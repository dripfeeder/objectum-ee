exports.Objectum=function(config){function msgLog(e,t,s){e<config.log.levelNum||(t=t||{},"string"==typeof t&&(t={msg:t}),t.msg=t.msg||s,t.level=e,common.log({file:config.rootDir+"/objectum-bunyan.log",text:util.inspect(t,{depth:null})}))}function b64_sha1(e){return binb2b64(core_sha1(str2binb(e),e.length*chrsz))}function str_sha1(e){return binb2str(core_sha1(str2binb(e),e.length*chrsz))}function hex_hmac_sha1(e,t){return binb2hex(core_hmac_sha1(e,t))}function b64_hmac_sha1(e,t){return binb2b64(core_hmac_sha1(e,t))}function str_hmac_sha1(e,t){return binb2str(core_hmac_sha1(e,t))}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc")}function core_sha1(e,t){e[t>>5]|=128<<24-t%32,e[(t+64>>9<<4)+15]=t;for(var s=Array(80),n=1732584193,r=-271733879,o=-1732584194,i=271733878,a=-1009589776,c=0;c<e.length;c+=16){for(var f=n,l=r,d=o,u=i,g=a,p=0;p<80;p++){p<16?s[p]=e[c+p]:s[p]=rol(s[p-3]^s[p-8]^s[p-14]^s[p-16],1);var m=safe_add(safe_add(rol(n,5),sha1_ft(p,r,o,i)),safe_add(safe_add(a,s[p]),sha1_kt(p)));a=i,i=o,o=rol(r,30),r=n,n=m}n=safe_add(n,f),r=safe_add(r,l),o=safe_add(o,d),i=safe_add(i,u),a=safe_add(a,g)}return Array(n,r,o,i,a)}function sha1_ft(e,t,s,n){return e<20?t&s|~t&n:e<40?t^s^n:e<60?t&s|t&n|s&n:t^s^n}function sha1_kt(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function core_hmac_sha1(e,t){var s=str2binb(e);s.length>16&&(s=core_sha1(s,e.length*chrsz));for(var n=Array(16),r=Array(16),o=0;o<16;o++)n[o]=909522486^s[o],r[o]=1549556828^s[o];var i=core_sha1(n.concat(str2binb(t)),512+t.length*chrsz);return core_sha1(r.concat(i),672)}function safe_add(e,t){var s=(65535&e)+(65535&t),n=(e>>16)+(t>>16)+(s>>16);return n<<16|65535&s}function rol(e,t){return e<<t|e>>>32-t}function str2binb(e){for(var t=Array(),s=(1<<chrsz)-1,n=0;n<e.length*chrsz;n+=chrsz)t[n>>5]|=(e.charCodeAt(n/chrsz)&s)<<32-chrsz-n%32;return t}function binb2str(e){for(var t="",s=(1<<chrsz)-1,n=0;n<32*e.length;n+=chrsz)t+=String.fromCharCode(e[n>>5]>>>32-chrsz-n%32&s);return t}function binb2hex(e){for(var t=hexcase?"0123456789ABCDEF":"0123456789abcdef",s="",n=0;n<4*e.length;n++)s+=t.charAt(e[n>>2]>>8*(3-n%4)+4&15)+t.charAt(e[n>>2]>>8*(3-n%4)&15);return s}function binb2b64(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s="",n=0;n<4*e.length;n+=3)for(var r=(e[n>>2]>>8*(3-n%4)&255)<<16|(e[n+1>>2]>>8*(3-(n+1)%4)&255)<<8|e[n+2>>2]>>8*(3-(n+2)%4)&255,o=0;o<4;o++)s+=8*n+6*o>32*e.length?b64pad:t.charAt(r>>6*(3-o)&63);return s}function Cell(e,t,s,n,r){var o=this;o.text=e||"",o.style=t||"none",o.colspan=s||1,o.rowspan=n||1,o.index=r||0}function Sheet(e){this.xml=e,this.colWidth={},this.sheetName=[],this.rowSheetId={},this.orientation=[],this.validation=[],this.namedRange=[],this.scale=[],this.marginTop=[],this.marginBottom=[],this.marginLeft=[],this.marginRight=[],this.autoFitHeight=[]}function XMLSS(e){e=e||{};var t=this;t.paperSizeIndex=9,t.fitWidth=0,t.fitHeight=0,t.zoom=90,t.marginBottom=2.5,t.marginLeft=2,t.marginRight=2,t.marginTop=2.5,t.autoFitHeight=0,t.workSheetName="Sheet1",t.clearColWidth(),t.orientation="Portrait",t.showPageBreakZoom=!1,t.printTitlesRow1=0,t.printTitlesRow2=0,t.fontSize=10,t.defRowHeight=e.defRowHeight||12.75,t.setDefaultStyles(),t.sheet=new Sheet(this),t.data=[],t.rowStartIndex=[],t.rowHeight=[],t.colWidth={}}config&&(config=config.config||config);var _=require("underscore");if(config||(config=require("./config")),config.auth||(config.auth={multi:!0}),config.backlog=config.backlog||1e4,config.caching||(config.caching={enabled:0}),config.admin||(config.admin={ip:["127.0.0.1"]}),config.session||(config.session={timeoutInterval:12e4,gcInterval:3e5}),config.news||(config.news={pollingInterval:5e3,gcInterval:3e5}),config.wwwRoot=__dirname+"/www",_.isArray(config.storages)&&config.projectsDir){var storages={};_.each(config.storages,function(e){storages[e]=require(config.projectsDir+"/"+e+"/config.json")}),config.storages=storages}var async=require("async"),pg=require("pg");pg.defaults.poolSize=0,pg.defaults.poolIdleTimeout=12e4,pg.defaults.reapIntervalMillis=6e4;var util=require("util"),fs=require("fs"),http=require("http"),url=require("url"),redis;config.redis&&config.redis.enabled&&(redis=require("redis"));var pg=require("pg"),express=require("express"),formidable=require("formidable"),nodemailer=require("nodemailer"),simplesmtp=require("simplesmtp"),smtp=simplesmtp.createServer(),MailParser=require("mailparser").MailParser,VError=require("verror"),Backbone=require("backbone"),log;try{config.log=config.log||{},config.log.level=config.log.level||"info";var bunyan=require("bunyan");log=bunyan.createLogger({name:"objectum",level:config.log.level||"info",streams:[{stream:process.stdout},{path:__dirname+"/objectum-bunyan.log"}]})}catch(e){var levelNum={fatal:60,error:50,warn:40,info:30,debug:20,trace:10};config.log.levelNum=levelNum[config.log.level],log={fatal:function(e,t){msgLog(60,e,t)},error:function(e,t){msgLog(50,e,t)},warn:function(e,t){msgLog(40,e,t)},info:function(e,t){msgLog(30,e,t)},debug:function(e,t){msgLog(20,e,t)},trace:function(e,t){msgLog(10,e,t)}}}var sql;if("win32"==process.platform&&(!config.mssql||config.mssql.enabled)){var tokens=process.version.split(".");if(tokens[1]<=8&&tokens[2]<=26)try{sql=require("msnodesql")}catch(e){}}var redisEmulator={m:{},del:function(e,t){delete this.m[e],t&&t(null,!0)},keys:function(e,t){var s=[];if(e&&"*"==e[e.length-1]){var n=e.substr(0,e.length-1);for(var r in this.m)r.substr(0,n.length)==n&&s.push(r)}t&&t(null,s)},subscribers:[],on:function(e,t){this.subscribers.push(t)},subscribe:function(e){},publish:function(e,t){for(var s=0;s<this.subscribers.length;s++)this.subscribers[s](e,t)},incrby:function(e,t,s){this.m[e]=this.m[e]||0,this.m[e]=Number(this.m[e])+t,s&&s(null,String(this.m[e]))},get:function(e,t){t&&t(null,this.m[e]||null)},set:function(e,t,s){this.m[e]=String(t),s&&s(null,!0)},hincrby:function(e,t,s,n){this.m[e]=this.m[e]||{},this.m[e][t]=this.m[e][t]||0,this.m[e][t]=Number(this.m[e][t])+s,n&&n(null,String(this.m[e][t]))},hdel:function(){for(var e=arguments[0],t=1;t<arguments.length;t++)"function"!=typeof arguments[t]&&this.m[e]&&this.m[e][arguments[t]]&&delete this.m[e][arguments[t]];"function"==typeof arguments[arguments.length-1]&&arguments[arguments.length-1](null,!0)},hset:function(e,t,s,n){this.m[e]=this.m[e]||{},this.m[e][t]=String(s),n&&n(null,!0)},hmset:function(e,t,s){this.m[e]=this.m[e]||{};for(var n in t)this.m[e][n]=String(t[n]);s&&s(null,!0)},hget:function(e,t,s){this.m[e]=this.m[e]||{},s&&s(null,this.m[e][t])},hmget:function(e,t,s){this.m[e]=this.m[e]||{};for(var n=[],r=0;r<t.length;r++)n.push(this.m[e][t[r]]);s&&s(null,n)},hgetall:function(e,t){var s={};for(var n in this.m[e])s[n]=this.m[e][n];t&&t(null,s)},hsetnx:function(e,t,s,n){this.m[e]=this.m[e]||{};var r=0;this.m[e][t]||(this.m[e][t]=s,r=1),n&&n(null,r)},hkeys:function(e,t){var s=[];for(var n in this.m[e])s.push(n);t&&t(null,s)},sadd:function(e,t,s){this.m[e]=this.m[e]||[],this.m[e].indexOf(t)==-1?(this.m[e].push(String(t)),s&&s(null,!0)):s&&s(!0,!1)},sismember:function(e,t,s){this.m[e]=this.m[e]||[],s&&s(null,this.m[e].indexOf(t)>-1)},srem:function(e,t,s){this.m[e]=this.m[e]||[];var n=this.m[e].indexOf(String(t));n>-1&&this.m[e].splice(n,1),s&&s(null,!0)},smembers:function(e,t){this.m[e]=this.m[e]||[],t&&t(null,this.m[e])},lpush:function(e,t){this.m[e]=this.m[e]||[],this.m[e]=[t].concat(this.m[e]),e.indexOf("service.log")>-1&&console.log(e+" lpush "+this.m[e])},ltrim:function(e,t,s){this.m[e]=this.m[e]||[],this.m[e]=this.m[e].slice(t,s+1),e.indexOf("service.log")>-1&&console.log(e+" ltrim "+this.m[e])},lrange:function(e,t,s,n){this.m[e]=this.m[e]||[],s=s==-1?this.m[e].length-1:s,n&&n(null,this.m[e].slice(t,s+1)),e.indexOf("service.log")>-1&&console.log(e+" lrange "+this.m[e])},select:function(e,t){t()},quit:function(){}};config.redis.enabled||(redis={createClient:function(){return redisEmulator}});var redisClient,redisPub,redisSub,common={};common.getDate=function(e){if(!e)return"";var t=e.getDate(),s=e.getMonth()+1,n=e.getFullYear(),r="";return t<10&&(r+="0"),r+=String(t)+".",s<10&&(r+="0"),r+=String(s)+".",r+=String(n)},common.getDateISO=function(e){if(!e)return"";var t=e.getDate(),s=e.getMonth()+1,n=e.getFullYear(),r=String(n)+"-";return s<10&&(r+="0"),r+=String(s)+"-",t<10&&(r+="0"),r+=String(t)},common.getDateFromDDMMYYYY=function(e){var t=null;return e&&10==e.length&&"."==e[2]&&"."==e[5]&&(t=new Date(e.substr(6,4),e.substr(3,2)-1,e.substr(0,2))),t},common.getLocalISOString=function(e){function t(e){var t="";return e<10&&(t+="0"),t+=e}var s=e.getFullYear()+"-";return s+=t(e.getMonth()+1)+"-",s+=t(e.getDate())+"T",s+=t(e.getHours())+":",s+=t(e.getMinutes())+":",s+=t(e.getSeconds())+".000Z"},common.getUTCDate=function(e){var t=e.getUTCDate(),s=e.getUTCMonth()+1,n=e.getUTCFullYear(),r="";return t<10&&(r+="0"),r+=String(t)+".",s<10&&(r+="0"),r+=String(s)+".",r+=String(n)},common.getTime=function(e){var t=e.getHours(),s=e.getMinutes(),n=e.getSeconds(),r="";return t<10&&(r+="0"),r+=String(t)+":",s<10&&(r+="0"),r+=String(s)+":",n<10&&(r+="0"),r+=String(n)},common.getUTCTime=function(e){var t=e.getUTCHours(),s=e.getUTCMinutes(),n=e.getUTCSeconds(),r="";return t<10&&(r+="0"),r+=String(t)+":",s<10&&(r+="0"),r+=String(s)+":",n<10&&(r+="0"),r+=String(n)},common.currentDate=function(){var e=new Date,t=e.getDate(),s=e.getMonth()+1,n=e.getFullYear(),r="";return t<10&&(r+="0"),r+=String(t)+".",s<10&&(r+="0"),r+=String(s)+".",r+=String(n)},common.currentUTCDate=function(){var e=new Date,t=e.getUTCDate(),s=e.getUTCMonth()+1,n=e.getUTCFullYear(),r="";return t<10&&(r+="0"),r+=String(t)+".",s<10&&(r+="0"),r+=String(s)+".",r+=String(n)},common.currentTime=function(e){var t=new Date,s=t.getHours(),n=t.getMinutes(),r=t.getSeconds(),o="";if(s<10&&(o+="0"),o+=String(s)+":",n<10&&(o+="0"),o+=String(n)+":",r<10&&(o+="0"),o+=String(r),e&&e.msec){o+=".";var i=t.getMilliseconds();i<100&&(o+="0"),i<10&&(o+="0"),o+=String(i)}return o},common.currentUTCTime=function(e){var t=new Date,s=t.getUTCHours(),n=t.getUTCMinutes(),r=t.getUTCSeconds(),o="";if(s<10&&(o+="0"),o+=String(s)+":",n<10&&(o+="0"),o+=String(n)+":",r<10&&(o+="0"),o+=String(r),e&&e.msec){o+=".";var i=t.getUTCMilliseconds();i<100&&(o+="0"),i<10&&(o+="0"),o+=String(i)}return o},common.currentTimestamp=function(){return common.currentDate()+" "+common.currentTime()},common.currentUTCTimestamp=function(){return common.currentUTCDate()+" "+common.currentUTCTime()},common.getTimestamp=function(e){return common.getDate(e)+" "+common.getTime(e)},common.getUTCTimestamp=function(e){return common.getUTCDate(e)+" "+common.getUTCTime(e)},common.getJulianDay=function(e){if(""==e)return 0;var t=e.getDate(),s=e.getMonth()+1,n=e.getFullYear();return jd=Math.floor(1461*(n+4800+(s-14)/12))/4+Math.floor(Math.floor(367*(s-2-12*((s-14)/12)))/12)-3*Math.floor(Math.floor(n+4900+(s-14)/12)/100)/4+t-32075,jd},common.getDateByJulianDay=function(e){var t,s,n,r,o,i,a;return t=e+68569,s=Math.floor(4*t/146097),t=Math.floor(t-(146097*s+3)/4),n=Math.floor(4e3*(t+1)/1461001),t=t-Math.floor(1461*n/4)+31,r=Math.floor(80*t/2447),o=t-Math.floor(2447*r/80),t=Math.floor(r/11),i=r+2-12*t,a=100*(s-49)+n+t,new Date(a,i-1,o)},common.getRemoteAddress=function(e){var t=e.headers["x-real-ip"]||e.connection.remoteAddress;return t},common.ToJSONString=function(e,t){var s;if("string"==typeof e)s=JSON.stringify(e).split("\\\\u").join("\\u");else if(e&&"object"==typeof e)if(e.getMonth)s=0==e.getUTCHours()&&0==e.getUTCMinutes()&&0==e.getUTCSeconds()&&0==e.getUTCMilliseconds()||0==e.getHours()&&0==e.getMinutes()&&0==e.getSeconds()&&0==e.getMilliseconds()?"new Date ("+e.getFullYear()+","+e.getMonth()+","+e.getDate()+")":"new Date (Date.UTC ("+e.getFullYear()+","+e.getMonth()+","+e.getDate()+","+e.getHours()+","+e.getMinutes()+","+e.getSeconds()+"))";else if(common.isArray(e)){s="[";for(var n=0;n<e.length;n++)n&&(s+=", "),s+=common.ToJSONString(e[n]);s+="]"}else{s="{";for(var r in e)"{"!=s&&(s+=", "),s+='"'+r+'": '+common.ToJSONString(e[r]);s+="}"}else s=e;return s},common.ToSQLString=function(e,t){var s;return"mssql"==t?"string"==typeof e?s="'"+e.split("'").join("''")+"'":e&&"object"==typeof e&&e.getMonth?e="'"+common.getUTCTimestamp(e)+"'":(s=e,null===s&&(s="null")):"string"==typeof e?s="'"+common.unescape(e.split("\\").join("\\\\").split("\n").join("\\n").split("\r").join("\\r").split("'").join("\\'"))+"'":e&&"object"==typeof e&&e.getMonth?e="'"+common.getUTCTimestamp(e)+"'":(s=e,null===s&&(s="null")),s},common.isEqualDates=function(e,t){return!(e&&!t||!e&&t)&&(e.getUTCFullYear()==t.getUTCFullYear()&&e.getUTCMonth()==t.getUTCMonth()&&e.getUTCDate()==t.getUTCDate()&&e.getUTCHours()==t.getUTCHours()&&e.getUTCMinutes()==t.getUTCMinutes()&&e.getUTCSeconds()==t.getUTCSeconds())},common.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)};var DMap={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:11,12:12,13:13,14:14,15:15,16:16,17:17,18:18,19:19,20:20,21:21,22:22,23:23,24:24,25:25,26:26,27:27,28:28,29:29,30:30,31:31,32:32,33:33,34:34,35:35,36:36,37:37,38:38,39:39,40:40,41:41,42:42,43:43,44:44,45:45,46:46,47:47,48:48,49:49,50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57,58:58,59:59,60:60,61:61,62:62,63:63,64:64,65:65,66:66,67:67,68:68,69:69,70:70,71:71,72:72,73:73,74:74,75:75,76:76,77:77,78:78,79:79,80:80,81:81,82:82,83:83,84:84,85:85,86:86,87:87,88:88,89:89,90:90,91:91,92:92,93:93,94:94,95:95,96:96,97:97,98:98,99:99,100:100,101:101,102:102,103:103,104:104,105:105,106:106,107:107,108:108,109:109,110:110,111:111,112:112,113:113,114:114,115:115,116:116,117:117,118:118,119:119,120:120,121:121,122:122,123:123,124:124,125:125,126:126,127:127,1027:129,8225:135,1046:198,8222:132,1047:199,1168:165,1048:200,1113:154,1049:201,1045:197,1050:202,1028:170,160:160,1040:192,1051:203,164:164,166:166,167:167,169:169,171:171,172:172,173:173,174:174,1053:205,176:176,177:177,1114:156,181:181,182:182,183:183,8221:148,187:187,1029:189,1056:208,1057:209,1058:210,8364:136,1112:188,1115:158,1059:211,1060:212,1030:178,1061:213,1062:214,1063:215,1116:157,1064:216,1065:217,1031:175,1066:218,1067:219,1068:220,1069:221,1070:222,1032:163,8226:149,1071:223,1072:224,8482:153,1073:225,8240:137,1118:162,1074:226,1110:179,8230:133,1075:227,1033:138,1076:228,1077:229,8211:150,1078:230,1119:159,1079:231,1042:194,1080:232,1034:140,1025:168,1081:233,1082:234,8212:151,1083:235,1169:180,1084:236,1052:204,1085:237,1035:142,1086:238,1087:239,1088:240,1089:241,1090:242,1036:141,1041:193,1091:243,1092:244,8224:134,1093:245,8470:185,1094:246,1054:206,1095:247,1096:248,8249:139,1097:249,1098:250,1044:196,1099:251,1111:191,1055:207,1100:252,1038:161,8220:147,1101:253,8250:155,1102:254,8216:145,1103:255,1043:195,1105:184,1039:143,1026:128,1106:144,8218:130,1107:131,8217:146,1108:186,1109:190};common.UnicodeToWin1251=function(e){var t=[];if(!e||!e.length)return e;for(var s=0;s<e.length;s++){var n=e.charCodeAt(s);if(!(n in DMap))throw"Character "+e.charAt(s)+" isn't supported by win1251!";t.push(String.fromCharCode(DMap[n]))}return t.join("")},common.unescape=function(e){if(!e)return e;if("object"==typeof e){if(e.getMonth)return e;if(common.isArray(e))for(var t=0;t<e.length;t++)e[t]=common.unescape(e[t]);else for(var s in e)e[s]=common.unescape(e[s]);return e}if("string"==typeof e){var n=/\\u([\d\w]{4})/gi,r=e.replace(n,function(e,t){return String.fromCharCode(parseInt(t,16))});return r=unescape(r)}return e},common.randomInt=function(e,t){return Math.floor(Math.random()*(t-e+1))+e},common.getCookies=function(e){if(!e)return{};for(var t=e.split(";"),s={},n=0;n<t.length;n++){var r=t[n].split("=");s[r[0].fulltrim()]=r[1]}return s},String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.ltrim=function(){return this.replace(/^\s+/,"")},String.prototype.rtrim=function(){return this.replace(/\s+$/,"")},String.prototype.fulltrim=function(){return this.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},common.clone=function(e){if(!e||"object"!=typeof e)return e;if("object"==typeof e&&e&&e.getMonth)return new Date(e.getTime());var t,s,n="function"==typeof e.pop?[]:{};for(t in e)e.hasOwnProperty(t)&&(s=e[t],s&&"object"==typeof s?n[t]=common.clone(s):n[t]=s);return n};var logFile="server.log";common.log=function(e){if("string"!=typeof e&&"number"!=typeof e||(e={text:e}),e.file&&(logFile=e.file),e.text){var t="["+common.currentDate()+" "+common.currentTime({msec:!0})+"] "+e.text;e.silent||console.log(e.text),fs.appendFile(logFile,t+"\n",function(e){e&&console.error(e)})}},common.getText=function(e,t){process.stdin.setEncoding("utf8"),console.log(e.title),process.stdin.on("data",function(e){e=e.split("\n").join(""),t(e)})};var ifields={tclass:["fid","fparent_id","fname","fcode","fdescription","fformat","fview_id","ftype","fsystem","fschema_id","frecord_id","fstart_id","fend_id"],tclass_attr:["fid","fclass_id","fname","fcode","ftype_id","forder","fnot_null","fvalid_func","fformat_func","fdescription","fsecure","fmax_str","fmin_str","fmax_number","fmin_number","fmax_ts","fmin_ts","funique","fformat_number","fformat_ts","fremove_rule","fschema_id","frecord_id","fstart_id","fend_id"],tview:["fid","fparent_id","fname","fcode","fdescription","flayout","fkey","fparent_key","fclass_id","funrelated","fquery","ftype","fsystem","fmaterialized","forder","fschema_id","frecord_id","ficon_cls","fstart_id","fend_id"],tview_attr:["fid","fview_id","fname","fcode","fclass_id","fclass_attr_id","fsubject_id","forder","fsort_kind","fsort_order","foperation","fvalue","farea","fcolumn_width","ftotal_type","fread_only","fgroup","fnot_null","fschema_id","frecord_id","fstart_id","fend_id"],taction:["fid","fclass_id","fname","fcode","fdescription","forder","fbody","fconfirm","flayout","fschema_id","frecord_id","fstart_id","fend_id"],tobject:["fid","fclass_id","fschema_id","frecord_id","fstart_id","fend_id"],tobject_attr:["fid","fobject_id","fclass_attr_id","fstring","fnumber","ftime","fschema_id","frecord_id","fstart_id","fend_id"],trevision:["fid","fdate","fdescription","fschema_id","frecord_id"],tschema:["fid","fparent_id","fname","fcode"]},Export=function(){var e;this.data={},this.classesId=[],this.viewsId=[],this.except={},this.currentSchemaId=null,this.getTopClassesCodes=function(t){log.info({cls:"Export",fn:"getTopClassesCodes"});var s=t.success;e.query({sql:"select\n\tdistinct (a.fid) as fid\nfrom\n\ttclass a\nwhere\n\ta.fparent_id is null and a.fid >= 1000\n",success:function(e){for(var t=e.result.rows,n=[],r=0;r<t.length;r++)n.push(t[r].fid);s(n)}})},this.getTopViewsCodes=function(t){log.info({cls:"Export",fn:"getTopViewsCodes"});var s=t.success;e.query({sql:"select\n\tdistinct (a.fid) as fid\nfrom\n\ttview a\nwhere\n\ta.fparent_id is null\n",success:function(e){for(var t=e.result.rows,n=[],r=0;r<t.length;r++)n.push(t[r].fid);s(n)}})},this.getNodesId=function(t){var s=this,n=[],r=t.success,o=t.table;async.mapSeries(t.codes,function(t,r){var i;async.series([function(s){if("number"==String(typeof t).toLowerCase())i=t,s();else{var n="select\n\tdistinct (a.fid) as fid\nfrom\n\t"+o+" a\nwhere\n\ta.fcode='"+t+"' and a.fparent_id is null\n";e.query({sql:n,success:function(e){i=e.result.rows[0].fid,s()}})}},function(t){n.push(i),e.query({sql:"select\n\tdistinct (a.fid) as fid\nfrom\n\t"+o+" a\nwhere\n\ta.fparent_id="+i+"\norder by a.fid\n",success:function(e){for(var r=e.result.rows,i=[],a=0;a<r.length;a++){var c=r[a].fid;i.push(c)}i.length?s.getNodesId({table:o,codes:i,success:function(e){for(var s=0;s<e.length;s++)n.push(e[s]);t()}}):t()}})}],function(e,t){r()})},function(e,t){r(n)})},this.exportClasses=function(t){log.info({cls:"Export",fn:"exportClasses"});var s=this,n=t.success,r=s.data.options.classes;async.series([function(e){s.getNodesId({table:"tclass",codes:r,success:function(t){s.classesId=t,e()}})},function(t){s.classesId.length&&(s.data.tclass=[],e.query({sql:"select\n\t"+ifields.tclass.join()+"\nfrom\n\ttclass a\nwhere\n\ta.fid in ("+s.classesId.join()+")\norder by\n\ta.fid, a.fstart_id\n",success:function(e){for(var n=e.result.rows,r=0;r<n.length;r++){for(var o=[],i=0;i<ifields.tclass.length;i++){var a=ifields.tclass[i],c=n[r][a];if("fcode"==a&&!c)throw"exportClasses (): fcode must be not null. FID="+n[r].fid;"fschema_id"==a&&null==c&&(c=s.currentSchemaId),"frecord_id"==a&&null==c&&(c=n[r].fid),o.push(c)}var f={};f.values=o,s.data.tclass.push(f)}t()}}))}],function(e,t){n()})},this.exportClassAttrs=function(t){var s=this,n=t.success;s.data.tclass_attr=[],e.query({sql:"select\n\t"+ifields.tclass_attr.join()+"\nfrom\n\ttclass_attr a\nwhere\n\ta.fclass_id in ("+s.classesId.join()+")\norder by\n\ta.fid, a.fstart_id\n",success:function(e){for(var t=e.result.rows,r=0;r<t.length;r++){var o={};o.values=[];for(var i=0;i<ifields.tclass_attr.length;i++){var a=ifields.tclass_attr[i],c=t[r][a];"fschema_id"==a&&null==c&&(c=s.currentSchemaId),"frecord_id"==a&&null==c&&(c=t[r].fid),o.values.push(c)}s.data.tclass_attr.push(o)}n()}})},this.exportActions=function(t){var s=this,n=t.success;s.data.taction=[],e.query({sql:"select\n\t"+ifields.taction.join()+"\nfrom\n\ttaction a\nwhere\n\ta.fclass_id in ("+s.classesId.join()+")\norder by\n\ta.fid, a.fstart_id\n",success:function(e){for(var t=e.result.rows,r=0;r<t.length;r++){var o={};o.values=[];for(var i=0;i<ifields.taction.length;i++){var a=ifields.taction[i],c=t[r][a];"fschema_id"==a&&null==c&&(c=s.currentSchemaId),"frecord_id"==a&&null==c&&(c=t[r].fid),o.values.push(c)}t[r].fid;s.data.taction.push(o)}n()}})},this.exportObjects=function(t){var s=this,n=t.success;s.data.tobject=[];var r=[];if(s.except.tobject&&s.except.tobject.fclass_id.length)for(var o=s.except.tobject.fclass_id,i=0;i<s.classesId.length;i++)o.indexOf(s.classesId[i])==-1&&r.push(s.classesId[i]);else r=s.classesId;e.query({sql:"select\n\t"+ifields.tobject.join()+"\nfrom\n\ttobject a\nwhere\n\ta.fclass_id in ("+r.join()+")\norder by\n\ta.fid, a.fstart_id\n",success:function(e){for(var t=e.result.rows,r=0;r<t.length;r++){var o={};o.values=[];for(var i=0;i<ifields.tobject.length;i++){var a=ifields.tobject[i],c=t[r][a];"fschema_id"==a&&null==c&&(c=s.currentSchemaId),"frecord_id"==a&&null==c&&(c=t[r].fid),o.values.push(c)}s.data.tobject.push(o)}n()}})},this.exportObjectAttrs=function(t){var s=this,n=t.success;s.data.tobject_attr=[];var r=[];if(s.except.tobject&&s.except.tobject.fclass_id.length)for(var o=s.except.tobject.fclass_id,i=0;i<s.classesId.length;i++)o.indexOf(s.classesId[i])==-1&&r.push(s.classesId[i]);else r=s.classesId;e.query({sql:"select\n\t"+ifields.tobject_attr.join()+"\nfrom\n\ttobject_attr a\nwhere\n\ta.fobject_id in (select b.fid from tobject b where b.fclass_id in ("+r.join()+"))\norder by\n\ta.fid, a.fstart_id\n",success:function(e){for(var t=e.result.rows,r=0;r<t.length;r++){var o={};o.values=[];for(var i=0;i<ifields.tobject_attr.length;i++){var a=ifields.tobject_attr[i],c=t[r][a];"fschema_id"==a&&null==c&&(c=s.currentSchemaId),"frecord_id"==a&&null==c&&(c=t[r].fid),o.values.push(c)}s.data.tobject_attr.push(o)}n()}})},this.exportViews=function(t){var s=this,n=t.success;log.info({cls:"Export",fn:"exportViews"});var r=s.data.options.views;s.getNodesId({table:"tview",codes:r,success:function(t){s.viewsId=t,s.viewsId.length&&(s.data.tview=[],e.query({sql:"select\n\t"+ifields.tview.join()+"\nfrom\n\ttview a\nwhere\n\ta.fid in ("+s.viewsId.join()+")\norder by\n\ta.fid, a.fstart_id\n",success:function(e){var t=e.result.rows;for(k=0;k<t.length;k++){for(var r=[],o=0;o<ifields.tview.length;o++){var i=ifields.tview[o],a=t[k][i];if("fcode"==i&&!a)throw"exportViews (): fcode must be not null. fid="+t[k].fid;"fschema_id"==i&&null==a&&(a=s.currentSchemaId),"frecord_id"==i&&null==a&&(a=t[k].fid),r.push(a)}var c={};c.values=r,s.data.tview.push(c)}n()}}))}})},this.exportViewAttrs=function(t){var s=this,n=t.success;s.data.tview_attr=[],e.query({sql:"select\n\t"+ifields.tview_attr.join()+"\nfrom\n\ttview_attr a\nwhere\n\ta.fview_id in ("+s.viewsId.join()+")\norder by\n\ta.fid, a.fstart_id\n",success:function(e){for(var t=e.result.rows,r=0;r<t.length;r++){for(var o=[],i=0;i<ifields.tview_attr.length;i++){var a=ifields.tview_attr[i],c=t[r][a];"fschema_id"==a&&null==c&&(c=s.currentSchemaId),"frecord_id"==a&&null==c&&(c=t[r].fid),o.push(c)}s.data.tview_attr.push({values:o})}n()}})},this.exportRevisions=function(t){var s=this,n=t.success;log.info({cls:"Export",fn:"exportRevisions"}),e.query({sql:"select\n"+ifields.trevision.join()+"\nfrom trevision a\norder by a.fid\n",success:function(e){var t=e.result.rows;s.data.trevision=[];for(var r=0;r<t.length;r++){for(var o=[],i=0;i<ifields.trevision.length;i++){var a=ifields.trevision[i],c=t[r][a];"fschema_id"==a&&null==c&&(c=s.currentSchemaId),"frecord_id"==a&&null==c&&(c=t[r].fid),o.push(c)}var f={};f.values=o,s.data.trevision.push(f)}n()}})},this.exportSchemas=function(t){var s=this,n=t.success;log.info({cls:"Export",fn:"exportSchemas"}),e.query({sql:"select\n"+ifields.tschema.join()+"\nfrom tschema a\norder by a.fid\n",success:function(e){var t=e.result.rows;s.data.tschema=[];for(var r=0;r<t.length;r++){for(var o=[],i=0;i<ifields.tschema.length;i++){var a=ifields.tschema[i],c=t[r][a];o.push(c)}var f={};f.values=o,s.data.tschema.push(f)}n()}})},this.prepareExcept=function(t){var s=this,n=t.success,r=s.data.options.except;if(!r)return void n();var o=[];for(var i in r)o.push(i);async.mapSeries(o,function(t,n){var o=r[t],i=[];async.mapSeries(o,function(t,s){function n(t,s){i.indexOf(t)==-1&&i.push(t),e.query({sql:"select\n\tfid\nfrom\n\ttclass a\nwhere\n\ta.fparent_id = "+t+"\norder by\n\ta.fid, a.fstart_id\n",success:function(e){var t=e.result.rows;async.mapSeries(t,function(e,t){n(e.fid,function(){t()})},function(e,t){s()})}})}t.fclass_id&&("object"==String(typeof t.fclass_id).toLowerCase()&&t.fclass_id instanceof Array?async.mapSeries(t.fclass_id,function(t,s){n(e.getClass(t).get("fid"),function(){s()})},function(e,t){s()}):n(e.getClass(t.fclass_id).get("fid"),function(){s()}))},function(e,r){s.except[t]={},s.except[t].fclass_id=i,n()})},function(e,t){n()})},this.clearBadTimeFields=function(t){var s=t.success;log.info({cls:"Export",fn:"clearBadTimeFields"});var n;n="update tobject_attr set ftime=null\n",n+="where ftime<'01.01.1400'\n",e.query({sql:n,success:function(e){s()}})},this.fixReferences=function(t){var s=t.success;e.query({sql:"select min (fid) as fid from trevision",success:function(t){var n=t.result.rows;if(n.length>0){var r=n[0].fid,o=[];for(var i in ifields){var a=ifields[i].join();a.indexOf("fstart_id")!=-1&&(o.push("update "+i+" set fstart_id="+r+"\nwhere fstart_id not in (select fid from trevision)\n"),o.push("update "+i+" set fend_id="+r+"\nwhere fend_id <> "+e.maxRevision+" and fend_id not in (select fid from trevision)\n"))}async.mapSeries(o,function(t,s){e.query({sql:t,success:function(e){s()}})},function(e,t){s()})}}})},this.createSchema=function(t){var s=null,n=t.success,r=t.code;e.query({sql:"select fid from tschema where fcode='"+r+"'",success:function(t){var o=t.result.rows;if(0==o.length){var i=null;e.query({sql:"select max (fid) as fid from tschema",success:function(t){var o=t.result.rows;o.length&&(i=o[0].fid+1),null==i&&(i=1),e.query({sql:"insert into tschema (fid, fcode) values ("+i+",'"+r+"')",success:function(e){s=i,n(s)}})}})}else s=o[0].fid,n(s)}})},this.exportToFile=function(t){var s=this,n=t.success,r=(new Date).getTime();log.info({cls:"Export",fn:"exportToFile"}),s.data.options=t,async.series([function(n){t.storage?(e=s.storage=t.storage,n()):projects.loadConfig({code:t.code,success:function(){e=new Storage({code:t.code,connection:config.storages[t.code],success:function(){s.storageCreated=!0,n()}})},failure:function(e){n(e)}})},function(e){"all"==t.classes?s.getTopClassesCodes({success:function(s){t.classes=s,e()}}):e()},function(e){"all"==t.views?s.getTopViewsCodes({success:function(s){t.views=s,e()}}):e()},function(e){s.data.fields=ifields,s.clearBadTimeFields({success:function(){s.fixReferences({success:function(){s.createSchema({code:t.code,success:function(t){s.currentSchemaId=t,e()}})}})}})},function(e){s.exportClasses({success:function(){s.exportClassAttrs({success:function(){s.exportActions({success:function(){s.prepareExcept({success:function(){s.exportObjects({success:function(){s.exportObjectAttrs({success:function(){s.exportViews({success:function(){s.exportViewAttrs({success:function(){s.exportSchemas({success:function(){s.exportRevisions({success:function(){e()}})}})}})}})}})}})}})}})}})}})},function(e){s.data=common.unescape(s.data),t.space?fs.writeFile(t.file,JSON.stringify(s.data,0,t.space),function(t){e()}):fs.writeFile(t.file,JSON.stringify(s.data),function(t){e()})}],function(t,o){var i="";for(var a in ifields)s.data[a]&&(i+=a+": "+s.data[a].length+"\n");i+="queryCount: "+e.queryCount+"\n",i+="duration: "+((new Date).getTime()-r)/1e3+" sec.\n",log.info({cls:"Export",stat:i}),s.storageCreated&&e.freeResources(),n()})}},Import=function(){var e,t;this.data={},this.addGet=function(e){var t={};return t.values=e.values,t.fields=this.data.fields[e.table],t.get=function(e){for(var t=0;t<this.fields.length&&this.fields[t]!=e;t++);if(t==this.fields.length)throw"get: field '"+e+"'not exists in '"+this.fields.join()+"'";return this.values[t]},t},this.removeTrash=function(s){log.info({cls:"Import",fn:"removeTrash"});var n=s.success;async.series([function(s){async.forever(function(s){e.query({session:t,sql:"delete from tview a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fparent_id not in (select b.fid from tview b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(n){e.query({session:t,sql:"select count (*) as num from tview a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fparent_id not in (select b.fid from tview b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(e){var t=e.result.rows;0==t[0].num?s("end"):s()}})}})},function(e){s()})},function(s){e.query({session:t,sql:"delete from tview_attr a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fview_id not in (select b.fid from tview b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(e){s()}})},function(s){async.forever(function(s){e.query({session:t,sql:"delete from tclass a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fparent_id not in (select b.fid from tclass b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(n){e.query({session:t,sql:"select count (*) as num from tclass a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fparent_id not in (select b.fid from tclass b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(e){var t=e.result.rows;0==t[0].num?s("end"):s()}})}})},function(e){s()})},function(s){e.query({session:t,sql:"delete from tclass_attr a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fclass_id not in (select b.fid from tclass b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(e){s()}})},function(s){e.query({session:t,sql:"delete from taction a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fclass_id not in (select b.fid from tclass b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(e){s()}})},function(s){e.query({session:t,sql:"delete from tobject a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fclass_id not in (select b.fid from tclass b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(e){s()}})},function(s){e.query({session:t,sql:"delete from tobject_attr a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand not exists (select b.fid from tobject b where b.fid=a.fobject_id and "+e.getCurrentFilter({alias:"b"})+")\n",success:function(e){s()}})}],function(e,t){n()})},this.prepareStorageForImport=function(s){var n=this,r=s.success;log.info({cls:"Import",fn:"prepareStorageForImport"}),async.series([function(s){async.eachSeries(n.data.views,function(s,r){var s=n.addGet({values:s.values,table:"tview"}),o=s.get("fcode"),i=s.get("fparent_id");""==i&&e.query({session:t,sql:"delete from tview where fparent_id is null and fcode='"+o+"'",success:function(e){
r()}})},function(e){s()})},function(s){async.eachSeries(n.data.classes,function(s,r){var s=n.addGet({values:s.values,table:"tclass"}),o=s.get("fcode"),i=s.get("fparent_id");""==i&&e.query({session:t,sql:"delete from tclass where fparent_id is null and fcode='"+o+"'",success:function(e){r()}})},function(e){s()})},function(e){n.removeTrash({success:function(){e()}})}],function(e,t){r()})},this.tableId={},this.newId={tclass:{},tclass_attr:{},tview:{},tview_attr:{},taction:{},taction_attr:{},tobject:{},tobject_attr:{},trevision:{},tschema:{}},this.count={tclass:0,tclass_attr:0,tview:0,tview_attr:0,taction:0,taction_attr:0,tobject:0,tobject_attr:0,trevision:0},this.classAttrType={},this.startRevision=null,this.startRevisionMin=null,this.getSequences=function(t){var s=this,n=t.success,r=t.session,o=["tclass","tclass_attr","tview","tview_attr","taction","taction_attr","tobject","tobject_attr","trevision"];async.eachSeries(o,function(t,n){e.client.getNextId({session:r,table:t,success:function(e){s.tableId[t]=e.id,n()}})},function(e){n()})},this.updateEngineTables=function(t,s){var n=this;log.info({cls:"Import",fn:"updateEngineTables"});var r=t.session,o={_class:["fid","fparent_id","fname","fcode","fdescription","fformat","fview_id","fstart_id"],_class_attr:["fid","fclass_id","fname","fcode","fdescription","ftype_id","fnot_null","fsecure","funique","fremove_rule","fstart_id"],_view:["fid","fparent_id","fname","fcode","fdescription","flayout","fquery","fstart_id"],_object:["fid","fstart_id"]};async.eachSeries(["class","class_attr","view","object"],function(t,s){async.series([function(s){e.query({session:r,sql:"delete from _"+t,success:function(e){s()}})},function(s){var n="insert into _"+t+" ("+o["_"+t].join(",")+") (\n\tselect "+o["_"+t].join(",")+" from t"+t+" where fend_id = "+e.maxRevision+"\n)\n";if("class_attr"==t&&(n="insert into _class_attr ("+o._class_attr.join(",")+", fclass_code) (\n\tselect a."+o._class_attr.join(",a.")+",b.fcode from tclass_attr a\n\tinner join tclass b on (a.fclass_id = b.fid)\n\twhere a.fend_id = "+e.maxRevision+"\n)\n"),"view"==t)var n="insert into _view ("+o._view.join(",")+") (\n\tselect "+o._view.join(",")+" from tview where fsystem is null and fend_id = "+e.maxRevision+"\n)\n";e.query({session:r,sql:n,success:function(e){s()}})},function(s){if("object"==t)return s();var i={},a=n.data.fields["t"+t];_.each(n.data["t"+t],function(s){for(var n={},r=0;r<a.length;r++){var o=a[r],c=s.values[r];n[o]=c}n.fend_id==e.maxRevision&&("view"==t&&1==n.fsystem||(i[n.fid]=i[n.fid]||n,n.fstart_id>i[n.fid].fstart_id&&(i[n.fid]=n)))});var c=[];_.each(i,function(e){c.push(e)}),async.eachSeries(c,function(s,i){var a={};async.series([function(n){e.query({session:r,sql:"delete from _"+t+" where fid = "+s.fid,success:function(){n()}})},function(e){_.each(o["_"+t],function(e){a[e]=s[e]}),"class_attr"==t&&(a.fclass_code="tmp"),a.fid=n.newId["t"+t][a.fid],a.fparent_id&&(a.fparent_id=n.newId["t"+t][a.fparent_id]),a.fclass_id&&(a.fclass_id=n.newId.tclass[a.fclass_id]),a.fview_id&&(a.fview_id=n.newId.tview[a.fview_id]),a.ftype_id&&a.ftype_id>=1e3&&(a.ftype_id=n.newId.tclass[a.ftype_id]),a.fstart_id=n.newId.trevision[a.fstart_id],e()},function(s){if("class"!=t)return s();var n=a.fcode+"_"+a.fid;e.client.isTableExists({session:r,table:n,success:function(t){return t?s():void e.query({session:r,sql:"create table "+n+" (fobject_id bigint)",success:function(e){s()}})}})},function(n){return"class_attr"!=t?n():void e.query({session:r,sql:"select fcode from _class where fid = "+a.fclass_id,success:function(t){if(!t.result.rows.length)return n();var o=t.result.rows[0].fcode+"_"+a.fclass_id,i=a.fcode+"_"+a.fid;e.client.isFieldExists({session:r,table:o,field:i,success:function(t){if(t)return n();var c="bigint";3==a.ftype_id&&(c="timestamp (6)"),2==a.ftype_id&&(c="numeric"),1!=a.ftype_id&&5!=a.ftype_id||(c="text"),async.series([function(t){e.query({session:r,sql:"alter table "+o+" add column "+i+" "+c,success:function(e){t()}})},function(t){s.funique&&!e.connection.dbEngine.uniqueValueIndex?e.query({session:r,sql:"create unique index "+o+"_"+i+"_unique on "+o+" ("+i+")",success:function(e){t()}}):12==a.ftype_id||a.ftype_id>=1e3||s.fformat_func&&s.fformat_func.indexOf('"index"')>0?e.query({session:r,sql:"create index "+o+"_"+i+" on "+o+" ("+i+")",success:function(e){t()}}):t()}],n)}})}})},function(s){var o=n.generateInsert({table:"_"+t,fields:a});e.query({session:r,sql:o,success:function(e){s()}})}],i)},s)},function(t){e.query({session:r,sql:"select "+o._class.join(",")+" from _class order by fcode",success:function(e){fs.writeFileSync("c-schema.txt",JSON.stringify(n.data.tclass,null,"\t")),fs.writeFile("c-db.txt",JSON.stringify(e.result.rows,null,"\t"),t)}})}],s)},function(e){s(e)})},this.generateInsert=function(t){var s=[],n="";for(var r in t.fields)if(s.push(r),n&&(n+=","),null!=t.fields[r]){var o=t.fields[r];"string"==typeof o?24==o.length&&"T"==o[10]&&"Z"==o[23]?o="'"+common.getUTCTimestamp(new Date(o))+"'":(o=common.ToSQLString(o,e.client.database),"postgres"==e.client.database&&(o="E"+o)):"object"==typeof o&&o.getMonth&&(o="'"+common.getUTCTimestamp(o)+"'"),n+=o}else n+="null";var i;return i="insert into "+t.table+"(\n",i+=s.join(),i+="\n) values (\n",i+=n,i+="\n)\n"},this.incCount=function(e,t){this.count[e]++},this.importViews=function(s){var n=this,r=s.success;log.info({cls:"Import",fn:"importViews"});var o=n.data.fields.tview;async.eachSeries(n.data.tview,function(s,r){process.nextTick(function(){for(var i,a={},c=0;c<o.length;c++){var f=o[c],l=s.values[c];null!=l&&("fid"==f?l=n.newId.tview[l]:"fparent_id"==f?l=n.newId.tview[l]:"fclass_id"==f?l=n.newId.tclass[l]:"fschema_id"==f&&(i=l,l=n.newId.tschema[l])),a[f]=l}if(null==n.startRevision[i]||a.fstart_id<n.startRevision[i])null!=n.startRevision[i]&&a.fend_id!=e.maxRevision&&a.fend_id>=n.startRevision[i]&&void 0!==a.fid?(a.fend_id=n.newId.trevision[a.fend_id],e.query({session:t,sql:"update tview set fend_id = "+a.fend_id+" where fid = "+a.fid+" and fend_id="+e.maxRevision,success:function(e){n.incCount("tview",a.fid),r()}})):r();else{a.fstart_id=n.newId.trevision[a.fstart_id],a.fend_id=n.newId.trevision[a.fend_id];var d=n.generateInsert({table:"tview",fields:a});e.query({session:t,sql:d,success:function(e){n.incCount("tview",a.fid),r()}})}})},function(e){r()})},this.importViewAttrs=function(s){var n=this,r=s.success;log.info({cls:"Import",fn:"importViewAttrs"});var o,i=n.data.fields.tview_attr;async.eachSeries(n.data.tview_attr,function(s,r){process.nextTick(function(){for(var a,c={},f=0;f<i.length;f++){var l=i[f],d=s.values[f];null!=d&&("fid"==l?d=n.newId.tview_attr[d]:"fview_id"==l?d=n.newId.tview[d]:"fclass_id"==l?d=n.newId.tclass[d]:"fclass_attr_id"==l?d=n.newId.tclass_attr[d]:"fschema_id"==l&&(a=d,d=n.newId.tschema[d])),c[l]=d}null==n.startRevision[a]||c.fstart_id<n.startRevision[a]?null!=n.startRevision[a]&&c.fend_id!=e.maxRevision&&c.fend_id>=n.startRevision[a]&&void 0!==c.fid?(c.fend_id=n.newId.trevision[c.fend_id],e.query({session:t,sql:"update tview_attr set fend_id = "+c.fend_id+" where fid = "+c.fid+" and fend_id="+e.maxRevision,success:function(e){n.incCount("tview_attr",c.fid),r()}})):r():(c.fstart_id=n.newId.trevision[c.fstart_id],c.fend_id=n.newId.trevision[c.fend_id],o=n.generateInsert({table:"tview_attr",fields:c}),e.query({session:t,sql:o,success:function(e){n.incCount("tview_attr",c.fid),r()}}))})},function(e){r()})},this.importClasses=function(n){var r=this,o=n.success;log.info({cls:"Import",fn:"importClasses"});var i=r.data.fields.tclass;async.eachSeries(r.data.tclass,function(n,o){process.nextTick(function(){for(var a,c={},f=0;f<i.length;f++){var l=i[f],d=n.values[f];null!=d&&("fid"==l?d=r.newId.tclass[d]:"fparent_id"==l?d=r.newId.tclass[d]:"fview_id"==l?d=r.newId.tview[d]:"fschema_id"==l&&(a=d,d=r.newId.tschema[d])),c[l]=d}null==r.startRevision[a]||c.fstart_id<r.startRevision[a]?null!=r.startRevision[a]&&c.fend_id!=e.maxRevision&&c.fend_id>=r.startRevision[a]&&void 0!==c.fid?(c.fend_id=r.newId.trevision[c.fend_id],e.query({session:t,sql:"update tclass set fend_id = "+c.fend_id+" where fid = "+c.fid+" and fend_id="+e.maxRevision,success:function(e){r.incCount("tclass",c.fid),o()}})):o():(c.fstart_id=r.newId.trevision[c.fstart_id],c.fend_id=r.newId.trevision[c.fend_id],s=r.generateInsert({table:"tclass",fields:c}),e.query({session:t,sql:s,success:function(e){r.incCount("tclass",c.fid),o()}}))})},function(e){o()})},this.importClassAttrs=function(n){var r=this,o=n.success;log.info({cls:"Import",fn:"importClassAttrs"});var i=r.data.fields.tclass_attr;async.eachSeries(r.data.tclass_attr,function(n,o){process.nextTick(function(){for(var a,c={},f=0;f<i.length;f++){var l=i[f],d=n.values[f];if(null!=d)if("fid"==l)d=r.newId.tclass_attr[d];else if("fclass_id"==l)d=r.newId.tclass[d];else if("ftype_id"==l){var u=d;if(u>=1e3){var g=r.newId.tclass[u];d=g,r.classAttrType[c.fid]=g}else r.classAttrType[c.fid]=u}else"fschema_id"==l&&(a=d,d=r.newId.tschema[d]);c[l]=d}null==r.startRevision[a]||c.fstart_id<r.startRevision[a]?null!=r.startRevision[a]&&c.fend_id!=e.maxRevision&&c.fend_id>=r.startRevision[a]&&void 0!==c.fid?(c.fend_id=r.newId.trevision[c.fend_id],e.query({session:t,sql:"update tclass_attr set fend_id = "+c.fend_id+" where fid = "+c.fid+" and fend_id="+e.maxRevision,success:function(e){r.incCount("tclass_attr",c.fid),o()}})):o():(c.fstart_id=r.newId.trevision[c.fstart_id],c.fend_id=r.newId.trevision[c.fend_id],s=r.generateInsert({table:"tclass_attr",fields:c}),e.query({session:t,sql:s,success:function(e){r.incCount("tclass_attr",c.fid),o()}}))})},function(e){o()})},this.importActions=function(n){var r=this,o=n.success;log.info({cls:"Import",fn:"importActions"});var i=r.data.fields.taction;async.eachSeries(r.data.taction,function(n,o){process.nextTick(function(){for(var a,c=[],f=0;f<i.length;f++){var l=i[f],d=n.values[f];null!=d&&("fid"==l?d=r.newId.taction[d]:"fclass_id"==l?d=r.newId.tclass[d]:"fschema_id"==l&&(a=d,d=r.newId.tschema[d])),c[l]=d}null==r.startRevision[a]||c.fstart_id<r.startRevision[a]?null!=r.startRevision[a]&&c.fend_id!=e.maxRevision&&c.fend_id>=r.startRevision[a]&&void 0!==c.fid?(c.fend_id=r.newId.trevision[c.fend_id],e.query({session:t,sql:"update taction set fend_id = "+c.fend_id+" where fid = "+c.fid+" and fend_id="+e.maxRevision,success:function(e){r.incCount("taction",c.fid),o()}})):o():(c.fstart_id=r.newId.trevision[c.fstart_id],c.fend_id=r.newId.trevision[c.fend_id],s=r.generateInsert({table:"taction",fields:c}),e.query({session:t,sql:s,success:function(e){r.incCount("taction",c.fid),o()}}))})},function(e){o()})},this.importObjects=function(n){var r=this,o=n.success;log.info({cls:"Import",fn:"importObjects"});var i=r.data.fields.tobject,a=0;async.eachSeries(r.data.tobject,function(n,o){process.nextTick(function(){for(var c,f={},l=0;l<i.length;l++){var d=i[l],u=n.values[l];null!=u&&("fid"==d?u=r.newId.tobject[u]:"fclass_id"==d?u=r.newId.tclass[u]:"fschema_id"==d&&(c=u,u=r.newId.tschema[u])),f[d]=u}"0"!=f.fclass_id&&(null==r.startRevision[c]||f.fstart_id<r.startRevision[c]?null!=r.startRevision[c]&&f.fend_id!=e.maxRevision&&f.fend_id>=r.startRevision[c]&&void 0!==f.fid?(f.fend_id=r.newId.trevision[f.fend_id],e.query({session:t,sql:"update tobject set fend_id = "+f.fend_id+" where fid = "+f.fid+" and fend_id="+e.maxRevision,success:function(e){r.incCount("tobject",f.fid),o()}})):o():(f.fstart_id=r.newId.trevision[f.fstart_id],f.fend_id=r.newId.trevision[f.fend_id],s=r.generateInsert({table:"tobject",fields:f}),e.query({session:t,sql:s,success:function(e){r.incCount("tobject",f.fid),a++,a%1e4==0&&log.info({cls:"Import"},"\t"+a+" records"),o()}})))})},function(e){o()})},this.importObjectAttrs=function(n){var r=this,o=n.success;log.info({cls:"Import",fn:"importObjectAttrs"});var i=r.data.fields.tobject_attr,a=0;async.eachSeries(r.data.tobject_attr,function(n,o){process.nextTick(function(){for(var c,f={},l=0,d=0;d<i.length;d++){var u=i[d],g=n.values[d];if(null!=g)if("fid"==u)g=r.newId.tobject_attr[g];else if("fclass_attr_id"==u){var p=r.newId.tclass_attr[g];g=p,l=r.classAttrType[p]}else"fobject_id"==u?g=r.newId.tobject[g]:"fschema_id"==u?(c=g,g=r.newId.tschema[g]):"fnumber"==u?((l>=1e3||12==l)&&(g=r.newId.tobject[g]),6==l&&(g=r.newId.tclass[g]),7==l&&(g=r.newId.tclass_attr[g]),8==l&&(g=r.newId.tview[g]),9==l&&(g=r.newId.tview_attr[g]),10==l&&(g=r.newId.taction[g]),11==l&&(g=r.newId.taction_attr[g]),13==l&&(g=r.newId.tobject_attr[g])):"fstart_id"!=u&&"fend_id"!=u&&void 0==g&&(g=null);f[u]=g}l?null==r.startRevision[c]||f.fstart_id<r.startRevision[c]?null!=r.startRevision[c]&&f.fend_id!=e.maxRevision&&f.fend_id>=r.startRevision[c]&&void 0!==f.fid?(f.fend_id=r.newId.trevision[f.fend_id],e.query({session:t,sql:"update tobject_attr set fend_id = "+f.fend_id+" where fid = "+f.fid+" and fend_id="+e.maxRevision,success:function(e){r.incCount("tobject_attr",f.fid),o()}})):o():(f.fstart_id=r.newId.trevision[f.fstart_id],f.fend_id=r.newId.trevision[f.fend_id],"mssql"==e.client.database&&f.ftime&&(f.ftime=new Date(f.ftime)),s=r.generateInsert({table:"tobject_attr",fields:f}),e.query({session:t,sql:s,success:function(e){r.incCount("tobject_attr",f.fid),a++,a%1e4==0&&log.info({cls:"Import"},"\t"+a+" records"),o()}})):o()})},function(e){o()})},this.createSchema=function(s){var n=null,r=s.success,o=s.code;e.query({session:t,sql:"select fid from tschema where fcode='"+o+"'",success:function(s){var i=s.result.rows;if(0==i.length){var a=null;e.query({session:t,sql:"select max (fid) as fid from tschema",success:function(s){var i=s.result.rows;i.length&&(a=i[0].fid+1),null==a&&(a=1),e.query({session:t,sql:"insert into tschema (fid, fcode) values ("+a+",'"+o+"')",success:function(e){n=a,r(n)}})}})}else n=i[0].fid,r(n)}})},this.getSchemaId=function(s){var n=s.success;if(!s||!s.code)throw"schema.getId (): options.code must be defined";var r=null;e.query({session:t,sql:"select fid from tschema where fcode='"+s.code+"'",success:function(e){var t=e.result.rows;t.length>0?(r=t[0].fid,n(r)):n(null)}})},this.getNewId=function(s){var n=this,r=s.success;log.info({cls:"Import",fn:"getNewId"}),async.eachSeries(n.data.tschema,function(s,r){n.getSchemaId({code:s.values[3],success:function(o){if(null==o)r();else{var i=[];for(var a in ifields)i.push(a);async.eachSeries(i,function(r,i){var a=ifields[r].indexOf("fschema_id"),c=ifields[r].indexOf("frecord_id");a==-1?i():e.query({session:t,sql:"select distinct (frecord_id) as frecord_id, fid from "+r+" where frecord_id is not null and fschema_id="+o,success:function(e){for(var t=e.result.rows,o=n.data[r],f=0;f<t.length;f++)for(var l=t[f].frecord_id,d=0;d<o.length;d++)s.values[0]==o[d].values[a]&&l==o[d].values[c]&&(n.newId[r][o[d].values[0]]=t[f].fid);i()}})},function(e){r()})}}})},function(e){r()})},this.importRevisions=function(n){var r=this,o=n.success;log.info({cls:"Import",fn:"importRevisions"});var i=r.data.fields.trevision,a=i.indexOf("fschema_id");async.eachSeries(r.data.trevision,function(n,o){process.nextTick(function(){var c=n.values[a];if(r.newId.trevision[n.values[0]])return void o();r.startRevision[c]||(r.startRevision[c]=n.values[0],(!r.startRevisionMin||r.startRevisionMin>r.startRevision[c])&&(r.startRevisionMin=r.startRevision[c]),log.info({cls:"Import"},"startRevision ["+c+"] = "+n.values[0]+" "));for(var f,l={},d=0;d<i.length;d++){var u=i[d],g=n.values[d];null!=g&&("fid"==u?(f=g,g=r.tableId.trevision):"fschema_id"==u&&(g=r.newId.tschema[g])),l[u]=g}"mssql"==e.client.database&&l.fdate&&(l.fdate=new Date(l.fdate)),s=r.generateInsert({table:"trevision",fields:l}),e.query({session:t,sql:s,success:function(e){r.incCount("trevision",l.fid),r.newId.trevision[f]=r.tableId.trevision,r.tableId.trevision++,o()}})})},function(t){r.newId.trevision[e.maxRevision]=e.maxRevision,o()})},this.importSchemas=function(e){var t=this,s=e.success;log.info({cls:"Import",fn:"importSchemas"});var n=t.data.fields.tschema;this.startRevision={},async.eachSeries(t.data.tschema,function(e,s){t.startRevision[e.values[0]]=null;for(var r=0;r<n.length;r++){var o=n[r],i=e.values[r];if(null!=i&&"fcode"==o){t.createSchema({code:i,success:function(n){t.newId.tschema[e.values[0]]=n,s()}});break}}},function(e){s()})},this.generateNewId=function(e){var t=this,s=e.success;log.info({cls:"Import",fn:"generateNewId"});for(var n=["tclass","tclass_attr","tview","tview_attr","taction","taction_attr","tobject","tobject_attr"],r=0;r<n.length;r++){var o=n[r];if(t.data[o])for(var i=0;i<t.data[o].length;i++){for(var a={},c=0;c<t.data.fields[o].length;c++){var f=t.data.fields[o][c],l=t.data[o][i].values[c];a[f]=l}t.schema&&(null==t.startRevision[a.fschema_id]||a.fstart_id<t.startRevision[a.fschema_id])||t.newId[o][a.fid]||(t.newId[o][a.fid]=t.tableId[o],t.tableId[o]++)}}s()},this.removeTOC=function(t){var s=t.success,n=t.session;t.storage&&(e=t.storage),log.info({cls:"Import",fn:"removeTOC"});var r="select c.fid from tclass c\n";r+="where c.fid >= 1000 and "+e.getCurrentFilter({alias:"c"})+"\n",t&&t.classId&&(r+="and c.fid="+t.classId+"\n"),r+="order by c.fid\n",e.query({session:n,sql:r,success:function(t){var r=t.result.rows;async.eachSeries(r,function(t,s){var r=e.getClass(t.fid).toc;e.client.isTableExists({session:n,table:r,success:function(t){if(t){var o;o="mssql"==e.client.database?"drop table "+r+"\n":"drop table "+r+" cascade\n",e.query({session:n,sql:o,success:function(e){s()}})}else s()}})},function(e){s()})}})},this.removeObjectDuplicates=function(s){var n=s.success;log.info({cls:"Import",fn:"removeObjectDuplicates"}),e.query({session:t,sql:"select count (*), o.fid from tobject o\nwhere "+e.getCurrentFilter({alias:"o"})+"\ngroup by o.fid\nhaving count (*) > 1\n",success:function(s){var r=s.result.rows;async.eachSeries(r,function(s,n){var r=s.fid;e.query({session:t,sql:"select o.fstart_id from tobject o\nwhere o.fid="+r+" and "+e.getCurrentFilter({alias:"o"})+"\norder by o.fstart_id desc\n",success:function(s){var o=s.result.rows;o.splice(0,1),async.eachSeries(o,function(s,n){e.query({session:t,sql:"update tobject set fend_id=fstart_id\nwhere fid="+r+" and fstart_id="+s.fstart_id,success:function(e){n()}})},function(e){n()})}})},function(e){n()})}})},this.removeObjectAttrDuplicates=function(s){var n=s.success;log.info({cls:"Import",fn:"removeObjectAttrDuplicates"}),e.query({session:t,sql:"select oa.fclass_attr_id, oa.fobject_id from tobject_attr oa\nwhere "+e.getCurrentFilter({alias:"oa"})+"\ngroup by oa.fclass_attr_id, oa.fobject_id\nhaving count (*) > 1\n",success:function(s){var r=s.result.rows;async.eachSeries(r,function(s,n){var r=s.fclass_attr_id,o=s.fobject_id;e.query({session:t,sql:"select oa.fid from tobject_attr oa\nwhere oa.fclass_attr_id="+r+" and oa.fobject_id="+o+" and "+e.getCurrentFilter({alias:"oa"})+"\norder by oa.FSTART_ID desc\n",success:function(s){var r=s.result.rows;r.splice(0,1),async.eachSeries(r,function(s,n){e.query({session:t,sql:"update tobject_attr set fend_id=fstart_id\nwhere fid="+s.fid,success:function(e){n()}})},function(e){n()})}})},function(e){n()})}})},this.getChilds=function(s){var n=this,r=s.success,o=s;e.query({session:t,sql:"select fid from "+s.table+" where fparent_id "+(s.parentId?"= "+s.parentId:"is null")+" and "+e.getCurrentFilter(),success:function(e){var t=e.result.rows;o.childs||(o.childs=[]),async.eachSeries(t,function(e,t){o.childs.push(e.fid),n.getChilds({table:o.table,parentId:e.fid,childs:o.childs,success:function(e){t()}})},function(e){r(o.childs)})}})},this.createTOC=function(s){var n=this,r=s.success;s.storage&&(e=s.storage),log.info({cls:"Import",fn:"createTOC"});var o;async.series([function(e){n.removeObjectAttrDuplicates({success:function(){n.removeObjectDuplicates({success:function(){e()}})}})},function(n){var r;r="select\n",r+="\t"+ifields.tclass+"\n",r+="from\n",r+="\ttclass\n",r+="where\n",r+="\t"+e.getCurrentFilter()+"\n",s&&s.classId&&(r+="and fid="+s.classId+"\n"),r+="and fid >= 1000\n",r+="order by fid\n",e.query({session:t,sql:r,success:function(e){o=e.result.rows,n()}})},function(s){async.eachSeries(o,function(s,r){var o=s.fid,i=e.getClass(o).toc;return"view_"==i.toLowerCase().substring(0,5)?void r():void e.client.isTableExists({session:t,table:i,success:function(a){if(a)return void r();var c,f="insert into "+i+" (fobject_id",l="select o.fid",d="",u=[];async.series([function(n){if(log.info({cls:"Import"},"Creating toc for class '"+s.fcode+"' ["+o+"] ..."),"mssql"==e.client.database)e.query({session:t,sql:"create table "+i+" (fobject_id bigint primary key clustered)",success:function(e){n()}});else{var r="create table "+i+" (fobject_id bigint not null, primary key (fobject_id))";e.client.version>=91&&config.storages[e.code]&&config.storages[e.code].unlogged&&(r="create unlogged table "+i+" (fobject_id bigint not null, primary key (fobject_id))"),e.query({session:t,sql:r,success:function(){n()}})}},function(s){u.push(o),n.getChilds({table:"tclass",parentId:o,childs:u,success:function(n){u=n,e.query({session:t,sql:"select\n\t"+ifields.tclass_attr+"\nfrom\n\ttclass_attr ca\nwhere\n\tca.fclass_id = "+o+" and\n\t"+e.getCurrentFilter({alias:"ca"})+"\norder by ca.fid\n",success:function(e){c=e.result.rows,s()}})}})},function(s){async.eachSeries(c,function(s,n){var r=s.fid,o={};try{o=JSON.parse(s.fformat_func)||{}}catch(e){}var a="$tnumber$",c="fnumber";switch(s.ftype_id){case 2:a="$tnumber_value$";break;case 1:case 5:a="$ttext$",c="fstring";break;case 3:a="$ttimestamp$",c="ftime"}var u=e.getClassAttr(r).toc,g="alter table "+i+" add column "+u+" "+a;"mssql"==e.client.database&&(g="alter table "+i+" add "+u+" "+a),e.query({session:t,sql:g,success:function(){if(f+=", "+u,l+=", oa"+r+"."+c,d+="left join tobject_attr oa"+r+" on (oa"+r+".fobject_id = o.fid and oa"+r+".fclass_attr_id = "+r+" and "+e.getCurrentFilter({alias:"oa"+r})+")\n",12==s.ftype_id||s.ftype_id>=1e3||s.funique||o.index){log.info({cls:"Import"},"created index for class_attr: "+s.fcode);var a="create index "+i+"_"+u+" on $schema_prefix$"+i+" ("+u+")";s.funique&&"mssql"==e.client.database&&"fstring"==c&&(a="create index "+i+"_"+u+" on $schema_prefix$"+i+" (fobject_id) include ("+u+")"),e.query({session:t,sql:a,success:function(){n()}})}else if(config.index&&config.index.text_pattern_ops&&1==s.ftype_id&&"postgres"==e.client.database){log.info({cls:"Import"},"created text index for class_attr: "+s.fcode);var a="create index "+i+"_"+u+" on $schema_prefix$"+i+" ("+u+" text_pattern_ops)";e.query({session:t,sql:a,success:function(){n()}})}else if(config.index&&config.index.substr&&1==s.ftype_id&&"postgres"==e.client.database){log.info({cls:"Import"},"created text index for class_attr: "+s.fcode);var a="create index "+i+"_"+u+" on $schema_prefix$"+i+" (substr ("+u+", 1, 1024))";e.query({session:t,sql:a,success:function(){n()}})}else n()}})},function(e){s()})},function(n){log.info({cls:"Import"},"Inserting toc data for class '"+s.fcode+"' ["+o+"] ..."),f=f+")\n"+l+" from $schema_prefix$tobject o\n"+d,f+="where\to.fclass_id in ("+u.join()+") and "+e.getCurrentFilter({alias:"o"})+"\n",f+="order by o.fid\n",e.query({session:t,sql:f,success:function(){n()}})}],function(e,t){r()})}})},function(e){s()})}],function(e,t){r()})},this.importFromFile=function(s){var n=this,r=s.success;t={id:"import_"+s.code,username:"admin",userId:null},log.info({cls:"Import",fn:"importFromFile"}),async.series([function(e){fs.exists(s.file,function(t){t?fs.readFile(s.file,function(t,s){n.data=JSON.parse(s),e()}):e("file not exists.")})},function(t){s.storage?(e=n.storage=s.storage,t()):projects.loadConfig({code:s.code,success:function(){e=new Storage({code:s.code,connection:config.storages[s.code],success:function(){n.storageCreated=!0,t()}})},failure:function(e){t(e)}})},function(n){e.startTransaction({session:t,remoteAddr:"127.0.0.1",description:"import_"+s.code,success:function(){n()},failure:function(e){n(e.error)}})},function(e){n.getSequences({session:t,success:function(){e()}})},function(s){e.query({session:t,sql:"select fcode from tschema",success:function(e){for(var t=e.result.rows,n=0;n<t.length;n++)if(!t[n].fcode||"undefined"==t[n].fcode)return void s("Schema undefined.");s()}})},function(s){n.count.tclass=0,n.count.tclass_attr=0,n.count.tview=0,n.count.tview_attr=0,n.count.taction=0,n.count.taction_attr=0,n.count.tobject=0,n.count.tobject_attr=0,n.count.trevision=0,async.series([function(e){n.getNewId({success:function(){e()}})},function(e){n.importSchemas({success:function(){e()}})},function(e){n.importRevisions({success:function(){e()}})},function(e){n.generateNewId({success:function(){e()}})},function(s){e.connection.dbEngine&&e.connection.dbEngine.enabled?n.updateEngineTables({session:t},function(){s()}):s()},function(e){n.importViews({success:function(){e()}})},function(e){n.importViewAttrs({success:function(){e()}})},function(e){n.importClasses({success:function(){e()}})},function(e){n.importClassAttrs({success:function(){e()}})},function(e){n.importActions({success:function(){e()}})},function(e){n.importObjects({success:function(){e()}})}],s)},function(s){"mssql"==e.client.database?e.query({session:t,sql:"set identity_insert tobject_attr on",success:function(e){s()}}):s()},function(s){e.connection.dbEngine&&e.connection.dbEngine.enabled?e.query({session:t,sql:"create trigger tobject_attr_after_insert\nafter insert on tobject_attr for each row \nexecute procedure trigger_tobject_attr_after_insert ();\n",success:function(e){s()}}):s()},function(e){n.importObjectAttrs({success:function(){e()}})},function(s){e.connection.dbEngine&&e.connection.dbEngine.enabled?e.query({session:t,sql:"drop trigger tobject_attr_after_insert on tobject_attr",success:function(e){s()}}):s()},function(s){"mssql"==e.client.database?e.query({session:t,sql:"set identity_insert tobject_attr off",success:function(e){s()}}):s()},function(s){e.commitTransaction({session:t,success:function(){s()}})},function(t){e.client.updateSequences({success:function(){t()}})},function(r){log.info({cls:"Import"},"records count:\n"+JSON.stringify(n.count,0,"\t")),!s.keepToc&&(n.count.tclass||n.count.tclass_attr||n.count.tobject||n.count.tobject_attr)?async.series([function(t){e.initClasses({success:function(){t()}})},function(t){e.initClassAttrs({success:function(){t()}})},function(n){e.startTransaction({session:t,remoteAddr:"127.0.0.1",description:"import_"+s.code,success:function(){n()}})},function(t){!e.connection.dbEngine||e.connection.dbEngine&&!e.connection.dbEngine.enabled?n.removeTOC({success:function(){t()}}):t()},function(t){!e.connection.dbEngine||e.connection.dbEngine&&!e.connection.dbEngine.enabled?n.createTOC({success:function(){t()}}):t()},function(s){e.commitTransaction({session:t,success:function(){s()}})}],function(e){r()}):r()},function(e){var t=redis.createClient(config.redis.port,config.redis.host);t.del(s.code+"-requests"),t.del(s.code+"-objects"),t.keys("*-content",function(e,s){for(var n=0;n<s.length;n++)t.del(s[n])}),t.keys("*-clschange",function(e,s){for(var n=0;n<s.length;n++)t.del(s[n])}),e()}],function(o,i){o?(log.info({cls:"Import",error:o}),e?e.rollbackTransaction({session:t,success:function(){r()}}):r()):r(),n.storageCreated&&e.freeResources(),s.noExit||process.exit(1)})}},smtpTransport=nodemailer.createTransport("SMTP",config.mail.smtp),mailSender={smtpTransport:{}};mailSender.send=function(e){var t=e.success,s=e.failure,n=e.session?e.session.storage:null;if(_.has(config.mail,"enabled")&&!config.mail.enabled)return void(t&&t());var r=smtpTransport,o=e.to.split("@")[1];if(n&&n.config.smtp&&n.config.smtp.host){if(e.from=n.config.smtp.sender||e.from,!mailSender.smtpTransport[n.code]){var i={host:n.config.smtp.host,maxConnections:50,port:25,forceSender:n.config.smtp.sender,auth:n.config.smtp.username?{user:n.config.smtp.username,pass:n.config.smtp.password}:void 0};mailSender.smtpTransport[n.code]=nodemailer.createTransport("SMTP",i)}r=mailSender.smtpTransport[n.code]}else e.from=config.mail.smtp.forceSender||e.from,config.mail.smtp[o]&&(mailSender.smtpTransport[o]||(mailSender.smtpTransport[o]=nodemailer.createTransport("SMTP",config.mail.smtp[o])),r=mailSender.smtpTransport[o],e.from=config.mail.smtp[o].forceSender||e.from);var a={from:e.from,to:e.to,envelope:{from:e.from,to:e.to},subject:e.subject||e.topic,text:e.message||e.text,html:e.message||e.html,attachments:e.attachments};r.sendMail(a,function(r,o){r?(log.info({cls:"mailSender"},"mail ("+e.to+"): "+r),a.storage=n,mailSender.saveFailed(a),s&&s(r)):(log.info({cls:"mailSender"},"Message sent ("+e.to+"): "+o.message),t&&t())})},mailSender.saveFailed=function(e){var t=e.storage;if(!e.sendFailed&&t){var s={from:e.from,to:e.to,subject:e.subject,text:e.text,html:e.html};s=JSON.stringify(s),s=s.split("'").join("''"),t.query({sql:"insert into tmail (fcreation_date, fmessage)\nvalues ("+t.client.currentTimestamp()+", '"+s+"')\n"})}},mailSender.sendFailed=function(){var e=[];for(var t in projects.storagePool)e.push(projects.storagePool[t]);async.eachSeries(e,function(e,t){e.query({sql:"select fid, fmessage from tmail\nwhere fsending_date is null\norder by fid\n",success:function(s){s.result.rows;async.eachSeries(s.result.rows,function(t,s){async.series([function(e){try{var s=JSON.parse(t.fmessage);s.success=function(){e()},s.failure=function(){e("fail")},mailSender.send(s)}catch(t){e()}},function(s){e.query({sql:"delete from tmail where fid="+t.fid,success:function(){s()}})}],function(e){s(e)})},function(e){t(e)})}})},function(e){})};var meta={};meta.fields={tclass:["fid","fparent_id","fname","fcode","fdescription","fformat","fview_id","ftype","fsystem"],tclass_attr:["fid","fclass_id","fname","fcode","ftype_id","forder","fnot_null","fvalid_func","fformat_func","fdescription","fsecure","fmax_str","fmin_str","fmax_number","fmin_number","fmax_ts","fmin_ts","funique","fformat_number","fformat_ts","fremove_rule"],tview:["fid","fparent_id","fname","fcode","fdescription","flayout","fkey","fparent_key","fclass_id","funrelated","fquery","ftype","fsystem","fmaterialized","forder","ficon_cls"],tview_attr:["fid","fview_id","fname","fcode","fclass_id","fclass_attr_id","fsubject_id","forder","fsort_kind","fsort_order","foperation","fvalue","farea","fcolumn_width","ftotal_type","fread_only","fgroup","fnot_null"],taction:["fid","fclass_id","fname","fcode","fdescription","forder","fbody","flayout"]},meta.tableCreate=function(e){var t,s=e.request,n=e.response,r=s.session,o=e.table,i=meta.fields[o],a=e.values,c=e.storage,f=c.revision[r.id],l=!!f,d=e.success;async.series([function(e){l?e():c.startTransaction({session:r,remoteAddr:common.getRemoteAddress(s),description:"Create "+o,success:function(t){f=t.revision,projects.sessions[r.id].transaction.active=!0,e()},failure:function(t){e(t.error)}})},function(e){var s=c.getClient({session:r});s.getNextId({table:o,success:function(s){t=s.id,e()}})},function(e){i=i.concat(["fstart_id","fend_id"]),a=a.concat([f,c.maxRevision]),a=[t].concat(a);for(var s=[],n=0;n<a.length;n++)s.push("$"+(n+1));c.query({session:r,sql:"insert into "+o+" ("+i.join(",")+") values ("+s.join(",")+")",params:[].concat(a),success:function(t){e()}})}],function(e,t){e?projects.send({request:s,response:n,msg:"{header: {error: '"+e+"'},data: []}"}):("tclass"==o&&(c.revisions[c.revision[r.id]].classes.created.push({fields:i,values:a}),c.updateClassCache({fields:i,values:a})),"tclass_attr"==o&&(c.revisions[c.revision[r.id]].classAttrs.created.push({fields:i,values:a}),c.updateClassAttrCache({fields:i,values:a})),"tview"==o&&(c.revisions[c.revision[r.id]].views.created.push({fields:i,values:a}),c.updateViewCache({fields:i,values:a})),"tview_attr"==o&&(c.revisions[c.revision[r.id]].viewAttrs.created.push({fields:i,values:a}),c.updateViewAttrCache({fields:i,values:a})),l?d({values:a}):c.commitTransaction({session:r,success:function(e){projects.sessions[r.id].transaction.active=!1,d({values:a})}}))})},meta.tableRemove=function(e){var t=e.request,s=e.response,n=t.session,r=e.table,o=e.values,i=e.storage,a=i.revision[n.id],c=!!a,f=e.success;async.series([function(e){c?e():i.startTransaction({session:n,remoteAddr:common.getRemoteAddress(t),
description:"Create "+r,success:function(t){a=t.revision,projects.sessions[n.id].transaction.active=!0,e()},failure:function(t){e(t.error)}})},function(e){i.query({session:n,sql:"update "+r+" set fend_id="+a+" where fid="+o[0]+" and fend_id="+i.maxRevision,success:function(t){e()}})}],function(e,a){e?projects.send({request:t,response:s,msg:"{header: {error: '"+e+"'},data: []}"}):("tclass"==r&&i.revisions[i.revision[n.id]].classes.removed.push(o[0]),"tclass_attr"==r&&i.revisions[i.revision[n.id]].classAttrs.removed.push(o[0]),"tview"==r&&i.revisions[i.revision[n.id]].views.removed.push(o[0]),"tview_attr"==r&&i.revisions[i.revision[n.id]].viewAttrs.removed.push(o[0]),c?f():i.commitTransaction({session:n,success:function(e){projects.sessions[n.id].transaction.active=!1,f()}}))})},meta.tableUpdate=function(e){var t=e.request,s=e.response,n=t.session,r=e.table,o=meta.fields[r],i=e.values,a=e.storage,c=a.revision[n.id],f=e.success,l=!!c;async.series([function(e){l?e():a.startTransaction({session:n,remoteAddr:common.getRemoteAddress(t),description:"Update "+r,success:function(t){c=t.revision,projects.sessions[n.id].transaction.active=!0,e()},failure:function(t){e(t.error)}})},function(e){a.query({session:n,sql:"update "+r+" set fend_id="+c+" where fid="+i[0]+" and fend_id="+a.maxRevision,success:function(t){e()}})},function(e){o=o.concat(["fstart_id","fend_id"]),i=i.concat([c,a.maxRevision]);for(var t=[],s=0;s<i.length;s++)t.push("$"+(s+1));a.query({session:n,sql:"insert into "+r+" ("+o.join(",")+") values ("+t.join(",")+")",params:i,success:function(t){e()}})}],function(e,c){e?projects.send({request:t,response:s,msg:"{header: {error: '"+e+"'},data: []}"}):("tclass"==r&&(a.revisions[a.revision[n.id]].classes.changed.push({fields:o,values:i}),a.updateClassCache({fields:o,values:i})),"tclass_attr"==r&&(a.revisions[a.revision[n.id]].classAttrs.changed.push({fields:o,values:i}),a.updateClassAttrCache({fields:o,values:i})),"tview"==r&&(a.revisions[a.revision[n.id]].views.changed.push({fields:o,values:i}),a.updateViewCache({fields:o,values:i})),"tview_attr"==r&&(a.revisions[a.revision[n.id]].viewAttrs.changed.push({fields:o,values:i}),a.updateViewAttrCache({fields:o,values:i})),l?f():a.commitTransaction({session:n,success:function(e){projects.sessions[n.id].transaction.active=!1,f()}}))})},meta.tableGet=function(e){var t=e.request,s=e.response,n=t.session,r=e.table,o=meta.fields[r],i=e.values,a=e.storage,c=(e.success,"select "+o.join(",")+" from "+r+" where fid="+i[0]+" and fend_id="+a.maxRevision);if("taction"==r&&"string"==typeof i[0]&&i[0].indexOf(".")>-1){var f=i[0].split("."),l=f[f.length-1],d=f.slice(0,f.length-1).join("."),u=a.getClass(d).get("fid");c="select "+o.join(",")+" from taction\nwhere fclass_id="+u+" and fcode='"+l+"' and fend_id="+a.maxRevision}a.query({session:n,sql:c,success:function(e){var n,r=e.result.rows;n=r.length?r[0]:{};for(var i=[],a=0;a<o.length;a++)i.push(n[o[a]]);projects.send({request:t,response:s,msg:"{header: {error: ''},data: "+JSON.stringify(i)+"}"})}})},meta.fnView=function(e,t,s){if("View"==e.storageArea){if("autologin"==e.session.username&&null==e.session.userId)return void projects.send({request:e,response:t,msg:"{header: {error: 'forbidden'}}"});var n={request:e,response:t,storageCode:e.storageCode,table:"tview",values:JSON.parse("["+e.storageParam+"]")};projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){var r=n.storage=s.storage;"create"==e.storageFn&&(n.success=function(s){var n=s.values;projects.send({request:e,response:t,msg:"{header: {error: ''},data: ["+JSON.stringify(n)+"]}"})},meta.tableCreate(n)),"set"==e.storageFn&&(n.success=function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})},meta.tableUpdate(n)),"remove"==e.storageFn&&(n.success=function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})},meta.tableRemove(n)),r.redisClient.hdel(r.code+"-requests","tview"),r.redisClient.hdel(r.code+"-requests","all")}})}else s()},meta.fnViewAttr=function(e,t,s){if("ViewAttr"==e.storageArea){if("autologin"==e.session.username&&null==e.session.userId)return void projects.send({request:e,response:t,msg:"{header: {error: 'forbidden'}}"});var n={request:e,response:t,storageCode:e.storageCode,table:"tview_attr",values:JSON.parse("["+e.storageParam+"]")};projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){var r=n.storage=s.storage;"create"==e.storageFn&&(n.success=function(s){var n=s.values;projects.send({request:e,response:t,msg:"{header: {error: ''},data: ["+JSON.stringify(n)+"]}"})},meta.tableCreate(n)),"set"==e.storageFn&&(n.success=function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})},meta.tableUpdate(n)),"remove"==e.storageFn&&(n.success=function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})},meta.tableRemove(n)),r.redisClient.hdel(r.code+"-requests","tview_attr"),r.redisClient.hdel(r.code+"-requests","all")}})}else s()},meta.fnClass=function(e,t,s){if("Class"==e.storageArea){if("autologin"==e.session.username&&null==e.session.userId)return void projects.send({request:e,response:t,msg:"{header: {error: 'forbidden'}}"});var n={request:e,response:t,storageCode:e.storageCode,table:"tclass",values:JSON.parse("["+e.storageParam+"]")},r=n.values[2],o=n.values[0];projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){var i=n.storage=s.storage,a=e.session,c=i.revision[a.id],f=!!c;if("create"==e.storageFn&&(n.success=function(s){var n=s.values;if(i.connection.dbEngine&&i.connection.dbEngine.enabled)projects.send({request:e,response:t,msg:"{header: {error: ''},data: ["+JSON.stringify(n)+"]}"});else{var o=r+"_"+n[0];i.query({sql:"create table "+o+" ($tocObjectId$)",success:function(){projects.send({request:e,response:t,msg:"{header: {error: ''},data: ["+JSON.stringify(n)+"]}"})}})}},meta.tableCreate(n)),"set"==e.storageFn){var l=i.getClass(o).toc,d=n.values[3]+"_"+o;async.series([function(t){f?t():i.startTransaction({session:a,remoteAddr:common.getRemoteAddress(e),description:"Remove ca ",success:function(e){c=e.revision,projects.sessions[a.id].transaction.active=!0,t()},failure:function(e){t(e.error)}})},function(e){n.success=function(t){e()},meta.tableUpdate(n)},function(e){l.toLowerCase()!=d.toLowerCase()?i.client.isTableExists({table:l,success:function(t){t?i.connection.dbEngine&&i.connection.dbEngine.enabled?e():i.query({session:a,sql:"alter table "+l+" rename to "+d,success:function(){e()}}):e()}}):e()},function(e){f?e():i.commitTransaction({session:a,success:function(t){projects.sessions[a.id].transaction.active=!1,e()}})}],function(s,n){s&&!f?i.rollbackTransaction({session:a,success:function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})}}):projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})})}"remove"==e.storageFn&&async.series([function(t){f?t():i.startTransaction({session:a,remoteAddr:common.getRemoteAddress(e),description:"Remove c",success:function(e){c=e.revision,projects.sessions[a.id].transaction.active=!0,t()},failure:function(e){t(e.error)}})},function(e){n.success=function(t){e()},meta.tableRemove(n)},function(e){var t=i.getClass(o).toc;i.client.isTableExists({table:t,success:function(s){s?i.query({session:a,sql:"drop table "+t,success:function(){e()},failure:function(){e()}}):e()}})},function(e){f?e():i.commitTransaction({session:a,success:function(t){projects.sessions[a.id].transaction.active=!1,e()}})}],function(s,n){s&&!f?i.rollbackTransaction({session:a,success:function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})}}):projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})}),i.redisClient.hdel(i.code+"-requests","tclass"),i.redisClient.hdel(i.code+"-requests","all")}})}else s()},meta.fnClassAttr=function(e,t,s){if("ClassAttr"==e.storageArea){if("autologin"==e.session.username&&null==e.session.userId)return void projects.send({request:e,response:t,msg:"{header: {error: 'forbidden'}}"});var n={request:e,response:t,storageCode:e.storageCode,table:"tclass_attr",values:JSON.parse("["+e.storageParam+"]")};projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){var r=n.storage=s.storage,o=e.session,i=r.revision[o.id],a=!!i;if("create"==e.storageFn&&(n.success=function(s){var o=s.values,i="$tnumber$";switch(o[4]){case 2:i="$tnumber_value$";break;case 1:case 5:i="$ttext$";break;case 3:i="$ttimestamp$"}var a=n.values[2]+"_"+o[0],c=r.getClass(o[1]).toc;r.client.createField({toc:c,tocField:a,caId:o[0],type:i,success:function(){projects.send({request:e,response:t,msg:"{header: {error: ''},data: ["+JSON.stringify(o)+"]}"})}})},meta.tableCreate(n)),"set"==e.storageFn){var c=n.values[0],f=r.getClassAttr(c),l=r.getClass(f.get("fclass_id")),d=f.toc,u=n.values[3]+"_"+c;async.series([function(t){a?t():r.startTransaction({session:o,remoteAddr:common.getRemoteAddress(e),description:"Remove ca ",success:function(e){i=e.revision,projects.sessions[o.id].transaction.active=!0,t()},failure:function(e){t(e.error)}})},function(e){n.success=function(t){e()},meta.tableUpdate(n)},function(e){d.toLowerCase()!=u.toLowerCase()?r.client.isFieldExists({table:l.toc,field:d,success:function(t){t?r.connection.dbEngine&&r.connection.dbEngine.enabled?e():r.query({session:o,sql:"alter table "+l.toc+" rename column "+d+" to "+u,success:function(){e()}}):e()}}):e()},function(e){a?e():r.commitTransaction({session:o,success:function(t){projects.sessions[o.id].transaction.active=!1,e()}})}],function(s,n){s&&!a?r.rollbackTransaction({session:o,success:function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})}}):projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})})}if("remove"==e.storageFn){var c=n.values[0],f=r.getClassAttr(c),l=r.getClass(f.get("fclass_id"));async.series([function(t){a?t():r.startTransaction({session:o,remoteAddr:common.getRemoteAddress(e),description:"Remove ca ",success:function(e){i=e.revision,projects.sessions[o.id].transaction.active=!0,t()},failure:function(e){t(e.error)}})},function(e){n.success=function(t){e()},meta.tableRemove(n)},function(e){r.client.isIndexExists({index:l.toc+"_"+c,success:function(t){t?r.query({session:o,sql:"drop index "+l.toc+"_"+c,success:function(){e()},failure:function(){e()}}):e()}})},function(e){r.client.isFieldExists({table:l.toc,field:f.toc,success:function(t){t?r.connection.dbEngine&&r.connection.dbEngine.enabled?e():r.query({session:o,sql:"alter table "+l.toc+" drop column "+f.toc,success:function(){e()},failure:function(){e()}}):e()}})},function(e){a?e():r.commitTransaction({session:o,success:function(t){projects.sessions[o.id].transaction.active=!1,e()}})}],function(s,n){s&&!a?r.rollbackTransaction({session:o,success:function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})}}):projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})})}r.redisClient.hdel(r.code+"-requests","tclass_attr"),r.redisClient.hdel(r.code+"-requests","all")}})}else s()},meta.fnAction=function(e,t,s){if("Action"==e.storageArea){if("autologin"==e.session.username&&null==e.session.userId)return void projects.send({request:e,response:t,msg:"{header: {error: 'forbidden'}}"});var n;try{n=JSON.parse("["+e.storageParam+"]")}catch(s){return void projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})}var r={request:e,response:t,storageCode:e.storageCode,table:"taction",values:n};projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){r.storage=s.storage;"create"==e.storageFn&&(r.success=function(s){var n=s.values;projects.send({request:e,response:t,msg:"{header: {error: ''},data: ["+JSON.stringify(n)+"]}"})},meta.tableCreate(r)),"set"==e.storageFn&&(r.success=function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})},meta.tableUpdate(r)),"remove"==e.storageFn&&(r.success=function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})},meta.tableRemove(r)),"get"==e.storageFn&&meta.tableGet(r)}})}else s()};var mimetypes={};mimetypes.types={"3gp":"video/3gpp",aiff:"audio/x-aiff",arj:"application/x-arj-compressed",asf:"video/x-ms-asf",asx:"video/x-ms-asx",au:"audio/ulaw",avi:"video/x-msvideo",bcpio:"application/x-bcpio",ccad:"application/clariscad",cod:"application/vnd.rim.cod",com:"application/x-msdos-program",cpio:"application/x-cpio",cpt:"application/mac-compactpro",csh:"application/x-csh",css:"text/css",deb:"application/x-debian-package",dl:"video/dl",doc:"application/msword",docx:"application/msword",drw:"application/drafting",dvi:"application/x-dvi",dwg:"application/acad",dxf:"application/dxf",dxr:"application/x-director",etx:"text/x-setext",ez:"application/andrew-inset",fli:"video/x-fli",flv:"video/x-flv",gif:"image/gif",gl:"video/gl",gtar:"application/x-gtar",gz:"application/x-gzip",hdf:"application/x-hdf",hqx:"application/mac-binhex40",html:"text/html; charset=utf-8",ice:"x-conference/x-cooltalk",ico:"image/x-icon",ief:"image/ief",igs:"model/iges",ips:"application/x-ipscript",ipx:"application/x-ipix",jad:"text/vnd.sun.j2me.app-descriptor",jar:"application/java-archive",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json; charset=utf-8",latex:"application/x-latex",lsp:"application/x-lisp",lzh:"application/octet-stream",m:"text/plain",m3u:"audio/x-mpegurl",m4v:"video/mp4",man:"application/x-troff-man",me:"application/x-troff-me",midi:"audio/midi",mif:"application/x-mif",mime:"www/mime",mkv:"video/x-matrosk",movie:"video/x-sgi-movie",mp4:"video/mp4",mp41:"video/mp4",mp42:"video/mp4",mpg:"video/mpeg",mpga:"audio/mpeg",ms:"application/x-troff-ms",mustache:"text/plain",nc:"application/x-netcdf",oda:"application/oda",ogm:"application/ogg",pbm:"image/x-portable-bitmap",pdf:"application/pdf",pgm:"image/x-portable-graymap",pgn:"application/x-chess-pgn",pgp:"application/pgp",pm:"application/x-perl",png:"image/png",pnm:"image/x-portable-anymap",ppm:"image/x-portable-pixmap",ppz:"application/vnd.ms-powerpoint",pre:"application/x-freelance",prt:"application/pro_eng",ps:"application/postscript",qt:"video/quicktime",ra:"audio/x-realaudio",rar:"application/x-rar-compressed",ras:"image/x-cmu-raster",rgb:"image/x-rgb",rm:"audio/x-pn-realaudio",rpm:"audio/x-pn-realaudio-plugin",rtf:"text/rtf",rtx:"text/richtext",scm:"application/x-lotusscreencam",set:"application/set",sgml:"text/sgml",sh:"application/x-sh",shar:"application/x-shar",silo:"model/mesh",sit:"application/x-stuffit",skt:"application/x-koan",smil:"application/smil",snd:"audio/basic",sol:"application/solids",spl:"application/x-futuresplash",src:"application/x-wais-source",stl:"application/SLA",stp:"application/STEP",sv4cpio:"application/x-sv4cpio",sv4crc:"application/x-sv4crc",svg:"image/svg+xml",swf:"application/x-shockwave-flash",tar:"application/x-tar",tcl:"application/x-tcl",tex:"application/x-tex",texinfo:"application/x-texinfo",tgz:"application/x-tar-gz",tiff:"image/tiff",tr:"application/x-troff",tsi:"audio/TSP-audio",tsp:"application/dsptype",tsv:"text/tab-separated-values",unv:"application/i-deas",ustar:"application/x-ustar",vcd:"application/x-cdlink",vda:"application/vda",vivo:"video/vnd.vivo",vrm:"x-world/x-vrml",wav:"audio/x-wav",wax:"audio/x-ms-wax",webm:"video/webm",wma:"audio/x-ms-wma",wmv:"video/x-ms-wmv",wmx:"video/x-ms-wmx",wrl:"model/vrml",wvx:"video/x-ms-wvx",xbm:"image/x-xbitmap",xls:"application/vnd.ms-excel",xlsx:"application/vnd.ms-excel",xlw:"application/vnd.ms-excel",xml:"text/xml",xpm:"image/x-xpixmap",xwd:"image/x-xwindowdump",xyz:"chemical/x-pdb",zip:"application/zip"},mimetypes.lookup=function(e,t){return t=t||"application/octet-stream",e in mimetypes.types?mimetypes.types[e]:t};var projects={};projects.init=function(e){redisClient=redis.createClient(config.redis.port,config.redis.host),redisPub=redis.createClient(config.redis.port,config.redis.host),redisSub=redis.createClient(config.redis.port,config.redis.host),async.series([function(e){config.redis.db?redisClient.select(config.redis.db,function(t,s){redisPub.select(config.redis.db,function(t,s){redisSub.select(config.redis.db,function(t,s){e()})})}):e()}],function(t){redisSub.on("message",function(e,t){if(e==config.redis.db+"-storages"){var s=JSON.parse(t);s.free&&projects.storagePool&&(projects.storagePool[s.free].freeResources(),delete projects.storagePool[s.free])}if(e==config.redis.db+"-cluster"&&"restart"==t&&process.exit(1),e==config.redis.db+"-sessions"){var s=JSON.parse(t),n=projects.sessions[s.removed];n&&n.storage&&n.storage.rollbackTransaction({session:n}),s.removed&&projects.sessions[s.removed]&&delete projects.sessions[s.removed]}if(e==config.redis.db+"-connections"){var s=JSON.parse(t);if(s.terminate)for(var r in projects.storagePool){var o=projects.storagePool[r],i=0;for(var a in o.clientPool){var c=o.clientPool[a];c.pid==s.terminate&&(i=1,log.info({cls:"connections"},"connections disconnect "+s.terminate),o.rollbackTransaction({session:projects.sessions[a],success:function(){}}))}!i&&db.Postgres.clients&&db.Postgres.clients[s.terminate]&&(log.info({cls:"connections"},"connections disconnect db.Postgres "+s.terminate),db.Postgres.clients[s.terminate].disconnect())}}}),redisSub.subscribe(config.redis.db+"-storages"),redisSub.subscribe(config.redis.db+"-sessions"),redisSub.subscribe(config.redis.db+"-connections"),redisSub.subscribe(config.redis.db+"-cluster"),e.success()})},projects.loadConfig=function(e){var t=e.code,s=e.success,n=e.failure;!config.storages.hasOwnProperty(t)&&config.projectsDir?fs.readFile(config.projectsDir+"/"+t+"/config.json",function(e,r){if(e)n("Unknown storage: "+t);else try{config.storages[t]=JSON.parse(r),s()}catch(e){n("Unknown storage: "+t)}}):s()},projects.getHandler=function(e,t,s){var n=e.url.split("/");if(3==n.length)return n.push(""),void t.redirect(n.join("/"));var r=n[2],o="/"+n.slice(3).join("/");"/"==o&&(o="/index.html"),o=o.split("?")[0],projects.loadConfig({code:r,success:function(){var n=config.storages[r].rootDir+o;server.www({request:e,response:t,next:s,filePath:n,nocache:"/files"==o.substr(0,6)})},failure:function(s){t.end("unknown url: "+e.url)}})},projects.startProjectPlugins=function(e){e=e||{};var t=e.success,s=e.storage;async.series([function(e){if(config.storages[s.code].pluginStarted||config.storages[s.code].disablePlugins)return void e();config.storages[s.code].pluginStarted=1;var t=config.storages[s.code].rootDir+"/plugins/plugins.js";fs.exists(t,function(n){if(n){var r=require(t);async.series([function(e){r.init&&server.objectum?r.init({objectum:server.objectum,storage:s,success:function(){log.info({cls:"plugins"},"plugin "+t+" initialized."),e()},failure:function(s){log.error({cls:"plugins",error:t+" error: "+s}),e()}}):e()}],function(n,o){r.handler&&(server.projectPlugins[s.code]=r.handler,log.info({cls:"plugins"},"plugin "+t+" handler activated.")),e()})}else e()})}],function(e,s){t&&t()})},projects.storagePool={},projects.getStorage=function(e){log.info({cls:"projects",fn:"getStorage",code:e.storageCode});var t=e.request,s=e.response,n=e.success,r=e.failure,o=e.storageCode;projects.storagePool[o]?n({storage:projects.storagePool[o]}):async.series([function(e){(config.port==config.startPort||process.env.mainWorker)&&config.redis.resetCache?(redisClient.del(o+"-requests"),redisClient.del(o+"-objects"),redisClient.del(o+"-sequences"),redisClient.del(o+"-vars"),redisClient.keys(o+"-objects*",function(t,s){for(var n=0;n<s.length;n++)redisClient.del(s[n]);e()})):e()},function(e){projects.loadConfig({code:o,success:function(){e()},failure:function(t){e(t)}})},function(e){projects.storagePool[o]=new Storage({code:o,connection:config.storages[o],authInfoUpdater:!0,success:function(){projects.storagePool[o].config=config.storages[o],projects.storagePool[o].rootDir=config.storages[o].rootDir,projects.storagePool[o].visualObjectum=config.storages[o].visualObjectum||{},config.port==config.startPort||process.env.mainWorker?projects.reloadUniqueValues({storage:projects.storagePool[o],success:function(){e()}}):e()},failure:function(n){t&&s&&projects.sendError({request:t,response:s,error:n.error}),e(n.error)}})},function(e){projects.storagePool[o].visualObjectum.timeMachine&&projects.storagePool[o].visualObjectum.timeMachine.showDates?projects.storagePool[o].query({sql:"select fid, fdate from trevision where ftoc=1 order by fdate desc",success:function(t){for(var s=[],n=0;n<t.result.rows.length;n++){var r=t.result.rows[n];s.push({id:r.fid,date:r.fdate})}projects.storagePool[o].visualObjectum.timeMachine.dates=s,e()}}):e()},function(e){tm.build(projects.storagePool[o]),e()},function(e){projects.startProjectPlugins({storage:projects.storagePool[o],success:function(){e()}})}],function(e,t){e?r&&(log.error({cls:"projects",fn:"getStorage",error:e}),r({error:e})):n({storage:projects.storagePool[o]})})},projects.sessions={},projects.saveSession=function(e){var t={};t[e.id+"-id"]=e.id,t[e.id+"-username"]=e.username,t[e.id+"-clock"]=String(e.activity.clock),t[e.id+"-storageCode"]=e.storage.code,t[e.id+"-newsRevision"]=String(e.news.revision),t[e.id+"-port"]=String(config.port),e.userId&&(t[e.id+"-userId"]=String(e.userId)),e.logined&&(t[e.id+"-logined"]=String(e.logined)),e.ip&&(t[e.id+"-ip"]=String(e.ip)),redisClient.hmset("sessions",t)},projects.tryLogin=function(e){var t=e.success,s=e.storage,n=e.session,r=e.authOld,o=n.id;e.cookies;projects.sessions[o]=n,projects.saveSession(n);var i="null",a="null";s.subjectRoles[n.userId]&&(i=s.subjectRoles[n.userId].role,a=s.subjectRoles[n.userId].menu),t(r?{result:o+" "+n.userId+" 3 "+i+" "+a,access:"granted"}:{result:JSON.stringify({sessionId:o,userId:n.userId,roleId:i,menuId:a,access:"granted"})})},projects.authActiveDirectory=function(e,t){var s=e.storage,n=e.login,r=e.password,o=s.config.activeDirectory;if(s.authRecords[n]&&o)try{var i=require("activedirectory"),a=new i(o);a.authenticate(n,r,function(e,s){!e&&s?t("complete"):t()})}catch(e){t()}else t()},projects.checkAuth=function(e,t,s){var n=function(s){var n=s.storage,r=s.login,o=s.password,i=s.authOld;if("admin"==r&&o==config.storages[n.code].adminPassword){var a=sha.hex_sha1(common.getRemoteAddress(e)+(new Date).getTime()+Math.random());return projects.sessions[a]={id:a,username:"admin",userId:null,activity:{clock:config.clock},storage:n,news:{revision:0},transaction:{active:!1},logined:common.currentUTCTimestamp(),ip:common.getRemoteAddress(e)},projects.saveSession(projects.sessions[a]),i?projects.send({request:e,response:t,msg:a+" null 3 admin admin"}):projects.send({request:e,response:t,msg:JSON.stringify({sessionId:a,userId:null,roleId:"admin",menuId:"admin"})}),!0}return!1},r=function(s){var n=s.storage,r=s.login,o=(s.password,s.authOld);if("autologin"==r&&config.storages[n.code].autologin){var i=sha.hex_sha1(common.getRemoteAddress(e)+(new Date).getTime()+Math.random());return projects.sessions[i]={id:i,username:"autologin",userId:null,activity:{clock:config.clock},storage:n,news:{revision:0},transaction:{active:!1},logined:common.currentUTCTimestamp(),ip:common.getRemoteAddress(e)},projects.saveSession(projects.sessions[i]),o?projects.send({request:e,response:t,msg:i+" null 3 autologin autologin"}):projects.send({request:e,response:t,msg:JSON.stringify({sessionId:i,userId:null,roleId:"autologin",menuId:"autologin"})}),!0}return!1},o=function(s){var n,r,o,i=s.storage,a=s.login,c=s.password,f=s.passwordPlain,l=s.authOld;return i.authRecords[a]&&i.authRecords[a].tryNum>=3&&config.clock-i.authRecords[a].lastTry<600?l?projects.send({request:e,response:t,msg:"wait "+(600-(config.clock-i.authRecords[a].lastTry))}):projects.send({request:e,response:t,msg:JSON.stringify({wait:600-(config.clock-i.authRecords[a].lastTry)})}):void async.series([function(t){i.authRecords[a]&&i.authRecords[a].password==c?(r=sha.hex_sha1(common.getRemoteAddress(e)+(new Date).getTime()+Math.random()),n=i.authRecords[a].objectId,o={id:r,username:a,userId:n,roles:i.ose.subject.getRoles(n),activity:{clock:config.clock},storage:i,news:{revision:0},transaction:{active:!1},logined:common.currentUTCTimestamp(),ip:common.getRemoteAddress(e)},t("complete")):projects.authActiveDirectory({storage:i,login:a,password:f},t)}],function(s,n){"complete"==s?projects.tryLogin({storage:i,session:o,cookies:common.getCookies(e.headers.cookie),authOld:l,success:function(s){projects.logLastTry(i,a,!0),projects.send({request:e,response:t,msg:s.result})}}):(projects.logLastTry(i,a,!1),l?projects.send({request:e,response:t,msg:""}):(t.writeHead(401,{"Content-Type":"text/html; charset=utf-8"}),t.end('{"error": "401 Unauthenticated"}')))})},i=function(t){e.session=projects.sessions[e.session.id],e.session.activity.clock=config.clock,redisClient.hset("sessions",e.session.id+"-clock",config.clock),s()};if(1==e.query.authorize){var a,c,f,l,d=!1;try{l=JSON.parse(e.body),a=l.username,c=l.password,f=l.passwordPlain}catch(t){d=!0;var u=e.body.split("\n");a=u[0],c=u[1],f=u.length>2?u[2]:null}var u=e.url.split("/"),g=u[2];projects.getStorage({request:e,response:t,storageCode:g,success:function(e){var t=e.storage;n({storage:t,login:a,password:c,authOld:d})||r({storage:t,login:a,password:c,authOld:d})||o({storage:t,login:a,password:c,passwordPlain:f,authOld:d})}})}else projects.sessions[e.session.id]?i():(t.writeHead(401,{"Content-Type":"text/html; charset=utf-8"}),t.end('{"error": "401 Unauthenticated"}'))},projects.sendError=function(e){var t=e.request,s=e.response;e.error&&"object"==typeof e.error&&(e.error.message?e.error=e.error.message:e.error=util.inspect(e.error)),s.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),s.end("{header: {error: "+JSON.stringify(e.error)+"}, data: []}"),log.error({cls:"projects",error:"sessionId: "+t.session.id+", error: "+util.inspect(e.error)})},projects.send=function(e){var t=(e.request,e.response);t.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),t.end(e.msg),log.debug({cls:"projects",fn:"send",params:e.msg})},projects.startTransaction=function(request,response,next){if("startTransaction"==request.storageFn){if(log.debug({cls:"projects",fn:"startTransaction",params:request.storageParam}),"autologin"==request.session.username&&null==request.session.userId)return void projects.send({request:request,response:response,msg:"{header: {error: 'forbidden'}}"});var params=eval("("+request.storageParam+")"),storage;async.series([function(e){projects.getStorage({request:request,response:response,storageCode:request.storageCode,success:function(t){storage=t.storage,e()}})},function(e){projects.sessions[request.session.id].transaction.active?storage.commitTransaction({session:request.session,success:function(t){projects.sessions[request.session.id].transaction.active=!1,e()},failure:function(t){e()}}):e()}],function(e,t){storage.startTransaction({session:request.session,remoteAddr:common.getRemoteAddress(request),description:params,success:function(e){var t=e.revision;projects.sessions[request.session.id]?(projects.sessions[request.session.id].transaction.active=!0,projects.send({request:request,response:response,msg:"{header: {error: ''},data: "+t+"}"})):storage.rollbackTransaction({session:request.session,success:function(e){projects.sendError({request:request,response:response,error:"invalid session in start transaction"})}})},failure:function(e){projects.sendError({request:request,response:response,error:new VError(e,"projects.startTransaction")})}})})}else next()},projects.commitTransaction=function(e,t,s){"commitTransaction"==e.storageFn?(log.debug({cls:"projects",fn:"commitTransaction",params:e.storageParam}),projects.sessions[e.session.id].transaction.active?projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){var n=s.storage;n.commitTransaction({session:e.session,success:function(s){projects.sessions[e.session.id].transaction.active=!1,projects.send({request:e,response:t,msg:"{header: {error: ''},data: "+s.revision+"}"})},failure:function(s){projects.sendError({request:e,response:t,error:new VError(s,"projects.commitTransaction")})}})}}):projects.send({request:e,response:t,msg:"{header: {error: ''},data: 'Transaction not active'}"})):s()},projects.rollbackTransaction=function(e,t,s){"rollbackTransaction"==e.storageFn?(log.debug({cls:"projects",fn:"rollbackTransaction"}),projects.sessions[e.session.id].transaction.active?projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){var n=s.storage;n.rollbackTransaction({session:e.session,success:function(s){projects.sessions[e.session.id].transaction.active=!1,projects.send({request:e,response:t,msg:"{header: {error: ''},data: "+s.revision+"}"})},failure:function(s){projects.sendError({request:e,response:t,error:new VError(s,"projects.rollbackTransaction")})}})}}):projects.send({request:e,response:t,msg:"{header: {error: ''},data: 'Transaction not active'}"})):s()},projects.getObject=function(e,t,s){if("getObject"==e.storageFn){log.debug({cls:"projects",fn:"getObject",params:e.storageParam});var n,r=e.storageCode;try{n=JSON.parse(e.storageParam)}catch(s){var o="{header: {error: ''},data: {id: null, classId: null, attrs: {}}}";return void projects.send({request:e,response:t,msg:o})}projects.getStorage({request:e,response:t,storageCode:r,success:function(s){var r=s.storage;projects.sessions[e.session.id].storage=r,r.getObject({session:e.session,id:n,success:function(s){var r=s.object,o="{header: {error: ''},data: {";if(r){o+="id:"+n+", classId: "+r.data.fclass_id+", attrs: {";var i=0;for(var a in r.data)["id","fclass_id"].indexOf(a)>-1||(i&&(o+=","),o+='"'+a+'":'+common.ToJSONString(r.data[a]),i++)}else o+="id: null, classId: null, attrs: {";o+="}}}",projects.send({request:e,response:t,msg:o})},failure:function(s){projects.sendError({request:e,response:t,error:new VError(s,"projects.getObject")})}})}})}else s()},projects.removeObject=function(e,t,s){if("Object"==e.storageArea&&"remove"==e.storageFn){if(log.debug({cls:"projects",fn:"removeObject",params:e.storageParam}),"autologin"==e.session.username&&null==e.session.userId)return void projects.send({request:e,response:t,msg:"{header: {error: 'forbidden'}}"});if(e.session.revision)return void projects.send({request:e,response:t,msg:"{header: {error: 'read only mode (time machine)'}}"});if(projects.sessions[e.session.id].transaction.active){var n=e.storageCode,r=e.storageParam;projects.getStorage({request:e,response:t,storageCode:n,success:function(s){var n=s.storage;n.getObject({session:e.session,id:r,success:function(s){var n,r,o=s.object;o?(o.remove(),async.series([function(t){projects.removeObject.beforeCommit?projects.removeObject.beforeCommit({session:e.session,object:o,success:function(){t()}}):t()},function(t){o.commit({session:e.session,success:function(e){n=e.cascadeNum,r=e.setnullNum,t()},failure:t})}],function(s,o){s?projects.sendError({request:e,response:t,error:new VError(s,"projects.removeObject")}):projects.send({request:e,response:t,msg:"{header: {error: ''}, data: [], cascadeNum: "+n+", setnullNum: "+r+"}"})})):projects.send({request:e,response:t,msg:"{header: {error: ''}, data: []}"})},failure:function(s){projects.sendError({request:e,response:t,error:new VError(s,"projects.removeObject")})}})}})}else projects.sendError({request:e,response:t,error:"Transaction not active"})}else s()},projects.setAttrs=function(request,response,next){if("setAttrs"==request.storageFn){if(log.debug({cls:"projects",fn:"setAttrs",params:request.storageParam}),"autologin"==request.session.username&&null==request.session.userId)return void projects.send({request:request,response:response,msg:"{header: {error: 'forbidden'}}"});if(request.session.revision)return void projects.send({request:request,response:response,msg:"{header: {error: 'read only mode (time machine)'}}"});if(projects.sessions[request.session.id].transaction.active){var s=request.storageParam;s=s.substr(2,s.length-4);
var tokens=eval(s),objectId=tokens[0],attrs=tokens[1],classId=tokens[2],storageCode=request.storageCode;projects.getStorage({request:request,response:response,storageCode:storageCode,success:function(e){var t=e.storage,s=function(e){var t=[],s=new Date,n=common.getUTCTimestamp(s);for(var r in attrs){var o=attrs[r].value;"$CURRENT_TIMESTAMP$"==o&&(o=n,t.push(r)),e.set(r,o)}async.series([function(t){projects.setAttrs.beforeCommit?projects.setAttrs.beforeCommit({session:request.session,object:e,success:function(){t(null,null)}}):t(null,null)},function(t){e.commit({session:request.session,success:function(){t(null,null)},failure:t})}],function(n,r){if(n)projects.sendError({request:request,response:response,error:new VError(n,"projects.setAttrs")});else{for(var o=0;o<t.length;o++)e.data[t[o]]=s;projects.send({request:request,response:response,msg:"{header: {error: ''}, data: "+common.ToJSONString(e.data)+"}"})}})};objectId?t.getObject({session:request.session,id:objectId,success:function(e){e.object?s(e.object):projects.send({request:request,response:response,msg:"{header: {error: ''},data: {id: null, classId: null, attrs: {}}}"})},failure:function(e){projects.sendError({request:request,response:response,error:new VError(e,"projects.setAttrs")})}}):t.createObject({session:request.session,classId:classId,success:function(e){e.object?s(e.object):projects.send({request:request,response:response,msg:"{header: {error: ''},data: {id: null, classId: null, attrs: {}}}"})},failure:function(e){projects.sendError({request:request,response:response,error:new VError(e,"projects.setAttrs")})}})}})}else projects.sendError({request:request,response:response,error:"Transaction not active"})}else next()},projects.execute=function(e,t,s){if("execute"==e.storageFn){var n=e.storageCode;projects.getStorage({request:e,response:t,storageCode:n,success:function(s){var n=s.storage;log.debug({cls:"projects",fn:"execute",params:e.storageParam});var r=JSON.parse(e.storageParam.substr(2,e.storageParam.length-4));n.execute({session:e.session,sql:r,resultText:!0,success:function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: "+s.result+"}"})},failure:function(s){projects.sendError({request:e,response:t,error:new VError(s,"projects.execute")})}})}})}else s()},projects.news={},projects.news.message={},projects.news.getObj=function(e,t){var s=e.body.split(" ");if(2==s.length){var n=s[0],r=s[1];projects.getStorage({request:e,response:t,storageCode:n,success:function(s){var n=s.storage;setTimeout(function(){if(!projects.sessions[e.session.id])return t.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),void t.end("{header: {error: 'session removed'}, data: []}");var s=projects.news.message[e.session.id];if(s&&(s="'"+s+"'",delete projects.news.message[e.session.id]),0==r||r==n.lastRevision)t.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),t.end("{header: {error: ''}, revision: "+n.lastRevision+", objects: [], message: "+s+"}");else{var o=[];for(var i in n.revisions)i>r&&(o=o.concat(n.revisions[i].objects.changed));t.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),t.end("{header: {error: ''}, revision: "+n.lastRevision+", objects: "+JSON.stringify(o)+", message: "+s+"}")}projects.sessions[e.session.id].storage=n,projects.sessions[e.session.id].news.revision=n.lastRevision},config.news.pollingInterval)}})}else t.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),t.end("{header: {error: 'Incorrect format. Must be storageCode and revision.'}, data: []}")},projects.news.gc=function(){for(var e in projects.storagePool){var t,s=projects.storagePool[e];for(var n in projects.sessions){var r=projects.sessions[n].news;projects.sessions[n].storage==s&&(!t||r.revision<t)&&(t=r.revision)}for(var o in s.revisions)o<t&&(delete s.revisions[o],log.debug({cls:"projects",fn:"news.gc"},"revision "+o+" removed"))}setTimeout(projects.news.gc,config.news.gcInterval)},projects.removeSession=function(e){var t=e.success,s=e.sessionId;redisClient.hmget("sessions",[s+"-storageCode",s+"-username"],function(e,n){redisClient.hdel("sessions",s+"-id",s+"-username",s+"-clock",s+"-storageCode",s+"-newsRevision",s+"-port",s+"-userId",s+"-logined",s+"-ip"),redisPub.publish(config.redis.db+"-sessions",'{"removed":"'+s+'"}'),log.debug({cls:"projects",fn:"removeSession"},"session "+s+" removed"),t()})},projects.removeTimeoutSessions=function(){if(config.port==config.startPort||process.env.mainWorker){log.info({cls:"projects",fn:"projects.removeTimeoutSessions"});var e=config.session.timeoutInterval/1e3;redisClient.hgetall("sessions",function(t,s){var n=[];for(var r in s)if(r.indexOf("-clock")>-1&&config.clock>Number(s[r])&&config.clock-Number(s[r])>2*e){var o=r.substr(0,r.length-6);n.push(o),log.info({cls:"projects"},"session removing: "+o+" "+config.clock+" "+s[r]+" "+2*e)}async.map(n,function(t,n){async.series([function(e){var s=projects.sessions[t];s&&s.storage?s.storage.rollbackTransaction({session:s,success:function(t){e()}}):e()},function(n){projects.removeSession({sessionId:t,success:function(){log.info({cls:"projects"},"session removed: "+t+" "+config.clock+" "+s[t+"-clock"]+" "+e),n()}})}],function(e,t){n()})},function(e,t){})})}},projects.createStorages=function(e){var t=[];for(var s in config.storages)config.storages[s].hasOwnProperty("db")&&t.push(s);async.map(t,function(e,t){projects.getStorage({storageCode:e,success:function(e){t()},failure:function(e){log.error({cls:"projects",error:"Storage error: "+e.error}),t()}})},function(t,s){e.success()})},projects.getTableRecords=function(e){var t=e.request,s=e.response,n=e.table,r=e.fields,o=e.success,i=e;projects.getStorage({request:t,response:s,storageCode:e.storageCode,success:function(e){var t=e.storage;t.redisClient.hget(t.code+"-requests",n,function(e,s){if(s)i.result=s,o.call(i.scope||this,i);else{var a="";"tview"==n&&(a=" and (fsystem is null or (fsystem is not null and fclass_id is not null))"),t.query({sql:"select\n\t"+r.join(",")+"\nfrom\n\t"+n+"\nwhere\n\t"+t.getCurrentFilter()+a+"\norder by fid",success:function(e){for(var s="[",a=e.result.rows,c=0;c<a.length;c++){c&&(s+=","),s+="[";for(var f=0;f<r.length;f++){f&&(s+=",");var l=a[c][r[f]];s+=common.ToJSONString(l)}"tview"==n&&(s+=", 0"),s+="]"}s+="]",t.redisClient.hset(t.code+"-requests",n,s),i.result=s,o.call(i.scope||this,i)}})}})}})},projects.sendTableRecords=function(e){e.scope=this,e.success=function(e){e.msg=e.result,projects.send(e)},projects.getTableRecords(e)},projects.getAll=function(e,t,s){if("getAll"==e.storageFn){log.debug({cls:"projects",fn:"getAll"});var n=function(s){var n=s.storage,r="{";async.parallel([function(s){projects.getTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tclass",fields:meta.fields.tclass,success:function(e){r+='"classes": '+e.result+",",s()}})},function(s){projects.getTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tclass_attr",fields:meta.fields.tclass_attr,success:function(e){r+='"classAttrs": '+e.result+",",s()}})},function(s){projects.getTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tview",fields:meta.fields.tview,success:function(e){r+='"views": '+e.result+",",s()}})},function(s){projects.getTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tview_attr",fields:meta.fields.tview_attr,success:function(e){r+='"viewAttrs": '+e.result+",",s()}})}],function(s,o){if(n.visualObjectum.timeMachine&&n.visualObjectum.timeMachine.dates)for(var i=n.visualObjectum.timeMachine.dates,a=0;a<i.length;a++)"string"==typeof i[a].date&&(i[a].date=new Date(i[a].date));r+='"visualObjectum": '+common.ToJSONString(n.visualObjectum)+",",r+='"all": 1}',n.redisClient.hset(n.code+"-requests","all",r),projects.send({request:e,response:t,msg:r})})};projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){var r=s.storage;r.redisClient.hget(r.code+"-requests","all",function(r,o){o?projects.send({request:e,response:t,msg:o}):n(s)})}})}else s()},projects.getContent=function(e,t,s){if("getContent"==e.storageFn){log.debug({cls:"projects",fn:"getContent",params:e.storageParam});var n=e.storageCode;projects.getStorage({request:e,response:t,storageCode:n,success:function(s){var n=s.storage,r=e.storageParam.split(","),o=r.slice(6).join(",");o="!"==o[2]?o.substr(3,o.length-5):o.substr(2,o.length-4),o=JSON.parse(o),n.getContent({request:e,response:t,session:e.session,viewId:r[0],column:r[1],row:r[2],columnCount:r[3],rowCount:r[4],parentId:r[5],filter:o.filter,order:o.order,total:o.total,dateAttrs:o.dateAttrs,timeOffsetMin:o.timeOffsetMin,success:function(s){projects.send({request:e,response:t,msg:s.result})},failure:function(s){projects.sendError({request:e,response:t,error:new VError(s,"projects.getContent")})}})}})}else s()},projects.selectRows=function(e,t,s){if("selectRows"==e.storageFn){log.debug({cls:"projects",fn:"selectRows",params:e.storageParam});var n=e.storageCode;projects.getStorage({request:e,response:t,storageCode:n,success:function(s){var n=s.storage,r=e.storageParam.split(","),o=r[0],i=r.slice(2).join(",");i=i.substr(i.indexOf("[!")+2,i.indexOf("!]")-(i.indexOf("[!")+2)),i=JSON.parse(i),n.selectRow({request:e,response:t,session:e.session,viewId:o,viewFilter:i.viewFilter,selectFilter:i.selectFilter,success:function(s){projects.send({request:e,response:t,msg:"{header: {error: ''}, data: ["+s.result+"]}"})},failure:function(s){projects.sendError({request:e,response:t,error:new VError(s,"projects.selectRows")})}})}})}else s()},projects.reloadUniqueValues=function(e){var t=e.storage,s=e.success;async.map(t.classAttrs,function(e,s){if(e.get("funique")){var n=t.code+"-unique-"+e.get("fid");log.debug({cls:"projects"},"Unique values reloading: "+n),async.series([function(e){redisClient.del(n,function(t,s){e()})},function(t){"login"==e.get("fcode")?redisClient.sadd(n,"admin",function(e,s){t()}):t()},function(s){config.storages[t.code].autologin&&"login"==e.get("fcode")?redisClient.sadd(n,"autologin",function(e,t){s()}):s()},function(s){t.query({session:{userId:null},sql:"select "+e.toc+" from "+t.classesMap[e.get("fclass_id")].toc+" where "+e.toc+" is not null",success:function(t){var r=t.result.rows;async.map(r,function(t,s){redisClient.sadd(n,t[e.toc],function(e,t){s()})},function(e,t){s()})}})}],function(e,t){s()})}else s()},function(e,t){s()})},projects.exist=function(e){var t=e.request,s=e.response,n=e.storageCode,r=e.classCode,o=e.attrCode,i=e.value;projects.getStorage({request:t,response:s,storageCode:n,success:function(e){var t=e.storage,a=t.getClassAttr({classCode:r,attrCode:o});a&&redisClient.sismember(n+"-unique-"+a.get("fid"),i,function(e,t){s.writeHead(200,{"Content-Type":"text/html"}),t?s.end("1"):s.end("0")})}})},projects.upload=function(e,t,s){var n=e.session;if(e.url.indexOf("/upload")>-1&&projects.sessions[n.id]){var r=n.storage;if(config.storages[r.code].hasOwnProperty("upload")&&!config.storages[r.code].upload)return void projects.send({request:e,response:t,msg:"{success: false, error: 'upload disabled'}"});var o=new formidable.IncomingForm;o.uploadDir=r.rootDir+"/files",o.parse(e,function(s,n,o){if(o["file-path"]&&o["file-path"].name){var i=r.rootDir+"/files/"+n.objectId+"-"+n.classAttrId+"-"+o["file-path"].name;fs.rename(o["file-path"].path,i,function(s){s?(log.error({cls:"projects",fn:"upload",error:"rename error: "+s+", "+o["file-path"].path+" -> "+i}),projects.send({request:e,response:t,msg:"{success: false, error: '"+s+"'}"})):projects.send({request:e,response:t,msg:"{success: true, file: '"+o["file-path"].name+"'}"})})}else projects.send({request:e,response:t,msg:"{success: false}"})})}else s()},projects.sendmail=function(e,t,s){var n=e.session;if(e.url.indexOf("/sendmail")>-1&&projects.sessions[n.id]){var r=new formidable.IncomingForm;r.parse(e,function(s,r,o){if(s)return log.error({cls:"projects",fn:"sendmail",error:"sendmail error: "+JSON.stringify(s)+" fields: "+JSON.stringify(r)}),void projects.send({request:e,response:t,msg:"{success: false, error: '"+s+"'}"});var i=[];if(r.attachments){var a=projects.sessions[n.id].storage;_.each(JSON.parse(r.attachments),function(e){e.filePath&&(e.filePath=a.rootDir+"/files/"+e.filePath),i.push(e)})}mailSender.send({to:r.to,from:r.from,subject:r.subject,html:r.message,session:e.session,attachments:i,success:function(){log.info({cls:"projects",fn:"sendmail"},"mail sended: "+JSON.stringify(r)),projects.send({request:e,response:t,msg:"{success: true}"})},failure:function(s){log.error({cls:"projects",fn:"sendmail",error:"sendmail error: "+JSON.stringify(s)+" fields: "+JSON.stringify(r)}),projects.send({request:e,response:t,msg:"{success: false, error: '"+s+"'}"})}})})}else s()},projects.services={},projects.services.captcha=function(e,t,s){if(e.url.indexOf("/services")>-1&&1==e.query.captcha){projects.services.images=projects.services.images||[];var n=projects.services.images;n.length||(n.push("30E936A16BDF7A13E3854E793FAC7B09D4673EEB.png"),n.push("4802DE61A70652CD389E566D0794EC61D34EE385.png"),n.push("497CD952DFE895358336AE56AED144ED2179B458.png"),n.push("6480E7583A6D3FCBAD553C9FA7E6AAF5104B93C7.png"),n.push("67403548F8644A7F6320245A898BD49729660708.png"),n.push("6CA1E9A46879877B8C4309EE9C4BC773FBB6E468.png"),n.push("6E48C6506E6E63852526E0CF1808B548AEC5ABAE.png"),n.push("8E6E28B5D96B18D5C0EA8EB9A497AD66252196EE.png"),n.push("CE665C570F0DD9E93DE3DAA7EAEBC446CEC2E88B.png"),n.push("D93A9798AFC25B7261E8BB790BF1394C1557B61D.png"));var r="<img src='/client/extjs4/images/captcha/"+n[common.randomInt(0,n.length-1)]+"' width=170 height=30> ";t.send(r)}else s()},projects.logout=function(e,t,s){if(1==e.query.logout&&e.session){var n=e.query.sessionId;redisClient.hdel("sessions",n+"-id",n+"-username",n+"-clock",n+"-storageCode",n+"-newsRevision",n+"-port",n+"-userId",n+"-logined",n+"-ip"),redisPub.publish(config.redis.db+"-sessions",'{"removed":"'+n+'"}'),t.send("ok");var r=projects.sessions[n];r&&r.storage&&r.storage.rollbackTransaction({session:r})}else s()},projects.copyFile=function(e,t,s){if(e.url.indexOf("/copy_file?")==-1)return void s();var n=e.session;if(n&&n.storage){var r=n.storage,o=r.config.rootDir,i=e.query.src_object_id,a=e.query.src_class_attr_id,c=e.query.dst_object_id,f=e.query.dst_class_attr_id,l=e.query.filename,d=o+"/files/"+i+"-"+a+"-"+l,u=o+"/files/"+c+"-"+f+"-"+l;fs.readFile(d,function(e,s){e?t.send({err:1}):fs.writeFile(u,s,function(e){e?t.send({err:1}):t.send({ok:1})})})}else t.status(403).send("Invalid session")},projects.saveToFile=function(e,t,s){if(e.url.indexOf("/save_to_file?")==-1)return void s();var n=e.session;if(n&&n.storage){var r=n.storage,o=r.config.rootDir,i=e.query.object_id,a=e.query.class_attr_id,c=e.query.filename,f=o+"/files/"+i+"-"+a+"-"+c;fs.writeFile(f,e.body,function(e){e?t.send({err:1}):t.send({ok:1})})}else t.status(403).send("Invalid session")},projects.logLastTry=function(e,t,s){if(e.authRecords[t]&&e.authRecords[t].hasTryAttrs){var n,r=e.authRecords[t].objectId,o={id:"logLastTry-"+t,username:r,userId:r};async.series([function(t){e.getObject({session:o,id:r,success:function(e){n=e.object,t()}})},function(s){e.startTransaction({session:o,remoteAddr:"127.0.0.1",description:"logLastTry-"+t,success:function(){s()},failure:function(e){s(e)}})},function(r){s?(n.set("lastLogin",common.currentUTCTimestamp()),e.authRecords[t].tryNum=null,e.authRecords[t].lastTry=null):(n.set("lastTry",common.currentUTCTimestamp()),e.authRecords[t].tryNum=(e.authRecords[t].tryNum||0)+1,e.authRecords[t].lastTry=config.clock),n.commit({session:o,success:function(){r()}})},function(t){e.commitTransaction({session:o,success:function(){t()},failure:function(e){t(e)}})}],function(e){})}};var Query=function(e){var t=this,s=(e.success,e.storage),n=e.session||{userId:null},r=n.revision,o=e.sql.select,i=e.sql.from,a=e.sql.where,c=e.sql.order,f=e.sql.orderAfter,l={},d=[],u=[],g={};t.generate=function(){p(),h(i),t.selectSQL=y(o),t.whereSQL=x(a),t.orderSQL=q(c),t.fromSQL=j(i),t.attrs=l,t.fields=d,t.fieldNames=u,t.fieldTypeId=g,f&&(t.selectSQL="select * from (\n"+t.selectSQL,t.orderSQL+="\n) orderAfter "+$(f))};var p=function(){for(var e=0;e<i.length;e++){var t=i[e];if("object"==typeof t&&"[object Array]"!==Object.prototype.toString.call(t))for(var s in t){l[s]=l[s]||{},l[s].cls=t[s],l[s].toc={};break}}},m=function(e){for(var n=0;n<e.length;n++){var o=e[n];if("object"==typeof o)for(var i in o){if("id"==o[i]){var a=s.classesCode[l[i].cls].toc;r&&(a="tm_"+a),l[i].toc[a]=l[i].toc[a]||[],l[i].toc[a].indexOf("fobject_id")==-1&&l[i].toc[a].push("fobject_id")}else{l[i]||console.error("unknown attr: "+i);var a,c,f=t.sysCls.indexOf(l[i].cls);f>-1?(a=t.tables[f],c={toc:o[i].substr(3)}):(c=s.getClassAttr({classCode:l[i].cls,attrCode:o[i]}),a=s.classesMap[c.get("fclass_id")].toc,r&&(a="tm_"+a)),l[i].toc[a]=l[i].toc[a]||[],l[i].toc[a].indexOf(c.toc)==-1&&l[i].toc[a].push(c.toc)}break}}},h=function(e){for(var t=0;t<e.length;t++){var s=e[t];"left-join"!=s&&"inner-join"!=s||(m(e[t+3]),t+=3)}},v=1,b=function(e){var n="",o=e.distinct;for(var i in e)if("distinct"!=i){if("id"==e[i]){n=o?"distinct on ("+i+".fobject_id) "+i+".fobject_id":i+".fobject_id";var a=s.getClass({classCode:l[i].cls});if(!a)throw"query.fieldToSQL - unknown class: "+l[i].cls;var c=a.toc;r&&(c="tm_"+c),l[i].toc[c]=l[i].toc[c]||[],l[i].toc[c].indexOf("fobject_id")==-1&&l[i].toc[c].push("fobject_id"),v=2}else{if(!l[i])throw new VError("Unknown attr: "+i);var c,f=t.sysCls.indexOf(l[i].cls),d=s.getClassAttr({classCode:l[i].cls,attrCode:e[i]});f>-1?(c=t.tables[f],d.toc=e[i].substr(3)):(c=s.classesMap[d.get("fclass_id")].toc,r&&(c="tm_"+c)),n=o?"distinct on ("+i+"."+d.toc+") "+i+"."+d.toc:i+"."+d.toc,l[i].toc[c]=l[i].toc[c]||[],l[i].toc[c].indexOf(d.toc)==-1&&l[i].toc[c].push(d.toc),v=d.get("ftype_id")}break}return n},w=function(e){for(var s="",n=0;n<e.length;n++){s&&(s+=" ");var r=e[n];if("object"==typeof r)s+=common.isArray(r)?"("+w(r)+")":b(r);else if("number"==typeof r)s+=r;else if("string"==typeof r){var o=d.indexOf(r.toLowerCase()+"_");t.keywords.indexOf(r)>-1?s+=r:o>-1?!config.query.strictFilter&&n<e.length-2&&("like"==e[n+1]||"not like"==e[n+1])&&e[n+2]&&"string"==typeof e[n+2]?(s+="lower ("+u[o]+")",e[n+2]=e[n+2].toLowerCase()):s+=u[o]:s+="'"+r.split("'").join("''")+"'"}else s+=r}return s},y=function(e){for(var t="",n=0;n<e.length;n++){var r,o=e[n];if(common.isArray(o))t+=t?",\n\t":"\t",t+=w(o);else if("object"==typeof o)t+=t?",\n\t":"\t",r=b(o),t+=r;else{var i=o.toLowerCase()+"_";t+=" as "+i,n&&!common.isArray(e[n-1])&&(d.push(i),"distinct"==r.substr(0,8)&&(r=r.split(" ")[3]),u.push(r),g[i]=v)}}return"mssql"==s.client.database?"select top 9223372036854775807\n"+t+"\n":"select\n"+t+"\n"},j=function(e){if(!e)return"";for(var o=function(e){var o,i,a=[],c=[],f=[];for(o in e){i=e[o];break}var d;for(var u in l[o].toc){for(var g=l[o].toc[u],p=0;p<g.length;p++)a.push(u+"."+g[p]);t.tables.indexOf(u)==-1&&(d=u+".fobject_id")}for(var m=s.getClass(i);;){var h=t.sysCls.indexOf(i);if(h>-1){c.push(t.tables[h]);break}if(r?c.push("tm_"+m.toc):c.push(m.toc),!m.get("fparent_id"))break;m=s.classesMap[m.get("fparent_id")]}for(var p=1;p<c.length;p++)f.push(c[p-1]+".fobject_id="+c[p]+".fobject_id");if(r)for(var p=0;p<c.length;p++)t.tables.indexOf(c[p])==-1&&f.push(c[p]+".frevision_id="+r);f=f.length?" where "+f.join(" and "):"",d||(c.indexOf("tobject")>-1?d="tobject.fid":c.indexOf("tobject_attr")>-1&&(d="tobject_attr.fid"));var v=s.fireEvent("generatequeryblock",{cls:m,objectField:d,session:n,tables:c,where:f,alias:o});return v&&v.where&&(f=v.where),"mssql"==s.client.database?"(select top 9223372036854775807 "+a.join(",")+" from "+c.join(",")+f+") "+o:"(select "+a.join(",")+" from "+c.join(",")+f+") "+o},i="",a=0;a<e.length;a++)if(a){var c=e[a];"left-join"!=c&&"inner-join"!=c||(i+="\n\t"+c.split("-").join(" "),i+=" "+o(e[a+1]),i+=" on ("+w(e[a+3])+")",a+=3)}else i+="\t"+o(e[0]);return"from\n"+i+"\n"},x=function(e){return e&&e.length?"where\n\t"+w(e)+"\n":""},q=function(e){return e&&e.length?"order by\n\t"+w(e)+"\n":""},$=function(e){if(!e||!e.length)return"";for(var t="",s=0;s<e.length;s++)if(_.isObject(e[s])){for(var n=!1,r=0;r<o.length;r++){var i=o[r];_.isObject(i)&&_.keys(i)[0]==_.keys(e[s])[0]&&_.values(i)[0]==_.values(e[s])[0]&&(t+="orderAfter."+o[r+1]+"_ ",n=!0)}n||(t+="orderAfter."+_.values(e[s])[0]+"_ ")}else{var a=d.indexOf(e[s].toLowerCase()+"_");t+=a>-1?"orderAfter."+e[s]+"_ ":e[s]}return"order by\n\t"+t+"\n"}};Query.prototype.sysCls=["system.class","system.class_attr","system.view","system.view_attr","system.action","system.action_attrs","system.object","system.object_attr","system.revision"],Query.prototype.tables=["tclass","tclass_attr","tview","tview_attr","taction","taction_attrs","tobject","tobject_attr","trevision"],Query.prototype.keywords=["is null","is not null","on","in","not in","exist","not exist","like","not like","desc","DESC","asc","ASC","and","or","row_number ()","over","order by","<>",">",">=","<","<=","=","+","-","||","/",",","*","current_timestamp","lower","trim","ltrim","rtrim"],process.env.TZ="UTC",process.maxTickDepth=1/0,config.uncaughtException&&process.on("uncaughtException",function(e){console.log(e),console.log(e.stack);var t="["+common.currentDate()+" "+common.currentTime({msec:!0})+"] ",s=fs.openSync(config.rootDir+"/error.log","a",666);fs.writeSync(s,t+"Caught exception: "+e+"\n"+e.stack+"\n",null,"utf8"),fs.closeSync(s),process.exit(1)}),config.clock=parseInt((new Date).getTime()/1e3);var server={};server.cache={},server.www=function(e){var t=e.request,s=e.response,n=e.next,r=e.filePath,o=url.parse(t.url).pathname;if(!r){"/"==o&&(o="/index.html");o.split(".");r=config.wwwRoot+o}var i=o.split("/");if("wsdl"==i[3])return console.log(o,decodeURI(r)),void fs.readFile(decodeURI(r),function(e,t){var n=r.split(".");n=n[n.length-1],s.writeHead(200,{"Content-Type":mimetypes.lookup(n)}),s.end(t)});if(["client","third-party","favicon.ico"].indexOf(i[1])==-1&&["resources","locale","files",""].indexOf(i[3])==-1)return n();var a=r.split(".");if(a=a[a.length-1],config.caching&&config.caching.enabled&&!e.nocache){var c,f=200;async.series([function(e){fs.stat(r,function(s,n){if(s)e("File not found "+r);else{if(c=new Date(n.mtime).getTime(),server.cache[r])if(server.cache[r].mtime!=c)server.cache[r]=null;else if(t.headers["if-none-match"]){var o=t.headers["if-none-match"];o==server.cache[r].mtime&&(f=304)}e()}})},function(e){server.cache[r]?e():fs.readFile(r,function(t,s){t?e("File not found "+r):(server.cache[r]={mtime:c,data:s},e())})}],function(e,t){if(e)if(n)n(e);else try{s.writeHead(404,{"Content-Type":"text/html; charset=utf-8"}),s.end(e)}catch(e){}else try{if(304==f)s.sendStatus(304);else{var o={ETag:c,"Content-Type":mimetypes.lookup(a)};s.writeHead(f,o),s.end(server.cache[r].data)}}catch(e){}})}else fs.readFile(decodeURI(r),function(e,t){var n=r.split(".");n=n[n.length-1],s.writeHead(200,{"Content-Type":mimetypes.lookup(n)}),s.end(t)})},server.setVars=function(e,t,s){e.session=projects.sessions[e.query.sessionId]||{id:e.query.sessionId},redisClient.hset("sessions",e.query.sessionId+"-clock",config.clock),s()},server.loadData=function(e,t,s){var n=e.url.split("/");e.setEncoding("utf8"),e.on("data",function(t){"plugins"==n[3]&&console.log("loadData data",t?t.length:null),e.body?e.body+=t:e.body=t}),e.on("end",function(){"plugins"==n[3]&&console.log("loadData end"),s()})},server.middleBodyLoader=function(e,t,s){if(e.body){var n=e.body.split(".");n.length>2&&["Storage","Object","Class","ClassAttr","View","ViewAttr","Action"].indexOf(n[1])>-1&&(e.storageCode=n[0],e.storageArea=n[1],e.storageFn=n[2].substr(0,n[2].indexOf("(")),e.storageParam=e.body.substr(e.body.indexOf("(")+1,e.body.length-e.body.indexOf("(")-2),config.debug&&console.log("http.request.body: "+e.body))}s()},server.middleBodyParser=function(e,t,s){var n=new formidable.IncomingForm;try{n.parse(e,function(n,r,o){return n?(log.error({cls:"server",fn:"middleBodyParser",error:"middleBodyParser error: "+JSON.stringify(n)+" fields: "+JSON.stringify(r)}),void t.end("middleBodyParser error "+common.currentUTCTimestamp())):(e.fields=r,void s())})}catch(t){e.fields={},log.error({cls:"server",fn:"middleBodyParser",error:"middleBodyParser error: "+t}),s()}},server.requestStart=function(e,t,s){if(e.storageCode=e.storageCode||e.params.storage,"GET"!=e.method){var n="",r="";e.body&&e.url.indexOf("/upload")==-1&&(n=", body: "+JSON.stringify(e.body)),e.fields&&(r=', fields: "'+JSON.stringify(e.fields)+'"'),e.objectum={start:(new Date).getTime(),end:t.end},redisClient.hincrby("current-requests","sequence",1,function(o,i){t.end=function(t,s){var o=this;redisClient.hdel("current-requests",i,function(i,a){var c=((new Date).getTime()-e.objectum.start)/1e3;log.info({cls:"server",fn:"requestStart"},"duration: "+c+' sec., url: "'+e.url+'", ip: "'+common.getRemoteAddress(e)+'"'+n+r),c>60&&log.warn({cls:"server",fn:"requestStart"},"duration: "+c+' sec., url: "'+e.url+'", ip: "'+common.getRemoteAddress(e)+'"'+n+r);try{e.objectum.end.call(o,t,s)}catch(e){throw console.log(t+", error: "+e),e}})},redisClient.hset("current-requests",i,'{url: "'+e.url+'"'+n+r+', ts: "'+common.currentUTCTimestamp()+'"}',function(e,t){s()})})}else s()},server.stat=function(options){var request=options.request,response=options.response;if(config.admin.ip.indexOf(common.getRemoteAddress(request))==-1&&"all"!=config.admin.ip&&response.end("forbidden"),log.info({cls:"server",fn:"stat"},"ip: "+common.getRemoteAddress(request)+", query: "+JSON.stringify(request.query)),request.query.logs)return void redisClient.keys(config.redis.db+"-log-*",function(e,t){for(var s=0;s<t.length;s++)t[s]=t[s].substr((config.redis.db+"-log-").length);response.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),response.end(JSON.stringify(t))});if(request.query.log)return void redisClient.lrange(config.redis.db+"-log-"+request.query.log,0,-1,function(e,t){response.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),response.end(JSON.stringify(t))});if(request.query.restart)return redisPub.publish(config.redis.db+"-cluster","restart"),response.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),void response.end("ok");if(!request.query.data)return void fs.readFile(__dirname+"/www/client/stat/stat.html",function(e,t){response.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),response.end(t)});var allData={},num=0,online,lost,onlineNum,onlineNumMax,onlineNumMaxTS,started,memoryUsage,idle="";async.series([function(e){redisClient.hgetall("sessions",function(t,s){var n=[];for(var r in s)if(r.indexOf("-username")>-1){var o=r.substr(0,r.length-9);n.push({login:s[r],port:s[o+"-port"],storage:s[o+"-storageCode"],logined:s[o+"-logined"],ip:s[o+"-ip"]}),num++}allData.sessions=n,e()})},function(cb){redisClient.hgetall("current-requests",function(err,result){var data=[];for(var k in result){var r;try{r=eval("("+result[k]+")")}catch(e){r={body:result[k]}}data.push({url:r.url,body:r.body,fields:r.fields,ts:r.ts})}allData.unprocessed=data,cb()})},function(e){redisClient.hgetall("server-started",function(t,s){started=s,e()})},function(e){redisClient.hgetall("server-memoryusage",function(t,s){var n=[];for(var r in s){var o=JSON.parse(s[r]);n.push({pid:r,port:o.port,started:started[r],rssCurrent:o.current.rss,heapTotalCurrent:o.current.heapTotal,heapUsedCurrent:o.current.heapUsed,rssMax:o.max.rss,heapTotalMax:o.max.heapTotal,heapUsedMax:o.max.heapUsed})}allData.cluster=n,e()})},function(e){redisClient.get("online-num",function(t,s){onlineNum=s,redisClient.get("online-num-max",function(t,s){onlineNumMax=s,redisClient.get("online-num-max-ts",function(t,s){onlineNumMaxTS=s,e()})})})},function(e){var t;for(t in config.storages)if("postgres"==config.storages[t].database){var s=new db.Postgres({connection:config.storages[t]});return void s.connect({systemDB:!0,success:function(){s.query({sql:"select (date_part ('epoch', now () - query_start)) as duration, procpid, current_query\nfrom pg_stat_activity\nwhere current_query <> '<IDLE>' and date_part ('epoch', now () - query_start) > 0\norder by 1",success:function(t){for(var n=t.result.rows,r=[],o=0;o<n.length;o++)r.push({duration:n[o].duration,pid:n[o].procpid,query:n[o].current_query});allData.pgStat=r,s.disconnect(),e()},failure:function(){allData.pgStat=[],e()}})}})}e()}],function(e,t){response.send(JSON.stringify(allData))})},server.updateMemoryUsage=function(){server.memoryUsage=server.memoryUsage||{rss:0,heapTotal:0,heapUsed:0};var e=process.memoryUsage();e.rss=(e.rss/1048576).toFixed(3),e.heapTotal=(e.heapTotal/1048576).toFixed(3),e.heapUsed=(e.heapUsed/1048576).toFixed(3),server.memoryUsage.rss<e.rss&&(server.memoryUsage.rss=e.rss),server.memoryUsage.heapTotal<e.heapTotal&&(server.memoryUsage.heapTotal=e.heapTotal),server.memoryUsage.heapUsed<e.heapUsed&&(server.memoryUsage.heapUsed=e.heapUsed),redisClient.hset("server-memoryusage",process.pid,JSON.stringify({port:config.port,current:{rss:e.rss,heapTotal:e.heapTotal,heapUsed:e.heapUsed},max:{rss:server.memoryUsage.rss,heapTotal:server.memoryUsage.heapTotal,heapUsed:server.memoryUsage.heapUsed}}))},server.init=function(e){e=e||{},server.objectum=e.objectum;var t=e.success;server.app=express(),server.app.use(function(e,t,s){e.connection.setNoDelay(!0),s()}),server.app.get("/projects/*",server.setVars,server.processProjectPlugins,server.requestStart,xmlss.report,projects.services.captcha,projects.services.accountActivate,projects.services.restorePassword,projects.services.resetPassword,projects.copyFile,projects.getHandler),server.app.post("/projects/*",server.setVars,projects.upload,projects.sendmail,server.loadData,projects.saveToFile,server.middleBodyLoader,server.requestStart,server.processProjectPlugins,projects.checkAuth,projects.logout,projects.startTransaction,projects.commitTransaction,projects.rollbackTransaction,projects.removeObject,projects.getObject,projects.setAttrs,projects.execute,projects.getAll,projects.getViews,projects.getViewAttrs,projects.getClasses,projects.getClassAttrs,projects.getActions,projects.getActionAttrs,projects.getContent,projects.selectRows,meta.fnClass,meta.fnClassAttr,meta.fnView,meta.fnViewAttr,meta.fnAction,projects.gate1c,xlsx.report,pdf.report,dbf.report,xmlss.report,tm.getRevisions,tm.setRevision,function(e,t){log.error({cls:"server",fn:"init",error:"Unknown request: "+e.url+" body: "+e.body}),t.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),t.end("{header: {error: 'unknown request'}, data: []}")}),server.app.post("/objectum/obj_news",server.loadData,server.setVars,server.middleBodyLoader,projects.checkAuth,function(e,t){projects.news.getObj(e,t)}),server.app.all("/objectum/exist",server.requestStart,function(e,t){projects.exist({request:e,response:t,storageCode:e.query.storageCode,classCode:e.query.classCode,attrCode:e.query.attrCode,value:e.query.value})}),server.app.all("/objectum/stat",server.requestStart,function(e,t){server.stat({request:e,response:t})}),server.app.all("/exception",function(e,t){setTimeout(function(){throw Error("boo")},1e3)}),server.startPlugins({success:function(){function e(){global.gc&&(global.gc(),setTimeout(e,config.gcInterval||5e3))}server.app.get("*",server.requestStart,function(e,t,s){server.www({request:e,response:t,next:s})}),server.app.use(function(e,t,s,n){var r=e.message?e.message:e;log.error({cls:"server",fn:"init",error:"express exception: "+r+", stack: "+JSON.stringify(e.stack)}),s.status(500).send("{header: {error: '"+r+"', stack:'"+JSON.stringify(e.stack)+"'}}")}),setTimeout(e,5e3),setInterval(function(){config.clock=parseInt((new Date).getTime()/1e3),server.updateMemoryUsage()},1e3),projects.init({success:function(){t&&t()}})}})},server.startPlugins=function(e){e=e||{};var t=e.success;if(!config.plugins)return void(t&&t());var s=[];for(var n in config.plugins)s.push(n);async.map(s,function(e,t){var s=config.plugins[e];fs.exists(s.require,function(e){if(e){var n=require(s.require);s.module=n,async.series([function(e){n.init?n.init({objectum:server.objectum,
success:function(){log.info({cls:"server",fn:"startPlugins"},"plugin "+s.require+" initialized."),e()},failure:function(t){log.error({cls:"server",fn:"startPlugins",error:s.require+" error: "+t}),e()}}):e()}],function(e,r){n.handler&&(server.app.all(s.path,n.handler),log.info({cls:"server",fn:"startPlugins"},"plugin "+s.require+" handler activated.")),t()})}else t()})},function(e,s){t&&t()})},server.projectPlugins={},server.processProjectPlugins=function(e,t,s){var n=e.url.split("/");if("plugins"==n[3]){var r=n[2];server.projectPlugins[r]?server.projectPlugins[r](e,t):projects.getStorage({request:e,res:t,storageCode:r,success:function(n){server.projectPlugins[r]?server.projectPlugins[r](e,t):s()}})}else s()},server.startWSDL=function(e){e=e||{};var t=e.success,s=[];for(var n in config.storages)s.push(n);async.map(s,function(e,t){var s=config.storages[e].rootDir+"/wsdl/wsdl.js";return config.storages[e].wsdl&&!config.storages[e].wsdl.enabled?void t():void fs.exists(s,function(n){n?projects.getStorage({storageCode:e,success:function(n){var r=require(s);n.storage.rootDir=config.storages[e].rootDir,r.start({objectum:server.objectum,storage:n.storage}),t()}}):t()})},function(e,s){t&&t()})},server.start=function(e,t){server.http=http.createServer(server.app);var s=e.port||config.startPort;config.port=s,async.series([function(e){config.createStoragesOnDemand?e():projects.createStorages({success:function(){console.log("Storages created."),projects.news.gc(),e()}})},function(e){s==config.startPort||process.env.mainWorker?(setInterval(function(){projects.removeTimeoutSessions()},config.session.gcInterval),setInterval(function(){mailSender.sendFailed()},config.mail.sendFailedInterval?config.mail.sendFailedInterval:12e5),config.redis.resetCache&&(redisClient.del("sessions"),redisClient.del("current-requests"),redisClient.del("server-memoryusage"),redisClient.del("files"),redisClient.del("files-mtime"),redisClient.keys("*-content",function(e,t){for(var s=0;s<t.length;s++)redisClient.del(t[s])}),redisClient.keys("*-clschange",function(e,t){for(var s=0;s<t.length;s++)redisClient.del(t[s])}),redisClient.keys("log-*",function(e,t){for(var s=0;s<t.length;s++)redisClient.del(t[s])}),redisClient.keys("*-objects",function(e,t){for(var s=0;s<t.length;s++)redisClient.del(t[s])}),redisClient.keys("*-data",function(e,t){for(var s=0;s<t.length;s++)redisClient.del(t[s])})),config.wsdl&&0==config.wsdl.enabled?e():server.startWSDL({success:e})):e()}],function(e,n){e?console.log("Objectum server start error: "+e+", port: "+s):console.log("Objectum server has started at port: "+s),redisClient.hset("server-started",process.pid,common.currentUTCTimestamp()),server.http.listen(s,config.host,config.backlog),server.http.on("error",function(e){log.error({cls:"server",fn:"start",error:"http error: "+e})}),t&&t(e)})};var hexcase=1,b64pad="",chrsz=8,sha={};sha.hex_sha1=function(e){return binb2hex(core_sha1(str2binb(e),e.length*chrsz))};var Storage=function(options){var storage=this;storage.client=null,storage.clientPool={},storage.getClient=function(e){if(e=e||{},e.session=e.session||{},storage.clientPool[e.session.id])return storage.clientPool[e.session.id];var t=db.create(storage);return t},storage.freeClient=function(e){var t=storage.clientPool[e.session.id];t&&(t.disconnect(),delete storage.clientPool[e.session.id])},storage.revision={},storage.queryCount=0,storage.query=function(e){var t=e;e.options=e.options||{};var s=e.session;storage.queryCount++;var n=e.client||storage.getClient(e);!function(){if(e.params)for(var t=0;t<e.params.length;t++)e.sql=e.sql.replace("$"+(t+1),"#"+(t+1))}(),function(){for(var t,s="",r="",o=0;o<e.sql.length;o++)t=e.sql[o],"$"==t?s?(s=s.substr(1),r+=n.tags.hasOwnProperty(s)?n.tags[s]:"$"+s+"$",s=""):s=t:s?s+=t:r+=t;s&&(r+=s),e.sql=r}(),function(){if(e.params)for(var t=0;t<e.params.length;t++)e.sql=e.sql.replace("#"+(t+1),"$"+(t+1))}(),n.query({sql:e.sql,params:e.params,success:function(e){s&&storage.clientPool[s.id]||n.inStorage||n.disconnect(),t.success&&t.success(e)},failure:function(e){s&&storage.clientPool[s.id]||n.inStorage||n.disconnect(),t.failure&&t.failure(new VError(e,"Storage.query"))}})},storage.maxRevision=2147483647,storage.getCurrentFilter=function(e){var t,s="";return e&&e.alias&&(s=e.alias+"."),t="("+s+"fend_id = "+this.maxRevision+")"},storage.createRevision=function(e){var t=e.success,s=e.description,n=e.session,r=e.remoteAddr||n.ip,o=storage.clientPool[n.id];o.getNextId({session:n,table:"trevision",success:function(e){var i=e.id;storage.lastRevision=i,r=r?"'"+r+"'":"null",n.userId=n.userId||"null";var a="insert into trevision (fid, fdate, fdescription, fsubject_id, fremote_addr)\nvalues ("+i+", "+o.currentTimestamp()+", '"+s+"', "+n.userId+", "+r+")";storage.query({session:n,sql:a,success:function(e){t&&t({id:i})},failure:function(t){e.failure&&e.failure(new VError(t,"Storage.createRevision"))}})},failure:function(t){e.failure&&e.failure(new VError(t,"Storage.createRevision"))}})},storage.inTransaction=function(e){return storage.clientPool[e.id]},storage.startTransaction=function(e){e=e||{},e.session=e.session||{};var t=e.success,s=e.failure,n=e.session;log.debug({cls:"Storage",fn:"startTransaction",params:e.description}),async.series([function(e){storage.clientPool[n.id]?storage.rollbackTransaction({session:n,success:function(){e()},failure:e}):e()}],function(r,o){var i=db.create(storage);i.connect({success:function(){i.startTransaction({success:function(){storage.clientPool[n.id]=i,e.success=function(e){storage.revision[n.id]=e.id,storage.revisions[e.id]={id:e.id,dirty:!0,objects:{changed:[],created:[],removed:[],classId:{}},classes:{changed:[],created:[],removed:[]},classAttrs:{changed:[],created:[],removed:[]},views:{changed:[],created:[],removed:[]},viewAttrs:{changed:[],created:[],removed:[]}},t&&t({revision:e.id})},e.failure=function(e){s&&s(new VError(e,"Storage.startTransaction"))},storage.createRevision(e)},failure:function(e){s&&s(new VError(e,"Storage.startTransaction"))}})},failure:function(e){s&&s(new VError(e,"Storage.startTransaction"))}})})},storage.commitTransaction=function(e){log.debug({cls:"Storage",fn:"commitTransaction"}),e=e||{},e.session=e.session||{};var t=e.session,s=e.failure;if(storage.revision[t.id]){var n=storage.clientPool[t.id];n?n.commitTransaction({success:function(){delete storage.clientPool[t.id],n.disconnect();var s=storage.revision[t.id];storage.revisions[s]&&(storage.revisions[s].dirty=!1,storage.redisPub.publish(config.redis.db+"-"+storage.code+"-revisions",JSON.stringify(storage.revisions[s]))),delete storage.revision[t.id],e.success&&e.success({revision:s})},failure:function(e){s&&s(new VError(e,"Storage.commitTransaction"))}}):(delete storage.clientPool[t.id],e.success&&e.success({}))}else e.success&&e.success({})},storage.rollbackTransaction=function(e){log.debug({cls:"Storage",fn:"rollbackTransaction"}),e=e||{},e.session=e.session||{};var t=e.session;if(storage.revision[t.id]){var s=storage.clientPool[t.id];if(!s){var n=storage.revision[t.id];return delete storage.revisions[n],delete storage.revision[t.id],void(e.success&&e.success({revision:n}))}s.rollbackTransaction({success:function(){delete storage.clientPool[t.id],s.disconnect();var n=storage.revision[t.id];delete storage.revisions[n],delete storage.revision[t.id],e.success&&e.success({revision:n})},failure:function(t){e.failure&&e.failure(new VError(t,"Storage.rollbackTransaction"))}})}else e.success&&e.success({})},storage.classes=null,storage.classesMap=null,storage.classesCode=null,storage.classesTree=null,storage.initClasses=function(e){log.debug({cls:"Storage",fn:"initClasses"}),e=e||{};var t=e.success;e.session=e.session||{};var s=e.session;storage.query({session:s,sql:"select * from tclass where "+storage.getCurrentFilter(),success:function(e){var s=e.result.rows,n=[];for(var r in s[0])n.push(r);storage.classes=[],storage.classesMap={};for(var o=0;o<s.length;o++){for(var i=new storage.tobject({code:"tclass"}),a=0;a<n.length;a++)i.data[n[a]]=s[o][n[a]];i.toc=i.get("fcode").toLowerCase()+"_"+i.get("fid"),i.childs=[],i.attrs={},storage.classes.push(i),storage.classesMap[i.get("fid")]=i}storage.classesTree={},storage.classesCode={};var c=function(e){for(var t=0;t<storage.classes.length;t++){var s=storage.classes[t];if(s.get("fparent_id")==e.parent){e.parent&&storage.classesMap[e.parent].childs.push(s.get("fid")),e.node[s.get("fcode")]={id:s.get("fid")};var n=e.code?e.code+"."+s.get("fcode"):s.get("fcode");storage.classesCode[n]=s;var r=n.split(".");3==r.length&&(storage.classesCode[r[0]+"."+r[2]]=storage.classesCode[r[0]+"."+r[2]]||s),4==r.length&&(storage.classesCode[r[0]+"."+r[3]]=storage.classesCode[r[0]+"."+r[3]]||s),c({node:e.node[s.get("fcode")],parent:s.get("fid"),code:n})}}};c({node:storage.classesTree,parent:null}),t&&t()}})},storage.getClassFullCode=function(e){if(!e)return e;var t=e.get("fcode");return e.get("fparent_id")&&(t=storage.getClassFullCode(storage.classesMap[e.get("fparent_id")])+"."+t),t},storage.updateClassCache=function(e){var t=e.fields,s=e.values,n=storage.classesMap[s[0]]||new storage.tobject({code:"tclass"});s[1]&&storage.classesMap[s[1]].childs.splice(storage.classesMap[s[1]].childs.indexOf(s[0],1));for(var r=0;r<t.length;r++)n.data[t[r]]=s[r];if(n.toc=n.get("fcode").toLowerCase()+"_"+n.get("fid"),storage.classesMap[n.get("fid")]||(n.childs=[],n.attrs={},storage.classes.push(n),storage.classesMap[n.get("fid")]=n),n.get("fparent_id")){storage.classesMap[n.get("fparent_id")].childs.indexOf(n.get("fid"))==-1&&storage.classesMap[n.get("fparent_id")].childs.push(n.get("fid"));var o=storage.getClassFullCode(n);storage.classesCode[o]=n;var i=o.split(".");3==i.length&&(storage.classesCode[i[0]+"."+i[2]]=storage.classesCode[i[0]+"."+i[2]]||n),4==i.length&&(storage.classesCode[i[0]+"."+i[3]]=storage.classesCode[i[0]+"."+i[3]]||n)}else storage.classesCode[n.get("fcode")]=n},storage.updateClassAttrCache=function(e){var t=e.fields,s=e.values,n=storage.classAttrsMap[s[0]]||new storage.tobject({code:"tclass_attr"});if(storage.classesMap[s[1]]){var r=function(e){e.attrs=e.attrs||{},delete e.attrs[s[3]];for(var t=0;t<e.childs.length;t++)r(storage.classesMap[e.childs[t]])};r(storage.classesMap[s[1]])}for(var o=0;o<t.length;o++)n.data[t[o]]=s[o];if(n.toc=n.get("fcode").toLowerCase()+"_"+n.get("fid"),storage.classAttrsMap[n.get("fid")]||(storage.classAttrs.push(n),storage.classAttrsMap[n.get("fid")]=n),storage.classesMap[n.get("fclass_id")]){var i=function(e){e.attrs=e.attrs||{},e.attrs[n.get("fcode")]=n;for(var t=0;t<e.childs.length;t++)i(storage.classesMap[e.childs[t]])};i(storage.classesMap[n.get("fclass_id")])}},storage.getViewFullCode=function(e){if(!e)return e;var t=e.get("fcode");return e.get("fparent_id")&&(t=storage.getViewFullCode(storage.viewsMap[e.get("fparent_id")])+"."+t),t},storage.updateViewCache=function(e){for(var t=e.fields,s=e.values,n=storage.viewsMap[s[0]]||new storage.tobject({code:"tview"}),r=0;r<t.length;r++)n.data[t[r]]=s[r];if(storage.viewsMap[n.get("fid")]||(n.attrs={},storage.views.push(n),storage.viewsMap[n.get("fid")]=n),n.get("fparent_id")){var o=storage.getViewFullCode(n);storage.viewsCode[o]=n;var i=o.split(".");3==i.length&&(storage.viewsCode[i[0]+"."+i[2]]=storage.viewsCode[i[0]+"."+i[2]]||n),4==i.length&&(storage.viewsCode[i[0]+"."+i[3]]=storage.viewsCode[i[0]+"."+i[3]]||n)}else storage.viewsCode[n.get("fcode")]=n},storage.updateViewAttrCache=function(e){for(var t=e.fields,s=e.values,n=storage.viewAttrsMap[s[0]]||new storage.tobject({code:"tview_attr"}),r=0;r<t.length;r++)n.data[t[r]]=s[r];storage.viewAttrsMap[n.get("fid")]||(storage.viewAttrs.push(n),storage.viewAttrsMap[n.get("fid")]=n);var o=storage.viewsMap[n.get("fview_id")];o&&(o.attrs=o.attrs||{},o.attrs[n.get("fcode")]=n)},storage.classAttrs=null,storage.classAttrsMap=null,storage.initClassAttrs=function(e){log.debug({cls:"storage",fn:"initClassAttrs"}),e=e||{};var t=e.success;e.session=e.session||{};var s=e.session;storage.query({session:s,sql:"select * from tclass_attr where "+storage.getCurrentFilter(),success:function(e){var s=e.result.rows,n=[];for(var r in s[0])n.push(r);storage.classAttrs=[],storage.classAttrsMap={};for(var o=0;o<s.length;o++){for(var i=new storage.tobject({code:"tclass_attr"}),a=0;a<n.length;a++)i.data[n[a]]=s[o][n[a]];if(i.toc=i.get("fcode").toLowerCase()+"_"+i.get("fid"),storage.classAttrs.push(i),storage.classAttrsMap[i.get("fid")]=i,storage.classesMap[i.get("fclass_id")]){var c=function(e){e.attrs=e.attrs||{},e.attrs[i.get("fcode")]=i;for(var t=0;t<e.childs.length;t++)c(storage.classesMap[e.childs[t]])};c(storage.classesMap[i.get("fclass_id")])}}t&&t()}})},storage.views=null,storage.viewsMap=null,storage.viewsCode=null,storage.viewsTree=null,storage.initViews=function(e){log.debug({cls:"storage",fn:"initViews"}),e=e||{};var t=e.success;e.session=e.session||{};var s=e.session;storage.query({session:s,sql:"select * from tview where "+storage.getCurrentFilter(),success:function(e){var s=e.result.rows,n=[];for(var r in s[0])n.push(r);storage.views=[],storage.viewsMap={};for(var o=0;o<s.length;o++){for(var i=new storage.tobject({code:"tview"}),a=0;a<n.length;a++)i.data[n[a]]=s[o][n[a]];storage.views.push(i),storage.viewsMap[i.get("fid")]=i}storage.viewsTree={},storage.viewsCode={};var c=function(e){for(var t=0;t<storage.views.length;t++){var s=storage.views[t];if(s.get("fparent_id")==e.parent){e.node[s.get("fcode")]={id:s.get("fid")};var n=e.code?e.code+"."+s.get("fcode"):s.get("fcode");if(storage.viewsCode[n]=s,n){var r=n.split(".");3==r.length&&(storage.viewsCode[r[0]+"."+r[2]]=storage.viewsCode[r[0]+"."+r[2]]||s),4==r.length&&(storage.viewsCode[r[0]+"."+r[3]]=storage.viewsCode[r[0]+"."+r[3]]||s)}c({node:e.node[s.get("fcode")],parent:s.get("fid"),code:n})}}};c({node:storage.viewsTree,parent:null}),t&&t()}})},storage.viewAttrs=null,storage.viewAttrsMap=null,storage.initViewAttrs=function(e){log.debug({cls:"storage",fn:"initViewAttrs"}),e=e||{};var t=e.success;e.session=e.session||{};var s=e.session;storage.query({session:s,sql:"select * from tview_attr where "+storage.getCurrentFilter(),success:function(e){var s=e.result.rows,n=[];for(var r in s[0])n.push(r);storage.viewAttrs=[],storage.viewAttrsMap={};for(var o=0;o<s.length;o++){for(var i=new storage.tobject({code:"tview_attr"}),a=0;a<n.length;a++)i.data[n[a]]=s[o][n[a]];null!=i.get("fcode")&&(i.toc=i.get("fcode").toLowerCase()+"_"+i.get("fid"),storage.viewAttrs.push(i),storage.viewAttrsMap[i.get("fid")]=i,storage.viewsMap[i.get("fview_id")]&&(storage.viewsMap[i.get("fview_id")].attrs=storage.viewsMap[i.get("fview_id")].attrs||{},storage.viewsMap[i.get("fview_id")].attrs[i.get("fcode")]=i))}t&&t()}})},storage.findNode=function(e){log.debug({cls:"storage",fn:"findNode"});var t,s=e.node,n=e.path;"string"==typeof n&&(n=n.split("."));var r=n[0];return s.hasOwnProperty(r)&&(n.length>1?(n.splice(0,1),t=storage.findNode({node:s[r],path:n})):t=s[r]),"object"==typeof t&&(t=t.id),t},storage.getClass=function(e){if(log.debug({cls:"storage",fn:"getClass"}),"number"==typeof e){if(storage.classesMap[e])return storage.classesMap[e];throw new VError("storage.getClass - Unknown classId: "+e)}"string"==typeof e&&(e={code:e});var t=e.classCode||e.code;if(storage.classesCode[t])return storage.classesCode[t];if(storage.classesMap[t])return storage.classesMap[t];throw new VError("storage.getClass - Unknown classCode: "+t)},storage.getClassAttr=function(e){function t(s){if(s.attrs&&s.attrs[e.attrCode])return s.attrs[e.attrCode];if(s.get("fparent_id"))return t(storage.classesMap[s.get("fparent_id")]);throw new Error("storage.getClassAttr - Unknown attrCode: "+e.attrCode+" (classId: "+(e.classId||e.classCode)+")")}if(log.debug({cls:"storage",fn:"getClassAttr ("+JSON.stringify(e)+")"}),"number"==typeof e){if(storage.classAttrsMap[e])return storage.classAttrsMap[e];throw new Error("storage.getClassAttr - Unknown classAttrId: "+e)}var s;if(s=e.classCode?storage.classesCode[e.classCode]:storage.classesMap[e.classId]){var n=t(s);return n}throw new Error("storage.getClassAttr - Unknown classCode: "+e.classCode+" (classId: "+e.classId||e.classCode+")")},storage.getObject=function(options){log.debug({cls:"Storage",fn:"getObject",id:options.id}),options=options||{};var success=options.success,failure=options.failure,objectId=options.id;options.session=options.session||{};var session=options.session;storage.redisClient.hset("sessions",session.id+"-clock",config.clock);var revision=session.revision;if(!objectId||NaN==Number(objectId))return void(success&&success({object:null}));var object;async.series([function(e){storage.fireEvent("beforegetobject",{objectId:objectId,session:session,storage:storage,success:function(t){t&&t.cancel?e("cancel"):e()}})},function(cb){storage.redisClient.hmget(storage.code+"-objects"+(revision||""),[objectId+"-data"],function(err,result){var o=new storage.tobject({code:"tobject"});if(result&&result[0]){o.data=eval("("+result[0]+")"),o.originalData={};for(var attr in o.data)o.originalData[attr]=o.data[attr];object=o,cb()}else if(revision){var cls,row;async.series([function(e){storage.query({session:session,sql:"select fclass_id from tobject where fid="+objectId,success:function(t){cls=storage.getClass(t.result.rows[0].fclass_id),e()}})},function(e){function t(e){for(var t in e)n.push(e[t].toc)}function s(e){if(e){var n=storage.getClass(e);r+="left join tm_"+n.toc+" on (tm_"+n.toc+".fobject_id=tm_"+cls.toc+".fobject_id and tm_"+n.toc+".frevision_id=tm_"+cls.toc+".frevision_id)\n",t(n.attrs),s(n.get("fparent_id"))}}var n=[];t(cls.attrs);var r="";s(cls.get("fparent_id"));var o="select "+n.join(", ")+" from tm_"+cls.toc+"\n"+r+"where tm_"+cls.toc+".fobject_id="+objectId+" and tm_"+cls.toc+".frevision_id="+revision;storage.query({session:session,sql:o,success:function(t){row=t.result.rows[0],e()}})},function(e){o.data.id=objectId,o.data.fclass_id=cls.get("fid");for(var t in cls.attrs){var s=cls.attrs[t];o.data[t]=row[s.toc],o.originalData[t]=row[s.toc]}var n={};n[objectId+"-data"]=o.dataToJSONString(!0),storage.redisClient.hmset(storage.code+"-objects"+revision,n),object=o,e()}],function(e){cb()})}else{var select="select a.fclass_attr_id, a.fstring, a.ftime, fnumber, b.fclass_id";storage.query({session:session,sql:select+"\nfrom tobject b\nleft join tobject_attr a on (a.fobject_id=b.fid and "+storage.getCurrentFilter({alias:"a"})+")\nwhere b.fid="+objectId+" and "+storage.getCurrentFilter({alias:"b"}),success:function(e){if(e&&e.result&&e.result.rows&&0!=e.result.rows.length){var t=e.result.rows;o.data.id=objectId,o.data.fclass_id=t[0].fclass_id;for(var s=0;s<t.length;s++)if(t[s].fclass_attr_id){var n=storage.classAttrsMap[t[s].fclass_attr_id];if(n){var r;r=1==n.get("ftype_id")||5==n.get("ftype_id")?t[s].fstring:3==n.get("ftype_id")?t[s].ftime:t[s].fnumber,o.data[n.get("fcode")]=r,o.originalData[n.get("fcode")]=r}}if(!storage.revision[session.id]){var i={};i[objectId+"-data"]=o.dataToJSONString(!0),storage.redisClient.hmset(storage.code+"-objects",i)}object=o,cb()}else object=null,cb()},failure:cb})}})},function(e){storage.fireEvent("aftergetobject",{object:object,session:session,storage:storage,success:function(t){t&&t.cancel?e("cancel"):e()}})}],function(e,t){success(e?{object:null}:{object:object})})},storage.createObject=function(e){"string"==typeof e&&(e={code:e}),log.debug({cls:"Storage",fn:"createObject",params:e.classId||e.code}),e=e||{};var t=e,s=e.success,n=e.failure,r=e.classId||storage.getClass(e.code).get("fid"),o=e.options||{};e.session=e.session||{};var i=e.session;async.series([function(e){storage.fireEvent("beforecreateobject",{classId:r,session:i,storage:storage,success:function(t){t&&t.cancel?e("cancel"):e()}})}],function(e,a){return"cancel"!=e&&storage.revision[i.id]?(storage.clsChange({classId:r}),void storage.client.getNextId({session:i,table:"tobject",success:function(e){var a=[],c=t.objectId||e.id;a.push("insert into tobject (fid, fclass_id, fstart_id, fend_id)\nvalues ("+c+","+r+","+storage.revision[i.id]+","+storage.maxRevision+")");var f=function(e){var t=storage.classesMap[e.classId],s=t.get("fcode")+"_"+e.classId;a.push("insert into "+s+" (fobject_id) values ("+c+")"),t.get("fparent_id")&&f({classId:t.get("fparent_id")})};storage.connection.dbEngine&&storage.connection.dbEngine.enabled||f({classId:r}),async.eachSeries(a,function(e,t){storage.query({session:i,sql:e,success:function(e){t()},failure:t})},function(e){if(e)n&&n(new VError(e,"Storage.createObject"));else if(s){var t=new storage.tobject({code:"tobject"});t.data.id=c,t.data.fclass_id=r,o.object=t;var a={};a[c+"-data"]=t.dataToJSONString(),storage.redisClient.hmset(storage.code+"-objects",a),storage.revisions[storage.revision[i.id]]&&(storage.revisions[storage.revision[i.id]].objects.created.push(c),storage.revisions[storage.revision[i.id]].objects.classId[c]=r),storage.fireEvent("aftercreateobject",{classId:r,session:i,object:t,storage:storage,success:function(e){s(o)}})}})},failure:function(e){n&&n(new VError(e,"Storage.createObject"))}})):(console.log("cancel or no transaction, session "+JSON.stringify(i)),void s({object:null}))})},storage.tobject=function(e){var t=this;t.code=e.code,t.data={},t.originalData={},t.removed=!1},storage.tobject.prototype.get=function(e){return this.data[e]},storage.tobject.prototype.set=function(e,t){this.data[e]=t},storage.getClassAttrs=function(e){log.debug({cls:"storage",fn:"getClassAttrs"}),e.result=e.result||{};for(var t=0;t<storage.classAttrs.length;t++)storage.classAttrs[t].get("fclass_id")==e.classId&&(e.result[storage.classAttrs[t].get("fcode")]=storage.classAttrs[t]);return storage.classesMap[e.classId].get("fparent_id")&&(e.classId=storage.classesMap[e.classId].get("fparent_id"),storage.getClassAttrs(e)),e.result},storage.getDependentObjects=function(e){var t=e.session,s=e.object,n=e.success,r=e.failure,o=function(e){var t=[e],s=storage.classesMap[e];return s.get("fparent_id")&&(t=t.concat(o(s.get("fparent_id")))),t},i=function(e){for(var t=[e],s=storage.classesMap[e],n=0;n<s.childs.length;n++)t=t.concat(i(storage.classesMap[s.childs[n]].get("fid")));return t},a=o(s.data.fclass_id).concat(i(s.data.fclass_id));a.push(12);for(var c=[],f=0;f<storage.classAttrs.length;f++){var l=storage.classAttrs[f];a.indexOf(l.get("ftype_id"))>-1&&c.push(l.get("fid"))}if(c.length){var d=[],u=[];storage.query({session:t,sql:"select fobject_id, fclass_attr_id from tobject_attr\nwhere fclass_attr_id in ("+c.join(",")+") and fnumber="+s.data.id+" and "+storage.getCurrentFilter()+"\n",success:function(e){for(var t=e.result.rows,s=0;s<t.length;s++){var r=storage.classAttrsMap[t[s].fclass_attr_id].get("fremove_rule");"cascade"==r?d.push(t[s].fobject_id):u.push({id:t[s].fobject_id,attrCode:l.get("fcode")})}n({cascade:d,setnull:u})},failure:function(e){r&&r(new VError(e,"Storage.getDependentObjects"))}})}else n({cascade:d,setnull:u})},storage.removeObject=function(e){var t=e.session;storage.redisClient.hset("sessions",t.id+"-clock",config.clock);var s=function(e){var s=e.object,n=s.data.id,r=e.success,o=e.failure,i=[];i.push("update tobject set fend_id="+storage.revision[t.id]+" where fend_id="+storage.maxRevision+" and fid="+n);var a=function(e){var t=storage.classesMap[e.classId],s=t.get("fcode")+"_"+e.classId;i.push("delete from "+s+" where fobject_id="+n),t.get("fparent_id")&&a({classId:t.get("fparent_id")})};storage.connection.dbEngine&&storage.connection.dbEngine.enabled||a({classId:s.data.fclass_id}),async.map(i,function(e,s){storage.query({session:t,sql:e,success:function(){s()},failure:s})},function(e,t){if(e&&o)return o(new VError(e,"Storage.removeSingleObject"));var i=storage.classesMap[s.data.fclass_id],a=[];for(var c in s.originalData)s.originalData[c]&&a.push(c);async.map(a,function(e,t){var n=i.attrs[e];if(n&&n.get("funique")){var r=storage.code+"-unique-"+n.get("fid");storage.redisClient.srem(r,s.originalData[e],function(e,s){t()})}else t()},function(e,t){storage.redisClient.hdel(storage.code+"-objects",n+"-data",function(e,t){r&&r()})})})},n=e.success,r=(e.failure,e);if(!e.object)return void(n&&n({cascadeNum:0,setnullNum:0}));var o,i,a,c;async.series([function(s){storage.fireEvent("beforeremoveobject",{object:e.object,session:t,storage:storage,success:function(e){e&&e.cancel?s("cancel"):s()}})},function(n){storage.suspendEvent("beforeremoveobject"),storage.getDependentObjects({session:t,object:e.object,success:function(e){o=e.cascade,i=o.length,a=e.setnull,c=a.length,async.parallel([function(e){async.map(a,function(e,s){storage.getObject({session:t,id:e.id,success:function(n){var r=n.object;r?(r.set(e.attrCode,null),r.commit({session:t,success:function(){s()},failure:function(e){s()}})):s()},failure:function(e){s()}})},function(t,s){e()})},function(e){async.map(o,function(e,s){storage.getObject({session:t,id:e,success:function(e){storage.removeObject({session:t,object:e.object,success:function(e){i+=e.cascadeNum,c+=e.setnullNum,s()},failure:function(e){s()}})},failure:function(e){s()}})},function(t,s){e()})},function(e){r.success=function(){e()},r.failure=function(){e()},s(r)}],function(e,t){n()})},failure:n})}],function(e,t){storage.resumeEvent("beforeremoveobject"),"cancel"==e?n&&n({cascadeNum:0,setnullNum:0}):n&&n({cascadeNum:i,setnullNum:c})})},storage.tobject.prototype.commit=function(e){log.debug({cls:"Object",fn:"commit"}),e=e||{},e.session=e.session||{};var t=e.session;storage.redisClient.hset("sessions",t.id+"-clock",config.clock);var s=e.success,n=e.failure,r=this.data.id,o=this;async.series([function(e){o.removed?e():storage.fireEvent("beforecommitobject",{object:o,session:t,storage:storage,success:function(t){t&&t.cancel?e("cancel"):e()}})}],function(e,i){if("cancel"==e||!storage.revision[t.id])return void(s&&s());if(storage.revisions[storage.revision[t.id]]&&(storage.revisions[storage.revision[t.id]].objects.changed.push(r),storage.revisions[storage.revision[t.id]].objects.classId[r]=o.get("fclass_id")),o.removed)storage.revisions[storage.revision[t.id]]&&storage.revisions[storage.revision[t.id]].objects.removed.push(r),storage.clsChange({session:t,classId:o.get("fclass_id")}),storage.removeObject({session:t,object:o,success:s,failure:function(e){n(new VError(e,"Object.commit"))}});else{var a=[];for(var c in o.data)["id","fclass_id"].indexOf(c)>-1||(_.isDate(o.originalData[c])&&(o.originalData[c]=common.getLocalISOString(o.originalData[c])),_.isDate(o.data[c])&&(o.data[c]=common.getLocalISOString(o.data[c])),o.originalData.hasOwnProperty(c)&&o.originalData[c]==o.data[c]||a.push(c));a.length?async.series([function(e){var t=storage.classesMap[o.data.fclass_id];async.map(a,function(e,s){var n=t.attrs[e];if(n&&n.get("funique")){var r=storage.code+"-unique-"+n.get("fid");async.series([function(t){o.data[e]?storage.redisClient.sadd(r,o.data[e],function(s,n){n?t():t("value exists: "+o.data[e])}):t()},function(t){o.originalData[e]?storage.redisClient.srem(r,o.originalData[e],function(e,s){t()}):t()}],function(e,t){s(e)})}else s()},function(t,s){e(t)})},function(e){storage.clsChange({session:t,classId:o.get("fclass_id")});for(var s=storage.getClassAttrs({classId:o.get("fclass_id")}),n={},i=[],c=[],f=[],l=0;l<a.length;l++){var d=o.data[a[l]];d!==!0&&d!==!1||(d=Number(d));var u=s[a[l]];if(u){c.push({sql:"update tobject_attr set fend_id="+storage.revision[t.id]+"\nwhere fobject_id="+r+" and fclass_attr_id="+u.get("fid")+" and fend_id="+storage.maxRevision});var g="fnumber";1==u.get("ftype_id")||5==u.get("ftype_id")?g="fstring":3==u.get("ftype_id")&&(g="ftime","string"==typeof d&&""==(d||"").trim()&&(d=null)),"fnumber"!=g||!isNaN(d)&&""!==d||(d=null),f.push({sql:"insert into tobject_attr (fobject_id, fclass_attr_id, "+g+", fstart_id, fend_id)\nvalues ("+r+","+u.get("fid")+", $1, "+storage.revision[t.id]+","+storage.maxRevision+")",params:[d]});var p=u.get("fclass_id");n[p]=n[p]||{name:storage.classesMap[p].get("fcode")+"_"+u.get("fclass_id")},n[p].attrs=n[p].attrs||{},n[p].attrs[u.get("fcode")+"_"+u.get("fid")]=d}}i=c.concat(f);var m=function(e){async.mapSeries(i,function(e,s){storage.query({session:t,sql:e.sql,params:e.params,success:function(){s()},failure:s})},e)},h=[];for(var p in n)h.push(n[p]);var v=function(e){async.mapSeries(h,function(e,s){storage.query({session:t,sql:"select fobject_id from "+e.name+" where fobject_id="+r,success:function(n){if(0==n.result.rows.length){var o=["fobject_id"],i=[r],a="$1";for(var c in e.attrs)o.push(c),i.push(e.attrs[c]),a+=", $"+i.length;storage.query({session:t,sql:"insert into "+e.name+" ("+o.join(",")+") values ("+a+")",params:i,success:function(){s()},failure:function(){s()}})}else{var o=[],i=[];for(var c in e.attrs){var f=e.attrs[c];""===f&&(f=null),i.push(f),o.push(c+"=$"+i.length)}storage.query({session:t,sql:"update "+e.name+" set "+o.join(",")+"\nwhere fobject_id="+r,params:i,success:function(){s()},failure:function(){s()}})}},failure:s})},function(t,s){e(t)})},_=[m,v];async.series(_,function(t,s){e(t)})}],function(e,t){e?n?n(new VError(e,"Object.commit")):(log.error({cls:"Object",fn:"commit",err:e}),s&&s()):(storage.redisClient.hdel(storage.code+"-objects",r+"-data"),s&&s())}):s&&s()}})},storage.tobject.prototype.sync=function(e){this.commit.call(this,e)},storage.tobject.prototype.remove=function(){this.removed=!0},storage.tobject.prototype.dataToJSONString=function(e){var t;for(var s in this.data)t?t+=",":t="{",t+='"'+s+'":'+common.ToJSONString(this.data[s],e);return t+="}"},storage.dataId={},storage.getId=function(e){function t(){if(storage.dataId.hasOwnProperty(r)&&storage.dataId[r].hasOwnProperty(o))log.trace({cls:"storage",fn:"getId",classCode:r,valueCode:o},storage.dataId[r][o]),s({id:storage.dataId[r][o]});else{log.trace({cls:"storage",fn:"getId",classCode:r,valueCode:o},"unknown");var e={error:"unknown value. classCode: "+r+", valueCode: "+o,module:"storage",fn:"getId"};n?n(e):s({id:null})}}log.debug({cls:"storage",fn:"getId"}),e=e||{},e.session=e.session||{};var s=(e.session,e.success),n=e.failure,r=e.classCode,o=e.valueCode||e.code;return o?void(null==storage.dataId[r]?storage.execute({sql:{select:[{a:"id"},"id",{a:"code"},"code"],from:[{a:r}]},success:function(e){storage.dataId[r]={};for(var s=0;s<e.length;s++)storage.dataId[r][e.get(s,"code")]=e.get(s,"id");t()}}):t()):void s({id:null})},storage.execute=function(e,t){var s=e,n=e.success,r=e.failure,o=e.session;e.storage=storage;var i=new Query(e);i.generate();var a=i.fields,c=i.selectSQL+i.fromSQL+i.whereSQL+i.orderSQL;"mssql"!=storage.client.database&&(c+="\nlimit "+(e.sql.limit||config.query.maxRowNum)+" offset "+(e.sql.offset||"0")+"\n"),storage.query({session:o,sql:c,success:function(e){if(s.resultText){var r="[";if(e.result)for(var o=e.result.rows,i=0;i<o.length;i++){i&&(r+=","),r+="[";for(var c=0;c<a.length;c++)c&&(r+=","),r+=common.ToJSONString(o[i][a[c]]);r+="]"}r+="]",t?t(null,r):n({result:r})}else if(s.asArray||s.sql.asArray){var f=[];_.each(s.sql.select,function(e){"string"==typeof e&&f.push(e)});var l=[];_.each(e.result.rows,function(e){var t={};_.each(a,function(s,n){t[f[n]]=e[s]}),l.push(t)}),t?t(null,l):n(l)}else e&&e.result&&e.result.rows&&(e.rows=e.result.rows,e.length=e.rows.length,e.get=function(t,s){return t>=e.length?null:e.rows[t][s+"_"]}),t?t(null,e):n(e)},failure:function(e){if(t)t(new VError(e,"Storage.execute"));else{if(!r)throw new Error("storage.execute: "+e);r(new VError(e,"Storage.execute"))}}})},storage.prepareSQLForCount=function(e,t){function s(e){var t;for(t in e)if("distinct"!=t)break;return t}function n(e,t){if(!_.isArray(e))return!1;for(var r=0;r<e.length;r++){var o=e[r];if(_.isArray(o)){var i=n(o,t);if(i)return i}if(_.isObject(o)&&s(o)==t)return!0}return!1}function r(e,t){var s=!1;return _.each(e,function(e,r){e&&"inner-join"!=e[0]&&r!=t&&n(e,t)&&(s=!0)}),s}function o(e,t){var o,i={};return _.each(e.from,function(t,n){"left-join"!=t&&"inner-join"!=t||(o=s(e.from[n+1])),o&&(i[o]=i[o]||[],i[o].push(t))}),_.each(i,function(o,a){var c=!1;if("inner-join"!=o[0]&&(n(e.where,a)||n(e.order,a)||n(e.orderAfter,a)||r(i,a)||(c=!0),t)){for(var f=!1,l=0;l<e.select.length;l+=2)if(s(e.select[l])==a&&t[e.select[l+1]]){
f=!0;break}f&&(c=!1)}c&&(i[a]=null)}),i}var i=o(e,t),a={};return _.each(e,function(t,n){if("select"==n){a.select=[];for(var r=0;r<t.length;r+=2){var o=s(t[r]);(i[o]||o==s(e.from[0]))&&(a.select.push(t[r]),a.select.push(t[r+1]))}}else"from"==n?(a.from=[t[0]],_.each(i,function(e,t){e&&_.each(e,function(e,t){a.from.push(e)})})):a[n]=t}),a},storage.getContent=function(e){function t(e){var t;for(t in e.from[0])break;var s=e.orderAfter||e.order;s=s||[];for(var n=0,r=0;r<s.length;r++)if("object"==typeof s[r])for(var o in s[r])"id"==s[r][o]&&(n=1);if(!n&&["system.class","system.class_attr","system.view","system.view_attr","system.action","system.action_attrs","system.object","system.object_attr","system.revision"].indexOf(e.from[0][t])==-1){s.length&&s.push(",");var i={};i[t]="id",s.push(i)}e.orderAfter?e.orderAfter=s:e.order=s}var s=e.viewId,n=(e.column,e.row),r=(e.columnCount,e.rowCount),o=(e.parentId,e.filter),i=e.order,a=e.total,c=e.dateAttrs||[],f=e.timeOffsetMin,l=e.success,d=e.failure,u=e.request;e.session=e.session||u.session||{};var g=e.session,p=storage.viewsMap[s],m=JSON.parse(p.get("fquery"));if(!m||"unselected"==o){var h="{\n\tview: "+s+",\n\tcolumnCount: 0,\n\theaderDepth: 0,\n\tcolumn: {\n\t},\n\ttree: {\n\t\tlength: 0\n\t}\n}";return void(l&&l({result:h}))}o&&o.length&&(m.where=m.where||[],m.where.length&&(m.where=[m.where],m.where.push("and")),m.where.push(o)),i&&i.length&&(m.orderAfter?m.orderAfter=i:m.order=i),t(m);var v,_,b,w,y=[];async.series([function(e){config.caching&&config.caching.getContent?storage.redisClient.hget(storage.code+"-content",u.storageParam,function(t,s){s?e(s):e()}):e()},function(e){v=new Query({storage:storage,session:g,sql:m}),v.generate(),w=v.selectSQL+v.fromSQL+v.whereSQL+v.orderSQL;for(var t in v.attrs){var s=function(e){y.push(e);for(var t=storage.classesMap[e].childs,n=0;n<t.length;n++)s(t[n])},n=v.attrs[t].cls;["system.class","system.class_attr","system.view","system.view_attr"].indexOf(n)>-1||s(storage.classesCode[n].get("fid"))}e()},function(e){var t=w+"\nlimit "+r+" offset "+n+"\n";"mssql"==storage.client.database&&(t="select mssql2.* from (\n\tselect mssql1.*, ROW_NUMBER () over (order by (select 0)) as 'rn' from (\n"+w+"\n\t) mssql1\n) mssql2\nwhere rn > "+n+" and rn <= "+(Number(n)+Number(r))),storage.query({client:db.create(storage),sql:t,success:function(t){_=t.result.rows,e()},failure:e})},function(e){var t=w;if(config.query.optimizeCountQuery){var s=storage.prepareSQLForCount(m,a),n=new Query({storage:storage,session:g,sql:s});n.generate(),t=n.selectSQL+n.fromSQL+n.whereSQL+n.orderSQL}var r="select\n\tcount (*) as rows_num";for(var o in a){for(var i=0,c=1;c<m.select.length;c+=2)if(m.select[c]==o){i=1;break}if(i){var f=o.toLowerCase()+"_";"cnt"==a[o]&&(a[o]="count"),r+=", "+a[o]+"("+f+") as "+f}}r+="\nfrom ("+t,"postgres"==storage.client.database&&(r+="\nlimit "+(config.query.maxCount||1e3)+" offset 0\n"),r+=") v\n",storage.query({client:db.create(storage),sql:r,success:function(t){b=t.result.rows[0],e()},failure:e})}],function(e,t){if(e)return d(new VError(e,"Storage.getContent"));var r=p.attrs,o=0,i=[];for(var a in r)r[a].set("field",r[a].get("fcode").toLowerCase()+"_"),i.push(r[a]),o++;i.sort(function(e,t){var s=e.get("forder"),n=t.get("forder");return null==n||s<n?-1:null==s||s>n?1:s==n?0:void 0});for(var m="{header: {error: ''}, data: {view: "+s+", columnCount: "+o+", headerDepth: 1, column: {\n",h=0;h<i.length;h++){var w=i[h];h&&(m+="\t,\n");var j=w.get("fcode").toLowerCase()+"_";m+="\t"+h+": {\n\t\twidth: "+w.get("fcolumn_width")+",\n\t\tarea: "+w.get("farea")+",\n\t\t0: {\n\t\t\tattrId: "+w.get("fid")+',\n\t\t\tattr: "'+w.get("fcode")+'",\n\t\t\ttext: "'+w.get("fname").split('"').join('\\"')+'",\n\t\t\tidAttr: "id",\n\t\t\ttypeId: '+v.fieldTypeId[j]+",\n\t\t\ttotal: "+(b[j]?b[j]:"null")+",\n\t\t\tspan: 1\n\t\t}\n\t}\n"}m+="}, tree: {overflow: "+(b.rows_num==(config.query.maxCount||1e3)?1:0)+", length: "+b.rows_num+", currentLength: "+_.length,m+=_.length?",\n":"\n";for(var h=0;h<_.length;h++){h&&(m+=",\n"),m+=h+Number(n)+": {\n\tid: "+h+",\n\tlength: 0,\n\tdata: {\n";for(var x=0;x<i.length;x++){x&&(m+="\t\t,\n");var q=_[h][i[x].get("field")];if(c.indexOf(i[x].get("fcode"))>-1&&q&&"object"==typeof q&&q.getMonth)if(f&&(q.getUTCHours()||q.getUTCMinutes()||q.getUTCSeconds())){var $=60*f*1e3;q=new Date(q.getTime()-$),q="new Date ("+q.getUTCFullYear()+","+q.getUTCMonth()+","+q.getUTCDate()+")"}else q="new Date ("+q.getFullYear()+","+q.getMonth()+","+q.getDate()+")";else q=common.ToJSONString(q);m+="\t\t"+x+": {text: "+q+"}\n"}m+="\t}\n}\n"}if(m+="}}}",config.caching&&config.caching.getContent&&y.length&&!storage.revision[g.id]){storage.redisClient.hsetnx(storage.code+"-content",u.storageParam,m);for(var h=0;h<y.length;h++)storage.redisClient.hsetnx(storage.code+"-"+y[h]+"-clschange",u.storageParam,"1")}l({result:m})})},storage.selectRow=function(e){var t=e.viewId,s=e.viewFilter,n=e.selectFilter,r=e.success,o=e.failure,i=(e.request,e.session||{userId:null}),a=storage.viewsMap[t],c=JSON.parse(a.get("fquery"));if(s&&s.length&&(c.where=c.where||[],c.where.length&&c.where.push("and"),c.where.push(s)),"mssql"!=storage.client.database){var f=["row_number ()","over"];c.order?f.push(["order by"].concat(c.order)):f.push([]),c.select.push(f),c.select.push("rn")}var l,d,u,g=[];async.series([function(e){l=new Query({storage:storage,session:i,sql:c}),l.generate(),u=l.selectSQL+l.fromSQL+l.whereSQL+l.orderSQL;for(var t in l.attrs)g.push(storage.classesCode[l.attrs[t].cls].get("fid"));e()},function(e){n[0]=n[0].substr(1)+"_",u="mssql"==storage.client.database?"select\n\t(mssql2.rn - 1) as rn_ from (\n\t\tselect ROW_NUMBER () over (order by (select 0)) as 'rn', vr_.* from (\n\t\t\t"+u+") vr_ \t) mssql2\nwhere\n"+n.join(" "):"select rn_ from ("+u+") v where "+n.join(" "),storage.query({sql:u,success:function(t){d=t.result?t.result.rows:[],e()},failure:e})}],function(e,t){if(e)return o(new VError(e,"Storage.selectRow"));var s="0";d.length&&(s=d[0].rn_-1),r({result:s})})},storage.clsChange=function(e){var t=e.classId;log.debug({cls:"storage",fn:"clsChange",params:t});e.session;storage.redisClient.hkeys(storage.code+"-"+t+"-clschange",function(e,s){for(var n=0;n<s.length;n++)storage.redisClient.hdel(storage.code+"-content",s[n]);storage.redisClient.del(storage.code+"-"+t+"-clschange")})},storage.setVar=function(e){var t=e.success;storage.redisClient.hset(storage.code+"-vars",e.field,e.value,function(e,s){t&&t()})},storage.getVar=function(e){var t=e.success;storage.redisClient.hget(storage.code+"-vars",e.field,function(e,s){t&&t({value:s})})},storage.removeVar=function(e){var t=e.success;storage.redisClient.hdel(storage.code+"-vars",e.field,function(e,s){t&&t()})},storage.authRecords={},storage.subjectRoles={},storage.authInfoUpdater=function(e){var t;async.series([function(e){storage.execute({sql:{select:[{a:"id"},"id",{a:"login"},"login",{a:"password"},"password",{a:"use"},"use"],from:[{a:"system.admin.Authentication.LoginPassword"}]},success:function(s){t=s.result.rows,e()},failure:function(t){e(t)}})},function(e){var t=storage.getClass("ose.role");t.attrs.menu?storage.execute({sql:{select:[{a:"subject"},"subject",{a:"role"},"role",{b:"menu"},"menu"],from:[{a:"ose.srole"},"left-join",{b:"ose.role"},"on",[{a:"role"},"=",{b:"id"}]]},success:function(t){for(var s=t.result.rows,n=0;n<s.length;n++)storage.subjectRoles[s[n].subject_]={role:s[n].role_,menu:s[n].menu_};e()},failure:function(t){e(t)}}):e()},function(e){var s={};async.map(t,function(e,t){if(!e.use_)return void t();var n=e.login_,r=e.password_;if(!s[n]==r)return void t();s[n]=r;var o=storage.classAttrsMap[n],i=storage.classAttrsMap[r],a=storage.classesMap[o.get("fclass_id")],c=a.toc;storage.query({sql:"select fobject_id, "+o.toc+", "+i.toc+"\nfrom "+c+"\nwhere "+o.toc+" is not null and "+i.toc+" is not null\n",success:function(e){for(var s=e.result.rows,n=0;n<s.length;n++)storage.authRecords[s[n][o.toc]]={password:s[n][i.toc],objectId:s[n].fobject_id,hasTryAttrs:!!a.attrs.lastTry};t()},failure:function(e){t(e)}})},function(t,s){e(t)})}],function(t,s){e&&e.success&&e.success()})},storage.subscribers={beforecreateobject:[],aftercreateobject:[],beforegetobject:[],aftergetobject:[],beforecommitobject:[],beforeremoveobject:[],generatequeryblock:[]},storage.suspendedEvents={},storage.on=function(e,t){storage.subscribers[e]=storage.subscribers[e]||[],storage.subscribers[e].push(t)},storage.un=function(e,t){storage.subscribers[e]&&storage.subscribers[e].indexOf(t)>-1&&storage.subscribers[e].splice(storage.subscribers[e].indexOf(t),1)},storage.suspendEvent=function(e){if(e)storage.suspendedEvents[e]=1;else for(e in storage.subscribers)storage.suspendedEvents[e]=1},storage.resumeEvent=function(e){if(e)storage.suspendedEvents[e]=0;else for(e in storage.subscribers)storage.suspendedEvents[e]=0},storage.fireEvent=function(e,t){t=t||{};var s=t.success;if(storage.suspendedEvents[e])return void(s&&s());var n=storage.subscribers[e]||[];delete t.success;var r=0;if(!s){for(var o=0;o<n.length;o++)n[o](t);return t}async.eachSeries(n,function(e,s){t.success=function(e){e&&e.cancel&&(r=1),s()},e(t)},function(e){s&&s({cancel:r})})},storage.freeResources=function(){clearInterval(storage.keepConnectionAliveIntervalId),clearInterval(storage.authInfoUpdaterIntervalId),storage.client.disconnect(),storage.redisClient.quit(),storage.redisSub.quit(),storage.redisPub.quit(),storage.ose&&storage.ose.freeResources()},storage.code=options.code,storage.redisClient=redis.createClient(config.redis.port,config.redis.host),storage.redisPub=redis.createClient(config.redis.port,config.redis.host),storage.redisSub=redis.createClient(config.redis.port,config.redis.host),storage.connection=options.connection,storage.revisions={},async.series([function(e){config.redis.db?storage.redisSub.select(config.redis.db,function(t,s){storage.redisPub.select(config.redis.db,function(t,s){storage.redisClient.select(config.redis.db,function(t,s){e()})})}):e()}],function(e){storage.redisSub.on("message",function(e,t){if(log.debug({cls:"storage"},"redisSub.message on channel: "+e),e==config.redis.db+"-"+storage.code+"-revisions"){var s=JSON.parse(t);storage.revisions[s.id]||(storage.revisions[s.id]=s,log.debug({cls:"storage"},"new revision: "+s.id));for(var n=0;n<s.classes.created.length;n++)storage.updateClassCache(s.classes.created[n]);for(var n=0;n<s.classes.changed.length;n++)storage.updateClassCache(s.classes.changed[n]);for(var n=0;n<s.classAttrs.created.length;n++)storage.updateClassAttrCache(s.classAttrs.created[n]);for(var n=0;n<s.classAttrs.changed.length;n++)storage.updateClassAttrCache(s.classAttrs.changed[n]);for(var n=0;n<s.views.created.length;n++)storage.updateViewCache(s.views.created[n]);for(var n=0;n<s.views.changed.length;n++)storage.updateViewCache(s.views.changed[n]);for(var n=0;n<s.viewAttrs.created.length;n++)storage.updateViewAttrCache(s.viewAttrs.created[n]);for(var n=0;n<s.viewAttrs.changed.length;n++)storage.updateViewAttrCache(s.viewAttrs.changed[n])}}),storage.redisSub.subscribe(config.redis.db+"-"+storage.code+"-revisions");var t=options,s=db.create(storage);s.connect({systemDB:options.systemDB,success:function(){if(s.inStorage=1,storage.client=s,options.systemDB){var e=options.success;return void(e&&e())}async.series([function(e){config.port==config.startPort||process.env.mainWorker?s.update({success:function(){e()}}):e()},function(e){storage.initClasses({success:function(){e()}})},function(e){storage.initClassAttrs({success:function(){e()}})},function(e){storage.initViews({success:function(){e()}})},function(e){storage.initViewAttrs({success:function(){e()}})},function(e){options.authInfoUpdater&&!storage.authInfoUpdaterIntervalId?storage.authInfoUpdater({success:function(){storage.authInfoUpdaterIntervalId=setInterval(storage.authInfoUpdater,6e4),e()}}):e()},function(e){storage.ose=new Ose({storage:storage,success:function(){e()}})}],function(e,t){var s=options.success;storage.query({sql:"select max (fid) as maxId from trevision",success:function(e){storage.lastRevision=e.result.rows[0].maxid,s&&s()}})})},failure:function(e){log.error({cls:"storage",fn:"init",error:util.inspect(e.error)}),t.failure&&t.failure(e)}})})},db={};db.create=function(e){if("postgres"==e.connection.database){var t=new db.Postgres(e);return t}if("mssql"==e.connection.database){var t=new db.MSSQL(e);return t}throw"Client ({database: '"+e.connection.database+"'}) unsupported database."},db.execute=function(e){var t,s=e;async.series([function(e){projects.loadConfig({code:s.code,success:function(){e()},failure:function(t){e(t)}})},function(e){var n=config.storages[s.code];if("rebuild"==s.fn)return void(t=new Storage({code:s.code,connection:n,success:function(){console.log("Rebuilding storage ...");var s=new Import;s.removeTOC({storage:t,success:function(){s.createTOC({storage:t,success:function(){console.log("Storage rebuilded."),e()}})}})}}));if("import"==s.fn){console.log("Importing storage ...");var r=new Import;return void r.importFromFile({code:s.code,file:s.file,success:function(){console.log("Storage imported."),e()}})}if("export"==s.fn){console.log("Exporting storage ...");var o=new Export;return void o.exportToFile({schema:!_.has(s,"schema")||s.schema,code:s.code,file:s.file,classes:s.classes||"all",views:s.views||"all",except:{tobject:[{fclass_id:s.filterClasses||[]}]},space:_.has(s,"space")?s.space:"\t",success:function(){console.log("Storage exported."),e()}})}t=new Storage({systemDB:!0,code:s.code,connection:n,success:function(){"create"==s.fn&&(console.log("Creating storage ..."),t.client.create({cfg:s,connection:n,success:function(){console.log("Storage created."),e()}})),"remove"==s.fn&&(console.log("Removing storage ..."),t.client.remove({cfg:s,connection:n,success:function(){console.log("Storage removed."),e()}})),"clear"==s.fn&&(console.log("Clearing storage ..."),db.clear({storage:t,success:function(){console.log("Storage cleared."),e()}}))},failure:function(t){e(t.error)}})}],function(e){e?common.log({file:config.rootDir+"/error.log",text:e}):(t&&t.freeResources(),s.success&&s.success())})},db.clear=function(e){var t=e.storage,s=e.success,n=[];async.series([function(e){t.client.disconnect(),t.client.connect({success:function(){e()},failure:function(){e()}})},function(e){t.query({sql:"select fid, fcode from tclass\nwhere "+t.getCurrentFilter()+"\norder by fid\n",success:function(t){for(var s=t.result.rows,r=0;r<s.length;r++){var o=s[r].fcode+"_"+s[r].fid;n.push(o)}n.push("taction"),n.push("taction_attr"),n.push("tclass"),n.push("tclass_attr"),n.push("tobject"),n.push("tobject_attr"),n.push("tview"),n.push("tview_attr"),n.push("trevision"),n.push("tright"),n.push("tsession"),n.push("tschema"),n.push("tmail"),e()},failure:function(t){e(t.error)}})},function(e){async.map(n,function(e,s){t.client.isTableExists({table:e,success:function(n){n?t.query({sql:"drop table "+e+" cascade",success:function(e){s()}}):s()}})},function(t,s){e()})}],function(e,t){e&&common.log({file:config.rootDir+"/error.log",text:"error: "+e}),s()})},db.init=function(e){var t=config.storages[e.code],s=t.rootDir;async.series([function(e){fs.mkdir(s,e)},function(e){fs.mkdir(s+"/files",e)},function(e){fs.mkdir(s+"/plugins",e)},function(e){fs.mkdir(s+"/resources",e)},function(e){fs.mkdir(s+"/resources/css",e)},function(e){fs.mkdir(s+"/resources/images",e)},function(e){fs.mkdir(s+"/resources/scripts",e)},function(e){fs.mkdir(s+"/schema",e)},function(e){fs.readFile(config.rootDir+"/server/project-app/schema/schema-app.js",function(t,n){return t?e(t):void fs.writeFile(s+"/schema/schema-app.js",n,e)})},function(e){var n="<html>\n<head>\n\t<title>"+t.code+'</title>\n\t<!-- ExtJS -->\n\t<link rel="stylesheet" type="text/css" href="/third-party/extjs4/resources/css/ext-all-objectum.css">\n\t<script type="text/javascript" src="/third-party/extjs4/ext-all-debug.js"></script>\n\t<script type="text/javascript" src="/third-party/extjs4/locale/ext-lang-ru.js" charset="UTF-8"></script>\n\t<!-- Objectum Client -->\n\t<link rel="stylesheet" type="text/css" href="/client/extjs4/css/images.css">\n\t<script type="text/javascript" src="/client/extjs4/all-debug.js" charset="UTF-8"></script>\n\t<!-- Current configuration -->\n\t<script type="text/javascript" src="resources/scripts/all-debug.js" charset="UTF-8"></script>\n</head>\n<body>\n\t<div id="loading"></div>\n\t<script type="text/javascript" charset="UTF-8">\n\t\t$o.app.start ({"code": "'+t.code+'", "name": "'+t.code+'", "version": "1.0", "locale": "en", "useHash":true});\n\t</script>\n</body>\n</html>\n';fs.writeFile(s+"/index.html",n,e)},function(e){},function(e){},function(e){}],function(e){})};var pgTypes=pg.types;pgTypes&&(pgTypes.setTypeParser(1700,function(e){return null===e?null:parseFloat(e)}),pgTypes.setTypeParser(700,function(e){return null===e?null:parseFloat(e)}),pgTypes.setTypeParser(701,function(e){return null===e?null:parseFloat(e)}),pgTypes.setTypeParser(20,function(e){return null===e?null:parseInt(e)}),pgTypes.setTypeParser(21,function(e){return null===e?null:parseInt(e)}),pgTypes.setTypeParser(23,function(e){return null===e?null:parseInt(e)})),db.Postgres=function(e){var t=this;t.storage=e,t.database="postgres",t.dbEngine=e.connection.dbEngine,t.host=e.connection.host,t.port=e.connection.port,t.db=e.connection.db,t.dbUser=e.connection.dbUser,t.dbPassword=e.connection.dbPassword,t.dbaUser=e.connection.dbaUser,t.dbaPassword=e.connection.dbaPassword,t.connection="tcp://"+t.dbUser+":"+t.dbPassword+"@"+t.host+":"+t.port+"/"+t.db,t.adminConnection="tcp://"+t.dbaUser+":"+t.dbaPassword+"@"+t.host+":"+t.port+"/postgres",t.tags={schema:t.dbUser,schema_prefix:t.dbUser+".",tablespace:"tablespace "+t.dbUser,tid:"bigserial",tid_object_attr:"bigserial",tnumber:"bigint",tnumber_value:"numeric",ttext:"text",ttimestamp:"timestamp (6)",tstring:"varchar (1024)",tstring_value:"text",tocObjectId:"fobject_id bigint not null, primary key (fobject_id)",tobject_attr_fstring:"substr (fstring, 1, 1024)"}},db.Postgres.prototype.connect=function(e){e=e||{};var t=this,s=e.success,n=new pg.Client(e.systemDB?t.adminConnection:t.connection);n.connect(function(r){r?(log.error({cls:"Postgres",fn:"connect",err:r}),e.failure&&e.failure(new VError(r,"Postgres.connect"))):(t.client=n,t.connected=!0,t.lastActivity=(new Date).getTime(),n.pauseDrain&&n.pauseDrain(),t.query({sql:"select version ()",success:function(e){var n=e.result.rows[0].version;n=n.split(" ")[1],n=n.split("."),n=Number(10*n[0])+Number(n[1]),t.version=n,t.query({sql:"select pg_backend_pid() as pid",success:function(e){t.pid=e.result.rows[0].pid,db.Postgres.prototype.clients=db.Postgres.prototype.clients||{},db.Postgres.prototype.clients[t.pid]=t,s&&s()}})}}))}),n.on("error",function(e){log.error({cls:"Postgres",fn:"connect",err:e,client_error:!0})})},db.Postgres.prototype.disconnect=function(e){var t=this;t.client&&t.client.end&&(t.client.end(),t.connected=0)},db.Postgres.prototype.query=function(e){function t(){s.lastActivity=(new Date).getTime(),log.debug({cls:"Postgres",fn:"query",sql:e.sql,params:e.params}),s.client.query(e.sql,e.params,function(t,s){t?(log.error({cls:"Postgres",fn:"query",err:t,sql:e.sql,params:e.params}),e.failure&&e.failure(new VError(t,"Postgres.query"))):e.success&&e.success({result:s})})}var s=this;s.connected?t():s.connect({success:function(){t()},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.query"))}})},db.Postgres.prototype.startTransaction=function(e){this.query({sql:"begin",success:function(){e.success()},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.startTransaction"))}})},db.Postgres.prototype.commitTransaction=function(e){this.query({sql:"commit",success:function(){e.success()},failure:function(t){log.error({cls:"Postgres",fn:"commitTransaction",err:t}),e.failure&&e.failure(new VError(t,"Postgres.commitTransaction"))}})},db.Postgres.prototype.rollbackTransaction=function(e){this.query({sql:"rollback",success:function(){e.success()},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.rollbackTransaction"))}})},db.Postgres.prototype.getNextId=function(e){var t=this,s=e.success;t.query({sql:"select nextval ('"+e.table+"_fid_seq') as id",success:function(e){var t=e.result.rows[0].id;s({id:t})},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.getNextId"))}})},db.Postgres.prototype.currentTimestamp=function(){return"current_timestamp at time zone 'UTC'"},db.Postgres.prototype.update=function(e){var t=this,s=t.storage;async.series([function(e){s.query({sql:"select fremove_rule from tclass_attr",success:function(t){e()},failure:function(){s.query({sql:"alter table tclass_attr add column fremove_rule varchar (128)",success:function(t){e()},failure:e})}})},function(e){s.query({sql:"select ftoc from trevision",success:function(t){e()},failure:function(){s.query({sql:"alter table trevision add column ftoc bigint",success:function(n){s.query({sql:"create index trevision_ftoc on trevision (ftoc) tablespace "+t.storage.code,success:function(t){e()},failure:e})}})}})},function(e){s.query({sql:"select count (*) as num from pg_catalog.pg_class as c\nleft join pg_catalog.pg_namespace as n on (n.oid = c.relnamespace)\nwhere c.relkind = 'i' and c.relname = 'tobject_attr_ufid' and n.nspname = '"+s.code+"'",success:function(t){t.result.rows[0].num?s.query({sql:"drop index tobject_attr_ufid",success:function(t){e()},failure:function(){e()}}):e()},failure:function(){e()}})},function(e){t.isIndexExists({index:"tobject_fstring",success:function(t){t?s.query({sql:"drop index tobject_fstring",success:function(){s.query({sql:"create index tobject_attr_fstring on tobject_attr (substr (fstring, 1, 1024))",success:function(){e()},failure:function(){e()}})},failure:function(){e()}}):e()}})},function(e){s.query({sql:"select data_type from information_schema.columns where table_catalog='"+s.code+"' and table_name='tview_attr' and column_name='forder'",success:function(t){var n=t.result.rows;n.length&&"numeric"!=n[0].data_type?s.query({sql:"alter table tview_attr alter column forder type numeric",success:function(){e()},failure:function(){e()}}):e()}})},function(e){t.updateSequences({success:function(){e()},failure:e})}],function(t,s){t?e.failure&&e.failure(new VError(t,"Postgres.update")):e.success&&e.success()})},db.Postgres.prototype.updateSequences=function(e){var t=this,s=t.storage,n=["tclass","tclass_attr","tobject","tobject_attr","tview","tview_attr","taction","trevision"];async.map(n,function(e,t){s.query({sql:"select max (fid) as max_id from "+e,success:function(n){var r,o=n.result.rows;o.length&&(r=o[0].max_id+1),(!r||r<1e3)&&(r=1e3),s.query({sql:"alter sequence "+e+"_fid_seq restart with "+r,success:function(e){t()},failure:t})},failure:t})},function(t,s){t?e.failure&&e.failure(new VError(t,"Postgres.updateSequences")):e.success&&e.success()})},db.Postgres.prototype.create=function(e){var t=this,s=t.storage,n=e.connection,r=e.cfg,o=e.success;async.series([function(e){s.query({client:t,sql:"create role "+n.dbUser+" noinherit login password '"+n.dbPassword+"'",success:function(t){e()},failure:function(t){e()}})},function(e){s.query({client:t,sql:"create tablespace "+n.dbUser+" owner "+n.dbUser+" location '"+r.path+"'",success:function(t){e()},failure:function(t){e()}})},function(e){s.query({client:t,sql:"create database "+n.db+" owner "+n.dbUser+" encoding 'utf8' tablespace "+n.dbUser,success:function(t){e()},failure:function(t){e()}})},function(e){t.disconnect(),t.connect({client:t,success:function(){e()},failure:function(t){e()}})},function(e){s.query({client:t,sql:"create schema "+n.dbUser+" authorization "+n.dbUser,success:function(t){e()},failure:function(t){e()}})},function(e){var n=dbTablesSQL;s.query({client:t,sql:n,success:function(t){e()},failure:function(t){e()}})},function(e){var n=dbIndexesSQL;s.query({client:t,sql:n,success:function(t){e()},failure:function(t){e()}})},function(e){if(t.dbEngine&&t.dbEngine.enabled){var n=dbEngineSQL;s.query({client:t,sql:n,success:function(t){e()},failure:function(t){e()}})}else e()},function(e){var n=dbDataSQL;s.query({client:t,sql:n,success:function(t){e()},failure:function(t){e()}})},function(e){t.update({success:function(){e()}})}],function(e,t){o()})},db.Postgres.prototype.remove=function(e){var t=this,s=t.storage,n=e.connection,r=(e.cfg,e.success);async.series([function(e){t.disconnect(),t.connect({success:function(){e()},failure:function(t){e()}})},function(e){s.query({client:t,sql:"drop schema "+n.dbUser+" cascade",success:function(t){e()},failure:function(t){e()}})},function(e){t.disconnect(),t.connect({systemDB:!0,success:function(){e()},failure:function(t){e()}})},function(e){s.query({client:t,sql:"drop database "+n.db,success:function(t){e()},failure:function(t){e()}})},function(e){s.query({client:t,sql:"drop tablespace "+n.dbUser,success:function(t){e()},failure:function(t){e()}})},function(e){s.query({client:t,sql:"drop role "+n.dbUser,success:function(t){e()},failure:function(t){e()}})}],function(e,t){r()})},db.Postgres.prototype.createField=function(e){var t=this.storage,s=e.toc,n=e.tocField,r=e.type,o=e.caId,i=e.success;async.series([function(o){t.query({session:e.session,sql:"alter table "+s+" add column "+n+" "+r,success:function(){o()},failure:function(e){o()}})},function(e){t.query({sql:"create index "+s+"_"+o+" on "+s+" ("+n+")",success:function(){e()},failure:function(t){e()}})}],function(e){i()})},db.Postgres.prototype.createIndex=function(e){var t=this.storage,s=e.success;t.query({session:e.session,sql:"create index "+e.table+"_"+e.field+" on "+e.table+" ("+e.field+")",success:function(){s()},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.createIndex"))}})},db.Postgres.prototype.isTableExists=function(e){var t=e.success;this.storage.query({session:e.session,sql:"select count (*) as num from pg_tables where upper (schemaname) = upper ('$schema$') and upper (tablename) = upper ('"+e.table+"')",success:function(e){var s=e.result.rows;t(s[0].num)},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.isTableExists"))}})},db.Postgres.prototype.isFieldExists=function(e){var t=e.success;this.storage.query({session:e.session,sql:"select count (*) as num from information_schema.columns where lower (table_name) = lower ('"+e.table+"') and lower (column_name) = lower ('"+e.field+"')",success:function(e){var s=e.result.rows;t(s[0].num)},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.isFieldExists"))}})},db.Postgres.prototype.isIndexExists=function(e){var t=e.success;this.storage.query({session:e.session,sql:"select count (*) as num from pg_catalog.pg_class as c\nleft join pg_catalog.pg_namespace as n on (n.oid = c.relnamespace)\nwhere c.relkind = 'i' and lower (c.relname) = lower ('"+e.index+"') and n.nspname = '"+this.storage.code+"'",success:function(e){var s=e.result.rows;t(s[0].num)},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.isIndexExists"))}})},db.MSSQL=function(e){var t=this;t.storage=e,t.database="mssql",t.host=e.connection.host,t.port=e.connection.port,t.db=e.connection.db,t.dbUser=e.connection.dbUser,t.dbPassword=e.connection.dbPassword,t.dbaUser=e.connection.dbaUser,t.dbaPassword=e.connection.dbaPassword,t.connection="Driver={SQL Server};Server="+t.host+";Uid="+t.dbUser+";Pwd="+t.dbPassword+";Database="+t.db+";",t.adminConnection="Driver={SQL Server};Server="+t.host+";Uid="+t.dbaUser+";Pwd="+t.dbaPassword+";Database=master;",t.tags={schema:"",schema_prefix:"",tablespace:"",tid:"bigint",tid_object_attr:"bigint identity (1000, 1)",tnumber:"bigint",tnumber_value:"numeric",ttext:"nvarchar (max)",ttimestamp:"datetime",tstring:"nvarchar (450)",tstring_value:"nvarchar (max)",tocObjectId:"fobject_id bigint primary key clustered",tobject_attr_fstring:"fstring"}},db.MSSQL.prototype.connect=function(e){var t=this;sql.open(e.systemDB?t.adminConnection:t.connection,function(s,n){s?(common.log({file:config.rootDir+"/error.log",text:util.inspect(s)}),e.failure&&e.failure({error:s})):(t.client=n,t.connected=!0,n.query("set language english",function(t,s){n.query("set dateformat dmy",function(t,s){e.success&&e.success()})}))})},db.MSSQL.prototype.disconnect=function(e){this.client.close()},db.MSSQL.prototype.query=function(e){function t(e){var t,n=[];if(e.params)for(var r=0;r<e.params.length;r++){var o=e.params[r];""===o&&(o=null),null==o?e.sql=e.sql.replace("$"+(r+1),"null"):(e.sql=e.sql.replace("$"+(r+1),"?"),n.push(o))}s.n=s.n||1;var i=s.n;s.queue=s.queue||{},s.queue[i]=e.sql;var a=function(t,n){delete s.queue[i],t?e.failure&&e.failure({error:t+" "+n}):e.success&&(e.options.result={rows:n},e.success(e.options))};t=n.length?s.client.query(e.sql,n,a):s.client.query(e.sql,a)}var s=this;e.options=e.options||{};var n=e;s.connected?t(n):s.connect({success:function(){t(n)},failure:function(e){n.failure(e)}})},db.MSSQL.prototype.startTransaction=function(e){var t=e;this.query({sql:"begin transaction",success:function(){t.success()},failure:function(e){t.failure(e)}})},db.MSSQL.prototype.commitTransaction=function(e){var t=e;this.query({sql:"commit transaction",success:function(){t.success()},failure:function(e){t.failure(e)}})},db.MSSQL.prototype.rollbackTransaction=function(e){var t=e;this.query({sql:"rollback transaction",success:function(){t.success()},failure:function(e){t.failure(e)}})},db.MSSQL.prototype.getNextId=function(e){var t=this,s=e.success,n=(e.session,t.storage),r=e.table;n.redisClient.hincrby("mssql_sequences",n.code+"_"+r,1,function(e,t){s({id:t})})},db.MSSQL.prototype.currentTimestamp=function(){return"getutcdate ()"},db.MSSQL.prototype.update=function(e){var t=this,s=t.storage;async.series([function(e){s.query({sql:"drop index tobject_attr_ufid",success:function(t){e()},failure:function(){e()}})},function(e){s.query({sql:"select fremove_rule from tclass_attr",success:function(t){e()},failure:function(){s.query({sql:"alter table tclass_attr add column fremove_rule varchar (128)",success:function(t){e()}})}})},function(e){s.query({sql:"select ftoc from trevision",success:function(t){e()},failure:function(){s.query({sql:"alter table trevision add column ftoc bigint",success:function(t){s.query({sql:"create index trevision_ftoc on trevision (ftoc)",success:function(t){e()}})}})}})},function(e){t.updateSequences({success:function(){e()}})}],function(t,s){e.success&&e.success()})},db.MSSQL.prototype.updateSequences=function(e){var t=this,s=t.storage,n=["trevision","tclass","tclass_attr","tview","tview_attr","tobject","tobject_attr","taction","taction_attr"];async.map(n,function(e,t){s.query({sql:"select max (fid) as maxid from "+e,success:function(n){var r=1e3;n.result.rows[0].maxid&&(r=n.result.rows[0].maxid),r<1e3&&(r=1e3),s.redisClient.hset("mssql_sequences",s.code+"_"+e,r),common.log({file:config.rootDir+"/query.log",text:"sequence: "+s.code+"_"+e+" = "+r}),t()},failure:function(){t()}})},function(t,s){e.success()})},db.MSSQL.prototype.create=function(e){var t=this,s=t.storage,n=e.connection,r=e.cfg,o=e.success;async.series([function(e){s.query({sql:"create database "+n.dbUser+" on (\n    name="+n.dbUser+"_dat,\n    filename='"+r.path+"\\"+n.dbUser+".mdf',\n    size=10MB,\n    filegrowth=5MB\n) log on (\n    name="+n.dbUser+"_log,\n    filename='"+r.path+"\\"+n.dbUser+".ldf',\n    size=5MB,\n    filegrowth=5MB\n);\n",success:function(t){e()},failure:function(t){e()}})},function(e){s.query({sql:"create login "+n.dbUser+" with password = '"+n.dbPassword+"'",success:function(t){e()},failure:function(t){e()}})},function(e){s.query({sql:"use "+n.dbUser,success:function(t){e()},failure:function(t){e()}})},function(e){s.query({sql:"create user "+n.dbUser+" for login "+n.dbUser,success:function(t){e()},failure:function(t){e()}})},function(e){s.query({sql:"exec sp_addrolemember 'db_owner', '"+n.dbUser+"'",success:function(t){e()},failure:function(t){e()}})},function(e){s.query({sql:dbTablesSQL,success:function(t){e()},failure:function(t){e()}})},function(e){var t=dbIndexesSQL;t=t.replace("create index tobject_fstring on $schema_prefix$tobject_attr (fstring)","create index tobject_fstring on $schema_prefix$tobject_attr (fid) include (fstring)"),
s.query({sql:t,success:function(t){e()},failure:function(t){e()}})},function(e){t.disconnect(),t.connect({success:function(){e()},failure:function(){e()}})},function(e){t.update({success:function(){e()},failure:function(){e()}})},function(e){var t=dbDataSQL;async.map(t,function(e,t){s.query({sql:e,success:function(e){t()},failure:function(e){t()}})},function(t,s){e()})}],function(e,t){o()})},db.MSSQL.prototype.remove=function(e){var t=this,s=t.storage,n=e.connection,r=(e.cfg,e.success);s.query({sql:"drop database "+n.dbUser,success:function(e){s.query({sql:"drop login "+n.dbUser,success:function(e){r()},failure:function(e){r()}})},failure:function(e){r()}})},db.MSSQL.prototype.createField=function(e){var t=this.storage,s=e.toc,n=e.tocField,r=e.type,o=e.caId,i=e.success;t.query({sql:"alter table "+s+" add "+n+" "+r,success:function(){"$ttext$"!=r?t.query({session:e.session,sql:"create index "+s+"_"+o+" on "+s+" ("+n+")",success:function(){i()}}):t.query({session:e.session,sql:"create index "+s+"_"+o+" on "+s+" (fobject_id) include ("+n+")",success:function(){i()}})}})},db.MSSQL.prototype.createIndex=function(e){var t=this.storage,s=e.success;t.query({session:e.session,sql:"create index "+e.table+"_"+e.field+" on "+e.table+" ("+e.field+")",success:function(){s()}})},db.MSSQL.prototype.isTableExists=function(e){var t=this.storage,s=e.success;t.query({session:e.session,sql:"select count (*) as num from INFORMATION_SCHEMA.TABLES where upper (TABLE_NAME) = upper ('"+e.table+"')",success:function(e){var t=e.result.rows;s(t[0].num)}})};var dbTablesSQL="create table $schema_prefix$tschema (\r\n\tfid $tid$ not null,\r\n\tfparent_id $tnumber$,\r\n\tfname $ttext$,\r\n\tfcode $ttext$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$trevision (\r\n\tfid $tid$ not null,\r\n\tfsubject_id $tnumber$,\r\n\tfdate $ttimestamp$,\r\n\tfdescription $ttext$,\r\n\tfremote_addr $ttext$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$,\r\n\tftoc $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$tview (\r\n\tfid $tid$ not null,\r\n\tfparent_id $tnumber$,\r\n\tfname $tstring$,\r\n\tfcode $tstring$,\r\n\tfdescription $ttext$,\r\n\tflayout $ttext$,\r\n\tfkey $tstring$,\r\n\tfparent_key $tstring$,\r\n\tfclass_id $tnumber$,\r\n\tfunrelated $tstring$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tfquery $ttext$,\r\n\tftype $tnumber$,\r\n\tfmaterialized $tnumber$ default 0,\r\n\tfsystem $tnumber$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$,\r\n\tforder $tnumber_value$,\r\n\tficon_cls $tstring$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$tview_attr (\r\n\tfid $tid$ not null,\r\n\tfview_id $tnumber$,\r\n\tfname $tstring$,\r\n\tfcode $tstring$,\r\n\tfdescription $ttext$,\r\n\tfclass_id $tnumber$,\r\n\tfclass_attr_id $tnumber$,\r\n\tfsubject_id $tnumber$,\r\n\tforder $tnumber_value$,\r\n\tfsort_kind $tnumber$,\r\n\tfsort_order $tnumber$,\r\n\tfoperation $tnumber$,\r\n\tfvalue $ttext$,\r\n\tfarea $tnumber$,\r\n\tfcolumn_width $tnumber$,\r\n\tftotal_type $tnumber$,\r\n\tfread_only $tnumber$,\r\n\tfgroup $tnumber$,\r\n\tfnot_null $tnumber$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$taction (\r\n\tfid $tid$ not null,\r\n\tfclass_id $tnumber$,\r\n\tfname $tstring$,\r\n\tfcode $tstring$,\r\n\tfdescription $ttext$,\r\n\tforder $tnumber_value$,\r\n\tfbody $ttext$,\r\n\tfconfirm $tnumber$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tflayout $ttext$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$taction_attr (\r\n\tfid $tid$ not null,\r\n\tfaction_id $tnumber$,\r\n\tftype_id $tnumber$,\r\n\tfname $tstring$,\r\n\tfcode $tstring$,\r\n\tfdescription $ttext$,\r\n\tforder $tnumber_value$,\r\n\tfnot_null $tnumber$,\r\n\tfvalid_func $ttext$,\r\n\tfkind $tnumber$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$tclass (\r\n\tfid $tid$ not null,\r\n\tfparent_id $tnumber$,\r\n\tfname $tstring$,\r\n\tfcode $tstring$,\r\n\tfdescription $ttext$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tfformat $ttext$,\r\n\tfview_id $tnumber$,\r\n\tfsystem $tnumber$,\r\n\tftype $tnumber$,\r\n\tfkind $tnumber$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$tclass_attr (\r\n\tfid $tid$ not null,\r\n\tfclass_id $tnumber$,\r\n\tfname $tstring$,\r\n\tfcode $tstring$,\r\n\tfdescription $ttext$,\r\n\tftype_id $tnumber$,\r\n\tforder $tnumber_value$,\r\n\tfnot_null $tnumber$,\r\n\tfsecure $tnumber$,\r\n\tfmax_str $tnumber$,\r\n\tfmin_str $tnumber$,\r\n\tfmax_number $tnumber$,\r\n\tfmin_number $tnumber$,\r\n\tfmax_ts $tnumber$,\r\n\tfmin_ts $tnumber$,\r\n\tfunique $tnumber$,\r\n\tfvalid_func $ttext$,\r\n\tfformat_func $ttext$,\r\n\tfformat_number $tstring$,\r\n\tfformat_ts $tstring$,\r\n\tfremove_rule $tstring$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$tobject (\r\n\tfid $tid$ not null,\r\n\tfclass_id $tnumber$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$tobject_attr (\r\n\tfid $tid_object_attr$ not null,\r\n\tfobject_id $tnumber$,\r\n\tfclass_attr_id $tnumber$,\r\n\tfstring $tstring_value$,\r\n\tfnumber $tnumber_value$,\r\n\tftime $ttimestamp$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$tmail (\r\n\tfid $tid$ not null,\r\n\tfrecipients $ttext$,\r\n\tfmessage $ttext$,\r\n\tfcreation_date $ttimestamp$,\r\n\tfsending_date $ttimestamp$\r\n) $tablespace$;\r\n",dbIndexesSQL="create unique index tschema_fid on $schema_prefix$tschema (fid) $tablespace$;\r\n\r\ncreate index trevision_fdate on $schema_prefix$trevision (fdate) $tablespace$;\r\ncreate unique index trevision_fid on $schema_prefix$trevision (fid) $tablespace$;\r\ncreate index trevision_fschema_id on $schema_prefix$trevision (fschema_id) $tablespace$;\r\ncreate index trevision_frecord_id on $schema_prefix$trevision (frecord_id) $tablespace$;\r\ncreate index trevision_ftoc on $schema_prefix$trevision (ftoc) $tablespace$;\r\n\r\ncreate index tview_ftype on $schema_prefix$tview (ftype) $tablespace$;\r\ncreate index tview_fid on $schema_prefix$tview (fid) $tablespace$;\r\ncreate index tview_fcode on $schema_prefix$tview (fcode);\r\ncreate index tview_fend_id on $schema_prefix$tview (fend_id) $tablespace$;\r\ncreate unique index tview_ufid on $schema_prefix$tview (fid,fstart_id,fend_id) $tablespace$;\r\ncreate index tview_fname on $schema_prefix$tview (fname);\r\ncreate index tview_fparent_id on $schema_prefix$tview (fparent_id) $tablespace$;\r\ncreate index tview_fsystem on $schema_prefix$tview (fsystem) $tablespace$;\r\ncreate index tview_fstart_id on $schema_prefix$tview (fstart_id) $tablespace$;\r\ncreate index tview_fclass_id on $schema_prefix$tview (fclass_id) $tablespace$;\r\ncreate index tview_fschema_id on $schema_prefix$tview (fschema_id) $tablespace$;\r\ncreate index tview_frecord_id on $schema_prefix$tview (frecord_id) $tablespace$;\r\n\r\ncreate index tview_attr_fid on $schema_prefix$tview_attr (fid) $tablespace$;\r\ncreate index tview_attr_fclass_id on $schema_prefix$tview_attr (fclass_id) $tablespace$;\r\ncreate index tview_attr_fclass_attr_id on $schema_prefix$tview_attr (fclass_attr_id) $tablespace$;\r\ncreate index tview_attr_fcode on $schema_prefix$tview_attr (fcode) $tablespace$;\r\ncreate unique index tview_attr_ufid on $schema_prefix$tview_attr (fid,fstart_id,fend_id) $tablespace$;\r\ncreate index tview_attr_fname on $schema_prefix$tview_attr (fname) $tablespace$;\r\ncreate index tview_attr_fview_id on $schema_prefix$tview_attr (fview_id) $tablespace$;\r\ncreate index tview_attr_fsubject_id on $schema_prefix$tview_attr (fsubject_id) $tablespace$;\r\ncreate index tview_attr_fstart_id on $schema_prefix$tview_attr (fstart_id) $tablespace$;\r\ncreate index tview_attr_fend_id on $schema_prefix$tview_attr (fend_id) $tablespace$;\r\ncreate index tview_attr_farea on $schema_prefix$tview_attr (farea) $tablespace$;\r\ncreate index tview_attr_fschema_id on $schema_prefix$tview_attr (fschema_id) $tablespace$;\r\ncreate index tview_attr_frecord_id on $schema_prefix$tview_attr (frecord_id) $tablespace$;\r\n\r\ncreate index taction_fid on $schema_prefix$taction (fid) $tablespace$;\r\ncreate index taction_fclass_id on $schema_prefix$taction (fclass_id) $tablespace$;\r\ncreate index taction_fcode on $schema_prefix$taction (fcode);\r\ncreate index taction_fend_id on $schema_prefix$taction (fend_id) $tablespace$;\r\ncreate unique index taction_ufid on $schema_prefix$taction (fid,fstart_id,fend_id) $tablespace$;\r\ncreate index taction_fname on $schema_prefix$taction (fname);\r\ncreate index taction_fstart_id on $schema_prefix$taction (fstart_id) $tablespace$;\r\ncreate index taction_fschema_id on $schema_prefix$taction (fschema_id) $tablespace$;\r\ncreate index taction_frecord_id on $schema_prefix$taction (frecord_id) $tablespace$;\r\n\r\ncreate index taction_attr_fid on $schema_prefix$taction_attr (fid) $tablespace$;\r\ncreate index taction_attr_faction_id on $schema_prefix$taction_attr (faction_id) $tablespace$;\r\ncreate index taction_attr_fcode on $schema_prefix$taction_attr (fcode);\r\ncreate index taction_attr_fend_id on $schema_prefix$taction_attr (fend_id) $tablespace$;\r\ncreate unique index taction_attr_ufid on $schema_prefix$taction_attr (fid,fstart_id,fend_id) $tablespace$;\r\ncreate index taction_attr_fname on $schema_prefix$taction_attr (fname);\r\ncreate index taction_attr_fstart_id on $schema_prefix$taction_attr (fstart_id) $tablespace$;\r\ncreate index taction_attr_fschema_id on $schema_prefix$taction_attr (fschema_id) $tablespace$;\r\ncreate index taction_attr_frecord_id on $schema_prefix$taction_attr (frecord_id) $tablespace$;\r\n\r\ncreate index tclass_fid on $schema_prefix$tclass (fid) $tablespace$;\r\ncreate index tclass_fcode on $schema_prefix$tclass (fcode);\r\ncreate index tclass_fend_id on $schema_prefix$tclass (fend_id) $tablespace$;\r\ncreate index tclass_fname on $schema_prefix$tclass (fname);\r\ncreate index tclass_fparent_id on $schema_prefix$tclass (fparent_id) $tablespace$;\r\ncreate index tclass_fsystem on $schema_prefix$tclass (fsystem) $tablespace$;\r\ncreate index tclass_ftype on $schema_prefix$tclass (ftype) $tablespace$;\r\ncreate index tclass_fkind on $schema_prefix$tclass (fkind) $tablespace$;\r\ncreate index tclass_fstart_id on $schema_prefix$tclass (fstart_id) $tablespace$;\r\ncreate index tclass_fview_id on $schema_prefix$tclass (fview_id) $tablespace$;\r\ncreate index tclass_fschema_id on $schema_prefix$tclass (fschema_id) $tablespace$;\r\ncreate index tclass_frecord_id on $schema_prefix$tclass (frecord_id) $tablespace$;\r\n\r\ncreate index tclass_attr_fid on $schema_prefix$tclass_attr (fid) $tablespace$;\r\ncreate index tclass_attr_fclass_id on $schema_prefix$tclass_attr (fclass_id) $tablespace$;\r\ncreate index tclass_attr_fcode on $schema_prefix$tclass_attr (fcode);\r\ncreate index tclass_attr_fend_id on $schema_prefix$tclass_attr (fend_id) $tablespace$;\r\ncreate index tclass_attr_fname on $schema_prefix$tclass_attr (fname);\r\ncreate index tclass_attr_fstart_id on $schema_prefix$tclass_attr (fstart_id) $tablespace$;\r\ncreate index tclass_attr_ftype_id on $schema_prefix$tclass_attr (ftype_id) $tablespace$;\r\ncreate index tclass_attr_fschema_id on $schema_prefix$tclass_attr (fschema_id) $tablespace$;\r\ncreate index tclass_attr_frecord_id on $schema_prefix$tclass_attr (frecord_id) $tablespace$;\r\n\r\ncreate index tobject_fid on $schema_prefix$tobject (fid) $tablespace$;\r\ncreate index tobject_fclass_id on $schema_prefix$tobject (fclass_id) $tablespace$;\r\ncreate index tobject_fend_id on $schema_prefix$tobject (fend_id) $tablespace$;\r\ncreate unique index tobject_ufid on $schema_prefix$tobject (fid,fstart_id,fend_id) $tablespace$;\r\ncreate index tobject_fstart_id on $schema_prefix$tobject (fstart_id) $tablespace$;\r\ncreate index tobject_fschema_id on $schema_prefix$tobject (fschema_id) $tablespace$;\r\ncreate index tobject_frecord_id on $schema_prefix$tobject (frecord_id) $tablespace$;\r\n\r\ncreate index tobject_attr_fid on $schema_prefix$tobject_attr (fid) $tablespace$;\r\ncreate index tobject_attr_fclass_attr_id on $schema_prefix$tobject_attr (fclass_attr_id) $tablespace$;\r\ncreate index tobject_attr_fend_id on $schema_prefix$tobject_attr (fend_id) $tablespace$;\r\ncreate index tobject_attr_fnumber on $schema_prefix$tobject_attr (fnumber) $tablespace$;\r\ncreate index tobject_attr_fobject_id on $schema_prefix$tobject_attr (fobject_id) $tablespace$;\r\ncreate index tobject_attr_ftime on $schema_prefix$tobject_attr (ftime) $tablespace$;\r\ncreate index tobject_attr_fstart_id on $schema_prefix$tobject_attr (fstart_id) $tablespace$;\r\ncreate index tobject_attr_fstring on $schema_prefix$tobject_attr ($tobject_attr_fstring$);\r\ncreate index tobject_attr_fschema_id on $schema_prefix$tobject_attr (fschema_id) $tablespace$;\r\ncreate index tobject_attr_frecord_id on $schema_prefix$tobject_attr (frecord_id) $tablespace$;\r\n\r\ncreate unique index tmail_fid on $schema_prefix$tmail (fid) $tablespace$;\r\n",dbDataSQL="insert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (1, null, '', 'String', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (2, null, '', 'Number', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (3, null, '', 'Date', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (4, null, '', 'Boolean', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (5, null, '', 'File', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (6, null, '', 'Class', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (7, null, ' ', 'ClassAttr', '', 1, 2147483647, '', 1867, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (8, null, '', 'View', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (9, null, ' ', 'ViewAttr', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (10, null, '', 'Action', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (11, null, ' ', 'ActionAttr', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (12, null, '', 'Object', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (13, null, ' ', 'ObjectAttr', '', 1, 2147483647, '', null, 1, 0, null);\r\n",dbEngineSQL="create table $schema_prefix$_class (\n\tfid $tid$ not null,\n\tfparent_id $tnumber$,\n\tfname $tstring$,\n\tfcode $tstring$ not null,\n\tfdescription $ttext$,\n\tfformat $ttext$,\n\tfview_id $tnumber$,\n\tfstart_id $tnumber$\n) $tablespace$;\n\ncreate table $schema_prefix$_class_attr (\n\tfid $tid$ not null,\n\tfclass_id $tnumber$ not null,\n\tfclass_code $tstring$ not null,\n\tfname $tstring$,\n\tfcode $tstring$ not null,\n\tfdescription $ttext$,\n\tftype_id $tnumber$ not null,\n\tfnot_null $tnumber$,\n\tfsecure $tnumber$,\n\tfunique $tnumber$,\n\tfremove_rule $tstring$,\n\tfstart_id $tnumber$\n) $tablespace$;\n\ncreate table $schema_prefix$_view (\n\tfid $tid$ not null,\n\tfparent_id $tnumber$,\n\tfname $tstring$,\n\tfcode $tstring$ not null,\n\tfdescription $ttext$,\n\tflayout $ttext$,\n\tfquery $ttext$,\n\tfstart_id $tnumber$\n) $tablespace$;\n\ncreate table $schema_prefix$_object (\n\tfid $tid$ not null,\n\tfstart_id $tnumber$\n) $tablespace$;\n\nalter table $schema_prefix$_class add primary key (fid);\nalter table $schema_prefix$_class_attr add primary key (fid);\nalter table $schema_prefix$_view add primary key (fid);\nalter table $schema_prefix$_object add primary key (fid);\n\ncreate unique index _class_fcode on $schema_prefix$_class (fparent_id, fcode) $tablespace$;\ncreate unique index _class_fcode_null on $schema_prefix$_class (fcode) $tablespace$ where fparent_id is null;\ncreate unique index _class_attr_fcode on $schema_prefix$_class_attr (fclass_id, fcode) $tablespace$;\ncreate unique index _view_fcode on $schema_prefix$_view (fparent_id, fcode) $tablespace$;\ncreate unique index _view_fcode_null on $schema_prefix$_view (fcode) $tablespace$ where fparent_id is null;\n\n-- tclass after insert\ncreate function trigger_tclass_after_insert () returns trigger as\n$$\ndeclare\n\ttableName varchar (256);\n\tclassCode varchar (256);\n\tparentId int;\nbegin\n\tif (NEW.fend_id = 2147483647) then\n\t\ttableName = NEW.fcode || '_' || NEW.fid;\n\t\tselect fcode, fparent_id into classCode, parentId from _class where fid = NEW.fid;\n\t\tif (classCode is null) then\n\t\t\tif (NEW.fid >= 1000) then\n\t\t\t\tbegin\n\t\t\t\t\texecute 'create table ' || tableName || '(fobject_id bigint)';\n\t\t\t\t\texecute 'alter table ' || tableName || ' add primary key (fobject_id)';\n\t\t\t\texception when others then\n\t\t\t\tend;\n\t\t\tend if;\n\t\t\tinsert into _class (\n\t\t\t\tfid, fparent_id, fname, fcode, fdescription, fformat, fview_id, fstart_id\n\t\t\t) values (\n\t\t\t\tNEW.fid, NEW.fparent_id, NEW.fname, NEW.fcode, NEW.fdescription, NEW.fformat, NEW.fview_id, NEW.fstart_id\n\t\t\t);\n\t\telse\n\t\t\tif (classCode <> NEW.fcode) then\n\t\t\t\traise exception 'You can''t change: code';\n\t\t\tend if;\n\t\t\tif (parentId <> NEW.fparent_id) then\n\t\t\t\traise exception 'You can''t change: parent_id';\n\t\t\tend if;\n\t\t\tupdate _class set\n\t\t\t\tfparent_id = NEW.fparent_id,\n\t\t\t\tfname = NEW.fname,\n\t\t\t\tfcode = NEW.fcode,\n\t\t\t\tfdescription = NEW.fdescription,\n\t\t\t\tfformat = NEW.fformat,\n\t\t\t\tfview_id = NEW.fview_id,\n\t\t\t\tfstart_id = NEW.fstart_id\n\t\t\twhere\n\t\t\t\tfid = NEW.fid;\n\t\tend if;\n\tend if;\n\treturn NEW;\nend; \n$$ language plpgsql;\n\ncreate trigger tclass_after_insert\nafter insert on tclass for each row \nexecute procedure trigger_tclass_after_insert ();\n\n-- tclass after update\ncreate function trigger_tclass_after_update () returns trigger as\n$$\ndeclare\n\tstartId int;\nbegin\n\tselect fstart_id into startId from _class where fid = NEW.fid;\n\tif (NEW.fstart_id = startId) then\n\t\texecute 'delete from _class where fid = ' || NEW.fid;\n\t\tif (NEW.fid >= 1000) then\n\t\t\texecute 'drop table ' || NEW.fcode || '_' || NEW.fid;\n\t\tend if;\n\tend if;\n\treturn NEW;\nend; \n$$ language plpgsql;\n\ncreate trigger tclass_after_update\nafter update on tclass for each row \nexecute procedure trigger_tclass_after_update ();\n\n-- tclass_attr after insert\ncreate function trigger_tclass_attr_after_insert () returns trigger as\n$$\ndeclare\n\tclassCode varchar (256);\n\ttableName varchar (256);\n\tcolumnName varchar (256);\n\tcolumnType varchar (64);\n\tcaCode varchar (256);\n\tcaClassId int;\n\tcaTypeId int;\n\tcaUnique int;\nbegin\n\tselect fcode into classCode from _class where fid = NEW.fclass_id;\n\tif (classCode is not null and NEW.fend_id = 2147483647) then\n\t\tselect fcode, fclass_id, ftype_id, funique into caCode, caClassId, caTypeId, caUnique from _class_attr where fid = NEW.fid;\n\t\tcolumnName = NEW.fcode || '_' || NEW.fid;\n\t\ttableName = classCode || '_' || NEW.fclass_id;\n\t\tif (caCode is null) then\n\t\t\t-- Column type\n\t\t\tcolumnType = 'bigint';\n\t\t\tif (NEW.ftype_id = 3) then\n\t\t\t\tcolumnType = 'timestamp (6)';\n\t\t\tend if;\n\t\t\tif (NEW.ftype_id = 2) then\n\t\t\t\tcolumnType = 'numeric';\n\t\t\tend if;\n\t\t\tif (NEW.ftype_id = 1 or NEW.ftype_id = 5) then\n\t\t\t\tcolumnType = 'text';\n\t\t\tend if;\n\t\t\texecute 'alter table ' || tableName || ' add column ' || columnName || ' ' || columnType;\n\t\t\tinsert into _class_attr (\n\t\t\t\tfid, fclass_id, fclass_code, fname, fcode, fdescription, ftype_id, fnot_null, fsecure, funique, fremove_rule, fstart_id\n\t\t\t) values (\n\t\t\t\tNEW.fid, NEW.fclass_id, classCode, NEW.fname, NEW.fcode, NEW.fdescription, NEW.ftype_id, NEW.fnot_null, NEW.fsecure, NEW.funique, NEW.fremove_rule, NEW.fstart_id\n\t\t\t);\n\t\t\t-- Unique\n\t\t\t--if (NEW.funique is not null and NEW.funique = 1) then\n\t\t\t--\texecute 'create unique index ' || tableName || '_' || columnName || '_unique on ' || tableName || ' (' || columnName || ')';\n\t\t\t--end if;\n\t\t\t-- Index\n\t\t\tif (NEW.ftype_id = 12 or NEW.ftype_id >= 1000 or position ('\"index\"' in NEW.fformat_func) > 0) then\n\t\t\t\t-- if (NEW.ftype_id = 1) then\n\t\t\t\t-- \texecute 'create index ' || tableName || '_' || columnName || ' on ' || tableName || ' (' || columnName || ') (substr (' || columnName || ', 1, 1024))';\n\t\t\t\t-- else\n\t\t\t\t\texecute 'create index ' || tableName || '_' || columnName || ' on ' || tableName || ' (' || columnName || ')';\n\t\t\t\t-- end if;\n\t\t\tend if;\n\t\telse\n\t\t\tif (caCode <> NEW.fcode) then\n\t\t\t\traise exception 'You can''t change: code' using message = 'You can''t change: code - ' || caCode || ',' || NEW.fcode;\n\t\t\tend if;\n\t\t\tif (caClassId <> NEW.fclass_id) then\n\t\t\t\traise exception 'You can''t change: class_id' using message = 'You can''t change: class_id - ' || caClassId || ',' || NEW.fclass_id;\n\t\t\tend if;\n\t\t\tif (caTypeId <> NEW.ftype_id) then\n\t\t\t\traise exception 'You can''t change: type_id' using message = 'You can''t change: type_id - ' || caTypeId || ',' || NEW.ftype_id;\n\t\t\tend if;\n\t\t\tif (caUnique <> NEW.funique) then\n\t\t\t\traise exception 'You can''t change: unique' using message = 'You can''t change: unique';\n\t\t\tend if;\n\t\t\tupdate _class_attr set\n\t\t\t\tfname = NEW.fname,\n\t\t\t\tfcode = NEW.fcode,\n\t\t\t\tfclass_id = NEW.fclass_id,\n\t\t\t\tfclass_code = classCode,\n\t\t\t\tftype_id = NEW.ftype_id,\n\t\t\t\tfdescription = NEW.fdescription,\n\t\t\t\tfnot_null = NEW.fnot_null,\n\t\t\t\tfsecure = NEW.fsecure,\n\t\t\t\tfremove_rule = NEW.fremove_rule,\n\t\t\t\tfstart_id = NEW.fstart_id\n\t\t\twhere\n\t\t\t\tfid = NEW.fid;\n\t\tend if;\n\tend if;\n\treturn NEW;\nend; \n$$ language plpgsql;\n\ncreate trigger tclass_attr_after_insert\nafter insert on tclass_attr for each row \nexecute procedure trigger_tclass_attr_after_insert ();\n\n-- tclass_attr after update\ncreate function trigger_tclass_attr_after_update () returns trigger as\n$$\ndeclare\n\tstartId int;\n\tclassCode varchar (256);\nbegin\n\tselect fstart_id, fclass_code into startId, classCode from _class_attr where fid = NEW.fid;\n\tif (NEW.fstart_id = startId) then\n\t\texecute 'delete from _class_attr where fid = ' || NEW.fid;\n\t\texecute 'alter table ' || classCode || '_' || NEW.fclass_id || ' drop column ' || NEW.fcode || '_' || NEW.fid || ' cascade';\n\tend if;\n\treturn NEW;\nend; \n$$ language plpgsql;\n\ncreate trigger tclass_attr_after_update\nafter update on tclass_attr for each row \nexecute procedure trigger_tclass_attr_after_update ();\n\n-- tview after insert\ncreate function trigger_tview_after_insert () returns trigger as\n$$\ndeclare\n\tviewCode varchar (256);\nbegin\n\tselect fcode into viewCode from _view where fid = NEW.fid;\n\tif (NEW.fsystem is null and NEW.fend_id = 2147483647) then\n\t\tif (viewCode is null) then\n\t\t\tinsert into _view (\n\t\t\t\tfid, fparent_id, fname, fcode, fdescription, flayout, fquery, fstart_id\n\t\t\t) values (\n\t\t\t\tNEW.fid, NEW.fparent_id, NEW.fname, NEW.fcode, NEW.fdescription, NEW.flayout, NEW.fquery, NEW.fstart_id\n\t\t\t);\n\t\telse\n\t\t\tupdate _view set\n\t\t\t\tfparent_id = NEW.fparent_id,\n\t\t\t\tfname = NEW.fname,\n\t\t\t\tfcode = NEW.fcode,\n\t\t\t\tfdescription = NEW.fdescription,\n\t\t\t\tflayout = NEW.flayout,\n\t\t\t\tfquery = NEW.fquery,\n\t\t\t\tfstart_id = NEW.fstart_id\n\t\t\twhere\n\t\t\t\tfid = NEW.fid;\n\t\tend if;\n\tend if;\n\treturn NEW;\nend; \n$$ language plpgsql;\n\ncreate trigger tview_after_insert\nafter insert on tview for each row \nexecute procedure trigger_tview_after_insert ();\n\n-- tview after update\ncreate function trigger_tview_after_update () returns trigger as\n$$\ndeclare\n\tstartId int;\nbegin\n\tselect fstart_id into startId from _view where fid = NEW.fid;\n\tif (NEW.fsystem is null and startId is not null and NEW.fstart_id = startId) then\n\t\texecute 'delete from _view where fid = ' || NEW.fid;\n\tend if;\n\treturn NEW;\nend; \n$$ language plpgsql;\n\ncreate trigger tview_after_update\nafter update on tview for each row \nexecute procedure trigger_tview_after_update ();\n\n-- tobject after insert\ncreate function trigger_tobject_after_insert () returns trigger as\n$$\ndeclare\n\tclassCode varchar (256);\n\tid int;\n\tstartId int;\n\tclassId int;\n\tparentId int;\nbegin\n\tif (NEW.fend_id = 2147483647) then\n\t\tid = NEW.fid;\n\t\tclassId = NEW.fclass_id;\n\t\tstartId = NEW.fstart_id;\n\t\tselect fcode, fparent_id into classCode, parentId from _class where fid = classId;\n\t\tif (classCode is not null) then\n\t\t\tinsert into _object (\n\t\t\t\tfid, fstart_id\n\t\t\t) values (\n\t\t\t\tid, startId\n\t\t\t);\n\t\tend if;\n\t\tloop\n\t\t\tif (classCode is not null) then\n\t\t\t\texecute 'insert into ' || classCode || '_' || classId || ' (fobject_id) values (' || id || ')';\n\t\t\tend if;\n\t\t    if (parentId is null) then\n\t\t        exit;\n\t\t    else\n\t\t    \tclassId = parentId;\n\t\t\t\tselect fcode, fparent_id into classCode, parentId from _class where fid = classId;\n\t\t    end if;\n\t\tend loop;\n\tend if;\n\treturn NEW;\nend; \n$$ language plpgsql;\n\ncreate trigger tobject_after_insert\nafter insert on tobject for each row \nexecute procedure trigger_tobject_after_insert ();\n\n-- tobject after update\ncreate function trigger_tobject_after_update () returns trigger as\n$$\ndeclare\n\tstartId int;\n\tclassCode varchar (256);\nbegin\n\tselect fstart_id into startId from _object where fid = NEW.fid;\n\tif (NEW.fstart_id = startId) then\n\t\t-- todo delete from parent classes\n\t\texecute 'delete from _object where fid = ' || NEW.fid;\n\t\tselect fcode into classCode from _class where fid = NEW.fclass_id;\n\t\texecute 'delete from ' || classCode || '_' || NEW.fclass_id || ' where fobject_id = ' || NEW.fid;\n\tend if;\n\treturn NEW;\nend; \n$$ language plpgsql;\n\ncreate trigger tobject_after_update\nafter update on tobject for each row \nexecute procedure trigger_tobject_after_update ();\n\n-- tobject_attr after insert\ncreate function trigger_tobject_attr_after_insert () returns trigger as\n$$\ndeclare\n\tclassCode varchar (256);\n\tclassId int;\n\tcaCode varchar (256);\n\tvalue text;\nbegin\n\tselect fclass_code, fclass_id, fcode into classCode, classId, caCode from _class_attr where fid = NEW.fclass_attr_id;\n\tif (classCode is not null) then\n\t\tvalue = 'null';\n\t\tif (NEW.fstring is not null) then\n\t\t\tvalue = '''' || replace (NEW.fstring, '''', '''''') || '''';\n\t\tend if;\n\t\tif (NEW.ftime is not null) then\n\t\t\tvalue = '''' || to_char (NEW.ftime, 'DD.MM.YYYY HH24:MI:SS.MS') || '''';\n\t\tend if;\n\t\tif (NEW.fnumber is not null) then\n\t\t\tvalue = '''' || NEW.fnumber::text || '''';\n\t\tend if;\n\t\tbegin\n\t\t\texecute 'update ' || classCode || '_' || classId || ' set ' || caCode || '_' || NEW.fclass_attr_id || ' = ' || value || ' where fobject_id = ' || NEW.fobject_id;\n\t\texception when others then\n\t\tend;\n\tend if;\n\treturn NEW;\nend; \n$$ language plpgsql;\n\n-- enable/disable while storage-import\n--create trigger tobject_attr_after_insert\n--after insert on tobject_attr for each row \n--execute procedure trigger_tobject_attr_after_insert ();\n\n",Dbf=function(e){var t=this;t.options={},t.fields=e.fields,t.rows=e.rows,t.options=e.options};Dbf.prototype.convertDate=function(e){var t,s;return e?(s=String(e.getFullYear()),t=e.getMonth()+1,t<10&&(t="0"+t),s+=String(t),t=e.getDate(),t<10&&(t="0"+t),s+=String(t)):s="      ",s},Dbf.prototype.winToDos=function(e){var t=this;if(!Dbf.prototype.dos){var s={};s[""]=128,s[""]=129,s[""]=130,s[""]=131,s[""]=132,s[""]=133,s[""]=240,s[""]=134,s[""]=135,s[""]=136,s[""]=137,s[""]=138,s[""]=139,s[""]=140,s[""]=141,s[""]=142,s[""]=143,s[""]=144,s[""]=145,s[""]=146,s[""]=147,s[""]=148,s[""]=149,s[""]=150,s[""]=151,s[""]=152,s[""]=153,s[""]=155,s[""]=156,s[""]=154,s[""]=157,s[""]=158,s[""]=159,s[""]=160,s[""]=161,s[""]=162,s[""]=163,s[""]=164,s[""]=165,s[""]=241,s[""]=166,s[""]=167,s[""]=168,s[""]=169,s[""]=170,s[""]=171,s[""]=172,s[""]=173,s[""]=174,s[""]=175,s[""]=224,s[""]=225,s[""]=226,s[""]=227,s[""]=228,s[""]=229,s[""]=230,s[""]=231,s[""]=232,s[""]=233,s[""]=235,s[""]=236,s[""]=234,s[""]=237,s[""]=238,s[""]=239,Dbf.prototype.dos={};for(var n in s)Dbf.prototype.dos[n]=s[n],Dbf.prototype.dos[common.UnicodeToWin1251(n)]=s[n]}for(var r=0;r<e.length;r++){var o=String.fromCharCode(e[r]);t.dos[o]&&(e[r]=t.dos[o])}},Dbf.prototype.getBuffer=function(e){var t,s,n=this,r=32+32*n.fields.length+1,o=new Buffer(r);for(o[0]=3,dateLastUpdate=new Date,o[1]=dateLastUpdate.getFullYear()-1900,o[2]=dateLastUpdate.getMonth()+1,o[3]=dateLastUpdate.getDate(),o.writeUInt32LE(n.rows.length,4),o.writeUInt16LE(r,8),s=1,t=0;t<n.fields.length;t++)s+=n.fields[t].size;for(o.writeUInt16LE(s,10),t=12;t<=31;t++)o[t]=0;for(t=0;t<n.fields.length;t++)o.fill(0,32+32*t,32+32*t+32),o.write(n.fields[t].name,32+32*t,n.fields[t].name.length),o.write(n.fields[t].type,32+32*t+11,1),o[32+32*t+16]=n.fields[t].size,o[32+32*t+17]=n.fields[t].dec;o[32+32*t]=13;var i,a,c=[o];for(t=0;t<n.rows.length;t++){var f=new Buffer(s);f.fill(32),a=1;for(var l=0;l<n.fields.length;l++){var d=n.fields[l];"C"==d.type&&(i=n.rows[t][d.name]||"",i.length>d.size&&(i=i.substr(0,d.size))),"N"==d.type&&(i=n.rows[t][d.name]),"D"==d.type&&(i=n.convertDate(n.rows[t][d.name]));var u;"DOS"==e?(u=new Buffer(common.UnicodeToWin1251(i),"binary"),n.winToDos(u)):u=new Buffer(common.UnicodeToWin1251(i),"binary"),u.copy(f,a),a+=d.size}c.push(f)}var g=Buffer.concat(c);if(c.length>1)for(var t=0;t<c.length;t++)delete c[t];return g},dbf={},dbf.report=function(e,t,s){if(e.url.indexOf("/report?")>-1&&"dbf"==e.query.format){for(var n={},r=e.body.split("&"),o=0;o<r.length;o++){var i=r[o].split("=");
i[1]=i[1].split("+").join("%20"),i[1]=unescape(i[1]),i[1]=new Buffer(i[1],"ascii").toString("utf8"),n[i[0]]=JSON.parse(i[1])}var a=new Dbf(n),c=a.getBuffer(n.options.coding);t.header("Content-Type","application/x-download;"),t.header("Content-Disposition","attachment; filename="+(n.options.filename||"data.dbf")),t.header("Expires","-1"),t.header("Content-Length",c.length),t.statusCode=200,t.end(c)}else s()};var xmlss={};xmlss.customReport=function(e){var t=e.styles,s=e.sheets,n=new XMLSS;for(var r in t)n.addStyle(r,t[r]);for(var o={1:9,2:14.25,3:19.5,4:24.75,5:30,6:35.25,7:40.5,8:45.75,9:51,10:56.25,11:61.5,12:66.75,13:72,14:77.25,15:82.5,16:87.75,17:93,18:98.25,19:103.5,20:108.75},i=0;i<s.length;i++){var a=s[i],c=a.name;n.sheet.create(c);var f="Portrait";a.orientation&&(f="landscape"==a.orientation?"Landscape":"Portrait"),n.sheet.orientation.push(f),n.sheet.validation.push(a.validation),n.sheet.namedRange.push(a.namedRange);var l=a.scale||"100";n.sheet.scale.push(l);var d=!1;a.autoFitHeight&&(d=!0),n.sheet.autoFitHeight.push(d);var u=2.5,g=2,p=2,m=2.5;if(a.margins){var h=a.margins;h.left&&(g=h.left/10),h.top&&(m=h.top/10),h.right&&(p=h.right/10),h.bottom&&(u=h.bottom/10)}n.sheet.marginBottom.push(u),n.sheet.marginLeft.push(g),n.sheet.marginRight.push(p),n.sheet.marginTop.push(m);for(var v=a.rows,_=0;_<v.length;_++){var b=v[_],w=b.cells,y=b.height,j=0;b.startIndex&&(j=b.startIndex),n.pushRow(y,j);for(var x=0;x<w.length;x++){var q=w[x],$="Default";q.style&&($=q.style);var C=1;q.colspan&&(C=q.colspan);var S=1;q.rowspan&&(S=q.rowspan);var I=0;q.startIndex&&(I=q.startIndex);var T="";q.text&&(T=String(q.text));for(var A="",E=0;E<T.length;E++)A+="\n"==T[E]?"&#10;":T[E];n.pushCell(A,$,C,S,I)}}0==v.length&&(n.pushRow(),n.pushCell(""));var N=a.columns;for(var O in N){var k=N[O];if(k.width){var R=k.width;R=o[R]||5*R,n.setColWidth(R,O,O,!0)}}}var D=n.content();return D},xmlss.XMLSS=XMLSS,Sheet.prototype.create=function(e){var t=this.sheetName.length;this.sheetName.push(e),this.rowSheetId[this.xml.data.length]=t},Sheet.prototype.getSheetNum=function(){return this.sheetName.length},Sheet.prototype.setColWidth=function(e,t,s,n){var r=6;n&&(r=1);var o=this.sheetName.length-1;if(this.colWidth[o]=this.colWidth[o]||{},0==s)this.colWidth[o][t]=e*r;else if(s>=t)for(var i=t;i<=s;i++)this.colWidth[o][i]=e*r},Sheet.prototype.getColWidth=function(e,t){return this.colWidth[e]&&this.colWidth[e][t]?this.colWidth[e][t]:9},Sheet.prototype.getHeader=function(e){var t="";t+="<Worksheet ss:Name='"+this.sheetName[e]+"'>\n",this.xml.printTitlesRow1>0&&(t+="<Names>\n",t+="<NamedRange ss:Name='Print_Titles' ss:RefersTo='=Sheet1!R"+this.xml.printTitlesRow1+":R"+this.xml.printTitlesRow2+"'/>\n",t+="</Names>\n"),t+="<Table ss:ExpandedColumnCount='255' ss:ExpandedRowCount='65535' x:FullColumns='1' x:FullRows='1'>\n";for(var s=1;s<=255;s++)t+="<Column ss:AutoFitWidth='0' ss:Width='",t+=this.getColWidth(e,s),t+="'/>\n";return t},Sheet.prototype.getFooter=function(e){var t="",s=this.xml;if(t+="</Table>\n",t+="<WorksheetOptions xmlns='urn:schemas-microsoft-com:office:excel'>\n",t+="<PageSetup>\n","Landscape"==s.sheet.orientation[e]&&(t+="<Layout x:Orientation='Landscape'/>\n"),t+="<PageMargins x:Bottom='"+s.sheet.marginBottom[e]/2.54,t+="' x:Left='"+s.sheet.marginLeft[e]/2.54,t+="' x:Right='"+s.sheet.marginRight[e]/2.54,t+="' x:Top='"+s.sheet.marginTop[e]/2.54,t+="'/>\n",t+="</PageSetup>\n",(s.fitWidth||s.fitHeight)&&(t+="<FitToPage/>\n"),t+="<Print>\n",s.fitWidth&&(t+="<FitWidth>"+s.fitWidth+"</FitWidth>\n"),s.fitHeight&&(t+="<FitHeight>"+s.fitHeight+"</FitHeight>\n"),t+="<ValidPrinterInfo/>\n",t+="<PaperSizeIndex>"+s.paperSizeIndex+"</PaperSizeIndex>\n",t+="<Scale>"+s.sheet.scale[e]+"</Scale>\n",t+="<HorizontalResolution>600</HorizontalResolution>\n",t+="<VerticalResolution>600</VerticalResolution>\n",t+="</Print>\n",s.showPageBreakZoom&&(t+="<ShowPageBreakZoom/>"),t+="<Zoom>"+s.zoom+"</Zoom>\n",t+="<Selected/>\n",t+="<Panes>\n",t+="<Pane>\n",t+="<Number>3</Number>\n",t+="<ActiveRow>13</ActiveRow>\n",t+="<ActiveCol>3</ActiveCol>\n",t+="</Pane>\n",t+="</Panes>\n",t+="<ProtectObjects>False</ProtectObjects>\n",t+="<ProtectScenarios>False</ProtectScenarios>\n",t+="</WorksheetOptions>\n",s.sheet.validation[e]&&s.sheet.validation[e].length)for(var n=s.sheet.validation[e],r=0;r<n.length;r++){t+='<DataValidation  xmlns="urn:schemas-microsoft-com:office:excel">\n';var o=n[r],i="";o.r1&&(i+="R"+o.r1),o.c1&&(i+="C"+o.c1),(o.r2||o.c2)&&(i+=":",o.r2&&(i+="R"+o.r2),o.c2&&(i+="C"+o.c2)),t+="<Range>"+i+"</Range>\n",t+="<Type>"+o.type+"</Type>\n",o.value&&("object"==typeof o.value&&o.value.length?(t+="<CellRangeList/>\n",t+="<Value>&quot;"+o.value.join(",")+"&quot;</Value>\n"):t+="<Value>"+o.value+"</Value>\n"),o.min&&(t+="<Min>"+o.min+"</Min>\n"),o.max&&(t+="<Max>"+o.max+"</Max>\n"),t+="</DataValidation>\n"}return t+="</Worksheet>\n"},Sheet.prototype.hasStartRow=function(e){return this.rowSheetId.hasOwnProperty(e)},Sheet.prototype.getSheetIdByRowId=function(e){return this.rowSheetId[e]},XMLSS.prototype.setDefaultStyles=function(){this.xmlStyles=""},XMLSS.prototype.clearColWidth=function(){this.colWidth=[];for(var e=0;e<257;e++)this.colWidth.push(50.58)},XMLSS.prototype.setColWidth=function(e,t,s,n){var r=6;if(n&&(r=1),0==this.sheet.getSheetNum()){if(0==s)this.colWidth[t]=e*r;else if(s>=t)for(var o=t;o<=s;o++)this.colWidth[o]=e*r}else this.sheet.setColWidth(e,t,s,n)},XMLSS.prototype.clearRowHeight=function(){this.rowHeight=[];for(var e=0;e<this.data.length;e++)this.rowHeight.push(this.defRowHeight)},XMLSS.prototype.clearRowStartIndex=function(){this.rowStartIndex=[];for(var e=0;e<this.data.length;e++)this.rowStartIndex.push(0)},XMLSS.prototype.addStyle=function(e,t){var s,n,r="",o={};for(s=0;s<t.length;s++){var i=t[s];","==i||s==t.length-1?(s==t.length-1&&(r+=i),o[n]=r,r=""):":"==i?(n=r,r=""):r+=i}o.hAlign||(o.hAlign="Left"),o.vAlign||(o.vAlign="Center"),o.fontSize||(o.fontSize="10"),o.fontName||(o.fontName="Arial Cyr");var a="";if(a+="<Style ss:ID='"+e+"'>\n",a+="<Alignment ss:Horizontal='"+o.hAlign+"' ss:Vertical='"+o.vAlign+"'",o.rotate&&(a+=" ss:Rotate='"+o.rotate+"'"),"true"==o.wrap&&(a+=" ss:WrapText='1'"),a+="/>\n",o.numberFormat&&(a+="<NumberFormat ss:Format='"+o.numberFormat+"'/>"),a+="<Borders>\n",o.borders){var c=o.borders;"AllDash"==c?c="LeftDash RightDash TopDash BottomDash":"All"==c&&(c="Left Right Top Bottom"),c.indexOf("LCont")!=-1&&(a+="<Border ss:Position='Left' ss:LineStyle='Continuous' ss:Weight='2'/>\n"),c.indexOf("BottomDash")!=-1?a+="<Border ss:Position='Bottom' ss:LineStyle='Dash' ss:Weight='1'/>\n":c.indexOf("Bottom")!=-1&&(a+="<Border ss:Position='Bottom' ss:LineStyle='Continuous' ss:Weight='1'/>\n"),c.indexOf("LeftDash")!=-1?a+="<Border ss:Position='Left' ss:LineStyle='Dash' ss:Weight='1'/>\n":c.indexOf("Left")!=-1&&(a+="<Border ss:Position='Left' ss:LineStyle='Continuous' ss:Weight='1'/>\n"),c.indexOf("RightDash")!=-1?a+="<Border ss:Position='Right' ss:LineStyle='Dash' ss:Weight='1'/>\n":c.indexOf("Right")!=-1&&(a+="<Border ss:Position='Right' ss:LineStyle='Continuous' ss:Weight='1'/>\n"),c.indexOf("TopDash")!=-1?a+="<Border ss:Position='Top' ss:LineStyle='Dash' ss:Weight='1'/>\n":c.indexOf("Top")!=-1&&(a+="<Border ss:Position='Top' ss:LineStyle='Continuous' ss:Weight='1'/>\n")}a+="</Borders>\n",a+="<Font ss:FontName='"+o.fontName+"' x:CharSet='204'",a+=" ss:Size='"+o.fontSize+"'","true"==o.bold&&(a+=" ss:Bold='1'"),"true"==o.italic&&(a+=" ss:Italic='1'"),"true"==o.underline&&(a+=" ss:Underline='Single'"),o.fontColor&&(a+=" ss:Color='"+o.fontColor+"'"),a+="/>",o.bgColor&&(a+="<Interior ss:Color='"+o.bgColor+"' ss:Pattern='Solid'/>"),a+="</Style>\n",this.xmlStyles+=a},XMLSS.prototype.pushRow=function(e,t){12.75==e&&(e=this.defRowHeight),this.rowStartIndex.push(t),this.rowHeight.push(e);var s=[];return this.data.push(s),this.row=s,this.data.length-1},XMLSS.prototype.pushCell=function(e,t,s,n,r){return!this.row.length&&!r&&this.rowStartIndex[this.rowStartIndex.length-1]>0&&(r=this.rowStartIndex[this.rowStartIndex.length-1]),this.row.push(new Cell(e,t,s,n,r)),this.row.length-1},XMLSS.prototype.content=function(){var e=this.getMultiSheetContent();return e},XMLSS.prototype.getMultiSheetContent=function(){for(var e,t,s,n,r,o,i,a,c="",f=1,l=0,s=0;s<this.data.length;s++){var d=this.data[s];this.sheet.hasStartRow(l)&&(r=this.sheet.getSheetIdByRowId(l),l>0&&(c+=this.sheet.getFooter(r-1)),c+=this.sheet.getHeader(r)),c+=this.sheet.autoFitHeight[r]&&this.rowHeight[f-1]==this.defRowHeight?"<Row ss:AutoFitHeight='1'>\n":"<Row ss:AutoFitHeight='0' ss:Height='"+this.rowHeight[f-1]+"'>\n",t=1;for(var n=0;n<d.length;n++){var u=d[n];if(""!=u.style||""!=u.text){c+="<Cell",u.index>0&&(c+=" ss:Index='"+u.index+"'"),""!=u.style&&(c+=" ss:StyleID='"+u.style+"'"),u.colspan>1&&(c+=" ss:MergeAcross='"+(u.colspan-1)+"'"),u.rowspan>1&&(c+=" ss:MergeDown='"+(u.rowspan-1)+"'"),o=0,i=0,a=u.text.length;for(var g=0;g<a;g++)"0123456789".indexOf(u.text[g])>-1&&o++,"."==u.text[g]&&i++;if(a>0&&o+i==a&&o>0&&i<=1)c+="><Data ss:Type='String'>"+u.text+"</Data></Cell>\n";else{var p=u.text.split("<").join("&lt;");p=p.split(">").join("&gt;"),c+="><Data ss:Type='String'>"+p+"</Data></Cell>\n"}}u.index>0?t=u.index+u.colspan:t+=u.colspan}c+="</Row>\n",f++,l++}return c+=this.sheet.getFooter(r),e="<?xml version='1.0'?>\n",e+="<?mso-application progid='Excel.Sheet'?>\n",e+="<Workbook xmlns='urn:schemas-microsoft-com:office:spreadsheet'\n",e+="xmlns:o='urn:schemas-microsoft-com:office:office'\n",e+="xmlns:x='urn:schemas-microsoft-com:office:excel'\n",e+="xmlns:ss='urn:schemas-microsoft-com:office:spreadsheet'\n",e+="xmlns:html='http://www.w3.org/TR/REC-html40'>\n",e+="<DocumentProperties xmlns='urn:schemas-microsoft-com:office:office'>\n",e+="<Author>Dimas</Author>\n",e+="<LastAuthor>Dimas</LastAuthor>\n",e+="<Created>2008-04-10T14:18:34Z</Created>\n",e+="<Company>-</Company>\n",e+="<Version>11.5606</Version>\n",e+="</DocumentProperties>\n",e+="<ExcelWorkbook xmlns='urn:schemas-microsoft-com:office:excel'>\n",e+="<WindowHeight>10230</WindowHeight>\n",e+="<WindowWidth>14235</WindowWidth>\n",e+="<WindowTopX>480</WindowTopX>\n",e+="<WindowTopY>15</WindowTopY>\n",e+="<ProtectStructure>False</ProtectStructure>\n",e+="<ProtectWindows>False</ProtectWindows>\n",e+="</ExcelWorkbook>\n",e+="<Styles>\n"+this.xmlStyles+"</Styles>\n",e+="<Names>\n"+this.getNamedRangeList()+"</Names>\n",e+=c,e+="</Workbook>\n"},XMLSS.prototype.getNamedRange=function(e,t,s){for(var n=0;n<e.length;n++){var r=e[n];if(t>=r.r1&&s>=r.c1&&t<=r.r2&&s<=r.c2||t==r.r1&&(s==r.c1||s>=r.c1&&s<=r.c2||!r.c1)||s==r.c1&&(t==r.r1||t>=r.r1&&t<=r.r2||!r.r1))return r.name}},XMLSS.prototype.getNamedRangeList=function(){for(var e="",t=0;t<this.sheet.namedRange.length;t++){var s=this.sheet.namedRange[t];if(s&&s.length)for(var n=0;n<s.length;n++){var r="";s[n].r1&&(r+="R"+s[n].r1),s[n].c1&&(r+="C"+s[n].c1),(s[n].r2||s[n].c2)&&(r+=":",s[n].r2&&(r+="R"+s[n].r2),s[n].c2&&(r+="C"+s[n].c2)),e+='<NamedRange ss:Name="'+s[n].name+'" ss:RefersTo="='+this.sheet.sheetName[t]+"!"+r+'"/>'}}return e},xmlss.getAttr=function(e){var t=e.storage,s=e.tags,n=e.success,r=e.text.split("."),o=!1;r.length&&"$date"==r[r.length-1]&&(r.splice(r.length-1,1),o=!0);var i,a;e.timeOffset=e.timeOffset||-144e5;var c=function(t){return t?(t.getUTCHours()||t.getUTCMinutes()||t.getUTCSeconds()?(t=new Date(t.getTime()-e.timeOffset),t=common.getUTCTimestamp(t),"00:00:00"==t.substr(11,8)&&(t=t.substr(0,10))):t=common.getUTCDate(t),t):t};async.reduce(r,0,function(e,n,o){e?(a=i.get(n),e<r.length-1?t.getObject({id:a,success:function(t){i=t.object,i?o(null,e+1):o("empty")},failure:function(e){o("empty")}}):o(null,e+1)):r.length>1?t.getObject({id:s[n],success:function(t){i=t.object,i?o(null,e+1):o("empty")},failure:function(e){o("empty")}}):(a=s[n],o(null,e+1))},function(e,t){"empty"==e||void 0==a||null==a?n(""):(o&&a?(a=c(a),a&&(a=a.substr(0,10))):a&&"object"==typeof a&&a.getMonth&&(a=c(a)),n(a))})},xmlss.updateTags=function(e){var t=e.success;e.timeOffset=60*e.request.query.time_offset_min*1e3;for(var s=[],n=e.data,r=1;r<n.length;r++)if("$"==n[r]&&"["==n[r-1]){var o="";for(r++;r<n.length&&"]"!=n[r];r++)o+=n[r];s.indexOf(o)==-1&&s.push(o)}async.mapSeries(s,function(t,s){e.text=t,e.success=function(e){n=n.split("[$"+t+"]").join(e),s()},xmlss.getAttr(e)},function(e,s){t(n)})},xmlss.report=function(e,t,s){if(e.url.indexOf("/report?")>-1){var n=e.url;1!=e.query.custom&&(n=n.split("&view").join("&noview"),n+="&custom=1");var r={},o=e.body;if(o){for(var i=o.split("&"),a=0;a<i.length;a++){var c=i[a].split("=");c[1]=c[1].split("+").join("%20"),c[1]=unescape(c[1]),c[1]=new Buffer(c[1],"ascii").toString("utf8"),r[c[0]]=1==e.query.csv?c[1]:JSON.parse(c[1])}r.opts&&_.extend(r,r.opts)}if(1==e.query.csv){var f=new Buffer(common.UnicodeToWin1251(r.body),"binary");t.header("Content-Type","application/x-download; charset=windows-1251"),t.header("Content-Disposition","attachment; filename=report.csv"),t.header("Expires","-1"),t.header("Content-Length",f.length),t.statusCode=200,t.end(f)}else if(1==e.query.custom){var f=xmlss.customReport(r);t.header("Content-Type","application/x-download"),t.header("Content-Disposition","attachment; filename=report.xml"),t.header("Expires","-1"),t.header("Content-Length",Buffer.byteLength(f,"utf8")),t.statusCode=200,t.end(f)}else if(e.query.view){var l=e.session,d=l.storage,u=e.query.view,g=d.viewsMap[u],p=JSON.parse(g.get("fquery")),m=r.filter||[];if(m&&m.length){p.where=p.where||[],p.where.length&&p.where.push("and");for(var h={},a=1;a<p.select.length;a+=2)h[p.select[a]]=p.select[a-1];for(var a=0;a<m.length;a++)h[m[a]]&&(m[a]=h[m[a]]);p.where.push(m)}var v=null;e.query.order&&(v=JSON.parse(e.query.order));var b=[];r.options&&(b=r.options.dateAttrs||[]),v&&v.length&&(p.order=v);for(var w=r.cols||[],y={},a=0;a<w.length;a++)y[w[a].attrId]=w[a];var j=new Query({session:l,storage:d,sql:p});j.generate(),d.query({sql:j.selectSQL+j.fromSQL+j.whereSQL+j.orderSQL+("mssql"!=d.client.database?"\nlimit "+config.query.maxRowNum+" offset 0\n":""),success:function(s){var n=s.result.rows,r=g.attrs,o=0,i=[];for(var a in r)y[r[a].get("fid")]&&y[r[a].get("fid")].hidden||(r[a].set("field",r[a].get("fcode").toLowerCase()+"_"),i.push(r[a]),o++);i.sort(function(e,t){return null!==e.get("forder")&&null!==t.get("forder")&&e.get("forder")<t.get("forder")?-1:null!=e.get("forder")&&null==t.get("forder")?-1:e.get("forder")==t.get("forder")&&e.get("fid")<t.get("fid")?-1:null!==e.get("forder")&&null!==t.get("forder")&&e.get("forder")>t.get("forder")?1:null==e.get("forder")&&null!=t.get("forder")?1:e.get("forder")==t.get("forder")&&e.get("fid")>t.get("fid")?1:0});for(var c={},f=0;f<i.length;f++)c[f+1]={width:parseInt(i[f].get("fcolumn_width")/6.5)},y[i[f].get("fid")]&&y[i[f].get("fid")].width&&(c[f+1].width=y[i[f].get("fid")].width/6.5);for(var d=[],u={height:12.75,cells:[]},p=0;p<i.length;p++)if(!y[i[p].get("fid")]||!y[i[p].get("fid")].hidden){var m=i[p].get("fname");u.cells.push({text:common.unescape(m),style:"border_bold"})}d.push(u);for(var h=60*e.query.time_offset_min*1e3,f=0;f<n.length;f++){for(var u={height:12.75,cells:[]},p=0;p<i.length;p++)if(!y[i[p].get("fid")]||!y[i[p].get("fid")].hidden){var v=i[p].get("fcode").toLowerCase()+"_",w=n[f][v];"string"==typeof w?w=w:w&&"object"==typeof w&&w.getMonth?b.indexOf(i[p].get("fcode"))==-1&&(w.getUTCHours()||w.getUTCMinutes()||w.getUTCSeconds())?(w=new Date(w.getTime()-h),w=common.getUTCTimestamp(w)):w=common.getUTCDate(w):4==j.fieldTypeId[v]&&(w=w?"":""),u.cells.push({text:w,style:"border"})}d.push(u)}if("xmlss"==e.query.format){var x=xmlss.customReport({styles:{default:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9",center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9",center_bold:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,bold:true",bold:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,bold:true",border:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All",border_center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,borders:All",border_bold:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true",border_bold_underline:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true,underline:true",border_underline:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,underline:true",border_bold_center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true",border_bottom:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:Bottom",right:"hAlign:Right,vAlign:Center,wrap:true,fontSize:9"},sheets:[{name:"Sheet",autoFitHeight:!0,orientation:"landscape",scale:100,margins:{left:31,top:32,right:33,bottom:34},columns:c,rows:d}]});t.header("Content-Type","application/x-download"),t.header("Content-Disposition","attachment; filename=report.xml"),t.header("Expires","-1"),t.header("Content-Length",Buffer.byteLength(x,"utf8")),t.statusCode=200,t.end(x)}else if("pdf"==e.query.format)pdf.buildReportFromXMLSS({session:l,sheet:{name:"Sheet",autoFitHeight:!0,orientation:"landscape",scale:100,margins:{left:31,top:32,right:33,bottom:34},columns:c,rows:d}},function(e,s){e?t.end("{success: false, error: '"+e+"'}"):(t.header("Content-Type","application/x-download;"),t.header("Content-Disposition","attachment; filename=report.pdf"),t.header("Expires","-1"),t.header("Content-Length",s.length),t.statusCode=200,t.end(s))});else if("ods"==e.query.format){var q=require("adm-zip"),$=new q,C=require("fs");$.addLocalFolder(__dirname+"/report/template.ods");var C=require("fs");C.readFile(__dirname+"/report/template.ods/content.xml","utf8",function(e,s){var n=require("xml2js"),r=new n.Parser({explicitArray:!1});r.parseString(s,function(e,s){s["office:document-content"]["office:body"]["office:spreadsheet"]["table:table"]["table:table-row"]=[],_.each(d,function(e){var t=[];_.each(e.cells,function(e){e.text=e.text||"",e.style=e.style||"",e.colspan=e.colspan||1,e.rowspan=e.rowspan||1;var s=e.text;t.push({$:{"office:value-type":"string","calcext:value-type":"string"},"text:p":s})}),s["office:document-content"]["office:body"]["office:spreadsheet"]["table:table"]["table:table-row"].push({$:{"table:style-name":"ro1"},"table:table-cell":t})});var r=new n.Builder,o=r.buildObject(s);$.updateFile("content.xml",new Buffer(o));var i=$.toBuffer();t.header("Content-Type","application/x-download;"),t.header("Content-Disposition","attachment; filename=report.ods"),t.header("Expires","-1"),t.header("Content-Length",i.length),t.statusCode=200,t.end(i)})})}else if("csv"==e.query.format){var S="";if(_.each(d,function(e){_.each(e.cells,function(e){S+=(null===e.text?"":e.text)+";"}),S+="\n"}),"win1251"==e.query.coding){S=common.UnicodeToWin1251(S);var x=new Buffer(S,"binary");t.header("Content-Type","application/x-download; charset=windows-1251"),t.header("Content-Disposition","attachment; filename=report.csv"),t.header("Expires","-1"),t.header("Content-Length",S.length),t.statusCode=200,t.end(x)}else t.header("Content-Type","application/x-download; charset=utf-8"),t.header("Content-Disposition","attachment; filename=report.csv"),t.header("Expires","-1"),t.header("Content-Length",Buffer.byteLength(S,"utf8")),t.statusCode=200,t.end(S)}else if("xlsx"==e.query.format){var I=new ReportXSLX;s.styles={default:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9",center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9",center_bold:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,bold:true",bold:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,bold:true",border:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All",border_center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,borders:All",border_bold:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true",border_bold_underline:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true,underline:true",border_underline:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,underline:true",border_bold_center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true",border_bottom:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:Bottom",right:"hAlign:Right,vAlign:Center,wrap:true,fontSize:9"},s.sheets=[{name:"Sheet",autoFitHeight:!0,orientation:"landscape",scale:100,margins:{left:31,top:32,right:33,bottom:34},columns:c,rows:d}],I.build(s);var T=XLSX.write(I.workbook,{type:"base64"}),x=new Buffer(T,"base64");t.header("Content-Type","application/x-download;"),t.header("Content-Disposition","attachment; filename=report.xlsx"),t.header("Expires","-1"),t.header("Content-Length",x.length),t.statusCode=200,t.end(x),delete I}}})}else{var x,l=e.session,d=l.storage,q=config.storages[d.code].rootDir+(e.query.files?"/files/":"/reports/")+e.query.template;_.extend(r,e.query),"xmlss"==r.format&&async.series([function(e){fs.readFile(q,function(t,s){x=s,e(t)})},function(t){r.showTags?(x=x.toString(),t()):xmlss.updateTags({request:e,tags:r,storage:d,data:x.toString(),success:function(e){x=e,t()}})}],function(e,s){t.header("Content-Type","application/x-download");var n=r.template.split("."),o="report."+n[n.length-1];t.header("Content-Disposition","attachment; filename="+o),t.header("Expires","-1"),t.header("Content-Length",Buffer.byteLength(x,"utf8")),t.statusCode=200,t.end(x)}),"docx"==r.format&&async.series([function(e){fs.readFile(q,"binary",function(t,s){x=s,e(t)})}],function(e,s){var n=require("docxtemplater"),o=new n(x);o.setOptions({parser:function(e){return{get:function(t){return"."===e?t:t[e]}}}}),o.setData(r),r.showTags||o.render();var i=o.getZip().generate({type:"nodebuffer"});t.header("Content-Type","application/x-download"),t.header("Content-Disposition","attachment; filename=report.docx"),t.header("Expires","-1"),t.header("Content-Length",i.length),t.statusCode=200,t.end(i)})}}else s()};var pdf={};pdf.buildReportFromXMLSS=function(e,t){var s=e.session,n=e.sheet,r=n.columns,o=n.orientation,i=n.rows,a='<html>\n<head>\n<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">\n<style type=\'text/css\'>\n* {\n   font-family: Arial;\n   font-size: 10pt;\n}\n</style>\n</head>\n<body>\n';a+="%"==n.ell?"<table cellspacing=0 width=100% border=1>\n":"<table cellspacing=0 border=1>\n";for(var c=0;c<i.length;c++){for(var f=i[c],l=f.cells,d="<tr height=20>\n",u=1,g=0;g<l.length;g++){var p=l[g];p.text=p.text||"",p.style=p.style||"",p.colspan=p.colspan||1,p.rowspan=p.rowspan||1;var m=p.text;void 0!==m&&null!==m&&""!==m||(m="<img width=1 height=1>"),p.style.indexOf("bold")>-1&&(m="<b>"+m+"</b>");for(var h="",v=0,_=u;_<u+p.colspan;_++)v+=r[_]?r[_].width||0:0;v&&(h+="width: "+v+n.ell+";"),p.style.indexOf("underline")>-1&&(h+="border-bottom: 1px solid #000000;");var b="";p.style.indexOf("center")>-1&&(b=" align=center "),d+="\t<td colspan="+p.colspan+" rowspan="+p.rowspan+b+" style='"+h+"'>"+m+"</td>\n",u+=p.colspan}d+="</tr>\n",a+=d}a+="</table>\n</body>\n</html>\n",fs.writeFile(__dirname+"/report/pdf/"+s.id+".html",a,function(e){if(e)return t(e);var n=require("child_process").spawn,r=["--orientation","landscape"==o?"Landscape":"Portrait","--dpi",300,"--page-size","A4",__dirname+"/report/pdf/"+s.id+".html",__dirname+"/report/pdf/"+s.id+".pdf"],i=__dirname+"/report/pdf/wkhtmltopdf";config.report&&config.report.pdf&&(i=config.report.pdf);var a=n(i,r);a.stdout.on("data",function(e){console.log("stdout: "+e)}),a.stderr.on("data",function(e){console.log("stderr: "+e)}),a.on("close",function(e){fs.unlink(__dirname+"/report/pdf/"+s.id+".html",function(e){return e?t(e):void fs.readFile(__dirname+"/report/pdf/"+s.id+".pdf",function(e,n){return e?t(e):void fs.unlink(__dirname+"/report/pdf/"+s.id+".pdf",function(e){return e?t(e):void t(null,n)})})})})})},pdf.report=function(e,t,s){var n=e.session;n.storage;if(e.url.indexOf("/pdf?")>-1&&projects.sessions[n.id]){var r={},o=e.body;if(o){o=o.split("+").join("%20"),o=unescape(o),o=new Buffer(o,"ascii").toString("utf8");for(var i=o.split("&"),a=0;a<i.length;a++){var c=i[a].split("=");r[c[0]]=JSON.parse(c[1])}}var f=r.sheets[0];pdf.buildReportFromXMLSS({sheet:f,session:n},function(e,s){e?t.end("{success: false, error: '"+e+"'}"):(t.header("Content-Type","application/x-download;"),t.header("Content-Disposition","attachment; filename=report.pdf"),t.header("Expires","-1"),t.header("Content-Length",s.length),t.statusCode=200,t.end(s))})}else s()};var XLSX=require("xlsx"),ReportXSLX=Backbone.Model.extend({addStyle:function(e,t){var s=this;s.styles=s.styles||{};var n={alignment:{horizontal:"left",vertical:"top"},font:{name:"Arial",sz:"9"}};_.each(t.split(","),function(e){var t=e.split(":")[0],s=e.split(":")[1];"hAlign"==t&&(n.alignment.horizontal={Left:"left",Center:"center",Right:"right"}[s]),"vAlign"==t&&(n.alignment.vertical={Left:"top",Center:"center",Right:"bottom"}[s]),"wrap"==t&&(n.alignment.wrapText=!0),"rotate"==t&&(n.alignment.textRotation=90),"fontSize"==t&&(n.font.sz=s),"fontName"==t&&(n.font.name=s),"bold"==t&&(n.font.bold=!0),"italic"==t&&(n.font.italic=!0),"underline"==t&&(n.font.underline=!0),"borders"==t&&(n.border={left:{style:"thin",color:{auto:1}},right:{style:"thin",color:{auto:1}},top:{style:"thin",color:{auto:1}},bottom:{style:"thin",color:{auto:1}}})}),s.styles[e]=n},addCell:function(e,t,s,n){var r=this,o=n.colspan>1?n.colspan-1:0,i=n.rowspan>1?n.rowspan-1:0;(o||i)&&(e["!merges"]=e["!merges"]||[],e["!merges"].push({s:{c:t,r:s},e:{c:t+o,r:s+i}}));for(var a=t;a<=t+o;a++)for(var c=s;c<=s+i;c++)e[XLSX.utils.encode_cell({c:a,r:c})]={v:null===n.text?"":n.text,t:"s",s:r.styles[n.style]}},addCols:function(e,t){e["!cols"]=_.map(t,function(e){var t;return t=_.isObject(e)?e.width:e,{wch:t}})},addSheet:function(e){var t=this,s={},n=0,r=0;_.each(e.rows,function(e){var o=e.startIndex?e.startIndex-1:0;_.each(e.cells,function(e){e.startIndex&&(o=e.startIndex-1),t.addCell(s,o,n,e),o+=e.colspan||1}),r=o>r?o:r,n++}),t.addCols(s,e.columns),s["!ref"]=XLSX.utils.encode_range({s:{c:0,r:0},e:{c:r,r:n}}),t.workbook.SheetNames.push(e.name),t.workbook.Sheets[e.name]=s},build:function(e){var t=this;t.workbook={SheetNames:[],Sheets:{}},_.each(e.styles,function(e,s){t.addStyle(s,e)}),_.each(e.sheets,function(e){t.addSheet(e)})}}),xlsx={};xlsx.report=function(e,t,s){if(e.url.indexOf("/report?")>-1&&"xlsx"==e.query.format&&!e.query.view){var n={},r=e.body;if(r)for(var o=r.split("&"),i=0;i<o.length;i++){var a=o[i].split("=");a[1]=a[1].split("+").join("%20"),a[1]=unescape(a[1]),a[1]=new Buffer(a[1],"ascii").toString("utf8"),n[a[0]]=JSON.parse(a[1])}var c=new ReportXSLX;if(c.build(n),log.debug({workbook:c.workbook}),e.query.convert_csv){var f=XLSX.utils.sheet_to_csv(c.workbook.Sheets[c.workbook.SheetNames[0]],{FS:";"});if(e.query.win1251){var l=new Buffer(common.UnicodeToWin1251(f),"binary");t.header("Content-Type","application/x-download; charset=windows-1251"),t.header("Content-Disposition","attachment; filename=report.csv"),t.header("Expires","-1"),t.header("Content-Length",l.length),t.statusCode=200,t.end(l)}else t.header("Content-Type","application/x-download;"),t.header("Content-Disposition","attachment; filename=report.csv"),t.header("Expires","-1"),t.header("Content-Length",f.length),t.statusCode=200,t.end(f)}else{var d=XLSX.write(c.workbook,{type:"base64"}),l=new Buffer(d,"base64");t.header("Content-Type","application/x-download;"),t.header("Content-Disposition","attachment; filename=report.xlsx"),t.header("Expires","-1"),t.header("Content-Length",l.length),t.statusCode=200,t.end(l)}delete c}else s()};var tm={};tm.remove=function(e){var t=e.success,s=e.session,n=e.storage,r=e.revision,o="select fid, fcode from tclass\nwhere\n\t"+n.getCurrentFilter()+"\n\tand fid >= 1000\norder by fid\n";n.query({session:s,sql:o,success:function(e){var o=e.result.rows;async.eachSeries(o,function(e,t){var o="tm_"+e.fcode+"_"+e.fid;n.client.isTableExists({session:s,table:o,success:function(e){e?n.query({session:s,sql:"delete from "+o+" where frevision_id="+r,success:function(){t()}}):t()}})},t)}})},tm.create=function(e){var t,n,r,o,i=e.storageCode,a=e.success;log.info({cls:"tm",fn:"create ("+i+")"}),async.series([function(e){log.info({cls:"tm"},"getStorage"),projects.getStorage({storageCode:i,success:function(t){n=t.storage,r={id:"tm_create_"+i,username:"admin",userId:null},e()}})},function(e){log.info({cls:"tm"},"startTransaction"),n.startTransaction({session:r,remoteAddr:"127.0.0.1",description:"toc_create_"+i,success:function(){t=n.lastRevision,e()},failure:function(t){e(t.error)}})},function(e){log.info({cls:"tm"},"remove"),tm.remove({storage:n,revision:t,session:r,success:function(){e()}})},function(e){log.info({cls:"tm"},"classes");var t="select\n\tfid, fcode\nfrom\n\ttclass\nwhere\n\t"+n.getCurrentFilter()+"\n\tand fid >= 1000\norder by fid\n";n.query({session:r,sql:t,success:function(t){o=t.result.rows,e()}})},function(e){log.info({cls:"tm"},"process"),async.eachSeries(o,function(e,o){var i,a=e.fid,c=e.fcode,f="tm_"+c+"_"+a;async.series([function(e){n.client.isTableExists({session:r,table:f,success:function(t){t?e():n.query({session:r,sql:"create table "+f+" (fobject_id bigint not null, frevision_id bigint not null)",success:function(){n.client.createIndex({session:r,table:f,field:"fobject_id",success:function(){n.client.createIndex({session:r,table:f,field:"frevision_id",success:function(){e()}})}})}})}})},function(e){n.query({session:r,sql:"select\n\tfid, fcode, ftype_id\nfrom\n\ttclass_attr\nwhere\n\t"+n.getCurrentFilter()+"\n\tand fclass_id = "+a+"\norder by fid\n",success:function(t){i=t.result.rows,e()}})},function(e){async.eachSeries(i,function(e,t){var o=e.fid,i=e.fcode+"_"+o;n.client.isFieldExists({session:r,table:f,field:i,success:function(o){if(o)t();else{var a="$tnumber$",c="fnumber";switch(e.ftype_id){case 2:a="$tnumber_value$";break;case 1:case 5:a="$ttext$",c="fstring";break;case 3:a="$ttimestamp$",c="ftime"}s="alter table "+f+" add "+i+" "+a,n.query({session:r,sql:s,success:function(){t()}})}}})},function(t){e()})},function(e){n.client.isTableExists({session:r,table:c+"_"+a,success:function(s){if(s){for(var o=[],l=0;l<i.length;l++){var d=i[l].fcode+"_"+i[l].fid;o.indexOf(d)==-1&&o.push(d)}var u="insert into "+f+" (fobject_id, frevision_id"+(o.length?", ":"")+o.join(", ")+")\nselect fobject_id, "+t+(o.length?", ":"")+o.join(", ")+" from "+c+"_"+a;n.query({session:r,sql:u,success:function(){e()}})}else e()}})}],function(e,t){o()})},function(t){e()})},function(e){log.info({cls:"tm"},"update"),n.query({session:r,sql:"update trevision set ftoc=1 where fid="+t,success:function(){e()}})},function(e){log.info({cls:"tm"},"commitTransaction"),n.commitTransaction({session:r,success:function(){e()}})}],function(e){log.info({cls:"tm"},"end"),a&&a(t)})},tm.getRevisions=function(e,t,s){if(e.url.indexOf("/get_revisions?")>-1){var n=e.session,r=n.storage;r.query({session:n,sql:"select fid, fdate from trevision where ftoc=1 order by fdate desc",success:function(e){for(var s=[],n=0;n<e.result.rows.length;n++){var r=e.result.rows[n];s.push({id:r.fid,date:r.fdate})}t.send(common.ToJSONString(s))}})}else s()},tm.setRevision=function(e,t,s){if(e.url.indexOf("/set_revision?")>-1){var n=e.session;n.revision=e.query.id,t.send({ok:1})}else s()},tm.build=function(e){function t(){log.info({cls:"tm"},"start build"),tm.create({storageCode:e.code,success:function(t){e.query({sql:"select fid, fdate from trevision where fid="+t,success:function(t){var s=t.result.rows[0];e.visualObjectum.timeMachine.dates.push({id:s.fid,date:s.fdate})}})}}),setTimeout(t,864e5)}if(log.info({cls:"tm"},"build"),e.config.visualObjectum){var s=e.config.visualObjectum.timeMachine?e.config.visualObjectum.timeMachine.buildTime:null;if(s){var n=s.split(":"),r=new Date,o=new Date;Number(n[0])<r.getHours()&&o.setDate(r.getDate()+1),Number(n[0])==r.getHours()&&Number(n[1])<r.getMinutes()&&o.setDate(r.getDate()+1),o.setHours(n[0]),o.setMinutes(n[1]),o.setSeconds(0),o.setMilliseconds(0),log.info({cls:"tm"},"setTimeout "+s+" "+(o.getTime()-r.getTime())),setTimeout(t,o.getTime()-r.getTime())}}};var Ose=function(e){var t=e.storage,s=e.success,n=this;config.storages[t.code]?n.config=config.storages[t.code].ose||{
enabled:0}:n.config={enabled:0},n.subject={getRoles:function(e){return n.config.enabled?r.srole[e]||[]:[]},isAdmin:function(e){return!e||r.admins.indexOf(e)>-1?1:0},can:function(e){var s=e.access,n=e.success,o=e.session,i=e.object,a=r.class_[i.get("fclass_id")];if(a&&(a[null]&&a[null][s]||a[o.userId]&&a[o.userId][s]))return void n();for(var c=0;c<o.roles.length;c++)if(a[o.roles[c]]&&a[o.roles[c]][s])return void n();var f=o.roles.concat(o.userId);t.execute({session:o,sql:{select:[{a:"id"},"id"],from:[{a:"ose.object"}],where:[{a:s},"=",1,"and",{a:"object"},"=",i.get("id"),"and",{a:"subject"},"in",f.join(".,.").split(".")]},success:function(e){e.length?n():n({cancel:1})}})}},n.object={};var r={admins:[],ext:{},srole:{},ext:{},class_:{}};if(n.load=function(e){e=e||{};var s=e.success;async.series([function(e){t.execute({sql:{select:[{a:"role"},"role",{a:"subject"},"subject"],from:[{a:"ose.srole"}]},success:function(t){r.srole={};for(var s=0;s<t.length;s++){var n=t.get(s,"role"),o=t.get(s,"subject");r.srole[o]=r.srole[o]||[],r.srole[o].push(n)}e()}})},function(e){t.execute({sql:{select:[{a:"classAttr"},"classAttr",{a:"give"},"give",{a:"take"},"take"],from:[{a:"ose.ext"}]},success:function(t){r.ext={};for(var s=0;s<t.length;s++){var n=t.get(s,"classattr");r.ext[n]=r.ext[n]||{},r.ext[n]={classAttr:n,take:t.get(s,"take"),give:t.get(s,"give")}}e()}})},function(e){t.execute({sql:{select:[{a:"subject"},"subject",{a:"class"},"class",{a:"read"},"read",{a:"update"},"update",{a:"delete"},"delete"],from:[{a:"ose.object"}],where:[{a:"class"},"is not null"],order:[{a:"npp"}]},success:function(t){r.class_={};for(var s=0;s<t.length;s++){var n=t.get(s,"subject"),o=t.get(s,"class");r.class_[o]=r.class_[o]||{},r.class_[o][n]={read:t.get(s,"read"),update:t.get(s,"update"),delete_:t.get(s,"delete")}}e()}})},function(e){r.admins=["admin"],n.config.admins?t.execute({sql:{select:[{a:"login"},"login"],from:[{a:n.config.admins}]},success:function(t){for(var s=0;s<t.length;s++)r.admins.push(t.get(s,"login"));e()}}):e()}],function(e,t){s&&s()})},n.freeResources=function(){n.config.enabled&&clearInterval(n.loadIntervalId)},!n.config.enabled)return void s();var o=t.getClass("ose.role").get("fid"),i=t.getClass("ose.srole").get("fid"),a=t.getClass("ose.ext").get("fid"),c=t.getClass("ose.object").get("fid"),f=t.getClass(n.config.admins).get("fid"),l=[o,i,a,c,f],d=function(e){var t=e.success;e.session&&e.session.username&&!n.subject.isAdmin(e.session.username)&&e.classId!=c&&l.indexOf(e.classId)>-1&&(e.cancel=1),t(e)};t.on("beforecreateobject",d);var u=function(e){var s=e.success,o=e.classId;if(!r.class_[o]||!e.session||n.subject.isAdmin(e.session.username))return void s();var i=e.object,a=e.session;t.un("aftercreateobject",u),t.un("beforecreateobject",d),t.createObject({session:a,classId:c,success:function(e){t.on("aftercreateobject",u),t.on("beforecreateobject",d);var n=e.object;n.set("object",i.get("id")),n.set("subject",a.userId),n.set("read",1),n.set("update",1),n.set("delete",1),t.un("beforecommitobject",p),n.commit({session:a,success:function(){t.on("beforecommitobject",p),s()}})}})};t.on("aftercreateobject",u);var g=function(e){var t=e.success,s=e.session,o=e.object;return o&&s&&!n.subject.isAdmin(s.username)?l.indexOf(o.get("fclass_id"))>-1?void t({cancel:1}):r.class_[o.get("fclass_id")]?void n.subject.can({session:s,object:o,access:"read",success:t}):void t():void t()};t.on("aftergetobject",g),n.ext=function(e){var s=e.success,n=e.session,o=e.object,i=[],a=t.getClass(o.get("fclass_id"));for(var f in o.data)["id","fclass_id","fspace_id"].indexOf(f)>-1||o.originalData.hasOwnProperty(f)&&o.originalData[f]==o.data[f]||a.attrs[f]&&i.push(a.attrs[f]);async.eachSeries(i,function(e,s){var i=o.data[e.get("fcode")],a=r.ext[e.get("fid")];if(a&&i){var f=[],l=[];async.series([function(e){t.execute({session:n,sql:{select:[{a:"npp"},"npp",{a:"subject"},"subject",{a:"object"},"object",{a:"read"},"read",{a:"update"},"update",{a:"delete"},"delete"],from:[{a:"ose.object"}],where:[{a:"object"},"in",[o.get("id"),",",i]]},success:function(t){for(var s=0;s<t.length;s++){var n={npp:t.get(s,"npp"),subject:t.get(s,"subject"),read:t.get(s,"read"),update:t.get(s,"update"),delete_:t.get(s,"delete")};t.get(s,"object")==i?f.push(n):l.push(n)}e()}})},function(e){a.take?async.eachSeries(f,function(e,s){for(var r=0,i=0;i<l.length;i++)if(l[i].subject==e.subject&&l[i].read==e.read&&l[i].update==e.update&&l[i].delete_==e.delete_){r=1;break}r?s():(t.un("aftercreateobject",u),t.un("beforecreateobject",d),t.createObject({session:n,classId:c,success:function(r){t.on("aftercreateobject",u),t.on("beforecreateobject",d);var i=r.object;i.set("object",o.get("id")),i.set("subject",e.subject),i.set("read",e.read),i.set("update",e.update),i.set("delete",e.delete_),t.un("beforecommitobject",p),i.commit({session:n,success:function(){t.on("beforecommitobject",p),s()}})}}))},function(t){e()}):e()},function(e){a.give?async.eachSeries(l,function(e,s){for(var r=0,o=0;o<f.length;o++)if(f[o].subject==e.subject&&f[o].read==e.read&&f[o].update==e.update&&f[o].delete_==e.delete_){r=1;break}r?s():(t.un("aftercreateobject",u),t.un("beforecreateobject",d),t.createObject({session:n,classId:c,success:function(r){t.on("aftercreateobject",u),t.on("beforecreateobject",d);var o=r.object;o.set("object",i),o.set("subject",e.subject),o.set("read",e.read),o.set("update",e.update),o.set("delete",e.delete_),t.un("beforecommitobject",p),o.commit({session:n,success:function(){t.on("beforecommitobject",p),s()}})}}))},function(t){e()}):e()}],function(e,t){s()})}else s()},function(e){s()})};var p=function(e){var s=e.success,o=e.session,i=e.object;async.series([function(e){!o||n.subject.isAdmin(o.username)?e("ok"):e()},function(e){i.get("fclass_id")==c?i.get("object")?(t.un("aftergetobject",g),t.getObject({session:o,id:i.get("object"),success:function(s){t.on("aftergetobject",g);var r=s.object;r?n.subject.can({session:o,object:r,access:"update",success:function(t){e(t&&t.cancel?"cancel":"ok")}}):e("cancel")}})):e("cancel"):e()},function(e){l.indexOf(i.get("fclass_id"))>-1?e("cancel"):r.class_[i.get("fclass_id")]?n.subject.can({session:o,object:i,access:"update",success:function(t){e(t&&t.cancel?"cancel":"ok")}}):e("ok")}],function(e,t){"cancel"==e?s({cancel:1}):n.ext({object:i,session:o,success:s})})};t.on("beforecommitobject",p);var m=function(e){var t=e.success,s=e.session,o=e.object;return o&&s&&!n.subject.isAdmin(s.username)?l.indexOf(o.get("fclass_id"))>-1?void t({cancel:1}):r.class_[o.get("fclass_id")]?void n.subject.can({session:s,object:o,access:"delete",success:t}):void t():void t()};t.on("beforeremoveobject",m),t.on("generatequeryblock",function(e){var s=e.cls,o=e.objectField,i=e.session,a=(e.tables,e.where);e.alia;if(i&&!n.subject.isAdmin(i.username)&&r.class_[s.get("fid")]){a?a+=" and ":a=" where ";var c=i.roles.concat(i.userId),f=t.getClass("ose.object");a+="exists (\nselect fobject_id from "+f.toc+"\nwhere "+f.attrs.read.toc+" = 1 and "+f.attrs.subject.toc+" in ("+c.join(",")+") and\n("+f.attrs.class.toc+"="+s.get("fid")+" or "+o+"="+f.attrs.object.toc+")\n)",e.where=a}}),n.load({success:function(){n.loadIntervalId=setInterval(n.load,6e4),s()}})};projects.getClasses=function(e,t,s){"getClasses"==e.storageFn?(log.debug({cls:"projects",fn:"getClasses"}),projects.sendTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tclass",fields:["fid","fparent_id","fname","fcode","fdescription","fformat","fview_id","ftype","fsystem","fschema_id","frecord_id"]})):s()},projects.getClassAttrs=function(e,t,s){"getClassAttrs"==e.storageFn?(log.debug({cls:"projects",fn:"getClassAttrs"}),projects.sendTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tclass_attr",fields:["fid","fclass_id","fname","fcode","ftype_id","forder","fnot_null","fvalid_func","fformat_func","fdescription","fsecure","fmax_str","fmin_str","fmax_number","fmin_number","fmax_ts","fmin_ts","funique","fformat_number","fformat_ts"]})):s()},projects.getActions=function(e,t,s){"getActions"==e.storageFn?(log.debug({cls:"projects",fn:"getActions"}),projects.sendTableRecords({request:e,response:t,storageCode:e.storageCode,table:"taction",fields:["fid","fclass_id","fname","fcode","fdescription","forder","fbody","fconfirm","flayout"]})):s()},projects.getActionAttrs=function(e,t,s){"getActionAttrs"==e.storageFn?projects.send({request:e,response:t,msg:"{header: {error: ''}, data: []}"}):s()},projects.getViews=function(e,t,s){"getViews"==e.storageFn?(log.debug({cls:"projects",fn:"getViews"}),projects.sendTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tview",fields:["fid","fparent_id","fname","fcode","fdescription","flayout","fkey","fparent_key","fclass_id","funrelated","fquery","ftype","fsystem","fmaterialized","forder","fschema_id","frecord_id","ficon_cls"]})):s()},projects.getViewAttrs=function(e,t,s){"getViewAttrs"==e.storageFn?(log.debug({cls:"projects",fn:"getViewAttrs"}),projects.sendTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tview_attr",fields:["fid","fview_id","fname","fcode","fclass_id","fclass_attr_id","fsubject_id","forder","fsort_kind","fsort_order","foperation","fvalue","farea","fcolumn_width","ftotal_type","fread_only","fgroup","fnot_null"]})):s()},projects.services.accountActivate=function(e,t,s){if(e.url.indexOf("/services")==-1||!e.query.account_activate)return void s();var n=e.query.account_activate,r=e.query.hash,o={id:"account_activate_"+n,username:"admin",userId:null},i=e.url.split("/");i=i[i.indexOf("projects")+1];var a=projects.storagePool[i],c={select:[{a:"id"},"id",{a:"email"},"email",{a:"password"},"password"],from:[{a:"subject.human"}],where:[{a:"id"},"=",n]};a.execute({session:o,sql:c,success:function(e){var s=e.result.rows;if(s.length){var i=s[0].email_,c=s[0].password_;c==r&&async.series([function(e){a.startTransaction({session:o,remoteAddr:"127.0.0.1",description:"account_activate_"+n,success:function(){e()},failure:function(t){e(t.error)}})},function(e){a.getObject({session:o,id:n,success:function(t){var s=t.object;s?(s.set("login",i),s.commit({session:o,success:function(){e()}})):e("no object")}})},function(e){a.commitTransaction({session:o,success:function(){e()},failure:function(t){e(t.error)}})}],function(e,s){e?a.rollbackTransaction({session:o,success:function(){t.send("<html><body>.     .</body></html>")}}):t.send("<html><body>   .</body></html>")})}else t.send("<html><body>.     .</body></html>")}})},projects.services.restorePassword=function(e,t,s){if(e.url.indexOf("/services")==-1||!e.query.restore_password)return void s();var n=e.url.split("/");n=n[n.indexOf("projects")+1];var r=projects.storagePool[n],o=e.query.restore_password,i={select:[{a:"id"},"id",{a:"email"},"email",{a:"password"},"password"],from:[{a:"subject.human"}],where:[{a:"email"},"=",o]};r.execute({sql:i,success:function(s){var n=s.result.rows;if(n.length){var r=n[0].id_,i=n[0].password_,a=e.query.host,c=e.query.sender,f=e.query.port,l=e.query.storage,d="http://"+a+":"+f+"/projects/"+l+"/services?reset_password="+r+"&hash="+i+"&host="+a;mailSender.send({to:o,from:c,subject:"  "+a,message:"       <a target='_blank' href='"+d+"'>"+d+"</a>",success:function(){t.send("success")},failure:function(e){t.send("error")}})}else t.send("error")}})},projects.services.resetPassword=function(e,t,s){if(e.url.indexOf("/services")==-1||!e.query.reset_password)return void s();var n=e.url.split("/");n=n[n.indexOf("projects")+1];var r=projects.storagePool[n],o="<html><body>.     .</body></html>",i=e.query.reset_password,a=e.query.host,c=e.query.hash,f={id:"reset_password_"+i,username:"admin",userId:null},l={select:[{a:"id"},"id",{a:"email"},"email",{a:"password"},"password"],from:[{a:"subject.human"}],where:[{a:"id"},"=",i]};r.execute({session:f,sql:l,success:function(e){var s=e.result.rows;if(s.length){var n=s[0].password_;if(c==n){var l=s[0].email_,d=String(common.randomInt(1e6,9e6));async.series([function(e){r.startTransaction({session:f,remoteAddr:"127.0.0.1",description:"reset_password_"+i,success:function(){e()},failure:function(t){e(t.error)}})},function(e){r.getObject({session:f,id:i,success:function(t){var s=t.object;s.set("password",sha.hex_sha1(d)),s.commit({session:f,success:function(){e()}})}})},function(e){r.commitTransaction({session:f,success:function(){e()},failure:function(t){e(t.error)}})}],function(e,s){e?r.rollbackTransaction({session:f,success:function(){t.send(o)}}):(o="<html><body>  : "+d+"</body></html>",t.send(o),mailSender.send({to:l,from:"noreply@"+a,subject:"  "+a,message:"  : "+d}))})}}else t.send(o)}})},projects.gate1c=function(e,t,s){if(e.url.indexOf("/1c?")>-1){var n=JSON.parse(e.body),r=http.request({hostname:n.host,port:n.port,path:n.path,method:"POST",headers:{"Content-Type":"text/xml; charset=utf-8","Content-Length":Buffer.byteLength(e.body,"utf8")}},function(e){e.setEncoding("utf8");var s;e.on("error",function(e){t.send("{error: '"+e+"'}")}),e.on("data",function(e){s?s+=e:s=e}),e.on("end",function(e){t.send(s)})});r.on("error",function(e){t.send("{error: '"+e+"'}")}),r.end(e.body)}else s()},this.common=common,this.config=config,this.Export=Export,this.Import=Import,this.mailSender=mailSender,this.meta=meta,this.mimetypes=mimetypes,this.projects=projects,this.Query=Query,this.server=server,this.sha=sha,this.Storage=Storage,this.db=db,this.xmlss=xmlss,this.Dbf=Dbf,this.async=async,this.sha=sha,this.tm=tm,this.log=log,this.modules={async:async,pg:pg,util:util,fs:fs,http:http,url:url,redis:redis,pg:pg,express:express,nodemailer:nodemailer,simplesmtp:simplesmtp,_:_}};