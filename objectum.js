exports.Objectum=function(config){function msgLog(e,t,s){e<config.log.levelNum||(t=t||{},"string"==typeof t&&(t={msg:t}),t.msg=t.msg||s,t.level=e,common.log({file:config.rootDir+"/objectum-bunyan.log",text:util.inspect(t,{depth:null})}))}function b64_sha1(e){return binb2b64(core_sha1(str2binb(e),e.length*chrsz))}function str_sha1(e){return binb2str(core_sha1(str2binb(e),e.length*chrsz))}function hex_hmac_sha1(e,t){return binb2hex(core_hmac_sha1(e,t))}function b64_hmac_sha1(e,t){return binb2b64(core_hmac_sha1(e,t))}function str_hmac_sha1(e,t){return binb2str(core_hmac_sha1(e,t))}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc")}function core_sha1(e,t){e[t>>5]|=128<<24-t%32,e[(t+64>>9<<4)+15]=t;for(var s=Array(80),r=1732584193,n=-271733879,o=-1732584194,i=271733878,a=-1009589776,c=0;c<e.length;c+=16){for(var l=r,f=n,u=o,d=i,g=a,p=0;p<80;p++){p<16?s[p]=e[c+p]:s[p]=rol(s[p-3]^s[p-8]^s[p-14]^s[p-16],1);var m=safe_add(safe_add(rol(r,5),sha1_ft(p,n,o,i)),safe_add(safe_add(a,s[p]),sha1_kt(p)));a=i,i=o,o=rol(n,30),n=r,r=m}r=safe_add(r,l),n=safe_add(n,f),o=safe_add(o,u),i=safe_add(i,d),a=safe_add(a,g)}return Array(r,n,o,i,a)}function sha1_ft(e,t,s,r){return e<20?t&s|~t&r:e<40?t^s^r:e<60?t&s|t&r|s&r:t^s^r}function sha1_kt(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function core_hmac_sha1(e,t){var s=str2binb(e);s.length>16&&(s=core_sha1(s,e.length*chrsz));for(var r=Array(16),n=Array(16),o=0;o<16;o++)r[o]=909522486^s[o],n[o]=1549556828^s[o];var i=core_sha1(r.concat(str2binb(t)),512+t.length*chrsz);return core_sha1(n.concat(i),672)}function safe_add(e,t){var s=(65535&e)+(65535&t),r=(e>>16)+(t>>16)+(s>>16);return r<<16|65535&s}function rol(e,t){return e<<t|e>>>32-t}function str2binb(e){for(var t=Array(),s=(1<<chrsz)-1,r=0;r<e.length*chrsz;r+=chrsz)t[r>>5]|=(e.charCodeAt(r/chrsz)&s)<<32-chrsz-r%32;return t}function binb2str(e){for(var t="",s=(1<<chrsz)-1,r=0;r<32*e.length;r+=chrsz)t+=String.fromCharCode(e[r>>5]>>>32-chrsz-r%32&s);return t}function binb2hex(e){for(var t=hexcase?"0123456789ABCDEF":"0123456789abcdef",s="",r=0;r<4*e.length;r++)s+=t.charAt(e[r>>2]>>8*(3-r%4)+4&15)+t.charAt(e[r>>2]>>8*(3-r%4)&15);return s}function binb2b64(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s="",r=0;r<4*e.length;r+=3)for(var n=(e[r>>2]>>8*(3-r%4)&255)<<16|(e[r+1>>2]>>8*(3-(r+1)%4)&255)<<8|e[r+2>>2]>>8*(3-(r+2)%4)&255,o=0;o<4;o++)s+=8*r+6*o>32*e.length?b64pad:t.charAt(n>>6*(3-o)&63);return s}function Cell(e,t,s,r,n){var o=this;o.text=e||"",o.style=t||"none",o.colspan=s||1,o.rowspan=r||1,o.index=n||0}function Sheet(e){this.xml=e,this.colWidth={},this.sheetName=[],this.rowSheetId={},this.orientation=[],this.validation=[],this.namedRange=[],this.scale=[],this.marginTop=[],this.marginBottom=[],this.marginLeft=[],this.marginRight=[],this.autoFitHeight=[]}function XMLSS(e){e=e||{};var t=this;t.paperSizeIndex=9,t.fitWidth=0,t.fitHeight=0,t.zoom=90,t.marginBottom=2.5,t.marginLeft=2,t.marginRight=2,t.marginTop=2.5,t.autoFitHeight=0,t.workSheetName="Sheet1",t.clearColWidth(),t.orientation="Portrait",t.showPageBreakZoom=!1,t.printTitlesRow1=0,t.printTitlesRow2=0,t.fontSize=10,t.defRowHeight=e.defRowHeight||12.75,t.setDefaultStyles(),t.sheet=new Sheet(this),t.data=[],t.rowStartIndex=[],t.rowHeight=[],t.colWidth={}}var _=require("underscore");if(config||(config=require("./config")),config.auth||(config.auth={multi:!0}),config.backlog=config.backlog||1e4,config.caching||(config.caching={enabled:0}),config.admin||(config.admin={ip:["127.0.0.1"]}),config.session||(config.session={timeoutInterval:12e4,gcInterval:3e5}),config.news||(config.news={pollingInterval:5e3,gcInterval:3e5}),config.wwwRoot=__dirname+"/www",_.isArray(config.storages)&&config.projectsDir){var storages={};_.each(config.storages,function(e){storages[e]=require(config.projectsDir+"/"+e+"/config.json")}),config.storages=storages}var async=require("async"),pg=require("pg");pg.defaults.poolSize=0,pg.defaults.poolIdleTimeout=12e4,pg.defaults.reapIntervalMillis=6e4;var util=require("util"),fs=require("fs"),http=require("http"),url=require("url"),redis;config.redis&&config.redis.enabled&&(redis=require("redis"));var pg=require("pg"),express=require("express"),formidable=require("formidable"),nodemailer=require("nodemailer"),simplesmtp=require("simplesmtp"),smtp=simplesmtp.createServer(),MailParser=require("mailparser").MailParser,VError=require("verror"),Backbone=require("backbone"),log;try{config.log=config.log||{},config.log.level=config.log.level||"info";var bunyan=require("bunyan");log=bunyan.createLogger({name:"objectum",level:config.log.level||"info",streams:[{stream:process.stdout},{path:__dirname+"/objectum-bunyan.log"}]})}catch(e){var levelNum={fatal:60,error:50,warn:40,info:30,debug:20,trace:10};config.log.levelNum=levelNum[config.log.level],log={fatal:function(e,t){msgLog(60,e,t)},error:function(e,t){msgLog(50,e,t)},warn:function(e,t){msgLog(40,e,t)},info:function(e,t){msgLog(30,e,t)},debug:function(e,t){msgLog(20,e,t)},trace:function(e,t){msgLog(10,e,t)}}}var sql;if("win32"==process.platform&&(!config.mssql||config.mssql.enabled)){var tokens=process.version.split(".");if(tokens[1]<=8&&tokens[2]<=26)try{sql=require("msnodesql")}catch(e){}}var redisEmulator={m:{},del:function(e,t){delete this.m[e],t&&t(null,!0)},keys:function(e,t){var s=[];if(e&&"*"==e[e.length-1]){var r=e.substr(0,e.length-1);for(var n in this.m)n.substr(0,r.length)==r&&s.push(n)}t&&t(null,s)},subscribers:[],on:function(e,t){this.subscribers.push(t)},subscribe:function(e){},publish:function(e,t){for(var s=0;s<this.subscribers.length;s++)this.subscribers[s](e,t)},incrby:function(e,t,s){this.m[e]=this.m[e]||0,this.m[e]=Number(this.m[e])+t,s&&s(null,String(this.m[e]))},get:function(e,t){t&&t(null,this.m[e]||null)},set:function(e,t,s){this.m[e]=String(t),s&&s(null,!0)},hincrby:function(e,t,s,r){this.m[e]=this.m[e]||{},this.m[e][t]=this.m[e][t]||0,this.m[e][t]=Number(this.m[e][t])+s,r&&r(null,String(this.m[e][t]))},hdel:function(){for(var e=arguments[0],t=1;t<arguments.length;t++)"function"!=typeof arguments[t]&&this.m[e]&&this.m[e][arguments[t]]&&delete this.m[e][arguments[t]];"function"==typeof arguments[arguments.length-1]&&arguments[arguments.length-1](null,!0)},hset:function(e,t,s,r){this.m[e]=this.m[e]||{},this.m[e][t]=String(s),r&&r(null,!0)},hmset:function(e,t,s){this.m[e]=this.m[e]||{};for(var r in t)this.m[e][r]=String(t[r]);s&&s(null,!0)},hget:function(e,t,s){this.m[e]=this.m[e]||{},s&&s(null,this.m[e][t])},hmget:function(e,t,s){this.m[e]=this.m[e]||{};for(var r=[],n=0;n<t.length;n++)r.push(this.m[e][t[n]]);s&&s(null,r)},hgetall:function(e,t){var s={};for(var r in this.m[e])s[r]=this.m[e][r];t&&t(null,s)},hsetnx:function(e,t,s,r){this.m[e]=this.m[e]||{};var n=0;this.m[e][t]||(this.m[e][t]=s,n=1),r&&r(null,n)},hkeys:function(e,t){var s=[];for(var r in this.m[e])s.push(r);t&&t(null,s)},sadd:function(e,t,s){this.m[e]=this.m[e]||[],this.m[e].indexOf(t)==-1?(this.m[e].push(String(t)),s&&s(null,!0)):s&&s(!0,!1)},sismember:function(e,t,s){this.m[e]=this.m[e]||[],s&&s(null,this.m[e].indexOf(t)>-1)},srem:function(e,t,s){this.m[e]=this.m[e]||[];var r=this.m[e].indexOf(String(t));r>-1&&this.m[e].splice(r,1),s&&s(null,!0)},smembers:function(e,t){this.m[e]=this.m[e]||[],t&&t(null,this.m[e])},lpush:function(e,t){this.m[e]=this.m[e]||[],this.m[e]=[t].concat(this.m[e]),e.indexOf("service.log")>-1&&console.log(e+" lpush "+this.m[e])},ltrim:function(e,t,s){this.m[e]=this.m[e]||[],this.m[e]=this.m[e].slice(t,s+1),e.indexOf("service.log")>-1&&console.log(e+" ltrim "+this.m[e])},lrange:function(e,t,s,r){this.m[e]=this.m[e]||[],s=s==-1?this.m[e].length-1:s,r&&r(null,this.m[e].slice(t,s+1)),e.indexOf("service.log")>-1&&console.log(e+" lrange "+this.m[e])},select:function(e,t){t()},quit:function(){}};config.redis.enabled||(redis={createClient:function(){return redisEmulator}});var redisClient,redisPub,redisSub,common={};common.getDate=function(e){if(!e)return"";var t=e.getDate(),s=e.getMonth()+1,r=e.getFullYear(),n="";return t<10&&(n+="0"),n+=String(t)+".",s<10&&(n+="0"),n+=String(s)+".",n+=String(r)},common.getDateISO=function(e){if(!e)return"";var t=e.getDate(),s=e.getMonth()+1,r=e.getFullYear(),n=String(r)+"-";return s<10&&(n+="0"),n+=String(s)+"-",t<10&&(n+="0"),n+=String(t)},common.getDateFromDDMMYYYY=function(e){var t=null;return e&&10==e.length&&"."==e[2]&&"."==e[5]&&(t=new Date(e.substr(6,4),e.substr(3,2)-1,e.substr(0,2))),t},common.getLocalISOString=function(e){function t(e){var t="";return e<10&&(t+="0"),t+=e}var s=e.getFullYear()+"-";return s+=t(e.getMonth()+1)+"-",s+=t(e.getDate())+"T",s+=t(e.getHours())+":",s+=t(e.getMinutes())+":",s+=t(e.getSeconds())+".000Z"},common.getUTCDate=function(e){var t=e.getUTCDate(),s=e.getUTCMonth()+1,r=e.getUTCFullYear(),n="";return t<10&&(n+="0"),n+=String(t)+".",s<10&&(n+="0"),n+=String(s)+".",n+=String(r)},common.getTime=function(e){var t=e.getHours(),s=e.getMinutes(),r=e.getSeconds(),n="";return t<10&&(n+="0"),n+=String(t)+":",s<10&&(n+="0"),n+=String(s)+":",r<10&&(n+="0"),n+=String(r)},common.getUTCTime=function(e){var t=e.getUTCHours(),s=e.getUTCMinutes(),r=e.getUTCSeconds(),n="";return t<10&&(n+="0"),n+=String(t)+":",s<10&&(n+="0"),n+=String(s)+":",r<10&&(n+="0"),n+=String(r)},common.currentDate=function(){var e=new Date,t=e.getDate(),s=e.getMonth()+1,r=e.getFullYear(),n="";return t<10&&(n+="0"),n+=String(t)+".",s<10&&(n+="0"),n+=String(s)+".",n+=String(r)},common.currentUTCDate=function(){var e=new Date,t=e.getUTCDate(),s=e.getUTCMonth()+1,r=e.getUTCFullYear(),n="";return t<10&&(n+="0"),n+=String(t)+".",s<10&&(n+="0"),n+=String(s)+".",n+=String(r)},common.currentTime=function(e){var t=new Date,s=t.getHours(),r=t.getMinutes(),n=t.getSeconds(),o="";if(s<10&&(o+="0"),o+=String(s)+":",r<10&&(o+="0"),o+=String(r)+":",n<10&&(o+="0"),o+=String(n),e&&e.msec){o+=".";var i=t.getMilliseconds();i<100&&(o+="0"),i<10&&(o+="0"),o+=String(i)}return o},common.currentUTCTime=function(e){var t=new Date,s=t.getUTCHours(),r=t.getUTCMinutes(),n=t.getUTCSeconds(),o="";if(s<10&&(o+="0"),o+=String(s)+":",r<10&&(o+="0"),o+=String(r)+":",n<10&&(o+="0"),o+=String(n),e&&e.msec){o+=".";var i=t.getUTCMilliseconds();i<100&&(o+="0"),i<10&&(o+="0"),o+=String(i)}return o},common.currentTimestamp=function(){return common.currentDate()+" "+common.currentTime()},common.currentUTCTimestamp=function(){return common.currentUTCDate()+" "+common.currentUTCTime()},common.getTimestamp=function(e){return common.getDate(e)+" "+common.getTime(e)},common.getUTCTimestamp=function(e){return common.getUTCDate(e)+" "+common.getUTCTime(e)},common.getJulianDay=function(e){if(""==e)return 0;var t=e.getDate(),s=e.getMonth()+1,r=e.getFullYear();return jd=Math.floor(1461*(r+4800+(s-14)/12))/4+Math.floor(Math.floor(367*(s-2-12*((s-14)/12)))/12)-3*Math.floor(Math.floor(r+4900+(s-14)/12)/100)/4+t-32075,jd},common.getDateByJulianDay=function(e){var t,s,r,n,o,i,a;return t=e+68569,s=Math.floor(4*t/146097),t=Math.floor(t-(146097*s+3)/4),r=Math.floor(4e3*(t+1)/1461001),t=t-Math.floor(1461*r/4)+31,n=Math.floor(80*t/2447),o=t-Math.floor(2447*n/80),t=Math.floor(n/11),i=n+2-12*t,a=100*(s-49)+r+t,new Date(a,i-1,o)},common.getRemoteAddress=function(e){var t=e.headers["x-real-ip"]||e.connection.remoteAddress;return t},common.ToJSONString=function(e,t){var s;if("string"==typeof e)s=JSON.stringify(e).split("\\\\u").join("\\u");else if(e&&"object"==typeof e)if(e.getMonth)s=0==e.getUTCHours()&&0==e.getUTCMinutes()&&0==e.getUTCSeconds()&&0==e.getUTCMilliseconds()||0==e.getHours()&&0==e.getMinutes()&&0==e.getSeconds()&&0==e.getMilliseconds()?"new Date ("+e.getFullYear()+","+e.getMonth()+","+e.getDate()+")":"new Date (Date.UTC ("+e.getFullYear()+","+e.getMonth()+","+e.getDate()+","+e.getHours()+","+e.getMinutes()+","+e.getSeconds()+"))";else if(common.isArray(e)){s="[";for(var r=0;r<e.length;r++)r&&(s+=", "),s+=common.ToJSONString(e[r]);s+="]"}else{s="{";for(var n in e)"{"!=s&&(s+=", "),s+='"'+n+'": '+common.ToJSONString(e[n]);s+="}"}else s=e;return s},common.ToSQLString=function(e,t){var s;return"mssql"==t?"string"==typeof e?s="'"+e.split("'").join("''")+"'":e&&"object"==typeof e&&e.getMonth?e="'"+common.getUTCTimestamp(e)+"'":(s=e,null===s&&(s="null")):"string"==typeof e?s="'"+common.unescape(e.split("\\").join("\\\\").split("\n").join("\\n").split("\r").join("\\r").split("'").join("\\'"))+"'":e&&"object"==typeof e&&e.getMonth?e="'"+common.getUTCTimestamp(e)+"'":(s=e,null===s&&(s="null")),s},common.isEqualDates=function(e,t){return!(e&&!t||!e&&t)&&(e.getUTCFullYear()==t.getUTCFullYear()&&e.getUTCMonth()==t.getUTCMonth()&&e.getUTCDate()==t.getUTCDate()&&e.getUTCHours()==t.getUTCHours()&&e.getUTCMinutes()==t.getUTCMinutes()&&e.getUTCSeconds()==t.getUTCSeconds())},common.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)};var DMap={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:11,12:12,13:13,14:14,15:15,16:16,17:17,18:18,19:19,20:20,21:21,22:22,23:23,24:24,25:25,26:26,27:27,28:28,29:29,30:30,31:31,32:32,33:33,34:34,35:35,36:36,37:37,38:38,39:39,40:40,41:41,42:42,43:43,44:44,45:45,46:46,47:47,48:48,49:49,50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57,58:58,59:59,60:60,61:61,62:62,63:63,64:64,65:65,66:66,67:67,68:68,69:69,70:70,71:71,72:72,73:73,74:74,75:75,76:76,77:77,78:78,79:79,80:80,81:81,82:82,83:83,84:84,85:85,86:86,87:87,88:88,89:89,90:90,91:91,92:92,93:93,94:94,95:95,96:96,97:97,98:98,99:99,100:100,101:101,102:102,103:103,104:104,105:105,106:106,107:107,108:108,109:109,110:110,111:111,112:112,113:113,114:114,115:115,116:116,117:117,118:118,119:119,120:120,121:121,122:122,123:123,124:124,125:125,126:126,127:127,1027:129,8225:135,1046:198,8222:132,1047:199,1168:165,1048:200,1113:154,1049:201,1045:197,1050:202,1028:170,160:160,1040:192,1051:203,164:164,166:166,167:167,169:169,171:171,172:172,173:173,174:174,1053:205,176:176,177:177,1114:156,181:181,182:182,183:183,8221:148,187:187,1029:189,1056:208,1057:209,1058:210,8364:136,1112:188,1115:158,1059:211,1060:212,1030:178,1061:213,1062:214,1063:215,1116:157,1064:216,1065:217,1031:175,1066:218,1067:219,1068:220,1069:221,1070:222,1032:163,8226:149,1071:223,1072:224,8482:153,1073:225,8240:137,1118:162,1074:226,1110:179,8230:133,1075:227,1033:138,1076:228,1077:229,8211:150,1078:230,1119:159,1079:231,1042:194,1080:232,1034:140,1025:168,1081:233,1082:234,8212:151,1083:235,1169:180,1084:236,1052:204,1085:237,1035:142,1086:238,1087:239,1088:240,1089:241,1090:242,1036:141,1041:193,1091:243,1092:244,8224:134,1093:245,8470:185,1094:246,1054:206,1095:247,1096:248,8249:139,1097:249,1098:250,1044:196,1099:251,1111:191,1055:207,1100:252,1038:161,8220:147,1101:253,8250:155,1102:254,8216:145,1103:255,1043:195,1105:184,1039:143,1026:128,1106:144,8218:130,1107:131,8217:146,1108:186,1109:190};common.UnicodeToWin1251=function(e){var t=[];if(!e||!e.length)return e;for(var s=0;s<e.length;s++){var r=e.charCodeAt(s);if(!(r in DMap))throw"Character "+e.charAt(s)+" isn't supported by win1251!";t.push(String.fromCharCode(DMap[r]))}return t.join("")},common.unescape=function(e){if(!e)return e;if("object"==typeof e){if(e.getMonth)return e;if(common.isArray(e))for(var t=0;t<e.length;t++)e[t]=common.unescape(e[t]);else for(var s in e)e[s]=common.unescape(e[s]);return e}if("string"==typeof e){var r=/\\u([\d\w]{4})/gi,n=e.replace(r,function(e,t){return String.fromCharCode(parseInt(t,16))});return n=unescape(n)}return e},common.randomInt=function(e,t){return Math.floor(Math.random()*(t-e+1))+e},common.getCookies=function(e){if(!e)return{};for(var t=e.split(";"),s={},r=0;r<t.length;r++){var n=t[r].split("=");s[n[0].fulltrim()]=n[1]}return s},String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.ltrim=function(){return this.replace(/^\s+/,"")},String.prototype.rtrim=function(){return this.replace(/\s+$/,"")},String.prototype.fulltrim=function(){return this.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},common.clone=function(e){if(!e||"object"!=typeof e)return e;if("object"==typeof e&&e&&e.getMonth)return new Date(e.getTime());var t,s,r="function"==typeof e.pop?[]:{};for(t in e)e.hasOwnProperty(t)&&(s=e[t],s&&"object"==typeof s?r[t]=common.clone(s):r[t]=s);return r};var logFile="server.log";common.log=function(e){if("string"!=typeof e&&"number"!=typeof e||(e={text:e}),e.file&&(logFile=e.file),e.text){var t="["+common.currentDate()+" "+common.currentTime({msec:!0})+"] "+e.text;e.silent||console.log(e.text),fs.appendFile(logFile,t+"\n",function(e){e&&console.error(e)})}},common.getText=function(e,t){process.stdin.setEncoding("utf8"),console.log(e.title),process.stdin.on("data",function(e){e=e.split("\n").join(""),t(e)})};var ifields={tclass:["fid","fparent_id","fname","fcode","fdescription","fformat","fview_id","ftype","fsystem","fschema_id","frecord_id","fstart_id","fend_id"],tclass_attr:["fid","fclass_id","fname","fcode","ftype_id","forder","fnot_null","fvalid_func","fformat_func","fdescription","fsecure","fmax_str","fmin_str","fmax_number","fmin_number","fmax_ts","fmin_ts","funique","fformat_number","fformat_ts","fremove_rule","fschema_id","frecord_id","fstart_id","fend_id"],tview:["fid","fparent_id","fname","fcode","fdescription","flayout","fkey","fparent_key","fclass_id","funrelated","fquery","ftype","fsystem","fmaterialized","forder","fschema_id","frecord_id","ficon_cls","fstart_id","fend_id"],tview_attr:["fid","fview_id","fname","fcode","fclass_id","fclass_attr_id","fsubject_id","forder","fsort_kind","fsort_order","foperation","fvalue","farea","fcolumn_width","ftotal_type","fread_only","fgroup","fnot_null","fschema_id","frecord_id","fstart_id","fend_id"],taction:["fid","fclass_id","fname","fcode","fdescription","forder","fbody","fconfirm","flayout","fschema_id","frecord_id","fstart_id","fend_id"],tobject:["fid","fclass_id","fschema_id","frecord_id","fstart_id","fend_id"],tobject_attr:["fid","fobject_id","fclass_attr_id","fstring","fnumber","ftime","fschema_id","frecord_id","fstart_id","fend_id"],trevision:["fid","fdate","fdescription","fschema_id","frecord_id"],tschema:["fid","fparent_id","fname","fcode"]},Export=function(){var e;this.data={},this.classesId=[],this.viewsId=[],this.except={},this.currentSchemaId=null,this.getTopClassesCodes=function(t){log.info({cls:"Export",fn:"getTopClassesCodes"});var s=t.success;e.query({sql:"select\n\tdistinct (a.fid) as fid\nfrom\n\ttclass a\nwhere\n\ta.fparent_id is null and a.fid >= 1000\n",success:function(e){for(var t=e.result.rows,r=[],n=0;n<t.length;n++)r.push(t[n].fid);s(r)}})},this.getTopViewsCodes=function(t){log.info({cls:"Export",fn:"getTopViewsCodes"});var s=t.success;e.query({sql:"select\n\tdistinct (a.fid) as fid\nfrom\n\ttview a\nwhere\n\ta.fparent_id is null\n",success:function(e){for(var t=e.result.rows,r=[],n=0;n<t.length;n++)r.push(t[n].fid);s(r)}})},this.getNodesId=function(t){var s=this,r=[],n=t.success,o=t.table;async.mapSeries(t.codes,function(t,n){var i;async.series([function(s){if("number"==String(typeof t).toLowerCase())i=t,s();else{var r="select\n\tdistinct (a.fid) as fid\nfrom\n\t"+o+" a\nwhere\n\ta.fcode='"+t+"' and a.fparent_id is null\n";e.query({sql:r,success:function(e){i=e.result.rows[0].fid,s()}})}},function(t){r.push(i),e.query({sql:"select\n\tdistinct (a.fid) as fid\nfrom\n\t"+o+" a\nwhere\n\ta.fparent_id="+i+"\norder by a.fid\n",success:function(e){for(var n=e.result.rows,i=[],a=0;a<n.length;a++){var c=n[a].fid;i.push(c)}i.length?s.getNodesId({table:o,codes:i,success:function(e){for(var s=0;s<e.length;s++)r.push(e[s]);t()}}):t()}})}],function(e,t){n()})},function(e,t){n(r)})},this.exportClasses=function(t){log.info({cls:"Export",fn:"exportClasses"});var s=this,r=t.success,n=s.data.options.classes;async.series([function(e){s.getNodesId({table:"tclass",codes:n,success:function(t){s.classesId=t,e()}})},function(t){s.classesId.length&&(s.data.tclass=[],e.query({sql:"select\n\t"+ifields.tclass.join()+"\nfrom\n\ttclass a\nwhere\n\ta.fid in ("+s.classesId.join()+")\norder by\n\ta.fid, a.fstart_id\n",success:function(e){for(var r=e.result.rows,n=0;n<r.length;n++){for(var o=[],i=0;i<ifields.tclass.length;i++){var a=ifields.tclass[i],c=r[n][a];if("fcode"==a&&!c)throw"exportClasses (): fcode must be not null. FID="+r[n].fid;"fschema_id"==a&&null==c&&(c=s.currentSchemaId),"frecord_id"==a&&null==c&&(c=r[n].fid),o.push(c)}var l={};l.values=o,s.data.tclass.push(l)}t()}}))}],function(e,t){r()})},this.exportClassAttrs=function(t){var s=this,r=t.success;s.data.tclass_attr=[],e.query({sql:"select\n\t"+ifields.tclass_attr.join()+"\nfrom\n\ttclass_attr a\nwhere\n\ta.fclass_id in ("+s.classesId.join()+")\norder by\n\ta.fid, a.fstart_id\n",success:function(e){for(var t=e.result.rows,n=0;n<t.length;n++){var o={};o.values=[];for(var i=0;i<ifields.tclass_attr.length;i++){var a=ifields.tclass_attr[i],c=t[n][a];"fschema_id"==a&&null==c&&(c=s.currentSchemaId),"frecord_id"==a&&null==c&&(c=t[n].fid),o.values.push(c)}s.data.tclass_attr.push(o)}r()}})},this.exportActions=function(t){var s=this,r=t.success;s.data.taction=[],e.query({sql:"select\n\t"+ifields.taction.join()+"\nfrom\n\ttaction a\nwhere\n\ta.fclass_id in ("+s.classesId.join()+")\norder by\n\ta.fid, a.fstart_id\n",success:function(e){for(var t=e.result.rows,n=0;n<t.length;n++){var o={};o.values=[];for(var i=0;i<ifields.taction.length;i++){var a=ifields.taction[i],c=t[n][a];"fschema_id"==a&&null==c&&(c=s.currentSchemaId),"frecord_id"==a&&null==c&&(c=t[n].fid),o.values.push(c)}t[n].fid;s.data.taction.push(o)}r()}})},this.exportObjects=function(t){var s=this,r=t.success;s.data.tobject=[];var n=[];if(s.except.tobject&&s.except.tobject.fclass_id.length)for(var o=s.except.tobject.fclass_id,i=0;i<s.classesId.length;i++)o.indexOf(s.classesId[i])==-1&&n.push(s.classesId[i]);else n=s.classesId;e.query({sql:"select\n\t"+ifields.tobject.join()+"\nfrom\n\ttobject a\nwhere\n\ta.fclass_id in ("+n.join()+")\norder by\n\ta.fid, a.fstart_id\n",success:function(e){for(var t=e.result.rows,n=0;n<t.length;n++){var o={};o.values=[];for(var i=0;i<ifields.tobject.length;i++){var a=ifields.tobject[i],c=t[n][a];"fschema_id"==a&&null==c&&(c=s.currentSchemaId),"frecord_id"==a&&null==c&&(c=t[n].fid),o.values.push(c)}s.data.tobject.push(o)}r()}})},this.exportObjectAttrs=function(t){var s=this,r=t.success;s.data.tobject_attr=[];var n=[];if(s.except.tobject&&s.except.tobject.fclass_id.length)for(var o=s.except.tobject.fclass_id,i=0;i<s.classesId.length;i++)o.indexOf(s.classesId[i])==-1&&n.push(s.classesId[i]);else n=s.classesId;e.query({sql:"select\n\t"+ifields.tobject_attr.join()+"\nfrom\n\ttobject_attr a\nwhere\n\ta.fobject_id in (select b.fid from tobject b where b.fclass_id in ("+n.join()+"))\norder by\n\ta.fid, a.fstart_id\n",success:function(e){for(var t=e.result.rows,n=0;n<t.length;n++){var o={};o.values=[];for(var i=0;i<ifields.tobject_attr.length;i++){var a=ifields.tobject_attr[i],c=t[n][a];"fschema_id"==a&&null==c&&(c=s.currentSchemaId),"frecord_id"==a&&null==c&&(c=t[n].fid),o.values.push(c)}s.data.tobject_attr.push(o)}r()}})},this.exportViews=function(t){var s=this,r=t.success;log.info({cls:"Export",fn:"exportViews"});var n=s.data.options.views;s.getNodesId({table:"tview",codes:n,success:function(t){s.viewsId=t,s.viewsId.length&&(s.data.tview=[],e.query({sql:"select\n\t"+ifields.tview.join()+"\nfrom\n\ttview a\nwhere\n\ta.fid in ("+s.viewsId.join()+")\norder by\n\ta.fid, a.fstart_id\n",success:function(e){var t=e.result.rows;for(k=0;k<t.length;k++){for(var n=[],o=0;o<ifields.tview.length;o++){var i=ifields.tview[o],a=t[k][i];if("fcode"==i&&!a)throw"exportViews (): fcode must be not null. fid="+t[k].fid;"fschema_id"==i&&null==a&&(a=s.currentSchemaId),"frecord_id"==i&&null==a&&(a=t[k].fid),n.push(a)}var c={};c.values=n,s.data.tview.push(c)}r()}}))}})},this.exportViewAttrs=function(t){var s=this,r=t.success;s.data.tview_attr=[],e.query({sql:"select\n\t"+ifields.tview_attr.join()+"\nfrom\n\ttview_attr a\nwhere\n\ta.fview_id in ("+s.viewsId.join()+")\norder by\n\ta.fid, a.fstart_id\n",success:function(e){for(var t=e.result.rows,n=0;n<t.length;n++){for(var o=[],i=0;i<ifields.tview_attr.length;i++){var a=ifields.tview_attr[i],c=t[n][a];"fschema_id"==a&&null==c&&(c=s.currentSchemaId),"frecord_id"==a&&null==c&&(c=t[n].fid),o.push(c)}s.data.tview_attr.push({values:o})}r()}})},this.exportRevisions=function(t){var s=this,r=t.success;log.info({cls:"Export",fn:"exportRevisions"}),e.query({sql:"select\n"+ifields.trevision.join()+"\nfrom trevision a\norder by a.fid\n",success:function(e){var t=e.result.rows;s.data.trevision=[];for(var n=0;n<t.length;n++){for(var o=[],i=0;i<ifields.trevision.length;i++){var a=ifields.trevision[i],c=t[n][a];"fschema_id"==a&&null==c&&(c=s.currentSchemaId),"frecord_id"==a&&null==c&&(c=t[n].fid),o.push(c)}var l={};l.values=o,s.data.trevision.push(l)}r()}})},this.exportSchemas=function(t){var s=this,r=t.success;log.info({cls:"Export",fn:"exportSchemas"}),e.query({sql:"select\n"+ifields.tschema.join()+"\nfrom tschema a\norder by a.fid\n",success:function(e){var t=e.result.rows;s.data.tschema=[];for(var n=0;n<t.length;n++){for(var o=[],i=0;i<ifields.tschema.length;i++){var a=ifields.tschema[i],c=t[n][a];o.push(c)}var l={};l.values=o,s.data.tschema.push(l)}r()}})},this.prepareExcept=function(t){var s=this,r=t.success,n=s.data.options.except;if(!n)return void r();var o=[];for(var i in n)o.push(i);async.mapSeries(o,function(t,r){var o=n[t],i=[];async.mapSeries(o,function(t,s){function r(t,s){i.indexOf(t)==-1&&i.push(t),e.query({sql:"select\n\tfid\nfrom\n\ttclass a\nwhere\n\ta.fparent_id = "+t+"\norder by\n\ta.fid, a.fstart_id\n",success:function(e){var t=e.result.rows;async.mapSeries(t,function(e,t){r(e.fid,function(){t()})},function(e,t){s()})}})}t.fclass_id&&("object"==String(typeof t.fclass_id).toLowerCase()&&t.fclass_id instanceof Array?async.mapSeries(t.fclass_id,function(t,s){r(e.getClass(t).get("fid"),function(){s()})},function(e,t){s()}):r(e.getClass(t.fclass_id).get("fid"),function(){s()}))},function(e,n){s.except[t]={},s.except[t].fclass_id=i,r()})},function(e,t){r()})},this.clearBadTimeFields=function(t){var s=t.success;log.info({cls:"Export",fn:"clearBadTimeFields"});var r;r="update tobject_attr set ftime=null\n",r+="where ftime<'01.01.1400'\n",e.query({sql:r,success:function(e){s()}})},this.fixReferences=function(t){var s=t.success;e.query({sql:"select min (fid) as fid from trevision",success:function(t){var r=t.result.rows;if(r.length>0){var n=r[0].fid,o=[];for(var i in ifields){var a=ifields[i].join();a.indexOf("fstart_id")!=-1&&(o.push("update "+i+" set fstart_id="+n+"\nwhere fstart_id not in (select fid from trevision)\n"),o.push("update "+i+" set fend_id="+n+"\nwhere fend_id <> "+e.maxRevision+" and fend_id not in (select fid from trevision)\n"))}async.mapSeries(o,function(t,s){e.query({sql:t,success:function(e){s()}})},function(e,t){s()})}}})},this.createSchema=function(t){var s=null,r=t.success,n=t.code;e.query({sql:"select fid from tschema where fcode='"+n+"'",success:function(t){var o=t.result.rows;if(0==o.length){var i=null;e.query({sql:"select max (fid) as fid from tschema",success:function(t){var o=t.result.rows;o.length&&(i=o[0].fid+1),null==i&&(i=1),e.query({sql:"insert into tschema (fid, fcode) values ("+i+",'"+n+"')",success:function(e){s=i,r(s)}})}})}else s=o[0].fid,r(s)}})},this.exportToFile=function(t){var s=this,r=t.success,n=(new Date).getTime();log.info({cls:"Export",fn:"exportToFile"}),s.data.options=t,async.series([function(r){t.storage?(e=s.storage=t.storage,r()):projects.loadConfig({code:t.code,success:function(){e=new Storage({code:t.code,connection:config.storages[t.code],success:function(){s.storageCreated=!0,r()}})},failure:function(e){r(e)}})},function(e){"all"==t.classes?s.getTopClassesCodes({success:function(s){t.classes=s,e()}}):e()},function(e){"all"==t.views?s.getTopViewsCodes({success:function(s){t.views=s,e()}}):e()},function(e){s.data.fields=ifields,s.clearBadTimeFields({success:function(){s.fixReferences({success:function(){s.createSchema({code:t.code,success:function(t){s.currentSchemaId=t,e()}})}})}})},function(e){s.exportClasses({success:function(){s.exportClassAttrs({success:function(){s.exportActions({success:function(){s.prepareExcept({success:function(){s.exportObjects({success:function(){s.exportObjectAttrs({success:function(){s.exportViews({success:function(){s.exportViewAttrs({success:function(){s.exportSchemas({success:function(){s.exportRevisions({success:function(){e()}})}})}})}})}})}})}})}})}})}})},function(e){s.data=common.unescape(s.data),t.space?fs.writeFile(t.file,JSON.stringify(s.data,0,t.space),function(t){e()}):fs.writeFile(t.file,JSON.stringify(s.data),function(t){e()})}],function(t,o){var i="";for(var a in ifields)s.data[a]&&(i+=a+": "+s.data[a].length+"\n");i+="queryCount: "+e.queryCount+"\n",i+="duration: "+((new Date).getTime()-n)/1e3+" sec.\n",log.info({cls:"Export",stat:i}),s.storageCreated&&e.freeResources(),r()})}},Import=function(){var e,t;this.data={},this.addGet=function(e){var t={};return t.values=e.values,t.fields=this.data.fields[e.table],t.get=function(e){for(var t=0;t<this.fields.length&&this.fields[t]!=e;t++);if(t==this.fields.length)throw"get: field '"+e+"'not exists in '"+this.fields.join()+"'";return this.values[t]},t},this.removeTrash=function(s){log.info({cls:"Import",fn:"removeTrash"});var r=s.success;async.series([function(s){async.forever(function(s){e.query({session:t,sql:"delete from tview a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fparent_id not in (select b.fid from tview b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(r){e.query({session:t,sql:"select count (*) as num from tview a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fparent_id not in (select b.fid from tview b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(e){var t=e.result.rows;0==t[0].num?s("end"):s()}})}})},function(e){s()})},function(s){e.query({session:t,sql:"delete from tview_attr a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fview_id not in (select b.fid from tview b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(e){s()}})},function(s){async.forever(function(s){e.query({session:t,sql:"delete from tclass a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fparent_id not in (select b.fid from tclass b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(r){e.query({session:t,sql:"select count (*) as num from tclass a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fparent_id not in (select b.fid from tclass b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(e){var t=e.result.rows;0==t[0].num?s("end"):s()}})}})},function(e){s()})},function(s){e.query({session:t,sql:"delete from tclass_attr a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fclass_id not in (select b.fid from tclass b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(e){s()}})},function(s){e.query({session:t,sql:"delete from taction a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fclass_id not in (select b.fid from tclass b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(e){s()}})},function(s){e.query({session:t,sql:"delete from tobject a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand a.fclass_id not in (select b.fid from tclass b where "+e.getCurrentFilter({alias:"b"})+")\n",success:function(e){s()}})},function(s){e.query({session:t,sql:"delete from tobject_attr a\nwhere\n"+e.getCurrentFilter({alias:"a"})+"\nand not exists (select b.fid from tobject b where b.fid=a.fobject_id and "+e.getCurrentFilter({alias:"b"})+")\n",success:function(e){s()}})}],function(e,t){r()})},this.prepareStorageForImport=function(s){var r=this,n=s.success;log.info({cls:"Import",fn:"prepareStorageForImport"}),async.series([function(s){async.eachSeries(r.data.views,function(s,n){var s=r.addGet({values:s.values,table:"tview"}),o=s.get("fcode"),i=s.get("fparent_id");""==i&&e.query({session:t,sql:"delete from tview where fparent_id is null and fcode='"+o+"'",success:function(e){n()}})},function(e){s()})},function(s){
async.eachSeries(r.data.classes,function(s,n){var s=r.addGet({values:s.values,table:"tclass"}),o=s.get("fcode"),i=s.get("fparent_id");""==i&&e.query({session:t,sql:"delete from tclass where fparent_id is null and fcode='"+o+"'",success:function(e){n()}})},function(e){s()})},function(e){r.removeTrash({success:function(){e()}})}],function(e,t){n()})},this.tableId={},this.newId={tclass:{},tclass_attr:{},tview:{},tview_attr:{},taction:{},taction_attr:{},tobject:{},tobject_attr:{},trevision:{},tschema:{}},this.count={tclass:0,tclass_attr:0,tview:0,tview_attr:0,taction:0,taction_attr:0,tobject:0,tobject_attr:0,trevision:0},this.classAttrType={},this.startRevision=null,this.startRevisionMin=null,this.getSequences=function(t){var s=this,r=t.success,n=t.session,o=["tclass","tclass_attr","tview","tview_attr","taction","taction_attr","tobject","tobject_attr","trevision"];async.eachSeries(o,function(t,r){e.client.getNextId({session:n,table:t,success:function(e){s.tableId[t]=e.id,r()}})},function(e){r()})},this.generateInsert=function(t){var s=[],r="";for(var n in t.fields)if(s.push(n),r&&(r+=","),null!=t.fields[n]){var o=t.fields[n];"string"==typeof o?24==o.length&&"T"==o[10]&&"Z"==o[23]?o="'"+common.getUTCTimestamp(new Date(o))+"'":(o=common.ToSQLString(o,e.client.database),"postgres"==e.client.database&&(o="E"+o)):"object"==typeof o&&o.getMonth&&(o="'"+common.getUTCTimestamp(o)+"'"),r+=o}else r+="null";var i;return i="insert into "+t.table+"(\n",i+=s.join(),i+="\n) values (\n",i+=r,i+="\n)\n"},this.incCount=function(e,t){this.count[e]++},this.importViews=function(s){var r=this,n=s.success;log.info({cls:"Import",fn:"importViews"});var o=r.data.fields.tview;async.eachSeries(r.data.tview,function(s,n){process.nextTick(function(){for(var i,a={},c=0;c<o.length;c++){var l=o[c],f=s.values[c];null!=f&&("fid"==l?f=r.newId.tview[f]:"fparent_id"==l?f=r.newId.tview[f]:"fclass_id"==l?f=r.newId.tclass[f]:"fschema_id"==l&&(i=f,f=r.newId.tschema[f])),a[l]=f}if(null==r.startRevision[i]||a.fstart_id<r.startRevision[i])null!=r.startRevision[i]&&a.fend_id!=e.maxRevision&&a.fend_id>=r.startRevision[i]&&void 0!==a.fid?(a.fend_id=r.newId.trevision[a.fend_id],e.query({session:t,sql:"update tview set fend_id = "+a.fend_id+" where fid = "+a.fid+" and fend_id="+e.maxRevision,success:function(e){r.incCount("tview",a.fid),n()}})):n();else{a.fstart_id=r.newId.trevision[a.fstart_id],a.fend_id=r.newId.trevision[a.fend_id];var u=r.generateInsert({table:"tview",fields:a});e.query({session:t,sql:u,success:function(e){r.incCount("tview",a.fid),n()}})}})},function(e){n()})},this.importViewAttrs=function(s){var r=this,n=s.success;log.info({cls:"Import",fn:"importViewAttrs"});var o,i=r.data.fields.tview_attr;async.eachSeries(r.data.tview_attr,function(s,n){process.nextTick(function(){for(var a,c={},l=0;l<i.length;l++){var f=i[l],u=s.values[l];null!=u&&("fid"==f?u=r.newId.tview_attr[u]:"fview_id"==f?u=r.newId.tview[u]:"fclass_id"==f?u=r.newId.tclass[u]:"fclass_attr_id"==f?u=r.newId.tclass_attr[u]:"fschema_id"==f&&(a=u,u=r.newId.tschema[u])),c[f]=u}null==r.startRevision[a]||c.fstart_id<r.startRevision[a]?null!=r.startRevision[a]&&c.fend_id!=e.maxRevision&&c.fend_id>=r.startRevision[a]&&void 0!==c.fid?(c.fend_id=r.newId.trevision[c.fend_id],e.query({session:t,sql:"update tview_attr set fend_id = "+c.fend_id+" where fid = "+c.fid+" and fend_id="+e.maxRevision,success:function(e){r.incCount("tview_attr",c.fid),n()}})):n():(c.fstart_id=r.newId.trevision[c.fstart_id],c.fend_id=r.newId.trevision[c.fend_id],o=r.generateInsert({table:"tview_attr",fields:c}),e.query({session:t,sql:o,success:function(e){r.incCount("tview_attr",c.fid),n()}}))})},function(e){n()})},this.importClasses=function(r){var n=this,o=r.success;log.info({cls:"Import",fn:"importClasses"});var i=n.data.fields.tclass;async.eachSeries(n.data.tclass,function(r,o){process.nextTick(function(){for(var a,c={},l=0;l<i.length;l++){var f=i[l],u=r.values[l];null!=u&&("fid"==f?u=n.newId.tclass[u]:"fparent_id"==f?u=n.newId.tclass[u]:"fview_id"==f?u=n.newId.tview[u]:"fschema_id"==f&&(a=u,u=n.newId.tschema[u])),c[f]=u}null==n.startRevision[a]||c.fstart_id<n.startRevision[a]?null!=n.startRevision[a]&&c.fend_id!=e.maxRevision&&c.fend_id>=n.startRevision[a]&&void 0!==c.fid?(c.fend_id=n.newId.trevision[c.fend_id],e.query({session:t,sql:"update tclass set fend_id = "+c.fend_id+" where fid = "+c.fid+" and fend_id="+e.maxRevision,success:function(e){n.incCount("tclass",c.fid),o()}})):o():(c.fstart_id=n.newId.trevision[c.fstart_id],c.fend_id=n.newId.trevision[c.fend_id],s=n.generateInsert({table:"tclass",fields:c}),e.query({session:t,sql:s,success:function(e){n.incCount("tclass",c.fid),o()}}))})},function(e){o()})},this.importClassAttrs=function(r){var n=this,o=r.success;log.info({cls:"Import",fn:"importClassAttrs"});var i=n.data.fields.tclass_attr;async.eachSeries(n.data.tclass_attr,function(r,o){process.nextTick(function(){for(var a,c={},l=0;l<i.length;l++){var f=i[l],u=r.values[l];if(null!=u)if("fid"==f)u=n.newId.tclass_attr[u];else if("fclass_id"==f)u=n.newId.tclass[u];else if("ftype_id"==f){var d=u;if(d>=1e3){var g=n.newId.tclass[d];u=g,n.classAttrType[c.fid]=g}else n.classAttrType[c.fid]=d}else"fschema_id"==f&&(a=u,u=n.newId.tschema[u]);c[f]=u}null==n.startRevision[a]||c.fstart_id<n.startRevision[a]?null!=n.startRevision[a]&&c.fend_id!=e.maxRevision&&c.fend_id>=n.startRevision[a]&&void 0!==c.fid?(c.fend_id=n.newId.trevision[c.fend_id],e.query({session:t,sql:"update tclass_attr set fend_id = "+c.fend_id+" where fid = "+c.fid+" and fend_id="+e.maxRevision,success:function(e){n.incCount("tclass_attr",c.fid),o()}})):o():(c.fstart_id=n.newId.trevision[c.fstart_id],c.fend_id=n.newId.trevision[c.fend_id],s=n.generateInsert({table:"tclass_attr",fields:c}),e.query({session:t,sql:s,success:function(e){n.incCount("tclass_attr",c.fid),o()}}))})},function(e){o()})},this.importActions=function(r){var n=this,o=r.success;log.info({cls:"Import",fn:"importActions"});var i=n.data.fields.taction;async.eachSeries(n.data.taction,function(r,o){process.nextTick(function(){for(var a,c=[],l=0;l<i.length;l++){var f=i[l],u=r.values[l];null!=u&&("fid"==f?u=n.newId.taction[u]:"fclass_id"==f?u=n.newId.tclass[u]:"fschema_id"==f&&(a=u,u=n.newId.tschema[u])),c[f]=u}null==n.startRevision[a]||c.fstart_id<n.startRevision[a]?null!=n.startRevision[a]&&c.fend_id!=e.maxRevision&&c.fend_id>=n.startRevision[a]&&void 0!==c.fid?(c.fend_id=n.newId.trevision[c.fend_id],e.query({session:t,sql:"update taction set fend_id = "+c.fend_id+" where fid = "+c.fid+" and fend_id="+e.maxRevision,success:function(e){n.incCount("taction",c.fid),o()}})):o():(c.fstart_id=n.newId.trevision[c.fstart_id],c.fend_id=n.newId.trevision[c.fend_id],s=n.generateInsert({table:"taction",fields:c}),e.query({session:t,sql:s,success:function(e){n.incCount("taction",c.fid),o()}}))})},function(e){o()})},this.importObjects=function(r){var n=this,o=r.success;log.info({cls:"Import",fn:"importObjects"});var i=n.data.fields.tobject,a=0;async.eachSeries(n.data.tobject,function(r,o){process.nextTick(function(){for(var c,l={},f=0;f<i.length;f++){var u=i[f],d=r.values[f];null!=d&&("fid"==u?d=n.newId.tobject[d]:"fclass_id"==u?d=n.newId.tclass[d]:"fschema_id"==u&&(c=d,d=n.newId.tschema[d])),l[u]=d}"0"!=l.fclass_id&&(null==n.startRevision[c]||l.fstart_id<n.startRevision[c]?null!=n.startRevision[c]&&l.fend_id!=e.maxRevision&&l.fend_id>=n.startRevision[c]&&void 0!==l.fid?(l.fend_id=n.newId.trevision[l.fend_id],e.query({session:t,sql:"update tobject set fend_id = "+l.fend_id+" where fid = "+l.fid+" and fend_id="+e.maxRevision,success:function(e){n.incCount("tobject",l.fid),o()}})):o():(l.fstart_id=n.newId.trevision[l.fstart_id],l.fend_id=n.newId.trevision[l.fend_id],s=n.generateInsert({table:"tobject",fields:l}),e.query({session:t,sql:s,success:function(e){n.incCount("tobject",l.fid),a++,a%1e4==0&&log.info({cls:"Import"},"\t"+a+" records"),o()}})))})},function(e){o()})},this.importObjectAttrs=function(r){var n=this,o=r.success;log.info({cls:"Import",fn:"importObjectAttrs"});var i=n.data.fields.tobject_attr,a=0;async.eachSeries(n.data.tobject_attr,function(r,o){process.nextTick(function(){for(var c,l={},f=0,u=0;u<i.length;u++){var d=i[u],g=r.values[u];if(null!=g)if("fid"==d)g=n.newId.tobject_attr[g];else if("fclass_attr_id"==d){var p=n.newId.tclass_attr[g];g=p,f=n.classAttrType[p]}else"fobject_id"==d?g=n.newId.tobject[g]:"fschema_id"==d?(c=g,g=n.newId.tschema[g]):"fnumber"==d?((f>=1e3||12==f)&&(g=n.newId.tobject[g]),6==f&&(g=n.newId.tclass[g]),7==f&&(g=n.newId.tclass_attr[g]),8==f&&(g=n.newId.tview[g]),9==f&&(g=n.newId.tview_attr[g]),10==f&&(g=n.newId.taction[g]),11==f&&(g=n.newId.taction_attr[g]),13==f&&(g=n.newId.tobject_attr[g])):"fstart_id"!=d&&"fend_id"!=d&&void 0==g&&(g=null);l[d]=g}f?null==n.startRevision[c]||l.fstart_id<n.startRevision[c]?null!=n.startRevision[c]&&l.fend_id!=e.maxRevision&&l.fend_id>=n.startRevision[c]&&void 0!==l.fid?(l.fend_id=n.newId.trevision[l.fend_id],e.query({session:t,sql:"update tobject_attr set fend_id = "+l.fend_id+" where fid = "+l.fid+" and fend_id="+e.maxRevision,success:function(e){n.incCount("tobject_attr",l.fid),o()}})):o():(l.fstart_id=n.newId.trevision[l.fstart_id],l.fend_id=n.newId.trevision[l.fend_id],"mssql"==e.client.database&&l.ftime&&(l.ftime=new Date(l.ftime)),s=n.generateInsert({table:"tobject_attr",fields:l}),e.query({session:t,sql:s,success:function(e){n.incCount("tobject_attr",l.fid),a++,a%1e4==0&&log.info({cls:"Import"},"\t"+a+" records"),o()}})):o()})},function(e){o()})},this.createSchema=function(s){var r=null,n=s.success,o=s.code;e.query({session:t,sql:"select fid from tschema where fcode='"+o+"'",success:function(s){var i=s.result.rows;if(0==i.length){var a=null;e.query({session:t,sql:"select max (fid) as fid from tschema",success:function(s){var i=s.result.rows;i.length&&(a=i[0].fid+1),null==a&&(a=1),e.query({session:t,sql:"insert into tschema (fid, fcode) values ("+a+",'"+o+"')",success:function(e){r=a,n(r)}})}})}else r=i[0].fid,n(r)}})},this.getSchemaId=function(s){var r=s.success;if(!s||!s.code)throw"schema.getId (): options.code must be defined";var n=null;e.query({session:t,sql:"select fid from tschema where fcode='"+s.code+"'",success:function(e){var t=e.result.rows;t.length>0?(n=t[0].fid,r(n)):r(null)}})},this.getNewId=function(s){var r=this,n=s.success;log.info({cls:"Import",fn:"getNewId"}),async.eachSeries(r.data.tschema,function(s,n){r.getSchemaId({code:s.values[3],success:function(o){if(null==o)n();else{var i=[];for(var a in ifields)i.push(a);async.eachSeries(i,function(n,i){var a=ifields[n].indexOf("fschema_id"),c=ifields[n].indexOf("frecord_id");a==-1?i():e.query({session:t,sql:"select distinct (frecord_id) as frecord_id, fid from "+n+" where frecord_id is not null and fschema_id="+o,success:function(e){for(var t=e.result.rows,o=r.data[n],l=0;l<t.length;l++)for(var f=t[l].frecord_id,u=0;u<o.length;u++)s.values[0]==o[u].values[a]&&f==o[u].values[c]&&(r.newId[n][o[u].values[0]]=t[l].fid);i()}})},function(e){n()})}}})},function(e){n()})},this.importRevisions=function(r){var n=this,o=r.success;log.info({cls:"Import",fn:"importRevisions"});var i=n.data.fields.trevision,a=i.indexOf("fschema_id");async.eachSeries(n.data.trevision,function(r,o){process.nextTick(function(){var c=r.values[a];if(n.newId.trevision[r.values[0]])return void o();n.startRevision[c]||(n.startRevision[c]=r.values[0],(!n.startRevisionMin||n.startRevisionMin>n.startRevision[c])&&(n.startRevisionMin=n.startRevision[c]),log.info({cls:"Import"},"startRevision ["+c+"] = "+r.values[0]+" "));for(var l,f={},u=0;u<i.length;u++){var d=i[u],g=r.values[u];null!=g&&("fid"==d?(l=g,g=n.tableId.trevision):"fschema_id"==d&&(g=n.newId.tschema[g])),f[d]=g}"mssql"==e.client.database&&f.fdate&&(f.fdate=new Date(f.fdate)),s=n.generateInsert({table:"trevision",fields:f}),e.query({session:t,sql:s,success:function(e){n.incCount("trevision",f.fid),n.newId.trevision[l]=n.tableId.trevision,n.tableId.trevision++,o()}})})},function(t){n.newId.trevision[e.maxRevision]=e.maxRevision,o()})},this.importSchemas=function(e){var t=this,s=e.success;log.info({cls:"Import",fn:"importSchemas"});var r=t.data.fields.tschema;this.startRevision={},async.eachSeries(t.data.tschema,function(e,s){t.startRevision[e.values[0]]=null;for(var n=0;n<r.length;n++){var o=r[n],i=e.values[n];if(null!=i&&"fcode"==o){t.createSchema({code:i,success:function(r){t.newId.tschema[e.values[0]]=r,s()}});break}}},function(e){s()})},this.generateNewId=function(e){var t=this,s=e.success;log.info({cls:"Import",fn:"generateNewId"});for(var r=["tclass","tclass_attr","tview","tview_attr","taction","taction_attr","tobject","tobject_attr"],n=0;n<r.length;n++){var o=r[n];if(t.data[o])for(var i=0;i<t.data[o].length;i++){for(var a={},c=0;c<t.data.fields[o].length;c++){var l=t.data.fields[o][c],f=t.data[o][i].values[c];a[l]=f}t.schema&&(null==t.startRevision[a.fschema_id]||a.fstart_id<t.startRevision[a.fschema_id])||t.newId[o][a.fid]||(t.newId[o][a.fid]=t.tableId[o],t.tableId[o]++)}}s()},this.removeTOC=function(t){var s=t.success,r=t.session;t.storage&&(e=t.storage),log.info({cls:"Import",fn:"removeTOC"});var n="select c.fid from tclass c\n";n+="where c.fid >= 1000 and "+e.getCurrentFilter({alias:"c"})+"\n",t&&t.classId&&(n+="and c.fid="+t.classId+"\n"),n+="order by c.fid\n",e.query({session:r,sql:n,success:function(t){var n=t.result.rows;async.eachSeries(n,function(t,s){var n=e.getClass(t.fid).toc;e.client.isTableExists({session:r,table:n,success:function(t){if(t){var o;o="mssql"==e.client.database?"drop table "+n+"\n":"drop table "+n+" cascade\n",e.query({session:r,sql:o,success:function(e){s()}})}else s()}})},function(e){s()})}})},this.removeObjectDuplicates=function(s){var r=s.success;log.info({cls:"Import",fn:"removeObjectDuplicates"}),e.query({session:t,sql:"select count (*), o.fid from tobject o\nwhere "+e.getCurrentFilter({alias:"o"})+"\ngroup by o.fid\nhaving count (*) > 1\n",success:function(s){var n=s.result.rows;async.eachSeries(n,function(s,r){var n=s.fid;e.query({session:t,sql:"select o.fstart_id from tobject o\nwhere o.fid="+n+" and "+e.getCurrentFilter({alias:"o"})+"\norder by o.fstart_id desc\n",success:function(s){var o=s.result.rows;o.splice(0,1),async.eachSeries(o,function(s,r){e.query({session:t,sql:"update tobject set fend_id=fstart_id\nwhere fid="+n+" and fstart_id="+s.fstart_id,success:function(e){r()}})},function(e){r()})}})},function(e){r()})}})},this.removeObjectAttrDuplicates=function(s){var r=s.success;log.info({cls:"Import",fn:"removeObjectAttrDuplicates"}),e.query({session:t,sql:"select oa.fclass_attr_id, oa.fobject_id from tobject_attr oa\nwhere "+e.getCurrentFilter({alias:"oa"})+"\ngroup by oa.fclass_attr_id, oa.fobject_id\nhaving count (*) > 1\n",success:function(s){var n=s.result.rows;async.eachSeries(n,function(s,r){var n=s.fclass_attr_id,o=s.fobject_id;e.query({session:t,sql:"select oa.fid from tobject_attr oa\nwhere oa.fclass_attr_id="+n+" and oa.fobject_id="+o+" and "+e.getCurrentFilter({alias:"oa"})+"\norder by oa.FSTART_ID desc\n",success:function(s){var n=s.result.rows;n.splice(0,1),async.eachSeries(n,function(s,r){e.query({session:t,sql:"update tobject_attr set fend_id=fstart_id\nwhere fid="+s.fid,success:function(e){r()}})},function(e){r()})}})},function(e){r()})}})},this.getChilds=function(s){var r=this,n=s.success,o=s;e.query({session:t,sql:"select fid from "+s.table+" where fparent_id "+(s.parentId?"= "+s.parentId:"is null")+" and "+e.getCurrentFilter(),success:function(e){var t=e.result.rows;o.childs||(o.childs=[]),async.eachSeries(t,function(e,t){o.childs.push(e.fid),r.getChilds({table:o.table,parentId:e.fid,childs:o.childs,success:function(e){t()}})},function(e){n(o.childs)})}})},this.createTOC=function(s){var r=this,n=s.success;s.storage&&(e=s.storage),log.info({cls:"Import",fn:"createTOC"});var o;async.series([function(e){r.removeObjectAttrDuplicates({success:function(){r.removeObjectDuplicates({success:function(){e()}})}})},function(r){var n;n="select\n",n+="\t"+ifields.tclass+"\n",n+="from\n",n+="\ttclass\n",n+="where\n",n+="\t"+e.getCurrentFilter()+"\n",s&&s.classId&&(n+="and fid="+s.classId+"\n"),n+="and fid >= 1000\n",n+="order by fid\n",e.query({session:t,sql:n,success:function(e){o=e.result.rows,r()}})},function(s){async.eachSeries(o,function(s,n){var o=s.fid,i=e.getClass(o).toc;return"view_"==i.toLowerCase().substring(0,5)?void n():void e.client.isTableExists({session:t,table:i,success:function(a){if(a)return void n();var c,l="insert into "+i+" (fobject_id",f="select o.fid",u="",d=[];async.series([function(r){if(log.info({cls:"Import"},"Creating toc for class '"+s.fcode+"' ["+o+"] ..."),"mssql"==e.client.database)e.query({session:t,sql:"create table "+i+" (fobject_id bigint primary key clustered)",success:function(e){r()}});else{var n="create table "+i+" (fobject_id bigint not null, primary key (fobject_id))";e.client.version>=91&&config.storages[e.code]&&config.storages[e.code].unlogged&&(n="create unlogged table "+i+" (fobject_id bigint not null, primary key (fobject_id))"),e.query({session:t,sql:n,success:function(){r()}})}},function(s){d.push(o),r.getChilds({table:"tclass",parentId:o,childs:d,success:function(r){d=r,e.query({session:t,sql:"select\n\t"+ifields.tclass_attr+"\nfrom\n\ttclass_attr ca\nwhere\n\tca.fclass_id = "+o+" and\n\t"+e.getCurrentFilter({alias:"ca"})+"\norder by ca.fid\n",success:function(e){c=e.result.rows,s()}})}})},function(s){async.eachSeries(c,function(s,r){var n=s.fid,o={};try{o=JSON.parse(s.fformat_func)||{}}catch(e){}var a="$tnumber$",c="fnumber";switch(s.ftype_id){case 2:a="$tnumber_value$";break;case 1:case 5:a="$ttext$",c="fstring";break;case 3:a="$ttimestamp$",c="ftime"}var d=e.getClassAttr(n).toc,g="alter table "+i+" add column "+d+" "+a;"mssql"==e.client.database&&(g="alter table "+i+" add "+d+" "+a),e.query({session:t,sql:g,success:function(){if(l+=", "+d,f+=", oa"+n+"."+c,u+="left join tobject_attr oa"+n+" on (oa"+n+".fobject_id = o.fid and oa"+n+".fclass_attr_id = "+n+" and "+e.getCurrentFilter({alias:"oa"+n})+")\n",12==s.ftype_id||s.ftype_id>=1e3||s.funique||o.index){log.info({cls:"Import"},"created index for class_attr: "+s.fcode);var a="create index "+i+"_"+d+" on $schema_prefix$"+i+" ("+d+")";s.funique&&"mssql"==e.client.database&&"fstring"==c&&(a="create index "+i+"_"+d+" on $schema_prefix$"+i+" (fobject_id) include ("+d+")"),e.query({session:t,sql:a,success:function(){r()}})}else if(config.index&&config.index.text_pattern_ops&&1==s.ftype_id&&"postgres"==e.client.database){log.info({cls:"Import"},"created text index for class_attr: "+s.fcode);var a="create index "+i+"_"+d+" on $schema_prefix$"+i+" ("+d+" text_pattern_ops)";e.query({session:t,sql:a,success:function(){r()}})}else if(config.index&&config.index.substr&&1==s.ftype_id&&"postgres"==e.client.database){log.info({cls:"Import"},"created text index for class_attr: "+s.fcode);var a="create index "+i+"_"+d+" on $schema_prefix$"+i+" (substr ("+d+", 1, 1024))";e.query({session:t,sql:a,success:function(){r()}})}else r()}})},function(e){s()})},function(r){log.info({cls:"Import"},"Inserting toc data for class '"+s.fcode+"' ["+o+"] ..."),l=l+")\n"+f+" from $schema_prefix$tobject o\n"+u,l+="where\to.fclass_id in ("+d.join()+") and "+e.getCurrentFilter({alias:"o"})+"\n",l+="order by o.fid\n",e.query({session:t,sql:l,success:function(){r()}})}],function(e,t){n()})}})},function(e){s()})}],function(e,t){n()})},this.importFromFile=function(s){var r=this,n=s.success;t={id:"import_"+s.code,username:"admin",userId:null},log.info({cls:"Import",fn:"importFromFile"}),async.series([function(e){fs.exists(s.file,function(t){t?fs.readFile(s.file,function(t,s){r.data=JSON.parse(s),e()}):e("file not exists.")})},function(t){s.storage?(e=r.storage=s.storage,t()):projects.loadConfig({code:s.code,success:function(){e=new Storage({code:s.code,connection:config.storages[s.code],success:function(){r.storageCreated=!0,t()}})},failure:function(e){t(e)}})},function(r){e.startTransaction({session:t,remoteAddr:"127.0.0.1",description:"import_"+s.code,success:function(){r()},failure:function(e){r(e.error)}})},function(e){r.getSequences({session:t,success:function(){e()}})},function(s){e.query({session:t,sql:"select fcode from tschema",success:function(e){for(var t=e.result.rows,r=0;r<t.length;r++)if(!t[r].fcode||"undefined"==t[r].fcode)return void s("Schema undefined.");s()}})},function(e){r.count.tclass=0,r.count.tclass_attr=0,r.count.tview=0,r.count.tview_attr=0,r.count.taction=0,r.count.taction_attr=0,r.count.tobject=0,r.count.tobject_attr=0,r.count.trevision=0,r.getNewId({success:function(){r.importSchemas({success:function(){r.importRevisions({success:function(){r.generateNewId({success:function(){r.importViews({success:function(){r.importViewAttrs({success:function(){r.importClasses({success:function(){r.importClassAttrs({success:function(){r.importActions({success:function(){r.importObjects({success:function(){e()}})}})}})}})}})}})}})}})}})}})},function(s){"mssql"==e.client.database?e.query({session:t,sql:"set identity_insert tobject_attr on",success:function(e){s()}}):s()},function(e){r.importObjectAttrs({success:function(){e()}})},function(s){"mssql"==e.client.database?e.query({session:t,sql:"set identity_insert tobject_attr off",success:function(e){s()}}):s()},function(s){e.commitTransaction({session:t,success:function(){s()}})},function(t){e.client.updateSequences({success:function(){t()}})},function(n){log.info({cls:"Import"},"records count:\n"+JSON.stringify(r.count,0,"\t")),!s.keepToc&&(r.count.tclass||r.count.tclass_attr||r.count.tobject||r.count.tobject_attr)?e.initClasses({success:function(){e.initClassAttrs({success:function(){e.startTransaction({session:t,remoteAddr:"127.0.0.1",description:"import_"+s.code,success:function(){r.removeTOC({success:function(){r.createTOC({success:function(){e.commitTransaction({session:t,success:function(){n()}})}})}})}})}})}}):n()},function(e){var t=redis.createClient(config.redis.port,config.redis.host);t.del(s.code+"-requests"),t.del(s.code+"-objects"),t.keys("*-content",function(e,s){for(var r=0;r<s.length;r++)t.del(s[r])}),t.keys("*-clschange",function(e,s){for(var r=0;r<s.length;r++)t.del(s[r])}),e()}],function(o,i){o?(log.info({cls:"Import",error:o}),e?e.rollbackTransaction({session:t,success:function(){n()}}):n()):n(),r.storageCreated&&e.freeResources(),s.noExit||process.exit(1)})}},smtpTransport=nodemailer.createTransport("SMTP",config.mail.smtp),mailSender={smtpTransport:{}};mailSender.send=function(e){var t=e.success,s=e.failure,r=e.session?e.session.storage:null;if(_.has(config.mail,"enabled")&&!config.mail.enabled)return void(t&&t());var n=smtpTransport,o=e.to.split("@")[1];if(r&&r.config.smtp&&r.config.smtp.host){if(e.from=r.config.smtp.sender||e.from,!mailSender.smtpTransport[r.code]){var i={host:r.config.smtp.host,maxConnections:50,port:25,forceSender:r.config.smtp.sender,auth:r.config.smtp.username?{user:r.config.smtp.username,pass:r.config.smtp.password}:void 0};mailSender.smtpTransport[r.code]=nodemailer.createTransport("SMTP",i)}n=mailSender.smtpTransport[r.code]}else e.from=config.mail.smtp.forceSender||e.from,config.mail.smtp[o]&&(mailSender.smtpTransport[o]||(mailSender.smtpTransport[o]=nodemailer.createTransport("SMTP",config.mail.smtp[o])),n=mailSender.smtpTransport[o],e.from=config.mail.smtp[o].forceSender||e.from);var a={from:e.from,to:e.to,envelope:{from:e.from,to:e.to},subject:e.subject||e.topic,text:e.message||e.text,html:e.message||e.html,attachments:e.attachments};n.sendMail(a,function(n,o){n?(log.info({cls:"mailSender"},"mail ("+e.to+"): "+n),a.storage=r,mailSender.saveFailed(a),s&&s(n)):(log.info({cls:"mailSender"},"Message sent ("+e.to+"): "+o.message),t&&t())})},mailSender.saveFailed=function(e){var t=e.storage;if(!e.sendFailed&&t){var s={from:e.from,to:e.to,subject:e.subject,text:e.text,html:e.html};s=JSON.stringify(s),s=s.split("'").join("''"),t.query({sql:"insert into tmail (fcreation_date, fmessage)\nvalues ("+t.client.currentTimestamp()+", '"+s+"')\n"})}},mailSender.sendFailed=function(){var e=[];for(var t in projects.storagePool)e.push(projects.storagePool[t]);async.eachSeries(e,function(e,t){e.query({sql:"select fid, fmessage from tmail\nwhere fsending_date is null\norder by fid\n",success:function(s){s.result.rows;async.eachSeries(s.result.rows,function(t,s){async.series([function(e){try{var s=JSON.parse(t.fmessage);s.success=function(){e()},s.failure=function(){e("fail")},mailSender.send(s)}catch(t){e()}},function(s){e.query({sql:"delete from tmail where fid="+t.fid,success:function(){s()}})}],function(e){s(e)})},function(e){t(e)})}})},function(e){})};var meta={};meta.fields={tclass:["fid","fparent_id","fname","fcode","fdescription","fformat","fview_id","ftype","fsystem"],tclass_attr:["fid","fclass_id","fname","fcode","ftype_id","forder","fnot_null","fvalid_func","fformat_func","fdescription","fsecure","fmax_str","fmin_str","fmax_number","fmin_number","fmax_ts","fmin_ts","funique","fformat_number","fformat_ts","fremove_rule"],tview:["fid","fparent_id","fname","fcode","fdescription","flayout","fkey","fparent_key","fclass_id","funrelated","fquery","ftype","fsystem","fmaterialized","forder","ficon_cls"],tview_attr:["fid","fview_id","fname","fcode","fclass_id","fclass_attr_id","fsubject_id","forder","fsort_kind","fsort_order","foperation","fvalue","farea","fcolumn_width","ftotal_type","fread_only","fgroup","fnot_null"],taction:["fid","fclass_id","fname","fcode","fdescription","forder","fbody","flayout"]},meta.tableCreate=function(e){var t,s=e.request,r=e.response,n=s.session,o=e.table,i=meta.fields[o],a=e.values,c=e.storage,l=c.revision[n.id],f=!!l,u=e.success;async.series([function(e){f?e():c.startTransaction({session:n,remoteAddr:common.getRemoteAddress(s),description:"Create "+o,success:function(t){l=t.revision,projects.sessions[n.id].transaction.active=!0,e()},failure:function(t){e(t.error)}})},function(e){var s=c.getClient({session:n});s.getNextId({table:o,success:function(s){t=s.id,e()}})},function(e){i=i.concat(["fstart_id","fend_id"]),a=a.concat([l,c.maxRevision]),a=[t].concat(a);for(var s=[],r=0;r<a.length;r++)s.push("$"+(r+1));c.query({session:n,sql:"insert into "+o+" ("+i.join(",")+") values ("+s.join(",")+")",params:[].concat(a),success:function(t){e()}})}],function(e,t){e?projects.send({request:s,response:r,msg:"{header: {error: '"+e+"'},data: []}"}):("tclass"==o&&(c.revisions[c.revision[n.id]].classes.created.push({fields:i,values:a}),c.updateClassCache({fields:i,values:a})),"tclass_attr"==o&&(c.revisions[c.revision[n.id]].classAttrs.created.push({fields:i,values:a}),c.updateClassAttrCache({fields:i,values:a})),"tview"==o&&(c.revisions[c.revision[n.id]].views.created.push({fields:i,values:a}),c.updateViewCache({fields:i,values:a})),"tview_attr"==o&&(c.revisions[c.revision[n.id]].viewAttrs.created.push({fields:i,values:a}),c.updateViewAttrCache({fields:i,values:a})),f?u({values:a}):c.commitTransaction({session:n,success:function(e){projects.sessions[n.id].transaction.active=!1,u({values:a})}}))})},meta.tableRemove=function(e){var t=e.request,s=e.response,r=t.session,n=e.table,o=e.values,i=e.storage,a=i.revision[r.id],c=!!a,l=e.success;async.series([function(e){c?e():i.startTransaction({session:r,remoteAddr:common.getRemoteAddress(t),description:"Create "+n,success:function(t){a=t.revision,projects.sessions[r.id].transaction.active=!0,e()},failure:function(t){e(t.error)}})},function(e){i.query({session:r,sql:"update "+n+" set fend_id="+a+" where fid="+o[0]+" and fend_id="+i.maxRevision,success:function(t){e()}})}],function(e,a){e?projects.send({request:t,response:s,msg:"{header: {error: '"+e+"'},data: []}"}):("tclass"==n&&i.revisions[i.revision[r.id]].classes.removed.push(o[0]),"tclass_attr"==n&&i.revisions[i.revision[r.id]].classAttrs.removed.push(o[0]),"tview"==n&&i.revisions[i.revision[r.id]].views.removed.push(o[0]),"tview_attr"==n&&i.revisions[i.revision[r.id]].viewAttrs.removed.push(o[0]),c?l():i.commitTransaction({session:r,success:function(e){projects.sessions[r.id].transaction.active=!1,l()}}))})},meta.tableUpdate=function(e){var t=e.request,s=e.response,r=t.session,n=e.table,o=meta.fields[n],i=e.values,a=e.storage,c=a.revision[r.id],l=e.success,f=!!c;async.series([function(e){f?e():a.startTransaction({session:r,remoteAddr:common.getRemoteAddress(t),description:"Update "+n,success:function(t){c=t.revision,projects.sessions[r.id].transaction.active=!0,e()},failure:function(t){e(t.error)}})},function(e){a.query({session:r,sql:"update "+n+" set fend_id="+c+" where fid="+i[0]+" and fend_id="+a.maxRevision,success:function(t){e()}})},function(e){o=o.concat(["fstart_id","fend_id"]),i=i.concat([c,a.maxRevision]);for(var t=[],s=0;s<i.length;s++)t.push("$"+(s+1));a.query({session:r,sql:"insert into "+n+" ("+o.join(",")+") values ("+t.join(",")+")",params:i,success:function(t){e()}})}],function(e,c){e?projects.send({request:t,response:s,msg:"{header: {error: '"+e+"'},data: []}"}):("tclass"==n&&(a.revisions[a.revision[r.id]].classes.changed.push({fields:o,values:i}),a.updateClassCache({fields:o,values:i})),"tclass_attr"==n&&(a.revisions[a.revision[r.id]].classAttrs.changed.push({fields:o,values:i}),a.updateClassAttrCache({fields:o,values:i})),"tview"==n&&(a.revisions[a.revision[r.id]].views.changed.push({fields:o,values:i}),a.updateViewCache({fields:o,values:i})),"tview_attr"==n&&(a.revisions[a.revision[r.id]].viewAttrs.changed.push({fields:o,values:i}),a.updateViewAttrCache({fields:o,values:i})),f?l():a.commitTransaction({session:r,success:function(e){projects.sessions[r.id].transaction.active=!1,l()}}))})},meta.tableGet=function(e){var t=e.request,s=e.response,r=t.session,n=e.table,o=meta.fields[n],i=e.values,a=e.storage,c=(e.success,"select "+o.join(",")+" from "+n+" where fid="+i[0]+" and fend_id="+a.maxRevision);if("taction"==n&&"string"==typeof i[0]&&i[0].indexOf(".")>-1){var l=i[0].split("."),f=l[l.length-1],u=l.slice(0,l.length-1).join("."),d=a.getClass(u).get("fid");c="select "+o.join(",")+" from taction\nwhere fclass_id="+d+" and fcode='"+f+"' and fend_id="+a.maxRevision}a.query({session:r,sql:c,success:function(e){var r,n=e.result.rows;r=n.length?n[0]:{};for(var i=[],a=0;a<o.length;a++)i.push(r[o[a]]);projects.send({request:t,response:s,msg:"{header: {error: ''},data: "+JSON.stringify(i)+"}"})}})},meta.fnView=function(e,t,s){if("View"==e.storageArea){if("autologin"==e.session.username&&null==e.session.userId)return void projects.send({request:e,response:t,msg:"{header: {error: 'forbidden'}}"});var r={request:e,response:t,storageCode:e.storageCode,table:"tview",values:JSON.parse("["+e.storageParam+"]")};projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){var n=r.storage=s.storage;"create"==e.storageFn&&(r.success=function(s){var r=s.values;projects.send({request:e,response:t,msg:"{header: {error: ''},data: ["+JSON.stringify(r)+"]}"})},meta.tableCreate(r)),"set"==e.storageFn&&(r.success=function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})},meta.tableUpdate(r)),"remove"==e.storageFn&&(r.success=function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})},meta.tableRemove(r)),n.redisClient.hdel(n.code+"-requests","tview"),n.redisClient.hdel(n.code+"-requests","all")}})}else s()},meta.fnViewAttr=function(e,t,s){if("ViewAttr"==e.storageArea){if("autologin"==e.session.username&&null==e.session.userId)return void projects.send({request:e,response:t,msg:"{header: {error: 'forbidden'}}"});var r={request:e,response:t,storageCode:e.storageCode,table:"tview_attr",values:JSON.parse("["+e.storageParam+"]")};projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){var n=r.storage=s.storage;"create"==e.storageFn&&(r.success=function(s){var r=s.values;projects.send({request:e,response:t,msg:"{header: {error: ''},data: ["+JSON.stringify(r)+"]}"})},meta.tableCreate(r)),"set"==e.storageFn&&(r.success=function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})},
meta.tableUpdate(r)),"remove"==e.storageFn&&(r.success=function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})},meta.tableRemove(r)),n.redisClient.hdel(n.code+"-requests","tview_attr"),n.redisClient.hdel(n.code+"-requests","all")}})}else s()},meta.fnClass=function(e,t,s){if("Class"==e.storageArea){if("autologin"==e.session.username&&null==e.session.userId)return void projects.send({request:e,response:t,msg:"{header: {error: 'forbidden'}}"});var r={request:e,response:t,storageCode:e.storageCode,table:"tclass",values:JSON.parse("["+e.storageParam+"]")},n=r.values[2],o=r.values[0];projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){var i=r.storage=s.storage,a=e.session,c=i.revision[a.id],l=!!c;if("create"==e.storageFn&&(r.success=function(s){var r=s.values,o=n+"_"+r[0];i.query({sql:"create table "+o+" ($tocObjectId$)",success:function(){projects.send({request:e,response:t,msg:"{header: {error: ''},data: ["+JSON.stringify(r)+"]}"})}})},meta.tableCreate(r)),"set"==e.storageFn){var f=i.getClass(o).toc,u=r.values[3]+"_"+o;async.series([function(t){l?t():i.startTransaction({session:a,remoteAddr:common.getRemoteAddress(e),description:"Remove ca ",success:function(e){c=e.revision,projects.sessions[a.id].transaction.active=!0,t()},failure:function(e){t(e.error)}})},function(e){r.success=function(t){e()},meta.tableUpdate(r)},function(e){f.toLowerCase()!=u.toLowerCase()?i.client.isTableExists({table:f,success:function(t){t?i.query({session:a,sql:"alter table "+f+" rename to "+u,success:function(){e()}}):e()}}):e()},function(e){l?e():i.commitTransaction({session:a,success:function(t){projects.sessions[a.id].transaction.active=!1,e()}})}],function(s,r){s&&!l?i.rollbackTransaction({session:a,success:function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})}}):projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})})}"remove"==e.storageFn&&async.series([function(t){l?t():i.startTransaction({session:a,remoteAddr:common.getRemoteAddress(e),description:"Remove c",success:function(e){c=e.revision,projects.sessions[a.id].transaction.active=!0,t()},failure:function(e){t(e.error)}})},function(e){r.success=function(t){e()},meta.tableRemove(r)},function(e){var t=i.getClass(o).toc;i.client.isTableExists({table:t,success:function(s){s?i.query({session:a,sql:"drop table "+t,success:function(){e()},failure:function(){e()}}):e()}})},function(e){l?e():i.commitTransaction({session:a,success:function(t){projects.sessions[a.id].transaction.active=!1,e()}})}],function(s,r){s&&!l?i.rollbackTransaction({session:a,success:function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})}}):projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})}),i.redisClient.hdel(i.code+"-requests","tclass"),i.redisClient.hdel(i.code+"-requests","all")}})}else s()},meta.fnClassAttr=function(e,t,s){if("ClassAttr"==e.storageArea){if("autologin"==e.session.username&&null==e.session.userId)return void projects.send({request:e,response:t,msg:"{header: {error: 'forbidden'}}"});var r={request:e,response:t,storageCode:e.storageCode,table:"tclass_attr",values:JSON.parse("["+e.storageParam+"]")};projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){var n=r.storage=s.storage,o=e.session,i=n.revision[o.id],a=!!i;if("create"==e.storageFn&&(r.success=function(s){var o=s.values,i="$tnumber$";switch(o[4]){case 2:i="$tnumber_value$";break;case 1:case 5:i="$ttext$";break;case 3:i="$ttimestamp$"}var a=r.values[2]+"_"+o[0],c=n.getClass(o[1]).toc;n.client.createField({toc:c,tocField:a,caId:o[0],type:i,success:function(){projects.send({request:e,response:t,msg:"{header: {error: ''},data: ["+JSON.stringify(o)+"]}"})}})},meta.tableCreate(r)),"set"==e.storageFn){var c=r.values[0],l=n.getClassAttr(c),f=n.getClass(l.get("fclass_id")),u=l.toc,d=r.values[3]+"_"+c;async.series([function(t){a?t():n.startTransaction({session:o,remoteAddr:common.getRemoteAddress(e),description:"Remove ca ",success:function(e){i=e.revision,projects.sessions[o.id].transaction.active=!0,t()},failure:function(e){t(e.error)}})},function(e){r.success=function(t){e()},meta.tableUpdate(r)},function(e){u.toLowerCase()!=d.toLowerCase()?n.client.isFieldExists({table:f.toc,field:u,success:function(t){t?n.query({session:o,sql:"alter table "+f.toc+" rename column "+u+" to "+d,success:function(){e()}}):e()}}):e()},function(e){a?e():n.commitTransaction({session:o,success:function(t){projects.sessions[o.id].transaction.active=!1,e()}})}],function(s,r){s&&!a?n.rollbackTransaction({session:o,success:function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})}}):projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})})}if("remove"==e.storageFn){var c=r.values[0],l=n.getClassAttr(c),f=n.getClass(l.get("fclass_id"));async.series([function(t){a?t():n.startTransaction({session:o,remoteAddr:common.getRemoteAddress(e),description:"Remove ca ",success:function(e){i=e.revision,projects.sessions[o.id].transaction.active=!0,t()},failure:function(e){t(e.error)}})},function(e){r.success=function(t){e()},meta.tableRemove(r)},function(e){n.client.isIndexExists({index:f.toc+"_"+c,success:function(t){t?n.query({session:o,sql:"drop index "+f.toc+"_"+c,success:function(){e()},failure:function(){e()}}):e()}})},function(e){n.client.isFieldExists({table:f.toc,field:l.toc,success:function(t){t?n.query({session:o,sql:"alter table "+f.toc+" drop column "+l.toc,success:function(){e()},failure:function(){e()}}):e()}})},function(e){a?e():n.commitTransaction({session:o,success:function(t){projects.sessions[o.id].transaction.active=!1,e()}})}],function(s,r){s&&!a?n.rollbackTransaction({session:o,success:function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})}}):projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})})}n.redisClient.hdel(n.code+"-requests","tclass_attr"),n.redisClient.hdel(n.code+"-requests","all")}})}else s()},meta.fnAction=function(e,t,s){if("Action"==e.storageArea){if("autologin"==e.session.username&&null==e.session.userId)return void projects.send({request:e,response:t,msg:"{header: {error: 'forbidden'}}"});var r;try{r=JSON.parse("["+e.storageParam+"]")}catch(s){return void projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})}var n={request:e,response:t,storageCode:e.storageCode,table:"taction",values:r};projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){n.storage=s.storage;"create"==e.storageFn&&(n.success=function(s){var r=s.values;projects.send({request:e,response:t,msg:"{header: {error: ''},data: ["+JSON.stringify(r)+"]}"})},meta.tableCreate(n)),"set"==e.storageFn&&(n.success=function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})},meta.tableUpdate(n)),"remove"==e.storageFn&&(n.success=function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: []}"})},meta.tableRemove(n)),"get"==e.storageFn&&meta.tableGet(n)}})}else s()};var mimetypes={};mimetypes.types={"3gp":"video/3gpp",aiff:"audio/x-aiff",arj:"application/x-arj-compressed",asf:"video/x-ms-asf",asx:"video/x-ms-asx",au:"audio/ulaw",avi:"video/x-msvideo",bcpio:"application/x-bcpio",ccad:"application/clariscad",cod:"application/vnd.rim.cod",com:"application/x-msdos-program",cpio:"application/x-cpio",cpt:"application/mac-compactpro",csh:"application/x-csh",css:"text/css",deb:"application/x-debian-package",dl:"video/dl",doc:"application/msword",docx:"application/msword",drw:"application/drafting",dvi:"application/x-dvi",dwg:"application/acad",dxf:"application/dxf",dxr:"application/x-director",etx:"text/x-setext",ez:"application/andrew-inset",fli:"video/x-fli",flv:"video/x-flv",gif:"image/gif",gl:"video/gl",gtar:"application/x-gtar",gz:"application/x-gzip",hdf:"application/x-hdf",hqx:"application/mac-binhex40",html:"text/html; charset=utf-8",ice:"x-conference/x-cooltalk",ico:"image/x-icon",ief:"image/ief",igs:"model/iges",ips:"application/x-ipscript",ipx:"application/x-ipix",jad:"text/vnd.sun.j2me.app-descriptor",jar:"application/java-archive",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json; charset=utf-8",latex:"application/x-latex",lsp:"application/x-lisp",lzh:"application/octet-stream",m:"text/plain",m3u:"audio/x-mpegurl",m4v:"video/mp4",man:"application/x-troff-man",me:"application/x-troff-me",midi:"audio/midi",mif:"application/x-mif",mime:"www/mime",mkv:"video/x-matrosk",movie:"video/x-sgi-movie",mp4:"video/mp4",mp41:"video/mp4",mp42:"video/mp4",mpg:"video/mpeg",mpga:"audio/mpeg",ms:"application/x-troff-ms",mustache:"text/plain",nc:"application/x-netcdf",oda:"application/oda",ogm:"application/ogg",pbm:"image/x-portable-bitmap",pdf:"application/pdf",pgm:"image/x-portable-graymap",pgn:"application/x-chess-pgn",pgp:"application/pgp",pm:"application/x-perl",png:"image/png",pnm:"image/x-portable-anymap",ppm:"image/x-portable-pixmap",ppz:"application/vnd.ms-powerpoint",pre:"application/x-freelance",prt:"application/pro_eng",ps:"application/postscript",qt:"video/quicktime",ra:"audio/x-realaudio",rar:"application/x-rar-compressed",ras:"image/x-cmu-raster",rgb:"image/x-rgb",rm:"audio/x-pn-realaudio",rpm:"audio/x-pn-realaudio-plugin",rtf:"text/rtf",rtx:"text/richtext",scm:"application/x-lotusscreencam",set:"application/set",sgml:"text/sgml",sh:"application/x-sh",shar:"application/x-shar",silo:"model/mesh",sit:"application/x-stuffit",skt:"application/x-koan",smil:"application/smil",snd:"audio/basic",sol:"application/solids",spl:"application/x-futuresplash",src:"application/x-wais-source",stl:"application/SLA",stp:"application/STEP",sv4cpio:"application/x-sv4cpio",sv4crc:"application/x-sv4crc",svg:"image/svg+xml",swf:"application/x-shockwave-flash",tar:"application/x-tar",tcl:"application/x-tcl",tex:"application/x-tex",texinfo:"application/x-texinfo",tgz:"application/x-tar-gz",tiff:"image/tiff",tr:"application/x-troff",tsi:"audio/TSP-audio",tsp:"application/dsptype",tsv:"text/tab-separated-values",unv:"application/i-deas",ustar:"application/x-ustar",vcd:"application/x-cdlink",vda:"application/vda",vivo:"video/vnd.vivo",vrm:"x-world/x-vrml",wav:"audio/x-wav",wax:"audio/x-ms-wax",webm:"video/webm",wma:"audio/x-ms-wma",wmv:"video/x-ms-wmv",wmx:"video/x-ms-wmx",wrl:"model/vrml",wvx:"video/x-ms-wvx",xbm:"image/x-xbitmap",xls:"application/vnd.ms-excel",xlsx:"application/vnd.ms-excel",xlw:"application/vnd.ms-excel",xml:"text/xml",xpm:"image/x-xpixmap",xwd:"image/x-xwindowdump",xyz:"chemical/x-pdb",zip:"application/zip"},mimetypes.lookup=function(e,t){return t=t||"application/octet-stream",e in mimetypes.types?mimetypes.types[e]:t};var projects={};projects.init=function(e){redisClient=redis.createClient(config.redis.port,config.redis.host),redisPub=redis.createClient(config.redis.port,config.redis.host),redisSub=redis.createClient(config.redis.port,config.redis.host),async.series([function(e){config.redis.db?redisClient.select(config.redis.db,function(t,s){redisPub.select(config.redis.db,function(t,s){redisSub.select(config.redis.db,function(t,s){e()})})}):e()}],function(t){redisSub.on("message",function(e,t){if(e==config.redis.db+"-storages"){var s=JSON.parse(t);s.free&&projects.storagePool&&(projects.storagePool[s.free].freeResources(),delete projects.storagePool[s.free])}if(e==config.redis.db+"-cluster"&&"restart"==t&&process.exit(1),e==config.redis.db+"-sessions"){var s=JSON.parse(t),r=projects.sessions[s.removed];r&&r.storage&&r.storage.rollbackTransaction({session:r}),s.removed&&projects.sessions[s.removed]&&delete projects.sessions[s.removed]}if(e==config.redis.db+"-connections"){var s=JSON.parse(t);if(s.terminate)for(var n in projects.storagePool){var o=projects.storagePool[n],i=0;for(var a in o.clientPool){var c=o.clientPool[a];c.pid==s.terminate&&(i=1,log.info({cls:"connections"},"connections disconnect "+s.terminate),o.rollbackTransaction({session:projects.sessions[a],success:function(){}}))}!i&&db.Postgres.clients&&db.Postgres.clients[s.terminate]&&(log.info({cls:"connections"},"connections disconnect db.Postgres "+s.terminate),db.Postgres.clients[s.terminate].disconnect())}}}),redisSub.subscribe(config.redis.db+"-storages"),redisSub.subscribe(config.redis.db+"-sessions"),redisSub.subscribe(config.redis.db+"-connections"),redisSub.subscribe(config.redis.db+"-cluster"),e.success()})},projects.loadConfig=function(e){var t=e.code,s=e.success,r=e.failure;!config.storages.hasOwnProperty(t)&&config.projectsDir?fs.readFile(config.projectsDir+"/"+t+"/config.json",function(e,n){if(e)r("Unknown storage: "+t);else try{config.storages[t]=JSON.parse(n),s()}catch(e){r("Unknown storage: "+t)}}):s()},projects.getHandler=function(e,t,s){var r=e.url.split("/");if(3==r.length)return r.push(""),void t.redirect(r.join("/"));var n=r[2],o="/"+r.slice(3).join("/");"/"==o&&(o="/index.html"),o=o.split("?")[0],projects.loadConfig({code:n,success:function(){var r=config.storages[n].rootDir+o;server.www({request:e,response:t,next:s,filePath:r,nocache:"/files"==o.substr(0,6)})},failure:function(s){t.end("unknown url: "+e.url)}})},projects.startProjectPlugins=function(e){e=e||{};var t=e.success,s=e.storage;async.series([function(e){if(config.storages[s.code].pluginStarted||config.storages[s.code].disablePlugins)return void e();config.storages[s.code].pluginStarted=1;var t=config.storages[s.code].rootDir+"/plugins/plugins.js";fs.exists(t,function(r){if(r){var n=require(t);async.series([function(e){n.init&&server.objectum?n.init({objectum:server.objectum,storage:s,success:function(){log.info({cls:"plugins"},"plugin "+t+" initialized."),e()},failure:function(s){log.error({cls:"plugins",error:t+" error: "+s}),e()}}):e()}],function(r,o){n.handler&&(server.projectPlugins[s.code]=n.handler,log.info({cls:"plugins"},"plugin "+t+" handler activated.")),e()})}else e()})}],function(e,s){t&&t()})},projects.storagePool={},projects.getStorage=function(e){var t=e.request,s=e.response,r=e.success,n=e.failure,o=e.storageCode;projects.storagePool[o]?r({storage:projects.storagePool[o]}):async.series([function(e){(config.port==config.startPort||process.env.mainWorker)&&config.redis.resetCache?(redisClient.del(o+"-requests"),redisClient.del(o+"-objects"),redisClient.del(o+"-sequences"),redisClient.del(o+"-vars"),redisClient.keys(o+"-objects*",function(t,s){for(var r=0;r<s.length;r++)redisClient.del(s[r]);e()})):e()},function(e){projects.loadConfig({code:o,success:function(){e()},failure:function(t){e(t)}})},function(e){projects.storagePool[o]=new Storage({code:o,connection:config.storages[o],authInfoUpdater:!0,success:function(){projects.storagePool[o].config=config.storages[o],projects.storagePool[o].rootDir=config.storages[o].rootDir,projects.storagePool[o].visualObjectum=config.storages[o].visualObjectum||{},config.port==config.startPort||process.env.mainWorker?projects.reloadUniqueValues({storage:projects.storagePool[o],success:function(){e()}}):e()},failure:function(r){t&&s&&projects.sendError({request:t,response:s,error:r.error}),e(r.error)}})},function(e){projects.storagePool[o].visualObjectum.timeMachine&&projects.storagePool[o].visualObjectum.timeMachine.showDates?projects.storagePool[o].query({sql:"select fid, fdate from trevision where ftoc=1 order by fdate desc",success:function(t){for(var s=[],r=0;r<t.result.rows.length;r++){var n=t.result.rows[r];s.push({id:n.fid,date:n.fdate})}projects.storagePool[o].visualObjectum.timeMachine.dates=s,e()}}):e()},function(e){tm.build(projects.storagePool[o]),e()},function(e){projects.startProjectPlugins({storage:projects.storagePool[o],success:function(){e()}})}],function(e,t){e?n&&(log.error({cls:"projects",fn:"getStorage",error:e}),n({error:e})):r({storage:projects.storagePool[o]})})},projects.sessions={},projects.saveSession=function(e){var t={};t[e.id+"-id"]=e.id,t[e.id+"-username"]=e.username,t[e.id+"-clock"]=String(e.activity.clock),t[e.id+"-storageCode"]=e.storage.code,t[e.id+"-newsRevision"]=String(e.news.revision),t[e.id+"-port"]=String(config.port),e.userId&&(t[e.id+"-userId"]=String(e.userId)),e.logined&&(t[e.id+"-logined"]=String(e.logined)),e.ip&&(t[e.id+"-ip"]=String(e.ip)),redisClient.hmset("sessions",t)},projects.tryLogin=function(e){var t=e.success,s=e.storage,r=e.session,n=r.id;e.cookies;projects.sessions[n]=r,projects.saveSession(r);var o="null",i="null";s.subjectRoles[r.userId]&&(o=s.subjectRoles[r.userId].role,i=s.subjectRoles[r.userId].menu),t({result:n+" "+r.userId+" 3 "+o+" "+i,access:"granted"})},projects.authActiveDirectory=function(e,t){var s=e.storage,r=e.login,n=e.password,o=s.config.activeDirectory;if(s.authRecords[r]&&o)try{var i=require("activedirectory"),a=new i(o);a.authenticate(r,n,function(e,s){!e&&s?t("complete"):t()})}catch(e){t()}else t()},projects.checkAuth=function(e,t,s){var r=function(s){var r=s.storage,n=s.login,o=s.password;if("admin"==n&&o==config.storages[r.code].adminPassword){var i=sha.hex_sha1(common.getRemoteAddress(e)+(new Date).getTime()+Math.random());return projects.sessions[i]={id:i,username:"admin",userId:null,activity:{clock:config.clock},storage:r,news:{revision:0},transaction:{active:!1},logined:common.currentUTCTimestamp(),ip:common.getRemoteAddress(e)},projects.saveSession(projects.sessions[i]),projects.send({request:e,response:t,msg:i+" null 3 admin admin"}),!0}return!1},n=function(s){var r=s.storage,n=s.login;s.password;if("autologin"==n&&config.storages[r.code].autologin){var o=sha.hex_sha1(common.getRemoteAddress(e)+(new Date).getTime()+Math.random());return projects.sessions[o]={id:o,username:"autologin",userId:null,activity:{clock:config.clock},storage:r,news:{revision:0},transaction:{active:!1},logined:common.currentUTCTimestamp(),ip:common.getRemoteAddress(e)},projects.saveSession(projects.sessions[o]),projects.send({request:e,response:t,msg:o+" null 3 autologin autologin"}),!0}return!1},o=function(s){var r,n,o,i=s.storage,a=s.login,c=s.password,l=s.passwordPlain;return i.authRecords[a]&&i.authRecords[a].tryNum>=3&&config.clock-i.authRecords[a].lastTry<600?projects.send({request:e,response:t,msg:"wait "+(600-(config.clock-i.authRecords[a].lastTry))}):void async.series([function(t){i.authRecords[a]&&i.authRecords[a].password==c?(n=sha.hex_sha1(common.getRemoteAddress(e)+(new Date).getTime()+Math.random()),r=i.authRecords[a].objectId,o={id:n,username:a,userId:r,roles:i.ose.subject.getRoles(r),activity:{clock:config.clock},storage:i,news:{revision:0},transaction:{active:!1},logined:common.currentUTCTimestamp(),ip:common.getRemoteAddress(e)},t("complete")):projects.authActiveDirectory({storage:i,login:a,password:l},t)}],function(s,r){"complete"==s?projects.tryLogin({storage:i,session:o,cookies:common.getCookies(e.headers.cookie),success:function(s){projects.logLastTry(i,a,!0),projects.send({request:e,response:t,msg:s.result})}}):(projects.logLastTry(i,a,!1),projects.send({request:e,response:t,msg:""}))})},i=function(t){e.session=projects.sessions[e.session.id],e.session.activity.clock=config.clock,redisClient.hset("sessions",e.session.id+"-clock",config.clock),s()};if(1==e.query.authorize){var a=e.body.split("\n"),c=a[0],l=a[1],f=a.length>2?a[2]:null;a=e.url.split("/");var u=a[2];projects.getStorage({request:e,response:t,storageCode:u,success:function(e){var t=e.storage;r({storage:t,login:c,password:l})||n({storage:t,login:c,password:l})||o({storage:t,login:c,password:l,passwordPlain:f})}})}else projects.sessions[e.session.id]?i():(t.writeHead(401,{"Content-Type":"text/html; charset=utf-8"}),t.end("<html><head><title>Unauthenticated</title></head><body><h1>401 Unauthenticated</h1></body></html>"))},projects.sendError=function(e){var t=e.request,s=e.response;e.error&&"object"==typeof e.error&&(e.error.message?e.error=e.error.message:e.error=util.inspect(e.error)),s.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),s.end("{header: {error: "+JSON.stringify(e.error)+"}, data: []}"),log.error({cls:"projects",error:"sessionId: "+t.session.id+", error: "+util.inspect(e.error)})},projects.send=function(e){var t=(e.request,e.response);t.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),t.end(e.msg),log.debug({cls:"projects",fn:"send",params:e.msg})},projects.startTransaction=function(request,response,next){if("startTransaction"==request.storageFn){if(log.debug({cls:"projects",fn:"startTransaction",params:request.storageParam}),"autologin"==request.session.username&&null==request.session.userId)return void projects.send({request:request,response:response,msg:"{header: {error: 'forbidden'}}"});var params=eval("("+request.storageParam+")"),storage;async.series([function(e){projects.getStorage({request:request,response:response,storageCode:request.storageCode,success:function(t){storage=t.storage,e()}})},function(e){projects.sessions[request.session.id].transaction.active?storage.commitTransaction({session:request.session,success:function(t){projects.sessions[request.session.id].transaction.active=!1,e()},failure:function(t){e()}}):e()}],function(e,t){storage.startTransaction({session:request.session,remoteAddr:common.getRemoteAddress(request),description:params,success:function(e){var t=e.revision;projects.sessions[request.session.id]?(projects.sessions[request.session.id].transaction.active=!0,projects.send({request:request,response:response,msg:"{header: {error: ''},data: "+t+"}"})):storage.rollbackTransaction({session:request.session,success:function(e){projects.sendError({request:request,response:response,error:"invalid session in start transaction"})}})},failure:function(e){projects.sendError({request:request,response:response,error:new VError(e,"projects.startTransaction")})}})})}else next()},projects.commitTransaction=function(e,t,s){"commitTransaction"==e.storageFn?(log.debug({cls:"projects",fn:"commitTransaction",params:e.storageParam}),projects.sessions[e.session.id].transaction.active?projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){var r=s.storage;r.commitTransaction({session:e.session,success:function(s){projects.sessions[e.session.id].transaction.active=!1,projects.send({request:e,response:t,msg:"{header: {error: ''},data: "+s.revision+"}"})},failure:function(s){projects.sendError({request:e,response:t,error:new VError(s,"projects.commitTransaction")})}})}}):projects.send({request:e,response:t,msg:"{header: {error: ''},data: 'Transaction not active'}"})):s()},projects.rollbackTransaction=function(e,t,s){"rollbackTransaction"==e.storageFn?(log.debug({cls:"projects",fn:"rollbackTransaction"}),projects.sessions[e.session.id].transaction.active?projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){var r=s.storage;r.rollbackTransaction({session:e.session,success:function(s){projects.sessions[e.session.id].transaction.active=!1,projects.send({request:e,response:t,msg:"{header: {error: ''},data: "+s.revision+"}"})},failure:function(s){projects.sendError({request:e,response:t,error:new VError(s,"projects.rollbackTransaction")})}})}}):projects.send({request:e,response:t,msg:"{header: {error: ''},data: 'Transaction not active'}"})):s()},projects.getObject=function(e,t,s){if("getObject"==e.storageFn){log.debug({cls:"projects",fn:"getObject",params:e.storageParam});var r,n=e.storageCode;try{r=JSON.parse(e.storageParam)}catch(s){var o="{header: {error: ''},data: {id: null, classId: null, attrs: {}}}";return void projects.send({request:e,response:t,msg:o})}projects.getStorage({request:e,response:t,storageCode:n,success:function(s){var n=s.storage;projects.sessions[e.session.id].storage=n,n.getObject({session:e.session,id:r,success:function(s){var n=s.object,o="{header: {error: ''},data: {";if(n){o+="id:"+r+", classId: "+n.data.fclass_id+", attrs: {";var i=0;for(var a in n.data)["id","fclass_id"].indexOf(a)>-1||(i&&(o+=","),o+='"'+a+'":'+common.ToJSONString(n.data[a]),i++)}else o+="id: null, classId: null, attrs: {";o+="}}}",projects.send({request:e,response:t,msg:o})},failure:function(s){projects.sendError({request:e,response:t,error:new VError(s,"projects.getObject")})}})}})}else s()},projects.removeObject=function(e,t,s){if("Object"==e.storageArea&&"remove"==e.storageFn){if(log.debug({cls:"projects",fn:"removeObject",params:e.storageParam}),"autologin"==e.session.username&&null==e.session.userId)return void projects.send({request:e,response:t,msg:"{header: {error: 'forbidden'}}"});if(e.session.revision)return void projects.send({request:e,response:t,msg:"{header: {error: 'read only mode (time machine)'}}"});if(projects.sessions[e.session.id].transaction.active){var r=e.storageCode,n=e.storageParam;projects.getStorage({request:e,response:t,storageCode:r,success:function(s){var r=s.storage;r.getObject({session:e.session,id:n,success:function(s){var r,n,o=s.object;o?(o.remove(),async.series([function(t){projects.removeObject.beforeCommit?projects.removeObject.beforeCommit({session:e.session,object:o,success:function(){t()}}):t()},function(t){o.commit({session:e.session,success:function(e){r=e.cascadeNum,n=e.setnullNum,t()},failure:t})}],function(s,o){s?projects.sendError({request:e,response:t,error:new VError(s,"projects.removeObject")}):projects.send({request:e,response:t,msg:"{header: {error: ''}, data: [], cascadeNum: "+r+", setnullNum: "+n+"}"})})):projects.send({request:e,response:t,msg:"{header: {error: ''}, data: []}"})},failure:function(s){projects.sendError({request:e,response:t,error:new VError(s,"projects.removeObject")})}})}})}else projects.sendError({request:e,response:t,error:"Transaction not active"})}else s()},projects.setAttrs=function(request,response,next){if("setAttrs"==request.storageFn){if(log.debug({cls:"projects",fn:"setAttrs",params:request.storageParam}),"autologin"==request.session.username&&null==request.session.userId)return void projects.send({request:request,response:response,msg:"{header: {error: 'forbidden'}}"});if(request.session.revision)return void projects.send({request:request,response:response,msg:"{header: {error: 'read only mode (time machine)'}}"});if(projects.sessions[request.session.id].transaction.active){var s=request.storageParam;s=s.substr(2,s.length-4);var tokens=eval(s),objectId=tokens[0],attrs=tokens[1],classId=tokens[2],storageCode=request.storageCode;projects.getStorage({request:request,response:response,storageCode:storageCode,success:function(e){var t=e.storage,s=function(e){var t=[],s=new Date,r=common.getUTCTimestamp(s);for(var n in attrs){var o=attrs[n].value;"$CURRENT_TIMESTAMP$"==o&&(o=r,t.push(n)),e.set(n,o)}async.series([function(t){projects.setAttrs.beforeCommit?projects.setAttrs.beforeCommit({session:request.session,object:e,success:function(){t(null,null)}}):t(null,null)},function(t){e.commit({session:request.session,success:function(){t(null,null)},failure:t})}],function(r,n){if(r)projects.sendError({request:request,response:response,error:new VError(r,"projects.setAttrs")});else{for(var o=0;o<t.length;o++)e.data[t[o]]=s;projects.send({request:request,response:response,msg:"{header: {error: ''}, data: "+common.ToJSONString(e.data)+"}"})}})};objectId?t.getObject({session:request.session,id:objectId,success:function(e){e.object?s(e.object):projects.send({request:request,response:response,msg:"{header: {error: ''},data: {id: null, classId: null, attrs: {}}}"})},failure:function(e){projects.sendError({request:request,response:response,error:new VError(e,"projects.setAttrs")})}}):t.createObject({session:request.session,classId:classId,success:function(e){e.object?s(e.object):projects.send({request:request,response:response,msg:"{header: {error: ''},data: {id: null, classId: null, attrs: {}}}"})},failure:function(e){projects.sendError({request:request,response:response,error:new VError(e,"projects.setAttrs")})}})}})}else projects.sendError({request:request,response:response,error:"Transaction not active"})}else next()},projects.execute=function(e,t,s){if("execute"==e.storageFn){var r=e.storageCode;projects.getStorage({request:e,response:t,storageCode:r,success:function(s){var r=s.storage;log.debug({cls:"projects",fn:"execute",params:e.storageParam});var n=JSON.parse(e.storageParam.substr(2,e.storageParam.length-4));r.execute({session:e.session,sql:n,resultText:!0,success:function(s){projects.send({request:e,response:t,msg:"{header: {error: ''},data: "+s.result+"}"})},failure:function(s){projects.sendError({request:e,response:t,error:new VError(s,"projects.execute")})}})}})}else s()},projects.news={},projects.news.message={},projects.news.getObj=function(e,t){var s=e.body.split(" ");if(2==s.length){var r=s[0],n=s[1];projects.getStorage({request:e,response:t,storageCode:r,success:function(s){var r=s.storage;setTimeout(function(){if(!projects.sessions[e.session.id])return t.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),void t.end("{header: {error: 'session removed'}, data: []}");var s=projects.news.message[e.session.id];if(s&&(s="'"+s+"'",delete projects.news.message[e.session.id]),0==n||n==r.lastRevision)t.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),t.end("{header: {error: ''}, revision: "+r.lastRevision+", objects: [], message: "+s+"}");else{var o=[];for(var i in r.revisions)i>n&&(o=o.concat(r.revisions[i].objects.changed));t.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),t.end("{header: {error: ''}, revision: "+r.lastRevision+", objects: "+JSON.stringify(o)+", message: "+s+"}")}projects.sessions[e.session.id].storage=r,projects.sessions[e.session.id].news.revision=r.lastRevision},config.news.pollingInterval)}})}else t.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),t.end("{header: {error: 'Incorrect format. Must be storageCode and revision.'}, data: []}")},projects.news.gc=function(){for(var e in projects.storagePool){var t,s=projects.storagePool[e];for(var r in projects.sessions){var n=projects.sessions[r].news;projects.sessions[r].storage==s&&(!t||n.revision<t)&&(t=n.revision)}for(var o in s.revisions)o<t&&(delete s.revisions[o],log.debug({cls:"projects",fn:"news.gc"},"revision "+o+" removed"))}setTimeout(projects.news.gc,config.news.gcInterval)},projects.removeSession=function(e){var t=e.success,s=e.sessionId;redisClient.hmget("sessions",[s+"-storageCode",s+"-username"],function(e,r){redisClient.hdel("sessions",s+"-id",s+"-username",s+"-clock",s+"-storageCode",s+"-newsRevision",s+"-port",s+"-userId",s+"-logined",s+"-ip"),redisPub.publish(config.redis.db+"-sessions",'{"removed":"'+s+'"}'),log.debug({cls:"projects",fn:"removeSession"},"session "+s+" removed"),t()})},projects.removeTimeoutSessions=function(){if(config.port==config.startPort||process.env.mainWorker){log.info({cls:"projects",fn:"projects.removeTimeoutSessions"});var e=config.session.timeoutInterval/1e3;redisClient.hgetall("sessions",function(t,s){var r=[];for(var n in s)if(n.indexOf("-clock")>-1&&config.clock>Number(s[n])&&config.clock-Number(s[n])>2*e){var o=n.substr(0,n.length-6);r.push(o),log.info({cls:"projects"},"session removing: "+o+" "+config.clock+" "+s[n]+" "+2*e)}async.map(r,function(t,r){async.series([function(e){var s=projects.sessions[t];s&&s.storage?s.storage.rollbackTransaction({session:s,success:function(t){e()}}):e()},function(r){projects.removeSession({sessionId:t,success:function(){log.info({cls:"projects"},"session removed: "+t+" "+config.clock+" "+s[t+"-clock"]+" "+e),r()}})}],function(e,t){r()})},function(e,t){})})}},projects.createStorages=function(e){var t=[];for(var s in config.storages)config.storages[s].hasOwnProperty("db")&&t.push(s);async.map(t,function(e,t){projects.getStorage({storageCode:e,success:function(e){t()},failure:function(e){log.error({cls:"projects",error:"Storage error: "+e.error}),t()}})},function(t,s){e.success()})},projects.getTableRecords=function(e){var t=e.request,s=e.response,r=e.table,n=e.fields,o=e.success,i=e;projects.getStorage({request:t,response:s,storageCode:e.storageCode,success:function(e){var t=e.storage;t.redisClient.hget(t.code+"-requests",r,function(e,s){if(s)i.result=s,
o.call(i.scope||this,i);else{var a="";"tview"==r&&(a=" and (fsystem is null or (fsystem is not null and fclass_id is not null))"),t.query({sql:"select\n\t"+n.join(",")+"\nfrom\n\t"+r+"\nwhere\n\t"+t.getCurrentFilter()+a+"\norder by fid",success:function(e){for(var s="[",a=e.result.rows,c=0;c<a.length;c++){c&&(s+=","),s+="[";for(var l=0;l<n.length;l++){l&&(s+=",");var f=a[c][n[l]];s+=common.ToJSONString(f)}"tview"==r&&(s+=", 0"),s+="]"}s+="]",t.redisClient.hset(t.code+"-requests",r,s),i.result=s,o.call(i.scope||this,i)}})}})}})},projects.sendTableRecords=function(e){e.scope=this,e.success=function(e){e.msg=e.result,projects.send(e)},projects.getTableRecords(e)},projects.getAll=function(e,t,s){if("getAll"==e.storageFn){log.debug({cls:"projects",fn:"getAll"});var r=function(s){var r=s.storage,n="{";async.parallel([function(s){projects.getTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tclass",fields:meta.fields.tclass,success:function(e){n+='"classes": '+e.result+",",s()}})},function(s){projects.getTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tclass_attr",fields:meta.fields.tclass_attr,success:function(e){n+='"classAttrs": '+e.result+",",s()}})},function(s){projects.getTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tview",fields:meta.fields.tview,success:function(e){n+='"views": '+e.result+",",s()}})},function(s){projects.getTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tview_attr",fields:meta.fields.tview_attr,success:function(e){n+='"viewAttrs": '+e.result+",",s()}})}],function(s,o){if(r.visualObjectum.timeMachine&&r.visualObjectum.timeMachine.dates)for(var i=r.visualObjectum.timeMachine.dates,a=0;a<i.length;a++)"string"==typeof i[a].date&&(i[a].date=new Date(i[a].date));n+='"visualObjectum": '+common.ToJSONString(r.visualObjectum)+",",n+='"all": 1}',r.redisClient.hset(r.code+"-requests","all",n),projects.send({request:e,response:t,msg:n})})};projects.getStorage({request:e,response:t,storageCode:e.storageCode,success:function(s){var n=s.storage;n.redisClient.hget(n.code+"-requests","all",function(n,o){o?projects.send({request:e,response:t,msg:o}):r(s)})}})}else s()},projects.getContent=function(e,t,s){if("getContent"==e.storageFn){log.debug({cls:"projects",fn:"getContent",params:e.storageParam});var r=e.storageCode;projects.getStorage({request:e,response:t,storageCode:r,success:function(s){var r=s.storage,n=e.storageParam.split(","),o=n.slice(6).join(",");o="!"==o[2]?o.substr(3,o.length-5):o.substr(2,o.length-4),o=JSON.parse(o),r.getContent({request:e,response:t,session:e.session,viewId:n[0],column:n[1],row:n[2],columnCount:n[3],rowCount:n[4],parentId:n[5],filter:o.filter,order:o.order,total:o.total,dateAttrs:o.dateAttrs,timeOffsetMin:o.timeOffsetMin,success:function(s){projects.send({request:e,response:t,msg:s.result})},failure:function(s){projects.sendError({request:e,response:t,error:new VError(s,"projects.getContent")})}})}})}else s()},projects.selectRows=function(e,t,s){if("selectRows"==e.storageFn){log.debug({cls:"projects",fn:"selectRows",params:e.storageParam});var r=e.storageCode;projects.getStorage({request:e,response:t,storageCode:r,success:function(s){var r=s.storage,n=e.storageParam.split(","),o=n[0],i=n.slice(2).join(",");i=i.substr(i.indexOf("[!")+2,i.indexOf("!]")-(i.indexOf("[!")+2)),i=JSON.parse(i),r.selectRow({request:e,response:t,session:e.session,viewId:o,viewFilter:i.viewFilter,selectFilter:i.selectFilter,success:function(s){projects.send({request:e,response:t,msg:"{header: {error: ''}, data: ["+s.result+"]}"})},failure:function(s){projects.sendError({request:e,response:t,error:new VError(s,"projects.selectRows")})}})}})}else s()},projects.reloadUniqueValues=function(e){var t=e.storage,s=e.success;async.map(t.classAttrs,function(e,s){if(e.get("funique")){var r=t.code+"-unique-"+e.get("fid");log.debug({cls:"projects"},"Unique values reloading: "+r),async.series([function(e){redisClient.del(r,function(t,s){e()})},function(t){"login"==e.get("fcode")?redisClient.sadd(r,"admin",function(e,s){t()}):t()},function(s){config.storages[t.code].autologin&&"login"==e.get("fcode")?redisClient.sadd(r,"autologin",function(e,t){s()}):s()},function(s){t.query({session:{userId:null},sql:"select "+e.toc+" from "+t.classesMap[e.get("fclass_id")].toc+" where "+e.toc+" is not null",success:function(t){var n=t.result.rows;async.map(n,function(t,s){redisClient.sadd(r,t[e.toc],function(e,t){s()})},function(e,t){s()})}})}],function(e,t){s()})}else s()},function(e,t){s()})},projects.exist=function(e){var t=e.request,s=e.response,r=e.storageCode,n=e.classCode,o=e.attrCode,i=e.value;projects.getStorage({request:t,response:s,storageCode:r,success:function(e){var t=e.storage,a=t.getClassAttr({classCode:n,attrCode:o});a&&redisClient.sismember(r+"-unique-"+a.get("fid"),i,function(e,t){s.writeHead(200,{"Content-Type":"text/html"}),t?s.end("1"):s.end("0")})}})},projects.upload=function(e,t,s){var r=e.session;if(e.url.indexOf("/upload")>-1&&projects.sessions[r.id]){var n=r.storage;if(config.storages[n.code].hasOwnProperty("upload")&&!config.storages[n.code].upload)return void projects.send({request:e,response:t,msg:"{success: false, error: 'upload disabled'}"});var o=new formidable.IncomingForm;o.uploadDir=n.rootDir+"/files",o.parse(e,function(s,r,o){if(o["file-path"]&&o["file-path"].name){var i=n.rootDir+"/files/"+r.objectId+"-"+r.classAttrId+"-"+o["file-path"].name;fs.rename(o["file-path"].path,i,function(s){s?(log.error({cls:"projects",fn:"upload",error:"rename error: "+s+", "+o["file-path"].path+" -> "+i}),projects.send({request:e,response:t,msg:"{success: false, error: '"+s+"'}"})):projects.send({request:e,response:t,msg:"{success: true, file: '"+o["file-path"].name+"'}"})})}else projects.send({request:e,response:t,msg:"{success: false}"})})}else s()},projects.sendmail=function(e,t,s){var r=e.session;if(e.url.indexOf("/sendmail")>-1&&projects.sessions[r.id]){var n=new formidable.IncomingForm;n.parse(e,function(s,n,o){if(s)return log.error({cls:"projects",fn:"sendmail",error:"sendmail error: "+JSON.stringify(s)+" fields: "+JSON.stringify(n)}),void projects.send({request:e,response:t,msg:"{success: false, error: '"+s+"'}"});var i=[];if(n.attachments){var a=projects.sessions[r.id].storage;_.each(JSON.parse(n.attachments),function(e){e.filePath&&(e.filePath=a.rootDir+"/files/"+e.filePath),i.push(e)})}mailSender.send({to:n.to,from:n.from,subject:n.subject,html:n.message,session:e.session,attachments:i,success:function(){log.info({cls:"projects",fn:"sendmail"},"mail sended: "+JSON.stringify(n)),projects.send({request:e,response:t,msg:"{success: true}"})},failure:function(s){log.error({cls:"projects",fn:"sendmail",error:"sendmail error: "+JSON.stringify(s)+" fields: "+JSON.stringify(n)}),projects.send({request:e,response:t,msg:"{success: false, error: '"+s+"'}"})}})})}else s()},projects.services={},projects.services.captcha=function(e,t,s){if(e.url.indexOf("/services")>-1&&1==e.query.captcha){projects.services.images=projects.services.images||[];var r=projects.services.images;r.length||(r.push("30E936A16BDF7A13E3854E793FAC7B09D4673EEB.png"),r.push("4802DE61A70652CD389E566D0794EC61D34EE385.png"),r.push("497CD952DFE895358336AE56AED144ED2179B458.png"),r.push("6480E7583A6D3FCBAD553C9FA7E6AAF5104B93C7.png"),r.push("67403548F8644A7F6320245A898BD49729660708.png"),r.push("6CA1E9A46879877B8C4309EE9C4BC773FBB6E468.png"),r.push("6E48C6506E6E63852526E0CF1808B548AEC5ABAE.png"),r.push("8E6E28B5D96B18D5C0EA8EB9A497AD66252196EE.png"),r.push("CE665C570F0DD9E93DE3DAA7EAEBC446CEC2E88B.png"),r.push("D93A9798AFC25B7261E8BB790BF1394C1557B61D.png"));var n="<img src='/client/extjs4/images/captcha/"+r[common.randomInt(0,r.length-1)]+"' width=170 height=30> ";t.send(n)}else s()},projects.logout=function(e,t,s){if(1==e.query.logout&&e.session){var r=e.query.sessionId;redisClient.hdel("sessions",r+"-id",r+"-username",r+"-clock",r+"-storageCode",r+"-newsRevision",r+"-port",r+"-userId",r+"-logined",r+"-ip"),redisPub.publish(config.redis.db+"-sessions",'{"removed":"'+r+'"}'),t.send("ok");var n=projects.sessions[r];n&&n.storage&&n.storage.rollbackTransaction({session:n})}else s()},projects.copyFile=function(e,t,s){if(e.url.indexOf("/copy_file?")==-1)return void s();var r=e.session;if(r&&r.storage){var n=r.storage,o=n.config.rootDir,i=e.query.src_object_id,a=e.query.src_class_attr_id,c=e.query.dst_object_id,l=e.query.dst_class_attr_id,f=e.query.filename,u=o+"/files/"+i+"-"+a+"-"+f,d=o+"/files/"+c+"-"+l+"-"+f;fs.readFile(u,function(e,s){e?t.send({err:1}):fs.writeFile(d,s,function(e){e?t.send({err:1}):t.send({ok:1})})})}else t.status(403).send("Invalid session")},projects.saveToFile=function(e,t,s){if(e.url.indexOf("/save_to_file?")==-1)return void s();var r=e.session;if(r&&r.storage){var n=r.storage,o=n.config.rootDir,i=e.query.object_id,a=e.query.class_attr_id,c=e.query.filename,l=o+"/files/"+i+"-"+a+"-"+c;fs.writeFile(l,e.body,function(e){e?t.send({err:1}):t.send({ok:1})})}else t.status(403).send("Invalid session")},projects.logLastTry=function(e,t,s){if(e.authRecords[t]&&e.authRecords[t].hasTryAttrs){var r,n=e.authRecords[t].objectId,o={id:"logLastTry-"+t,username:n,userId:n};async.series([function(t){e.getObject({session:o,id:n,success:function(e){r=e.object,t()}})},function(s){e.startTransaction({session:o,remoteAddr:"127.0.0.1",description:"logLastTry-"+t,success:function(){s()},failure:function(e){s(e)}})},function(n){s?(r.set("lastLogin",common.currentUTCTimestamp()),e.authRecords[t].tryNum=null,e.authRecords[t].lastTry=null):(r.set("lastTry",common.currentUTCTimestamp()),e.authRecords[t].tryNum=(e.authRecords[t].tryNum||0)+1,e.authRecords[t].lastTry=config.clock),r.commit({session:o,success:function(){n()}})},function(t){e.commitTransaction({session:o,success:function(){t()},failure:function(e){t(e)}})}],function(e){})}};var Query=function(e){var t=this,s=(e.success,e.storage),r=e.session||{userId:null},n=r.revision,o=e.sql.select,i=e.sql.from,a=e.sql.where,c=e.sql.order,l=e.sql.orderAfter,f={},u=[],d=[],g={};t.generate=function(){p(),h(i),t.selectSQL=y(o),t.whereSQL=x(a),t.orderSQL=q(c),t.fromSQL=j(i),t.attrs=f,t.fields=u,t.fieldNames=d,t.fieldTypeId=g,l&&(t.selectSQL="select * from (\n"+t.selectSQL,t.orderSQL+="\n) orderAfter "+C(l))};var p=function(){for(var e=0;e<i.length;e++){var t=i[e];if("object"==typeof t&&"[object Array]"!==Object.prototype.toString.call(t))for(var s in t){f[s]=f[s]||{},f[s].cls=t[s],f[s].toc={};break}}},m=function(e){for(var r=0;r<e.length;r++){var o=e[r];if("object"==typeof o)for(var i in o){if("id"==o[i]){var a=s.classesCode[f[i].cls].toc;n&&(a="tm_"+a),f[i].toc[a]=f[i].toc[a]||[],f[i].toc[a].indexOf("fobject_id")==-1&&f[i].toc[a].push("fobject_id")}else{f[i]||console.error("unknown attr: "+i);var a,c,l=t.sysCls.indexOf(f[i].cls);l>-1?(a=t.tables[l],c={toc:o[i].substr(3)}):(c=s.getClassAttr({classCode:f[i].cls,attrCode:o[i]}),a=s.classesMap[c.get("fclass_id")].toc,n&&(a="tm_"+a)),f[i].toc[a]=f[i].toc[a]||[],f[i].toc[a].indexOf(c.toc)==-1&&f[i].toc[a].push(c.toc)}break}}},h=function(e){for(var t=0;t<e.length;t++){var s=e[t];"left-join"!=s&&"inner-join"!=s||(m(e[t+3]),t+=3)}},v=1,b=function(e){var r="",o=e.distinct;for(var i in e)if("distinct"!=i){if("id"==e[i]){r=o?"distinct on ("+i+".fobject_id) "+i+".fobject_id":i+".fobject_id";var a=s.getClass({classCode:f[i].cls});if(!a)throw"query.fieldToSQL - unknown class: "+f[i].cls;var c=a.toc;n&&(c="tm_"+c),f[i].toc[c]=f[i].toc[c]||[],f[i].toc[c].indexOf("fobject_id")==-1&&f[i].toc[c].push("fobject_id"),v=2}else{if(!f[i])throw new VError("Unknown attr: "+i);var c,l=t.sysCls.indexOf(f[i].cls),u=s.getClassAttr({classCode:f[i].cls,attrCode:e[i]});l>-1?(c=t.tables[l],u.toc=e[i].substr(3)):(c=s.classesMap[u.get("fclass_id")].toc,n&&(c="tm_"+c)),r=o?"distinct on ("+i+"."+u.toc+") "+i+"."+u.toc:i+"."+u.toc,f[i].toc[c]=f[i].toc[c]||[],f[i].toc[c].indexOf(u.toc)==-1&&f[i].toc[c].push(u.toc),v=u.get("ftype_id")}break}return r},w=function(e){for(var s="",r=0;r<e.length;r++){s&&(s+=" ");var n=e[r];if("object"==typeof n)s+=common.isArray(n)?"("+w(n)+")":b(n);else if("number"==typeof n)s+=n;else if("string"==typeof n){var o=u.indexOf(n.toLowerCase()+"_");t.keywords.indexOf(n)>-1?s+=n:o>-1?!config.query.strictFilter&&r<e.length-2&&("like"==e[r+1]||"not like"==e[r+1])&&e[r+2]&&"string"==typeof e[r+2]?(s+="lower ("+d[o]+")",e[r+2]=e[r+2].toLowerCase()):s+=d[o]:s+="'"+n.split("'").join("''")+"'"}else s+=n}return s},y=function(e){for(var t="",r=0;r<e.length;r++){var n,o=e[r];if(common.isArray(o))t+=t?",\n\t":"\t",t+=w(o);else if("object"==typeof o)t+=t?",\n\t":"\t",n=b(o),t+=n;else{var i=o.toLowerCase()+"_";t+=" as "+i,r&&!common.isArray(e[r-1])&&(u.push(i),"distinct"==n.substr(0,8)&&(n=n.split(" ")[3]),d.push(n),g[i]=v)}}return"mssql"==s.client.database?"select top 9223372036854775807\n"+t+"\n":"select\n"+t+"\n"},j=function(e){if(!e)return"";for(var o=function(e){var o,i,a=[],c=[],l=[];for(o in e){i=e[o];break}var u;for(var d in f[o].toc){for(var g=f[o].toc[d],p=0;p<g.length;p++)a.push(d+"."+g[p]);t.tables.indexOf(d)==-1&&(u=d+".fobject_id")}for(var m=s.getClass(i);;){var h=t.sysCls.indexOf(i);if(h>-1){c.push(t.tables[h]);break}if(n?c.push("tm_"+m.toc):c.push(m.toc),!m.get("fparent_id"))break;m=s.classesMap[m.get("fparent_id")]}for(var p=1;p<c.length;p++)l.push(c[p-1]+".fobject_id="+c[p]+".fobject_id");if(n)for(var p=0;p<c.length;p++)t.tables.indexOf(c[p])==-1&&l.push(c[p]+".frevision_id="+n);l=l.length?" where "+l.join(" and "):"",u||(c.indexOf("tobject")>-1?u="tobject.fid":c.indexOf("tobject_attr")>-1&&(u="tobject_attr.fid"));var v=s.fireEvent("generatequeryblock",{cls:m,objectField:u,session:r,tables:c,where:l,alias:o});return v&&v.where&&(l=v.where),"mssql"==s.client.database?"(select top 9223372036854775807 "+a.join(",")+" from "+c.join(",")+l+") "+o:"(select "+a.join(",")+" from "+c.join(",")+l+") "+o},i="",a=0;a<e.length;a++)if(a){var c=e[a];"left-join"!=c&&"inner-join"!=c||(i+="\n\t"+c.split("-").join(" "),i+=" "+o(e[a+1]),i+=" on ("+w(e[a+3])+")",a+=3)}else i+="\t"+o(e[0]);return"from\n"+i+"\n"},x=function(e){return e&&e.length?"where\n\t"+w(e)+"\n":""},q=function(e){return e&&e.length?"order by\n\t"+w(e)+"\n":""},C=function(e){if(!e||!e.length)return"";for(var t="",s=0;s<e.length;s++)if(_.isObject(e[s])){for(var r=!1,n=0;n<o.length;n++){var i=o[n];_.isObject(i)&&_.keys(i)[0]==_.keys(e[s])[0]&&_.values(i)[0]==_.values(e[s])[0]&&(t+="orderAfter."+o[n+1]+"_ ",r=!0)}r||(t+="orderAfter."+_.values(e[s])[0]+"_ ")}else{var a=u.indexOf(e[s].toLowerCase()+"_");t+=a>-1?"orderAfter."+e[s]+"_ ":e[s]}return"order by\n\t"+t+"\n"}};Query.prototype.sysCls=["system.class","system.class_attr","system.view","system.view_attr","system.action","system.action_attrs","system.object","system.object_attr","system.revision"],Query.prototype.tables=["tclass","tclass_attr","tview","tview_attr","taction","taction_attrs","tobject","tobject_attr","trevision"],Query.prototype.keywords=["is null","is not null","on","in","not in","exist","not exist","like","not like","desc","DESC","asc","ASC","and","or","row_number ()","over","order by","<>",">",">=","<","<=","=","+","-","||","/",",","*","current_timestamp","lower","trim","ltrim","rtrim"],process.env.TZ="UTC",process.maxTickDepth=1/0,config.uncaughtException&&process.on("uncaughtException",function(e){console.log(e),console.log(e.stack);var t="["+common.currentDate()+" "+common.currentTime({msec:!0})+"] ",s=fs.openSync(config.rootDir+"/error.log","a",666);fs.writeSync(s,t+"Caught exception: "+e+"\n"+e.stack+"\n",null,"utf8"),fs.closeSync(s),process.exit(1)}),config.clock=parseInt((new Date).getTime()/1e3);var server={};server.cache={},server.www=function(e){var t=e.request,s=e.response,r=e.next,n=e.filePath,o=url.parse(t.url).pathname;if(!n){"/"==o&&(o="/index.html");o.split(".");n=config.wwwRoot+o}var i=o.split("/");if("wsdl"==i[3])return console.log(o,decodeURI(n)),void fs.readFile(decodeURI(n),function(e,t){var r=n.split(".");r=r[r.length-1],s.writeHead(200,{"Content-Type":mimetypes.lookup(r)}),s.end(t)});if(["client","third-party","favicon.ico"].indexOf(i[1])==-1&&["resources","locale","files",""].indexOf(i[3])==-1)return r();var a=n.split(".");if(a=a[a.length-1],config.caching&&config.caching.enabled&&!e.nocache){var c,l=200;async.series([function(e){fs.stat(n,function(s,r){if(s)e("File not found "+n);else{if(c=new Date(r.mtime).getTime(),server.cache[n])if(server.cache[n].mtime!=c)server.cache[n]=null;else if(t.headers["if-none-match"]){var o=t.headers["if-none-match"];o==server.cache[n].mtime&&(l=304)}e()}})},function(e){server.cache[n]?e():fs.readFile(n,function(t,s){t?e("File not found "+n):(server.cache[n]={mtime:c,data:s},e())})}],function(e,t){if(e)if(r)r(e);else try{s.writeHead(404,{"Content-Type":"text/html; charset=utf-8"}),s.end(e)}catch(e){}else try{if(304==l)s.sendStatus(304);else{var o={ETag:c,"Content-Type":mimetypes.lookup(a)};s.writeHead(l,o),s.end(server.cache[n].data)}}catch(e){}})}else fs.readFile(decodeURI(n),function(e,t){var r=n.split(".");r=r[r.length-1],s.writeHead(200,{"Content-Type":mimetypes.lookup(r)}),s.end(t)})},server.setVars=function(e,t,s){e.session=projects.sessions[e.query.sessionId]||{id:e.query.sessionId},redisClient.hset("sessions",e.query.sessionId+"-clock",config.clock),s()},server.loadData=function(e,t,s){var r=e.url.split("/");e.setEncoding("utf8"),e.on("data",function(t){"plugins"==r[3]&&console.log("loadData data",t?t.length:null),e.body?e.body+=t:e.body=t}),e.on("end",function(){"plugins"==r[3]&&console.log("loadData end"),s()})},server.middleBodyLoader=function(e,t,s){if(e.body){var r=e.body.split(".");r.length>2&&["Storage","Object","Class","ClassAttr","View","ViewAttr","Action"].indexOf(r[1])>-1&&(e.storageCode=r[0],e.storageArea=r[1],e.storageFn=r[2].substr(0,r[2].indexOf("(")),e.storageParam=e.body.substr(e.body.indexOf("(")+1,e.body.length-e.body.indexOf("(")-2),config.debug&&console.log("http.request.body: "+e.body))}s()},server.middleBodyParser=function(e,t,s){var r=new formidable.IncomingForm;try{r.parse(e,function(r,n,o){return r?(log.error({cls:"server",fn:"middleBodyParser",error:"middleBodyParser error: "+JSON.stringify(r)+" fields: "+JSON.stringify(n)}),void t.end("middleBodyParser error "+common.currentUTCTimestamp())):(e.fields=n,void s())})}catch(t){e.fields={},log.error({cls:"server",fn:"middleBodyParser",error:"middleBodyParser error: "+t}),s()}},server.requestStart=function(e,t,s){if(e.storageCode=e.storageCode||e.params.storage,"GET"!=e.method){var r="",n="";e.body&&e.url.indexOf("/upload")==-1&&(r=", body: "+JSON.stringify(e.body)),e.fields&&(n=', fields: "'+JSON.stringify(e.fields)+'"'),e.objectum={start:(new Date).getTime(),end:t.end},redisClient.hincrby("current-requests","sequence",1,function(o,i){t.end=function(t,s){var o=this;redisClient.hdel("current-requests",i,function(i,a){var c=((new Date).getTime()-e.objectum.start)/1e3;log.info({cls:"server",fn:"requestStart"},"duration: "+c+' sec., url: "'+e.url+'", ip: "'+common.getRemoteAddress(e)+'"'+r+n),c>60&&log.warn({cls:"server",fn:"requestStart"},"duration: "+c+' sec., url: "'+e.url+'", ip: "'+common.getRemoteAddress(e)+'"'+r+n);try{e.objectum.end.call(o,t,s)}catch(e){throw console.log(t+", error: "+e),e}})},redisClient.hset("current-requests",i,'{url: "'+e.url+'"'+r+n+', ts: "'+common.currentUTCTimestamp()+'"}',function(e,t){s()})})}else s()},server.stat=function(options){var request=options.request,response=options.response;if(config.admin.ip.indexOf(common.getRemoteAddress(request))==-1&&"all"!=config.admin.ip&&response.end("forbidden"),log.info({cls:"server",fn:"stat"},"ip: "+common.getRemoteAddress(request)+", query: "+JSON.stringify(request.query)),request.query.logs)return void redisClient.keys(config.redis.db+"-log-*",function(e,t){for(var s=0;s<t.length;s++)t[s]=t[s].substr((config.redis.db+"-log-").length);response.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),response.end(JSON.stringify(t))});if(request.query.log)return void redisClient.lrange(config.redis.db+"-log-"+request.query.log,0,-1,function(e,t){response.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),response.end(JSON.stringify(t))});if(request.query.restart)return redisPub.publish(config.redis.db+"-cluster","restart"),response.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),void response.end("ok");if(!request.query.data)return void fs.readFile(__dirname+"/www/client/stat/stat.html",function(e,t){response.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),response.end(t)});var allData={},num=0,online,lost,onlineNum,onlineNumMax,onlineNumMaxTS,started,memoryUsage,idle="";async.series([function(e){redisClient.hgetall("sessions",function(t,s){var r=[];for(var n in s)if(n.indexOf("-username")>-1){var o=n.substr(0,n.length-9);r.push({login:s[n],port:s[o+"-port"],storage:s[o+"-storageCode"],logined:s[o+"-logined"],ip:s[o+"-ip"]}),num++}allData.sessions=r,e()})},function(cb){redisClient.hgetall("current-requests",function(err,result){var data=[];for(var k in result){var r;try{r=eval("("+result[k]+")")}catch(e){r={body:result[k]}}data.push({url:r.url,body:r.body,fields:r.fields,ts:r.ts})}allData.unprocessed=data,cb()})},function(e){redisClient.hgetall("server-started",function(t,s){started=s,e()})},function(e){redisClient.hgetall("server-memoryusage",function(t,s){var r=[];for(var n in s){var o=JSON.parse(s[n]);r.push({pid:n,port:o.port,started:started[n],rssCurrent:o.current.rss,heapTotalCurrent:o.current.heapTotal,heapUsedCurrent:o.current.heapUsed,rssMax:o.max.rss,heapTotalMax:o.max.heapTotal,heapUsedMax:o.max.heapUsed})}allData.cluster=r,e()})},function(e){redisClient.get("online-num",function(t,s){onlineNum=s,redisClient.get("online-num-max",function(t,s){onlineNumMax=s,redisClient.get("online-num-max-ts",function(t,s){onlineNumMaxTS=s,e()})})})},function(e){var t;for(t in config.storages)if("postgres"==config.storages[t].database){var s=new db.Postgres({connection:config.storages[t]});return void s.connect({systemDB:!0,success:function(){s.query({sql:"select (date_part ('epoch', now () - query_start)) as duration, procpid, current_query\nfrom pg_stat_activity\nwhere current_query <> '<IDLE>' and date_part ('epoch', now () - query_start) > 0\norder by 1",success:function(t){for(var r=t.result.rows,n=[],o=0;o<r.length;o++)n.push({duration:r[o].duration,pid:r[o].procpid,query:r[o].current_query});allData.pgStat=n,s.disconnect(),e()},failure:function(){allData.pgStat=[],e()}})}})}e()}],function(e,t){response.send(JSON.stringify(allData))})},server.updateMemoryUsage=function(){server.memoryUsage=server.memoryUsage||{rss:0,heapTotal:0,heapUsed:0};var e=process.memoryUsage();e.rss=(e.rss/1048576).toFixed(3),e.heapTotal=(e.heapTotal/1048576).toFixed(3),e.heapUsed=(e.heapUsed/1048576).toFixed(3),server.memoryUsage.rss<e.rss&&(server.memoryUsage.rss=e.rss),server.memoryUsage.heapTotal<e.heapTotal&&(server.memoryUsage.heapTotal=e.heapTotal),server.memoryUsage.heapUsed<e.heapUsed&&(server.memoryUsage.heapUsed=e.heapUsed),redisClient.hset("server-memoryusage",process.pid,JSON.stringify({port:config.port,current:{rss:e.rss,heapTotal:e.heapTotal,heapUsed:e.heapUsed},max:{rss:server.memoryUsage.rss,heapTotal:server.memoryUsage.heapTotal,heapUsed:server.memoryUsage.heapUsed}}))},server.init=function(e){e=e||{},server.objectum=e.objectum;var t=e.success;server.app=express(),server.app.use(function(e,t,s){e.connection.setNoDelay(!0),s()}),server.app.get("/projects/*",server.setVars,server.processProjectPlugins,server.requestStart,xmlss.report,projects.services.captcha,projects.services.accountActivate,projects.services.restorePassword,projects.services.resetPassword,projects.copyFile,projects.getHandler),server.app.post("/projects/*",server.setVars,projects.upload,projects.sendmail,server.loadData,projects.saveToFile,server.middleBodyLoader,server.requestStart,server.processProjectPlugins,projects.checkAuth,projects.logout,projects.startTransaction,projects.commitTransaction,projects.rollbackTransaction,projects.removeObject,projects.getObject,projects.setAttrs,projects.execute,projects.getAll,projects.getViews,projects.getViewAttrs,projects.getClasses,projects.getClassAttrs,projects.getActions,projects.getActionAttrs,projects.getContent,projects.selectRows,meta.fnClass,meta.fnClassAttr,meta.fnView,meta.fnViewAttr,meta.fnAction,projects.gate1c,xlsx.report,pdf.report,dbf.report,xmlss.report,tm.getRevisions,tm.setRevision,function(e,t){log.error({cls:"server",fn:"init",error:"Unknown request: "+e.url+" body: "+e.body}),t.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),t.end("{header: {error: 'unknown request'}, data: []}")}),server.app.post("/objectum/obj_news",server.loadData,server.setVars,server.middleBodyLoader,projects.checkAuth,function(e,t){projects.news.getObj(e,t)}),server.app.all("/objectum/exist",server.requestStart,function(e,t){projects.exist({request:e,response:t,storageCode:e.query.storageCode,classCode:e.query.classCode,attrCode:e.query.attrCode,value:e.query.value})}),server.app.all("/objectum/stat",server.requestStart,function(e,t){server.stat({request:e,response:t})}),server.startPlugins({success:function(){function e(){global.gc&&(global.gc(),setTimeout(e,config.gcInterval||5e3))}server.app.get("*",server.requestStart,function(e,t,s){server.www({request:e,response:t,next:s})}),server.app.use(function(e,t,s,r){var n=e.message?e.message:e;log.error({cls:"server",fn:"init",error:"express exception: "+n+", stack: "+JSON.stringify(e.stack)}),s.status(500).send("{header: {error: '"+n+"', stack:'"+JSON.stringify(e.stack)+"'}}")}),setTimeout(e,5e3),setInterval(function(){config.clock=parseInt((new Date).getTime()/1e3),server.updateMemoryUsage()},1e3),projects.init({success:function(){t&&t()}})}})},server.startPlugins=function(e){e=e||{};var t=e.success;if(!config.plugins)return void(t&&t());var s=[];for(var r in config.plugins)s.push(r);async.map(s,function(e,t){var s=config.plugins[e];fs.exists(s.require,function(e){if(e){var r=require(s.require);s.module=r,async.series([function(e){r.init?r.init({objectum:server.objectum,success:function(){log.info({cls:"server",fn:"startPlugins"},"plugin "+s.require+" initialized."),e()},failure:function(t){log.error({cls:"server",fn:"startPlugins",error:s.require+" error: "+t}),e()}}):e()}],function(e,n){r.handler&&(server.app.all(s.path,r.handler),log.info({cls:"server",fn:"startPlugins"},"plugin "+s.require+" handler activated.")),t()})}else t()})},function(e,s){t&&t()})},server.projectPlugins={},server.processProjectPlugins=function(e,t,s){var r=e.url.split("/");if("plugins"==r[3]){var n=r[2];server.projectPlugins[n]?server.projectPlugins[n](e,t):projects.getStorage({request:e,res:t,storageCode:n,success:function(r){server.projectPlugins[n]?server.projectPlugins[n](e,t):s()}})}else s()},server.startWSDL=function(e){e=e||{};var t=e.success,s=[];for(var r in config.storages)s.push(r);async.map(s,function(e,t){var s=config.storages[e].rootDir+"/wsdl/wsdl.js";return config.storages[e].wsdl&&!config.storages[e].wsdl.enabled?void t():void fs.exists(s,function(r){r?projects.getStorage({storageCode:e,success:function(r){var n=require(s);r.storage.rootDir=config.storages[e].rootDir,n.start({objectum:server.objectum,storage:r.storage}),t()}}):t()})},function(e,s){t&&t()})},server.start=function(e,t){server.http=http.createServer(server.app);var s=e.port||config.startPort;config.port=s,async.series([function(e){config.createStoragesOnDemand?e():projects.createStorages({success:function(){console.log("Storages created."),projects.news.gc(),e()}})},function(e){s==config.startPort||process.env.mainWorker?(setInterval(function(){projects.removeTimeoutSessions()},config.session.gcInterval),setInterval(function(){mailSender.sendFailed()},config.mail.sendFailedInterval?config.mail.sendFailedInterval:12e5),config.redis.resetCache&&(redisClient.del("sessions"),redisClient.del("current-requests"),redisClient.del("server-memoryusage"),redisClient.del("files"),redisClient.del("files-mtime"),redisClient.keys("*-content",function(e,t){for(var s=0;s<t.length;s++)redisClient.del(t[s])}),redisClient.keys("*-clschange",function(e,t){for(var s=0;s<t.length;s++)redisClient.del(t[s])}),redisClient.keys("log-*",function(e,t){for(var s=0;s<t.length;s++)redisClient.del(t[s])}),redisClient.keys("*-objects",function(e,t){for(var s=0;s<t.length;s++)redisClient.del(t[s])}),redisClient.keys("*-data",function(e,t){for(var s=0;s<t.length;s++)redisClient.del(t[s])})),config.wsdl&&0==config.wsdl.enabled?e():server.startWSDL({success:e})):e()}],function(e,r){redisClient.hset("server-started",process.pid,common.currentUTCTimestamp()),server.http.listen(s,config.host,config.backlog),server.http.on("error",function(e){log.error({cls:"server",fn:"start",error:"http error: "+e})}),e?console.log("Objectum server start error: "+e+", port: "+s):console.log("Objectum server has started at port: "+s),t&&t(e)})};var hexcase=1,b64pad="",chrsz=8,sha={};sha.hex_sha1=function(e){return binb2hex(core_sha1(str2binb(e),e.length*chrsz))};var Storage=function(options){var storage=this;storage.client=null,storage.clientPool={},storage.getClient=function(e){if(e=e||{},e.session=e.session||{},storage.clientPool[e.session.id])return storage.clientPool[e.session.id];var t=db.create(storage);return t},storage.freeClient=function(e){var t=storage.clientPool[e.session.id];t&&(t.disconnect(),delete storage.clientPool[e.session.id])},storage.revision={},storage.queryCount=0,storage.query=function(e){var t=e;e.options=e.options||{};var s=e.session;storage.queryCount++;var r=e.client||storage.getClient(e);!function(){if(e.params)for(var t=0;t<e.params.length;t++)e.sql=e.sql.replace("$"+(t+1),"#"+(t+1))}(),function(){for(var t,s="",n="",o=0;o<e.sql.length;o++)t=e.sql[o],"$"==t?s?(s=s.substr(1),n+=r.tags.hasOwnProperty(s)?r.tags[s]:"$"+s+"$",s=""):s=t:s?s+=t:n+=t;s&&(n+=s),e.sql=n}(),function(){if(e.params)for(var t=0;t<e.params.length;t++)e.sql=e.sql.replace("#"+(t+1),"$"+(t+1))}(),r.query({sql:e.sql,params:e.params,success:function(e){s&&storage.clientPool[s.id]||r.inStorage||r.disconnect(),t.success&&t.success(e)},failure:function(e){s&&storage.clientPool[s.id]||r.inStorage||r.disconnect(),t.failure&&t.failure(new VError(e,"Storage.query"))}})},storage.maxRevision=2147483647,storage.getCurrentFilter=function(e){var t,s="";return e&&e.alias&&(s=e.alias+"."),t="("+s+"fend_id = "+this.maxRevision+")"},storage.createRevision=function(e){var t=e.success,s=e.description,r=e.session,n=e.remoteAddr||r.ip,o=storage.clientPool[r.id];o.getNextId({session:r,table:"trevision",success:function(e){var i=e.id;storage.lastRevision=i,n=n?"'"+n+"'":"null",r.userId=r.userId||"null";var a="insert into trevision (fid, fdate, fdescription, fsubject_id, fremote_addr)\nvalues ("+i+", "+o.currentTimestamp()+", '"+s+"', "+r.userId+", "+n+")";storage.query({session:r,sql:a,success:function(e){t&&t({id:i})},failure:function(t){e.failure&&e.failure(new VError(t,"Storage.createRevision"))}})},failure:function(t){e.failure&&e.failure(new VError(t,"Storage.createRevision"))}})},storage.inTransaction=function(e){return storage.clientPool[e.id]},storage.startTransaction=function(e){e=e||{},e.session=e.session||{};var t=e.success,s=e.failure,r=e.session;log.debug({cls:"Storage",fn:"startTransaction",params:e.description}),async.series([function(e){storage.clientPool[r.id]?storage.rollbackTransaction({session:r,success:function(){e()},failure:e}):e()}],function(n,o){var i=db.create(storage);i.connect({success:function(){i.startTransaction({success:function(){storage.clientPool[r.id]=i,e.success=function(e){storage.revision[r.id]=e.id,storage.revisions[e.id]={id:e.id,dirty:!0,objects:{changed:[],created:[],removed:[],classId:{}},classes:{changed:[],created:[],removed:[]},classAttrs:{changed:[],created:[],removed:[]},views:{changed:[],created:[],removed:[]},viewAttrs:{changed:[],created:[],removed:[]}},t&&t({revision:e.id})},e.failure=function(e){s&&s(new VError(e,"Storage.startTransaction"));
},storage.createRevision(e)},failure:function(e){s&&s(new VError(e,"Storage.startTransaction"))}})},failure:function(e){s&&s(new VError(e,"Storage.startTransaction"))}})})},storage.commitTransaction=function(e){log.debug({cls:"Storage",fn:"commitTransaction"}),e=e||{},e.session=e.session||{};var t=e.session,s=e.failure;if(storage.revision[t.id]){var r=storage.clientPool[t.id];r?r.commitTransaction({success:function(){delete storage.clientPool[t.id],r.disconnect();var s=storage.revision[t.id];storage.revisions[s]&&(storage.revisions[s].dirty=!1,storage.redisPub.publish(config.redis.db+"-"+storage.code+"-revisions",JSON.stringify(storage.revisions[s]))),delete storage.revision[t.id],e.success&&e.success({revision:s})},failure:function(e){s&&s(new VError(e,"Storage.commitTransaction"))}}):(delete storage.clientPool[t.id],e.success&&e.success({}))}else e.success&&e.success({})},storage.rollbackTransaction=function(e){log.debug({cls:"Storage",fn:"rollbackTransaction"}),e=e||{},e.session=e.session||{};var t=e.session;if(storage.revision[t.id]){var s=storage.clientPool[t.id];if(!s){var r=storage.revision[t.id];return delete storage.revisions[r],delete storage.revision[t.id],void(e.success&&e.success({revision:r}))}s.rollbackTransaction({success:function(){delete storage.clientPool[t.id],s.disconnect();var r=storage.revision[t.id];delete storage.revisions[r],delete storage.revision[t.id],e.success&&e.success({revision:r})},failure:function(t){e.failure&&e.failure(new VError(t,"Storage.rollbackTransaction"))}})}else e.success&&e.success({})},storage.classes=null,storage.classesMap=null,storage.classesCode=null,storage.classesTree=null,storage.initClasses=function(e){log.debug({cls:"Storage",fn:"initClasses"}),e=e||{};var t=e.success;e.session=e.session||{};var s=e.session;storage.query({session:s,sql:"select * from tclass where "+storage.getCurrentFilter(),success:function(e){var s=e.result.rows,r=[];for(var n in s[0])r.push(n);storage.classes=[],storage.classesMap={};for(var o=0;o<s.length;o++){for(var i=new storage.tobject({code:"tclass"}),a=0;a<r.length;a++)i.data[r[a]]=s[o][r[a]];i.toc=i.get("fcode").toLowerCase()+"_"+i.get("fid"),i.childs=[],i.attrs={},storage.classes.push(i),storage.classesMap[i.get("fid")]=i}storage.classesTree={},storage.classesCode={};var c=function(e){for(var t=0;t<storage.classes.length;t++){var s=storage.classes[t];if(s.get("fparent_id")==e.parent){e.parent&&storage.classesMap[e.parent].childs.push(s.get("fid")),e.node[s.get("fcode")]={id:s.get("fid")};var r=e.code?e.code+"."+s.get("fcode"):s.get("fcode");storage.classesCode[r]=s;var n=r.split(".");3==n.length&&(storage.classesCode[n[0]+"."+n[2]]=storage.classesCode[n[0]+"."+n[2]]||s),4==n.length&&(storage.classesCode[n[0]+"."+n[3]]=storage.classesCode[n[0]+"."+n[3]]||s),c({node:e.node[s.get("fcode")],parent:s.get("fid"),code:r})}}};c({node:storage.classesTree,parent:null}),t&&t()}})},storage.getClassFullCode=function(e){if(!e)return e;var t=e.get("fcode");return e.get("fparent_id")&&(t=storage.getClassFullCode(storage.classesMap[e.get("fparent_id")])+"."+t),t},storage.updateClassCache=function(e){var t=e.fields,s=e.values,r=storage.classesMap[s[0]]||new storage.tobject({code:"tclass"});s[1]&&storage.classesMap[s[1]].childs.splice(storage.classesMap[s[1]].childs.indexOf(s[0],1));for(var n=0;n<t.length;n++)r.data[t[n]]=s[n];if(r.toc=r.get("fcode").toLowerCase()+"_"+r.get("fid"),storage.classesMap[r.get("fid")]||(r.childs=[],r.attrs={},storage.classes.push(r),storage.classesMap[r.get("fid")]=r),r.get("fparent_id")){storage.classesMap[r.get("fparent_id")].childs.indexOf(r.get("fid"))==-1&&storage.classesMap[r.get("fparent_id")].childs.push(r.get("fid"));var o=storage.getClassFullCode(r);storage.classesCode[o]=r;var i=o.split(".");3==i.length&&(storage.classesCode[i[0]+"."+i[2]]=storage.classesCode[i[0]+"."+i[2]]||r),4==i.length&&(storage.classesCode[i[0]+"."+i[3]]=storage.classesCode[i[0]+"."+i[3]]||r)}else storage.classesCode[r.get("fcode")]=r},storage.updateClassAttrCache=function(e){var t=e.fields,s=e.values,r=storage.classAttrsMap[s[0]]||new storage.tobject({code:"tclass_attr"});if(storage.classesMap[s[1]]){var n=function(e){e.attrs=e.attrs||{},delete e.attrs[s[3]];for(var t=0;t<e.childs.length;t++)n(storage.classesMap[e.childs[t]])};n(storage.classesMap[s[1]])}for(var o=0;o<t.length;o++)r.data[t[o]]=s[o];if(r.toc=r.get("fcode").toLowerCase()+"_"+r.get("fid"),storage.classAttrsMap[r.get("fid")]||(storage.classAttrs.push(r),storage.classAttrsMap[r.get("fid")]=r),storage.classesMap[r.get("fclass_id")]){var i=function(e){e.attrs=e.attrs||{},e.attrs[r.get("fcode")]=r;for(var t=0;t<e.childs.length;t++)i(storage.classesMap[e.childs[t]])};i(storage.classesMap[r.get("fclass_id")])}},storage.getViewFullCode=function(e){if(!e)return e;var t=e.get("fcode");return e.get("fparent_id")&&(t=storage.getViewFullCode(storage.viewsMap[e.get("fparent_id")])+"."+t),t},storage.updateViewCache=function(e){for(var t=e.fields,s=e.values,r=storage.viewsMap[s[0]]||new storage.tobject({code:"tview"}),n=0;n<t.length;n++)r.data[t[n]]=s[n];if(storage.viewsMap[r.get("fid")]||(r.attrs={},storage.views.push(r),storage.viewsMap[r.get("fid")]=r),r.get("fparent_id")){var o=storage.getViewFullCode(r);storage.viewsCode[o]=r;var i=o.split(".");3==i.length&&(storage.viewsCode[i[0]+"."+i[2]]=storage.viewsCode[i[0]+"."+i[2]]||r),4==i.length&&(storage.viewsCode[i[0]+"."+i[3]]=storage.viewsCode[i[0]+"."+i[3]]||r)}else storage.viewsCode[r.get("fcode")]=r},storage.updateViewAttrCache=function(e){for(var t=e.fields,s=e.values,r=storage.viewAttrsMap[s[0]]||new storage.tobject({code:"tview_attr"}),n=0;n<t.length;n++)r.data[t[n]]=s[n];storage.viewAttrsMap[r.get("fid")]||(storage.viewAttrs.push(r),storage.viewAttrsMap[r.get("fid")]=r);var o=storage.viewsMap[r.get("fview_id")];o&&(o.attrs=o.attrs||{},o.attrs[r.get("fcode")]=r)},storage.classAttrs=null,storage.classAttrsMap=null,storage.initClassAttrs=function(e){log.debug({cls:"storage",fn:"initClassAttrs"}),e=e||{};var t=e.success;e.session=e.session||{};var s=e.session;storage.query({session:s,sql:"select * from tclass_attr where "+storage.getCurrentFilter(),success:function(e){var s=e.result.rows,r=[];for(var n in s[0])r.push(n);storage.classAttrs=[],storage.classAttrsMap={};for(var o=0;o<s.length;o++){for(var i=new storage.tobject({code:"tclass_attr"}),a=0;a<r.length;a++)i.data[r[a]]=s[o][r[a]];if(i.toc=i.get("fcode").toLowerCase()+"_"+i.get("fid"),storage.classAttrs.push(i),storage.classAttrsMap[i.get("fid")]=i,storage.classesMap[i.get("fclass_id")]){var c=function(e){e.attrs=e.attrs||{},e.attrs[i.get("fcode")]=i;for(var t=0;t<e.childs.length;t++)c(storage.classesMap[e.childs[t]])};c(storage.classesMap[i.get("fclass_id")])}}t&&t()}})},storage.views=null,storage.viewsMap=null,storage.viewsCode=null,storage.viewsTree=null,storage.initViews=function(e){log.debug({cls:"storage",fn:"initViews"}),e=e||{};var t=e.success;e.session=e.session||{};var s=e.session;storage.query({session:s,sql:"select * from tview where "+storage.getCurrentFilter(),success:function(e){var s=e.result.rows,r=[];for(var n in s[0])r.push(n);storage.views=[],storage.viewsMap={};for(var o=0;o<s.length;o++){for(var i=new storage.tobject({code:"tview"}),a=0;a<r.length;a++)i.data[r[a]]=s[o][r[a]];storage.views.push(i),storage.viewsMap[i.get("fid")]=i}storage.viewsTree={},storage.viewsCode={};var c=function(e){for(var t=0;t<storage.views.length;t++){var s=storage.views[t];if(s.get("fparent_id")==e.parent){e.node[s.get("fcode")]={id:s.get("fid")};var r=e.code?e.code+"."+s.get("fcode"):s.get("fcode");if(storage.viewsCode[r]=s,r){var n=r.split(".");3==n.length&&(storage.viewsCode[n[0]+"."+n[2]]=storage.viewsCode[n[0]+"."+n[2]]||s),4==n.length&&(storage.viewsCode[n[0]+"."+n[3]]=storage.viewsCode[n[0]+"."+n[3]]||s)}c({node:e.node[s.get("fcode")],parent:s.get("fid"),code:r})}}};c({node:storage.viewsTree,parent:null}),t&&t()}})},storage.viewAttrs=null,storage.viewAttrsMap=null,storage.initViewAttrs=function(e){log.debug({cls:"storage",fn:"initViewAttrs"}),e=e||{};var t=e.success;e.session=e.session||{};var s=e.session;storage.query({session:s,sql:"select * from tview_attr where "+storage.getCurrentFilter(),success:function(e){var s=e.result.rows,r=[];for(var n in s[0])r.push(n);storage.viewAttrs=[],storage.viewAttrsMap={};for(var o=0;o<s.length;o++){for(var i=new storage.tobject({code:"tview_attr"}),a=0;a<r.length;a++)i.data[r[a]]=s[o][r[a]];null!=i.get("fcode")&&(i.toc=i.get("fcode").toLowerCase()+"_"+i.get("fid"),storage.viewAttrs.push(i),storage.viewAttrsMap[i.get("fid")]=i,storage.viewsMap[i.get("fview_id")]&&(storage.viewsMap[i.get("fview_id")].attrs=storage.viewsMap[i.get("fview_id")].attrs||{},storage.viewsMap[i.get("fview_id")].attrs[i.get("fcode")]=i))}t&&t()}})},storage.findNode=function(e){log.debug({cls:"storage",fn:"findNode"});var t,s=e.node,r=e.path;"string"==typeof r&&(r=r.split("."));var n=r[0];return s.hasOwnProperty(n)&&(r.length>1?(r.splice(0,1),t=storage.findNode({node:s[n],path:r})):t=s[n]),"object"==typeof t&&(t=t.id),t},storage.getClass=function(e){if(log.debug({cls:"storage",fn:"getClass"}),"number"==typeof e){if(storage.classesMap[e])return storage.classesMap[e];throw new VError("storage.getClass - Unknown classId: "+e)}"string"==typeof e&&(e={code:e});var t=e.classCode||e.code;if(storage.classesCode[t])return storage.classesCode[t];if(storage.classesMap[t])return storage.classesMap[t];throw new VError("storage.getClass - Unknown classCode: "+t)},storage.getClassAttr=function(e){function t(s){if(s.attrs&&s.attrs[e.attrCode])return s.attrs[e.attrCode];if(s.get("fparent_id"))return t(storage.classesMap[s.get("fparent_id")]);throw new Error("storage.getClassAttr - Unknown attrCode: "+e.attrCode+" (classId: "+(e.classId||e.classCode)+")")}if(log.debug({cls:"storage",fn:"getClassAttr ("+JSON.stringify(e)+")"}),"number"==typeof e){if(storage.classAttrsMap[e])return storage.classAttrsMap[e];throw new Error("storage.getClassAttr - Unknown classAttrId: "+e)}var s;if(s=e.classCode?storage.classesCode[e.classCode]:storage.classesMap[e.classId]){var r=t(s);return r}throw new Error("storage.getClassAttr - Unknown classCode: "+e.classCode+" (classId: "+e.classId||e.classCode+")")},storage.getObject=function(options){log.debug({cls:"Storage",fn:"getObject",id:options.id}),options=options||{};var success=options.success,failure=options.failure,objectId=options.id;options.session=options.session||{};var session=options.session;storage.redisClient.hset("sessions",session.id+"-clock",config.clock);var revision=session.revision;if(!objectId||NaN==Number(objectId))return void(success&&success({object:null}));var object;async.series([function(e){storage.fireEvent("beforegetobject",{objectId:objectId,session:session,storage:storage,success:function(t){t&&t.cancel?e("cancel"):e()}})},function(cb){storage.redisClient.hmget(storage.code+"-objects"+(revision||""),[objectId+"-data"],function(err,result){var o=new storage.tobject({code:"tobject"});if(result&&result[0]){o.data=eval("("+result[0]+")"),o.originalData={};for(var attr in o.data)o.originalData[attr]=o.data[attr];object=o,cb()}else if(revision){var cls,row;async.series([function(e){storage.query({session:session,sql:"select fclass_id from tobject where fid="+objectId,success:function(t){cls=storage.getClass(t.result.rows[0].fclass_id),e()}})},function(e){function t(e){for(var t in e)r.push(e[t].toc)}function s(e){if(e){var r=storage.getClass(e);n+="left join tm_"+r.toc+" on (tm_"+r.toc+".fobject_id=tm_"+cls.toc+".fobject_id and tm_"+r.toc+".frevision_id=tm_"+cls.toc+".frevision_id)\n",t(r.attrs),s(r.get("fparent_id"))}}var r=[];t(cls.attrs);var n="";s(cls.get("fparent_id"));var o="select "+r.join(", ")+" from tm_"+cls.toc+"\n"+n+"where tm_"+cls.toc+".fobject_id="+objectId+" and tm_"+cls.toc+".frevision_id="+revision;storage.query({session:session,sql:o,success:function(t){row=t.result.rows[0],e()}})},function(e){o.data.id=objectId,o.data.fclass_id=cls.get("fid");for(var t in cls.attrs){var s=cls.attrs[t];o.data[t]=row[s.toc],o.originalData[t]=row[s.toc]}var r={};r[objectId+"-data"]=o.dataToJSONString(!0),storage.redisClient.hmset(storage.code+"-objects"+revision,r),object=o,e()}],function(e){cb()})}else{var select="select a.fclass_attr_id, a.fstring, a.ftime, fnumber, b.fclass_id";storage.query({session:session,sql:select+"\nfrom tobject b\nleft join tobject_attr a on (a.fobject_id=b.fid and "+storage.getCurrentFilter({alias:"a"})+")\nwhere b.fid="+objectId+" and "+storage.getCurrentFilter({alias:"b"}),success:function(e){if(e&&e.result&&e.result.rows&&0!=e.result.rows.length){var t=e.result.rows;o.data.id=objectId,o.data.fclass_id=t[0].fclass_id;for(var s=0;s<t.length;s++)if(t[s].fclass_attr_id){var r=storage.classAttrsMap[t[s].fclass_attr_id];if(r){var n;n=1==r.get("ftype_id")||5==r.get("ftype_id")?t[s].fstring:3==r.get("ftype_id")?t[s].ftime:t[s].fnumber,o.data[r.get("fcode")]=n,o.originalData[r.get("fcode")]=n}}if(!storage.revision[session.id]){var i={};i[objectId+"-data"]=o.dataToJSONString(!0),storage.redisClient.hmset(storage.code+"-objects",i)}object=o,cb()}else object=null,cb()},failure:cb})}})},function(e){storage.fireEvent("aftergetobject",{object:object,session:session,storage:storage,success:function(t){t&&t.cancel?e("cancel"):e()}})}],function(e,t){success(e?{object:null}:{object:object})})},storage.createObject=function(e){"string"==typeof e&&(e={code:e}),log.debug({cls:"Storage",fn:"createObject",params:e.classId||e.code}),e=e||{};var t=e,s=e.success,r=e.failure,n=e.classId||storage.getClass(e.code).get("fid"),o=e.options||{};e.session=e.session||{};var i=e.session;async.series([function(e){storage.fireEvent("beforecreateobject",{classId:n,session:i,storage:storage,success:function(t){t&&t.cancel?e("cancel"):e()}})}],function(e,a){return"cancel"!=e&&storage.revision[i.id]?(storage.clsChange({classId:n}),void storage.client.getNextId({session:i,table:"tobject",success:function(e){var a=[],c=t.objectId||e.id;a.push("insert into tobject (fid, fclass_id, fstart_id, fend_id)\nvalues ("+c+","+n+","+storage.revision[i.id]+","+storage.maxRevision+")");var l=function(e){var t=storage.classesMap[e.classId],s=t.get("fcode")+"_"+e.classId;a.push("insert into "+s+" (fobject_id) values ("+c+")"),t.get("fparent_id")&&l({classId:t.get("fparent_id")})};l({classId:n}),async.eachSeries(a,function(e,t){storage.query({session:i,sql:e,success:function(e){t()},failure:t})},function(e){if(e)r&&r(new VError(e,"Storage.createObject"));else if(s){var t=new storage.tobject({code:"tobject"});t.data.id=c,t.data.fclass_id=n,o.object=t;var a={};a[c+"-data"]=t.dataToJSONString(),storage.redisClient.hmset(storage.code+"-objects",a),storage.revisions[storage.revision[i.id]]&&(storage.revisions[storage.revision[i.id]].objects.created.push(c),storage.revisions[storage.revision[i.id]].objects.classId[c]=n),storage.fireEvent("aftercreateobject",{classId:n,session:i,object:t,storage:storage,success:function(e){s(o)}})}})},failure:function(e){r&&r(new VError(e,"Storage.createObject"))}})):(console.log("cancel or no transaction, session "+JSON.stringify(i)),void s({object:null}))})},storage.tobject=function(e){var t=this;t.code=e.code,t.data={},t.originalData={},t.removed=!1},storage.tobject.prototype.get=function(e){return this.data[e]},storage.tobject.prototype.set=function(e,t){this.data[e]=t},storage.getClassAttrs=function(e){log.debug({cls:"storage",fn:"getClassAttrs"}),e.result=e.result||{};for(var t=0;t<storage.classAttrs.length;t++)storage.classAttrs[t].get("fclass_id")==e.classId&&(e.result[storage.classAttrs[t].get("fcode")]=storage.classAttrs[t]);return storage.classesMap[e.classId].get("fparent_id")&&(e.classId=storage.classesMap[e.classId].get("fparent_id"),storage.getClassAttrs(e)),e.result},storage.getDependentObjects=function(e){var t=e.session,s=e.object,r=e.success,n=e.failure,o=function(e){var t=[e],s=storage.classesMap[e];return s.get("fparent_id")&&(t=t.concat(o(s.get("fparent_id")))),t},i=function(e){for(var t=[e],s=storage.classesMap[e],r=0;r<s.childs.length;r++)t=t.concat(i(storage.classesMap[s.childs[r]].get("fid")));return t},a=o(s.data.fclass_id).concat(i(s.data.fclass_id));a.push(12);for(var c=[],l=0;l<storage.classAttrs.length;l++){var f=storage.classAttrs[l];a.indexOf(f.get("ftype_id"))>-1&&c.push(f.get("fid"))}if(c.length){var u=[],d=[];storage.query({session:t,sql:"select fobject_id, fclass_attr_id from tobject_attr\nwhere fclass_attr_id in ("+c.join(",")+") and fnumber="+s.data.id+" and "+storage.getCurrentFilter()+"\n",success:function(e){for(var t=e.result.rows,s=0;s<t.length;s++){var n=storage.classAttrsMap[t[s].fclass_attr_id].get("fremove_rule");"cascade"==n?u.push(t[s].fobject_id):d.push({id:t[s].fobject_id,attrCode:f.get("fcode")})}r({cascade:u,setnull:d})},failure:function(e){n&&n(new VError(e,"Storage.getDependentObjects"))}})}else r({cascade:u,setnull:d})},storage.removeObject=function(e){var t=e.session;storage.redisClient.hset("sessions",t.id+"-clock",config.clock);var s=function(e){var s=e.object,r=s.data.id,n=e.success,o=e.failure,i=[];i.push("update tobject set fend_id="+storage.revision[t.id]+" where fend_id="+storage.maxRevision+" and fid="+r);var a=function(e){var t=storage.classesMap[e.classId],s=t.get("fcode")+"_"+e.classId;i.push("delete from "+s+" where fobject_id="+r),t.get("fparent_id")&&a({classId:t.get("fparent_id")})};a({classId:s.data.fclass_id}),async.map(i,function(e,s){storage.query({session:t,sql:e,success:function(){s()},failure:s})},function(e,t){if(e&&o)return o(new VError(e,"Storage.removeSingleObject"));var i=storage.classesMap[s.data.fclass_id],a=[];for(var c in s.originalData)s.originalData[c]&&a.push(c);async.map(a,function(e,t){var r=i.attrs[e];if(r&&r.get("funique")){var n=storage.code+"-unique-"+r.get("fid");storage.redisClient.srem(n,s.originalData[e],function(e,s){t()})}else t()},function(e,t){storage.redisClient.hdel(storage.code+"-objects",r+"-data",function(e,t){n&&n()})})})},r=e.success,n=(e.failure,e);if(!e.object)return void(r&&r({cascadeNum:0,setnullNum:0}));var o,i,a,c;async.series([function(s){storage.fireEvent("beforeremoveobject",{object:e.object,session:t,storage:storage,success:function(e){e&&e.cancel?s("cancel"):s()}})},function(r){storage.suspendEvent("beforeremoveobject"),storage.getDependentObjects({session:t,object:e.object,success:function(e){o=e.cascade,i=o.length,a=e.setnull,c=a.length,async.parallel([function(e){async.map(a,function(e,s){storage.getObject({session:t,id:e.id,success:function(r){var n=r.object;n?(n.set(e.attrCode,null),n.commit({session:t,success:function(){s()},failure:function(e){s()}})):s()},failure:function(e){s()}})},function(t,s){e()})},function(e){async.map(o,function(e,s){storage.getObject({session:t,id:e,success:function(e){storage.removeObject({session:t,object:e.object,success:function(e){i+=e.cascadeNum,c+=e.setnullNum,s()},failure:function(e){s()}})},failure:function(e){s()}})},function(t,s){e()})},function(e){n.success=function(){e()},n.failure=function(){e()},s(n)}],function(e,t){r()})},failure:r})}],function(e,t){storage.resumeEvent("beforeremoveobject"),"cancel"==e?r&&r({cascadeNum:0,setnullNum:0}):r&&r({cascadeNum:i,setnullNum:c})})},storage.tobject.prototype.commit=function(e){log.debug({cls:"Object",fn:"commit"}),e=e||{},e.session=e.session||{};var t=e.session;storage.redisClient.hset("sessions",t.id+"-clock",config.clock);var s=e.success,r=e.failure,n=this.data.id,o=this;async.series([function(e){o.removed?e():storage.fireEvent("beforecommitobject",{object:o,session:t,storage:storage,success:function(t){t&&t.cancel?e("cancel"):e()}})}],function(e,i){if("cancel"==e||!storage.revision[t.id])return void(s&&s());if(storage.revisions[storage.revision[t.id]]&&(storage.revisions[storage.revision[t.id]].objects.changed.push(n),storage.revisions[storage.revision[t.id]].objects.classId[n]=o.get("fclass_id")),o.removed)storage.revisions[storage.revision[t.id]]&&storage.revisions[storage.revision[t.id]].objects.removed.push(n),storage.clsChange({session:t,classId:o.get("fclass_id")}),storage.removeObject({session:t,object:o,success:s,failure:function(e){r(new VError(e,"Object.commit"))}});else{var a=[];for(var c in o.data)["id","fclass_id"].indexOf(c)>-1||(_.isDate(o.originalData[c])&&(o.originalData[c]=common.getLocalISOString(o.originalData[c])),_.isDate(o.data[c])&&(o.data[c]=common.getLocalISOString(o.data[c])),o.originalData.hasOwnProperty(c)&&o.originalData[c]==o.data[c]||a.push(c));a.length?async.series([function(e){var t=storage.classesMap[o.data.fclass_id];async.map(a,function(e,s){var r=t.attrs[e];if(r&&r.get("funique")){var n=storage.code+"-unique-"+r.get("fid");async.series([function(t){o.data[e]?storage.redisClient.sadd(n,o.data[e],function(s,r){r?t():t("value exists: "+o.data[e])}):t()},function(t){o.originalData[e]?storage.redisClient.srem(n,o.originalData[e],function(e,s){t()}):t()}],function(e,t){s(e)})}else s()},function(t,s){e(t)})},function(e){storage.clsChange({session:t,classId:o.get("fclass_id")});for(var s=storage.getClassAttrs({classId:o.get("fclass_id")}),r={},i=[],c=[],l=[],f=0;f<a.length;f++){var u=o.data[a[f]];u!==!0&&u!==!1||(u=Number(u));var d=s[a[f]];if(d){c.push({sql:"update tobject_attr set fend_id="+storage.revision[t.id]+"\nwhere fobject_id="+n+" and fclass_attr_id="+d.get("fid")+" and fend_id="+storage.maxRevision});var g="fnumber";1==d.get("ftype_id")||5==d.get("ftype_id")?g="fstring":3==d.get("ftype_id")&&(g="ftime","string"==typeof u&&""==(u||"").trim()&&(u=null)),"fnumber"!=g||!isNaN(u)&&""!==u||(u=null),l.push({sql:"insert into tobject_attr (fobject_id, fclass_attr_id, "+g+", fstart_id, fend_id)\nvalues ("+n+","+d.get("fid")+", $1, "+storage.revision[t.id]+","+storage.maxRevision+")",params:[u]});var p=d.get("fclass_id");r[p]=r[p]||{name:storage.classesMap[p].get("fcode")+"_"+d.get("fclass_id")},r[p].attrs=r[p].attrs||{},r[p].attrs[d.get("fcode")+"_"+d.get("fid")]=u}}i=c.concat(l);var m=function(e){async.mapSeries(i,function(e,s){storage.query({session:t,sql:e.sql,params:e.params,success:function(){s()},failure:s})},e)},h=[];for(var p in r)h.push(r[p]);var v=function(e){async.mapSeries(h,function(e,s){storage.query({session:t,sql:"select fobject_id from "+e.name+" where fobject_id="+n,success:function(r){if(0==r.result.rows.length){var o=["fobject_id"],i=[n],a="$1";for(var c in e.attrs)o.push(c),i.push(e.attrs[c]),a+=", $"+i.length;storage.query({session:t,sql:"insert into "+e.name+" ("+o.join(",")+") values ("+a+")",params:i,success:function(){s()},failure:function(){s()}})}else{var o=[],i=[];for(var c in e.attrs){var l=e.attrs[c];""===l&&(l=null),i.push(l),o.push(c+"=$"+i.length)}storage.query({session:t,sql:"update "+e.name+" set "+o.join(",")+"\nwhere fobject_id="+n,params:i,success:function(){s()},failure:function(){s()}})}},failure:s})},function(t,s){e(t)})};async.series([m,v],function(t,s){e(t)})}],function(e,t){e?r?r(new VError(e,"Object.commit")):(log.error({cls:"Object",fn:"commit",err:e}),s&&s()):(storage.redisClient.hdel(storage.code+"-objects",n+"-data"),s&&s())}):s&&s()}})},storage.tobject.prototype.sync=function(e){this.commit.call(this,e)},storage.tobject.prototype.remove=function(){this.removed=!0},storage.tobject.prototype.dataToJSONString=function(e){var t;for(var s in this.data)t?t+=",":t="{",t+='"'+s+'":'+common.ToJSONString(this.data[s],e);return t+="}"},storage.dataId={},storage.getId=function(e){function t(){if(storage.dataId.hasOwnProperty(n)&&storage.dataId[n].hasOwnProperty(o))log.trace({cls:"storage",fn:"getId",classCode:n,valueCode:o},storage.dataId[n][o]),s({id:storage.dataId[n][o]});else{log.trace({cls:"storage",fn:"getId",classCode:n,valueCode:o},"unknown");var e={error:"unknown value. classCode: "+n+", valueCode: "+o,module:"storage",fn:"getId"};r?r(e):s({id:null})}}log.debug({cls:"storage",fn:"getId"}),e=e||{},e.session=e.session||{};var s=(e.session,e.success),r=e.failure,n=e.classCode,o=e.valueCode||e.code;return o?void(null==storage.dataId[n]?storage.execute({sql:{select:[{a:"id"},"id",{a:"code"},"code"],from:[{a:n}]},success:function(e){storage.dataId[n]={};for(var s=0;s<e.length;s++)storage.dataId[n][e.get(s,"code")]=e.get(s,"id");t()}}):t()):void s({id:null})},storage.execute=function(e,t){var s=e,r=e.success,n=e.failure,o=e.session;e.storage=storage;var i=new Query(e);i.generate();var a=i.fields,c=i.selectSQL+i.fromSQL+i.whereSQL+i.orderSQL;"mssql"!=storage.client.database&&(c+="\nlimit "+(e.sql.limit||config.query.maxRowNum)+" offset "+(e.sql.offset||"0")+"\n"),storage.query({session:o,sql:c,success:function(e){if(s.resultText){var n="[";if(e.result)for(var o=e.result.rows,i=0;i<o.length;i++){i&&(n+=","),n+="[";for(var c=0;c<a.length;c++)c&&(n+=","),n+=common.ToJSONString(o[i][a[c]]);n+="]"}n+="]",t?t(null,n):r({result:n})}else if(s.asArray||s.sql.asArray){var l=[];_.each(s.sql.select,function(e){"string"==typeof e&&l.push(e)});var f=[];_.each(e.result.rows,function(e){var t={};_.each(a,function(s,r){t[l[r]]=e[s]}),f.push(t)}),t?t(null,f):r(f)}else e&&e.result&&e.result.rows&&(e.rows=e.result.rows,e.length=e.rows.length,e.get=function(t,s){return t>=e.length?null:e.rows[t][s+"_"]}),t?t(null,e):r(e)},failure:function(e){if(t)t(new VError(e,"Storage.execute"));else{if(!n)throw new Error("storage.execute: "+e);n(new VError(e,"Storage.execute"))}}})},storage.prepareSQLForCount=function(e,t){function s(e){var t;for(t in e)if("distinct"!=t)break;return t}function r(e,t){if(!_.isArray(e))return!1;for(var n=0;n<e.length;n++){var o=e[n];if(_.isArray(o)){var i=r(o,t);if(i)return i}if(_.isObject(o)&&s(o)==t)return!0}return!1}function n(e,t){var s=!1;return _.each(e,function(e,n){e&&"inner-join"!=e[0]&&n!=t&&r(e,t)&&(s=!0)}),s}function o(e,t){var o,i={};return _.each(e.from,function(t,r){"left-join"!=t&&"inner-join"!=t||(o=s(e.from[r+1])),o&&(i[o]=i[o]||[],i[o].push(t))}),_.each(i,function(o,a){var c=!1;if("inner-join"!=o[0]&&(r(e.where,a)||r(e.order,a)||r(e.orderAfter,a)||n(i,a)||(c=!0),t)){for(var l=!1,f=0;f<e.select.length;f+=2)if(s(e.select[f])==a&&t[e.select[f+1]]){l=!0;break}l&&(c=!1)}c&&(i[a]=null)}),i}var i=o(e,t),a={};return _.each(e,function(t,r){if("select"==r){a.select=[];for(var n=0;n<t.length;n+=2){var o=s(t[n]);(i[o]||o==s(e.from[0]))&&(a.select.push(t[n]),a.select.push(t[n+1]))}}else"from"==r?(a.from=[t[0]],_.each(i,function(e,t){e&&_.each(e,function(e,t){a.from.push(e)})})):a[r]=t}),a},storage.getContent=function(e){function t(e){var t;for(t in e.from[0])break;var s=e.orderAfter||e.order;s=s||[];for(var r=0,n=0;n<s.length;n++)if("object"==typeof s[n])for(var o in s[n])"id"==s[n][o]&&(r=1);if(!r&&["system.class","system.class_attr","system.view","system.view_attr","system.action","system.action_attrs","system.object","system.object_attr","system.revision"].indexOf(e.from[0][t])==-1){s.length&&s.push(",");var i={};i[t]="id",s.push(i)}e.orderAfter?e.orderAfter=s:e.order=s}var s=e.viewId,r=(e.column,e.row),n=(e.columnCount,e.rowCount),o=(e.parentId,e.filter),i=e.order,a=e.total,c=e.dateAttrs||[],l=e.timeOffsetMin,f=e.success,u=e.failure,d=e.request;e.session=e.session||d.session||{};var g=e.session,p=storage.viewsMap[s],m=JSON.parse(p.get("fquery"));if(!m||"unselected"==o){var h="{\n\tview: "+s+",\n\tcolumnCount: 0,\n\theaderDepth: 0,\n\tcolumn: {\n\t},\n\ttree: {\n\t\tlength: 0\n\t}\n}";return void(f&&f({result:h}))}o&&o.length&&(m.where=m.where||[],m.where.length&&(m.where=[m.where],m.where.push("and")),m.where.push(o)),i&&i.length&&(m.orderAfter?m.orderAfter=i:m.order=i),t(m);var v,b,_,w,y=[];async.series([function(e){config.caching&&config.caching.getContent?storage.redisClient.hget(storage.code+"-content",d.storageParam,function(t,s){s?e(s):e()}):e()},function(e){v=new Query({storage:storage,session:g,sql:m}),v.generate(),w=v.selectSQL+v.fromSQL+v.whereSQL+v.orderSQL;for(var t in v.attrs){var s=function(e){y.push(e);for(var t=storage.classesMap[e].childs,r=0;r<t.length;r++)s(t[r])},r=v.attrs[t].cls;["system.class","system.class_attr","system.view","system.view_attr"].indexOf(r)>-1||s(storage.classesCode[r].get("fid"))}e()},function(e){var t=w+"\nlimit "+n+" offset "+r+"\n";"mssql"==storage.client.database&&(t="select mssql2.* from (\n\tselect mssql1.*, ROW_NUMBER () over (order by (select 0)) as 'rn' from (\n"+w+"\n\t) mssql1\n) mssql2\nwhere rn > "+r+" and rn <= "+(Number(r)+Number(n))),storage.query({client:db.create(storage),sql:t,success:function(t){b=t.result.rows,e()},failure:e})},function(e){var t=w;if(config.query.optimizeCountQuery){var s=storage.prepareSQLForCount(m,a),r=new Query({storage:storage,session:g,sql:s});r.generate(),t=r.selectSQL+r.fromSQL+r.whereSQL+r.orderSQL}var n="select\n\tcount (*) as rows_num";for(var o in a){for(var i=0,c=1;c<m.select.length;c+=2)if(m.select[c]==o){i=1;break}if(i){var l=o.toLowerCase()+"_";"cnt"==a[o]&&(a[o]="count"),n+=", "+a[o]+"("+l+") as "+l}}n+="\nfrom ("+t,"postgres"==storage.client.database&&(n+="\nlimit "+(config.query.maxCount||1e3)+" offset 0\n"),n+=") v\n",storage.query({client:db.create(storage),sql:n,success:function(t){_=t.result.rows[0],e()},failure:e})}],function(e,t){if(e)return u(new VError(e,"Storage.getContent"));var n=p.attrs,o=0,i=[];for(var a in n)n[a].set("field",n[a].get("fcode").toLowerCase()+"_"),i.push(n[a]),o++;i.sort(function(e,t){var s=e.get("forder"),r=t.get("forder");return null==r||s<r?-1:null==s||s>r?1:s==r?0:void 0});for(var m="{header: {error: ''}, data: {view: "+s+", columnCount: "+o+", headerDepth: 1, column: {\n",h=0;h<i.length;h++){var w=i[h];h&&(m+="\t,\n");var j=w.get("fcode").toLowerCase()+"_";m+="\t"+h+": {\n\t\twidth: "+w.get("fcolumn_width")+",\n\t\tarea: "+w.get("farea")+",\n\t\t0: {\n\t\t\tattrId: "+w.get("fid")+',\n\t\t\tattr: "'+w.get("fcode")+'",\n\t\t\ttext: "'+w.get("fname").split('"').join('\\"')+'",\n\t\t\tidAttr: "id",\n\t\t\ttypeId: '+v.fieldTypeId[j]+",\n\t\t\ttotal: "+(_[j]?_[j]:"null")+",\n\t\t\tspan: 1\n\t\t}\n\t}\n"}m+="}, tree: {overflow: "+(_.rows_num==(config.query.maxCount||1e3)?1:0)+", length: "+_.rows_num+", currentLength: "+b.length,m+=b.length?",\n":"\n";for(var h=0;h<b.length;h++){h&&(m+=",\n"),m+=h+Number(r)+": {\n\tid: "+h+",\n\tlength: 0,\n\tdata: {\n";for(var x=0;x<i.length;x++){x&&(m+="\t\t,\n");var q=b[h][i[x].get("field")];if(c.indexOf(i[x].get("fcode"))>-1&&q&&"object"==typeof q&&q.getMonth)if(l&&(q.getUTCHours()||q.getUTCMinutes()||q.getUTCSeconds())){var C=60*l*1e3;q=new Date(q.getTime()-C),q="new Date ("+q.getUTCFullYear()+","+q.getUTCMonth()+","+q.getUTCDate()+")"}else q="new Date ("+q.getFullYear()+","+q.getMonth()+","+q.getDate()+")";else q=common.ToJSONString(q);m+="\t\t"+x+": {text: "+q+"}\n"}m+="\t}\n}\n"}if(m+="}}}",config.caching&&config.caching.getContent&&y.length&&!storage.revision[g.id]){storage.redisClient.hsetnx(storage.code+"-content",d.storageParam,m);for(var h=0;h<y.length;h++)storage.redisClient.hsetnx(storage.code+"-"+y[h]+"-clschange",d.storageParam,"1")}f({result:m})})},storage.selectRow=function(e){var t=e.viewId,s=e.viewFilter,r=e.selectFilter,n=e.success,o=e.failure,i=(e.request,e.session||{userId:null}),a=storage.viewsMap[t],c=JSON.parse(a.get("fquery"));if(s&&s.length&&(c.where=c.where||[],c.where.length&&c.where.push("and"),c.where.push(s)),"mssql"!=storage.client.database){var l=["row_number ()","over"];c.order?l.push(["order by"].concat(c.order)):l.push([]),c.select.push(l),c.select.push("rn")}var f,u,d,g=[];async.series([function(e){f=new Query({storage:storage,session:i,sql:c}),f.generate(),d=f.selectSQL+f.fromSQL+f.whereSQL+f.orderSQL;for(var t in f.attrs)g.push(storage.classesCode[f.attrs[t].cls].get("fid"));e()},function(e){r[0]=r[0].substr(1)+"_",d="mssql"==storage.client.database?"select\n\t(mssql2.rn - 1) as rn_ from (\n\t\tselect ROW_NUMBER () over (order by (select 0)) as 'rn', vr_.* from (\n\t\t\t"+d+") vr_ \t) mssql2\nwhere\n"+r.join(" "):"select rn_ from ("+d+") v where "+r.join(" "),storage.query({sql:d,success:function(t){u=t.result?t.result.rows:[],e()},failure:e})}],function(e,t){if(e)return o(new VError(e,"Storage.selectRow"));var s="0";
u.length&&(s=u[0].rn_-1),n({result:s})})},storage.clsChange=function(e){var t=e.classId;log.debug({cls:"storage",fn:"clsChange",params:t});e.session;storage.redisClient.hkeys(storage.code+"-"+t+"-clschange",function(e,s){for(var r=0;r<s.length;r++)storage.redisClient.hdel(storage.code+"-content",s[r]);storage.redisClient.del(storage.code+"-"+t+"-clschange")})},storage.setVar=function(e){var t=e.success;storage.redisClient.hset(storage.code+"-vars",e.field,e.value,function(e,s){t&&t()})},storage.getVar=function(e){var t=e.success;storage.redisClient.hget(storage.code+"-vars",e.field,function(e,s){t&&t({value:s})})},storage.removeVar=function(e){var t=e.success;storage.redisClient.hdel(storage.code+"-vars",e.field,function(e,s){t&&t()})},storage.authRecords={},storage.subjectRoles={},storage.authInfoUpdater=function(e){var t;async.series([function(e){storage.execute({sql:{select:[{a:"id"},"id",{a:"login"},"login",{a:"password"},"password",{a:"use"},"use"],from:[{a:"system.admin.Authentication.LoginPassword"}]},success:function(s){t=s.result.rows,e()},failure:function(t){e(t)}})},function(e){var t=storage.getClass("ose.role");t.attrs.menu?storage.execute({sql:{select:[{a:"subject"},"subject",{a:"role"},"role",{b:"menu"},"menu"],from:[{a:"ose.srole"},"left-join",{b:"ose.role"},"on",[{a:"role"},"=",{b:"id"}]]},success:function(t){for(var s=t.result.rows,r=0;r<s.length;r++)storage.subjectRoles[s[r].subject_]={role:s[r].role_,menu:s[r].menu_};e()},failure:function(t){e(t)}}):e()},function(e){var s={};async.map(t,function(e,t){if(!e.use_)return void t();var r=e.login_,n=e.password_;if(!s[r]==n)return void t();s[r]=n;var o=storage.classAttrsMap[r],i=storage.classAttrsMap[n],a=storage.classesMap[o.get("fclass_id")],c=a.toc;storage.query({sql:"select fobject_id, "+o.toc+", "+i.toc+"\nfrom "+c+"\nwhere "+o.toc+" is not null and "+i.toc+" is not null\n",success:function(e){for(var s=e.result.rows,r=0;r<s.length;r++)storage.authRecords[s[r][o.toc]]={password:s[r][i.toc],objectId:s[r].fobject_id,hasTryAttrs:!!a.attrs.lastTry};t()},failure:function(e){t(e)}})},function(t,s){e(t)})}],function(t,s){e&&e.success&&e.success()})},storage.subscribers={beforecreateobject:[],aftercreateobject:[],beforegetobject:[],aftergetobject:[],beforecommitobject:[],beforeremoveobject:[],generatequeryblock:[]},storage.suspendedEvents={},storage.on=function(e,t){storage.subscribers[e]=storage.subscribers[e]||[],storage.subscribers[e].push(t)},storage.un=function(e,t){storage.subscribers[e]&&storage.subscribers[e].indexOf(t)>-1&&storage.subscribers[e].splice(storage.subscribers[e].indexOf(t),1)},storage.suspendEvent=function(e){if(e)storage.suspendedEvents[e]=1;else for(e in storage.subscribers)storage.suspendedEvents[e]=1},storage.resumeEvent=function(e){if(e)storage.suspendedEvents[e]=0;else for(e in storage.subscribers)storage.suspendedEvents[e]=0},storage.fireEvent=function(e,t){t=t||{};var s=t.success;if(storage.suspendedEvents[e])return void(s&&s());var r=storage.subscribers[e]||[];delete t.success;var n=0;if(!s){for(var o=0;o<r.length;o++)r[o](t);return t}async.eachSeries(r,function(e,s){t.success=function(e){e&&e.cancel&&(n=1),s()},e(t)},function(e){s&&s({cancel:n})})},storage.freeResources=function(){clearInterval(storage.keepConnectionAliveIntervalId),clearInterval(storage.authInfoUpdaterIntervalId),storage.client.disconnect(),storage.redisClient.quit(),storage.redisSub.quit(),storage.redisPub.quit(),storage.ose&&storage.ose.freeResources()},storage.code=options.code,storage.redisClient=redis.createClient(config.redis.port,config.redis.host),storage.redisPub=redis.createClient(config.redis.port,config.redis.host),storage.redisSub=redis.createClient(config.redis.port,config.redis.host),storage.connection=options.connection,storage.revisions={},async.series([function(e){config.redis.db?storage.redisSub.select(config.redis.db,function(t,s){storage.redisPub.select(config.redis.db,function(t,s){storage.redisClient.select(config.redis.db,function(t,s){e()})})}):e()}],function(e){storage.redisSub.on("message",function(e,t){if(log.debug({cls:"storage"},"redisSub.message on channel: "+e),e==config.redis.db+"-"+storage.code+"-revisions"){var s=JSON.parse(t);storage.revisions[s.id]||(storage.revisions[s.id]=s,log.debug({cls:"storage"},"new revision: "+s.id));for(var r=0;r<s.classes.created.length;r++)storage.updateClassCache(s.classes.created[r]);for(var r=0;r<s.classes.changed.length;r++)storage.updateClassCache(s.classes.changed[r]);for(var r=0;r<s.classAttrs.created.length;r++)storage.updateClassAttrCache(s.classAttrs.created[r]);for(var r=0;r<s.classAttrs.changed.length;r++)storage.updateClassAttrCache(s.classAttrs.changed[r]);for(var r=0;r<s.views.created.length;r++)storage.updateViewCache(s.views.created[r]);for(var r=0;r<s.views.changed.length;r++)storage.updateViewCache(s.views.changed[r]);for(var r=0;r<s.viewAttrs.created.length;r++)storage.updateViewAttrCache(s.viewAttrs.created[r]);for(var r=0;r<s.viewAttrs.changed.length;r++)storage.updateViewAttrCache(s.viewAttrs.changed[r])}}),storage.redisSub.subscribe(config.redis.db+"-"+storage.code+"-revisions");var t=options,s=db.create(storage);s.connect({systemDB:options.systemDB,success:function(){if(s.inStorage=1,storage.client=s,options.systemDB){var e=options.success;return void(e&&e())}async.series([function(e){config.port==config.startPort||process.env.mainWorker?s.update({success:function(){e()}}):e()},function(e){storage.initClasses({success:function(){e()}})},function(e){storage.initClassAttrs({success:function(){e()}})},function(e){storage.initViews({success:function(){e()}})},function(e){storage.initViewAttrs({success:function(){e()}})},function(e){options.authInfoUpdater&&!storage.authInfoUpdaterIntervalId?storage.authInfoUpdater({success:function(){storage.authInfoUpdaterIntervalId=setInterval(storage.authInfoUpdater,6e4),e()}}):e()},function(e){storage.ose=new Ose({storage:storage,success:function(){e()}})}],function(e,t){var s=options.success;storage.query({sql:"select max (fid) as maxId from trevision",success:function(e){storage.lastRevision=e.result.rows[0].maxid,s&&s()}})})},failure:function(e){log.error({cls:"storage",fn:"init",error:util.inspect(e.error)}),t.failure&&t.failure(e)}})})},db={};db.create=function(e){if("postgres"==e.connection.database){var t=new db.Postgres(e);return t}if("mssql"==e.connection.database){var t=new db.MSSQL(e);return t}throw"Client ({database: '"+e.connection.database+"'}) unsupported database."},db.execute=function(e){var t,s=e;async.series([function(e){projects.loadConfig({code:s.code,success:function(){e()},failure:function(t){e(t)}})},function(e){var r=config.storages[s.code];return"rebuild"==s.fn?void(t=new Storage({code:s.code,connection:r,success:function(){console.log("Rebuilding storage ...");var s=new Import;s.removeTOC({storage:t,success:function(){s.createTOC({storage:t,success:function(){console.log("Storage rebuilded."),e()}})}})}})):void(t=new Storage({systemDB:!0,code:s.code,connection:r,success:function(){"create"==s.fn&&(console.log("Creating storage ..."),t.client.create({cfg:s,connection:r,success:function(){console.log("Storage created."),e()}})),"remove"==s.fn&&(console.log("Removing storage ..."),t.client.remove({cfg:s,connection:r,success:function(){console.log("Storage removed."),e()}})),"clear"==s.fn&&(console.log("Clearing storage ..."),db.clear({storage:t,success:function(){console.log("Storage cleared."),e()}}))},failure:function(t){e(t.error)}}))}],function(e){e?common.log({file:config.rootDir+"/error.log",text:e}):(t.freeResources(),s.success&&s.success())})},db.clear=function(e){var t=e.storage,s=e.success,r=[];async.series([function(e){t.client.disconnect(),t.client.connect({success:function(){e()},failure:function(){e()}})},function(e){t.query({sql:"select fid, fcode from tclass\nwhere "+t.getCurrentFilter()+"\norder by fid\n",success:function(t){for(var s=t.result.rows,n=0;n<s.length;n++){var o=s[n].fcode+"_"+s[n].fid;r.push(o)}r.push("taction"),r.push("taction_attr"),r.push("tclass"),r.push("tclass_attr"),r.push("tobject"),r.push("tobject_attr"),r.push("tview"),r.push("tview_attr"),r.push("trevision"),r.push("tright"),r.push("tsession"),r.push("tschema"),r.push("tmail"),e()},failure:function(t){e(t.error)}})},function(e){async.map(r,function(e,s){t.client.isTableExists({table:e,success:function(r){r?t.query({sql:"drop table "+e+" cascade",success:function(e){s()}}):s()}})},function(t,s){e()})}],function(e,t){e&&common.log({file:config.rootDir+"/error.log",text:"error: "+e}),s()})},db.init=function(e){var t=config.storages[e.code],s=t.rootDir;async.series([function(e){fs.mkdir(s,e)},function(e){fs.mkdir(s+"/files",e)},function(e){fs.mkdir(s+"/plugins",e)},function(e){fs.mkdir(s+"/resources",e)},function(e){fs.mkdir(s+"/resources/css",e)},function(e){fs.mkdir(s+"/resources/images",e)},function(e){fs.mkdir(s+"/resources/scripts",e)},function(e){fs.mkdir(s+"/schema",e)},function(e){fs.readFile(config.rootDir+"/server/project-app/schema/schema-app.js",function(t,r){return t?e(t):void fs.writeFile(s+"/schema/schema-app.js",r,e)})},function(e){var r="<html>\n<head>\n\t<title>"+t.code+'</title>\n\t<!-- ExtJS -->\n\t<link rel="stylesheet" type="text/css" href="/third-party/extjs4/resources/css/ext-all-objectum.css">\n\t<script type="text/javascript" src="/third-party/extjs4/ext-all-debug.js"></script>\n\t<script type="text/javascript" src="/third-party/extjs4/locale/ext-lang-ru.js" charset="UTF-8"></script>\n\t<!-- Objectum Client -->\n\t<link rel="stylesheet" type="text/css" href="/client/extjs4/css/images.css">\n\t<script type="text/javascript" src="/client/extjs4/all-debug.js" charset="UTF-8"></script>\n\t<!-- Current configuration -->\n\t<script type="text/javascript" src="resources/scripts/all-debug.js" charset="UTF-8"></script>\n</head>\n<body>\n\t<div id="loading"></div>\n\t<script type="text/javascript" charset="UTF-8">\n\t\t$o.app.start ({"code": "'+t.code+'", "name": "'+t.code+'", "version": "1.0", "locale": "en", "useHash":true});\n\t</script>\n</body>\n</html>\n';fs.writeFile(s+"/index.html",r,e)},function(e){},function(e){},function(e){}],function(e){})};var pgTypes=pg.types;pgTypes&&(pgTypes.setTypeParser(1700,function(e){return null===e?null:parseFloat(e)}),pgTypes.setTypeParser(700,function(e){return null===e?null:parseFloat(e)}),pgTypes.setTypeParser(701,function(e){return null===e?null:parseFloat(e)}),pgTypes.setTypeParser(20,function(e){return null===e?null:parseInt(e)}),pgTypes.setTypeParser(21,function(e){return null===e?null:parseInt(e)}),pgTypes.setTypeParser(23,function(e){return null===e?null:parseInt(e)})),db.Postgres=function(e){var t=this;t.storage=e,t.database="postgres",t.host=e.connection.host,t.port=e.connection.port,t.db=e.connection.db,t.dbUser=e.connection.dbUser,t.dbPassword=e.connection.dbPassword,t.dbaUser=e.connection.dbaUser,t.dbaPassword=e.connection.dbaPassword,t.connection="tcp://"+t.dbUser+":"+t.dbPassword+"@"+t.host+":"+t.port+"/"+t.db,t.adminConnection="tcp://"+t.dbaUser+":"+t.dbaPassword+"@"+t.host+":"+t.port+"/postgres",t.tags={schema:t.dbUser,schema_prefix:t.dbUser+".",tablespace:"tablespace "+t.dbUser,tid:"bigserial",tid_object_attr:"bigserial",tnumber:"bigint",tnumber_value:"numeric",ttext:"text",ttimestamp:"timestamp (6)",tstring:"varchar (1024)",tstring_value:"text",tocObjectId:"fobject_id bigint not null, primary key (fobject_id)",tobject_attr_fstring:"substr (fstring, 1, 1024)"}},db.Postgres.prototype.connect=function(e){e=e||{};var t=this,s=e.success,r=new pg.Client(e.systemDB?t.adminConnection:t.connection);r.connect(function(n){n?(log.error({cls:"Postgres",fn:"connect",err:n}),e.failure&&e.failure(new VError(n,"Postgres.connect"))):(t.client=r,t.connected=!0,t.lastActivity=(new Date).getTime(),r.pauseDrain&&r.pauseDrain(),t.query({sql:"select version ()",success:function(e){var r=e.result.rows[0].version;r=r.split(" ")[1],r=r.split("."),r=Number(10*r[0])+Number(r[1]),t.version=r,t.query({sql:"select pg_backend_pid() as pid",success:function(e){t.pid=e.result.rows[0].pid,db.Postgres.prototype.clients=db.Postgres.prototype.clients||{},db.Postgres.prototype.clients[t.pid]=t,s&&s()}})}}))}),r.on("error",function(e){log.error({cls:"Postgres",fn:"connect",err:e,client_error:!0})})},db.Postgres.prototype.disconnect=function(e){var t=this;t.client&&t.client.end&&(t.client.end(),t.connected=0)},db.Postgres.prototype.query=function(e){function t(){s.lastActivity=(new Date).getTime(),log.debug({cls:"Postgres",fn:"query",sql:e.sql,params:e.params}),s.client.query(e.sql,e.params,function(t,s){t?(log.error({cls:"Postgres",fn:"query",err:t,sql:e.sql,params:e.params}),e.failure&&e.failure(new VError(t,"Postgres.query"))):e.success&&e.success({result:s})})}var s=this;s.connected?t():s.connect({success:function(){t()},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.query"))}})},db.Postgres.prototype.startTransaction=function(e){this.query({sql:"begin",success:function(){e.success()},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.startTransaction"))}})},db.Postgres.prototype.commitTransaction=function(e){this.query({sql:"commit",success:function(){e.success()},failure:function(t){log.error({cls:"Postgres",fn:"commitTransaction",err:t}),e.failure&&e.failure(new VError(t,"Postgres.commitTransaction"))}})},db.Postgres.prototype.rollbackTransaction=function(e){this.query({sql:"rollback",success:function(){e.success()},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.rollbackTransaction"))}})},db.Postgres.prototype.getNextId=function(e){var t=this,s=e.success;t.query({sql:"select nextval ('"+e.table+"_fid_seq') as id",success:function(e){var t=e.result.rows[0].id;s({id:t})},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.getNextId"))}})},db.Postgres.prototype.currentTimestamp=function(){return"current_timestamp at time zone 'UTC'"},db.Postgres.prototype.update=function(e){var t=this,s=t.storage;async.series([function(e){s.query({sql:"select fremove_rule from tclass_attr",success:function(t){e()},failure:function(){s.query({sql:"alter table tclass_attr add column fremove_rule varchar (128)",success:function(t){e()},failure:e})}})},function(e){s.query({sql:"select ftoc from trevision",success:function(t){e()},failure:function(){s.query({sql:"alter table trevision add column ftoc bigint",success:function(r){s.query({sql:"create index trevision_ftoc on trevision (ftoc) tablespace "+t.storage.code,success:function(t){e()},failure:e})}})}})},function(e){s.query({sql:"select count (*) as num from pg_catalog.pg_class as c\nleft join pg_catalog.pg_namespace as n on (n.oid = c.relnamespace)\nwhere c.relkind = 'i' and c.relname = 'tobject_attr_ufid' and n.nspname = '"+s.code+"'",success:function(t){t.result.rows[0].num?s.query({sql:"drop index tobject_attr_ufid",success:function(t){e()},failure:function(){e()}}):e()},failure:function(){e()}})},function(e){t.isIndexExists({index:"tobject_fstring",success:function(t){t?s.query({sql:"drop index tobject_fstring",success:function(){s.query({sql:"create index tobject_attr_fstring on tobject_attr (substr (fstring, 1, 1024))",success:function(){e()},failure:function(){e()}})},failure:function(){e()}}):e()}})},function(e){s.query({sql:"select data_type from information_schema.columns where table_catalog='"+s.code+"' and table_name='tview_attr' and column_name='forder'",success:function(t){var r=t.result.rows;r.length&&"numeric"!=r[0].data_type?s.query({sql:"alter table tview_attr alter column forder type numeric",success:function(){e()},failure:function(){e()}}):e()}})},function(e){t.updateSequences({success:function(){e()},failure:e})}],function(t,s){t?e.failure&&e.failure(new VError(t,"Postgres.update")):e.success&&e.success()})},db.Postgres.prototype.updateSequences=function(e){var t=this,s=t.storage,r=["tclass","tclass_attr","tobject","tobject_attr","tview","tview_attr","taction","trevision"];async.map(r,function(e,t){s.query({sql:"select max (fid) as max_id from "+e,success:function(r){var n,o=r.result.rows;o.length&&(n=o[0].max_id+1),(!n||n<1e3)&&(n=1e3),s.query({sql:"alter sequence "+e+"_fid_seq restart with "+n,success:function(e){t()},failure:t})},failure:t})},function(t,s){t?e.failure&&e.failure(new VError(t,"Postgres.updateSequences")):e.success&&e.success()})},db.Postgres.prototype.create=function(e){var t=this,s=t.storage,r=e.connection,n=e.cfg,o=e.success;async.series([function(e){s.query({client:t,sql:"create role "+r.dbUser+" noinherit login password '"+r.dbPassword+"'",success:function(t){e()},failure:function(t){e()}})},function(e){s.query({client:t,sql:"create tablespace "+r.dbUser+" owner "+r.dbUser+" location '"+n.path+"'",success:function(t){e()},failure:function(t){e()}})},function(e){s.query({client:t,sql:"create database "+r.db+" owner "+r.dbUser+" encoding 'utf8' tablespace "+r.dbUser,success:function(t){e()},failure:function(t){e()}})},function(e){t.disconnect(),t.connect({client:t,success:function(){e()},failure:function(t){e()}})},function(e){s.query({client:t,sql:"create schema "+r.dbUser+" authorization "+r.dbUser,success:function(t){e()},failure:function(t){e()}})},function(e){var r=dbTablesSQL;s.query({client:t,sql:r,success:function(t){e()},failure:function(t){e()}})},function(e){var r=dbIndexesSQL;s.query({client:t,sql:r,success:function(t){e()},failure:function(t){e()}})},function(e){var r=dbDataSQL;s.query({client:t,sql:r,success:function(t){e()},failure:function(t){e()}})},function(e){t.update({success:function(){e()}})}],function(e,t){o()})},db.Postgres.prototype.remove=function(e){var t=this,s=t.storage,r=e.connection,n=(e.cfg,e.success);async.series([function(e){t.disconnect(),t.connect({success:function(){e()},failure:function(t){e()}})},function(e){s.query({client:t,sql:"drop schema "+r.dbUser+" cascade",success:function(t){e()},failure:function(t){e()}})},function(e){t.disconnect(),t.connect({systemDB:!0,success:function(){e()},failure:function(t){e()}})},function(e){s.query({client:t,sql:"drop database "+r.db,success:function(t){e()},failure:function(t){e()}})},function(e){s.query({client:t,sql:"drop tablespace "+r.dbUser,success:function(t){e()},failure:function(t){e()}})},function(e){s.query({client:t,sql:"drop role "+r.dbUser,success:function(t){e()},failure:function(t){e()}})}],function(e,t){n()})},db.Postgres.prototype.createField=function(e){var t=this.storage,s=e.toc,r=e.tocField,n=e.type,o=e.caId,i=e.success;async.series([function(o){t.query({session:e.session,sql:"alter table "+s+" add column "+r+" "+n,success:function(){o()},failure:function(e){o()}})},function(e){t.query({sql:"create index "+s+"_"+o+" on "+s+" ("+r+")",success:function(){e()},failure:function(t){e()}})}],function(e){i()})},db.Postgres.prototype.createIndex=function(e){var t=this.storage,s=e.success;t.query({session:e.session,sql:"create index "+e.table+"_"+e.field+" on "+e.table+" ("+e.field+")",success:function(){s()},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.createIndex"))}})},db.Postgres.prototype.isTableExists=function(e){var t=e.success;this.storage.query({session:e.session,sql:"select count (*) as num from pg_tables where upper (schemaname) = upper ('$schema$') and upper (tablename) = upper ('"+e.table+"')",success:function(e){var s=e.result.rows;t(s[0].num)},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.isTableExists"))}})},db.Postgres.prototype.isFieldExists=function(e){var t=e.success;this.storage.query({session:e.session,sql:"select count (*) as num from information_schema.columns where lower (table_name) = lower ('"+e.table+"') and lower (column_name) = lower ('"+e.field+"')",success:function(e){var s=e.result.rows;t(s[0].num)},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.isFieldExists"))}})},db.Postgres.prototype.isIndexExists=function(e){var t=e.success;this.storage.query({session:e.session,sql:"select count (*) as num from pg_catalog.pg_class as c\nleft join pg_catalog.pg_namespace as n on (n.oid = c.relnamespace)\nwhere c.relkind = 'i' and lower (c.relname) = lower ('"+e.index+"') and n.nspname = '"+this.storage.code+"'",success:function(e){var s=e.result.rows;t(s[0].num)},failure:function(t){e.failure&&e.failure(new VError(t,"Postgres.isIndexExists"))}})},db.MSSQL=function(e){var t=this;t.storage=e,t.database="mssql",t.host=e.connection.host,t.port=e.connection.port,t.db=e.connection.db,t.dbUser=e.connection.dbUser,t.dbPassword=e.connection.dbPassword,t.dbaUser=e.connection.dbaUser,t.dbaPassword=e.connection.dbaPassword,t.connection="Driver={SQL Server};Server="+t.host+";Uid="+t.dbUser+";Pwd="+t.dbPassword+";Database="+t.db+";",t.adminConnection="Driver={SQL Server};Server="+t.host+";Uid="+t.dbaUser+";Pwd="+t.dbaPassword+";Database=master;",t.tags={schema:"",schema_prefix:"",tablespace:"",tid:"bigint",tid_object_attr:"bigint identity (1000, 1)",tnumber:"bigint",tnumber_value:"numeric",ttext:"nvarchar (max)",ttimestamp:"datetime",tstring:"nvarchar (450)",tstring_value:"nvarchar (max)",tocObjectId:"fobject_id bigint primary key clustered",tobject_attr_fstring:"fstring"}},db.MSSQL.prototype.connect=function(e){var t=this;sql.open(e.systemDB?t.adminConnection:t.connection,function(s,r){s?(common.log({file:config.rootDir+"/error.log",text:util.inspect(s)}),e.failure&&e.failure({error:s})):(t.client=r,t.connected=!0,r.query("set language english",function(t,s){r.query("set dateformat dmy",function(t,s){e.success&&e.success()})}))})},db.MSSQL.prototype.disconnect=function(e){this.client.close()},db.MSSQL.prototype.query=function(e){function t(e){var t,r=[];if(e.params)for(var n=0;n<e.params.length;n++){var o=e.params[n];""===o&&(o=null),null==o?e.sql=e.sql.replace("$"+(n+1),"null"):(e.sql=e.sql.replace("$"+(n+1),"?"),r.push(o))}s.n=s.n||1;var i=s.n;s.queue=s.queue||{},s.queue[i]=e.sql;var a=function(t,r){delete s.queue[i],t?e.failure&&e.failure({error:t+" "+r}):e.success&&(e.options.result={rows:r},e.success(e.options))};t=r.length?s.client.query(e.sql,r,a):s.client.query(e.sql,a)}var s=this;e.options=e.options||{};var r=e;s.connected?t(r):s.connect({success:function(){t(r)},failure:function(e){r.failure(e)}})},db.MSSQL.prototype.startTransaction=function(e){var t=e;this.query({sql:"begin transaction",success:function(){t.success()},failure:function(e){t.failure(e)}})},db.MSSQL.prototype.commitTransaction=function(e){var t=e;this.query({sql:"commit transaction",success:function(){t.success()},failure:function(e){t.failure(e)}})},db.MSSQL.prototype.rollbackTransaction=function(e){var t=e;this.query({sql:"rollback transaction",success:function(){t.success()},failure:function(e){t.failure(e)}})},db.MSSQL.prototype.getNextId=function(e){var t=this,s=e.success,r=(e.session,t.storage),n=e.table;r.redisClient.hincrby("mssql_sequences",r.code+"_"+n,1,function(e,t){s({id:t})})},db.MSSQL.prototype.currentTimestamp=function(){return"getutcdate ()"},db.MSSQL.prototype.update=function(e){var t=this,s=t.storage;async.series([function(e){s.query({sql:"drop index tobject_attr_ufid",success:function(t){e()},failure:function(){e()}})},function(e){s.query({sql:"select fremove_rule from tclass_attr",success:function(t){e()},failure:function(){s.query({sql:"alter table tclass_attr add column fremove_rule varchar (128)",success:function(t){e()}})}})},function(e){s.query({sql:"select ftoc from trevision",success:function(t){e()},failure:function(){s.query({sql:"alter table trevision add column ftoc bigint",success:function(t){s.query({sql:"create index trevision_ftoc on trevision (ftoc)",success:function(t){e()}})}})}})},function(e){t.updateSequences({success:function(){e()}})}],function(t,s){e.success&&e.success()})},db.MSSQL.prototype.updateSequences=function(e){var t=this,s=t.storage,r=["trevision","tclass","tclass_attr","tview","tview_attr","tobject","tobject_attr","taction","taction_attr"];async.map(r,function(e,t){s.query({sql:"select max (fid) as maxid from "+e,success:function(r){var n=1e3;r.result.rows[0].maxid&&(n=r.result.rows[0].maxid),n<1e3&&(n=1e3),s.redisClient.hset("mssql_sequences",s.code+"_"+e,n),common.log({file:config.rootDir+"/query.log",text:"sequence: "+s.code+"_"+e+" = "+n}),t()},failure:function(){t()}})},function(t,s){e.success()})},db.MSSQL.prototype.create=function(e){var t=this,s=t.storage,r=e.connection,n=e.cfg,o=e.success;async.series([function(e){s.query({sql:"create database "+r.dbUser+" on (\n    name="+r.dbUser+"_dat,\n    filename='"+n.path+"\\"+r.dbUser+".mdf',\n    size=10MB,\n    filegrowth=5MB\n) log on (\n    name="+r.dbUser+"_log,\n    filename='"+n.path+"\\"+r.dbUser+".ldf',\n    size=5MB,\n    filegrowth=5MB\n);\n",success:function(t){e()},failure:function(t){e()}})},function(e){s.query({sql:"create login "+r.dbUser+" with password = '"+r.dbPassword+"'",success:function(t){e()},failure:function(t){e()}})},function(e){s.query({sql:"use "+r.dbUser,success:function(t){e()},failure:function(t){e()}})},function(e){s.query({sql:"create user "+r.dbUser+" for login "+r.dbUser,success:function(t){e()},failure:function(t){e()}})},function(e){s.query({sql:"exec sp_addrolemember 'db_owner', '"+r.dbUser+"'",success:function(t){e()},failure:function(t){e()}})},function(e){s.query({sql:dbTablesSQL,success:function(t){e()},failure:function(t){e()}})},function(e){var t=dbIndexesSQL;t=t.replace("create index tobject_fstring on $schema_prefix$tobject_attr (fstring)","create index tobject_fstring on $schema_prefix$tobject_attr (fid) include (fstring)"),s.query({sql:t,success:function(t){e()},failure:function(t){e()}})},function(e){t.disconnect(),t.connect({success:function(){e()},failure:function(){e()}})},function(e){t.update({success:function(){e()},failure:function(){e()}})},function(e){var t=dbDataSQL;async.map(t,function(e,t){s.query({sql:e,success:function(e){t()},failure:function(e){t()}})},function(t,s){e()})}],function(e,t){o()})},db.MSSQL.prototype.remove=function(e){var t=this,s=t.storage,r=e.connection,n=(e.cfg,e.success);s.query({sql:"drop database "+r.dbUser,success:function(e){s.query({sql:"drop login "+r.dbUser,success:function(e){n()},failure:function(e){n()}})},failure:function(e){n()}})},db.MSSQL.prototype.createField=function(e){var t=this.storage,s=e.toc,r=e.tocField,n=e.type,o=e.caId,i=e.success;t.query({sql:"alter table "+s+" add "+r+" "+n,success:function(){"$ttext$"!=n?t.query({session:e.session,sql:"create index "+s+"_"+o+" on "+s+" ("+r+")",success:function(){i()}}):t.query({session:e.session,sql:"create index "+s+"_"+o+" on "+s+" (fobject_id) include ("+r+")",success:function(){i()}})}})},db.MSSQL.prototype.createIndex=function(e){var t=this.storage,s=e.success;t.query({session:e.session,sql:"create index "+e.table+"_"+e.field+" on "+e.table+" ("+e.field+")",success:function(){s()}})},db.MSSQL.prototype.isTableExists=function(e){var t=this.storage,s=e.success;t.query({session:e.session,sql:"select count (*) as num from INFORMATION_SCHEMA.TABLES where upper (TABLE_NAME) = upper ('"+e.table+"')",success:function(e){var t=e.result.rows;s(t[0].num)}})};var dbTablesSQL="create table $schema_prefix$tschema (\r\n\tfid $tid$ not null,\r\n\tfparent_id $tnumber$,\r\n\tfname $ttext$,\r\n\tfcode $ttext$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$trevision (\r\n\tfid $tid$ not null,\r\n\tfsubject_id $tnumber$,\r\n\tfdate $ttimestamp$,\r\n\tfdescription $ttext$,\r\n\tfremote_addr $ttext$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$,\r\n\tftoc $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$tview (\r\n\tfid $tid$ not null,\r\n\tfparent_id $tnumber$,\r\n\tfname $tstring$,\r\n\tfcode $tstring$,\r\n\tfdescription $ttext$,\r\n\tflayout $ttext$,\r\n\tfkey $tstring$,\r\n\tfparent_key $tstring$,\r\n\tfclass_id $tnumber$,\r\n\tfunrelated $tstring$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tfquery $ttext$,\r\n\tftype $tnumber$,\r\n\tfmaterialized $tnumber$ default 0,\r\n\tfsystem $tnumber$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$,\r\n\tforder $tnumber_value$,\r\n\tficon_cls $tstring$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$tview_attr (\r\n\tfid $tid$ not null,\r\n\tfview_id $tnumber$,\r\n\tfname $tstring$,\r\n\tfcode $tstring$,\r\n\tfdescription $ttext$,\r\n\tfclass_id $tnumber$,\r\n\tfclass_attr_id $tnumber$,\r\n\tfsubject_id $tnumber$,\r\n\tforder $tnumber_value$,\r\n\tfsort_kind $tnumber$,\r\n\tfsort_order $tnumber$,\r\n\tfoperation $tnumber$,\r\n\tfvalue $ttext$,\r\n\tfarea $tnumber$,\r\n\tfcolumn_width $tnumber$,\r\n\tftotal_type $tnumber$,\r\n\tfread_only $tnumber$,\r\n\tfgroup $tnumber$,\r\n\tfnot_null $tnumber$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$taction (\r\n\tfid $tid$ not null,\r\n\tfclass_id $tnumber$,\r\n\tfname $tstring$,\r\n\tfcode $tstring$,\r\n\tfdescription $ttext$,\r\n\tforder $tnumber_value$,\r\n\tfbody $ttext$,\r\n\tfconfirm $tnumber$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tflayout $ttext$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$taction_attr (\r\n\tfid $tid$ not null,\r\n\tfaction_id $tnumber$,\r\n\tftype_id $tnumber$,\r\n\tfname $tstring$,\r\n\tfcode $tstring$,\r\n\tfdescription $ttext$,\r\n\tforder $tnumber_value$,\r\n\tfnot_null $tnumber$,\r\n\tfvalid_func $ttext$,\r\n\tfkind $tnumber$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$tclass (\r\n\tfid $tid$ not null,\r\n\tfparent_id $tnumber$,\r\n\tfname $tstring$,\r\n\tfcode $tstring$,\r\n\tfdescription $ttext$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tfformat $ttext$,\r\n\tfview_id $tnumber$,\r\n\tfsystem $tnumber$,\r\n\tftype $tnumber$,\r\n\tfkind $tnumber$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$tclass_attr (\r\n\tfid $tid$ not null,\r\n\tfclass_id $tnumber$,\r\n\tfname $tstring$,\r\n\tfcode $tstring$,\r\n\tfdescription $ttext$,\r\n\tftype_id $tnumber$,\r\n\tforder $tnumber_value$,\r\n\tfnot_null $tnumber$,\r\n\tfsecure $tnumber$,\r\n\tfmax_str $tnumber$,\r\n\tfmin_str $tnumber$,\r\n\tfmax_number $tnumber$,\r\n\tfmin_number $tnumber$,\r\n\tfmax_ts $tnumber$,\r\n\tfmin_ts $tnumber$,\r\n\tfunique $tnumber$,\r\n\tfvalid_func $ttext$,\r\n\tfformat_func $ttext$,\r\n\tfformat_number $tstring$,\r\n\tfformat_ts $tstring$,\r\n\tfremove_rule $tstring$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$tobject (\r\n\tfid $tid$ not null,\r\n\tfclass_id $tnumber$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$tobject_attr (\r\n\tfid $tid_object_attr$ not null,\r\n\tfobject_id $tnumber$,\r\n\tfclass_attr_id $tnumber$,\r\n\tfstring $tstring_value$,\r\n\tfnumber $tnumber_value$,\r\n\tftime $ttimestamp$,\r\n\tfstart_id $tnumber$,\r\n\tfend_id $tnumber$,\r\n\tfschema_id $tnumber$,\r\n\tfrecord_id $tnumber$\r\n) $tablespace$;\r\n\r\ncreate table $schema_prefix$tmail (\r\n\tfid $tid$ not null,\r\n\tfrecipients $ttext$,\r\n\tfmessage $ttext$,\r\n\tfcreation_date $ttimestamp$,\r\n\tfsending_date $ttimestamp$\r\n) $tablespace$;\r\n",dbIndexesSQL="create unique index tschema_fid on $schema_prefix$tschema (fid) $tablespace$;\r\n\r\ncreate index trevision_fdate on $schema_prefix$trevision (fdate) $tablespace$;\r\ncreate unique index trevision_fid on $schema_prefix$trevision (fid) $tablespace$;\r\ncreate index trevision_fschema_id on $schema_prefix$trevision (fschema_id) $tablespace$;\r\ncreate index trevision_frecord_id on $schema_prefix$trevision (frecord_id) $tablespace$;\r\ncreate index trevision_ftoc on $schema_prefix$trevision (ftoc) $tablespace$;\r\n\r\ncreate index tview_ftype on $schema_prefix$tview (ftype) $tablespace$;\r\ncreate index tview_fid on $schema_prefix$tview (fid) $tablespace$;\r\ncreate index tview_fcode on $schema_prefix$tview (fcode);\r\ncreate index tview_fend_id on $schema_prefix$tview (fend_id) $tablespace$;\r\ncreate unique index tview_ufid on $schema_prefix$tview (fid,fstart_id,fend_id) $tablespace$;\r\ncreate index tview_fname on $schema_prefix$tview (fname);\r\ncreate index tview_fparent_id on $schema_prefix$tview (fparent_id) $tablespace$;\r\ncreate index tview_fsystem on $schema_prefix$tview (fsystem) $tablespace$;\r\ncreate index tview_fstart_id on $schema_prefix$tview (fstart_id) $tablespace$;\r\ncreate index tview_fclass_id on $schema_prefix$tview (fclass_id) $tablespace$;\r\ncreate index tview_fschema_id on $schema_prefix$tview (fschema_id) $tablespace$;\r\ncreate index tview_frecord_id on $schema_prefix$tview (frecord_id) $tablespace$;\r\n\r\ncreate index tview_attr_fid on $schema_prefix$tview_attr (fid) $tablespace$;\r\ncreate index tview_attr_fclass_id on $schema_prefix$tview_attr (fclass_id) $tablespace$;\r\ncreate index tview_attr_fclass_attr_id on $schema_prefix$tview_attr (fclass_attr_id) $tablespace$;\r\ncreate index tview_attr_fcode on $schema_prefix$tview_attr (fcode) $tablespace$;\r\ncreate unique index tview_attr_ufid on $schema_prefix$tview_attr (fid,fstart_id,fend_id) $tablespace$;\r\ncreate index tview_attr_fname on $schema_prefix$tview_attr (fname) $tablespace$;\r\ncreate index tview_attr_fview_id on $schema_prefix$tview_attr (fview_id) $tablespace$;\r\ncreate index tview_attr_fsubject_id on $schema_prefix$tview_attr (fsubject_id) $tablespace$;\r\ncreate index tview_attr_fstart_id on $schema_prefix$tview_attr (fstart_id) $tablespace$;\r\ncreate index tview_attr_fend_id on $schema_prefix$tview_attr (fend_id) $tablespace$;\r\ncreate index tview_attr_farea on $schema_prefix$tview_attr (farea) $tablespace$;\r\ncreate index tview_attr_fschema_id on $schema_prefix$tview_attr (fschema_id) $tablespace$;\r\ncreate index tview_attr_frecord_id on $schema_prefix$tview_attr (frecord_id) $tablespace$;\r\n\r\ncreate index taction_fid on $schema_prefix$taction (fid) $tablespace$;\r\ncreate index taction_fclass_id on $schema_prefix$taction (fclass_id) $tablespace$;\r\ncreate index taction_fcode on $schema_prefix$taction (fcode);\r\ncreate index taction_fend_id on $schema_prefix$taction (fend_id) $tablespace$;\r\ncreate unique index taction_ufid on $schema_prefix$taction (fid,fstart_id,fend_id) $tablespace$;\r\ncreate index taction_fname on $schema_prefix$taction (fname);\r\ncreate index taction_fstart_id on $schema_prefix$taction (fstart_id) $tablespace$;\r\ncreate index taction_fschema_id on $schema_prefix$taction (fschema_id) $tablespace$;\r\ncreate index taction_frecord_id on $schema_prefix$taction (frecord_id) $tablespace$;\r\n\r\ncreate index taction_attr_fid on $schema_prefix$taction_attr (fid) $tablespace$;\r\ncreate index taction_attr_faction_id on $schema_prefix$taction_attr (faction_id) $tablespace$;\r\ncreate index taction_attr_fcode on $schema_prefix$taction_attr (fcode);\r\ncreate index taction_attr_fend_id on $schema_prefix$taction_attr (fend_id) $tablespace$;\r\ncreate unique index taction_attr_ufid on $schema_prefix$taction_attr (fid,fstart_id,fend_id) $tablespace$;\r\ncreate index taction_attr_fname on $schema_prefix$taction_attr (fname);\r\ncreate index taction_attr_fstart_id on $schema_prefix$taction_attr (fstart_id) $tablespace$;\r\ncreate index taction_attr_fschema_id on $schema_prefix$taction_attr (fschema_id) $tablespace$;\r\ncreate index taction_attr_frecord_id on $schema_prefix$taction_attr (frecord_id) $tablespace$;\r\n\r\ncreate index tclass_fid on $schema_prefix$tclass (fid) $tablespace$;\r\ncreate index tclass_fcode on $schema_prefix$tclass (fcode);\r\ncreate index tclass_fend_id on $schema_prefix$tclass (fend_id) $tablespace$;\r\ncreate index tclass_fname on $schema_prefix$tclass (fname);\r\ncreate index tclass_fparent_id on $schema_prefix$tclass (fparent_id) $tablespace$;\r\ncreate index tclass_fsystem on $schema_prefix$tclass (fsystem) $tablespace$;\r\ncreate index tclass_ftype on $schema_prefix$tclass (ftype) $tablespace$;\r\ncreate index tclass_fkind on $schema_prefix$tclass (fkind) $tablespace$;\r\ncreate index tclass_fstart_id on $schema_prefix$tclass (fstart_id) $tablespace$;\r\ncreate index tclass_fview_id on $schema_prefix$tclass (fview_id) $tablespace$;\r\ncreate index tclass_fschema_id on $schema_prefix$tclass (fschema_id) $tablespace$;\r\ncreate index tclass_frecord_id on $schema_prefix$tclass (frecord_id) $tablespace$;\r\n\r\ncreate index tclass_attr_fid on $schema_prefix$tclass_attr (fid) $tablespace$;\r\ncreate index tclass_attr_fclass_id on $schema_prefix$tclass_attr (fclass_id) $tablespace$;\r\ncreate index tclass_attr_fcode on $schema_prefix$tclass_attr (fcode);\r\ncreate index tclass_attr_fend_id on $schema_prefix$tclass_attr (fend_id) $tablespace$;\r\ncreate index tclass_attr_fname on $schema_prefix$tclass_attr (fname);\r\ncreate index tclass_attr_fstart_id on $schema_prefix$tclass_attr (fstart_id) $tablespace$;\r\ncreate index tclass_attr_ftype_id on $schema_prefix$tclass_attr (ftype_id) $tablespace$;\r\ncreate index tclass_attr_fschema_id on $schema_prefix$tclass_attr (fschema_id) $tablespace$;\r\ncreate index tclass_attr_frecord_id on $schema_prefix$tclass_attr (frecord_id) $tablespace$;\r\n\r\ncreate index tobject_fid on $schema_prefix$tobject (fid) $tablespace$;\r\ncreate index tobject_fclass_id on $schema_prefix$tobject (fclass_id) $tablespace$;\r\ncreate index tobject_fend_id on $schema_prefix$tobject (fend_id) $tablespace$;\r\ncreate unique index tobject_ufid on $schema_prefix$tobject (fid,fstart_id,fend_id) $tablespace$;\r\ncreate index tobject_fstart_id on $schema_prefix$tobject (fstart_id) $tablespace$;\r\ncreate index tobject_fschema_id on $schema_prefix$tobject (fschema_id) $tablespace$;\r\ncreate index tobject_frecord_id on $schema_prefix$tobject (frecord_id) $tablespace$;\r\n\r\ncreate index tobject_attr_fid on $schema_prefix$tobject_attr (fid) $tablespace$;\r\ncreate index tobject_attr_fclass_attr_id on $schema_prefix$tobject_attr (fclass_attr_id) $tablespace$;\r\ncreate index tobject_attr_fend_id on $schema_prefix$tobject_attr (fend_id) $tablespace$;\r\ncreate index tobject_attr_fnumber on $schema_prefix$tobject_attr (fnumber) $tablespace$;\r\ncreate index tobject_attr_fobject_id on $schema_prefix$tobject_attr (fobject_id) $tablespace$;\r\ncreate index tobject_attr_ftime on $schema_prefix$tobject_attr (ftime) $tablespace$;\r\ncreate index tobject_attr_fstart_id on $schema_prefix$tobject_attr (fstart_id) $tablespace$;\r\ncreate index tobject_attr_fstring on $schema_prefix$tobject_attr ($tobject_attr_fstring$);\r\ncreate index tobject_attr_fschema_id on $schema_prefix$tobject_attr (fschema_id) $tablespace$;\r\ncreate index tobject_attr_frecord_id on $schema_prefix$tobject_attr (frecord_id) $tablespace$;\r\n\r\ncreate unique index tmail_fid on $schema_prefix$tmail (fid) $tablespace$;\r\n",dbDataSQL="insert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (1, null, 'Строка', 'String', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (2, null, 'Число', 'Number', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (3, null, 'Дата', 'Date', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (4, null, 'Логический', 'Boolean', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (5, null, 'Файл', 'File', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (6, null, 'Класс', 'Class', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (7, null, 'Атрибут класса', 'ClassAttr', '', 1, 2147483647, '', 1867, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (8, null, 'Представление', 'View', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (9, null, 'Атрибут представления', 'ViewAttr', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (10, null, 'Действие', 'Action', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (11, null, 'Атрибут действия', 'ActionAttr', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (12, null, 'Объект', 'Object', '', 1, 2147483647, '', null, 1, 0, null);\r\ninsert into $schema_prefix$tclass (fid, fparent_id, fname, fcode, fdescription, fstart_id, fend_id, fformat, fview_id, fsystem, ftype, fkind)\r\nvalues (13, null, 'Атрибут объекта', 'ObjectAttr', '', 1, 2147483647, '', null, 1, 0, null);\r\n",Dbf=function(e){
var t=this;t.options={},t.fields=e.fields,t.rows=e.rows,t.options=e.options};Dbf.prototype.convertDate=function(e){var t,s;return e?(s=String(e.getFullYear()),t=e.getMonth()+1,t<10&&(t="0"+t),s+=String(t),t=e.getDate(),t<10&&(t="0"+t),s+=String(t)):s="      ",s},Dbf.prototype.winToDos=function(e){var t=this;if(!Dbf.prototype.dos){var s={};s["А"]=128,s["Б"]=129,s["В"]=130,s["Г"]=131,s["Д"]=132,s["Е"]=133,s["Ё"]=240,s["Ж"]=134,s["З"]=135,s["И"]=136,s["Й"]=137,s["К"]=138,s["Л"]=139,s["М"]=140,s["Н"]=141,s["О"]=142,s["П"]=143,s["Р"]=144,s["С"]=145,s["Т"]=146,s["У"]=147,s["Ф"]=148,s["Х"]=149,s["Ц"]=150,s["Ч"]=151,s["Ш"]=152,s["Щ"]=153,s["Ы"]=155,s["Ь"]=156,s["Ъ"]=154,s["Э"]=157,s["Ю"]=158,s["Я"]=159,s["а"]=160,s["б"]=161,s["в"]=162,s["г"]=163,s["д"]=164,s["е"]=165,s["ё"]=241,s["ж"]=166,s["з"]=167,s["и"]=168,s["й"]=169,s["к"]=170,s["л"]=171,s["м"]=172,s["н"]=173,s["о"]=174,s["п"]=175,s["р"]=224,s["с"]=225,s["т"]=226,s["у"]=227,s["ф"]=228,s["х"]=229,s["ц"]=230,s["ч"]=231,s["ш"]=232,s["щ"]=233,s["ы"]=235,s["ь"]=236,s["ъ"]=234,s["э"]=237,s["ю"]=238,s["я"]=239,Dbf.prototype.dos={};for(var r in s)Dbf.prototype.dos[r]=s[r],Dbf.prototype.dos[common.UnicodeToWin1251(r)]=s[r]}for(var n=0;n<e.length;n++){var o=String.fromCharCode(e[n]);t.dos[o]&&(e[n]=t.dos[o])}},Dbf.prototype.getBuffer=function(e){var t,s,r=this,n=32+32*r.fields.length+1,o=new Buffer(n);for(o[0]=3,dateLastUpdate=new Date,o[1]=dateLastUpdate.getFullYear()-1900,o[2]=dateLastUpdate.getMonth()+1,o[3]=dateLastUpdate.getDate(),o.writeUInt32LE(r.rows.length,4),o.writeUInt16LE(n,8),s=1,t=0;t<r.fields.length;t++)s+=r.fields[t].size;for(o.writeUInt16LE(s,10),t=12;t<=31;t++)o[t]=0;for(t=0;t<r.fields.length;t++)o.fill(0,32+32*t,32+32*t+32),o.write(r.fields[t].name,32+32*t,r.fields[t].name.length),o.write(r.fields[t].type,32+32*t+11,1),o[32+32*t+16]=r.fields[t].size,o[32+32*t+17]=r.fields[t].dec;o[32+32*t]=13;var i,a,c=[o];for(t=0;t<r.rows.length;t++){var l=new Buffer(s);l.fill(32),a=1;for(var f=0;f<r.fields.length;f++){var u=r.fields[f];"C"==u.type&&(i=r.rows[t][u.name]||"",i.length>u.size&&(i=i.substr(0,u.size))),"N"==u.type&&(i=r.rows[t][u.name]),"D"==u.type&&(i=r.convertDate(r.rows[t][u.name]));var d;"DOS"==e?(d=new Buffer(common.UnicodeToWin1251(i),"binary"),r.winToDos(d)):d=new Buffer(common.UnicodeToWin1251(i),"binary"),d.copy(l,a),a+=u.size}c.push(l)}var g=Buffer.concat(c);if(c.length>1)for(var t=0;t<c.length;t++)delete c[t];return g},dbf={},dbf.report=function(e,t,s){if(e.url.indexOf("/report?")>-1&&"dbf"==e.query.format){for(var r={},n=e.body.split("&"),o=0;o<n.length;o++){var i=n[o].split("=");i[1]=i[1].split("+").join("%20"),i[1]=unescape(i[1]),i[1]=new Buffer(i[1],"ascii").toString("utf8"),r[i[0]]=JSON.parse(i[1])}var a=new Dbf(r),c=a.getBuffer(r.options.coding);t.header("Content-Type","application/x-download;"),t.header("Content-Disposition","attachment; filename="+(r.options.filename||"data.dbf")),t.header("Expires","-1"),t.header("Content-Length",c.length),t.statusCode=200,t.end(c)}else s()};var xmlss={};xmlss.customReport=function(e){var t=e.styles,s=e.sheets,r=new XMLSS;for(var n in t)r.addStyle(n,t[n]);for(var o={1:9,2:14.25,3:19.5,4:24.75,5:30,6:35.25,7:40.5,8:45.75,9:51,10:56.25,11:61.5,12:66.75,13:72,14:77.25,15:82.5,16:87.75,17:93,18:98.25,19:103.5,20:108.75},i=0;i<s.length;i++){var a=s[i],c=a.name;r.sheet.create(c);var l="Portrait";a.orientation&&(l="landscape"==a.orientation?"Landscape":"Portrait"),r.sheet.orientation.push(l),r.sheet.validation.push(a.validation),r.sheet.namedRange.push(a.namedRange);var f=a.scale||"100";r.sheet.scale.push(f);var u=!1;a.autoFitHeight&&(u=!0),r.sheet.autoFitHeight.push(u);var d=2.5,g=2,p=2,m=2.5;if(a.margins){var h=a.margins;h.left&&(g=h.left/10),h.top&&(m=h.top/10),h.right&&(p=h.right/10),h.bottom&&(d=h.bottom/10)}r.sheet.marginBottom.push(d),r.sheet.marginLeft.push(g),r.sheet.marginRight.push(p),r.sheet.marginTop.push(m);for(var v=a.rows,b=0;b<v.length;b++){var _=v[b],w=_.cells,y=_.height,j=0;_.startIndex&&(j=_.startIndex),r.pushRow(y,j);for(var x=0;x<w.length;x++){var q=w[x],C="Default";q.style&&(C=q.style);var $=1;q.colspan&&($=q.colspan);var S=1;q.rowspan&&(S=q.rowspan);var T=0;q.startIndex&&(T=q.startIndex);var I="";q.text&&(I=String(q.text));for(var A="",O=0;O<I.length;O++)A+="\n"==I[O]?"&#10;":I[O];r.pushCell(A,C,$,S,T)}}0==v.length&&(r.pushRow(),r.pushCell(""));var k=a.columns;for(var R in k){var D=k[R];if(D.width){var P=D.width;P=o[P]||5*P,r.setColWidth(P,R,R,!0)}}}var F=r.content();return F},xmlss.XMLSS=XMLSS,Sheet.prototype.create=function(e){var t=this.sheetName.length;this.sheetName.push(e),this.rowSheetId[this.xml.data.length]=t},Sheet.prototype.getSheetNum=function(){return this.sheetName.length},Sheet.prototype.setColWidth=function(e,t,s,r){var n=6;r&&(n=1);var o=this.sheetName.length-1;if(this.colWidth[o]=this.colWidth[o]||{},0==s)this.colWidth[o][t]=e*n;else if(s>=t)for(var i=t;i<=s;i++)this.colWidth[o][i]=e*n},Sheet.prototype.getColWidth=function(e,t){return this.colWidth[e]&&this.colWidth[e][t]?this.colWidth[e][t]:9},Sheet.prototype.getHeader=function(e){var t="";t+="<Worksheet ss:Name='"+this.sheetName[e]+"'>\n",this.xml.printTitlesRow1>0&&(t+="<Names>\n",t+="<NamedRange ss:Name='Print_Titles' ss:RefersTo='=Sheet1!R"+this.xml.printTitlesRow1+":R"+this.xml.printTitlesRow2+"'/>\n",t+="</Names>\n"),t+="<Table ss:ExpandedColumnCount='255' ss:ExpandedRowCount='65535' x:FullColumns='1' x:FullRows='1'>\n";for(var s=1;s<=255;s++)t+="<Column ss:AutoFitWidth='0' ss:Width='",t+=this.getColWidth(e,s),t+="'/>\n";return t},Sheet.prototype.getFooter=function(e){var t="",s=this.xml;if(t+="</Table>\n",t+="<WorksheetOptions xmlns='urn:schemas-microsoft-com:office:excel'>\n",t+="<PageSetup>\n","Landscape"==s.sheet.orientation[e]&&(t+="<Layout x:Orientation='Landscape'/>\n"),t+="<PageMargins x:Bottom='"+s.sheet.marginBottom[e]/2.54,t+="' x:Left='"+s.sheet.marginLeft[e]/2.54,t+="' x:Right='"+s.sheet.marginRight[e]/2.54,t+="' x:Top='"+s.sheet.marginTop[e]/2.54,t+="'/>\n",t+="</PageSetup>\n",(s.fitWidth||s.fitHeight)&&(t+="<FitToPage/>\n"),t+="<Print>\n",s.fitWidth&&(t+="<FitWidth>"+s.fitWidth+"</FitWidth>\n"),s.fitHeight&&(t+="<FitHeight>"+s.fitHeight+"</FitHeight>\n"),t+="<ValidPrinterInfo/>\n",t+="<PaperSizeIndex>"+s.paperSizeIndex+"</PaperSizeIndex>\n",t+="<Scale>"+s.sheet.scale[e]+"</Scale>\n",t+="<HorizontalResolution>600</HorizontalResolution>\n",t+="<VerticalResolution>600</VerticalResolution>\n",t+="</Print>\n",s.showPageBreakZoom&&(t+="<ShowPageBreakZoom/>"),t+="<Zoom>"+s.zoom+"</Zoom>\n",t+="<Selected/>\n",t+="<Panes>\n",t+="<Pane>\n",t+="<Number>3</Number>\n",t+="<ActiveRow>13</ActiveRow>\n",t+="<ActiveCol>3</ActiveCol>\n",t+="</Pane>\n",t+="</Panes>\n",t+="<ProtectObjects>False</ProtectObjects>\n",t+="<ProtectScenarios>False</ProtectScenarios>\n",t+="</WorksheetOptions>\n",s.sheet.validation[e]&&s.sheet.validation[e].length)for(var r=s.sheet.validation[e],n=0;n<r.length;n++){t+='<DataValidation  xmlns="urn:schemas-microsoft-com:office:excel">\n';var o=r[n],i="";o.r1&&(i+="R"+o.r1),o.c1&&(i+="C"+o.c1),(o.r2||o.c2)&&(i+=":",o.r2&&(i+="R"+o.r2),o.c2&&(i+="C"+o.c2)),t+="<Range>"+i+"</Range>\n",t+="<Type>"+o.type+"</Type>\n",o.value&&("object"==typeof o.value&&o.value.length?(t+="<CellRangeList/>\n",t+="<Value>&quot;"+o.value.join(",")+"&quot;</Value>\n"):t+="<Value>"+o.value+"</Value>\n"),o.min&&(t+="<Min>"+o.min+"</Min>\n"),o.max&&(t+="<Max>"+o.max+"</Max>\n"),t+="</DataValidation>\n"}return t+="</Worksheet>\n"},Sheet.prototype.hasStartRow=function(e){return this.rowSheetId.hasOwnProperty(e)},Sheet.prototype.getSheetIdByRowId=function(e){return this.rowSheetId[e]},XMLSS.prototype.setDefaultStyles=function(){this.xmlStyles="<Style ss:ID='Default' ss:Name='Normal'>\n<Alignment ss:Horizontal='Left' ss:Vertical='Center'/>\n<Borders/>\n<Font ss:FontName='Arial Cyr' x:CharSet='204' ss:Size='"+this.fontSize+"' />\n<Interior/>\n<NumberFormat/>\n<Protection/>\n</Style>\n"},XMLSS.prototype.clearColWidth=function(){this.colWidth=[];for(var e=0;e<257;e++)this.colWidth.push(50.58)},XMLSS.prototype.setColWidth=function(e,t,s,r){var n=6;if(r&&(n=1),0==this.sheet.getSheetNum()){if(0==s)this.colWidth[t]=e*n;else if(s>=t)for(var o=t;o<=s;o++)this.colWidth[o]=e*n}else this.sheet.setColWidth(e,t,s,r)},XMLSS.prototype.clearRowHeight=function(){this.rowHeight=[];for(var e=0;e<this.data.length;e++)this.rowHeight.push(this.defRowHeight)},XMLSS.prototype.clearRowStartIndex=function(){this.rowStartIndex=[];for(var e=0;e<this.data.length;e++)this.rowStartIndex.push(0)},XMLSS.prototype.addStyle=function(e,t){var s,r,n="",o={};for(s=0;s<t.length;s++){var i=t[s];","==i||s==t.length-1?(s==t.length-1&&(n+=i),o[r]=n,n=""):":"==i?(r=n,n=""):n+=i}o.hAlign||(o.hAlign="Left"),o.vAlign||(o.vAlign="Center"),o.fontSize||(o.fontSize="10"),o.fontName||(o.fontName="Arial Cyr");var a="";if(a+="<Style ss:ID='"+e+"'>\n",a+="<Alignment ss:Horizontal='"+o.hAlign+"' ss:Vertical='"+o.vAlign+"'",o.rotate&&(a+=" ss:Rotate='"+o.rotate+"'"),"true"==o.wrap&&(a+=" ss:WrapText='1'"),a+="/>\n",o.numberFormat&&(a+="<NumberFormat ss:Format='"+o.numberFormat+"'/>"),a+="<Borders>\n",o.borders){var c=o.borders;"AllDash"==c?c="LeftDash RightDash TopDash BottomDash":"All"==c&&(c="Left Right Top Bottom"),c.indexOf("LCont")!=-1&&(a+="<Border ss:Position='Left' ss:LineStyle='Continuous' ss:Weight='2'/>\n"),c.indexOf("BottomDash")!=-1?a+="<Border ss:Position='Bottom' ss:LineStyle='Dash' ss:Weight='1'/>\n":c.indexOf("Bottom")!=-1&&(a+="<Border ss:Position='Bottom' ss:LineStyle='Continuous' ss:Weight='1'/>\n"),c.indexOf("LeftDash")!=-1?a+="<Border ss:Position='Left' ss:LineStyle='Dash' ss:Weight='1'/>\n":c.indexOf("Left")!=-1&&(a+="<Border ss:Position='Left' ss:LineStyle='Continuous' ss:Weight='1'/>\n"),c.indexOf("RightDash")!=-1?a+="<Border ss:Position='Right' ss:LineStyle='Dash' ss:Weight='1'/>\n":c.indexOf("Right")!=-1&&(a+="<Border ss:Position='Right' ss:LineStyle='Continuous' ss:Weight='1'/>\n"),c.indexOf("TopDash")!=-1?a+="<Border ss:Position='Top' ss:LineStyle='Dash' ss:Weight='1'/>\n":c.indexOf("Top")!=-1&&(a+="<Border ss:Position='Top' ss:LineStyle='Continuous' ss:Weight='1'/>\n")}a+="</Borders>\n",a+="<Font ss:FontName='"+o.fontName+"' x:CharSet='204'",a+=" ss:Size='"+o.fontSize+"'","true"==o.bold&&(a+=" ss:Bold='1'"),"true"==o.italic&&(a+=" ss:Italic='1'"),"true"==o.underline&&(a+=" ss:Underline='Single'"),o.fontColor&&(a+=" ss:Color='"+o.fontColor+"'"),a+="/>",o.bgColor&&(a+="<Interior ss:Color='"+o.bgColor+"' ss:Pattern='Solid'/>"),a+="</Style>\n",this.xmlStyles+=a},XMLSS.prototype.pushRow=function(e,t){12.75==e&&(e=this.defRowHeight),this.rowStartIndex.push(t),this.rowHeight.push(e);var s=[];return this.data.push(s),this.row=s,this.data.length-1},XMLSS.prototype.pushCell=function(e,t,s,r,n){return!this.row.length&&!n&&this.rowStartIndex[this.rowStartIndex.length-1]>0&&(n=this.rowStartIndex[this.rowStartIndex.length-1]),this.row.push(new Cell(e,t,s,r,n)),this.row.length-1},XMLSS.prototype.content=function(){var e=this.getMultiSheetContent();return e},XMLSS.prototype.getMultiSheetContent=function(){for(var e,t,s,r,n,o,i,a,c="",l=1,f=0,s=0;s<this.data.length;s++){var u=this.data[s];this.sheet.hasStartRow(f)&&(n=this.sheet.getSheetIdByRowId(f),f>0&&(c+=this.sheet.getFooter(n-1)),c+=this.sheet.getHeader(n)),c+=this.sheet.autoFitHeight[n]&&this.rowHeight[l-1]==this.defRowHeight?"<Row ss:AutoFitHeight='1'>\n":"<Row ss:AutoFitHeight='0' ss:Height='"+this.rowHeight[l-1]+"'>\n",t=1;for(var r=0;r<u.length;r++){var d=u[r];if(""!=d.style||""!=d.text){c+="<Cell",d.index>0&&(c+=" ss:Index='"+d.index+"'"),""!=d.style&&(c+=" ss:StyleID='"+d.style+"'"),d.colspan>1&&(c+=" ss:MergeAcross='"+(d.colspan-1)+"'"),d.rowspan>1&&(c+=" ss:MergeDown='"+(d.rowspan-1)+"'"),o=0,i=0,a=d.text.length;for(var g=0;g<a;g++)"0123456789".indexOf(d.text[g])>-1&&o++,"."==d.text[g]&&i++;if(a>0&&o+i==a&&o>0&&i<=1)c+="><Data ss:Type='String'>"+d.text+"</Data></Cell>\n";else{var p=d.text.split("<").join("&lt;");p=p.split(">").join("&gt;"),c+="><Data ss:Type='String'>"+p+"</Data></Cell>\n"}}d.index>0?t=d.index+d.colspan:t+=d.colspan}c+="</Row>\n",l++,f++}return c+=this.sheet.getFooter(n),e="<?xml version='1.0'?>\n",e+="<?mso-application progid='Excel.Sheet'?>\n",e+="<Workbook xmlns='urn:schemas-microsoft-com:office:spreadsheet'\n",e+="xmlns:o='urn:schemas-microsoft-com:office:office'\n",e+="xmlns:x='urn:schemas-microsoft-com:office:excel'\n",e+="xmlns:ss='urn:schemas-microsoft-com:office:spreadsheet'\n",e+="xmlns:html='http://www.w3.org/TR/REC-html40'>\n",e+="<DocumentProperties xmlns='urn:schemas-microsoft-com:office:office'>\n",e+="<Author>Dimas</Author>\n",e+="<LastAuthor>Dimas</LastAuthor>\n",e+="<Created>2008-04-10T14:18:34Z</Created>\n",e+="<Company>-</Company>\n",e+="<Version>11.5606</Version>\n",e+="</DocumentProperties>\n",e+="<ExcelWorkbook xmlns='urn:schemas-microsoft-com:office:excel'>\n",e+="<WindowHeight>10230</WindowHeight>\n",e+="<WindowWidth>14235</WindowWidth>\n",e+="<WindowTopX>480</WindowTopX>\n",e+="<WindowTopY>15</WindowTopY>\n",e+="<ProtectStructure>False</ProtectStructure>\n",e+="<ProtectWindows>False</ProtectWindows>\n",e+="</ExcelWorkbook>\n",e+="<Styles>\n"+this.xmlStyles+"</Styles>\n",e+="<Names>\n"+this.getNamedRangeList()+"</Names>\n",e+=c,e+="</Workbook>\n"},XMLSS.prototype.getNamedRange=function(e,t,s){for(var r=0;r<e.length;r++){var n=e[r];if(t>=n.r1&&s>=n.c1&&t<=n.r2&&s<=n.c2||t==n.r1&&(s==n.c1||s>=n.c1&&s<=n.c2||!n.c1)||s==n.c1&&(t==n.r1||t>=n.r1&&t<=n.r2||!n.r1))return n.name}},XMLSS.prototype.getNamedRangeList=function(){for(var e="",t=0;t<this.sheet.namedRange.length;t++){var s=this.sheet.namedRange[t];if(s&&s.length)for(var r=0;r<s.length;r++){var n="";s[r].r1&&(n+="R"+s[r].r1),s[r].c1&&(n+="C"+s[r].c1),(s[r].r2||s[r].c2)&&(n+=":",s[r].r2&&(n+="R"+s[r].r2),s[r].c2&&(n+="C"+s[r].c2)),e+='<NamedRange ss:Name="'+s[r].name+'" ss:RefersTo="='+this.sheet.sheetName[t]+"!"+n+'"/>'}}return e},xmlss.getAttr=function(e){var t=e.storage,s=e.tags,r=e.success,n=e.text.split("."),o=!1;n.length&&"$date"==n[n.length-1]&&(n.splice(n.length-1,1),o=!0);var i,a;e.timeOffset=e.timeOffset||-144e5;var c=function(t){return t?(t.getUTCHours()||t.getUTCMinutes()||t.getUTCSeconds()?(t=new Date(t.getTime()-e.timeOffset),t=common.getUTCTimestamp(t),"00:00:00"==t.substr(11,8)&&(t=t.substr(0,10))):t=common.getUTCDate(t),t):t};async.reduce(n,0,function(e,r,o){e?(a=i.get(r),e<n.length-1?t.getObject({id:a,success:function(t){i=t.object,i?o(null,e+1):o("empty")},failure:function(e){o("empty")}}):o(null,e+1)):n.length>1?t.getObject({id:s[r],success:function(t){i=t.object,i?o(null,e+1):o("empty")},failure:function(e){o("empty")}}):(a=s[r],o(null,e+1))},function(e,t){"empty"==e||void 0==a||null==a?r(""):(o&&a?(a=c(a),a&&(a=a.substr(0,10))):a&&"object"==typeof a&&a.getMonth&&(a=c(a)),r(a))})},xmlss.updateTags=function(e){var t=e.success;e.timeOffset=60*e.request.query.time_offset_min*1e3;for(var s=[],r=e.data,n=1;n<r.length;n++)if("$"==r[n]&&"["==r[n-1]){var o="";for(n++;n<r.length&&"]"!=r[n];n++)o+=r[n];s.indexOf(o)==-1&&s.push(o)}async.mapSeries(s,function(t,s){e.text=t,e.success=function(e){r=r.split("[$"+t+"]").join(e),s()},xmlss.getAttr(e)},function(e,s){t(r)})},xmlss.report=function(e,t,s){if(e.url.indexOf("/report?")>-1){var r=e.url;1!=e.query.custom&&(r=r.split("&view").join("&noview"),r+="&custom=1");var n={},o=e.body;if(o){for(var i=o.split("&"),a=0;a<i.length;a++){var c=i[a].split("=");c[1]=c[1].split("+").join("%20"),c[1]=unescape(c[1]),c[1]=new Buffer(c[1],"ascii").toString("utf8"),n[c[0]]=1==e.query.csv?c[1]:JSON.parse(c[1])}n.opts&&_.extend(n,n.opts)}if(1==e.query.csv){var l=new Buffer(common.UnicodeToWin1251(n.body),"binary");t.header("Content-Type","application/x-download; charset=windows-1251"),t.header("Content-Disposition","attachment; filename=report.csv"),t.header("Expires","-1"),t.header("Content-Length",l.length),t.statusCode=200,t.end(l)}else if(1==e.query.custom){var l=xmlss.customReport(n);t.header("Content-Type","application/x-download"),t.header("Content-Disposition","attachment; filename=report.xml"),t.header("Expires","-1"),t.header("Content-Length",Buffer.byteLength(l,"utf8")),t.statusCode=200,t.end(l)}else if(e.query.view){var f=e.session,u=f.storage,d=e.query.view,g=u.viewsMap[d],p=JSON.parse(g.get("fquery")),m=n.filter||[];if(m&&m.length){p.where=p.where||[],p.where.length&&p.where.push("and");for(var h={},a=1;a<p.select.length;a+=2)h[p.select[a]]=p.select[a-1];for(var a=0;a<m.length;a++)h[m[a]]&&(m[a]=h[m[a]]);p.where.push(m)}var v=null;e.query.order&&(v=JSON.parse(e.query.order));var b=[];n.options&&(b=n.options.dateAttrs||[]),v&&v.length&&(p.order=v);for(var w=n.cols||[],y={},a=0;a<w.length;a++)y[w[a].attrId]=w[a];var j=new Query({session:f,storage:u,sql:p});j.generate(),u.query({sql:j.selectSQL+j.fromSQL+j.whereSQL+j.orderSQL+("mssql"!=u.client.database?"\nlimit "+config.query.maxRowNum+" offset 0\n":""),success:function(s){var r=s.result.rows,n=g.attrs,o=0,i=[];for(var a in n)y[n[a].get("fid")]&&y[n[a].get("fid")].hidden||(n[a].set("field",n[a].get("fcode").toLowerCase()+"_"),i.push(n[a]),o++);i.sort(function(e,t){return null!==e.get("forder")&&null!==t.get("forder")&&e.get("forder")<t.get("forder")?-1:null!=e.get("forder")&&null==t.get("forder")?-1:e.get("forder")==t.get("forder")&&e.get("fid")<t.get("fid")?-1:null!==e.get("forder")&&null!==t.get("forder")&&e.get("forder")>t.get("forder")?1:null==e.get("forder")&&null!=t.get("forder")?1:e.get("forder")==t.get("forder")&&e.get("fid")>t.get("fid")?1:0});for(var c={},l=0;l<i.length;l++)c[l+1]={width:parseInt(i[l].get("fcolumn_width")/6.5)},y[i[l].get("fid")]&&y[i[l].get("fid")].width&&(c[l+1].width=y[i[l].get("fid")].width/6.5);for(var u=[],d={height:12.75,cells:[]},p=0;p<i.length;p++)if(!y[i[p].get("fid")]||!y[i[p].get("fid")].hidden){var m=i[p].get("fname");d.cells.push({text:common.unescape(m),style:"border_bold"})}u.push(d);for(var h=60*e.query.time_offset_min*1e3,l=0;l<r.length;l++){for(var d={height:12.75,cells:[]},p=0;p<i.length;p++)if(!y[i[p].get("fid")]||!y[i[p].get("fid")].hidden){var v=i[p].get("fcode").toLowerCase()+"_",w=r[l][v];"string"==typeof w?w=w:w&&"object"==typeof w&&w.getMonth?b.indexOf(i[p].get("fcode"))==-1&&(w.getUTCHours()||w.getUTCMinutes()||w.getUTCSeconds())?(w=new Date(w.getTime()-h),w=common.getUTCTimestamp(w)):w=common.getUTCDate(w):4==j.fieldTypeId[v]&&(w=w?"Да":"Нет"),d.cells.push({text:w,style:"border"})}u.push(d)}if("xmlss"==e.query.format){var x=xmlss.customReport({styles:{default:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9",center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9",center_bold:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,bold:true",bold:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,bold:true",border:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All",border_center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,borders:All",border_bold:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true",border_bold_underline:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true,underline:true",border_underline:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,underline:true",border_bold_center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true",border_bottom:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:Bottom",right:"hAlign:Right,vAlign:Center,wrap:true,fontSize:9"},sheets:[{name:"Sheet",autoFitHeight:!0,orientation:"landscape",scale:100,margins:{left:31,top:32,right:33,bottom:34},columns:c,rows:u}]});t.header("Content-Type","application/x-download"),t.header("Content-Disposition","attachment; filename=report.xml"),t.header("Expires","-1"),t.header("Content-Length",Buffer.byteLength(x,"utf8")),t.statusCode=200,t.end(x)}else if("pdf"==e.query.format)pdf.buildReportFromXMLSS({session:f,sheet:{name:"Sheet",autoFitHeight:!0,orientation:"landscape",scale:100,margins:{left:31,top:32,right:33,bottom:34},columns:c,rows:u}},function(e,s){e?t.end("{success: false, error: '"+e+"'}"):(t.header("Content-Type","application/x-download;"),t.header("Content-Disposition","attachment; filename=report.pdf"),t.header("Expires","-1"),t.header("Content-Length",s.length),t.statusCode=200,t.end(s))});else if("ods"==e.query.format){var q=require("adm-zip"),C=new q,$=require("fs");C.addLocalFolder(__dirname+"/report/template.ods");var $=require("fs");$.readFile(__dirname+"/report/template.ods/content.xml","utf8",function(e,s){var r=require("xml2js"),n=new r.Parser({explicitArray:!1});n.parseString(s,function(e,s){s["office:document-content"]["office:body"]["office:spreadsheet"]["table:table"]["table:table-row"]=[],_.each(u,function(e){var t=[];_.each(e.cells,function(e){e.text=e.text||"",e.style=e.style||"",e.colspan=e.colspan||1,e.rowspan=e.rowspan||1;var s=e.text;t.push({$:{"office:value-type":"string","calcext:value-type":"string"},"text:p":s})}),s["office:document-content"]["office:body"]["office:spreadsheet"]["table:table"]["table:table-row"].push({$:{"table:style-name":"ro1"},"table:table-cell":t})});var n=new r.Builder,o=n.buildObject(s);C.updateFile("content.xml",new Buffer(o));var i=C.toBuffer();t.header("Content-Type","application/x-download;"),t.header("Content-Disposition","attachment; filename=report.ods"),t.header("Expires","-1"),t.header("Content-Length",i.length),t.statusCode=200,t.end(i)})})}else if("csv"==e.query.format){var S="";if(_.each(u,function(e){_.each(e.cells,function(e){S+=(null===e.text?"":e.text)+";"}),S+="\n"}),"win1251"==e.query.coding){S=common.UnicodeToWin1251(S);var x=new Buffer(S,"binary");t.header("Content-Type","application/x-download; charset=windows-1251"),t.header("Content-Disposition","attachment; filename=report.csv"),t.header("Expires","-1"),t.header("Content-Length",S.length),t.statusCode=200,t.end(x)}else t.header("Content-Type","application/x-download; charset=utf-8"),t.header("Content-Disposition","attachment; filename=report.csv"),t.header("Expires","-1"),t.header("Content-Length",Buffer.byteLength(S,"utf8")),t.statusCode=200,t.end(S)}else if("xlsx"==e.query.format){var T=new ReportXSLX;s.styles={default:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9",center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9",center_bold:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,bold:true",bold:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,bold:true",border:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All",border_center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,borders:All",border_bold:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true",border_bold_underline:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true,underline:true",border_underline:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,underline:true",border_bold_center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true",border_bottom:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:Bottom",right:"hAlign:Right,vAlign:Center,wrap:true,fontSize:9"},s.sheets=[{name:"Sheet",autoFitHeight:!0,orientation:"landscape",scale:100,margins:{left:31,top:32,right:33,bottom:34},columns:c,rows:u}],T.build(s);var I=XLSX.write(T.workbook,{type:"base64"}),x=new Buffer(I,"base64");t.header("Content-Type","application/x-download;"),t.header("Content-Disposition","attachment; filename=report.xlsx"),t.header("Expires","-1"),t.header("Content-Length",x.length),t.statusCode=200,t.end(x),delete T}}})}else{var x,f=e.session,u=f.storage,q=config.storages[u.code].rootDir+(e.query.files?"/files/":"/reports/")+e.query.template;_.extend(n,e.query),"xmlss"==n.format&&async.series([function(e){fs.readFile(q,function(t,s){x=s,e(t)})},function(t){n.showTags?(x=x.toString(),t()):xmlss.updateTags({request:e,tags:n,storage:u,data:x.toString(),success:function(e){x=e,t()}})}],function(e,s){t.header("Content-Type","application/x-download");var r=n.template.split("."),o="report."+r[r.length-1];t.header("Content-Disposition","attachment; filename="+o),t.header("Expires","-1"),t.header("Content-Length",Buffer.byteLength(x,"utf8")),t.statusCode=200,t.end(x)}),"docx"==n.format&&async.series([function(e){fs.readFile(q,"binary",function(t,s){x=s,e(t)})}],function(e,s){var r=require("docxtemplater"),o=new r(x);o.setOptions({parser:function(e){return{get:function(t){return"."===e?t:t[e]}}}}),o.setData(n),n.showTags||o.render();var i=o.getZip().generate({type:"nodebuffer"});t.header("Content-Type","application/x-download"),t.header("Content-Disposition","attachment; filename=report.docx"),t.header("Expires","-1"),t.header("Content-Length",i.length),t.statusCode=200,t.end(i)})}}else s()};var pdf={};pdf.buildReportFromXMLSS=function(e,t){var s=e.session,r=e.sheet,n=r.columns,o=r.orientation,i=r.rows,a='<html>\n<head>\n<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">\n<style type=\'text/css\'>\n* {\n   font-family: Arial;\n   font-size: 10pt;\n}\n</style>\n</head>\n<body>\n';a+="%"==r.ell?"<table cellspacing=0 width=100% border=1>\n":"<table cellspacing=0 border=1>\n";for(var c=0;c<i.length;c++){for(var l=i[c],f=l.cells,u="<tr height=20>\n",d=1,g=0;g<f.length;g++){var p=f[g];p.text=p.text||"",p.style=p.style||"",p.colspan=p.colspan||1,p.rowspan=p.rowspan||1;var m=p.text;void 0!==m&&null!==m&&""!==m||(m="<img width=1 height=1>"),p.style.indexOf("bold")>-1&&(m="<b>"+m+"</b>");for(var h="",v=0,b=d;b<d+p.colspan;b++)v+=n[b]?n[b].width||0:0;v&&(h+="width: "+v+r.ell+";"),p.style.indexOf("underline")>-1&&(h+="border-bottom: 1px solid #000000;");var _="";p.style.indexOf("center")>-1&&(_=" align=center "),u+="\t<td colspan="+p.colspan+" rowspan="+p.rowspan+_+" style='"+h+"'>"+m+"</td>\n",d+=p.colspan}u+="</tr>\n",a+=u}a+="</table>\n</body>\n</html>\n",fs.writeFile(__dirname+"/report/pdf/"+s.id+".html",a,function(e){if(e)return t(e);var r=require("child_process").spawn,n=["--orientation","landscape"==o?"Landscape":"Portrait","--dpi",300,"--page-size","A4",__dirname+"/report/pdf/"+s.id+".html",__dirname+"/report/pdf/"+s.id+".pdf"],i=__dirname+"/report/pdf/wkhtmltopdf";config.report&&config.report.pdf&&(i=config.report.pdf);var a=r(i,n);a.stdout.on("data",function(e){console.log("stdout: "+e)}),a.stderr.on("data",function(e){console.log("stderr: "+e)}),a.on("close",function(e){fs.unlink(__dirname+"/report/pdf/"+s.id+".html",function(e){return e?t(e):void fs.readFile(__dirname+"/report/pdf/"+s.id+".pdf",function(e,r){return e?t(e):void fs.unlink(__dirname+"/report/pdf/"+s.id+".pdf",function(e){return e?t(e):void t(null,r)})})})})})},pdf.report=function(e,t,s){var r=e.session;r.storage;if(e.url.indexOf("/pdf?")>-1&&projects.sessions[r.id]){var n={},o=e.body;if(o){o=o.split("+").join("%20"),o=unescape(o),o=new Buffer(o,"ascii").toString("utf8");for(var i=o.split("&"),a=0;a<i.length;a++){var c=i[a].split("=");n[c[0]]=JSON.parse(c[1])}}var l=n.sheets[0];pdf.buildReportFromXMLSS({sheet:l,session:r},function(e,s){e?t.end("{success: false, error: '"+e+"'}"):(t.header("Content-Type","application/x-download;"),t.header("Content-Disposition","attachment; filename=report.pdf"),t.header("Expires","-1"),t.header("Content-Length",s.length),t.statusCode=200,t.end(s))})}else s()};var XLSX=require("xlsx"),ReportXSLX=Backbone.Model.extend({addStyle:function(e,t){var s=this;s.styles=s.styles||{};var r={alignment:{horizontal:"left",vertical:"top"},font:{name:"Arial",sz:"9"}};_.each(t.split(","),function(e){var t=e.split(":")[0],s=e.split(":")[1];"hAlign"==t&&(r.alignment.horizontal={Left:"left",Center:"center",Right:"right"}[s]),"vAlign"==t&&(r.alignment.vertical={Left:"top",Center:"center",Right:"bottom"}[s]),"wrap"==t&&(r.alignment.wrapText=!0),"rotate"==t&&(r.alignment.textRotation=90),"fontSize"==t&&(r.font.sz=s),"fontName"==t&&(r.font.name=s),"bold"==t&&(r.font.bold=!0),"italic"==t&&(r.font.italic=!0),"underline"==t&&(r.font.underline=!0),"borders"==t&&(r.border={left:{style:"thin",color:{auto:1}},right:{style:"thin",color:{auto:1}},top:{style:"thin",color:{auto:1}},bottom:{style:"thin",color:{auto:1}}})}),s.styles[e]=r},addCell:function(e,t,s,r){var n=this,o=r.colspan>1?r.colspan-1:0,i=r.rowspan>1?r.rowspan-1:0;(o||i)&&(e["!merges"]=e["!merges"]||[],e["!merges"].push({s:{c:t,r:s},e:{c:t+o,r:s+i}}));for(var a=t;a<=t+o;a++)for(var c=s;c<=s+i;c++)e[XLSX.utils.encode_cell({c:a,r:c})]={v:null===r.text?"":r.text,t:"s",s:n.styles[r.style]}},addCols:function(e,t){e["!cols"]=_.map(t,function(e){var t;return t=_.isObject(e)?e.width:e,{wch:t}})},addSheet:function(e){var t=this,s={},r=0,n=0;_.each(e.rows,function(e){var o=e.startIndex?e.startIndex-1:0;_.each(e.cells,function(e){e.startIndex&&(o=e.startIndex-1),t.addCell(s,o,r,e),o+=e.colspan||1}),n=o>n?o:n,r++}),t.addCols(s,e.columns),s["!ref"]=XLSX.utils.encode_range({s:{c:0,r:0},e:{c:n,r:r}}),t.workbook.SheetNames.push(e.name),t.workbook.Sheets[e.name]=s},build:function(e){var t=this;t.workbook={SheetNames:[],Sheets:{}},_.each(e.styles,function(e,s){t.addStyle(s,e)}),_.each(e.sheets,function(e){t.addSheet(e)})}}),xlsx={};xlsx.report=function(e,t,s){if(e.url.indexOf("/report?")>-1&&"xlsx"==e.query.format&&!e.query.view){var r={},n=e.body;if(n)for(var o=n.split("&"),i=0;i<o.length;i++){var a=o[i].split("=");a[1]=a[1].split("+").join("%20"),a[1]=unescape(a[1]),a[1]=new Buffer(a[1],"ascii").toString("utf8"),r[a[0]]=JSON.parse(a[1])}var c=new ReportXSLX;if(c.build(r),log.debug({workbook:c.workbook}),e.query.convert_csv){var l=XLSX.utils.sheet_to_csv(c.workbook.Sheets[c.workbook.SheetNames[0]],{FS:";"});if(e.query.win1251){var f=new Buffer(common.UnicodeToWin1251(l),"binary");t.header("Content-Type","application/x-download; charset=windows-1251"),t.header("Content-Disposition","attachment; filename=report.csv"),t.header("Expires","-1"),t.header("Content-Length",f.length),t.statusCode=200,t.end(f)}else t.header("Content-Type","application/x-download;"),t.header("Content-Disposition","attachment; filename=report.csv"),t.header("Expires","-1"),t.header("Content-Length",l.length),t.statusCode=200,t.end(l)}else{var u=XLSX.write(c.workbook,{type:"base64"}),f=new Buffer(u,"base64");t.header("Content-Type","application/x-download;"),t.header("Content-Disposition","attachment; filename=report.xlsx"),t.header("Expires","-1"),t.header("Content-Length",f.length),t.statusCode=200,t.end(f)}delete c}else s()};var tm={};tm.remove=function(e){var t=e.success,s=e.session,r=e.storage,n=e.revision,o="select fid, fcode from tclass\nwhere\n\t"+r.getCurrentFilter()+"\n\tand fid >= 1000\norder by fid\n";r.query({session:s,sql:o,success:function(e){var o=e.result.rows;async.eachSeries(o,function(e,t){var o="tm_"+e.fcode+"_"+e.fid;r.client.isTableExists({session:s,table:o,success:function(e){e?r.query({session:s,sql:"delete from "+o+" where frevision_id="+n,success:function(){t()}}):t()}})},t)}})},tm.create=function(e){var t,r,n,o,i=e.storageCode,a=e.success;log.info({cls:"tm",fn:"create ("+i+")"}),async.series([function(e){log.info({cls:"tm"},"getStorage"),projects.getStorage({storageCode:i,success:function(t){r=t.storage,n={id:"tm_create_"+i,username:"admin",userId:null},e()}})},function(e){log.info({cls:"tm"},"startTransaction"),r.startTransaction({session:n,remoteAddr:"127.0.0.1",description:"toc_create_"+i,success:function(){t=r.lastRevision,e()},failure:function(t){e(t.error)}})},function(e){log.info({cls:"tm"},"remove"),tm.remove({storage:r,revision:t,session:n,success:function(){e()}})},function(e){log.info({cls:"tm"},"classes");var t="select\n\tfid, fcode\nfrom\n\ttclass\nwhere\n\t"+r.getCurrentFilter()+"\n\tand fid >= 1000\norder by fid\n";r.query({session:n,sql:t,success:function(t){o=t.result.rows,e()}})},function(e){log.info({cls:"tm"},"process"),async.eachSeries(o,function(e,o){var i,a=e.fid,c=e.fcode,l="tm_"+c+"_"+a;async.series([function(e){r.client.isTableExists({session:n,table:l,success:function(t){t?e():r.query({session:n,sql:"create table "+l+" (fobject_id bigint not null, frevision_id bigint not null)",success:function(){r.client.createIndex({session:n,table:l,field:"fobject_id",success:function(){r.client.createIndex({session:n,
table:l,field:"frevision_id",success:function(){e()}})}})}})}})},function(e){r.query({session:n,sql:"select\n\tfid, fcode, ftype_id\nfrom\n\ttclass_attr\nwhere\n\t"+r.getCurrentFilter()+"\n\tand fclass_id = "+a+"\norder by fid\n",success:function(t){i=t.result.rows,e()}})},function(e){async.eachSeries(i,function(e,t){var o=e.fid,i=e.fcode+"_"+o;r.client.isFieldExists({session:n,table:l,field:i,success:function(o){if(o)t();else{var a="$tnumber$",c="fnumber";switch(e.ftype_id){case 2:a="$tnumber_value$";break;case 1:case 5:a="$ttext$",c="fstring";break;case 3:a="$ttimestamp$",c="ftime"}s="alter table "+l+" add "+i+" "+a,r.query({session:n,sql:s,success:function(){t()}})}}})},function(t){e()})},function(e){r.client.isTableExists({session:n,table:c+"_"+a,success:function(s){if(s){for(var o=[],f=0;f<i.length;f++){var u=i[f].fcode+"_"+i[f].fid;o.indexOf(u)==-1&&o.push(u)}var d="insert into "+l+" (fobject_id, frevision_id"+(o.length?", ":"")+o.join(", ")+")\nselect fobject_id, "+t+(o.length?", ":"")+o.join(", ")+" from "+c+"_"+a;r.query({session:n,sql:d,success:function(){e()}})}else e()}})}],function(e,t){o()})},function(t){e()})},function(e){log.info({cls:"tm"},"update"),r.query({session:n,sql:"update trevision set ftoc=1 where fid="+t,success:function(){e()}})},function(e){log.info({cls:"tm"},"commitTransaction"),r.commitTransaction({session:n,success:function(){e()}})}],function(e){log.info({cls:"tm"},"end"),a&&a(t)})},tm.getRevisions=function(e,t,s){if(e.url.indexOf("/get_revisions?")>-1){var r=e.session,n=r.storage;n.query({session:r,sql:"select fid, fdate from trevision where ftoc=1 order by fdate desc",success:function(e){for(var s=[],r=0;r<e.result.rows.length;r++){var n=e.result.rows[r];s.push({id:n.fid,date:n.fdate})}t.send(common.ToJSONString(s))}})}else s()},tm.setRevision=function(e,t,s){if(e.url.indexOf("/set_revision?")>-1){var r=e.session;r.revision=e.query.id,t.send({ok:1})}else s()},tm.build=function(e){function t(){log.info({cls:"tm"},"start build"),tm.create({storageCode:e.code,success:function(t){e.query({sql:"select fid, fdate from trevision where fid="+t,success:function(t){var s=t.result.rows[0];e.visualObjectum.timeMachine.dates.push({id:s.fid,date:s.fdate})}})}}),setTimeout(t,864e5)}if(log.info({cls:"tm"},"build"),e.config.visualObjectum){var s=e.config.visualObjectum.timeMachine?e.config.visualObjectum.timeMachine.buildTime:null;if(s){var r=s.split(":"),n=new Date,o=new Date;Number(r[0])<n.getHours()&&o.setDate(n.getDate()+1),Number(r[0])==n.getHours()&&Number(r[1])<n.getMinutes()&&o.setDate(n.getDate()+1),o.setHours(r[0]),o.setMinutes(r[1]),o.setSeconds(0),o.setMilliseconds(0),log.info({cls:"tm"},"setTimeout "+s+" "+(o.getTime()-n.getTime())),setTimeout(t,o.getTime()-n.getTime())}}};var Ose=function(e){var t=e.storage,s=e.success,r=this;config.storages[t.code]?r.config=config.storages[t.code].ose||{enabled:0}:r.config={enabled:0},r.subject={getRoles:function(e){return r.config.enabled?n.srole[e]||[]:[]},isAdmin:function(e){return!e||n.admins.indexOf(e)>-1?1:0},can:function(e){var s=e.access,r=e.success,o=e.session,i=e.object,a=n.class_[i.get("fclass_id")];if(a&&(a[null]&&a[null][s]||a[o.userId]&&a[o.userId][s]))return void r();for(var c=0;c<o.roles.length;c++)if(a[o.roles[c]]&&a[o.roles[c]][s])return void r();var l=o.roles.concat(o.userId);t.execute({session:o,sql:{select:[{a:"id"},"id"],from:[{a:"ose.object"}],where:[{a:s},"=",1,"and",{a:"object"},"=",i.get("id"),"and",{a:"subject"},"in",l.join(".,.").split(".")]},success:function(e){e.length?r():r({cancel:1})}})}},r.object={};var n={admins:[],ext:{},srole:{},ext:{},class_:{}};if(r.load=function(e){e=e||{};var s=e.success;async.series([function(e){t.execute({sql:{select:[{a:"role"},"role",{a:"subject"},"subject"],from:[{a:"ose.srole"}]},success:function(t){n.srole={};for(var s=0;s<t.length;s++){var r=t.get(s,"role"),o=t.get(s,"subject");n.srole[o]=n.srole[o]||[],n.srole[o].push(r)}e()}})},function(e){t.execute({sql:{select:[{a:"classAttr"},"classAttr",{a:"give"},"give",{a:"take"},"take"],from:[{a:"ose.ext"}]},success:function(t){n.ext={};for(var s=0;s<t.length;s++){var r=t.get(s,"classattr");n.ext[r]=n.ext[r]||{},n.ext[r]={classAttr:r,take:t.get(s,"take"),give:t.get(s,"give")}}e()}})},function(e){t.execute({sql:{select:[{a:"subject"},"subject",{a:"class"},"class",{a:"read"},"read",{a:"update"},"update",{a:"delete"},"delete"],from:[{a:"ose.object"}],where:[{a:"class"},"is not null"],order:[{a:"npp"}]},success:function(t){n.class_={};for(var s=0;s<t.length;s++){var r=t.get(s,"subject"),o=t.get(s,"class");n.class_[o]=n.class_[o]||{},n.class_[o][r]={read:t.get(s,"read"),update:t.get(s,"update"),delete_:t.get(s,"delete")}}e()}})},function(e){n.admins=["admin"],r.config.admins?t.execute({sql:{select:[{a:"login"},"login"],from:[{a:r.config.admins}]},success:function(t){for(var s=0;s<t.length;s++)n.admins.push(t.get(s,"login"));e()}}):e()}],function(e,t){s&&s()})},r.freeResources=function(){r.config.enabled&&clearInterval(r.loadIntervalId)},!r.config.enabled)return void s();var o=t.getClass("ose.role").get("fid"),i=t.getClass("ose.srole").get("fid"),a=t.getClass("ose.ext").get("fid"),c=t.getClass("ose.object").get("fid"),l=t.getClass(r.config.admins).get("fid"),f=[o,i,a,c,l],u=function(e){var t=e.success;e.session&&e.session.username&&!r.subject.isAdmin(e.session.username)&&e.classId!=c&&f.indexOf(e.classId)>-1&&(e.cancel=1),t(e)};t.on("beforecreateobject",u);var d=function(e){var s=e.success,o=e.classId;if(!n.class_[o]||!e.session||r.subject.isAdmin(e.session.username))return void s();var i=e.object,a=e.session;t.un("aftercreateobject",d),t.un("beforecreateobject",u),t.createObject({session:a,classId:c,success:function(e){t.on("aftercreateobject",d),t.on("beforecreateobject",u);var r=e.object;r.set("object",i.get("id")),r.set("subject",a.userId),r.set("read",1),r.set("update",1),r.set("delete",1),t.un("beforecommitobject",p),r.commit({session:a,success:function(){t.on("beforecommitobject",p),s()}})}})};t.on("aftercreateobject",d);var g=function(e){var t=e.success,s=e.session,o=e.object;return o&&s&&!r.subject.isAdmin(s.username)?f.indexOf(o.get("fclass_id"))>-1?void t({cancel:1}):n.class_[o.get("fclass_id")]?void r.subject.can({session:s,object:o,access:"read",success:t}):void t():void t()};t.on("aftergetobject",g),r.ext=function(e){var s=e.success,r=e.session,o=e.object,i=[],a=t.getClass(o.get("fclass_id"));for(var l in o.data)["id","fclass_id","fspace_id"].indexOf(l)>-1||o.originalData.hasOwnProperty(l)&&o.originalData[l]==o.data[l]||a.attrs[l]&&i.push(a.attrs[l]);async.eachSeries(i,function(e,s){var i=o.data[e.get("fcode")],a=n.ext[e.get("fid")];if(a&&i){var l=[],f=[];async.series([function(e){t.execute({session:r,sql:{select:[{a:"npp"},"npp",{a:"subject"},"subject",{a:"object"},"object",{a:"read"},"read",{a:"update"},"update",{a:"delete"},"delete"],from:[{a:"ose.object"}],where:[{a:"object"},"in",[o.get("id"),",",i]]},success:function(t){for(var s=0;s<t.length;s++){var r={npp:t.get(s,"npp"),subject:t.get(s,"subject"),read:t.get(s,"read"),update:t.get(s,"update"),delete_:t.get(s,"delete")};t.get(s,"object")==i?l.push(r):f.push(r)}e()}})},function(e){a.take?async.eachSeries(l,function(e,s){for(var n=0,i=0;i<f.length;i++)if(f[i].subject==e.subject&&f[i].read==e.read&&f[i].update==e.update&&f[i].delete_==e.delete_){n=1;break}n?s():(t.un("aftercreateobject",d),t.un("beforecreateobject",u),t.createObject({session:r,classId:c,success:function(n){t.on("aftercreateobject",d),t.on("beforecreateobject",u);var i=n.object;i.set("object",o.get("id")),i.set("subject",e.subject),i.set("read",e.read),i.set("update",e.update),i.set("delete",e.delete_),t.un("beforecommitobject",p),i.commit({session:r,success:function(){t.on("beforecommitobject",p),s()}})}}))},function(t){e()}):e()},function(e){a.give?async.eachSeries(f,function(e,s){for(var n=0,o=0;o<l.length;o++)if(l[o].subject==e.subject&&l[o].read==e.read&&l[o].update==e.update&&l[o].delete_==e.delete_){n=1;break}n?s():(t.un("aftercreateobject",d),t.un("beforecreateobject",u),t.createObject({session:r,classId:c,success:function(n){t.on("aftercreateobject",d),t.on("beforecreateobject",u);var o=n.object;o.set("object",i),o.set("subject",e.subject),o.set("read",e.read),o.set("update",e.update),o.set("delete",e.delete_),t.un("beforecommitobject",p),o.commit({session:r,success:function(){t.on("beforecommitobject",p),s()}})}}))},function(t){e()}):e()}],function(e,t){s()})}else s()},function(e){s()})};var p=function(e){var s=e.success,o=e.session,i=e.object;async.series([function(e){!o||r.subject.isAdmin(o.username)?e("ok"):e()},function(e){i.get("fclass_id")==c?i.get("object")?(t.un("aftergetobject",g),t.getObject({session:o,id:i.get("object"),success:function(s){t.on("aftergetobject",g);var n=s.object;n?r.subject.can({session:o,object:n,access:"update",success:function(t){e(t&&t.cancel?"cancel":"ok")}}):e("cancel")}})):e("cancel"):e()},function(e){f.indexOf(i.get("fclass_id"))>-1?e("cancel"):n.class_[i.get("fclass_id")]?r.subject.can({session:o,object:i,access:"update",success:function(t){e(t&&t.cancel?"cancel":"ok")}}):e("ok")}],function(e,t){"cancel"==e?s({cancel:1}):r.ext({object:i,session:o,success:s})})};t.on("beforecommitobject",p);var m=function(e){var t=e.success,s=e.session,o=e.object;return o&&s&&!r.subject.isAdmin(s.username)?f.indexOf(o.get("fclass_id"))>-1?void t({cancel:1}):n.class_[o.get("fclass_id")]?void r.subject.can({session:s,object:o,access:"delete",success:t}):void t():void t()};t.on("beforeremoveobject",m),t.on("generatequeryblock",function(e){var s=e.cls,o=e.objectField,i=e.session,a=(e.tables,e.where);e.alia;if(i&&!r.subject.isAdmin(i.username)&&n.class_[s.get("fid")]){a?a+=" and ":a=" where ";var c=i.roles.concat(i.userId),l=t.getClass("ose.object");a+="exists (\nselect fobject_id from "+l.toc+"\nwhere "+l.attrs.read.toc+" = 1 and "+l.attrs.subject.toc+" in ("+c.join(",")+") and\n("+l.attrs.class.toc+"="+s.get("fid")+" or "+o+"="+l.attrs.object.toc+")\n)",e.where=a}}),r.load({success:function(){r.loadIntervalId=setInterval(r.load,6e4),s()}})};projects.getClasses=function(e,t,s){"getClasses"==e.storageFn?(log.debug({cls:"projects",fn:"getClasses"}),projects.sendTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tclass",fields:["fid","fparent_id","fname","fcode","fdescription","fformat","fview_id","ftype","fsystem","fschema_id","frecord_id"]})):s()},projects.getClassAttrs=function(e,t,s){"getClassAttrs"==e.storageFn?(log.debug({cls:"projects",fn:"getClassAttrs"}),projects.sendTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tclass_attr",fields:["fid","fclass_id","fname","fcode","ftype_id","forder","fnot_null","fvalid_func","fformat_func","fdescription","fsecure","fmax_str","fmin_str","fmax_number","fmin_number","fmax_ts","fmin_ts","funique","fformat_number","fformat_ts"]})):s()},projects.getActions=function(e,t,s){"getActions"==e.storageFn?(log.debug({cls:"projects",fn:"getActions"}),projects.sendTableRecords({request:e,response:t,storageCode:e.storageCode,table:"taction",fields:["fid","fclass_id","fname","fcode","fdescription","forder","fbody","fconfirm","flayout"]})):s()},projects.getActionAttrs=function(e,t,s){"getActionAttrs"==e.storageFn?projects.send({request:e,response:t,msg:"{header: {error: ''}, data: []}"}):s()},projects.getViews=function(e,t,s){"getViews"==e.storageFn?(log.debug({cls:"projects",fn:"getViews"}),projects.sendTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tview",fields:["fid","fparent_id","fname","fcode","fdescription","flayout","fkey","fparent_key","fclass_id","funrelated","fquery","ftype","fsystem","fmaterialized","forder","fschema_id","frecord_id","ficon_cls"]})):s()},projects.getViewAttrs=function(e,t,s){"getViewAttrs"==e.storageFn?(log.debug({cls:"projects",fn:"getViewAttrs"}),projects.sendTableRecords({request:e,response:t,storageCode:e.storageCode,table:"tview_attr",fields:["fid","fview_id","fname","fcode","fclass_id","fclass_attr_id","fsubject_id","forder","fsort_kind","fsort_order","foperation","fvalue","farea","fcolumn_width","ftotal_type","fread_only","fgroup","fnot_null"]})):s()},projects.services.accountActivate=function(e,t,s){if(e.url.indexOf("/services")==-1||!e.query.account_activate)return void s();var r=e.query.account_activate,n=e.query.hash,o={id:"account_activate_"+r,username:"admin",userId:null},i=e.url.split("/");i=i[i.indexOf("projects")+1];var a=projects.storagePool[i],c={select:[{a:"id"},"id",{a:"email"},"email",{a:"password"},"password"],from:[{a:"subject.human"}],where:[{a:"id"},"=",r]};a.execute({session:o,sql:c,success:function(e){var s=e.result.rows;if(s.length){var i=s[0].email_,c=s[0].password_;c==n&&async.series([function(e){a.startTransaction({session:o,remoteAddr:"127.0.0.1",description:"account_activate_"+r,success:function(){e()},failure:function(t){e(t.error)}})},function(e){a.getObject({session:o,id:r,success:function(t){var s=t.object;s?(s.set("login",i),s.commit({session:o,success:function(){e()}})):e("no object")}})},function(e){a.commitTransaction({session:o,success:function(){e()},failure:function(t){e(t.error)}})}],function(e,s){e?a.rollbackTransaction({session:o,success:function(){t.send("<html><body>Извините. Не удалось активировать учетную запись.</body></html>")}}):t.send("<html><body>Ваша учетная запись активирована.</body></html>")})}else t.send("<html><body>Извините. Не удалось активировать учетную запись.</body></html>")}})},projects.services.restorePassword=function(e,t,s){if(e.url.indexOf("/services")==-1||!e.query.restore_password)return void s();var r=e.url.split("/");r=r[r.indexOf("projects")+1];var n=projects.storagePool[r],o=e.query.restore_password,i={select:[{a:"id"},"id",{a:"email"},"email",{a:"password"},"password"],from:[{a:"subject.human"}],where:[{a:"email"},"=",o]};n.execute({sql:i,success:function(s){var r=s.result.rows;if(r.length){var n=r[0].id_,i=r[0].password_,a=e.query.host,c=e.query.sender,l=e.query.port,f=e.query.storage,u="http://"+a+":"+l+"/projects/"+f+"/services?reset_password="+n+"&hash="+i+"&host="+a;mailSender.send({to:o,from:c,subject:"Восстановление пароля "+a,message:"Для получения нового пароля перейдите по ссылке <a target='_blank' href='"+u+"'>"+u+"</a>",success:function(){t.send("success")},failure:function(e){t.send("error")}})}else t.send("error")}})},projects.services.resetPassword=function(e,t,s){if(e.url.indexOf("/services")==-1||!e.query.reset_password)return void s();var r=e.url.split("/");r=r[r.indexOf("projects")+1];var n=projects.storagePool[r],o="<html><body>Извините. Не удалось получить новый пароль.</body></html>",i=e.query.reset_password,a=e.query.host,c=e.query.hash,l={id:"reset_password_"+i,username:"admin",userId:null},f={select:[{a:"id"},"id",{a:"email"},"email",{a:"password"},"password"],from:[{a:"subject.human"}],where:[{a:"id"},"=",i]};n.execute({session:l,sql:f,success:function(e){var s=e.result.rows;if(s.length){var r=s[0].password_;if(c==r){var f=s[0].email_,u=String(common.randomInt(1e6,9e6));async.series([function(e){n.startTransaction({session:l,remoteAddr:"127.0.0.1",description:"reset_password_"+i,success:function(){e()},failure:function(t){e(t.error)}})},function(e){n.getObject({session:l,id:i,success:function(t){var s=t.object;s.set("password",sha.hex_sha1(u)),s.commit({session:l,success:function(){e()}})}})},function(e){n.commitTransaction({session:l,success:function(){e()},failure:function(t){e(t.error)}})}],function(e,s){e?n.rollbackTransaction({session:l,success:function(){t.send(o)}}):(o="<html><body>Ваш новый пароль: "+u+"</body></html>",t.send(o),mailSender.send({to:f,from:"noreply@"+a,subject:"Изменение пароля "+a,message:"Ваш новый пароль: "+u}))})}}else t.send(o)}})},projects.gate1c=function(e,t,s){if(e.url.indexOf("/1c?")>-1){var r=JSON.parse(e.body),n=http.request({hostname:r.host,port:r.port,path:r.path,method:"POST",headers:{"Content-Type":"text/xml; charset=utf-8","Content-Length":Buffer.byteLength(e.body,"utf8")}},function(e){e.setEncoding("utf8");var s;e.on("error",function(e){t.send("{error: '"+e+"'}")}),e.on("data",function(e){s?s+=e:s=e}),e.on("end",function(e){t.send(s)})});n.on("error",function(e){t.send("{error: '"+e+"'}")}),n.end(e.body)}else s()},this.common=common,this.config=config,this.Export=Export,this.Import=Import,this.mailSender=mailSender,this.meta=meta,this.mimetypes=mimetypes,this.projects=projects,this.Query=Query,this.server=server,this.sha=sha,this.Storage=Storage,this.db=db,this.xmlss=xmlss,this.Dbf=Dbf,this.async=async,this.sha=sha,this.tm=tm,this.log=log,this.modules={async:async,pg:pg,util:util,fs:fs,http:http,url:url,redis:redis,pg:pg,express:express,nodemailer:nodemailer,simplesmtp:simplesmtp,_:_}};