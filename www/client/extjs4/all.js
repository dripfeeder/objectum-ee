function hex_sha1(e){return binb2hex(core_sha1(str2binb(e),e.length*chrsz))}function b64_sha1(e){return binb2b64(core_sha1(str2binb(e),e.length*chrsz))}function str_sha1(e){return binb2str(core_sha1(str2binb(e),e.length*chrsz))}function hex_hmac_sha1(e,t){return binb2hex(core_hmac_sha1(e,t))}function b64_hmac_sha1(e,t){return binb2b64(core_hmac_sha1(e,t))}function str_hmac_sha1(e,t){return binb2str(core_hmac_sha1(e,t))}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc")}function core_sha1(e,t){e[t>>5]|=128<<24-t%32,e[(t+64>>9<<4)+15]=t;for(var s=Array(80),n=1732584193,r=-271733879,i=-1732584194,a=271733878,o=-1009589776,l=0;l<e.length;l+=16){for(var c=n,d=r,u=i,f=a,g=o,m=0;m<80;m++){m<16?s[m]=e[l+m]:s[m]=rol(s[m-3]^s[m-8]^s[m-14]^s[m-16],1);var p=safe_add(safe_add(rol(n,5),sha1_ft(m,r,i,a)),safe_add(safe_add(o,s[m]),sha1_kt(m)));o=a,a=i,i=rol(r,30),r=n,n=p}n=safe_add(n,c),r=safe_add(r,d),i=safe_add(i,u),a=safe_add(a,f),o=safe_add(o,g)}return Array(n,r,i,a,o)}function sha1_ft(e,t,s,n){return e<20?t&s|~t&n:e<40?t^s^n:e<60?t&s|t&n|s&n:t^s^n}function sha1_kt(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function core_hmac_sha1(e,t){var s=str2binb(e);s.length>16&&(s=core_sha1(s,e.length*chrsz));for(var n=Array(16),r=Array(16),i=0;i<16;i++)n[i]=909522486^s[i],r[i]=1549556828^s[i];var a=core_sha1(n.concat(str2binb(t)),512+t.length*chrsz);return core_sha1(r.concat(a),672)}function safe_add(e,t){var s=(65535&e)+(65535&t),n=(e>>16)+(t>>16)+(s>>16);return n<<16|65535&s}function rol(e,t){return e<<t|e>>>32-t}function str2binb(e){for(var t=Array(),s=(1<<chrsz)-1,n=0;n<e.length*chrsz;n+=chrsz)t[n>>5]|=(e.charCodeAt(n/chrsz)&s)<<32-chrsz-n%32;return t}function binb2str(e){for(var t="",s=(1<<chrsz)-1,n=0;n<32*e.length;n+=chrsz)t+=String.fromCharCode(e[n>>5]>>>32-chrsz-n%32&s);return t}function binb2hex(e){for(var t=hexcase?"0123456789ABCDEF":"0123456789abcdef",s="",n=0;n<4*e.length;n++)s+=t.charAt(e[n>>2]>>8*(3-n%4)+4&15)+t.charAt(e[n>>2]>>8*(3-n%4)&15);return s}function binb2b64(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s="",n=0;n<4*e.length;n+=3)for(var r=(e[n>>2]>>8*(3-n%4)&255)<<16|(e[n+1>>2]>>8*(3-(n+1)%4)&255)<<8|e[n+2>>2]>>8*(3-(n+2)%4)&255,i=0;i<4;i++)s+=8*n+6*i>32*e.length?b64pad:t.charAt(r>>6*(3-i)&63);return s}!function(){function e(e){var s=!1;return function(){if(s)throw new Error("Callback was already called.");s=!0,e.apply(t,arguments)}}var t,s,n={};t=this,null!=t&&(s=t.async),n.noConflict=function(){return t.async=s,n};var r=function(e,t){if(e.forEach)return e.forEach(t);for(var s=0;s<e.length;s+=1)t(e[s],s,e)},i=function(e,t){if(e.map)return e.map(t);var s=[];return r(e,function(e,n,r){s.push(t(e,n,r))}),s},a=function(e,t,s){return e.reduce?e.reduce(t,s):(r(e,function(e,n,r){s=t(s,e,n,r)}),s)},o=function(e){if(Object.keys)return Object.keys(e);var t=[];for(var s in e)e.hasOwnProperty(s)&&t.push(s);return t};"undefined"!=typeof process&&process.nextTick?(n.nextTick=process.nextTick,"undefined"!=typeof setImmediate?n.setImmediate=setImmediate:n.setImmediate=n.nextTick):"function"==typeof setImmediate?(n.setImmediate=setImmediate,n.nextTick=setImmediate):(n.setImmediate=n.nextTick,n.nextTick=function(e){setTimeout(e,0)}),n.each=function(t,s,n){if(n=n||function(){},!t.length)return n();var i=0;r(t,function(r){s(r,e(function(e){e?(n(e),n=function(){}):(i+=1,i>=t.length&&n(null))}))})},n.forEach=n.each,n.eachSeries=function(e,t,s){if(s=s||function(){},!e.length)return s();var n=0,r=function(){t(e[n],function(t){t?(s(t),s=function(){}):(n+=1,n>=e.length?s(null):r())})};r()},n.forEachSeries=n.eachSeries,n.eachLimit=function(e,t,s,n){var r=l(t);r.apply(null,[e,s,n])},n.forEachLimit=n.eachLimit;var l=function(e){return function(t,s,n){if(n=n||function(){},!t.length||e<=0)return n();var r=0,i=0,a=0;!function o(){if(r>=t.length)return n();for(;a<e&&i<t.length;)i+=1,a+=1,s(t[i-1],function(e){e?(n(e),n=function(){}):(r+=1,a-=1,r>=t.length?n():o())})}()}},c=function(e){return function(){var t=Array.prototype.slice.call(arguments);return e.apply(null,[n.each].concat(t))}},d=function(e,t){return function(){var s=Array.prototype.slice.call(arguments);return t.apply(null,[l(e)].concat(s))}},u=function(e){return function(){var t=Array.prototype.slice.call(arguments);return e.apply(null,[n.eachSeries].concat(t))}},f=function(e,t,s,n){var r=[];t=i(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){s(e.value,function(s,n){r[e.index]=n,t(s)})},function(e){n(e,r)})};n.map=c(f),n.mapSeries=u(f),n.mapLimit=function(e,t,s,n){return g(t)(e,s,n)};var g=function(e){return d(e,f)};n.reduce=function(e,t,s,r){n.eachSeries(e,function(e,n){s(t,e,function(e,s){t=s,n(e)})},function(e){r(e,t)})},n.inject=n.reduce,n.foldl=n.reduce,n.reduceRight=function(e,t,s,r){var a=i(e,function(e){return e}).reverse();n.reduce(a,t,s,r)},n.foldr=n.reduceRight;var m=function(e,t,s,n){var r=[];t=i(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){s(e.value,function(s){s&&r.push(e),t()})},function(e){n(i(r.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};n.filter=c(m),n.filterSeries=u(m),n.select=n.filter,n.selectSeries=n.filterSeries;var p=function(e,t,s,n){var r=[];t=i(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){s(e.value,function(s){s||r.push(e),t()})},function(e){n(i(r.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};n.reject=c(p),n.rejectSeries=u(p);var h=function(e,t,s,n){e(t,function(e,t){s(e,function(s){s?(n(e),n=function(){}):t()})},function(e){n()})};n.detect=c(h),n.detectSeries=u(h),n.some=function(e,t,s){n.each(e,function(e,n){t(e,function(e){e&&(s(!0),s=function(){}),n()})},function(e){s(!1)})},n.any=n.some,n.every=function(e,t,s){n.each(e,function(e,n){t(e,function(e){e||(s(!1),s=function(){}),n()})},function(e){s(!0)})},n.all=n.every,n.sortBy=function(e,t,s){n.map(e,function(e,s){t(e,function(t,n){t?s(t):s(null,{value:e,criteria:n})})},function(e,t){if(e)return s(e);var n=function(e,t){var s=e.criteria,n=t.criteria;return s<n?-1:s>n?1:0};s(null,i(t.sort(n),function(e){return e.value}))})},n.auto=function(e,t){t=t||function(){};var s=o(e);if(!s.length)return t(null);var i={},l=[],c=function(e){l.unshift(e)},d=function(e){for(var t=0;t<l.length;t+=1)if(l[t]===e)return void l.splice(t,1)},u=function(){r(l.slice(0),function(e){e()})};c(function(){o(i).length===s.length&&(t(null,i),t=function(){})}),r(s,function(s){var l=e[s]instanceof Function?[e[s]]:e[s],f=function(e){var a=Array.prototype.slice.call(arguments,1);if(a.length<=1&&(a=a[0]),e){var l={};r(o(i),function(e){l[e]=i[e]}),l[s]=a,t(e,l),t=function(){}}else i[s]=a,n.setImmediate(u)},g=l.slice(0,Math.abs(l.length-1))||[],m=function(){return a(g,function(e,t){return e&&i.hasOwnProperty(t)},!0)&&!i.hasOwnProperty(s)};if(m())l[l.length-1](f,i);else{var p=function(){m()&&(d(p),l[l.length-1](f,i))};c(p)}})},n.waterfall=function(e,t){if(t=t||function(){},e.constructor!==Array){var s=new Error("First argument to waterfall must be an array of functions");return t(s)}if(!e.length)return t();var r=function(e){return function(s){if(s)t.apply(null,arguments),t=function(){};else{var i=Array.prototype.slice.call(arguments,1),a=e.next();a?i.push(r(a)):i.push(t),n.setImmediate(function(){e.apply(null,i)})}}};r(n.iterator(e))()};var v=function(e,t,s){if(s=s||function(){},t.constructor===Array)e.map(t,function(e,t){e&&e(function(e){var s=Array.prototype.slice.call(arguments,1);s.length<=1&&(s=s[0]),t.call(null,e,s)})},s);else{var n={};e.each(o(t),function(e,s){t[e](function(t){var r=Array.prototype.slice.call(arguments,1);r.length<=1&&(r=r[0]),n[e]=r,s(t)})},function(e){s(e,n)})}};n.parallel=function(e,t){v({map:n.map,each:n.each},e,t)},n.parallelLimit=function(e,t,s){v({map:g(t),each:l(t)},e,s)},n.series=function(e,t){if(t=t||function(){},e.constructor===Array)n.mapSeries(e,function(e,t){e&&e(function(e){var s=Array.prototype.slice.call(arguments,1);s.length<=1&&(s=s[0]),t.call(null,e,s)})},t);else{var s={};n.eachSeries(o(e),function(t,n){e[t](function(e){var r=Array.prototype.slice.call(arguments,1);r.length<=1&&(r=r[0]),s[t]=r,n(e)})},function(e){t(e,s)})}},n.iterator=function(e){var t=function(s){var n=function(){return e.length&&e[s].apply(null,arguments),n.next()};return n.next=function(){return s<e.length-1?t(s+1):null},n};return t(0)},n.apply=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t.concat(Array.prototype.slice.call(arguments)))}};var b=function(e,t,s,n){var r=[];e(t,function(e,t){s(e,function(e,s){r=r.concat(s||[]),t(e)})},function(e){n(e,r)})};n.concat=c(b),n.concatSeries=u(b),n.whilst=function(e,t,s){e()?t(function(r){return r?s(r):void n.whilst(e,t,s)}):s()},n.doWhilst=function(e,t,s){e(function(r){return r?s(r):void(t()?n.doWhilst(e,t,s):s())})},n.until=function(e,t,s){e()?s():t(function(r){return r?s(r):void n.until(e,t,s)})},n.doUntil=function(e,t,s){e(function(r){return r?s(r):void(t()?s():n.doUntil(e,t,s))})},n.queue=function(t,s){function i(e,t,i,a){t.constructor!==Array&&(t=[t]),r(t,function(t){var r={data:t,callback:"function"==typeof a?a:null};i?e.tasks.unshift(r):e.tasks.push(r),e.saturated&&e.tasks.length===s&&e.saturated(),n.setImmediate(e.process)})}void 0===s&&(s=1);var a=0,o={tasks:[],concurrency:s,saturated:null,empty:null,drain:null,push:function(e,t){i(o,e,!1,t)},unshift:function(e,t){i(o,e,!0,t)},process:function(){if(a<o.concurrency&&o.tasks.length){var s=o.tasks.shift();o.empty&&0===o.tasks.length&&o.empty(),a+=1;var n=function(){a-=1,s.callback&&s.callback.apply(s,arguments),o.drain&&o.tasks.length+a===0&&o.drain(),o.process()},r=e(n);t(s.data,r)}},length:function(){return o.tasks.length},running:function(){return a}};return o},n.cargo=function(e,t){var s=!1,a=[],o={tasks:a,payload:t,saturated:null,empty:null,drain:null,push:function(e,s){e.constructor!==Array&&(e=[e]),r(e,function(e){a.push({data:e,callback:"function"==typeof s?s:null}),o.saturated&&a.length===t&&o.saturated()}),n.setImmediate(o.process)},process:function n(){if(!s){if(0===a.length)return void(o.drain&&o.drain());var l="number"==typeof t?a.splice(0,t):a.splice(0),c=i(l,function(e){return e.data});o.empty&&o.empty(),s=!0,e(c,function(){s=!1;var e=arguments;r(l,function(t){t.callback&&t.callback.apply(null,e)}),n()})}},length:function(){return a.length},running:function(){return s}};return o};var y=function(e){return function(t){var s=Array.prototype.slice.call(arguments,1);t.apply(null,s.concat([function(t){var s=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(t?console.error&&console.error(t):console[e]&&r(s,function(t){console[e](t)}))}]))}};n.log=y("log"),n.dir=y("dir"),n.memoize=function(e,t){var s={},n={};t=t||function(e){return e};var r=function(){var r=Array.prototype.slice.call(arguments),i=r.pop(),a=t.apply(null,r);a in s?i.apply(null,s[a]):a in n?n[a].push(i):(n[a]=[i],e.apply(null,r.concat([function(){s[a]=arguments;var e=n[a];delete n[a];for(var t=0,r=e.length;t<r;t++)e[t].apply(null,arguments)}])))};return r.memo=s,r.unmemoized=e,r},n.unmemoize=function(e){return function(){return(e.unmemoized||e).apply(null,arguments)}},n.times=function(e,t,s){for(var r=[],i=0;i<e;i++)r.push(i);return n.map(r,t,s)},n.timesSeries=function(e,t,s){for(var r=[],i=0;i<e;i++)r.push(i);return n.mapSeries(r,t,s)},n.compose=function(){var e=Array.prototype.reverse.call(arguments);return function(){var t=this,s=Array.prototype.slice.call(arguments),r=s.pop();n.reduce(e,s,function(e,s,n){s.apply(t,e.concat([function(){var e=arguments[0],t=Array.prototype.slice.call(arguments,1);n(e,t)}]))},function(e,s){r.apply(t,[e].concat(s))})}};var w=function(e,t){var s=function(){var s=this,n=Array.prototype.slice.call(arguments),r=n.pop();return e(t,function(e,t){e.apply(s,n.concat([t]))},r)};if(arguments.length>2){var n=Array.prototype.slice.call(arguments,2);return s.apply(this,n)}return s};n.applyEach=c(w),n.applyEachSeries=u(w),n.forever=function(e,t){function s(n){if(n){if(t)return t(n);throw n}e(s)}s()},"undefined"!=typeof define&&define.amd?define([],function(){return n}):"undefined"!=typeof module&&module.exports?module.exports=n:t.async=n}();var hexcase=1,b64pad="",chrsz=8;if(function(){function e(e){function t(t,s,n,r,i,a){for(;i>=0&&i<a;i+=e){var o=r?r[i]:i;n=s(n,t[o],o,t)}return n}return function(s,n,r,i){n=b(n,i,4);var a=!C(s)&&v.keys(s),o=(a||s).length,l=e>0?0:o-1;return arguments.length<3&&(r=s[a?a[l]:l],l+=e),t(s,n,r,a,l,o)}}function t(e){return function(t,s,n){s=y(s,n);for(var r=null!=t&&t.length,i=e>0?0:r-1;i>=0&&i<r;i+=e)if(s(t[i],i,t))return i;return-1}}function s(e,t){var s=E.length,n=e.constructor,r=v.isFunction(n)&&n.prototype||a,i="constructor";for(v.has(e,i)&&!v.contains(t,i)&&t.push(i);s--;)i=E[s],i in e&&e[i]!==r[i]&&!v.contains(t,i)&&t.push(i)}var n=this,r=n._,i=Array.prototype,a=Object.prototype,o=Function.prototype,l=i.push,c=i.slice,d=a.toString,u=a.hasOwnProperty,f=Array.isArray,g=Object.keys,m=o.bind,p=Object.create,h=function(){},v=function(e){return e instanceof v?e:this instanceof v?void(this._wrapped=e):new v(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=v),exports._=v):n._=v,v.VERSION="1.8.2";var b=function(e,t,s){if(void 0===t)return e;switch(null==s?3:s){case 1:return function(s){return e.call(t,s)};case 2:return function(s,n){return e.call(t,s,n)};case 3:return function(s,n,r){return e.call(t,s,n,r)};case 4:return function(s,n,r,i){return e.call(t,s,n,r,i)}}return function(){return e.apply(t,arguments)}},y=function(e,t,s){return null==e?v.identity:v.isFunction(e)?b(e,t,s):v.isObject(e)?v.matcher(e):v.property(e)};v.iteratee=function(e,t){return y(e,t,1/0)};var w=function(e,t){return function(s){var n=arguments.length;if(n<2||null==s)return s;for(var r=1;r<n;r++)for(var i=arguments[r],a=e(i),o=a.length,l=0;l<o;l++){var c=a[l];t&&void 0!==s[c]||(s[c]=i[c])}return s}},x=function(e){if(!v.isObject(e))return{};if(p)return p(e);h.prototype=e;var t=new h;return h.prototype=null,t},_=Math.pow(2,53)-1,C=function(e){var t=e&&e.length;return"number"==typeof t&&t>=0&&t<=_};v.each=v.forEach=function(e,t,s){t=b(t,s);var n,r;if(C(e))for(n=0,r=e.length;n<r;n++)t(e[n],n,e);else{var i=v.keys(e);for(n=0,r=i.length;n<r;n++)t(e[i[n]],i[n],e)}return e},v.map=v.collect=function(e,t,s){t=y(t,s);for(var n=!C(e)&&v.keys(e),r=(n||e).length,i=Array(r),a=0;a<r;a++){var o=n?n[a]:a;i[a]=t(e[o],o,e)}return i},v.reduce=v.foldl=v.inject=e(1),v.reduceRight=v.foldr=e(-1),v.find=v.detect=function(e,t,s){var n;if(n=C(e)?v.findIndex(e,t,s):v.findKey(e,t,s),void 0!==n&&n!==-1)return e[n]},v.filter=v.select=function(e,t,s){var n=[];return t=y(t,s),v.each(e,function(e,s,r){t(e,s,r)&&n.push(e)}),n},v.reject=function(e,t,s){return v.filter(e,v.negate(y(t)),s)},v.every=v.all=function(e,t,s){t=y(t,s);for(var n=!C(e)&&v.keys(e),r=(n||e).length,i=0;i<r;i++){var a=n?n[i]:i;if(!t(e[a],a,e))return!1}return!0},v.some=v.any=function(e,t,s){t=y(t,s);for(var n=!C(e)&&v.keys(e),r=(n||e).length,i=0;i<r;i++){var a=n?n[i]:i;if(t(e[a],a,e))return!0}return!1},v.contains=v.includes=v.include=function(e,t,s){return C(e)||(e=v.values(e)),v.indexOf(e,t,"number"==typeof s&&s)>=0},v.invoke=function(e,t){var s=c.call(arguments,2),n=v.isFunction(t);return v.map(e,function(e){var r=n?t:e[t];return null==r?r:r.apply(e,s)})},v.pluck=function(e,t){return v.map(e,v.property(t))},v.where=function(e,t){return v.filter(e,v.matcher(t))},v.findWhere=function(e,t){return v.find(e,v.matcher(t))},v.max=function(e,t,s){var n,r,i=-(1/0),a=-(1/0);if(null==t&&null!=e){e=C(e)?e:v.values(e);for(var o=0,l=e.length;o<l;o++)n=e[o],n>i&&(i=n)}else t=y(t,s),v.each(e,function(e,s,n){r=t(e,s,n),(r>a||r===-(1/0)&&i===-(1/0))&&(i=e,a=r)});return i},v.min=function(e,t,s){var n,r,i=1/0,a=1/0;if(null==t&&null!=e){e=C(e)?e:v.values(e);for(var o=0,l=e.length;o<l;o++)n=e[o],n<i&&(i=n)}else t=y(t,s),v.each(e,function(e,s,n){r=t(e,s,n),(r<a||r===1/0&&i===1/0)&&(i=e,a=r)});return i},v.shuffle=function(e){for(var t,s=C(e)?e:v.values(e),n=s.length,r=Array(n),i=0;i<n;i++)t=v.random(0,i),t!==i&&(r[i]=r[t]),r[t]=s[i];return r},v.sample=function(e,t,s){return null==t||s?(C(e)||(e=v.values(e)),e[v.random(e.length-1)]):v.shuffle(e).slice(0,Math.max(0,t))},v.sortBy=function(e,t,s){return t=y(t,s),v.pluck(v.map(e,function(e,s,n){return{value:e,index:s,criteria:t(e,s,n)}}).sort(function(e,t){var s=e.criteria,n=t.criteria;if(s!==n){if(s>n||void 0===s)return 1;if(s<n||void 0===n)return-1}return e.index-t.index}),"value")};var $=function(e){return function(t,s,n){var r={};return s=y(s,n),v.each(t,function(n,i){var a=s(n,i,t);e(r,n,a)}),r}};v.groupBy=$(function(e,t,s){v.has(e,s)?e[s].push(t):e[s]=[t]}),v.indexBy=$(function(e,t,s){e[s]=t}),v.countBy=$(function(e,t,s){v.has(e,s)?e[s]++:e[s]=1}),v.toArray=function(e){return e?v.isArray(e)?c.call(e):C(e)?v.map(e,v.identity):v.values(e):[]},v.size=function(e){return null==e?0:C(e)?e.length:v.keys(e).length},v.partition=function(e,t,s){t=y(t,s);var n=[],r=[];return v.each(e,function(e,s,i){(t(e,s,i)?n:r).push(e)}),[n,r]},v.first=v.head=v.take=function(e,t,s){if(null!=e)return null==t||s?e[0]:v.initial(e,e.length-t)},v.initial=function(e,t,s){return c.call(e,0,Math.max(0,e.length-(null==t||s?1:t)))},v.last=function(e,t,s){if(null!=e)return null==t||s?e[e.length-1]:v.rest(e,Math.max(0,e.length-t))},v.rest=v.tail=v.drop=function(e,t,s){return c.call(e,null==t||s?1:t)},v.compact=function(e){return v.filter(e,v.identity)};var j=function(e,t,s,n){for(var r=[],i=0,a=n||0,o=e&&e.length;a<o;a++){var l=e[a];if(C(l)&&(v.isArray(l)||v.isArguments(l))){t||(l=j(l,t,s));var c=0,d=l.length;for(r.length+=d;c<d;)r[i++]=l[c++]}else s||(r[i++]=l)}return r};v.flatten=function(e,t){return j(e,t,!1)},v.without=function(e){return v.difference(e,c.call(arguments,1))},v.uniq=v.unique=function(e,t,s,n){if(null==e)return[];v.isBoolean(t)||(n=s,s=t,t=!1),null!=s&&(s=y(s,n));for(var r=[],i=[],a=0,o=e.length;a<o;a++){var l=e[a],c=s?s(l,a,e):l;t?(a&&i===c||r.push(l),i=c):s?v.contains(i,c)||(i.push(c),r.push(l)):v.contains(r,l)||r.push(l)}return r},v.union=function(){return v.uniq(j(arguments,!0,!0))},v.intersection=function(e){if(null==e)return[];for(var t=[],s=arguments.length,n=0,r=e.length;n<r;n++){var i=e[n];if(!v.contains(t,i)){for(var a=1;a<s&&v.contains(arguments[a],i);a++);a===s&&t.push(i)}}return t},v.difference=function(e){var t=j(arguments,!0,!0,1);return v.filter(e,function(e){return!v.contains(t,e)})},v.zip=function(){return v.unzip(arguments)},v.unzip=function(e){for(var t=e&&v.max(e,"length").length||0,s=Array(t),n=0;n<t;n++)s[n]=v.pluck(e,n);return s},v.object=function(e,t){for(var s={},n=0,r=e&&e.length;n<r;n++)t?s[e[n]]=t[n]:s[e[n][0]]=e[n][1];return s},v.indexOf=function(e,t,s){var n=0,r=e&&e.length;if("number"==typeof s)n=s<0?Math.max(0,r+s):s;else if(s&&r)return n=v.sortedIndex(e,t),e[n]===t?n:-1;if(t!==t)return v.findIndex(c.call(e,n),v.isNaN);for(;n<r;n++)if(e[n]===t)return n;return-1},v.lastIndexOf=function(e,t,s){var n=e?e.length:0;if("number"==typeof s&&(n=s<0?n+s+1:Math.min(n,s+1)),t!==t)return v.findLastIndex(c.call(e,0,n),v.isNaN);for(;--n>=0;)if(e[n]===t)return n;return-1},v.findIndex=t(1),v.findLastIndex=t(-1),v.sortedIndex=function(e,t,s,n){s=y(s,n,1);for(var r=s(t),i=0,a=e.length;i<a;){var o=Math.floor((i+a)/2);s(e[o])<r?i=o+1:a=o}return i},v.range=function(e,t,s){arguments.length<=1&&(t=e||0,e=0),s=s||1;for(var n=Math.max(Math.ceil((t-e)/s),0),r=Array(n),i=0;i<n;i++,e+=s)r[i]=e;return r};var S=function(e,t,s,n,r){if(!(n instanceof t))return e.apply(s,r);var i=x(e.prototype),a=e.apply(i,r);return v.isObject(a)?a:i};v.bind=function(e,t){if(m&&e.bind===m)return m.apply(e,c.call(arguments,1));if(!v.isFunction(e))throw new TypeError("Bind must be called on a function");var s=c.call(arguments,2),n=function(){return S(e,n,t,this,s.concat(c.call(arguments)))};return n},v.partial=function(e){var t=c.call(arguments,1),s=function(){for(var n=0,r=t.length,i=Array(r),a=0;a<r;a++)i[a]=t[a]===v?arguments[n++]:t[a];for(;n<arguments.length;)i.push(arguments[n++]);return S(e,s,this,this,i)};return s},v.bindAll=function(e){var t,s,n=arguments.length;if(n<=1)throw new Error("bindAll must be passed function names");for(t=1;t<n;t++)s=arguments[t],e[s]=v.bind(e[s],e);return e},v.memoize=function(e,t){var s=function(n){var r=s.cache,i=""+(t?t.apply(this,arguments):n);return v.has(r,i)||(r[i]=e.apply(this,arguments)),r[i]};return s.cache={},s},v.delay=function(e,t){var s=c.call(arguments,2);return setTimeout(function(){return e.apply(null,s)},t)},v.defer=v.partial(v.delay,v,1),v.throttle=function(e,t,s){var n,r,i,a=null,o=0;s||(s={});var l=function(){o=s.leading===!1?0:v.now(),a=null,i=e.apply(n,r),a||(n=r=null)};return function(){var c=v.now();o||s.leading!==!1||(o=c);var d=t-(c-o);return n=this,r=arguments,d<=0||d>t?(a&&(clearTimeout(a),a=null),o=c,i=e.apply(n,r),a||(n=r=null)):a||s.trailing===!1||(a=setTimeout(l,d)),i}},v.debounce=function(e,t,s){var n,r,i,a,o,l=function(){var c=v.now()-a;c<t&&c>=0?n=setTimeout(l,t-c):(n=null,s||(o=e.apply(i,r),n||(i=r=null)))};return function(){i=this,r=arguments,a=v.now();var c=s&&!n;return n||(n=setTimeout(l,t)),c&&(o=e.apply(i,r),i=r=null),o}},v.wrap=function(e,t){return v.partial(t,e)},v.negate=function(e){return function(){return!e.apply(this,arguments)}},v.compose=function(){var e=arguments,t=e.length-1;return function(){for(var s=t,n=e[t].apply(this,arguments);s--;)n=e[s].call(this,n);return n}},v.after=function(e,t){return function(){if(--e<1)return t.apply(this,arguments)}},v.before=function(e,t){var s;return function(){return--e>0&&(s=t.apply(this,arguments)),e<=1&&(t=null),s}},v.once=v.partial(v.before,2);var A=!{toString:null}.propertyIsEnumerable("toString"),E=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];v.keys=function(e){if(!v.isObject(e))return[];if(g)return g(e);var t=[];for(var n in e)v.has(e,n)&&t.push(n);return A&&s(e,t),t},v.allKeys=function(e){if(!v.isObject(e))return[];var t=[];for(var n in e)t.push(n);return A&&s(e,t),t},v.values=function(e){for(var t=v.keys(e),s=t.length,n=Array(s),r=0;r<s;r++)n[r]=e[t[r]];return n},v.mapObject=function(e,t,s){t=y(t,s);for(var n,r=v.keys(e),i=r.length,a={},o=0;o<i;o++)n=r[o],a[n]=t(e[n],n,e);return a},v.pairs=function(e){for(var t=v.keys(e),s=t.length,n=Array(s),r=0;r<s;r++)n[r]=[t[r],e[t[r]]];return n},v.invert=function(e){for(var t={},s=v.keys(e),n=0,r=s.length;n<r;n++)t[e[s[n]]]=s[n];return t},v.functions=v.methods=function(e){var t=[];for(var s in e)v.isFunction(e[s])&&t.push(s);return t.sort()},v.extend=w(v.allKeys),v.extendOwn=v.assign=w(v.keys),v.findKey=function(e,t,s){t=y(t,s);for(var n,r=v.keys(e),i=0,a=r.length;i<a;i++)if(n=r[i],t(e[n],n,e))return n},v.pick=function(e,t,s){var n,r,i={},a=e;if(null==a)return i;v.isFunction(t)?(r=v.allKeys(a),n=b(t,s)):(r=j(arguments,!1,!1,1),n=function(e,t,s){return t in s},a=Object(a));for(var o=0,l=r.length;o<l;o++){var c=r[o],d=a[c];n(d,c,a)&&(i[c]=d)}return i},v.omit=function(e,t,s){if(v.isFunction(t))t=v.negate(t);else{var n=v.map(j(arguments,!1,!1,1),String);t=function(e,t){return!v.contains(n,t)}}return v.pick(e,t,s)},v.defaults=w(v.allKeys,!0),v.clone=function(e){return v.isObject(e)?v.isArray(e)?e.slice():v.extend({},e):e},v.tap=function(e,t){return t(e),e},v.isMatch=function(e,t){var s=v.keys(t),n=s.length;if(null==e)return!n;for(var r=Object(e),i=0;i<n;i++){var a=s[i];if(t[a]!==r[a]||!(a in r))return!1}return!0};var I=function(e,t,s,n){if(e===t)return 0!==e||1/e===1/t;if(null==e||null==t)return e===t;e instanceof v&&(e=e._wrapped),t instanceof v&&(t=t._wrapped);var r=d.call(e);if(r!==d.call(t))return!1;switch(r){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!==+e?+t!==+t:0===+e?1/+e===1/t:+e===+t;case"[object Date]":case"[object Boolean]":return+e===+t}var i="[object Array]"===r;if(!i){if("object"!=typeof e||"object"!=typeof t)return!1;var a=e.constructor,o=t.constructor;if(a!==o&&!(v.isFunction(a)&&a instanceof a&&v.isFunction(o)&&o instanceof o)&&"constructor"in e&&"constructor"in t)return!1}s=s||[],n=n||[];for(var l=s.length;l--;)if(s[l]===e)return n[l]===t;if(s.push(e),n.push(t),i){if(l=e.length,l!==t.length)return!1;for(;l--;)if(!I(e[l],t[l],s,n))return!1}else{var c,u=v.keys(e);if(l=u.length,v.keys(t).length!==l)return!1;for(;l--;)if(c=u[l],!v.has(t,c)||!I(e[c],t[c],s,n))return!1}return s.pop(),n.pop(),!0};v.isEqual=function(e,t){return I(e,t)},v.isEmpty=function(e){return null==e||(C(e)&&(v.isArray(e)||v.isString(e)||v.isArguments(e))?0===e.length:0===v.keys(e).length)},v.isElement=function(e){return!(!e||1!==e.nodeType)},v.isArray=f||function(e){return"[object Array]"===d.call(e)},v.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},v.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(e){v["is"+e]=function(t){return d.call(t)==="[object "+e+"]"}}),v.isArguments(arguments)||(v.isArguments=function(e){return v.has(e,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(v.isFunction=function(e){return"function"==typeof e||!1}),v.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},v.isNaN=function(e){return v.isNumber(e)&&e!==+e},v.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"===d.call(e)},v.isNull=function(e){return null===e},v.isUndefined=function(e){return void 0===e},v.has=function(e,t){return null!=e&&u.call(e,t)},v.noConflict=function(){return n._=r,this},v.identity=function(e){return e},v.constant=function(e){return function(){return e}},v.noop=function(){},v.property=function(e){return function(t){return null==t?void 0:t[e]}},v.propertyOf=function(e){return null==e?function(){}:function(t){return e[t]}},v.matcher=v.matches=function(e){return e=v.extendOwn({},e),function(t){return v.isMatch(t,e)}},v.times=function(e,t,s){var n=Array(Math.max(0,e));t=b(t,s,1);for(var r=0;r<e;r++)n[r]=t(r);return n},v.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))},v.now=Date.now||function(){return(new Date).getTime()};var q={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},V=v.invert(q),T=function(e){var t=function(t){return e[t]},s="(?:"+v.keys(e).join("|")+")",n=RegExp(s),r=RegExp(s,"g");return function(e){return e=null==e?"":""+e,n.test(e)?e.replace(r,t):e}};v.escape=T(q),v.unescape=T(V),v.result=function(e,t,s){var n=null==e?void 0:e[t];return void 0===n&&(n=s),v.isFunction(n)?n.call(e):n};var k=0;v.uniqueId=function(e){var t=++k+"";return e?e+t:t},v.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var O=/(.)^/,M={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},F=/\\|'|\r|\n|\u2028|\u2029/g,L=function(e){return"\\"+M[e]};v.template=function(e,t,s){!t&&s&&(t=s),t=v.defaults({},t,v.templateSettings);var n=RegExp([(t.escape||O).source,(t.interpolate||O).source,(t.evaluate||O).source].join("|")+"|$","g"),r=0,i="__p+='";e.replace(n,function(t,s,n,a,o){return i+=e.slice(r,o).replace(F,L),r=o+t.length,s?i+="'+\n((__t=("+s+"))==null?'':_.escape(__t))+\n'":n?i+="'+\n((__t=("+n+"))==null?'':__t)+\n'":a&&(i+="';\n"+a+"\n__p+='"),t}),i+="';\n",t.variable||(i="with(obj||{}){\n"+i+"}\n"),i="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+i+"return __p;\n";try{var a=new Function(t.variable||"obj","_",i)}catch(e){throw e.source=i,e}var o=function(e){return a.call(this,e,v)},l=t.variable||"obj";return o.source="function("+l+"){\n"+i+"}",o},v.chain=function(e){var t=v(e);return t._chain=!0,t};var R=function(e,t){return e._chain?v(t).chain():t};v.mixin=function(e){v.each(v.functions(e),function(t){var s=v[t]=e[t];v.prototype[t]=function(){var e=[this._wrapped];return l.apply(e,arguments),R(this,s.apply(v,e))}})},v.mixin(v),v.each(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=i[e];v.prototype[e]=function(){var s=this._wrapped;return t.apply(s,arguments),"shift"!==e&&"splice"!==e||0!==s.length||delete s[0],R(this,s)}}),v.each(["concat","join","slice"],function(e){var t=i[e];v.prototype[e]=function(){return R(this,t.apply(this._wrapped,arguments))}}),v.prototype.value=function(){return this._wrapped},v.prototype.valueOf=v.prototype.toJSON=v.prototype.value,v.prototype.toString=function(){return""+this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return v})}.call(this),function(e){var t="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;if("function"==typeof define&&define.amd)define(["underscore","jquery","exports"],function(s,n,r){t.Backbone=e(t,r,s,n)});else if("undefined"!=typeof exports){var s,n=require("underscore");try{s=require("jquery")}catch(e){}e(t,exports,n,s)}else t.Backbone=e(t,{},t._,t.jQuery||t.Zepto||t.ender||t.$)}(function(e,t,s,n){var r=e.Backbone,i=[].slice;t.VERSION="1.2.1",t.$=n,t.noConflict=function(){return e.Backbone=r,this},t.emulateHTTP=!1,t.emulateJSON=!1;var a=function(e,t,n){switch(e){case 1:return function(){return s[t](this[n])};case 2:return function(e){return s[t](this[n],e)};case 3:return function(e,r){return s[t](this[n],e,r)};case 4:return function(e,r,i){return s[t](this[n],e,r,i)};default:return function(){var e=i.call(arguments);return e.unshift(this[n]),s[t].apply(s,e)}}},o=function(e,t,n){s.each(t,function(t,r){s[r]&&(e.prototype[r]=a(t,r,n))})},l=t.Events={},c=/\s+/,d=function(e,t,n,r,i){var a,o=0;if(n&&"object"==typeof n){void 0!==r&&"context"in i&&void 0===i.context&&(i.context=r);for(a=s.keys(n);o<a.length;o++)t=e(t,a[o],n[a[o]],i)}else if(n&&c.test(n))for(a=n.split(c);o<a.length;o++)t=e(t,a[o],r,i);else t=e(t,n,r,i);return t};l.on=function(e,t,s){return u(this,e,t,s)};var u=function(e,t,s,n,r){if(e._events=d(f,e._events||{},t,s,{context:n,ctx:e,listening:r}),r){var i=e._listeners||(e._listeners={});i[r.id]=r}return e};l.listenTo=function(e,t,n){if(!e)return this;var r=e._listenId||(e._listenId=s.uniqueId("l")),i=this._listeningTo||(this._listeningTo={}),a=i[r];if(!a){var o=this._listenId||(this._listenId=s.uniqueId("l"));a=i[r]={obj:e,objId:r,id:o,listeningTo:i,count:0}}return u(e,t,n,this,a),this};var f=function(e,t,s,n){if(s){var r=e[t]||(e[t]=[]),i=n.context,a=n.ctx,o=n.listening;o&&o.count++,r.push({callback:s,context:i,ctx:i||a,listening:o})}return e};l.off=function(e,t,s){return this._events?(this._events=d(g,this._events,e,t,{context:s,listeners:this._listeners}),this):this},l.stopListening=function(e,t,n){var r=this._listeningTo;if(!r)return this;for(var i=e?[e._listenId]:s.keys(r),a=0;a<i.length;a++){var o=r[i[a]];if(!o)break;o.obj.off(t,n,this)}return s.isEmpty(r)&&(this._listeningTo=void 0),this};var g=function(e,t,n,r){if(e){var i,a=0,o=r.context,l=r.listeners;if(t||n||o){for(var c=t?[t]:s.keys(e);a<c.length;a++){t=c[a];var d=e[t];if(!d)break;for(var u=[],f=0;f<d.length;f++){var g=d[f];n&&n!==g.callback&&n!==g.callback._callback||o&&o!==g.context?u.push(g):(i=g.listening,i&&0===--i.count&&(delete l[i.id],delete i.listeningTo[i.objId]))}u.length?e[t]=u:delete e[t]}return s.size(e)?e:void 0}for(var m=s.keys(l);a<m.length;a++)i=l[m[a]],delete l[i.id],delete i.listeningTo[i.objId]}};l.once=function(e,t,n){var r=d(m,{},e,t,s.bind(this.off,this));return this.on(r,void 0,n)},l.listenToOnce=function(e,t,n){var r=d(m,{},t,n,s.bind(this.stopListening,this,e));return this.listenTo(e,r)};var m=function(e,t,n,r){if(n){var i=e[t]=s.once(function(){r(t,i),n.apply(this,arguments)});i._callback=n}return e};l.trigger=function(e){if(!this._events)return this;for(var t=Math.max(0,arguments.length-1),s=Array(t),n=0;n<t;n++)s[n]=arguments[n+1];return d(p,this._events,e,void 0,s),this};var p=function(e,t,s,n){if(e){var r=e[t],i=e.all;r&&i&&(i=i.slice()),r&&h(r,n),i&&h(i,[t].concat(n))}return e},h=function(e,t){var s,n=-1,r=e.length,i=t[0],a=t[1],o=t[2];switch(t.length){case 0:for(;++n<r;)(s=e[n]).callback.call(s.ctx);
return;case 1:for(;++n<r;)(s=e[n]).callback.call(s.ctx,i);return;case 2:for(;++n<r;)(s=e[n]).callback.call(s.ctx,i,a);return;case 3:for(;++n<r;)(s=e[n]).callback.call(s.ctx,i,a,o);return;default:for(;++n<r;)(s=e[n]).callback.apply(s.ctx,t);return}};l.bind=l.on,l.unbind=l.off,s.extend(t,l);var v=t.Model=function(e,t){var n=e||{};t||(t={}),this.cid=s.uniqueId(this.cidPrefix),this.attributes={},t.collection&&(this.collection=t.collection),t.parse&&(n=this.parse(n,t)||{}),n=s.defaults({},n,s.result(this,"defaults")),this.set(n,t),this.changed={},this.initialize.apply(this,arguments)};s.extend(v.prototype,l,{changed:null,validationError:null,idAttribute:"id",cidPrefix:"c",initialize:function(){},toJSON:function(e){return s.clone(this.attributes)},sync:function(){return t.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return s.escape(this.get(e))},has:function(e){return null!=this.get(e)},matches:function(e){return!!s.iteratee(e,this)(this.attributes)},set:function(e,t,n){if(null==e)return this;var r;if("object"==typeof e?(r=e,n=t):(r={})[e]=t,n||(n={}),!this._validate(r,n))return!1;var i=n.unset,a=n.silent,o=[],l=this._changing;this._changing=!0,l||(this._previousAttributes=s.clone(this.attributes),this.changed={});var c=this.attributes,d=this.changed,u=this._previousAttributes;this.idAttribute in r&&(this.id=r[this.idAttribute]);for(var f in r)t=r[f],s.isEqual(c[f],t)||o.push(f),s.isEqual(u[f],t)?delete d[f]:d[f]=t,i?delete c[f]:c[f]=t;if(!a){o.length&&(this._pending=n);for(var g=0;g<o.length;g++)this.trigger("change:"+o[g],this,c[o[g]],n)}if(l)return this;if(!a)for(;this._pending;)n=this._pending,this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},unset:function(e,t){return this.set(e,void 0,s.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var n in this.attributes)t[n]=void 0;return this.set(t,s.extend({},e,{unset:!0}))},hasChanged:function(e){return null==e?!s.isEmpty(this.changed):s.has(this.changed,e)},changedAttributes:function(e){if(!e)return!!this.hasChanged()&&s.clone(this.changed);var t=this._changing?this._previousAttributes:this.attributes,n={};for(var r in e){var i=e[r];s.isEqual(t[r],i)||(n[r]=i)}return!!s.size(n)&&n},previous:function(e){return null!=e&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return s.clone(this._previousAttributes)},fetch:function(e){e=s.extend({parse:!0},e);var t=this,n=e.success;return e.success=function(s){var r=e.parse?t.parse(s,e):s;return!!t.set(r,e)&&(n&&n.call(e.context,t,s,e),void t.trigger("sync",t,s,e))},N(this,e),this.sync("read",this,e)},save:function(e,t,n){var r;null==e||"object"==typeof e?(r=e,n=t):(r={})[e]=t,n=s.extend({validate:!0,parse:!0},n);var i=n.wait;if(r&&!i){if(!this.set(r,n))return!1}else if(!this._validate(r,n))return!1;var a=this,o=n.success,l=this.attributes;n.success=function(e){a.attributes=l;var t=n.parse?a.parse(e,n):e;return i&&(t=s.extend({},r,t)),!(t&&!a.set(t,n))&&(o&&o.call(n.context,a,e,n),void a.trigger("sync",a,e,n))},N(this,n),r&&i&&(this.attributes=s.extend({},l,r));var c=this.isNew()?"create":n.patch?"patch":"update";"patch"!==c||n.attrs||(n.attrs=r);var d=this.sync(c,this,n);return this.attributes=l,d},destroy:function(e){e=e?s.clone(e):{};var t=this,n=e.success,r=e.wait,i=function(){t.stopListening(),t.trigger("destroy",t,t.collection,e)};e.success=function(s){r&&i(),n&&n.call(e.context,t,s,e),t.isNew()||t.trigger("sync",t,s,e)};var a=!1;return this.isNew()?s.defer(e.success):(N(this,e),a=this.sync("delete",this,e)),r||i(),a},url:function(){var e=s.result(this,"urlRoot")||s.result(this.collection,"url")||R();if(this.isNew())return e;var t=this.get(this.idAttribute);return e.replace(/[^\/]$/,"$&/")+encodeURIComponent(t)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(e){return this._validate({},s.defaults({validate:!0},e))},_validate:function(e,t){if(!t.validate||!this.validate)return!0;e=s.extend({},this.attributes,e);var n=this.validationError=this.validate(e,t)||null;return!n||(this.trigger("invalid",this,n,s.extend(t,{validationError:n})),!1)}});var b={keys:1,values:1,pairs:1,invert:1,pick:0,omit:0,chain:1,isEmpty:1};o(v,b,"attributes");var y=t.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),void 0!==t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,s.extend({silent:!0},t))},w={add:!0,remove:!0,merge:!0},x={add:!0,remove:!1};s.extend(y.prototype,l,{model:v,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},sync:function(){return t.sync.apply(this,arguments)},add:function(e,t){return this.set(e,s.extend({merge:!1},t,x))},remove:function(e,t){t=s.extend({},t);var n=!s.isArray(e);e=n?[e]:s.clone(e);var r=this._removeModels(e,t);return!t.silent&&r&&this.trigger("update",this,t),n?r[0]:r},set:function(e,t){t=s.defaults({},t,w),t.parse&&!this._isModel(e)&&(e=this.parse(e,t));var n=!s.isArray(e);e=n?e?[e]:[]:e.slice();var r,i,a,o,l,c=t.at;null!=c&&(c=+c),c<0&&(c+=this.length+1);for(var d=this.comparator&&null==c&&t.sort!==!1,u=s.isString(this.comparator)?this.comparator:null,f=[],g=[],m={},p=t.add,h=t.merge,v=t.remove,b=!(d||!p||!v)&&[],y=!1,x=0;x<e.length;x++){if(a=e[x],o=this.get(a))v&&(m[o.cid]=!0),h&&a!==o&&(a=this._isModel(a)?a.attributes:a,t.parse&&(a=o.parse(a,t)),o.set(a,t),d&&!l&&o.hasChanged(u)&&(l=!0)),e[x]=o;else if(p){if(i=e[x]=this._prepareModel(a,t),!i)continue;f.push(i),this._addReference(i,t)}i=o||i,i&&(r=this.modelId(i.attributes),!b||!i.isNew()&&m[r]||(b.push(i),y=y||!this.models[x]||i.cid!==this.models[x].cid),m[r]=!0)}if(v){for(var x=0;x<this.length;x++)m[(i=this.models[x]).cid]||g.push(i);g.length&&this._removeModels(g,t)}if(f.length||y)if(d&&(l=!0),this.length+=f.length,null!=c)for(var x=0;x<f.length;x++)this.models.splice(c+x,0,f[x]);else{b&&(this.models.length=0);for(var _=b||f,x=0;x<_.length;x++)this.models.push(_[x])}if(l&&this.sort({silent:!0}),!t.silent){for(var C=null!=c?s.clone(t):t,x=0;x<f.length;x++)null!=c&&(C.index=c+x),(i=f[x]).trigger("add",i,this,C);(l||y)&&this.trigger("sort",this,t),(f.length||g.length)&&this.trigger("update",this,t)}return n?e[0]:e},reset:function(e,t){t=t?s.clone(t):{};for(var n=0;n<this.models.length;n++)this._removeReference(this.models[n],t);return t.previousModels=this.models,this._reset(),e=this.add(e,s.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),e},push:function(e,t){return this.add(e,s.extend({at:this.length},t))},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e)},unshift:function(e,t){return this.add(e,s.extend({at:0},t))},shift:function(e){var t=this.at(0);return this.remove(t,e)},slice:function(){return i.apply(this.models,arguments)},get:function(e){if(null!=e){var t=this.modelId(this._isModel(e)?e.attributes:e);return this._byId[e]||this._byId[t]||this._byId[e.cid]}},at:function(e){return e<0&&(e+=this.length),this.models[e]},where:function(e,t){var n=s.matches(e);return this[t?"find":"filter"](function(e){return n(e.attributes)})},findWhere:function(e){return this.where(e,!0)},sort:function(e){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return e||(e={}),s.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(s.bind(this.comparator,this)),e.silent||this.trigger("sort",this,e),this},pluck:function(e){return s.invoke(this.models,"get",e)},fetch:function(e){e=s.extend({parse:!0},e);var t=e.success,n=this;return e.success=function(s){var r=e.reset?"reset":"set";n[r](s,e),t&&t.call(e.context,n,s,e),n.trigger("sync",n,s,e)},N(this,e),this.sync("read",this,e)},create:function(e,t){t=t?s.clone(t):{};var n=t.wait;if(e=this._prepareModel(e,t),!e)return!1;n||this.add(e,t);var r=this,i=t.success;return t.success=function(e,t,s){n&&r.add(e,s),i&&i.call(s.context,e,t,s)},e.save(null,t),e},parse:function(e,t){return e},clone:function(){return new this.constructor(this.models,{model:this.model,comparator:this.comparator})},modelId:function(e){return e[this.model.prototype.idAttribute||"id"]},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(e,t){if(this._isModel(e))return e.collection||(e.collection=this),e;t=t?s.clone(t):{},t.collection=this;var n=new this.model(e,t);return n.validationError?(this.trigger("invalid",this,n.validationError,t),!1):n},_removeModels:function(e,t){for(var s=[],n=0;n<e.length;n++){var r=this.get(e[n]);if(r){var i=this.indexOf(r);this.models.splice(i,1),this.length--,t.silent||(t.index=i,r.trigger("remove",r,this,t)),s.push(r),this._removeReference(r,t)}}return!!s.length&&s},_isModel:function(e){return e instanceof v},_addReference:function(e,t){this._byId[e.cid]=e;var s=this.modelId(e.attributes);null!=s&&(this._byId[s]=e),e.on("all",this._onModelEvent,this)},_removeReference:function(e,t){delete this._byId[e.cid];var s=this.modelId(e.attributes);null!=s&&delete this._byId[s],this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,s,n){if("add"!==e&&"remove"!==e||s===this){if("destroy"===e&&this.remove(t,n),"change"===e){var r=this.modelId(t.previousAttributes()),i=this.modelId(t.attributes);r!==i&&(null!=r&&delete this._byId[r],null!=i&&(this._byId[i]=t))}this.trigger.apply(this,arguments)}}});var _={forEach:3,each:3,map:3,collect:3,reduce:4,foldl:4,inject:4,reduceRight:4,foldr:4,find:3,detect:3,filter:3,select:3,reject:3,every:3,all:3,some:3,any:3,include:2,contains:2,invoke:0,max:3,min:3,toArray:1,size:1,first:3,head:3,take:3,initial:3,rest:3,tail:3,drop:3,last:3,without:0,difference:0,indexOf:3,shuffle:1,lastIndexOf:3,isEmpty:1,chain:1,sample:3,partition:3};o(y,_,"models");var C=["groupBy","countBy","sortBy","indexBy"];s.each(C,function(e){s[e]&&(y.prototype[e]=function(t,n){var r=s.isFunction(t)?t:function(e){return e.get(t)};return s[e](this.models,r,n)})});var $=t.View=function(e){this.cid=s.uniqueId("view"),s.extend(this,s.pick(e,S)),this._ensureElement(),this.initialize.apply(this,arguments)},j=/^(\S+)\s*(.*)$/,S=["model","collection","el","id","attributes","className","tagName","events"];s.extend($.prototype,l,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this._removeElement(),this.stopListening(),this},_removeElement:function(){this.$el.remove()},setElement:function(e){return this.undelegateEvents(),this._setElement(e),this.delegateEvents(),this},_setElement:function(e){this.$el=e instanceof t.$?e:t.$(e),this.el=this.$el[0]},delegateEvents:function(e){if(e||(e=s.result(this,"events")),!e)return this;this.undelegateEvents();for(var t in e){var n=e[t];if(s.isFunction(n)||(n=this[n]),n){var r=t.match(j);this.delegate(r[1],r[2],s.bind(n,this))}}return this},delegate:function(e,t,s){return this.$el.on(e+".delegateEvents"+this.cid,t,s),this},undelegateEvents:function(){return this.$el&&this.$el.off(".delegateEvents"+this.cid),this},undelegate:function(e,t,s){return this.$el.off(e+".delegateEvents"+this.cid,t,s),this},_createElement:function(e){return document.createElement(e)},_ensureElement:function(){if(this.el)this.setElement(s.result(this,"el"));else{var e=s.extend({},s.result(this,"attributes"));this.id&&(e.id=s.result(this,"id")),this.className&&(e.class=s.result(this,"className")),this.setElement(this._createElement(s.result(this,"tagName"))),this._setAttributes(e)}},_setAttributes:function(e){this.$el.attr(e)}}),t.sync=function(e,n,r){var i=A[e];s.defaults(r||(r={}),{emulateHTTP:t.emulateHTTP,emulateJSON:t.emulateJSON});var a={type:i,dataType:"json"};if(r.url||(a.url=s.result(n,"url")||R()),null!=r.data||!n||"create"!==e&&"update"!==e&&"patch"!==e||(a.contentType="application/json",a.data=JSON.stringify(r.attrs||n.toJSON(r))),r.emulateJSON&&(a.contentType="application/x-www-form-urlencoded",a.data=a.data?{model:a.data}:{}),r.emulateHTTP&&("PUT"===i||"DELETE"===i||"PATCH"===i)){a.type="POST",r.emulateJSON&&(a.data._method=i);var o=r.beforeSend;r.beforeSend=function(e){if(e.setRequestHeader("X-HTTP-Method-Override",i),o)return o.apply(this,arguments)}}"GET"===a.type||r.emulateJSON||(a.processData=!1);var l=r.error;r.error=function(e,t,s){r.textStatus=t,r.errorThrown=s,l&&l.call(r.context,e,t,s)};var c=r.xhr=t.ajax(s.extend(a,r));return n.trigger("request",n,c,r),c};var A={create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"};t.ajax=function(){return t.$.ajax.apply(t.$,arguments)};var E=t.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},I=/\((.*?)\)/g,q=/(\(\?)?:\w+/g,V=/\*\w+/g,T=/[\-{}\[\]+?.,\\\^$|#\s]/g;s.extend(E.prototype,l,{initialize:function(){},route:function(e,n,r){s.isRegExp(e)||(e=this._routeToRegExp(e)),s.isFunction(n)&&(r=n,n=""),r||(r=this[n]);var i=this;return t.history.route(e,function(s){var a=i._extractParameters(e,s);i.execute(r,a,n)!==!1&&(i.trigger.apply(i,["route:"+n].concat(a)),i.trigger("route",n,a),t.history.trigger("route",i,n,a))}),this},execute:function(e,t,s){e&&e.apply(this,t)},navigate:function(e,s){return t.history.navigate(e,s),this},_bindRoutes:function(){if(this.routes){this.routes=s.result(this,"routes");for(var e,t=s.keys(this.routes);null!=(e=t.pop());)this.route(e,this.routes[e])}},_routeToRegExp:function(e){return e=e.replace(T,"\\$&").replace(I,"(?:$1)?").replace(q,function(e,t){return t?e:"([^/?]+)"}).replace(V,"([^?]*?)"),new RegExp("^"+e+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(e,t){var n=e.exec(t).slice(1);return s.map(n,function(e,t){return t===n.length-1?e||null:e?decodeURIComponent(e):null})}});var k=t.History=function(){this.handlers=[],s.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},O=/^[#\/]|\s+$/g,M=/^\/+|\/+$/g,F=/#.*$/;k.started=!1,s.extend(k.prototype,l,{interval:50,atRoot:function(){var e=this.location.pathname.replace(/[^\/]$/,"$&/");return e===this.root&&!this.getSearch()},matchRoot:function(){var e=this.decodeFragment(this.location.pathname),t=e.slice(0,this.root.length-1)+"/";return t===this.root},decodeFragment:function(e){return decodeURI(e.replace(/%25/g,"%2525"))},getSearch:function(){var e=this.location.href.replace(/#.*/,"").match(/\?.+/);return e?e[0]:""},getHash:function(e){var t=(e||this).location.href.match(/#(.*)$/);return t?t[1]:""},getPath:function(){var e=this.decodeFragment(this.location.pathname+this.getSearch()).slice(this.root.length-1);return"/"===e.charAt(0)?e.slice(1):e},getFragment:function(e){return null==e&&(e=this._usePushState||!this._wantsHashChange?this.getPath():this.getHash()),e.replace(O,"")},start:function(e){if(k.started)throw new Error("Backbone.history has already been started");if(k.started=!0,this.options=s.extend({root:"/"},this.options,e),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._hasHashChange="onhashchange"in window,this._useHashChange=this._wantsHashChange&&this._hasHashChange,this._wantsPushState=!!this.options.pushState,this._hasPushState=!(!this.history||!this.history.pushState),this._usePushState=this._wantsPushState&&this._hasPushState,this.fragment=this.getFragment(),this.root=("/"+this.root+"/").replace(M,"/"),this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){var t=this.root.slice(0,-1)||"/";return this.location.replace(t+"#"+this.getPath()),!0}this._hasPushState&&this.atRoot()&&this.navigate(this.getHash(),{replace:!0})}if(!this._hasHashChange&&this._wantsHashChange&&!this._usePushState){this.iframe=document.createElement("iframe"),this.iframe.src="javascript:0",this.iframe.style.display="none",this.iframe.tabIndex=-1;var n=document.body,r=n.insertBefore(this.iframe,n.firstChild).contentWindow;r.document.open(),r.document.close(),r.location.hash="#"+this.fragment}var i=window.addEventListener||function(e,t){return attachEvent("on"+e,t)};if(this._usePushState?i("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe?i("hashchange",this.checkUrl,!1):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),!this.options.silent)return this.loadUrl()},stop:function(){var e=window.removeEventListener||function(e,t){return detachEvent("on"+e,t)};this._usePushState?e("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe&&e("hashchange",this.checkUrl,!1),this.iframe&&(document.body.removeChild(this.iframe),this.iframe=null),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),k.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(e){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getHash(this.iframe.contentWindow)),t!==this.fragment&&(this.iframe&&this.navigate(t),void this.loadUrl())},loadUrl:function(e){return!!this.matchRoot()&&(e=this.fragment=this.getFragment(e),s.any(this.handlers,function(t){if(t.route.test(e))return t.callback(e),!0}))},navigate:function(e,t){if(!k.started)return!1;t&&t!==!0||(t={trigger:!!t}),e=this.getFragment(e||"");var s=this.root;""!==e&&"?"!==e.charAt(0)||(s=s.slice(0,-1)||"/");var n=s+e;if(e=this.decodeFragment(e.replace(F,"")),this.fragment!==e){if(this.fragment=e,this._usePushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);if(this._updateHash(this.location,e,t.replace),this.iframe&&e!==this.getHash(this.iframe.contentWindow)){var r=this.iframe.contentWindow;t.replace||(r.document.open(),r.document.close()),this._updateHash(r.location,e,t.replace)}}return t.trigger?this.loadUrl(e):void 0}},_updateHash:function(e,t,s){if(s){var n=e.href.replace(/(javascript:|#).*$/,"");e.replace(n+"#"+t)}else e.hash="#"+t}}),t.history=new k;var L=function(e,t){var n,r=this;n=e&&s.has(e,"constructor")?e.constructor:function(){return r.apply(this,arguments)},s.extend(n,r,t);var i=function(){this.constructor=n};return i.prototype=r.prototype,n.prototype=new i,e&&s.extend(n.prototype,e),n.__super__=r.prototype,n};v.extend=y.extend=E.extend=$.extend=k.extend=L;var R=function(){throw new Error('A "url" property or function must be specified')},N=function(e,t){var s=t.error;t.error=function(n){s&&s.call(t.context,e,n,t),e.trigger("error",e,n,t)}};return t}),$sessionId=void 0,$userId=void 0,Ext.define("$o",{singleton:!0,mixins:{observable:"Ext.util.Observable"},code:null,currentUser:null,objectsMap:{},actionsMap:{},constructor:function(e){this.mixins.observable.constructor.call(this,e),this.addEvents("afterCreateObject","beforeCommitObject","beforeRemoveObject")},load:function(e){var t=this,s=e.success,n=e.scope;t.initModels(),t.initStores({success:function(e){t.initClasses(e),t.initClassAttrs(e),t.initViews(e),t.initViewAttrs(e),t.initClassModels(),s.call(n||t,e)}})},init:function(e){if(!e)throw new Error("$o.init must have options: {success}");var t=this;t.code=e.code;var s=e.failure,n=e.scope;t.authorized?t.load(e):t.authorize(Ext.apply(e,{success:function(e){t.load(e)},failure:function(e){s&&s.call(n||t,e)}}))},authorize:function(e){var t=e;Ext.Ajax.request({url:"?authorize=1",params:e.login+"\n"+e.password+"\n"+e.passwordPlain,success:function(e,s){if(!e.responseText)return void(t.failure&&t.failure.call(t.scope||this,"Authentication error"));if("wait"!=e.responseText.substr(0,4)){if("no free slots"==e.responseText)return void(t.failure&&t.failure.call(t.scope||this,"no free slots"));if("user in system"==e.responseText)return void(t.failure&&t.failure.call(t.scope||this,"user in system"));if("firewall denied"==e.responseText)return void(t.failure&&t.failure.call(t.scope||this,"Запрещен доступ по данной ссылке."));var n=e.responseText.split(" "),r=n[0],i=n[1];"null"==i&&(i=null),this.sessionId=$sessionId=r,this.userId=$userId=i,this.authorized=!0,this.currentUser=t.login,"autologin"!=this.currentUser&&$o.util.setCookie("sessionId",r),n.length>2&&3==n[2]?$o.serverVersion=3:$o.serverVersion=2,n.length>4&&($o.roleId="null"==n[3]?null:n[3],$o.menuId="null"==n[4]?null:n[4]),$o.idleTimer=0;var a=function(){$o.idleTimer=0};if("autologin"!=this.currentUser)var o=setInterval(function(){$o.idleTimer+=1,$o.maxIdleSec=$o.maxIdleSec||1800,$o.idleTimer>$o.maxIdleSec&&(clearInterval(o),$o.logout({success:function(){Ext.Msg.alert($ptitle,$zr.getString("Session disabled"),function(){location.reload()})}}))},1e3);document.addEventListener("mousemove",a,!1),document.addEventListener("click",a,!1),document.addEventListener("scroll",a,!1),t.success.call(t.scope||this,Ext.apply(t,{sessionId:r,userId:i}))}else if(t.failure){var l=e.responseText.split(" ")[1];t.failure.call(t.scope||this,"Ждите "+(l/60|0)+" мин. до следующей попытки входа.")}},failure:function(){t.failure&&t.failure.call(t.scope||this,"Authentication error")},scope:this})},logout:function(e){function t(){Ext.Ajax.request({url:"?logout=1&sessionId="+s.sessionId,params:s.sessionId,success:function(e,t){n&&n()},failure:function(){r&&r()},scope:s})}var s=this;e=e||{};var n=e.success,r=e.failure;if($o.util.getCookie("esiaAuth")){$o.util.setCookie("esiaAuth","","/");var i=window.open("https://esia-portal1.test.gosuslugi.ru/profile/user/saml/Logout");setTimeout(function(){i.close(),window.open("https://esia-portal1.test.gosuslugi.ru/profile/user/saml/Logout"),t()},3e3)}else t()},initModels:function(){var storage=this;Ext.define("$o.Base.Model",{extend:"Ext.data.Model",constructor:function(e){var t=this;t.callParent(arguments),t.remove=function(){t.removed=!0}},sync:function(){var me=this;if(me.removed){var r=Ext.Ajax.request({async:!1,url:"?sessionId="+$sessionId,params:storage.code+"."+me.tableName+".remove("+me.get("id")+")"}),store;if("Class"==me.tableName&&(store=storage.store.classes),"ClassAttr"==me.tableName&&(store=storage.store.classAttrs),"View"==me.tableName&&(store=storage.store.views),"ViewAttr"==me.tableName&&(store=storage.store.viewAttrs),"Action"==me.tableName)return void delete storage.actionsMap[me.get("id")];var rec=store.findRecord("id",me.get("id"),0,!1,!1,!0);return store.remove(rec),"Class"!=me.tableName&&"ClassAttr"!=me.tableName||(storage.initClasses(),storage.initClassAttrs(),storage.initClassModels()),void("View"!=me.tableName&&"ViewAttr"!=me.tableName||(storage.initViews(),storage.initViewAttrs()))}for(var values=[],i=0;i<me.fieldsArray.length;i++)values.push(Ext.encode(me.get(me.fieldsArray[i])||null));if(me.get("id")){var valuesStr=values.join(",");"Action"!=me.tableName&&(valuesStr=valuesStr.split("false").join("0").split("true").join("1"));var r=Ext.Ajax.request({async:!1,url:"?sessionId="+$sessionId,params:storage.code+"."+me.tableName+".set("+valuesStr+")"})}else{values.splice(0,1);var valuesStr=values.join(",");"Action"!=me.tableName&&(valuesStr=valuesStr.split("false").join("0").split("true").join("1"));var r=Ext.Ajax.request({async:!1,url:"?sessionId="+$sessionId,params:storage.code+"."+me.tableName+".create("+valuesStr+")"});storage.checkException(r);var o=eval("("+r.responseText+")");me.set("id",o.data[0][0]),"Class"==me.tableName&&storage.store.classes.add(me),"ClassAttr"==me.tableName&&storage.store.classAttrs.add(me),"View"==me.tableName&&storage.store.views.add(me),"ViewAttr"==me.tableName&&storage.store.viewAttrs.add(me)}if("Class"==me.tableName&&storage.initClass(me),"ClassAttr"==me.tableName&&(storage.initClassAttr(me),me.get("class"))){var cls=$o.getClass(me.get("class"));cls&&storage.initClass(cls)}"View"==me.tableName&&storage.initView(me),"ViewAttr"==me.tableName&&storage.initViewAttr(me)},toString:function(){var e=this,t=e.get("code");e.getFullCode&&(t=e.getFullCode());var s;return s="Action"==e.tableName?e.get("name")+" ("+t+":"+e.get("id")+")"+(e.get("class")?", Класс: "+$o.getClass(e.get("class")).toString():""):e.get("name")+" ("+t+":"+e.get("id")+")"}}),Ext.define("$o.Class.Model",{extend:"$o.Base.Model",idProperty:"id",fields:[{name:"id",type:"number"},{name:"parent",type:"number",useNull:!0},{name:"name",type:"string",useNull:!0},{name:"code",type:"string",useNull:!0},{name:"description",type:"string",useNull:!0},{name:"format",type:"string",useNull:!0},{name:"view",type:"number",useNull:!0},{name:"type",type:"number",useNull:!0},{name:"system",type:"number",useNull:!0}],tableName:"Class",fieldsArray:["id","parent","name","code","description","format","view","type","system"],getFullCode:function(){var e="";return this.get("parent")&&(e=$o.classesMap[this.get("parent")].getFullCode()),e&&(e+="."),e+=this.get("code")},getPath:function(){return this.getFullCode()},updateDefault:function(){storage.updateDefaultView.call(this),storage.updateDefaultActions.call(this)},hasAttrInHierarchy:function(e){function t(e,s){if(e.attrs[s])return $o.getClass(e.attrs[s].get("class"));for(var n=0;n<e.childs.length;n++){var r=t($o.getClass(e.childs[n]),s);if(r)return r}return 0}var s=this,n=t(s,e);return n}}),Ext.define("$o.ClassAttr.Model",{extend:"$o.Base.Model",idProperty:"id",fields:[{name:"id",type:"number"},{name:"class",type:"number",useNull:!0},{name:"name",type:"string",useNull:!0},{name:"code",type:"string",useNull:!0},{name:"type",type:"number",useNull:!0},{name:"order",type:"number",useNull:!0},{name:"notNull",type:"bool",useNull:!0},{name:"validFunc",type:"string",useNull:!0},{name:"formatFunc",type:"string",useNull:!0},{name:"description",type:"string",useNull:!0},{name:"secure",type:"bool",useNull:!0},{name:"maxString",type:"number",useNull:!0},{name:"minString",type:"number",useNull:!0},{name:"maxNumber",type:"number",useNull:!0},{name:"minNumber",type:"number",useNull:!0},{name:"maxDate",type:"date",useNull:!0},{name:"minDate",type:"date",useNull:!0},{name:"unique",type:"bool",useNull:!0},{name:"numberFormat",type:"string",useNull:!0},{name:"dateFormat",type:"string",useNull:!0},{name:"removeRule",type:"string",useNull:!0}],tableName:"ClassAttr",fieldsArray:["id","class","name","code","type","order","notNull","validFunc","formatFunc","description","secure","maxString","minString","maxNumber","minNumber","maxDate","minDate","unique","numberFormat","dateFormat","removeRule"],getDataType:function(){var e;switch(this.get("type")){case 1:case 5:e="string";break;case 2:e="number";break;case 3:e="date";break;case 4:e="bool";break;case 6:case 7:case 8:case 9:e="number";break;default:e="number"}return e},getFieldType:function(){var e=this.getDataType(),t="numberfield";return"string"==e&&(t="textfield"),"date"==e&&(t="datefield"),"bool"==e&&(t="checkbox"),this.get("type")>=1e3&&(t="objectfield"),5==this.get("type")&&(t="$filefield"),t},getFilterDataType:function(){var e=this.getDataType();return"number"==e&&(e="numeric"),e},getVType:function(){var me=this,code;if(me.get("validFunc")){var code=$o.getClass(me.get("class")).getFullCode()+"."+me.get("code");if(!Ext.form.VTypes[code])try{var vf=eval("("+me.get("validFunc")+")"),o={};o[code]=vf.fn,o[code+"Text"]="function"==typeof vf.description?eval("("+vf.description+")"):vf.description,Ext.apply(Ext.form.VTypes,o)}catch(e){}}return code}}),Ext.define("$o.View.Model",{extend:"$o.Base.Model",idProperty:"id",fields:[{name:"id",type:"number"},{name:"parent",type:"number",useNull:!0},{name:"name",type:"string",useNull:!0},{name:"code",type:"string",useNull:!0},{name:"description",type:"string",useNull:!0},{name:"layout",type:"string",useNull:!0},{name:"key",type:"string",useNull:!0},{name:"parentKey",type:"number",useNull:!0},{name:"class",type:"number",useNull:!0},{name:"unrelated",type:"string",useNull:!0},{name:"query",type:"string",useNull:!0},{name:"type",type:"bool",useNull:!0},{name:"system",type:"bool",useNull:!0},{name:"materialized",type:"bool",useNull:!0},{name:"order",type:"number",useNull:!0},{name:"iconCls",type:"string",useNull:!0}],tableName:"View",fieldsArray:["id","parent","name","code","description","layout","key","parentKey","class","unrelated","query","type","system","materialized","order","iconCls"],getFullCode:function(){var e="";return this.get("parent")&&(e=$o.viewsMap[this.get("parent")].getFullCode()),e&&(e+="."),e+=this.get("code")},getPath:function(){return this.getFullCode()}}),Ext.define("$o.ViewAttr.Model",{extend:"$o.Base.Model",idProperty:"id",fields:[{name:"id",type:"number"},{name:"view",type:"number",useNull:!0},{name:"name",type:"string",useNull:!0},{name:"code",type:"string",useNull:!0},{name:"class",type:"number",useNull:!0},{name:"classAttr",type:"number",useNull:!0},{name:"subject",type:"number",useNull:!0},{name:"order",type:"number",useNull:!0},{name:"sort",type:"number",useNull:!0},{name:"sortOrder",type:"number",useNull:!0},{name:"operation",type:"number",useNull:!0},{name:"value",type:"string",useNull:!0},{name:"area",type:"bool",useNull:!0},{name:"width",type:"number",useNull:!0},{name:"totalType",type:"number",useNull:!0},{name:"readOnly",type:"bool",useNull:!0},{name:"group",type:"bool",useNull:!0},{name:"notNull",type:"bool",useNull:!0}],tableName:"ViewAttr",fieldsArray:["id","view","name","code","class","classAttr","subject","order","sort","sortOrder","operation","value","area","width","totalType","readOnly","group","notNull"]}),Ext.define("$o.Action.Model",{extend:"$o.Base.Model",idProperty:"id",fields:[{name:"id",type:"number"},{name:"class",type:"number",useNull:!0},{name:"name",type:"string",useNull:!0},{name:"code",type:"string",useNull:!0},{name:"description",type:"string",useNull:!0},{name:"body",type:"string",useNull:!0},{name:"layout",type:"string",useNull:!0}],tableName:"Action",fieldsArray:["id","class","name","code","description","order","body","layout"],initAction:function(){var actionId=this.get("id"),a=$o.getAction(actionId),cls=$o.getClass(a.get("class")),fName=cls.getFullCode()+"."+a.get("code");Ext.namespace(fName);var f=fName+" = function (options) {\n"+a.get("body")+"};\n",l;try{l=JSON.parse(a.get("layout"))}catch(e){}if(!l||!l.serverAction){try{eval(f)}catch(e){}if(l&&l.layout){var fl=fName+".layout = "+JSON.stringify(l.layout,null,"\t")+";\n";try{eval(fl)}catch(e){}}common.getConf("projectNeedBuild").used||common.setConf("projectNeedBuild",{used:1})}},getFullCode:function(){var e=$o.getClass(this.get("class")),t=(e?e.getFullCode()+".":"")+this.get("code");return t},getPath:function(){return this.getFullCode()},execute:function(options){var fn_=eval(this.getFullCode());"function"==typeof fn_&&fn_(options)}})},initStores:function(options){var me=this,mainOptions=options;Ext.define("$o.Class.Store",{extend:"Ext.data.Store",model:"$o.Class.Model"}),Ext.define("$o.ClassAttr.Store",{extend:"Ext.data.Store",model:"$o.ClassAttr.Model"}),Ext.define("$o.View.Store",{extend:"Ext.data.Store",model:"$o.View.Model"}),Ext.define("$o.ViewAttr.Store",{extend:"Ext.data.Store",model:"$o.ViewAttr.Model"}),me.store={classes:Ext.create("$o.Class.Store"),classAttrs:Ext.create("$o.ClassAttr.Store"),views:Ext.create("$o.View.Store"),viewAttrs:Ext.create("$o.ViewAttr.Store")},3==$o.serverVersion?Ext.Ajax.request({url:"?sessionId="+me.sessionId,params:me.code+'.Storage.getAll("")',success:function(response,options){var d=eval("("+response.responseText+")");me.store.classes.loadData(d.classes),me.store.classAttrs.loadData(d.classAttrs),me.store.views.loadData(d.views),me.store.viewAttrs.loadData(d.viewAttrs),me.visualObjectum=d.visualObjectum||{},me.visualObjectum.timeMachine=me.visualObjectum.timeMachine||{},me.visualObjectum.logo=me.visualObjectum.logo||{},me.data=d,mainOptions.data=d,mainOptions.success.call(mainOptions.scope||me,mainOptions)},scope:me}):(me.data={},mainOptions.data={},async.parallel([function(cb){Ext.Ajax.request({url:"?sessionId="+me.sessionId+"&username="+$o.currentUser,params:me.code+'.Storage.getClasses("")',success:function(response,options){var d=eval("("+response.responseText+")");me.store.classes.loadData(d.data),me.data.classes=d.data,mainOptions.data.classes=d.data,cb()},scope:me})},function(cb){
Ext.Ajax.request({url:"?sessionId="+me.sessionId+"&username="+$o.currentUser,params:me.code+'.Storage.getClassAttrs("")',success:function(response,options){var d=eval("("+response.responseText+")");me.store.classAttrs.loadData(d.data),me.classAttrs={},me.data.classAttrs=d.data,mainOptions.data.classAttrs=d.data,cb()},scope:me})},function(cb){Ext.Ajax.request({url:"?sessionId="+me.sessionId+"&username="+$o.currentUser,params:me.code+'.Storage.getViews("")',success:function(response,options){var d=eval("("+response.responseText+")");me.store.views.loadData(d.data),me.data.views=d.data,mainOptions.data.views=d.data,cb()},scope:me})},function(cb){Ext.Ajax.request({url:"?sessionId="+me.sessionId+"&username="+$o.currentUser,params:me.code+'.Storage.getViewAttrs("")',success:function(response,options){var d=eval("("+response.responseText+")");me.store.viewAttrs.loadData(d.data),me.data.viewAttrs=d.data,mainOptions.data.viewAttrs=d.data,cb()},scope:me})}],function(e,t){mainOptions.success.call(mainOptions.scope||me,mainOptions)}))},checkException:function(options){if(!$o.app){var r=eval("("+options.responseText+")");if(r&&r.header&&r.header.error)throw new Error(r.header.error)}},initClassModels:function(){Ext.define("$o.Class.Base.Model",{extend:"Ext.data.Model",storage:this,commitLocal:function(){var e=this;if("child"!=e.local){e.local=null,e.commit();for(var t in e.localChilds){var s=$o.getObject(t);"their"==e.localChilds[t].place&&s.set(e.localChilds[t].attr,e.get("id")),s.local="root",s.commitLocal(),"mine"==e.localChilds[t].place&&(e.set(e.localChilds[t].attr,s.get("id")),e.commit())}}},commit:function(options){if(this.local)return void("local"==options&&this.commitLocal());if(this.removed)return void this.storage.removeObject(this.get("id"));for(var changes={},changedNum=0,i=0;i<this.fields.getCount();i++){var attr=this.fields.getAt(i).name;if("id"!=attr&&this.data.hasOwnProperty(attr)&&this.data[attr]!=this.originalData[attr]&&(""!==this.data[attr]||this.originalData.hasOwnProperty(attr)&&null!=this.originalData[attr])){var ca=this.getClassAttr(attr);if("date"!=ca.getDataType()||!(!this.data[attr]&&!this.originalData[attr]||this.data[attr]&&this.originalData[attr]&&this.data[attr].getTime()==this.originalData[attr].getTime())){this.originalData[attr]=this.data[attr];var v=this.get(attr);if(v&&"object"==typeof v&&v.getMonth()&&2e3==v.getFullYear()&&1==v.getMonth()&&2==v.getDate()&&3==v.getHours()&&4==v.getMinutes()&&5==v.getSeconds()&&(v="$CURRENT_TIMESTAMP$"),"bool"==ca.getDataType()&&(v=v?1:0),"date"==ca.getDataType()&&v&&"$CURRENT_TIMESTAMP$"!=v)if(0==v.getHours()&&0==v.getMinutes()&&0==v.getSeconds()){var dd=v.getDate(),mm=v.getMonth()+1;v=v.getFullYear()+"-",mm<10&&(v+="0"),v+=mm+"-",dd<10&&(v+="0"),v+=dd+"T00:00:00.000Z"}else v=v.toISOString();changes[attr]={value:null===v?null:String(v),classAttrId:ca.get("id"),type:ca.get("type"),classId:ca.get("class"),classCode:$o.classesMap[ca.get("class")].get("code")},changedNum++}}}if(changedNum||!this.get("id")||this.get("id")<0){this.storage.fireEvent("beforeCommitObject",{objectId:this.get("id"),changes:changes}),this.get("id")<0&&this.set("id",null);var a=[this.get("id"),changes,this.get("classId")],r=Ext.Ajax.request({async:!1,url:"?sessionId="+this.storage.sessionId,params:this.storage.code+".Object.setAttrs([!"+JSON.stringify(a)+"!])"});this.storage.checkException.call(this.storage,r);var o=eval("("+r.responseText+")");(!this.get("id")||this.get("id")<0)&&o.data.id&&this.set("id",o.data.id||o.data);for(var a in o.data)"$CURRENT_TIMESTAMP$"==this.get(a)&&this.set(a,new Date(o.data[a]))}},sync:function(e){this.commit(e)},remove:function(){if($o.isReadOnly())throw common.message("Изменение данных недоступно."),new Error("Изменение данных недоступно.");this.removed=!0},getClassAttr:function(e){var t=$o.classesMap[this.get("classId")];return t.attrs[e]},toString:function(){var cls=$o.classesMap[this.get("classId")],ff=cls.get("format"),r=this.get("name");if(ff)try{var fn=eval("(function () {"+ff+"})");r=fn.call(this)}catch(e){console.log("toString exception"),console.log(this)}return r},set:function(e,t){if("$CURRENT_TIMESTAMP$"==t&&(t=new Date(2e3,1,2,3,4,5)),this.getClassAttr(e)&&this.getClassAttr(e).get("type")>=1e3&&t&&t<0){var s=$o.getObject(t);"root"==this.local?this.localChilds[s.get("id")]={attr:e,place:"mine"}:(this.get("id")||(this.set("id",$o.nextLocalId--),$o.objectsMap[this.get("id")]=this),s.localChilds[this.get("id")]={attr:e,place:"their"},this.local="child")}this.callParent(arguments)},getId:function(){return this.get("id")}});for(var i=0;i<this.store.classes.getCount();i++){var o=this.store.classes.getAt(i),fields=[{name:"id",type:"number",useNull:!0},{name:"classId",type:"number",useNull:!0}];for(var attr in o.attrs){var ca=o.attrs[attr];fields.push({name:ca.get("code"),type:ca.getDataType(),useNull:!0})}Ext.define("$o.Class."+o.get("id")+".Model",{extend:"$o.Class.Base.Model",fields:fields})}},initClass:function(e){var t=this;e.stub=e,e.attrs=e.attrs||{},e.attrsArray=e.attrsArray||[],e.childs=e.childs||[],t.classesMap[e.get("id")]=e,e.get("parent")&&t.classesMap[e.get("parent")].childs.push(e.get("id")),this.classesCode[e.getFullCode()]=e;var s=e.getFullCode().split(".");if(3==s.length&&(t.classesCode[s[0]+"."+s[2]]=t.classesCode[s[0]+"."+s[2]]||e),4==s.length&&(t.classesCode[s[0]+"."+s[3]]=t.classesCode[s[0]+"."+s[3]]||e),e.get("parent")){var n=$o.getClass(e.get("parent"));for(var r in n.attrs)e.attrs[r]=n.attrs[r],e.attrsArray.push(n.attrs[r])}var i=[{name:"id",type:"number",useNull:!0},{name:"classId",type:"number",useNull:!0}];for(var r in e.attrs){var a=e.attrs[r];i.push({name:a.get("code"),type:a.getDataType(),useNull:!0})}if(Ext.ClassManager.get("$o.Class."+e.get("id")+".Model")){var o=Ext.ClassManager.get("$o.Class."+e.get("id")+".Model").prototype.fields;_.each(i,function(e){o.contains({name:e.name})||o.add(e)})}else Ext.define("$o.Class."+e.get("id")+".Model",{extend:"$o.Class.Base.Model",fields:i})},initClasses:function(e){this.classesMap=this.classesMap||{};for(var t=0;t<this.store.classes.getCount();t++){var s=this.store.classes.getAt(t);s.stub=s,s.childs=[],this.classesMap[s.get("id")]=s}this.classesTree=this.classesTree||{},this.classesCode=this.classesCode||{};var n=function(e){for(var t=0;t<this.store.classes.getCount();t++){var s=this.store.classes.getAt(t);if(s.get("parent")==e.parent){e.parent&&this.classesMap[e.parent].childs.push(s.get("id")),e.node[s.get("code")]={id:s.get("id"),stub:s};var r=e.code?e.code+"."+s.get("code"):s.get("code");s.attrs={},s.attrsArray=[],this.classesCode[r]=s;var i=r.split(".");3==i.length&&(this.classesCode[i[0]+"."+i[2]]=this.classesCode[i[0]+"."+i[2]]||s),4==i.length&&(this.classesCode[i[0]+"."+i[3]]=this.classesCode[i[0]+"."+i[3]]||s),n.call(this,{node:e.node[s.get("code")],parent:s.get("id"),code:r})}}};n.call(this,{node:this.classesTree,parent:null})},initClassAttr:function(e){var t=this;if(t.classAttrs[e.get("id")]=e,t.classAttrsMap[e.get("id")]=e,t.classesMap[e.get("class")]){var s=function(n){n.attrs[e.get("code")]=e,n.attrsArray.push(e);for(var r=0;r<n.childs.length;r++)s(t.classesMap[n.childs[r]])};s(t.classesMap[e.get("class")])}},initClassAttrs:function(e){var t=this;t.classAttrs=t.classAttrs||{};for(var s=0;s<t.store.classAttrs.getCount();s++){var n=t.store.classAttrs.getAt(s);t.classAttrs[n.get("id")]=n}t.classAttrsMap=t.classAttrsMap||{};for(var s=0;s<t.store.classAttrs.getCount();s++){var r=this.store.classAttrs.getAt(s);if(t.classAttrsMap[r.get("id")]=r,t.classesMap[r.get("class")]){var i=function(e){e.attrs=e.attrs||{},e.attrs[r.get("code")]=r,e.attrsArray=e.attrsArray||[],e.attrsArray.push(r);for(var s=0;s<e.childs.length;s++)i(t.classesMap[e.childs[s]])};i(t.classesMap[r.get("class")])}}},initView:function(e){e.stub=e,e.attrs=e.attrs||{},e.childs=e.childs||[],this.viewsMap[e.get("id")]=e,this.viewsCode[e.getFullCode()]=e;var t=e.getFullCode().split(".");3==t.length&&(this.viewsCode[t[0]+"."+t[2]]=this.viewsCode[t[0]+"."+t[2]]||e),4==t.length&&(this.viewsCode[t[0]+"."+t[3]]=this.viewsCode[t[0]+"."+t[3]]||e),e.get("parent")&&this.viewsMap[e.get("parent")].childs.push(e.get("id"))},initViews:function(e){this.viewsMap=this.viewsMap||{};for(var t=0;t<this.store.views.getCount();t++){var s=this.store.views.getAt(t);s.stub=s,s.childs=[],this.viewsMap[s.get("id")]=s}this.viewsTree=this.viewsTree||{},this.viewsCode=this.viewsCode||{};var n=function(e){for(var t=0;t<this.store.views.getCount();t++){var s=this.store.views.getAt(t);if(s.get("parent")==e.parent){e.parent&&this.viewsMap[e.parent].childs.push(s.get("id")),e.node[s.get("code")]={id:s.get("id"),stub:s};var r=e.code?e.code+"."+s.get("code"):s.get("code");if(s.attrs={},this.viewsCode[r]=s,r){var i=r.split(".");3==i.length&&(this.viewsCode[i[0]+"."+i[2]]=this.viewsCode[i[0]+"."+i[2]]||s),4==i.length&&(this.viewsCode[i[0]+"."+i[3]]=this.viewsCode[i[0]+"."+i[3]]||s)}n.call(this,{node:e.node[s.get("code")],parent:s.get("id"),code:r})}}};n.call(this,{node:this.viewsTree,parent:null})},initViewAttr:function(e){var t=this;t.viewAttrsMap[e.get("id")]=e,t.viewsMap[e.get("view")].attrs[e.get("code")]=e},initViewAttrs:function(e){var t=this;t.viewAttrsMap=t.viewAttrsMap||{};for(var s=0;s<t.store.viewAttrs.getCount();s++){var n=this.store.viewAttrs.getAt(s);t.viewAttrsMap[n.get("id")]=n,t.viewsMap[n.get("view")]&&(t.viewsMap[n.get("view")].attrs=t.viewsMap[n.get("view")].attrs||{},t.viewsMap[n.get("view")].attrs[n.get("code")]=n)}},getClass:function(e){if(!e)return e;if("number"==typeof e){if(this.classesMap[e])return this.classesMap[e];throw new Error("getClass - Unknown classId: "+e)}if(e&&e.id){if(this.classesMap[e.id])return this.classesMap[e.id];throw new Error("getClass - Unknown classId: "+e.id)}var t=e.classCode||e.code;if("string"==typeof e&&(t=e),this.classesCode[t])return this.classesCode[t];throw new Error("getClass - Unknown classCode: "+t)},getClassAttr:function(e){if(this.classAttrsMap[e])return this.classAttrsMap[e];throw new Error("getClassAttr - Unknown id: "+e)},getView:function(e){if(!e)return e;if("number"==typeof e){if(this.viewsMap[e])return this.viewsMap[e];throw new Error("getView - Unknown viewId: "+e)}if(e&&e.id){if(this.viewsMap[e.id])return this.viewsMap[e.id];throw new Error("getView - Unknown viewId: "+e.id)}var t=e.viewCode||e.code;if("string"==typeof e&&(t=e),this.viewsCode[t])return this.viewsCode[t];throw new Error("getView - Unknown viewCode: "+t)},getViewAttr:function(e){if(this.viewAttrsMap[e])return this.viewAttrsMap[e];throw new Error("getViewAttr - Unknown id: "+e)},getAction:function(id){if(!id)return null;if("string"==typeof id&&id.indexOf(".")>-1)for(var i in this.actionsMap)if(this.actionsMap[i].getFullCode()==id)return this.actionsMap[i];if(this.actionsMap[id])return this.actionsMap[id];var storage=this,r=Ext.Ajax.request({async:!1,url:"?sessionId="+$sessionId,params:storage.code+".Action.get("+("string"==typeof id?'"'+id+'"':id)+")"});if(r=eval("("+r.responseText+")"),!r.data.length)return null;for(var o=Ext.create("$o.Action.Model"),i=0;i<r.data.length;i++)o.set(o.fieldsArray[i],r.data[i]);return this.actionsMap[o.get("id")]=o,o},getObject:function(id){if(!id)return null;if(this.objectsMap[id])return this.objectsMap[id];var r=Ext.Ajax.request({async:!1,url:"?sessionId="+this.sessionId,params:this.code+".Storage.getObject("+id+")"}),d=eval("("+r.responseText+")");if(d.data.id){var o=Ext.create("$o.Class."+d.data.classId+".Model",Ext.apply(d.data.attrs,{id:id,classId:d.data.classId}));return o.originalData=$o.util.clone(d.data.attrs),this.objectsMap[id]=o,o}return null},startTransaction:function(options){var description=options?options.description:"",tr=Ext.Ajax.request({async:!1,url:"?sessionId="+this.sessionId,params:this.code+'.Storage.startTransaction("'+description+'")'});return tr=eval("("+tr.responseText+")").data,$o.inTransaction=!0,tr},commitTransaction:function(e){Ext.Ajax.request({async:!1,url:"?sessionId="+this.sessionId,params:this.code+".Storage.commitTransaction("+(e||1)+")"}),$o.inTransaction=!1},rollbackTransaction:function(e){Ext.Ajax.request({async:!1,url:"?sessionId="+this.sessionId,params:this.code+".Storage.rollbackTransaction("+(e||1)+")"}),$o.inTransaction=!1},execute:function(options){if(options=options||{},!options.fn){var asArray=options.asArray;delete options.asArray;var sql=options.sql||options.query||options,r=Ext.Ajax.request({async:!1,url:"?sessionId="+this.sessionId,params:this.code+".Storage.execute([!"+JSON.stringify(sql)+"!])",paramsEncode:!1});options.noException||this.checkException(r);var o=eval("("+r.responseText+")");if(o.header&&o.header.error)return o.header;if(asArray){var r=[];return _.each(o.data,function(e,t){for(var s={},n=0;n<sql.select.length/2;n++)s[sql.select[2*n+1]]=o.data[t][n];r.push(s)}),r}o.data.fields={};for(var j=0;j<sql.select.length/2;j++)o.data.fields[sql.select[2*j+1]]=j,o.data.fields[j]=j;return o.data.get=function(e,t){var s=this.fields[t];if(null==s)throw new Error("result.get: col unknown (row:"+e+",col:"+t+")");var n=this[e][s];return void 0==n&&(n=null),n},o.data}Ext.Ajax.request({url:"plugins/?sessionId="+this.sessionId,params:JSON.stringify(options),success:function(response,opts){var o=eval("("+response.responseText+")");options.success&&options.success(o)},failure:function(e,t){this.checkException(e.responseText)}})},updateViewAttrsType:function(options){var view=options.view,query=view.get("query"),va=view.attrs;if(query){query=eval("("+query+")");for(var attrs={},i=0;i<query.select.length;i++){var qs=query.select[i];if("object"==typeof qs){var alias;for(alias in qs)break;attrs[query.select[i+1]]={alias:alias,attr:qs[alias]}}}for(var aliasClass={},i=0;i<query.from.length;i++){var qf=query.from[i];if("object"==typeof qf){var alias;for(alias in qf)break;i&&"left-join"!=query.from[i-1]&&"inner-join"!=query.from[i-1]||(aliasClass[alias]=qf[alias])}}for(var code in attrs){var attr=attrs[code],c=$o.getClass({code:aliasClass[attr.alias]});va[code]&&(va[code].set("class",c.get("id")),va[code].set("classAttr","id"!=attr.attr&&c.attrs[attr.attr]?c.attrs[attr.attr].get("id"):null))}}},createObject:function(e,t){if(this.isReadOnly())throw common.message("Изменение данных недоступно."),new Error("Изменение данных недоступно.");var s=this.getClass(e).get("id"),n="local"==t?"root":null;this.nextLocalId=this.nextLocalId||-1;var r=Ext.create("$o.Class."+s+".Model",{id:n?this.nextLocalId:null,classId:s});return r.local=n,r.localChilds={},r.originalData={classId:s},n&&(this.objectsMap[this.nextLocalId]=r,this.nextLocalId--),this.fireEvent("afterCreateObject",{classId:s,object:r}),r},removeObject:function(e){if(this.isReadOnly())throw common.message("Изменение данных недоступно."),new Error("Изменение данных недоступно.");e&&(this.fireEvent("beforeRemoveObject",{objectId:e}),Ext.Ajax.request({async:!1,url:"?sessionId="+this.sessionId,params:this.code+".Object.remove("+e+")"}),delete this.objectsMap[e])},createClass:function(e){var t=Ext.create("$o.Class.Model");for(var s in e)t.set(s,e[s]);return t},createClassAttr:function(e){var t=Ext.create("$o.ClassAttr.Model");for(var s in e){var n=s;"typeId"==n&&(n="type"),"classId"==n&&(n="class"),t.set(n,e[s])}return t},createView:function(e){var t=Ext.create("$o.View.Model");for(var s in e)t.set(s,e[s]);return t},createViewAttr:function(e){var t=Ext.create("$o.ViewAttr.Model");for(var s in e)t.set(s,e[s]);return t},createAction:function(e){var t=Ext.create("$o.Action.Model");for(var s in e)t.set(s,e[s]);return t},updateDefaultView:function(){var e,t=this;if(t.get("view"))try{e=$o.getView(t.get("view"))}catch(e){}e||(e=$o.createView(),e.set("class",t.get("id")),e.set("system",1),e.set("name",t.get("name")),e.set("code","classView."+t.getFullCode()),e.sync(),t.set("view",e.get("id")),t.sync());var s=1;for(var n in e.attrs)e.attrs[n].order&&e.attrs[n].order>=s&&(s=e.attrs[n].order+1);var r=["id"],i={select:[{a:"id"},"id"],from:[{a:t.getFullCode()}],order:[{a:"id"}]};if(!e.attrs.id){var a=$o.createViewAttr({name:"id",code:"id",view:e.get("id"),area:1,width:50,class:t.get("id"),order:s++,classAttr:null});a.sync()}for(var n in t.attrs){var o=t.attrs[n];if(r.push(n),!e.attrs[n]){var a=$o.createViewAttr({name:o.get("name"),code:n,view:e.get("id"),area:1,width:75,class:t.get("id"),order:s++,classAttr:o.get("id")});a.sync()}i.select.push({a:n}),i.select.push(n)}var l={olap:{id:"cmp-1",classView:t.getFullCode()}};i=JSON.stringify(i,null,"\t"),l=JSON.stringify(l,null,"\t"),e.get("query")==i&&e.get("layout")==l||(e.set("query",i),e.set("layout",l),e.sync());for(var n in e.attrs)if(r.indexOf(n)==-1){var a=e.attrs[n];a.remove(),a.sync()}},updateDefaultActions:function(){for(var e=this,t=common.execSQL({select:[{a:"___fid"},"id",{a:"___fcode"},"code"],from:[{a:"system.action"}],where:[{a:"___fend_id"},"=",2147483647,"and",{a:"___fclass_id"},"=",e.get("id")],order:[{a:"___fid"}]}),s={},n=0;n<t.length;n++)s[t.get(n,"code")]=t.get(n,"id");var r,i='var me = this;\nvar id = options.id || me.getValue ("id");\ncommon.tpl.show.call (this, {\n\tid: id,\n\tasWindow: 1,\n\treadOnly: options.readOnly,\n\tlayout: common.tpl.updateTags (\n\t\t'+e.getFullCode()+".card.layout, {\n\t\t\tid: id\n\t\t}\n\t)\n});\n";if(!s.card){var r=$o.createAction();r.set("class",e.get("id")),r.set("name","Открыть"),r.set("code","card"),r.set("layout",JSON.stringify({type:"card",layout:{card:{id:"card",items:[],object:[{cls:e.getFullCode(),tag:"[#id]"}]}}},null,"\t")),r.set("body",i),r.sync(),r.initAction()}var a,o='common.tpl.create.call (this, {\n\tasWindow: 1,\n\tclassCode: "'+e.getFullCode()+'",\n\tfn: function (o, options) {\n\t\toptions.layout = common.tpl.updateTags (\n\t\t\t'+e.getFullCode()+'.card.layout, {\n\t\t\t\tid: o.get ("id")\n\t\t\t}\n\t\t)\n\t}\n});\n';s.create||(a=$o.createAction(),a.set("class",e.get("id")),a.set("name","Добавить"),a.set("code","create"),a.set("layout",'{"type": "create"}'),a.set("body",o),a.sync(),a.initAction());var l,c="common.tpl.remove.call (this);\n";s.remove||(l=$o.createAction(),l.set("class",e.get("id")),l.set("name","Удалить"),l.set("code","remove"),l.set("layout",'{"type": "remove"}'),l.set("body",c),l.sync(),l.initAction())},getConfObject:function(e,t){var s;switch(e){case"class":s=$o.getClass(t);break;case"classAttr":s=$o.getClassAttr(t);break;case"view":s=$o.getView(t);break;case"viewAttr":s=$o.getViewAttr(t);break;case"action":s=$o.getAction(t)}return s},getRevisions:function(){var r=Ext.Ajax.request({async:!1,url:"get_revisions?sessionId="+$sessionId,params:"getRevisions ()"});return r=eval("("+r.responseText+")")},setRevision:function(revisionId){revisionId=revisionId||"";var r=Ext.Ajax.request({async:!1,url:"set_revision?sessionId="+$sessionId+"&id="+revisionId,params:"setRevision ("+revisionId+")"});return r=eval("("+r.responseText+")"),this.objectsMap={},this.revision=revisionId,this.app.tp.removeAll(),this.app.tp.doLayout(),r},copyFile:function(e){Ext.Ajax.request({async:!1,url:"copy_file?sessionId="+$sessionId+"&src_object_id="+e.src.objectId+"&src_class_attr_id="+e.src.classAttrId+"&dst_object_id="+e.dst.objectId+"&dst_class_attr_id="+e.dst.classAttrId+"&filename="+e.filename})},saveToFile:function(e){Ext.Ajax.request({async:!1,params:e.data,url:"save_to_file?sessionId="+$sessionId+"&object_id="+e.objectId+"&class_attr_id="+e.classAttrId+"&filename="+e.filename})},isReadOnly:function(){if($o.userId){var e=$o.getObject($o.userId);return e.get("readOnly")}return!1}}),$o.util={},$o.util.clone=function(e){if(!e||"object"!=typeof e)return e;if("object"==typeof e&&e&&e.getMonth)return new Date(e.getTime());var t,s,n="function"==typeof e.pop?[]:{};for(t in e)e.hasOwnProperty(t)&&(s=e[t],s&&"object"==typeof s?n[t]=$o.util.clone(s):n[t]=s);return n},$o.util.setCookie=function(e,t,s,n,r,i){var a=e+"="+escape(t),o=new Date;o.setDate(o.getDate()+30),n=n||o,n&&(a+="; expires="+n.toStringOriginal()),s&&(a+="; path="+escape(s)),r&&(a+="; domain="+escape(r)),i&&(a+="; secure"),document.cookie=a},$o.util.removeCookie=function(e){var t=new Date;t.setTime(t.getTime()-1),document.cookie=e+="=; expires=-1"},$o.util.getCookie=function(e){var t=document.cookie.match("(^|;) ?"+e+"=([^;]*)(;|$)");return t?unescape(t[2]):null},$o.util.getStyle=function(e){for(var t,s=document.styleSheets[0].rules||document.styleSheets[0].cssRules,n=0;n<s.length;n++)if(s[n].selectorText==e){t=s[n].cssText?s[n].cssText:s[n].style.cssText;break}return t},$o.util.isEmptyObject=function(e){if(!e)return!0;for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0},$o.util.loadCSS=function(e,t){var s=document.createElement("link");s.setAttribute("rel","stylesheet"),s.setAttribute("type","text/css"),s.setAttribute("href",e),t&&(void 0===s.onreadystatechange?s.onload=t:s.onreadystatechange=function(){"complete"!=this.readyState&&"loaded"!=this.readyState||t()}),document.getElementsByTagName("head")[0].appendChild(s)},$o.util.loadJS=function(e,t){var s=document.createElement("script");s.src=e,s.type="text/javascript",s.language="javascript";var n=document.getElementsByTagName("head")[0];t&&(void 0===s.onreadystatechange?s.onload=t:s.onreadystatechange=function(){"complete"!=this.readyState&&"loaded"!=this.readyState||t()}),n.appendChild(s)},$o.util.sha1=hex_sha1,$zu=$o.util,"object"!=typeof JSON&&(JSON={}),function(){"use strict";function f(e){return e<10?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var s,n,r,i,a,o=gap,l=t[e];switch(l&&"object"==typeof l&&"function"==typeof l.toJSON&&(l=l.toJSON(e)),"function"==typeof rep&&(l=rep.call(t,e,l)),typeof l){case"string":return quote(l);case"number":return isFinite(l)?String(l):"null";case"boolean":case"null":return String(l);case"object":if(!l)return"null";if(gap+=indent,a=[],"[object Array]"===Object.prototype.toString.apply(l)){for(i=l.length,s=0;s<i;s+=1)a[s]=str(s,l)||"null";return r=0===a.length?"[]":gap?"[\n"+gap+a.join(",\n"+gap)+"\n"+o+"]":"["+a.join(",")+"]",gap=o,r}if(rep&&"object"==typeof rep)for(i=rep.length,s=0;s<i;s+=1)"string"==typeof rep[s]&&(n=rep[s],r=str(n,l),r&&a.push(quote(n)+(gap?": ":":")+r));else for(n in l)Object.prototype.hasOwnProperty.call(l,n)&&(r=str(n,l),r&&a.push(quote(n)+(gap?": ":":")+r));return r=0===a.length?"{}":gap?"{\n"+gap+a.join(",\n"+gap)+"\n"+o+"}":"{"+a.join(",")+"}",gap=o,r}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(e){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(e){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(e,t,s){var n;if(gap="",indent="","number"==typeof s)for(n=0;n<s;n+=1)indent+=" ";else"string"==typeof s&&(indent=s);if(rep=t,t&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw new Error("JSON.stringify");return str("",{"":e})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(e,t){var s,n,r=e[t];if(r&&"object"==typeof r)for(s in r)Object.prototype.hasOwnProperty.call(r,s)&&(n=walk(r,s),void 0!==n?r[s]=n:delete r[s]);return reviver.call(e,t,r)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),Ext.define("$o.Base.Grid",{createButton:function(action){var me=this,item={scope:me,handler:function(){if(action.type&&"report"==action.type)me.report(action);else if(_fn){item.noTransaction=item.noTransaction||(item.arguments?item.arguments.noTransaction:null);try{_fn="string"==typeof _fn?eval("("+_fn+")"):_fn}catch(e){throw common.message("Функция отсутствует: "+_fn),new Error("action.fn exception: "+_fn+"\nexception: "+e)}item.noTransaction||$o.startTransaction({description:"***prepare_transaction*** action started"});var a=$o.util.clone(item.arguments);if($o.debug||a&&a.debug)_fn.call(me,a||{}),item.noTransaction||$o.commitTransaction();else try{_fn.call(me,a||{}),item.noTransaction||$o.commitTransaction()}catch(e){throw item.noTransaction||$o.rollbackTransaction(),console.log(e.stack),new Error(e)}}}};if(Ext.apply(item,action),action.code&&(item.text=$o.locale.getString(action.code),item.iconCls=action.code),item.iconCls=item.iconCls||item.icon,item.text=$o.locale.getString(action.text||action.caption),action.actions){item.menu={items:[]};for(var i=0;i<action.actions.length;i++)item.menu.items.push(me.createButton(action.actions[i]))}var _fn=item.fn||item.id;return item.id=void 0,item},report:function(e){var t=this,s=function(){var s,n="report?";for(s in e.arguments)n+=Ext.isArray(e.arguments[s])?s+"="+t.zview.getCurrentValue(e.arguments[s][0],e.arguments[s][1])+"&":s+"="+e.arguments[s]+"&";n+="storage="+$o.code+"&sessionId="+$sessionId+"&username="+$o.currentUser+"&time_offset_min="+(new Date).getTimezoneOffset();var r=window.open(n);r.focus()};if(e.fn){e.arguments.success=function(){s()};try{e.fn.call(t,e.arguments)}catch(e){return void alert(e)}}e.arguments.hasCallback||s(t)},createViewModel:function(e){var t=e.view;t.get("id");$o.updateViewAttrsType({view:t});var s=[];for(var n in t.attrs){var r=t.attrs[n],i=null==r.get("classAttr")?"number":$o.classAttrsMap[r.get("classAttr")].getDataType(),a=null==r.get("classAttr")?"numeric":$o.classAttrsMap[r.get("classAttr")].getFilterDataType();s.push({name:r.get("code"),header:r.get("name"),type:i,filterType:a,order:r.get("order"),id:r.get("id"),area:r.get("area"),width:r.get("width"),useNull:!0})}return s.sort(function(e,t){return null!==e.order&&null!==t.order&&e.order<t.order?-1:null!=e.order&&null==t.order?-1:e.order==t.order&&e.id<t.id?-1:null!==e.order&&null!==t.order&&e.order>t.order?1:null==e.order&&null!=t.order?1:e.order==t.order&&e.id>t.id?1:0}),t.orderedFields=$o.util.clone(s),s},beforeSelectListener:function(e){},selectionChangeListener:function(e){for(var t in this.targets){var s=this.targets[t];s.refresh&&s.refresh({moveFirst:1})}this.checkActions()},checkActions:function(){var tbar=this.getDockedItems("toolbar[dock='top']")[0];if(tbar)for(var i=0;i<tbar.items.getCount();i++){var b=tbar.items.getAt(i);if(b.active){var fn,args;"function"==typeof b.active?fn=b.active:"string"==typeof b.active?fn=eval(b.active):"object"==typeof b.active&&(fn=b.active.fn,args=b.active.arguments);var active=fn.call(this,args);active?b.enable():b.disable()}}},buildToolbar:function(){var e=this;if(e.actions){for(var t=[],s=0;s<e.actions.length;s++)t.push(e.createButton(e.actions[s]));t.length&&(e.dockedItems=e.dockedItems||[],e.dockedItems.push({xtype:"toolbar",dock:e.actionsDock||"top",items:t}))}},getCurrentValue:function(e){var t;if(this.getSelectionModel().hasSelection()){var s=this.getSelectionModel().getSelection()[0];t=s.get(e)}return t},getValue:function(e){return this.getCurrentValue(e)},getCurrentValues:function(e){var t=[];if(this.getSelectionModel().hasSelection())for(var s=this.getSelectionModel().getSelection(),n=0;n<s.length;n++)t.push(s[n].get(e));return t},getValues:function(e){return this.getCurrentValues(e)},getUserFilter:function(){var e=this;if(!e.filters)return[];for(var t=e.filters.getFilterData(),s=[],n={eq:"=",lt:"<",gt:">",neq:"<>",lte:"<=",gte:">="},r=0;r<t.length;r++){r&&s.push("and");var i=t[r];if(i.data.type&&"boolean"==i.data.type)i.data.value?s.push([i.field,"=",1]):s.push([i.field,"=",0,"or",i.field,"is null"]);else{s.push(i.field);var a="like";i.data.comparison&&(a=n[i.data.comparison]);var o=i.data.value;"like"==a&&o&&("object"==typeof o?(o.notLike&&(a="not like"),o.value.indexOf(",")>-1?(a=o.notLike?"not in":"in",i.data.value=o.value.split(",").join(".,.").split(".")):i.data.value=o.value+"%"):i.data.value+="%"),s.push(a),s.push(i.data.value)}}return s},getFilter:function(){var me=this,cf=[],uf=me.getUserFilter();if(!me.filter)return uf;"string"==typeof me.filter&&(me.filter={fn:eval(me.filter)}),"function"==typeof me.filter&&(me.filter={fn:me.filter});var disabled=!1,get=function(e){if("[object Array]"===Object.prototype.toString.apply(e)){for(var t=[],s=0;s<e.length;s++)t.push(get(e[s]));return t}if("object"==typeof e&&e.id){me.relatives[e.id].targets[me.zid]=me;var n=me.zview.getCurrentValue(e.id,e.attr);return void 0==n?(me.setDisabled(!0),void(disabled=!0)):(me.setDisabled(!1),n)}return e};if(me.filter.fn){if(cf=me.filter.fn.call(me,me.filter.arguments),cf=get(cf),disabled&&(cf=void 0),void 0==cf)return void me.setDisabled(!0);me.setDisabled(!1)}else cf=get(me.filter),disabled&&(cf=void 0);return"[object Array]"===Object.prototype.toString.apply(cf)&&(cf.length&&uf.length&&cf.push("and"),cf=cf.concat(uf)),cf},getFullFilter:function(){return this.getFilter()},cellRenderer:function(value,metaData,record,rowIndex,colIndex,store){if(metaData.userStyle=void 0,this.lconfig&&this.lconfig.listeners&&this.lconfig.listeners.cellRenderer){"string"==typeof this.lconfig.listeners.cellRenderer&&(this.lconfig.listeners.cellRenderer=eval(this.lconfig.listeners.cellRenderer));var scope=this.lconfig.listeners.cellRenderer.scope||this.lconfig.listeners.scope||this;"view"==scope&&(scope=this.zview),"this"===scope&&(scope=this);var _fn=this.lconfig.listeners.cellRenderer.fn||this.lconfig.listeners.cellRenderer;"string"==typeof _fn&&(_fn=eval(_fn)),value=_fn.call(scope,value,metaData,record,rowIndex,colIndex,store,this.lconfig.listeners.cellRenderer.arguments)}if(value){var tip=value;"string"==typeof tip&&(tip=tip.split('"').join("'")),metaData.tdAttr='data-qtip="'+tip+'"'}if(metaData.userStyle){var style="";style+=metaData.userStyle||"",metaData.tdAttr+=' style="'+style+'"'}return this.wordWrap&&(metaData.style="white-space: normal;"),value},userEventListener:function(options){if(this.lconfig){var listeners=this.lconfig.listeners,scope=this;if(listeners&&listeners.scope&&(scope=listeners.scope),listeners&&listeners[options.event])if(listeners[options.event].fn){listeners[options.event].scope&&(scope=listeners[options.event].scope);var fn="string"==typeof listeners[options.event].fn?eval("("+listeners[options.event].fn+")"):listeners[options.event].fn,arguments=$o.util.clone(listeners[options.event].arguments);fn.call(scope,arguments||{})}else{var fn="string"==typeof listeners[options.event]?eval("("+listeners[options.event]+")"):listeners[options.event];fn.call(scope,{})}}},getGroupedColumns:function(e){var t=function(e){for(var t=function(e){for(var t=0,s=0;s<e.length;s++){var n=e[s].split(":");n.length>t&&(t=n.length)}return t}(e),s=[],n=0;n<e.length;n++){for(var r=e[n].split(":"),i=0;i<r.length;i++)r[i]={text:r[i].trim(),colspan:1,rowspan:1};for(var i=0,a=t-r.length;i<a;i++)r.push({text:null,colspan:1,rowspan:1});s.push(r)}for(var n=1;n<e.length;n++)for(var i=0;i<t;i++){var o=s[n-1][i].hasOwnProperty("ref")?s[n-1][i].ref:n-1;null!=s[n][i].text&&s[n][i].text==s[o][i].text&&(s[o][i].colspan++,s[n][i].ref=o)}for(var n=0;n<e.length;n++)for(var i=1;i<t;i++){var l=s[n][i-1].hasOwnProperty("refR")?s[n][i-1].refR:i-1;null==s[n][i].text&&(s[n][l].rowspan++,s[n][i].refR=l)}for(var c=[],n=0;n<t;n++){for(var d=[],u=1,i=0;i<e.length;i++)s[i][n].hasOwnProperty("refR")?u+=s[i][n].colspan:s[i][n].hasOwnProperty("ref")||(d.push({
text:s[i][n].text,colspan:s[i][n].colspan,rowspan:s[i][n].rowspan,index:u}),u+=s[i][n].colspan);c.push(d)}return c},s=function(e,t){var s=function(n,r){var i=[];return _.each(e[n],function(a){if(!r||a.index>=r.index&&a.index<r.index+r.colspan){var o=[];n+1<e.length&&(o=s(n+1,a)),o.length?i.push({text:a.text,columns:o}):(t[a.index-1].header=a.text,t[a.index-1].tooltip=a.text,i.push(t[a.index-1]))}}),i},n=s(0);return n},n=t(_.map(e,function(e){return e.header})),r=s(n,e);return r}}),Ext.define("$o.Grid.Widget",{extend:"Ext.grid.Panel",mixins:{baseGrid:"$o.Base.Grid"},alias:["widget.$o.grid"],columnLines:!0,rowLines:!0,total:{},totalValues:{},initComponent:function(){function e(){var e=$o.inTransaction;e||$o.startTransaction(),r.updateDefault(),e||$o.commitTransaction()}var t,s,n=this;if(n.classView){var r=$o.getClass(n.classView);if(r.get("view")||e(),t=$o.getView(r.get("view")),n.recreateView||t.get("query").indexOf("left-join")>-1){var i=$o.inTransaction;i||$o.startTransaction(),t.remove(),t.sync(),r.set("view",null),r.sync(),e(),i||$o.commitTransaction()}s=r.get("view")}else t=n.queryId?$o.viewsMap[n.queryId]:$o.getView({code:n.$query}),s=n.viewId=t.get("id");n.$view=t;t.get("query");delete n.query;var a=n.createViewModel({view:t});n.columns=[];for(var o=0;o<a.length;o++){var l=a[o],c={header:l.header,tooltip:l.header,dataIndex:l.name,hidden:1!=l.area,width:l.width,filter:{type:l.filterType},$field:l,renderer:n.cellRenderer,scope:n,summaryType:"count",summaryRenderer:n.summaryRenderer};"bool"==l.type&&(c.renderer=function(e,t,s,r,i,a){return e=e?"Да":"Нет",n.cellRenderer(e,t,s,r,i,a)}),n.columns.push(c)}if(n.groupedColumns&&(n.columns=n.getGroupedColumns(n.columns)),_.each(n.fields,function(e){e.header=""}),Ext.define("$o.View."+s+".Model",{extend:"Ext.data.Model",fields:a}),n.store=Ext.create("Ext.data.Store",{model:"$o.View."+s+".Model",pageSize:30,remoteSort:!0,clearOnPageLoad:!0,proxy:{type:"ajax",api:{create:"view?create=1&id="+s+"&cmpId="+n.id,read:"view?read=1&id="+s+"&cmpId="+n.id,update:"view?update=1&id="+s+"&cmpId="+n.id,delete:"view?delete=1&id="+s+"&cmpId="+n.id},reader:{type:"json",root:"data"}},listeners:{load:function(e,t,s){n.down("*[name=rowsNum]")&&n.down("*[name=rowsNum]").setText("Кол-во: "+(n.countOverflow?">":"")+this.totalCount),n.needReconfigureColumns&&(n.needReconfigureColumns=!1,n.reconfigureColumns())}}}),n.dockedItems=n.dockedItems||[],!n.hideBottomToolbar){var d=[];n.hidePrint||d.push({iconCls:"gi_print",tooltip:"Печать",menu:{items:[{text:"*.xml (Таблица XML - Microsoft Excel)",iconCls:"gi_print",handler:function(){n.printOlap.call(this,"xmlss")}},{text:"*.csv (CSV - кодировка win-1251)",iconCls:"gi_print",handler:function(){n.printOlap.call(this,"csv","win1251")}},{text:"*.csv (CSV - кодировка utf-8)",iconCls:"gi_print",handler:function(){n.printOlap.call(this,"csv","utf8")}},{text:"*.xlsx (XLSX - Microsoft Excel)",iconCls:"gi_print",handler:function(){n.printOlap.call(this,"xlsx")}},{text:"*.pdf (PDF)",iconCls:"gi_print",hidden:!common.getConf({code:"reportPDF"}).used,handler:function(){n.printOlap.call(this,"pdf")}},{text:"*.ods (ODF - Open Document Format)",iconCls:"gi_print",handler:function(){n.printOlap.call(this,"ods")}}]}}),n.hideHeaders||(d.push({iconCls:"gi_restart",tooltip:"Сброс фильтров и итогов",handler:function(){n.filters.clearFilters(),n.total={},n.totalValues={};var e=n.down("*[itemId=summaryBar]");e.hide(),n.refresh()}}),d.push({xtype:"label",name:"rowsNum",text:""})),n.dockedItems.push({xtype:"pagingtoolbar",store:n.store,dock:"bottom",beforePageText:"",afterPageText:"из {0}",items:d})}n.filters={ftype:"filters",encode:!0,local:!1},n.features=[n.filters,{ftype:"summary",dock:"bottom",name:"summary"}],n.buildToolbar(),n.on("beforerender",n.beforeRenderListener,n),n.on("render",n.renderListener,n),n.on("itemdblclick",function(){n.userEventListener({event:"dblclick"})},n),n.selModel=n.selModel||Ext.create("Ext.selection.RowModel",{mode:0==n.singleSelect?"MULTI":"SINGLE",listeners:{beforeselect:{fn:n.beforeSelectListener,scope:n},selectionchange:{fn:n.selectionChangeListener,scope:n}}}),n.relatives=n.relatives||{},n.relatives[n.zid]=n,n.targets={},Ext.ux.grid.FiltersFeature.prototype.menuFilterText="Фильтр",Ext.ux.grid.filter.BooleanFilter.prototype.yesText="Да",Ext.ux.grid.filter.BooleanFilter.prototype.noText="Нет",Ext.ux.grid.filter.DateFilter.prototype.beforeEqText="Меньше или равно",Ext.ux.grid.filter.DateFilter.prototype.beforeText="Меньше",Ext.ux.grid.filter.DateFilter.prototype.afterEqText="Больше или равно",Ext.ux.grid.filter.DateFilter.prototype.afterText="Больше",Ext.ux.grid.filter.DateFilter.prototype.nonText="Не равно",Ext.ux.grid.filter.DateFilter.prototype.onText="Равно",Ext.ux.grid.filter.DateFilter.prototype.dateFormat="d.m.Y",Ext.ux.grid.menu.RangeMenu.prototype.menuItemCfgs.emptyText="Введите число ...",n.on("columnshow",function(){n.needReconfigureColumns=!0}),n.addEvents("refresh"),n.callParent(arguments)},beforeRenderListener:function(){this.getFilter()&&this.store.load()},renderListener:function(){var e=this;if(e.checkActions(),$o.util.isEmptyObject(e.total)){var t=e.down("*[itemId=summaryBar]");t&&t.hide()}var s=function(){this.down("*[name=totals]")&&this.remove(this.down("*[name=totals]"));for(var t=e.query("gridcolumn"),s=0,r=0;r<t.length;r++)if(t[r].$field&&t[r].$field.name==n.activeHeader.dataIndex){"number"==t[r].$field.type&&(s=1);break}s&&this.add([{text:"Итоги",name:"totals",iconCls:"gi_calculator",menu:{defaults:{handler:function(){e.total[n.activeHeader.dataIndex]=this.name,e.refresh();var t=e.down("*[itemId=summaryBar]");t.show()}},items:[{text:"Сумма",iconCls:"gi_calculator",name:"sum"},{text:"Среднее",iconCls:"gi_calculator",name:"avg"},{text:"Максимальное",iconCls:"gi_calculator",name:"max"},{text:"Минимальное",iconCls:"gi_calculator",name:"min"}]}}])},n=e.headerCt.getMenu();n.on("activate",s),e.on("reconfigure",function(){n=e.headerCt.getMenu(),n.on("activate",s)})},summaryRenderer:function(e,t,s){var n=t.column.dataIndex;return this.totalValues[n]},refresh:function(e){var t=this;if(t.getFilter()){if(e&&e.moveFirst){var s=t.getDockedItems("pagingtoolbar");s&&s.length&&s[0].moveFirst()}t.store.reload(e),t.checkActions()}for(var n in t.targets){var r=t.targets[n];r.refresh&&r.refresh({moveFirst:1})}t.fireEvent("refresh")},reconfigureColumns:function(){for(var e=this,t=[],s=e.down("headercontainer").getGridColumns(),n=0;n<s.length;n++){var r=s[n],i={header:r.text,tooltip:r.tooltip,dataIndex:r.dataIndex,hidden:r.hidden,width:r.width,filter:{type:r.filter.type},$field:r.$field,renderer:r.renderer,scope:r.scope};t.push(i)}e.reconfigure(null,t)},selectRow:function(options){var me=this,viewFilter=me.getFilter(),r=Ext.Ajax.request({url:"?sessionId="+$sessionId,params:$o.code+".View.selectRows("+me.viewId+", null, [!"+Ext.encode({viewFilter:viewFilter,selectFilter:options.filter})+"!])",async:!1}),rows=eval("("+r.responseText+")").data;rows.length>0&&(me.store.getProxy().extraParams={start:Math.floor(rows[0]/me.store.pageSize)*me.store.pageSize,limit:me.store.pageSize},me.store.load(function(){me.getSelectionModel().deselectAll(),me.getSelectionModel().select(rows[0]%me.store.pageSize)}))},printOlap:function(e,t){var s=this,n="report?";n+="format="+e+"&view="+s.up("grid").viewId+"&storage="+$o.code,t&&(n+="&coding="+t);var r,i=s.up("grid"),a=s.up("tabpanel");if(a&&(r=a.getActiveTab().title),r||i.title){var o="";r&&(o+=r),i.title&&(o&&(o+=" - "),o+=i.title),n+="&filename="+o,n+="xmlss"==e?".xml":"."+e}var l,c=i.getStore(),d=JSON.stringify(i.getFilter());l=c.sorters.getCount()?'["'+c.sorters.getAt(0).property+'","'+c.sorters.getAt(0).direction+'"]':"null";var u=new Date;n+="&sessionId="+$sessionId+"&username="+$zp.currentUser+"&time_offset_min="+u.getTimezoneOffset();for(var f=s.up("grid").query("gridcolumn"),g=[],m=0;m<f.length;m++){var p=f[m].$field;if(p){var h={attrId:p.id,attr:p.name,header:p.header,code:p.id,hidden:f[m].hidden?1:0,width:f[m].width||75};g.push(h)}}document.getElementById("loading").innerHTML="<form name='form_report' method='post' action='"+n+"'><textarea style='display: none' name='cols'>"+JSON.stringify(g)+"</textarea><textarea style='display: none' name='filter'>"+d+"</textarea><textarea style='display: none' name='total'>"+JSON.stringify(i.total)+"</textarea><textarea style='display: none' name='order'>"+l+"</textarea><textarea style='display: none' name='options'>"+JSON.stringify({dateAttrs:i.dateAttrs})+"</textarea></form>",document.forms.form_report.submit()}}),Ext.define("$o.CompositeField.Widget",{extend:"Ext.form.FieldContainer",alias:"widget.compositefield",layout:"hbox",initComponent:function(){this.callParent(arguments)}}),Ext.define("$o.ObjectField.Widget",{extend:"Ext.form.FieldContainer",alias:["widget.objectfield","widget.$objectfield","widget.$o.objectfield"],layout:"hbox",initComponent:function(){var me=this;me.items=[{xtype:"button",iconCls:"gi_edit",style:{marginRight:1},handler:function(){var me=this;if(!me.ro){me.choose=me.choose||{};var winWidth=me.choose.width||800,winHeight=me.choose.height||600;if(me.choose.fn&&"custom"==me.choose.type)return void me.choose.fn.call(me);me.choose.fn&&me.choose.fn.call(me),me.choose.listeners&&me.choose.listeners.beforeShow&&me.choose.listeners.beforeShow.call(me);var layout,view;if("layout"==me.choose.type)layout=$o.util.clone(me.choose.layout);else if(me.choose.id)view=$o.getView({code:me.choose.id}),layout=view.get("layout")||{olap:{id:"olap",view:me.choose.id}};else{var o=$o.getObject(me.objectId),cls=$o.getClass(o.get("classId")),ca=cls.attrs[me.attr];layout={olap:{id:"olap",classView:ca.get("type")}},me.choose.attr="olap.id"}"string"==typeof layout&&(layout=eval("("+layout+")")),me.fireEvent("beforechoose",{layout:layout});var attrs=me.choose.attr.split("."),olap,view=Ext.create("$o.Layout.Widget",{record:view||$zs.views.ser.card,$layout:layout,listeners:{afterrender:function(){var e;if(attrs.length>1){if(olap=view.relatives[attrs[0]],!olap)return void common.message("Элемент '"+attrs[0]+"' не найден.");e=olap.getDockedItems("toolbar[dock='top']")[0],e&&(e.insert(0,[btnChoose,btnCancel]),e.doLayout())}else olap=view.items.items[0];if(olap.selModel.on("selectionchange",function(){olap.getCurrentValue(attrs[attrs.length-1])?btnChoose.setDisabled(!1):btnChoose.setDisabled(!0)},this),olap.lconfig&&olap.lconfig.listeners&&olap.lconfig.listeners.dblclick&&delete olap.lconfig.listeners.dblclick,olap.on("itemdblclick",function(){me.onChoose(view),setTimeout(function(){win.close()},100)},me),e||(e=win.getDockedItems("toolbar[dock='top']")[0],e.add([btnChoose,btnCancel]),e.doLayout(),e.setVisible(!0)),me.choose.hideActions)for(var t=win.query("button"),s=0;s<t.length;s++)["Добавить","Открыть","Удалить"].indexOf(t[s].text)>-1&&t[s].hide()},scope:me}}),btnChoose=Ext.create("Ext.Button",{text:"Выбрать",iconCls:"ok",disabled:!0,handler:function(){me.onChoose(view),win.close()},scope:me}),btnCancel=Ext.create("Ext.Button",{text:"Отмена",iconCls:"cancel",handler:function(){win.close()}}),win=Ext.create("Ext.Window",{title:"Выберите объект",resizable:!0,closable:!0,height:winHeight,width:winWidth,layout:"fit",modal:!0,tbar:Ext.create("Ext.Toolbar",{hidden:!0}),items:[view]});win.show()}},scope:me},{xtype:"button",iconCls:"gi_remove",style:{marginRight:1},handler:function(){me.setValue(null),me.choose.listeners&&me.choose.listeners.afterChoose&&me.choose.listeners.afterChoose.call(me),me.fireEvent("change",null)}},{xtype:"textfield",flex:1,readOnly:!0,objectField:me,listeners:{render:function(e){me.valueField=e,me.value&&me.setValue(me.value),e.getEl().on("mousedown",function(e,t,s){me.down("button[iconCls=gi_edit]")&&me.down("button[iconCls=gi_edit]").handler.call(me)}),me.getActiveError=function(){return me.valueField.getActiveError.call(me.valueField,arguments)}},focus:function(){me.fireEvent("focus",me)}}}],me.hasOwnProperty("allowBlank")&&(me.items[me.items.length-1].allowBlank=me.allowBlank),me.readOnly&&(me.items.splice(0,2),me.addCls("readonly-field")),this.hasOwnProperty("allowBlank")&&!this.allowBlank&&this.fieldLabel&&(this.fieldLabel=this.fieldLabel+"<span style='color: red !important'>*</span>"),me.addEvents("change","beforechoose"),me.listeners&&me.listeners.beforechoose&&"string"==typeof me.listeners.beforechoose&&(me.listeners.beforechoose=eval(me.listeners.beforechoose)),me.callParent(arguments)},onChoose:function(e){var t,s,n,r=this,i=(r.choose.attr?r.choose.attr:"olap.id").split(".");if(1==i.length){for(t in e.relatives)break;s=i[0]}else t=i[0],s=i[1];var a=r.getValue();n=e.relatives[t].getCurrentValue(s),r.setValue(n),r.choose.listeners&&r.choose.listeners.afterChoose&&r.choose.listeners.afterChoose.call(r,a,n)},setValue:function(e){var t=this;if(t.value=e,e){var s=$o.getObject(e);e=s?s.toString():null}t.valueField&&(t.valueField.setValue(e),e?Ext.tip.QuickTipManager.register({target:t.valueField.id,text:e,width:300,dismissDelay:3e3}):Ext.tip.QuickTipManager.unregister(t.valueField.getEl())),t.fireEvent("change",t.value)},getValue:function(){return this.value},setReadOnly:function(e){var t=this;t.ro=e,e?(t.items.getAt(0).hide(),t.items.getAt(1).hide(),t.addCls("readonly-field")):(t.items.getAt(0).show(),t.items.getAt(1).show(),t.removeCls("readonly-field"))},validate:function(){return this.valueField.validate.call(this.valueField,arguments)},isValid:function(){return this.valueField.isValid.call(this.valueField,arguments)}}),Ext.define("$o.DateTimeField.Widget",{extend:"Ext.form.FieldContainer",alias:["widget.datetimefield","widget.$datetimefield"],layout:"hbox",initComponent:function(){var e=this;e.items=[{xtype:"datefield",width:90,readOnly:e.readOnly,listeners:{render:function(t){e.dateField=t,e.value&&e.setValue(e.value)},focus:function(){e.fireEvent("focus",e)}}},{xtype:"timefield",width:80,readOnly:e.readOnly,style:{marginLeft:1},listeners:{render:function(t){e.timeField=t,e.value&&e.setValue(e.value)},focus:function(){e.fireEvent("focus",e)}}}],e.callParent(arguments)},setValue:function(e){var t=this;t.value=e,t.dateField&&t.timeField&&(t.dateField.setValue(e),t.timeField.setValue(e))},getValue:function(){var e=this.dateField.getValue(),t=this.timeField.getValue();return t&&(e.setHours(t.getHours()),e.setMinutes(t.getMinutes()),e.setSeconds(t.getSeconds())),e}}),Ext.define("$o.MultiSelect.Widget",{extend:"Ext.panel.Panel",alias:"widget.$multiselect",border:!0,layout:"fit",initComponent:function(){var e=this;e.title=e.fieldLabel||e.title;var t={render:function(t){e.$multiselect=t}};e.listeners&&e.listeners.change&&(t.change=e.listeners.change),e.items={xtype:"multiselect",store:e.store,valueField:e.valueField,displayField:e.displayField,ddReorder:e.ddReorder,listeners:t},e.callParent(arguments)},getStore:function(){return this.$multiselect.getStore()},getValue:function(){return this.$multiselect.getValue()}}),Ext.define("$o.FileField.Widget",{extend:"Ext.form.FieldContainer",alias:"widget.$filefield",layout:"hbox",initComponent:function(){var e=this;e.items=[{xtype:"button",iconCls:"gi_upload",tooltip:"Выбрать и отправить файл",disabled:e.readOnly,style:{marginRight:1},handler:function(){var t=Ext.create("Ext.form.field.File",{fieldLabel:"Файл",buttonText:"Выбрать",name:"file-path"}),s=Ext.create("Ext.form.Panel",{defaults:{anchor:"95%"},bodyStyle:"padding: 10px 10px 0 10px;",items:[{hidden:!0,xtype:"textfield",name:"objectId",value:e.objectId},{hidden:!0,xtype:"textfield",name:"classAttrId",value:e.ca.get("id")},t],buttons:[{text:"Загрузить",iconCls:"gi_upload",handler:function(){e.card.save({autoSave:!0}),s.down("textfield[name=objectId]").setValue(e.objectId),s.getForm().submit({url:"upload?sessionId="+$sessionId+"&username="+$o.currentUser,waitMsg:"Отправление файла ...",success:function(t,s){s.result.success?(e.setValue(s.result.file),e.card.save(),n.close(),common.message("Файл "+s.result.file+" отправлен.")):common.message("Файл "+s.result.file+" не удалось отправить.")},failure:function(e,t){common.message("Файл не удалось отправить. Ошибка: "+t.result.error)}})}},{text:"Удалить",iconCls:"gi_remove",handler:function(){e.getValue()&&common.confirm({message:$zr.getString("Are you sure?"),scope:this,fn:function(t){"yes"==t&&(e.setValue(null),e.card.save({filefield:!0}))}})}}]}),n=new Ext.Window({title:"Отправление файла",resizable:!1,closable:!0,height:114,width:500,layout:"fit",modal:!0,items:s});n.show()},scope:e},{xtype:"button",iconCls:"gi_download",tooltip:"Скачать",disabled:e.readOnly,style:{marginRight:1},handler:function(){e.download()}},{xtype:"textfield",flex:1,readOnly:!0,listeners:{render:function(t){e.value&&e.setValue(e.value)}}}],e.callParent(arguments)},setValue:function(e){this.down("field").setValue(e)},getValue:function(){return this.down("field").getValue()},setReadOnly:function(e){var t=this;e?(t.items.getAt(0).hide(),t.items.getAt(1).hide(),t.addCls("readonly-field")):(t.items.getAt(0).show(),t.items.getAt(1).show(),t.removeCls("readonly-field"))},download:function(){var e=this,t=e.getValue();if(t){var s="files/"+e.objectId+"-"+e.ca.get("id")+"-"+t,n=window.open(s);n.focus()}}}),Ext.define("$o.ConfField.Widget",{extend:"$o.ObjectField.Widget",alias:["widget.conffield","widget.$conffield"],initComponent:function(){var e=this;e.addEvents("change"),e.callParent(arguments),e.setValue=function(e){var t=this;if(t.value=e,e){var s=$o.getConfObject(t.confRef,e);e=s.toString()}t.valueField&&t.valueField.setValue(e),t.fireEvent("change",t.value)}}}),Ext.define("$o.CodeMirrorTextArea.Widget",{extend:"Ext.panel.Panel",alias:["widget.codemirrortextarea"],layout:"fit",border:0,initComponent:function(){var e=this;e.items={xtype:"textarea",width:"100%",height:"100%",value:e.value,listeners:{afterrender:function(){var t=this;dom=t.inputEl.dom;var s=function(){e.editor=CodeMirror.fromTextArea(dom,{lineNumbers:!0,indentUnit:4,readOnly:!1,mode:e.mode||"javascript",viewportMargin:1/0}),e.editor.setSize(t.getWidth(),t.getHeight()),e.editor.on("change",function(){e.fireEvent("change")})};window.CodeMirror?s():$o.util.loadCSS("/third-party/codemirror/codemirror-4.3.css",function(){$o.util.loadJS("/third-party/codemirror/codemirror-4.3.min.js",function(){s()})})},resize:function(t,s,n,r,i,a){e.editor&&e.editor.setSize(s,n)}}},e.addEvents("change"),e.callParent(arguments)},setValue:function(e){var t=this;e=e||"",t.editor?t.editor.setValue(e):t.down("textarea").setValue(e)},getValue:function(){var e=this;return e.editor?this.editor.getValue():e.down("textarea").getValue()},setReadOnly:function(e){var t=this;e?t.disable():t.enable()}}),Ext.define("$o.IconSelector.Widget",{extend:"Ext.form.FieldContainer",alias:["widget.$o.iconselector","widget.$iconselector"],layout:"hbox",fieldLabel:"Иконка",initComponent:function(){var e=this;e.items=[{xtype:"button",iconCls:"gi_edit",name:"choose",height:22,handler:e.choose,scope:e,style:{marginRight:1}},{xtype:"button",iconCls:"gi_remove",height:22,style:{marginRight:5},handler:function(){e.setValue(null),e.fireEvent("change",null)}},{xtype:"button",name:"icon",width:22,height:22,iconCls:e.value,handler:e.choose,scope:e,style:{marginRight:1}},{xtype:"textfield",name:"name",flex:1,readOnly:!0,value:e.value?e.value:"",listeners:{render:function(t){t.getEl().on("mousedown",function(t,s,n){e.down("button[name=choose]").handler.call(e)})}}}],e.addEvents("change"),e.callParent(arguments)},getValue:function(){var e=this;return e.value},setValue:function(e){var t=this;t.value=e,t.down("button[name='icon']").setIconCls(e?e:""),t.down("textfield[name='name']").setValue(e?e:"")},getIconData:function(){for(var e=[],t=document.styleSheets,s=0;s<t.length;s++){var n=t[s].href;if(n&&n.indexOf("images.css")!=-1){var r=t[s].cssRules;r||(r=t[s].rules);for(var i=0;i<r.length;i++){var a=r[i].selectorText;if(a&&(a.length&&(a=a.substr(1)),"gi_"==a.substr(0,3))){var o={},l=r[i].cssText;l=l.split("(")[1].split(")")[0],o.url=l,o.iconCls=a,e.push(o)}}}}var c=function(e,t){var s=e.iconCls,n=t.iconCls;return s>n?1:s<n?-1:0};return e.sort(c),e},setReadOnly:function(e){var t=this;e?t.down("button[name='choose']").disable():t.down("button[name='choose']").enable()},choose:function(){for(var e=this,t=e.getIconData(),s=function(){a.close(),e.setValue(this.iconCls),e.fireEvent("change",this.iconCls)},n=[],r=[],i=0;i<t.length;i++)r.push({iconCls:t[i].iconCls}),r.length>20&&(n.push({layout:"hbox",defaults:{xtype:"button",handler:s,style:"margin-right: 1px; margin-bottom: 1px"},items:r}),r=[]);r.length&&n.push({layout:"hbox",defaults:{xtype:"button",handler:s,style:"margin-right: 1px; margin-bottom: 1px"},items:r});var a=Ext.create("Ext.Window",{width:500,height:570,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:"Выберите иконку",bodyPadding:5,modal:1,items:{layout:"vbox",border:0,defaults:{border:0},items:n}});a.show()}}),Ext.define("$o.Card.Widget",{extend:"Ext.panel.Panel",layout:"vbox",objectumCmp:"card",defaults:{width:"100%"},alias:["widget.$o.card","widget.$card"],bodyPadding:5,autoScroll:!0,initComponent:function(){var e=this;e.items=e.items||e.fields,e.on("beforerender",e.beforeRenderListener,e),e.on("afterrender",e.afterRenderListener,e),e.on("beforedestroy",e.beforeDestroyListener,e),e.$items=e.items,e.items=void 0,e.relatives=e.relatives||{},e.relatives[e.zid]=e,e.targets={},e.$source=null,e.buildToolbar(),e.addEvents("beforeSave","aftersave","refresh"),e.processListeners(),e.readOnly=e.readOnly||$o.isReadOnly(),e.on("destroy",function(){e.disableUnloadMessage()}),e.callParent(arguments)},setFieldValues:function(){var e=this;_.each(e.items,function(e){if(e.objectId&&e.attr&&!e.value)try{e.value=$o.getObject(e.objectId).get(e.attr)}catch(e){}})},processListeners:function(){var me=this;me.listeners=me.listeners||{},me.listeners.scope=me.listeners.scope||me;for(var i in me.listeners)if("scope"!=i){var l=me.listeners[i];if("string"==typeof l)try{l=me.listeners[i]=eval(l)}catch(e){}if("function"==typeof l)me.on(i,l,me.listeners.scope);else if(l.fn)if("string"==typeof l.fn)try{var fn=eval(l.fn),args=l.arguments||{};args.card=me,l.fn=_.bind(fn,me,args)}catch(e){console.error(l.fn,e)}else me.on(i,l.fn,l.scope||me.listeners.scope)}},beforeRenderListener:function(){this.createFields()},afterRenderListener:function(){var e=this;_.each(e.getItems(),function(t){t.on("change",function(){e.autoSave||this.originalValue!=this.getValue()&&e.enableUnloadMessage()})}),e.refresh();var t=e.up("window")||e.up("*[isTab=1]");if(t){var s=function(){if(e.enabledUnloadMessage)return common.confirm({message:"Данные не сохранены. Закрыть?",scope:this,fn:function(e){"yes"==e&&(t.un("beforeclose",s),t.close())}}),!1};t.on("beforeclose",s)}},beforeDestroyListener:function(){this.autoSave&&this.save({autoSave:!0})},getClassAttr:function(e){var t,s=this;if(e.objectId){var n=$o.getObject(e.objectId);n||console.error("bad objectId",e),t=n.getClassAttr(e.attr),t?e.$attr=e.attr:t=-1}else if(e.id&&e.attr){var r=e.attr.split(".")[0],i=e.attr.split(".")[1];s.$source=s.relatives[e.id],s.relatives[e.id].targets[s.zid]=s;var a,o=s.relatives[e.id].$view.attrs;if(o[r].get("classAttr")){var l=o[r].get("classAttr"),c=$o.classAttrsMap[l];a=$o.classesMap[c.get("type")]}else a=$o.classesMap[o[r].get("class")];t=a.attrs[i],t?(e.$relative=s.relatives[e.id],e.$objAttr=r,e.$attr=i,e.id=void 0):t=-1}return t},updateItem:function(e,t,s){var n=this,r=t.getFieldType(),i={fieldLabel:e.caption||e.fieldLabel||t.get("name"),xtype:r,card:this,ca:t};if(n.readOnly&&(i.readOnly=!0),t.get("secure")&&(i.inputType="password"),t.get("notNull")&&(e.allowBlank=!1),e.objectId){var a=$o.getObject(e.objectId);i.value=i.originalValue=a.get(e.attr)}"textfield"!=r&&"objectfield"!=r&&"$filefield"!=r||e.width||(i.anchor="-20"),"textfield"==r&&e.height&&(i.xtype="textarea"),"numberfield"==r&&(i.keyNavEnabled=!1,i.decimalPrecision=3),"datefield"!=r||e.hasOwnProperty("timefield")&&!e.timefield||(i.xtype="datetimefield"),s&&"compositefield"==s.xtype&&(i.style={marginRight:5},delete i.fieldLabel),e.listeners=e.listeners||{},e.listeners.focus=function(){n.down("*[name=fieldChanges]")&&n.down("*[name=fieldChanges]").enable(),n.focusedField=this},0==e.allowBlank&&(e.listeners.afterrender||(e.listeners.afterrender=function(){this.validate&&this.validate()})),i.vtype=t.getVType(),Ext.applyIf(e,i)},createFields:function(){for(var e=this,t=function(s,n){s||console.log(s,n);var r=e.getClassAttr(s);if(r==-1?Ext.apply(s,{xtype:"textfield",anchor:"-20",fieldLabel:s.caption||s.fieldLabel||"unknown",labelStyle:"color: red;",style:"color: red;",readOnly:!0,value:"Атрибут отсутствует в хранилище."}):r&&e.updateItem(s,r,n),s.items)for(var i=0;i<s.items.length;i++)t(s.items.getAt?s.items.getAt(i):s.items[i],s)},s=0;s<e.$items.length;s++)t(e.$items[s],null);e.add(e.$items),e.doLayout()},getItems:function(e){for(var t=this,s=[],n=function(t){if(t.$attr&&(e&&e.hidden||t.isVisible&&t.isVisible())&&s.push(t),t.items)for(var r=0;r<t.items.getCount();r++)n(t.items.getAt(r))},r=0;r<t.items.getCount();r++)n(t.items.getAt(r));return s},getFields:function(e){for(var t=this,s={},n=t.getItems(e),r=0;r<n.length;r++){var i=n[r];i.$attr&&(s[i.$attr]=i)}return s},updateFields:function(){for(var e=this,t=e.getItems(),s=0;s<t.length;s++){var n=t[s];if(n.$attr){var r=n.objectId=n.$relative?n.$relative.getCurrentValue(n.$objAttr):n.objectId,i=$o.getObject(r);n.setValue||console.log(n),n.setValue(i.get(n.$attr)),n.originalValue=i.get(n.$attr)}}},activeCondition:function(){var e=this;if(e.active){var t=e.active.fn.call(e,e.active.arguments),s=e.getItems();for(i=0;i<s.length;i++){var n=s[i];n.readOnly||n.setReadOnly(!t)}if(!e.readOnly&&!e.hideToolbar&&!e.autoSave){var r=e.getDockedItems("toolbar[dock='top']");r&&r.length&&r[0].setDisabled(!t)}}},refresh:function(){var e=this,t=e.$source;t?t.getSelectionModel().hasSelection()?(e.setDisabled(!1),e.updateFields()):e.setDisabled(!0):e.updateFields(),e.activeCondition();for(var s in this.targets){var n=this.targets[s];n.refresh&&n.refresh({moveFirst:1})}e.disableUnloadMessage(),e.fireEvent("refresh")},save:function(e){e=e||{};var t=this,s=function(){for(var s=t.getItems(),n={},r=!1,i=0;i<s.length;i++){var a=s[i];if(!e.filefield||"$filefield"==a.xtype){var o=a.objectId;if(o){var l=$o.getObject(o);if(l){n[o]=l;var c=a.getValue();l.get(a.$attr)!=c&&(l.getClassAttr(a.$attr).get("secure")&&(c=$o.util.sha1(c)),l.set(a.$attr,c),r=!0)}}}}if(r||t.hasListener("beforeSave")||t.hasListener("aftersave")){$o.startTransaction({description:"Card saving"});try{try{t.fireEvent("beforeSave",{card:t})}catch(e){console.error(e)}for(var o in n){var l=n[o];l.commit("local"),o<0&&_.each(s,function(e){e.objectId==o&&(e.objectId=l.get("id"))})}try{t.fireEvent("aftersave",{card:t})}catch(e){console.error(e),console.error(e.stack)}$o.commitTransaction(),t.$source&&t.$source.refresh()}catch(e){throw t.getEl()&&t.getEl().unmask(!0),common.message("<font color=red>Не удалось сохранить данные</font><br>Error: "+e+"<br>Stack: "+e.stack),$o.rollbackTransaction(),e}}e.autoSave||(t.getEl()&&t.getEl().unmask(!0),t.disableUnloadMessage());for(var d in t.targets){var u=t.targets[d];u.refresh&&u.refresh({moveFirst:1})}e&&e.success&&e.success.call(e.scope||t),t.up("window")&&common.getConf({code:"closeWindowAfterSave"}).used&&(t.up("window").close(),common.message("Информация сохранена."))};if(e.autoSave)s();else{for(var n=t.getItems(),r="",i=0;i<n.length;i++){var a=n[i];if(a.getActiveError&&a.getActiveError()){var o=a.fieldLabel;!o&&a.ownerCt&&a.ownerCt.fieldLabel&&(o=a.ownerCt.fieldLabel),r+="<b>"+o+": "+(null==a.getValue()?"":a.getValue())+"</b> "+a.getActiveError()+"<br>"}}r?common.message("<font color=red>Форма содержит ошибки в заполнении:</font><br><br>"+r):(t.getEl()&&t.getEl().mask("Сохранение ..."),setTimeout(s,300))}},onHighlight:function(){var e=this,t=[];_.each(e.query("*"),function(e){e.objectId&&t.push(e.objectId)}),t=_.uniq(t);var s=$o.execute({asArray:!0,select:[{a:"___fobject_id"},"objectId",{b:"___fcode"},"classAttrCode"],from:[{a:"system.object_attr"},"left-join",{b:"system.class_attr"},"on",[{a:"___fclass_attr_id"},"=",{b:"___fid"}]],where:[{a:"___fobject_id"},"in",t.join(".,.").split(".")]}),n={};_.each(s,function(e){n[e.objectId]=n[e.objectId]||{},n[e.objectId][e.classAttrCode]=n[e.objectId][e.classAttrCode]||0,n[e.objectId][e.classAttrCode]++}),_.each(e.query("*"),function(e){e.objectId&&n[e.objectId]&&n[e.objectId][e.attr]>1&&e.setFieldStyle("border: 2px solid orange")})},onFieldChanges:function(e,t){for(var s=this,n="number"==typeof e?e:s.focusedField.objectId,r="number"==typeof e?t:s.focusedField.$attr,i=$o.getObject(n),a=$o.getClass(i.get("classId")),o=a.attrs[r],l=$o.execute({select:[{a:"___fid"},"fid",{a:"___fstring"},"fstring",{a:"___fnumber"},"fnumber",{a:"___ftime"},"ftime",{b:"___fdate"},"fdate",{b:"___fsubject_id"},"fsubject_id",{b:"___fremote_addr"},"fremote_addr",{b:"___fdescription"},"fdescription",{c:"name"},"subject"],from:[{a:"system.object_attr"},"left-join",{b:"system.revision"},"on",[{a:"___fstart_id"},"=",{b:"___fid"}],"left-join",{c:"subject"},"on",[{b:"___fsubject_id"},"=",{c:"id"}]],where:[{a:"___fobject_id"},"=",n,"and",{a:"___fclass_attr_id"},"=",o.get("id")],order:[{b:"___fdate"},"desc"]}),c=[],d=0;d<l.length;d++){var u;if(l.get(d,"fsubject_id"))var f=$o.getObject(l.get(d,"fsubject_id")),u=_.filter(_.map(["login","surname","forename","patronymic","email","phone"],function(e){return f.get(e)}),function(e){if(e)return!0}).join(", ");else u="admin";var i={date:l.get(d,"fdate"),subject:u,ip:l.get(d,"fremote_addr"),description:l.get(d,"fdescription")},g="";if(l.get(d,"fstring"))g=l.get(d,"fstring");else if(l.get(d,"ftime"))g=common.getTimestamp(l.get(d,"ftime"));else if(l.get(d,"fnumber")&&(g=l.get(d,"fnumber"),o.get("type")>=1e3)){var m=$o.getObject(l.get(d,"fnumber"));g=m.toString()}i.value=g,c.push(i)}var p=Ext.create("Ext.data.Store",{data:c,fields:[{name:"date",type:"string"},{name:"value",type:"string"},{name:"subject",type:"string"},{name:"ip",type:"string"},{name:"description",type:"string"}]}),h=function(e,t,s,n,r,i){if(e){var a=e;a=a.split('"').join("'"),t.tdAttr='data-qtip="'+a+'"'}return t.style="white-space: normal;",e},v=Ext.create("Ext.grid.Panel",{store:p,columns:[{header:"Дата",width:100,dataIndex:"date",renderer:h},{header:"Значение",width:150,dataIndex:"value",renderer:h},{header:"Пользователь",width:150,dataIndex:"subject",renderer:h},{header:"IP-адрес",width:100,dataIndex:"ip",renderer:h},{header:"Комментарий ревизии",width:150,dataIndex:"description",renderer:h,hidden:!0}],forceFit:!0,frame:!1,deferRowRender:!1}),b=new Ext.Window({title:"Хронология изменений",resizable:!0,closable:!0,modal:!0,width:600,height:600,border:!1,iconCls:"gi_history",layout:"fit",items:v});b.show()},buildToolbar:function(){var e=this;e.tbarUser=e.tbar||[],e.tbar=[],e.hideToolbar||e.readOnly||e.autoSave||$o.isReadOnly()||(e.tbar=[{text:"Сохранить",iconCls:"save",handler:e.save,scope:e},{text:"Обновить",iconCls:"refresh",handler:e.refresh,scope:e}],e.showSaveAndClose&&e.tbar.push({text:"Сохранить и закрыть",iconCls:"ok",handler:function(){this.save({success:function(){this.up("window").close()}})},scope:e}),$o.visualObjectum&&$o.visualObjectum.timeMachine&&$o.visualObjectum.timeMachine.cardButton&&($o.visualObjectum.timeMachine.cardHighlight||window.monu?e.tbar.push({text:"Изменения",iconCls:"gi_history",menu:[{text:"Хронология изменений",iconCls:"gi_history",name:"fieldChanges",disabled:1,handler:e.onFieldChanges,scope:e},{text:"Показать измененные поля",iconCls:"gi_history",handler:e.onHighlight,scope:e}]}):e.tbar.push({text:"Изменения",iconCls:"gi_history",name:"fieldChanges",disabled:1,handler:e.onFieldChanges,scope:e})));for(var t=0;t<e.tbarUser.length;t++)e.tbar.push(e.tbarUser[t])},getChanged:function(){var e=this,t=[],s=e.getItems();for(i=0;i<s.length;i++){var n=s[i];if(n.isDirty()){var r=n.getValue();n.ca.get("secure")&&(r=$o.util.sha1(r));var a={};a.attr=n.$attr,a.oldValue=n.originalValue,a.newValue=r,a.fieldLabel=n.fieldLabel,
a.xtype=n.xtype,t.push(a)}}return t},enableUnloadMessage:function(){this.enabledUnloadMessage=!0,window.onbeforeunload=function(e){var t="Данные не сохранены. Вы потеряете изменения если покинете страницу.";return"undefined"==typeof e&&(e=window.event),e&&(e.returnValue=t),t}},disableUnloadMessage:function(){this.enabledUnloadMessage=!1,window.onbeforeunload=void 0}}),Ext.define("$o.CardConf.Widget",{extend:"$o.Card.Widget",alias:["widget.$o.cardConf","widget.$cardConf"],initComponent:function(){var e=this;e.callParent(arguments)},updateItem:function(e,t){var s=this,n={fieldLabel:e.fieldLabel||e.attr,xtype:"textfield",anchor:"-20",card:s,conf:e.conf};if(s.readOnly&&(n.readOnly=!0),e.confRef&&(n.xtype="conffield"),"number"==typeof e.id){n.confId=e.id;var r=$o.getConfObject(e.conf,e.id);r&&(n.value=n.originalValue=r.get(e.attr),e.$attr=e.attr)}else if("string"==typeof e.id){var i=e.attr.split(".")[0],a=e.attr.split(".")[1];s.$source=s.relatives[e.id],s.relatives[e.id].targets[s.zid]=s,n.$relative=s.relatives[e.id],n.$idAttr=i,n.$attr=a}t&&"compositefield"==t.xtype&&(n.style={marginRight:5},delete n.fieldLabel),delete e.id,Ext.applyIf(e,n)},createFields:function(){for(var e=this,t=function(s,n){if(s.conf&&s.id&&s.attr&&e.updateItem(s,n),s.items)for(var r=0;r<s.items.length;r++)t(s.items.getAt?s.items.getAt(r):s.items[r],s)},s=0;s<e.$items.length;s++)t(e.$items[s],null);e.add(e.$items),e.doLayout()},updateFields:function(){for(var e=this,t=e.getItems(),s=0;s<t.length;s++){var n=t[s];if(n.$attr){var r=n.confId=n.$relative?n.$relative.getCurrentValue(n.$idAttr):n.confId;if(r){var i=$o.getConfObject(n.conf,r);n.setValue||console.log(n),n.setValue(i.get(n.$attr)),n.originalValue=i.get(n.$attr)}}}},save:function(e){e=e||{};for(var t=this,s=function(){for(var s=t.getItems(),n={},r=!1,i=0;i<s.length;i++){var a=s[i],o=a.confId;if(o){var l=$o.getConfObject(a.conf,o);if(l){n[o]=l;var c=a.getValue();l.get(a.$attr)!=c&&(l.set(a.$attr,c),r=!0)}}}if(r){t.fireEvent("beforeSave"),$o.startTransaction({description:"CardConf saving"});try{for(var o in n){var l=n[o];l.sync()}t.fireEvent("afterSave"),$o.commitTransaction(),t.$source&&t.$source.refresh()}catch(e){throw t.getEl()&&t.getEl().unmask(!0),$o.rollbackTransaction(),e}}t.getEl()&&t.getEl().unmask(!0),e&&e.success&&e.success.call(e.scope||t)},n=t.getItems(),r="",i=0;i<n.length;i++){var a=n[i];if(a.getActiveError&&a.getActiveError()){var o=a.fieldLabel;!o&&a.ownerCt&&a.ownerCt.fieldLabel&&(o=a.ownerCt.fieldLabel),r+="<b>"+o+": "+(null==a.getValue()?"":a.getValue())+"</b> "+a.getActiveError()+"<br>"}}r?common.message("<font color=red>Форма содержит ошибки в заполнении:</font><br><br>"+r):(t.getEl()&&t.getEl().mask("Сохранение ..."),setTimeout(s,100))}}),Ext.define("$o.Tree.Widget",{extend:"Ext.tree.Panel",mixins:{baseGrid:"$o.Base.Grid"},alias:["widget.$o.tree"],useArrows:!0,rootVisible:!1,multiSelect:!0,columnLines:!0,rowLines:!0,scroll:!0,layout:"anchor",initComponent:function(){var e=this,t=e.$view=e.queryId?$o.viewsMap[e.queryId]:$o.getView({code:e.$query}),s=e.viewId=t.get("id");t.get("query");delete e.query;var n=e.createViewModel({view:t});Ext.define("$o.View."+s+".Model",{extend:"Ext.data.Model",fields:n}),e.columns=[],e.$opened=[];for(var r=0;r<n.length;r++){var i=n[r],a={text:i.header,tooltip:i.header,dataIndex:i.name,hidden:1!=i.area,width:i.width,renderer:e.cellRenderer,scope:e};r||(a.xtype="treecolumn",a.locked=!0),"bool"==i.type&&(a.renderer=function(t,s,n,r,i,a){return t=t?"Да":"Нет",e.cellRenderer(t,s,n,r,i,a)}),e.columns.push(a)}e.store=Ext.create("Ext.data.TreeStore",{model:"$o.View."+s+".Model",autoLoad:!1,root:{expanded:!1},proxy:{type:"ajax",api:{create:"treegrid?create=1&id="+s+"&cmpId="+e.id+"&fieldParent="+e.fields.parent+"&fieldId="+e.fields.id,read:"treegrid?read=1&id="+s+"&cmpId="+e.id+"&fieldParent="+e.fields.parent+"&fieldId="+e.fields.id,update:"treegrid?update=1&id="+s+"&cmpId="+e.id+"&fieldParent="+e.fields.parent+"&fieldId="+e.fields.id,delete:"treegrid?delete=1&id="+s+"&cmpId="+e.id+"&fieldParent="+e.fields.parent+"&fieldId="+e.fields.id}},listeners:{load:e.loadListener,expand:e.expandListener,collapse:e.collapseListener,scope:e}}),e.selModel=Ext.create("Ext.selection.TreeModel",{mode:0==e.singleSelect?"MULTI":"SINGLE",listeners:{beforeselect:{fn:e.beforeSelectListener,scope:e},selectionchange:{fn:e.selectionChangeListener,scope:e}}}),e.bbar=[{iconCls:"refresh",handler:e.refresh,scope:e}],e.on("beforerender",e.beforeRenderListener,e),e.on("render",e.renderListener,e),e.on("itemdblclick",function(){e.userEventListener({event:"dblclick"})},e),e.on("cellcontextmenu",function(){e.getSelectionModel().deselectAll()},e),e.buildToolbar(),e.relatives=e.relatives||{},e.relatives[e.zid]=e,e.targets={},e.callParent(arguments)},beforeRenderListener:function(){this.getFilter()&&this.store.getRootNode().expand()},renderListener:function(){this.checkActions()},expandListener:function(e){e.isRoot()||this.$opened.indexOf(e.get(this.fields.id))==-1&&this.$opened.push(e.get(this.fields.id))},collapseListener:function(e){e.isRoot()||this.$opened.splice(this.$opened.indexOf(e.get(this.fields.id)),1)},refresh:function(e){var t=this;e=e||{};var s,n=e.callback;t.getSelectionModel().hasSelection()&&(s=t.getSelectionModel().getSelection(),s=s[0]),t.getFilter()&&(t.store.getRootNode().isExpanded()?t.store.load({callback:function(){if(s&&t.getRootNode().findChild(t.fields.id,s.get(t.fields.id)))for(var e=0;e<t.records.length;e++){var r=t.records[e];if(r.get(t.fields.id)==s.get(t.fields.id)){t.getSelectionModel().deselectAll(),t.getSelectionModel().select(r);break}}n&&n.call(t,s,t.getStore(),!0)}}):t.store.getRootNode().expand(),this.checkActions())},loadListener:function(e,t,s,n,r){var i=this;i.records=i.records||[];var a=i.fields.id,o=function(e){for(var t=0;t<e.length;t++){for(var s=e[t],n=!1,r=0;r<i.records.length;r++){var l=i.records[r];if(s.get(a)==l.get(a)){i.records[r]=s,n=!0;break}}n||i.records.push(s),s.childNodes&&o(s.childNodes)}};o(s)},selectRow:function(e){var t=this;if(e.filter)for(var s=e.filter[2],n=0;n<t.records.length;n++){var r=t.records[n];if(r.get(t.fields.id)==s){t.getSelectionModel().deselectAll(),t.getSelectionModel().select(r);break}}}}),Ext.define("$o.Chart.Widget",{extend:"Ext.chart.Chart",alias:["widget.$o.chart"],style:"background:#fff",animate:!0,shadow:!0,overflowY:"auto",initComponent:function(){var e=this,t=e.$view=e.queryId?$o.viewsMap[e.queryId]:$o.getView({code:e.$query});e.viewId=t.get("id"),t.get("query");delete e.query;var s=[e.attrMark],n=[e.attrValue],r=e.getData();e.store=Ext.create("Ext.data.Store",{fields:["___name",e.attrMark,e.attrValue],data:r}),e.axes=[{type:"Numeric",position:"bottom",fields:n,minimum:0,label:{renderer:Ext.util.Format.numberRenderer("0,0")},grid:!0,title:e.titleValue},{type:"Category",position:"left",fields:["___name"],title:e.titleMark}],e.series=[{type:"bar",axis:"bottom",xField:e.attrMark,yField:n,title:s,tips:{trackMouse:!0,width:300,height:50,renderer:function(e,t){this.setTitle(t.value[0]+" ("+e.get("n"+t.yField.substr(1))+"): "+(null==t.value[1]?"":t.value[1]))}},label:{display:"insideEnd",field:s}}],e.relatives=e.relatives||{},e.relatives[e.zid]=e,e.targets={},e.callParent(arguments)},getData:function(){var e=this,t=e.$view.get("query");if(t=JSON.parse(t),e.filter){t.where=t.where||[],t.where.length&&t.where.push("and");for(var s=$o.util.clone(e.filter),n=0;n<s.length;n++){for(var r=1;r<t.select.length;r+=2)s[n]==t.select[r]&&(s[n]=t.select[r-1]);if(s[n]&&"object"==typeof s[n]&&s[n].id&&s[n].attr){if(e.relatives[s[n].id].targets[e.zid]=e,s[n]=e.relatives[s[n].id].getValue(s[n].attr),void 0==s[n])return e.disable(),[];e.enable()}}t.where.push(s)}for(var i=$o.execute({sql:t}),a=[],n=0;n<i.length;n++){var o={};o[e.attrMark]=i.get(n,e.attrMark),o[e.attrValue]=i.get(n,e.attrValue),o.___name="",a.push(o)}return a},refresh:function(e){var t=this;if(!t.refreshing){t.refreshing=1;var t=this;e=e||{},t.store.loadData(t.getData()),t.redraw(),t.refreshing=0}}}),Ext.define("$o.Image.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.image"],border:0,initComponent:function(){var e=this;e.relatives=e.relatives||{},e.relatives[e.zid]=e,e.targets={},e.items={xtype:"image",src:e.url,width:e.width,height:e.height,shrinkWrap:!0},e.on("afterrender",e.refresh,e),e.callParent(arguments)},refresh:function(e){var t=this;if(t.attr){var s=t.relatives[t.attr.split(".")[0]],n=t.attr.split(".")[1];if(s)if(s.targets[t.zid]=t,"$o.card"==s.xtype){for(var r,i=s.getItems(),a=0;a<i.length;a++)if(i[a].objectId){r=i[a].objectId;break}if(r){var o=$o.getObject(r);if(o.get(n)){var l=$o.getClass(o.get("classId")).attrs[n],c="files/"+r+"-"+l.get("id")+"-"+o.get(n);t.down("image").setSrc(c)}else t.down("image").setSrc(null)}}else{var c=s.getValue(n);t.down("image").setSrc(c)}}}}),Ext.define("$o.Frame.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.frame"],border:0,initComponent:function(){var e=this;e.relatives=e.relatives||{},e.relatives[e.zid]=e,e.targets={},e.html='<iframe src="'+e.url+'" frameborder="0" width="100%" height="100%">',e.on("afterrender",e.refresh,e),e.callParent(arguments)},refresh:function(e){var t=this;if(t.attr){var s=t.relatives[t.attr.split(".")[0]],n=t.attr.split(".")[1];if(s){s.targets[t.zid]=t;var r=s.getValue(n);t.update('<iframe src="'+r+'" frameborder="0" width="100%" height="100%">')}}}}),Ext.define("$o.Layout.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.layout","widget.$layout"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){this.relatives={};var layout=this.$layout;!layout&&this.record&&this.record.stub&&(layout=this.record.stub.get("layout"),!layout&&this.record.get("query")&&(layout={olap:{id:"olap",view:this.record.getFullCode()}})),"object"!=typeof layout&&(layout=eval("("+layout+")"),"function"==typeof layout&&(layout=layout())),delete this.layout,this.addEvents("load"),this.on("afterrender",function(){this.fireEvent("load")},this),this.record=this.record||{},this.record.stub=this.record.stub||{},this.record.stub.get=this.record.stub.get||function(){},$o.app.fireEvent("viewLayout",{record:this.record,layout:layout}),this.items=this.process(layout);try{this.viewFullCode=$o.getView(this.record.get("id")).getFullCode()}catch(e){}this.callParent(arguments)},processTab:function(e){var t={xtype:"tabpanel",zid:e.id,items:[]};e.items=e.pages||e.items;for(var s=0;s<e.items.length;s++)t.items.push(this.process(e.items[s]));return delete e.id,t},processSplit:function(e){var t={layout:"border",border:!1,zid:e.id,defaults:{border:!1}};return"horizontal"==e.orientation?t.items=[{split:!0,region:"west",width:e.width,layout:"fit",items:this.process(e.pages?e.pages[0]:e.items[0])},{region:"center",layout:"fit",items:this.process(e.pages?e.pages[1]:e.items[1])}]:t.items=[{split:!0,region:"north",height:e.height||e.width,layout:"fit",items:this.process(e.pages?e.pages[0]:e.items[0])},{region:"center",layout:"fit",items:this.process(e.pages?e.pages[1]:e.items[1])}],delete e.id,t},processOlap:function(e){var t={xtype:"$o.grid",zview:this,relatives:this.relatives,$query:e.view,zid:e.id,lconfig:{listeners:{}}};return e.listeners&&e.listeners.dblclick&&(t.lconfig.listeners.dblclick=$o.util.clone(e.listeners.dblclick),delete e.listeners.dblclick),e.listeners&&e.listeners.cellRenderer&&(t.lconfig.listeners.cellRenderer=$o.util.clone(e.listeners.cellRenderer),delete e.listeners.cellRenderer),delete e.view,delete e.id,t},processChart:function(e){var t={xtype:"$o.chart",zview:this,relatives:this.relatives,$query:e.view,zid:e.id};return delete e.view,delete e.id,t},processImage:function(e){var t={xtype:"$o.image",zview:this,relatives:this.relatives,url:e.url,attr:e.attr,width:e.width,height:e.height,zid:e.id};return delete e.id,t},processFrame:function(e){var t={xtype:"$o.frame",zview:this,relatives:this.relatives,url:e.url,attr:e.attr,zid:e.id};return delete e.id,t},processTreegrid:function(e){var t={xtype:"$o.tree",zview:this,relatives:this.relatives,$query:e.view,zid:e.id,lconfig:{listeners:{}}};return e.listeners&&e.listeners.dblclick&&(t.lconfig.listeners.dblclick=$o.util.clone(e.listeners.dblclick),delete e.listeners.dblclick),e.listeners&&e.listeners.cellRenderer&&(t.lconfig.listeners.cellRenderer=$o.util.clone(e.listeners.cellRenderer),delete e.listeners.cellRenderer),delete e.view,delete e.id,t},processCard:function(e){var t={xtype:"$o.card",zview:this,relatives:this.relatives,zid:e.id};return delete e.id,t},processCardConf:function(e){var t={xtype:"$o.cardConf",zview:this,relatives:this.relatives,zid:e.id};return delete e.id,t},processPanel:function(e){var t={xtype:"panel",zview:this,relatives:this.relatives,zid:e.id};return delete e.id,t},process:function(e){var t={};for(var s in e){var n=e[s];switch(s){case"tab":t=this.processTab(n);break;case"split":t=this.processSplit(n);break;case"olap":t=this.processOlap(n);break;case"treegrid":t=this.processTreegrid(n);break;case"card":t=this.processCard(n);break;case"cardConf":t=this.processCardConf(n);break;case"panel":t=this.processPanel(n);break;case"chart":t=this.processChart(n);break;case"image":t=this.processImage(n);break;case"frame":t=this.processFrame(n);break;case"calendar":break;case"designer":break;default:return e}n.title=$o.locale.getString(n.title)||$o.locale.getString(n.caption),Ext.applyIf(t,n)}return t},getCurrentValue:function(e,t){var s,n=this.relatives[e];return n&&(s=n.getCurrentValue(t)),s}}),Ext.define("$o.Classes.Widget",{extend:"$o.Layout.Widget",alias:["widget.$o.classes","widget.$classes"],initComponent:function(){var e=this;e.$layout={split:{orientation:"horizontal",width:290,pages:[{treegrid:{id:"olap",view:"system.classes",fields:{id:"id",parent:"parent_id"},filter:{fn:function(){return["end_id","=",2147483647,"and","id",">=",1e3]},all:!0},actions:[{fn:function(){var t=this;$zu.dialog.getNameAndCode({title:"Добавление класса",success:function(s,n){var r=!1;async.series([function(e){var s=$o.getClass(t.getCurrentValue("id"));s&&"spr"==s.getFullCode().split(".")[0]?common.confirm({message:"Создать типовой справочник (карточка, представление)?",scope:this,fn:function(t){"yes"==t&&(r=!0),e()}}):e()}],function(i){var a=$o.startTransaction({description:"Create class "}),o=$o.createClass();o.set("parent",t.getCurrentValue("id")),o.set("name",s),o.set("code",n),o.sync(),o.updateDefault(),r&&e.createSpr(o),$o.commitTransaction(a),t.refresh({callback:function(e,s,n){n&&t.selectRow({filter:["&id","=",o.get("id")]})},scope:t})})}})},caption:"create",icon:"new"},{fn:function(){common.confirm({message:$zr.getString("Are you sure?"),scope:this,fn:function(e){if("yes"==e){var t=this.getCurrentValue("id"),s=$o.startTransaction({description:"Remove class "+t}),n=$o.getClass(t);n.remove(),n.sync(),$o.commitTransaction(s),this.refresh()}}})},active:{fn:function(){var e=this.getCurrentValue("id")&&!this.getCurrentValue("schema_id");return e}},caption:"delete",icon:"delete"},{fn:function(){e.showObjects({classId:this.getCurrentValue("id")})},active:{fn:function(){var e=this.getCurrentValue("id");return e}},caption:"Объекты",iconCls:"gi_file"}],listeners:{afterrender:function(){e.olapClasses=this}}}},{tab:{pages:[{cardConf:{id:"commonCard",title:"Общие",iconCls:"gi_edit",items:[{conf:"class",id:"olap",attr:"id.name",fieldLabel:"Наименование"},{conf:"class",id:"olap",attr:"id.code",allowBlank:!1,fieldLabel:"Код",readOnly:!0,maskRe:/[A-Za-z0-9\_]/},{conf:"class",id:"olap",attr:"id.description",fieldLabel:"Описание",xtype:"textarea",height:150},{conf:"class",id:"olap",attr:"id.format",fieldLabel:"Функция форматирования (по умолчанию: return this.get ('name');)",xtype:"textarea",height:200}],active:{fn:function(){return!this.relatives.olap.getCurrentValue("schema_id")}}}},{split:{title:"Атрибуты",iconCls:"gi_file",orientation:"vertical",height:400,pages:[{olap:{id:"olapAttrs",view:"system.classAttrs",filter:["class_id","=",{id:"olap",attr:"id"}],actions:[{fn:function(){$zu.dialog.getNameAndCodeAndType({title:"Добавление атрибута класса",success:function(e,t,s){var n=$o.getClass(this.relatives.olap.getCurrentValue("id")),r=n.hasAttrInHierarchy(t);if(r)return void common.message("Атрибут уже есть в классе: "+r.toString());var i=$o.startTransaction({description:"Create class attr"}),a=$o.createClassAttr();a.set("class",this.relatives.olap.getCurrentValue("id")),a.set("name",e),a.set("code",t),a.set("type",s),a.set("removeRule","set null"),a.sync(),$o.getClass(a.get("class")).updateDefault(),$o.commitTransaction(i),this.refresh({callback:function(e,t,s){s&&this.selectRow({filter:["&id","=",a.get("id")]})},scope:this})},scope:this})},arguments:{debug:1},caption:"create",icon:"new",active:{fn:function(){return!this.relatives.olap.getCurrentValue("schema_id")}}},{fn:function(){common.confirm({message:$zr.getString("Are you sure?"),scope:this,fn:function(e){if("yes"==e){var t=this.getCurrentValue("id"),s=$o.startTransaction({description:"Remove class attr "+t}),n=$o.getClassAttr(t),r=n.get("class");n.remove(),n.sync(),$o.getClass(r).updateDefault(),$o.commitTransaction(s),this.refresh()}}})},active:{fn:function(){return this.getCurrentValue("id")&&!this.relatives.olap.getCurrentValue("schema_id")}},caption:"delete",icon:"delete"}],cellRenderer:function(e,t,s,n,r,i){if("type"==t.column.dataIndex&&s.get("type_id")){var a=$o.getClass(s.get("type_id"));a&&(e=a.toString())}return e}}},{cardConf:{id:"attrCard",items:[{conf:"classAttr",id:"olapAttrs",attr:"id.name",fieldLabel:"Наименование"},{conf:"classAttr",id:"olapAttrs",attr:"id.code",fieldLabel:"Код",allowBlank:!1,readOnly:!0,maskRe:/[A-Za-z0-9\_]/},{conf:"classAttr",id:"olapAttrs",attr:"id.type",fieldLabel:"Тип",confRef:"class",readOnly:!0},{anchor:"100%",xtype:"fieldcontainer",layout:"hbox",items:[{conf:"classAttr",id:"olapAttrs",attr:"id.secure",fieldLabel:"Пароль",xtype:"checkbox"},{conf:"classAttr",id:"olapAttrs",attr:"id.unique",fieldLabel:"Уникально",xtype:"checkbox",style:"margin-left: 10px"},{conf:"classAttr",id:"olapAttrs",attr:"id.notNull",fieldLabel:"Обязательный",xtype:"checkbox",style:"margin-left: 10px"},{xtype:"compositefield",fieldLabel:"Правило удаления",style:"margin-left: 10px",items:[{xtype:"combo",conf:"classAttr",id:"olapAttrs",attr:"id.removeRule",width:200,triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["set null","Очистить значение (set null)"],["cascade","Каскадное удаление (cascade)"]]}),valueField:"id",displayField:"text"}]}]},{conf:"classAttr",id:"olapAttrs",attr:"id.formatFunc",fieldLabel:"Параметры (JSON)",xtype:"textarea",height:50},{conf:"classAttr",id:"olapAttrs",attr:"id.validFunc",fieldLabel:"Функция валидации",xtype:"textarea",height:30},{conf:"classAttr",id:"olapAttrs",attr:"id.description",fieldLabel:"Описание",xtype:"textarea",height:30}],active:{fn:function(){if(this.relatives.olapAttrs.getValue("id")){var e=$o.getClassAttr(this.relatives.olapAttrs.getValue("id"));e.get("type")>=1e3?this.down("*[attr=id.removeRule]").enable():this.down("*[attr=id.removeRule]").disable(),1==e.get("type")?this.down("*[attr=id.secure]").enable():this.down("*[attr=id.secure]").disable()}return!this.relatives.olap.getCurrentValue("schema_id")}}}}]}},{split:{title:"Действия",iconCls:"gi_wrench",orientation:"vertical",width:400,pages:[{olap:{id:"olapActions",view:"system.actions",filter:["class_id","=",{id:"olap",attr:"id"}],actions:[{fn:function(){$zu.dialog.getNameAndCode({title:"Добавление действия",success:function(e,t){var s=$o.startTransaction({description:"Create action"}),n=$o.createAction();n.set("class",this.relatives.olap.getCurrentValue("id")),n.set("name",e),n.set("code",t),n.sync(),$o.commitTransaction(s),this.refresh({callback:function(e,t,s){s&&this.selectRow({filter:["&id","=",n.get("id")]})},scope:this})},scope:this})},caption:"create",icon:"new",active:{fn:function(){return!this.relatives.olap.getCurrentValue("schema_id")}}},{fn:function(){common.confirm({message:$zr.getString("Are you sure?"),scope:this,fn:function(e){if("yes"==e){var t=this.getCurrentValue("id"),s=$o.startTransaction({description:"Remove action "+t}),n=$o.getAction(t);n.remove(),n.sync(),$o.commitTransaction(s),this.refresh()}}})},active:{fn:function(){return this.getCurrentValue("id")&&!this.relatives.olap.getCurrentValue("schema_id")}},caption:"delete",icon:"delete"},{fn:function(){var e=$o.getAction(this.getCurrentValue("id")),t=e.get("body"),s=Ext.create("Ext.Window",{width:800,height:600,layout:"fit",frame:!1,border:!1,bodyPadding:1,modal:!1,maximizable:!0,title:"Исходный код действия: "+e.toString(),iconCls:"gi_notes",items:{name:"body",xtype:"codemirrortextarea",listeners:{afterrender:function(){this.setValue(t)}}},tbar:[{text:"Сохранить",iconCls:"gi_floppy_save",disabled:this.relatives.olap.getCurrentValue("schema_id"),handler:function(){e.set("body",s.down("*[name=body]").getValue()),e.sync(),e.initAction(),s.close()}},{text:"Отмена",iconCls:"gi_remove",handler:function(){s.close()}}]});s.show()},active:{fn:function(){return this.getCurrentValue("id")}},text:"Исходный код",iconCls:"gi_notes"},{fn:function(){var t=this.getCurrentValue("class_id"),s=$o.getAction(this.getCurrentValue("id")),n=s.get("layout");n=n||"{}",n=JSON.parse(n);var r=(n.layout,Ext.create("Ext.Window",{width:800,height:600,layout:"fit",frame:!1,border:!1,bodyPadding:1,modal:!1,maximizable:!0,title:"Макет действия: "+s.toString(),iconCls:"gi_table",items:{xtype:"$layoutdesigner",name:"layout",listeners:{afterrender:function(){this.setValue(n.layout),this.classId=t}}},tbar:[{text:"Сохранить",iconCls:"gi_floppy_save",disabled:this.relatives.olap.getCurrentValue("schema_id"),handler:function(){var t=r.down("*[name=layout]").getValue();if(t){if("string"==typeof t)try{n.layout=JSON.parse(t)}catch(e){return common.message("Парсинг макета завершился с ошибкой."),void r.close()}"object"==typeof t&&(n.layout=t)}else delete n.layout;s.set("layout",JSON.stringify(n,null,"\t")),s.sync(),s.initAction(),e.actionCard.down("*[attr=id.layout]").originalValue=JSON.stringify(n,null,"\t"),r.close()}},{text:"Отмена",iconCls:"gi_remove",handler:function(){r.close()}}]}));r.show()},active:{fn:function(){return this.getCurrentValue("id")}},text:"Макет",iconCls:"gi_table"},{text:"Обновить действия по умолчанию",iconCls:"gi_refresh",handler:function(){var e=this.up("grid").relatives.olap.getValue("id"),t=$o.getClass(e);t.updateDefault()}}],listeners:{afterrender:function(){e.olapActions=this}}}},{cardConf:{id:"actionCard",listeners:{afterrender:function(){e.actionCard=this},afterSave:function(){var t=this.relatives.olapActions.getValue("id"),s=$o.getAction(t),n=e.actionCard.down("*[attr=id.layout]"),r=n.originalValue;r=JSON.parse(r),r&&"object"==typeof r||(r={}),r.type=e.actionCard.down("*[name=type]").getValue(),r.serverAction=e.actionCard.down("*[name=serverAction]").getValue(),r.noAuth=e.actionCard.down("*[name=noAuth]").getValue(),s.set("layout",JSON.stringify(r,null,"\t")),s.sync(),s.initAction()}},items:[{conf:"action",id:"olapActions",attr:"id.name",fieldLabel:"Наименование",labelWidth:150},{conf:"action",id:"olapActions",attr:"id.code",fieldLabel:"Код",allowBlank:!1,labelWidth:150,maskRe:/[A-Za-z0-9\_]/},{xtype:"combo",name:"type",fieldLabel:"Тип",triggerAction:"all",lazyRender:!0,mode:"local",labelWidth:150,queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[[null,"-"],["create","Создание объекта"],["remove","Удаление объекта"],["card","Карточка объекта"]]}),valueField:"id",displayField:"text",listeners:{select:function(){e.actionCard.down("*[attr=id.layout]").setValue(e.actionCard.down("*[attr=id.layout]").counter++)}}},{xtype:"compositefield",fieldLabel:"Действие на сервере",labelWidth:150,items:[{xtype:"checkbox",name:"serverAction",listeners:{change:function(){e.actionCard.down("*[attr=id.layout]").setValue(e.actionCard.down("*[attr=id.layout]").counter++),this.getValue()?(e.actionCard.down("*[name=noAuth]").enable(),e.actionCard.down("*[name=displayNoAuth]").enable()):(e.actionCard.down("*[name=noAuth]").disable(),e.actionCard.down("*[name=displayNoAuth]").disable())}}},{xtype:"displayfield",name:"displayNoAuth",value:"Выполнять без аутентификации:",style:"margin-left: 10px; margin-right: 5px"},{xtype:"checkbox",name:"noAuth",labelWidth:150,listeners:{change:function(){e.actionCard.down("*[attr=id.layout]").setValue(e.actionCard.down("*[attr=id.layout]").counter++)}}}]},{conf:"action",id:"olapActions",attr:"id.body",xtype:"textarea",hideLabel:!0,style:"display: none"},{conf:"action",id:"olapActions",attr:"id.layout",xtype:"textarea",hideLabel:!0,style:"display: none"}],active:{fn:function(){if(this.relatives.olapActions.getValue("id")){var e=$o.getAction(this.relatives.olapActions.getValue("id")),t=e.get("layout");t=t||"{}",t=JSON.parse(t),this.down("*[name=type]").setValue(t.type),this.down("*[name=serverAction]").setValue(t.serverAction),this.down("*[name=noAuth]").setValue(t.noAuth),t.serverAction?(this.down("*[name=noAuth]").enable(),this.down("*[name=displayNoAuth]").enable()):(this.down("*[name=noAuth]").disable(),this.down("*[name=displayNoAuth]").disable()),t.system?this.down("*[iconCls=save]").disable():this.down("*[iconCls=save]").enable(),this.down("*[attr=id.layout]").originalValue=e.get("layout"),this.down("*[attr=id.layout]").counter=1}return!this.relatives.olap.getCurrentValue("schema_id")}}}}]}},{olap:{id:"olapDependency",title:"Зависимости",iconCls:"gi_link",view:"system.typeClassAttrs",filter:["type_id","=",{id:"olap",attr:"id"}],cellRenderer:function(e,t,s,n,r,i){if("classCode"==t.column.dataIndex){var a=$o.getClass(s.get("class_id"));a&&(e=a.getFullCode())}return e}}}]}}]}},e.callParent(arguments)},showObjects:function(e){var t=$o.getClass(e.classId);if(!t.attrsArray.length)return void common.message("В классе отсутствуют атрибуты.");var s=Ext.create("Ext.Window",{title:"Объекты класса: "+t.toString(),iconCls:"gi_file",width:800,height:600,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",bodyPadding:1,modal:!0,items:{xtype:"$o.layout",$layout:{olap:{id:"olap",classView:e.classId,recreateView:!0,singleSelect:!1,actions:[{fn:function(){var e=this;common.confirm({message:"Вы уверены?",fn:function(t){"yes"==t&&($o.startTransaction({description:"Remove by admin"}),_.each(e.getSelectionModel().getSelection(),function(t,s){$o.removeObject(t.get("id")),e.getStore().remove(t)}),$o.commitTransaction())}})},text:"Удалить",iconCls:"gi_circle_minus",active:"common.recordSelected"},{fn:function(){var e=this,t=JSON.parse(e.$view.get("query")),s=e.getFilter();s&&s.length&&(_.each(s,function(e,n){var r=t.select.indexOf(e);r>-1&&(s[n]=t.select[r-1])}),t.where=t.where||[],t.where.length&&t.where.push("and"),t.where.push(s)),t.asArray=!0;var n=$o.execute(t);common.confirm({message:"Будет удалено записей: "+n.length+". Вы уверены?",fn:function(t){"yes"==t&&(Ext.MessageBox.show({title:"Пожалуйста подождите",msg:"Действие выполняется ...",progressText:"",width:300,progress:1,closable:!1}),setTimeout(function(){$o.startTransaction(),async.reduce(n,0,function(e,t,s){Ext.MessageBox.updateProgress(e/n.length,e+" / "+n.length),$o.removeObject(t.id),setTimeout(function(){s(null,e+1)},1)},function(t){$o.commitTransaction(),Ext.MessageBox.hide(),e.refresh()})},100))}})},text:"Удалить все",iconCls:"gi_circle_minus"},{fn:function(){var e=this,s=JSON.parse(e.$view.get("query")),n=e.getFilter();n&&n.length&&(_.each(n,function(e,t){var r=s.select.indexOf(e);r>-1&&(n[t]=s.select[r-1])}),s.where=s.where||[],s.where.length&&s.where.push("and"),s.where.push(n)),s.asArray=!0;var r=$o.execute(s),i=Ext.create("Ext.window.Window",{title:"Изменение значения",iconCls:"edit",closable:!0,width:600,height:400,layout:"vbox",modal:!0,style:"background-color: #fff",bodyStyle:"background-color: #fff",bodyPadding:5,items:[{xtype:"textfield",disabled:!0,fieldLabel:"Будет изменено записей",value:r.length},{xtype:"combo",fieldLabel:"Атрибут",name:"attr",triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",store:{type:"json",fields:["id","name"],data:_.map(t.attrsArray,function(e){return{id:e.get("code"),name:e.toString()}})},width:"100%",valueField:"id",displayField:"name",editable:!1},{xtype:"textfield",name:"value",fieldLabel:"Значение",width:"100%"}],buttons:[{text:"Изменить",iconCls:"ok",handler:function(){var t=i.down("*[name=attr]").getValue(),s=i.down("*[name=value]").getValue()||null;return t?(Ext.MessageBox.show({title:"Пожалуйста подождите",msg:"Действие выполняется ...",progressText:"",width:300,progress:1,closable:!1}),void setTimeout(function(){$o.startTransaction(),async.reduce(r,0,function(e,n,i){Ext.MessageBox.updateProgress(e/r.length,e+" / "+r.length);var a=$o.getObject(n.id);a.set(t,s),a.sync(),setTimeout(function(){i(null,e+1)},1)},function(t){$o.commitTransaction(),Ext.MessageBox.hide(),i.close(),e.refresh()})},100)):common.message("Выберите атрибут")}}]});i.show()},text:"Изменить все",iconCls:"edit"},{text:"Импорт из CSV",iconCls:"gi_disk_import",fn:function(){var t=this,s=Ext.create("Ext.window.Window",{title:"Импорт из CSV",iconCls:"gi_disk_import",closable:!0,width:800,height:600,layout:"fit",modal:!0,style:"background-color: #fff",bodyStyle:"background-color: #fff",items:{xtype:"importcsvobjects",classId:e.classId,listeners:{imported:function(){s.close(),t.refresh()}}}});s.show()}}]}}}});s.show()},createSpr:function(e){var t={type:"card",layout:{designer:1,card:{id:"card",items:[{anchor:"100%",fieldLabel:"Наименование",attr:"name",objectId:"[#id]"},{fieldLabel:"№ пп",attr:"npp",objectId:"[#id]",width:200},{anchor:"100%",fieldLabel:"Код",attr:"code",objectId:"[#id]"}],object:[{cls:e.getFullCode(),tag:"[#id]"}]}}},s=$o.execute({asArray:!0,select:[{a:"___fid"},"id"],from:[{a:"system.action"}],where:[{a:"___fend_id"},"=",2147483647,"and",{a:"___fclass_id"},"=",e.get("id"),"and",{a:"___fcode"},"=","card"]}),n=$o.getAction(s[0].id);n.set("layout",JSON.stringify(t,null,"\t")),n.sync();var r=e.getFullCode().split(".");r.splice(r.length-1,1),r=r.join(".");var i;try{i=$o.getView(r)}catch(e){return common.message("Базовое представление отсутствует "+r)}if(!i)return common.message("Базовое представление отсутствует "+r);var a=r+"."+e.get("code"),o=$o.createView();o.set("parent",i.get("id")),o.set("name",e.get("name")),o.set("code",e.get("code")),o.set("query",JSON.stringify({designer:1,select:[{a:"id"},"id",{a:"name"},"name",{a:"code"},"code",{a:"npp"},"npp"],from:[{a:a}],order:[{a:"npp"},",",{a:"name"}]},null,"\t")),o.set("layout",JSON.stringify({designer:1,olap:{id:"olap",view:a,actions:[{fn:a+".card",text:"Открыть",iconCls:"gi_edit",active:"common.recordSelected"},{fn:a+".create",text:"Добавить",iconCls:"gi_circle_plus"},{fn:a+".remove",text:"Удалить",iconCls:"gi_circle_minus",active:"common.recordSelected"}]}},null,"\t")),o.set("iconCls","gi_book"),o.sync(),_.each([{code:"id",name:"id",width:75,area:0},{code:"name",name:"Наименование",width:500,area:1},{code:"code",name:"Код",width:75,area:0},{code:"npp",name:"№ пп",width:75,area:0}],function(e,t){var s=$o.createViewAttr();s.set("view",o.get("id")),s.set("code",e.code),s.set("name",e.name),s.set("width",e.width),s.set("area",e.area),s.set("order",t+1),s.sync()})}}),Ext.define("$o.Views.Widget",{extend:"$o.Layout.Widget",alias:["widget.$o.views","widget.$views"],initComponent:function(){var me=this;me.$layout={split:{orientation:"horizontal",width:290,pages:[{treegrid:{id:"olap",view:"system.views",fields:{id:"id",parent:"parent_id"},filter:{fn:function(){return["system","is null","and","end_id","=",2147483647]},all:!0},actions:[{fn:function(){$zu.dialog.getNameAndCode({title:"Добавление представления",success:function(e,t){var s=$o.startTransaction({description:"Create view"}),n=$o.createView();n.set("parent",this.getCurrentValue("id")),n.set("name",e),n.set("code",t),n.sync(),$o.commitTransaction(s),this.refresh({callback:function(e,t,s){s&&this.selectRow({filter:["&id","=",n.get("id")]})},
scope:this})},scope:this})},caption:"create",icon:"new"},{fn:function(){common.confirm({message:$zr.getString("Are you sure?"),scope:this,fn:function(e){if("yes"==e){var t=this.getCurrentValue("id"),s=$o.startTransaction({description:"Remove view "+t}),n=$o.getView(t);n.remove(),n.sync(),$o.commitTransaction(s),this.refresh()}}})},active:{fn:function(){var e=this.getCurrentValue("id")&&!this.getCurrentValue("schema_id");return e}},caption:"delete",icon:"delete"},{fn:function(){var e=$o.viewsMap[this.getCurrentValue("id")];$o.app.show.call($o.app,{record:e})},active:{fn:function(){var e=this.getCurrentValue("id");return e}},caption:"Просмотр",iconCls:"gi_eye_open"}]}},{tab:{listeners:{tabchangeTODO:function(e,t){var s=this;if("Запрос"==t.title||"Макет"==t.title){var n=t.getItems()[0],r=n.getValue(),i=Ext.getDom(n.inputEl);s.editor&&s.editor.toTextArea();var a=t.getHeight(!0);Ext.util.CSS.updateRule(".CodeMirror-scroll","height",a+"px"),s.editor=CodeMirror.fromTextArea(i,{lineNumbers:!0,indentUnit:4,readOnly:!1,mode:{name:"javascript",json:!0}}),s.editor.setValue(r)}}},pages:[{cardConf:{id:"commonCard",title:"Общие",iconCls:"gi_edit",tbar:[{text:"Зависимости",iconCls:"gi_link",handler:function(){var e=this.up("*[name=views]").relatives.olap.getValue("id"),t=$o.getView(e).getFullCode(),s=[];_.each($o.viewsMap,function(e,n){e.get("layout")&&e.get("layout").indexOf(t)>-1&&s.push({id:e.get("id"),path:e.getFullCode(),name:e.get("name")})});var n=Ext.create("Ext.Window",{width:600,height:600,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:"Зависимости: Представления",iconCls:"gi_link",bodyPadding:5,modal:1,items:{xtype:"grid",name:"grid",store:{type:"json",fields:["id","path","name"],data:s},columns:[{text:"id",dataIndex:"id"},{text:"Код",dataIndex:"path"},{text:"Наименование",dataIndex:"name"}],width:"100%",forceFit:!0,columnLines:!0,rowLines:!0}});n.show()}}],items:[{conf:"view",id:"olap",attr:"id.name",fieldLabel:"Наименование"},{conf:"view",id:"olap",attr:"id.code",fieldLabel:"Код",allowBlank:!1,maskRe:/[A-Za-z0-9\_]/},{conf:"view",id:"olap",attr:"id.parent",fieldLabel:"Родитель",confRef:"view",choose:{type:"view",id:"system.views",attr:"olap.id",width:500,height:400}},{conf:"view",id:"olap",attr:"id.description",fieldLabel:"Описание",xtype:"textarea",height:150},{conf:"view",id:"olap",attr:"id.iconCls",fieldLabel:"Иконка",xtype:"$iconselector"}],active:{fn:function(){return!this.relatives.olap.getCurrentValue("schema_id")}}}},{cardConf:{id:"queryCard",title:"Запрос",iconCls:"gi_cogwheel",tbar:[{text:"Настройка столбцов таблицы",iconCls:"gi_table",handler:function(){var e=Ext.create("Ext.Window",{width:800,height:600,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:"Настройка столбцов таблицы",bodyPadding:5,modal:1,maximizable:!0,items:{xtype:"$querycolumns",viewId:this.up("*[name=views]").relatives.olap.getValue("id"),schemaId:this.up("*[name=views]").relatives.olap.getCurrentValue("schema_id")}});e.show()}}],listeners:{beforeSave:function(){var me=this,query=me.down("*[attr=id.query]").getValue();query=eval("("+query+")");var r=$o.execute({sql:query,noException:1});r.error&&common.message("Запрос составлен с ошибкой:\n"+r.error)}},items:[{flex:1,width:"100%",border:0,layout:"fit",items:[{conf:"view",id:"olap",attr:"id.query",hideLabel:!0,xtype:"$querydesigner"}]}],active:{fn:function(){return!this.relatives.olap.getCurrentValue("schema_id")}}}},{cardConf:{id:"layoutCard",title:"Макет",iconCls:"gi_table",items:[{flex:1,width:"100%",border:0,layout:"fit",items:[{conf:"view",id:"olap",attr:"id.layout",hideLabel:!0,xtype:"$layoutdesigner"}]}],active:{fn:function(){return!this.relatives.olap.getCurrentValue("schema_id")}}}}]}}]}},me.callParent(arguments)}}),Ext.define("$o.LayoutEditor",{extend:"Ext.panel.Panel",layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.tbar=[{text:"Ок",name:"ok",iconCls:"gi_ok",handler:e.save,scope:e},{text:"Отмена",name:"cancel",iconCls:"gi_remove",handler:function(){e.up("window").close()}},{text:"Преобразовать в разделитель",name:"make_split",iconCls:"gi_share_alt",handler:function(){var t=e.down("codemirrortextarea[name='json']"),s={split:{id:"cmp-"+e.layoutDesigner.counter++,orientation:"horizontal",width:"50%",items:[JSON.parse(t.getValue()),e.layoutDesigner.createEmpty()]}};t.setValue(JSON.stringify(s,null,"\t")),e.save({convertion:1})},scope:e},{text:"Преобразовать в закладки",name:"make_tab",iconCls:"gi_bookmark",handler:function(){var t=e.down("codemirrortextarea[name='json']"),s=JSON.parse(t.getValue());s[e.cmpCode].title=s[e.cmpCode].title||"Закладка";var n={tab:{id:"cmp-"+e.layoutDesigner.counter++,items:[s]}};t.setValue(JSON.stringify(n,null,"\t")),e.save({convertion:1})},scope:e}],e.addEvents("beforesave","aftersave","change"),this.callParent(arguments)},changeAttr:function(e,t){var s=this,n=s.down("codemirrortextarea[name='json']"),r=n.getValue();r=JSON.parse(r);for(var i=e.split("."),a=r[s.cmpCode],o=0;o<i.length;o++){if(a[i[o]]=a[i[o]]||{},o==i.length-1){a[i[o]]=t;break}a=a[i[o]]}"title"!=e||t||delete r[s.cmpCode][e],"filter"!=e||t&&0!=t.length||delete r[s.cmpCode][e],s.value=r,n.setValue(JSON.stringify(r,null,"\t"))},save:function(e){var t=this;t.fireEvent("beforesave",e);var s=t.down("codemirrortextarea[name='json']"),n=JSON.parse(s.getValue());t.value=n,t.fireEvent("aftersave",n),t.fireEvent("change",n)},getValue:function(){var e=this;return e.value}}),Ext.define("$o.LayoutOlap.Widget",{extend:"$o.LayoutEditor",alias:["widget.$o.layoutolap","widget.$layoutolap"],cmpCode:"olap",initComponent:function(){var e=this;e.value=e.value||{olap:{id:"cmp-"+e.layoutDesigner.counter++}};var t=null;e.value.olap.filter&&"string"==typeof e.value.olap.filter&&(t=$o.getAction(e.value.olap.filter).get("id")),e.items={xtype:"tabpanel",items:[{layout:"vbox",title:"Общие",iconCls:"gi_edit",bodyPadding:5,items:[{xtype:"textfield",width:"100%",labelWidth:150,fieldLabel:"Идентификатор",name:"id",style:"margin-top: 5px;",value:e.value.olap.id,listeners:{change:function(){e.changeAttr("id",this.getValue()),e.down("*[name=filter]").setCmpId(this.getValue())}}},{xtype:"textfield",labelWidth:150,width:"100%",fieldLabel:"Заголовок",name:"title",value:e.value.olap.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}}},{xtype:"$iconselector",labelWidth:150,width:"100%",name:"iconCls",value:e.value.olap.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}},{xtype:"$conffield",fieldLabel:"Запрос",labelWidth:150,name:"view",value:e.value.olap.view,width:"100%",confRef:"view",choose:{type:"custom",fn:function(){var e=this;dialog.getView({hasQuery:1,success:function(t){e.setValue(t.id)}})}},listeners:{afterrender:function(){e.validator()},change:function(){e.validator();var t=this.getValue()?$o.getView(this.getValue()).getFullCode():void 0;e.changeAttr("view",t),e.down("*[name=filter]").setViewId(t?$o.getView(t).get("id"):null),e.down("*[name=total]").setViewId(t?$o.getView(t).get("id"):null)}}},{xtype:"checkbox",width:"100%",name:"wordWrap",labelWidth:150,fieldLabel:"Перенос по словам",checked:e.value.olap.wordWrap,listeners:{change:function(){e.changeAttr("wordWrap",this.getValue())}}},{xtype:"checkbox",width:"100%",name:"groupedColumns",labelWidth:150,fieldLabel:"Многоуровневый заголовок",checked:e.value.olap.groupedColumns,listeners:{change:function(){e.changeAttr("groupedColumns",this.getValue())}}},{fieldLabel:"Фильтр из действия",xtype:"$conffield",labelWidth:150,name:"filterAction",value:t,width:"100%",confRef:"action",choose:{type:"custom",fn:function(){var e=this;dialog.getAction({success:function(t){e.setValue(t.id)}})}},listeners:{change:function(t){t?(t=$o.getAction(t).getFullCode(),e.down("*[name=filter]").setValue(null),e.down("*[name=filter]").disable()):e.down("*[name=filter]").enable(),e.changeAttr("filter",t)}}},{layout:"hbox",width:"100%",border:0,flex:1,items:[{layout:"fit",width:"30%",height:"100%",title:"Меню",iconCls:"gi_list",bodyPadding:2,items:{xtype:"$actiondesigner",name:"actions",value:e.value.olap.actions,listeners:{change:function(t){e.changeAttr("actions",t)}}}},{layout:"fit",width:"40%",height:"100%",title:"Фильтр",iconCls:"gi_filter",bodyPadding:2,style:"margin-left: 1px",items:{xtype:"$layoutfilter",name:"filter",layoutDesigner:e.layoutDesigner,disabled:!!t,value:t?null:e.value.olap.filter,$cmpId:e.value.olap.id,$viewId:e.value.olap.view,listeners:{change:function(t){e.changeAttr("filter",t),e.validator.call(this)}}}},{layout:"fit",width:"30%",height:"100%",title:"Итоги",iconCls:"gi_calculator",bodyPadding:2,style:"margin-left: 1px",items:{xtype:"$layouttotal",name:"total",layoutDesigner:e.layoutDesigner,value:e.value.olap.total,viewId:e.value.olap.view?$o.getView(e.value.olap.view).get("id"):null,listeners:{change:function(t){e.changeAttr("total",t)}}}}]}]},{layout:"fit",title:"События",iconCls:"gi_wifi_alt",border:0,items:{xtype:"$eventdesigner",name:"events",value:e.value.olap.listeners,$events:["afterrender","dblclick","cellRenderer"],listeners:{changeevent:function(t){e.changeAttr("listeners",t)}}}},{layout:"fit",title:"Исходный код",iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)},validator:function(){var e=this,t=e.down("*[name='view']");return t.getValue()?$o.getView(t.getValue()).get("query")?e.down("button[name='ok']").enable():(common.message("Выбранное представление не содержит запрос."),e.down("button[name='ok']").disable()):e.down("button[name='ok']").disable(),!0}}),Ext.define("$o.LayoutTreegrid.Widget",{extend:"$o.LayoutEditor",alias:["widget.$o.layouttreegrid","widget.$layouttreegrid"],cmpCode:"treegrid",initComponent:function(){var e=this;e.value=e.value||{treegrid:{id:"cmp-"+e.layoutDesigner.counter++}};var t=e.getData();e.items={xtype:"tabpanel",items:[{layout:"vbox",title:"Общие",iconCls:"gi_edit",bodyPadding:5,items:[{xtype:"textfield",width:"100%",fieldLabel:"Идентификатор",name:"id",style:"margin-top: 5px;",value:e.value.treegrid.id,listeners:{change:function(){e.changeAttr("id",this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:"Заголовок",name:"title",value:e.value.treegrid.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}},validator:e.validator},{xtype:"$iconselector",width:"100%",name:"iconCls",value:e.value.treegrid.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}},{xtype:"$conffield",fieldLabel:"Запрос",name:"view",value:e.value.treegrid.view,width:"100%",confRef:"view",choose:{type:"custom",fn:function(){var t=this;dialog.getView({hasQuery:1,success:function(s){t.setValue(s.id),e.changeAttr("view",s.id?$o.getView(s.id).getFullCode():void 0);var n=e.getData();e.down("*[name='idAttr']").getStore().loadData(n),e.down("*[name='idAttr']").setValue(null),e.down("*[name='parent']").getStore().loadData(n),e.down("*[name='parent']").setValue(null),e.validator.call(t)}})}},listeners:{afterrender:function(){e.validator.call(this)}}},{xtype:"combo",fieldLabel:"Идентификатор узла",name:"idAttr",width:"100%",mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:t}),valueField:"id",displayField:"text",value:e.value.treegrid.fields?e.value.treegrid.fields.id:null,validator:e.validator},{xtype:"combo",fieldLabel:"Идентификатор родительского узла",name:"parent",width:"100%",mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:t}),valueField:"id",displayField:"text",value:e.value.treegrid.fields?e.value.treegrid.fields.parent:null,validator:e.validator},{layout:"fit",width:"100%",flex:1,title:"Меню",iconCls:"gi_list",bodyPadding:2,items:{xtype:"$actiondesigner",name:"actions",value:e.value.treegrid.actions,listeners:{change:function(t){e.changeAttr("actions",t)}}}}]},{layout:"fit",title:"События",iconCls:"gi_wifi_alt",border:0,items:{xtype:"$eventdesigner",name:"events",value:e.value.treegrid.listeners,$events:["dblclick"],listeners:{changeevent:function(t){e.changeAttr("listeners",t)}}}},{layout:"fit",title:"Исходный код",iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)},getData:function(){var e=this,t=[];if(e.value.treegrid.view){var s=$o.getView(e.value.treegrid.view);for(var n in s.attrs){var r=s.attrs[n];if(r.get("classAttr")){var i=$o.getClassAttr(r.get("classAttr"));if(!(2==i.get("type")||12==i.get("type")||i.get("type")>=1e3))continue}t.push([n,r.toString()])}}return t},validator:function(){var e=this.up("panel[cmpCode='treegrid']"),t=e.down("*[name='view']"),s=e.down("*[name='idAttr']"),n=e.down("*[name='parent']");return s.getValue()&&n.getValue()&&s.getValue()!=n.getValue()?(s.getValue()&&n.getValue()&&e.changeAttr("fields",{id:s.getValue(),parent:n.getValue()}),t.getValue()?$o.getView(t.getValue()).get("query")?e.down("button[name='ok']").enable():(common.message("Выбранное представление не содержит запрос."),e.down("button[name='ok']").disable()):e.down("button[name='ok']").disable(),!0):(e.down("button[name='ok']").disable(),!0)}}),Ext.define("$o.LayoutSplit.Widget",{extend:"$o.LayoutEditor",alias:["widget.$o.layoutsplit"],cmpCode:"split",initComponent:function(){var e=this;e.value=e.value||{split:{id:"cmp-"+e.layoutDesigner.counter++,orientation:"horizontal",width:"50%",items:[e.layoutDesigner.createEmpty(),e.layoutDesigner.createEmpty()]}};var t,s=e.value.split.width||e.value.split.height;"string"==typeof s?(t="%",s=s.substr(0,s.length-1)):t="px",e.items={xtype:"tabpanel",items:[{layout:"vbox",title:"Общие",iconCls:"gi_edit",bodyPadding:5,items:[{xtype:"textfield",width:"100%",fieldLabel:"Идентификатор",name:"id",style:"margin-top: 5px;",value:e.value.split.id,listeners:{change:function(){e.changeAttr("id",this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:"Заголовок",name:"title",value:e.value.split.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}}},{xtype:"$iconselector",width:"100%",name:"iconCls",value:e.value.split.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}},{xtype:"combo",fieldLabel:"Ориентация",name:"orientation",width:"100%",triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["horizontal","Горизонтальный"],["vertical","Вертикальный"]]}),valueField:"id",displayField:"text",style:"margin-top: 5px;",value:e.value.split.orientation,listeners:{select:function(){e.changeAttr("orientation",this.getValue())}}},{xtype:"compositefield",fieldLabel:"Ширина (высота) левого (верхнего) компонента",items:[{xtype:"numberfield",name:"width",value:s,width:100,validator:function(t){return this.getValue()?e.down("button[name='ok']").enable():e.down("button[name='ok']").disable(),"%"==e.down("*[name=ed]").getValue()?e.changeAttr("width",this.getValue()+"%"):e.changeAttr("width",Number(this.getValue())),!0}},{xtype:"combo",name:"ed",width:50,triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["%","%"],["px","px"]]}),valueField:"id",displayField:"text",style:"margin-left: 2px;",value:t,listeners:{select:function(){"%"==this.getValue()?(e.down("*[name=width]").getValue()>90&&e.down("*[name=width]").setValue(90),e.changeAttr("width",e.down("*[name=width]").getValue()+"%")):e.changeAttr("width",Number(e.down("*[name=width]").getValue()))}}}]}]},{layout:"fit",title:"Исходный код",iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)}}),Ext.define("$o.LayoutTab.Widget",{extend:"$o.LayoutEditor",alias:["widget.$o.layouttab"],cmpCode:"tab",initComponent:function(){var e=this,t=e.layoutDesigner.createEmpty();t.panel.title="Закладка",e.value=e.value||{tab:{id:"cmp-"+e.layoutDesigner.counter++,items:[t]}},e.items={xtype:"tabpanel",items:[{layout:"vbox",title:"Общие",iconCls:"gi_edit",bodyPadding:5,items:[{xtype:"textfield",width:"100%",fieldLabel:"Идентификатор",name:"id",style:"margin-top: 5px;",value:e.value.tab.id,listeners:{change:function(){e.changeAttr("id",this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:"Заголовок",name:"title",value:e.value.tab.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}}},{xtype:"$iconselector",width:"100%",name:"iconCls",value:e.value.tab.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}}]},{layout:"fit",title:"Исходный код",iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)}}),Ext.define("$o.LayoutCondition.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.layoutcondition","widget.$layoutcondition"],layout:"vbox",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.filter=e.filter||[],e.value={},e.tbar=[{text:"Ок",iconCls:"gi_ok",name:"save",disabled:1,handler:e.save,scope:e},{text:"Отмена",iconCls:"gi_remove",name:"cancel",handler:function(){e.up("window").close()}}];var t=[];for(var s in e.$view.attrs){var n=e.$view.attrs[s];t.push([s,n.toString()])}e.items=[{xtype:"combo",fieldLabel:"И/ИЛИ",labelWidth:200,name:"and_or",width:350,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["and","И"],["or","ИЛИ"]]}),valueField:"id",displayField:"text"},{xtype:"combo",fieldLabel:"Атрибут этого компонента",name:"attr",width:"100%",labelWidth:200,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:t}),valueField:"id",displayField:"text",validator:e.validator},{xtype:"combo",fieldLabel:"Оператор",labelWidth:200,name:"oper",width:350,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["=","равно (=)"],["<>","не равно (<>)"],["<","меньше (<)"],[">","больше (>)"],["<=","меньше или равно (<=)"],[">=","больше или равно (>=)"],["is null","пусто (is null)"],["is not null","не пусто (is not null)"],["in","одно из перечня (in)"]]}),valueField:"id",displayField:"text",listeners:{select:function(){var t=this.getValue();"is null"==t||"is not null"==t?(e.down("*[name='value']").disable(),e.down("*[name='attrValue']").disable()):(e.down("*[name='value']").enable(),"in"==t?e.down("*[name='attrValue']").disable():e.down("*[name='attrValue']").enable())}},validator:e.validator},{xtype:"textfield",fieldLabel:"Значение",labelWidth:200,width:"100%",name:"value",validator:e.validator},{xtype:"combo",fieldLabel:"Атрибут другого компонента",name:"attrValue",width:"100%",labelWidth:200,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:e.getOtherAttrs()}),valueField:"id",displayField:"text",validator:e.validator}],e.filter.length||e.items.splice(0,1),e.items[0].style="margin-top: 5px;",e.addEvents("aftersave"),this.callParent(arguments)},validator:function(e){var t=this.up("panel"),s=t.down("*[name='and_or']"),n=t.down("*[name='attr']"),r=t.down("*[name='oper']"),i=t.down("*[name='value']"),a=t.down("*[name='attrValue']");if(s&&!s.getValue())return t.down("button[name='save']").disable(),!0;if(n.getValue()&&r.getValue()&&("is null"==r.getValue()||"is not null"==r.getValue()||i.getValue()||a.getValue())){if(t.down("button[name='save']").enable(),"is null"==r.getValue()||"is not null"==r.getValue())t.value=[n.getValue(),r.getValue()];else{var o=i.getValue();if(a.getValue()){var l=a.getValue();o={id:l.split(":")[0],attr:l.split(":")[1]}}t.value=[n.getValue(),r.getValue(),o]}s&&(t.value=[s.getValue()].concat(t.value))}else t.down("button[name='save']").disable(),t.value=[];return!0},getOtherAttrs:function(){var e=this,t=[],s=function(n){if("object"==typeof n)for(var r in n)if(n[r]){if(n[r].id&&n[r].view&&n[r].id!=e.$cmpId){var i=$o.getView(n[r].view);for(var a in i.attrs)t.push([n[r].id+":"+a,n[r].id+":"+i.attrs[a].toString()])}s(n[r])}};return s(e.layoutDesigner.value),t},save:function(){var e=this;e.fireEvent("aftersave",e.value)},getValue:function(){var e=this;return e.value}}),Ext.define("$o.LayoutFilter.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.layoutfilter","widget.$layoutfilter"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.value=e.value||[],e.classMode||(e.$view=$o.getView(e.$viewId));var t=e.getItems();t.width="100%",t.flex=1,e.items=t,e.tbar=[{text:"Добавить",name:"create",iconCls:"gi_circle_plus",handler:e.createCondition,scope:e},{text:"Очистить",name:"delete",iconCls:"gi_circle_minus",scope:e,handler:function(){e.value=[],e.build(),e.fireEvent("change",e.value)}}],e.addEvents("change"),this.callParent(arguments)},build:function(){var e=this,t=e.getItems();e.removeAll(),e.add(t),e.doLayout()},createCondition:function(){var e=this,t="$o.layoutcondition";e.classMode&&(t="$o.querycondition"),e.reportMode&&(t="$o.reportcondition");var s=Ext.create("Ext.Window",{width:600,height:400,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:"Условие",iconCls:"gi_filter",bodyPadding:5,modal:1,items:{xtype:t,filter:e.value,$cmpId:e.$cmpId,$view:e.$view,$classes:e.$classes,$classAliases:e.$classAliases,$aliases:e.$aliases,layoutDesigner:e.layoutDesigner,listeners:{aftersave:function(t){s.close(),e.value=e.value||[],e.value=e.value.concat(t),e.build(),e.fireEvent("change",e.value)}}}});s.show()},getItems:function(){function e(n,r){for(var i=0;i<n.length;i++){var a=(r?r:"")+(i+1)+".",o="";if(a.split(".").length>2)for(var l=0;l<a.length;l++)o+="_";Ext.isArray(n[i])?e(n[i],a):("and"==n[i+2]||"or"==n[i+2]||i==n.length-2?(s.push({attr:o+t.getAttrName(n[i]),oper:t.getOperName(n[i+1])}),i+=2):(s.push({attr:o+t.getAttrName(n[i]),oper:t.getOperName(n[i+1]),value:t.getValueName(n[i+2])}),i+=3),i<n.length&&s.push({attr:o+("and"==n[i]?"И":"ИЛИ")}))}}var t=this,s=[];t.value&&e(t.value);var n=Ext.create("Ext.data.Store",{data:s,fields:[{name:"attr",type:"string"},{name:"oper",type:"string"},{name:"value",type:"string"}]}),r=Ext.create("Ext.grid.Panel",{store:n,columns:[{header:"Атрибут",width:100,dataIndex:"attr",renderer:t.cellRenderer},{header:"Оператор",width:100,dataIndex:"oper",renderer:t.cellRenderer},{header:"Значение",width:100,dataIndex:"value",renderer:t.cellRenderer}],forceFit:!0,frame:!1,deferRowRender:!1});return r},getAttrName:function(e,t){var s=this,n=e;if(t&&$o.getView(t).attrs[e])n=$o.getView(t).attrs[e].toString();else if(!s.classMode&&s.$view.attrs[e])n=s.$view.attrs[e].toString();else if(s.classMode&&"object"==typeof e){var r;for(r in e)break;for(var i=0;i<s.$aliases.length;i++)if(s.$aliases[i]==r){var a=$o.getClass(s.$classes[i]);if(a.attrs[e[r]]){n=r+":"+a.attrs[e[r]].toString();break}}}return n},getOperName:function(e){var t={};return t["="]="равно (=)",t["<>"]="не равно (<>)",t["<"]="меньше (<)",t[">"]="больше (>)",t["<="]="меньше или равно (<=)",t[">="]="больше или равно (>=)",t["is null"]="пусто (is null)",t["is not null"]="не пусто (is not null)",t.in="одно из перечня (in)",t[e]},getValueName:function(e){var t=this;if(Ext.isArray(e))return e.join(", ");if("object"==typeof e){if(t.classMode)return t.getAttrName(e);var s=t.layoutDesigner.getCmp(e.id),n=t.layoutDesigner.getCmpCode(e.id),r=s[n].view;return t.getAttrName(e.attr,r)}return e},cellRenderer:function(e,t,s,n,r,i){if(e){var a=e;"string"==typeof a&&(a=a.split('"').join("'")),t.tdAttr='data-qtip="'+a+'"'}return e},setValue:function(e){var t=this;t.value=e,t.build()},setViewId:function(e){var t=this;t.$viewId=e,t.$view=$o.getView(t.$viewId)},setCmpId:function(e){var t=this;t.$cmpId=e},setClasses:function(e,t,s){var n=this;n.$classes=e,n.$classAliases=t,n.$aliases=s},getValue:function(){var e=this;return e.value}}),Ext.define("$o.LayoutCard.Widget",{extend:"$o.LayoutEditor",layout:"fit",border:!1,defaults:{border:!1},alias:["widget.$o.layoutcard","widget.$layoutcard"],cmpCode:"card",initComponent:function(){var e=this,t=e.layoutDesigner?"cmp-"+e.layoutDesigner.counter++:"card";e.value=e.value||{card:{id:t,items:[]}},e.value.card.object=e.value.card.object||[],Ext.isArray(e.value.card.object)||(e.value.card.object=[e.value.card.object]);var s=[{layout:"column",border:0,width:"100%",items:[{columnWidth:.5,border:0,items:[{xtype:"compositefield",width:375,labelWidth:100,fieldLabel:"Идентификатор",style:"margin-top: 5px;",items:[{xtype:"textfield",name:"id",value:e.value.card.id,listeners:{change:function(){e.changeAttr("id",this.getValue())}}},{xtype:"displayfield",value:"Только для чтения:",style:"margin-left: 5px;"},{xtype:"checkbox",name:"readOnly",value:e.value.card.readOnly,listeners:{change:function(){e.changeAttr("readOnly",this.getValue())}}}]},{xtype:"textfield",labelWidth:100,width:375,fieldLabel:"Заголовок",name:"title",value:e.value.card.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}}},{xtype:"$iconselector",labelWidth:100,width:375,name:"iconCls",value:e.value.card.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}}]},{columnWidth:.5,border:0,style:"margin-left: 5px",items:[{xtype:"grid",name:"tags",store:{xtype:"store",fields:["clsName","cls","tag","cmpAttrName","cmpAttr"],data:[]},columns:[{text:"Класс объекта",dataIndex:"clsName",flex:2},{text:"Тэг объекта",dataIndex:"tag",flex:1},{text:"Объект по атрибуту компонента",dataIndex:"cmpAttrName",flex:2},{text:"cls",dataIndex:"cls",hidden:!0},{text:"cmpAttr",dataIndex:"cmpAttr",hidden:!0}],tbar:[{text:"Добавить",iconCls:"gi_circle_plus",handler:function(){var t=Ext.create("Ext.Window",{title:"Добавление тэга",width:600,height:400,layout:"vbox",bodyPadding:5,border:!1,resizable:!0,closable:!0,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",tbar:[{text:"Добавить",iconCls:"gi_circle_plus",handler:function(){var s=e.down("*[name=tags]").getStore(),n=t.down("*[name=cls]").getValue(),r=t.down("*[name=tag]").getValue();s.insert(s.getCount(),{cls:n,clsName:n?$o.getClass(n).toString():null,tag:r,cmpAttr:t.down("*[name=cmpAttr]").getValue()}),n?e.value.card.object.push({cls:$o.getClass(n).getFullCode(),tag:r}):e.value.card.object.push({tag:r}),t.close()}}],items:[{xtype:"$conffield",fieldLabel:"Класс объекта",labelWidth:200,name:"cls",width:"100%",confRef:"class",choose:{type:"custom",fn:function(){var e=this;dialog.getClass({success:function(t){e.setValue(t.id)}})}}},{xtype:"textfield",fieldLabel:"Тэг объекта",labelWidth:200,width:"100%",name:"tag"},{xtype:"combo",fieldLabel:"Объект по атрибуту компонента",name:"cmpAttr",anchor:"100%",labelWidth:200,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:e.layoutDesigner?e.getViewCmpAttrs(JSON.parse(e.layoutDesigner.getValue())):[]}),width:"100%",valueField:"id",displayField:"text"}]});t.show()}},{text:"Удалить",iconCls:"gi_circle_minus",handler:function(){var t=e.down("*[name=tags]");if(t.getSelectionModel().hasSelection()){for(var s=t.getSelectionModel().getSelection()[0],n=0;n<e.value.card.object.length;n++){if(s.get("cls")){var r=$o.getClass(s.get("cls"));if(r.getFullCode()==e.value.card.object[n].cls){e.value.card.object.splice(n,1);break}}if(s.get("cmpAttr")&&s.get("cmpAttr")==e.value.card.object[n].cmpAttr){e.value.card.object.splice(n,1);break}}t.getStore().remove(s)}}}],width:"100%",forceFit:!0,height:90,border:1,selModel:Ext.create("Ext.selection.RowModel",{mode:"SINGLE",listeners:{selectionchange:function(t,s){if(s.length){var n=s[0].get("cls");e.down("*[name=cardDesigner]").setClassId(n,s[0].get("tag")),e.down("*[name=cardDesigner]").down("*[name=tree]").getSelectionModel().deselectAll()}},scope:e}}),listeners:{afterrender:function(){if(e.value.card.object){Ext.isArray(e.value.card.object)||(e.value.card.object=[e.value.card.object]);for(var t=0;t<e.value.card.object.length;t++){var s=$o.getClass(e.value.card.object[t].cls);e.value.card.object[t].cls=s.get("id"),e.value.card.object[t].clsName=s.toString()}this.getStore().loadData(e.value.card.object)}}}}]}]}];s.push({layout:"fit",title:"Атрибуты карточки",name:"cardDesigner",width:"100%",border:1,flex:1,xtype:"$carddesigner",layoutCard:e,value:e.value.card.items}),e.items={xtype:"tabpanel",items:[{layout:"vbox",title:"Общие",iconCls:"gi_edit",bodyPadding:5,items:s},{layout:"fit",title:"События",iconCls:"gi_wifi_alt",border:0,items:{xtype:"$eventdesigner",name:"events",value:e.value.card.listeners,$events:["aftersave","afterrender","beforerender"],listeners:{changeevent:function(t){e.changeAttr("listeners",t)}}}},{layout:"fit",title:"Исходный код",iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},e.addEvents("change"),e.on("beforesave",function(t){if(!t.convertion){e.value.card.items=e.down("*[name=cardDesigner]").getValue();for(var s=0;s<e.value.card.object.length;s++)delete e.value.card.object[s].clsName,e.value.card.object[s].cls=$o.getClass(e.value.card.object[s].cls).getFullCode();e.down("*[name=json]").setValue(JSON.stringify(e.value,null,"\t"))}}),this.callParent(arguments)},validator:function(){var e=this.up("panel");return e.down("*[name=cls]").getValue()&&(e.down("*[name=tag]").getValue()||e.down("*[name=cmpAttr]").getValue())?e.up("window").down("button[name=ok]").enable():e.up("window").down("button[name=ok]").disable(),!0},getViewCmpAttrs:function(layout){var me=this;try{"string"==typeof layout&&(layout=eval("("+layout+")"))}catch(e){}if(!layout)return[];var data=[];me.cmpAttrId={};var get=function(e){if("object"==typeof e)for(var t in e)if(e[t]){if(e[t].id&&e[t].view){v=$o.getView(e[t].view);for(var s in v.attrs){var n=v.attrs[s];if(n.get("classAttr")){var r=$o.getClassAttr(n.get("classAttr"));if(!(2==r.get("type")||12==r.get("type")||r.get("type")>=1e3))continue}data.push([e[t].id+"."+s,e[t].id+":"+n.toString()]),me.cmpAttrId[e[t].id+"."+s]=n.get("id")}}get(e[t])}};return get(layout),data},setValue:function(e){var t=this;t.value=e,t.value.card.object=t.value.card.object||[],Ext.isArray(t.value.card.object)||(t.value.card.object=[t.value.card.object]),t.down("*[name=json]").setValue(JSON.stringify(e,null,"\t")),t.build()},getValue:function(){var e=this;return e.value}}),Ext.define("$o.LayoutTotal.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.layouttotal","widget.$layouttotal"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.value=e.value||{},e.tbar=[{text:"Очистить",name:"delete",iconCls:"gi_circle_minus",scope:e,handler:function(){e.value={},e.build(),e.fireEvent("change",e.value)}}],e.store=Ext.create("Ext.data.Store",{data:[],autoSync:!0,fields:[{name:"attr",type:"string"},{name:"total",type:"string"}],listeners:{datachanged:e.datachanged,scope:e}});var t=new Ext.grid.plugin.CellEditing({clicksToEdit:1});e.grid=Ext.create("Ext.grid.Panel",{store:e.store,columns:[{header:"Атрибут",dataIndex:"attr"},{header:"Итог",width:100,dataIndex:"total",editor:{xtype:"combo",mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["sum","Сумма"],["avg","Среднее"],["max","Максимальное"],["min","Минимальное"]]}),valueField:"id",displayField:"text"},renderer:function(e,t,s,n,r,i){switch(t.tdAttr+=' style=";border: 1px gray solid;"',e){case"sum":e="Сумма";break;case"avg":e="Среднее";break;case"max":e="Максимальное";break;case"min":e="Минимальное"}return e}}],plugins:[t],forceFit:!0,frame:!1,deferRowRender:!1}),e.items=e.grid,e.addEvents("change"),e.build(),this.callParent(arguments)},datachanged:function(){var e=this;if(e.store){e.value={};for(var t=0;t<e.store.getCount();t++)e.store.getAt(t).get("total")&&(e.value[e.store.getAt(t).get("attr")]=e.store.getAt(t).get("total"));
e.fireEvent("change",e.value)}},setViewId:function(e){var t=this;t.viewId!=e&&(t.value={}),t.viewId=e,t.build()},build:function(){var e=this,t=$o.getView(e.viewId)||{},s=[];for(var n in t.attrs){var r=t.attrs[n];r.get("classAttr")&&2!=$o.getClassAttr(r.get("classAttr")).get("type")||s.push([n,e.value[n]])}e.store.loadData(s)}}),Ext.define("$o.LayoutChart.Widget",{extend:"$o.LayoutEditor",alias:["widget.$o.layoutchart","widget.$layoutchart"],cmpCode:"chart",border:1,initComponent:function(){var e=this;e.value=e.value||{chart:{id:"cmp-"+e.layoutDesigner.counter++}},e.storeMark=new Ext.data.ArrayStore({fields:["id","text"],data:[]}),e.storeValue=new Ext.data.ArrayStore({fields:["id","text"],data:[]}),e.items={xtype:"tabpanel",items:[{layout:"vbox",title:"Общие",iconCls:"gi_edit",bodyPadding:5,items:[{xtype:"textfield",width:"100%",fieldLabel:"Идентификатор",name:"id",style:"margin-top: 5px;",value:e.value.chart.id,listeners:{change:function(){e.changeAttr("id",this.getValue()),e.down("*[name=filter]").setCmpId(this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:"Заголовок",name:"title",value:e.value.chart.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}}},{xtype:"$iconselector",width:"100%",name:"iconCls",value:e.value.chart.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}},{xtype:"$conffield",fieldLabel:"Запрос",name:"view",value:e.value.chart.view,width:"100%",confRef:"view",choose:{type:"custom",fn:function(){var e=this;system.view.selectQuery({success:function(t){e.setValue(t.value),e.fireEvent("change",t.value)}})}},listeners:{afterrender:function(){e.validator()},change:function(){e.validator.call(this);var t=this.getValue()?$o.getView(this.getValue()).getFullCode():void 0;e.changeAttr("view",t),e.down("*[name=filter]").setViewId(t?$o.getView(t).get("id"):null),e.updateStores(this.getValue())}}},{xtype:"combo",fieldLabel:"Атрибут показателя",name:"attrMark",width:"100%",mode:"local",queryMode:"local",editable:!1,store:e.storeMark,value:e.value.chart.attrMark,valueField:"id",displayField:"text",validator:e.validator,listeners:{select:function(){e.changeAttr("attrMark",this.getValue())}}},{xtype:"combo",fieldLabel:"Атрибут значения",name:"attrValue",width:"100%",mode:"local",queryMode:"local",editable:!1,store:e.storeValue,value:e.value.chart.attrValue,valueField:"id",displayField:"text",validator:e.validator,listeners:{select:function(){e.changeAttr("attrValue",this.getValue())}}},{xtype:"textfield",fieldLabel:"Заголовок показателей",width:"100%",name:"titleMark",validator:e.validator,value:e.value.chart.titleMark,listeners:{change:function(){e.changeAttr("titleMark",this.getValue())}}},{xtype:"textfield",fieldLabel:"Заголовок значений",width:"100%",name:"titleValue",validator:e.validator,value:e.value.chart.titleValue,listeners:{change:function(){e.changeAttr("titleValue",this.getValue())}}},{layout:"fit",width:"100%",flex:1,title:"Фильтр",iconCls:"gi_filter",bodyPadding:2,items:{xtype:"$layoutfilter",name:"filter",layoutDesigner:e.layoutDesigner,value:e.value.chart.filter,$cmpId:e.value.chart.id,$viewId:e.value.chart.view,listeners:{change:function(t){e.changeAttr("filter",t),e.validator.call(this)}}}}]},{layout:"fit",title:"Исходный код",iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)},updateStores:function(e){var t=this;t.down("*[name=attrMark]").setValue(null),t.down("*[name=attrValue]").setValue(null);var s=[];if(e){var n=$o.getView(e);for(var r in n.attrs)s.push([r,n.attrs[r].toString()])}if(t.storeMark.loadData(s),s=[],e){var n=$o.getView(e);for(var r in n.attrs){var i=n.attrs[r];i.get("classAttr")&&2!=$o.getClassAttr(i.get("classAttr")).get("type")||s.push([r,i.toString()])}}t.storeValue.loadData(s)},validator:function(){var e=this.up("window");return e.down("*[name=view]").getValue()&&e.down("*[name=attrMark]").getValue()&&e.down("*[name=attrValue]").getValue()?e.down("button[name='ok']").enable():e.down("button[name='ok']").disable(),!0}}),Ext.define("$o.LayoutImage.Widget",{extend:"$o.LayoutEditor",alias:["widget.$o.layoutimage","widget.$layoutimage"],cmpCode:"image",border:1,initComponent:function(){var e=this;e.value=e.value||{image:{id:"cmp-"+e.layoutDesigner.counter++}},e.store=new Ext.data.ArrayStore({fields:["id","text"],data:e.getOtherAttrs()}),e.items={xtype:"tabpanel",items:[{layout:"vbox",title:"Общие",iconCls:"gi_edit",bodyPadding:5,items:[{xtype:"textfield",width:"100%",fieldLabel:"Идентификатор",name:"id",style:"margin-top: 5px;",value:e.value.image.id,validator:e.validator,listeners:{change:function(){e.changeAttr("id",this.getValue()),e.down("*[name=filter]").setCmpId(this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:"Заголовок",name:"title",value:e.value.image.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}}},{xtype:"$iconselector",width:"100%",name:"iconCls",value:e.value.image.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:"Ссылка (URL)",name:"url",value:e.value.image.url,validator:e.validator,listeners:{change:function(){e.changeAttr("url",this.getValue()),e.down("*[name=attr]").setValue(null)}}},{xtype:"combo",fieldLabel:"Атрибут компонента",name:"attr",width:"100%",mode:"local",queryMode:"local",editable:!1,store:e.store,value:e.value.image.attr,valueField:"id",displayField:"text",validator:e.validator,listeners:{select:function(){e.changeAttr("attr",this.getValue()),e.down("*[name=url]").setValue(null)}}},{xtype:"numberfield",width:300,fieldLabel:"Ширина",name:"width",value:e.value.image.width,validator:e.validator,listeners:{change:function(){e.changeAttr("width",this.getValue())}}},{xtype:"numberfield",width:300,fieldLabel:"Высота",name:"height",value:e.value.image.height,validator:e.validator,listeners:{change:function(){e.changeAttr("height",this.getValue())}}}]},{layout:"fit",title:"Исходный код",iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)},getOtherAttrs:function(){var e=this,t=[],s=function(n){function r(e){if(e)for(var s=0;s<e.length;s++){var a=e[s],o=c.attrs[a.attr];a.objectId&&a.attr&&o&&5==o.get("type")&&t.push([n[i].id+"."+a.attr,n[i].id+":"+o.toString()]),a.items&&r(a.items)}}if("object"==typeof n)for(var i in n)if(n[i]){if(n[i].id&&n[i].id!=e.$cmpId){if(n[i].view){var a=$o.getView(n[i].view);for(var o in a.attrs){var l=a.attrs[o];l.get("classAttr")&&5==$o.getClassAttr(l.get("classAttr")).get("type")&&t.push([n[i].id+"."+o,n[i].id+":"+l.toString()])}}if("card"==i&&n[i].object&&n[i].object.cls){var c=$o.getClass(n[i].object.cls);r(n[i].items)}}s(n[i])}};return s(e.layoutDesigner.value),t},validator:function(){var e=this.up("window");return e.down("*[name=id]").getValue()&&(e.down("*[name=url]").getValue()||e.down("*[name=attr]").getValue())?e.down("button[name='ok']").enable():e.down("button[name='ok']").disable(),!0}}),Ext.define("$o.LayoutFrame.Widget",{extend:"$o.LayoutEditor",alias:["widget.$o.layoutframe","widget.$layoutframe"],cmpCode:"frame",border:0,initComponent:function(){var e=this;e.value=e.value||{frame:{id:"cmp-"+e.layoutDesigner.counter++}},e.store=new Ext.data.ArrayStore({fields:["id","text"],data:e.getOtherAttrs()}),e.items={xtype:"tabpanel",items:[{layout:"vbox",title:"Общие",iconCls:"gi_edit",bodyPadding:5,items:[{xtype:"textfield",width:"100%",fieldLabel:"Идентификатор",name:"id",style:"margin-top: 5px;",value:e.value.frame.id,validator:e.validator,listeners:{change:function(){e.changeAttr("id",this.getValue()),e.down("*[name=filter]").setCmpId(this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:"Заголовок",name:"title",value:e.value.frame.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}}},{xtype:"$iconselector",width:"100%",name:"iconCls",value:e.value.frame.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:"Ссылка (URL)",name:"url",value:e.value.frame.url,validator:e.validator,listeners:{change:function(){e.changeAttr("url",this.getValue()),e.down("*[name=attr]").setValue(null)}}},{xtype:"combo",fieldLabel:"Атрибут компонента",name:"attr",width:"100%",mode:"local",queryMode:"local",editable:!1,store:e.store,value:e.value.frame.attr,valueField:"id",displayField:"text",validator:e.validator,listeners:{select:function(){e.changeAttr("attr",this.getValue()),e.down("*[name=url]").setValue(null)}}}]},{layout:"fit",title:"Исходный код",iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)},getOtherAttrs:function(){var e=this,t=[],s=function(n){if("object"==typeof n)for(var r in n)if(n[r]){if(n[r].id&&n[r].view&&n[r].id!=e.$cmpId){var i=$o.getView(n[r].view);for(var a in i.attrs){var o=i.attrs[a];"olap"!=r&&"treegrid"!=r||!o.get("classAttr")||1!=$o.getClassAttr(o.get("classAttr")).get("type")||t.push([n[r].id+"."+a,n[r].id+":"+o.toString()])}}s(n[r])}};return s(e.layoutDesigner.value),t},validator:function(){var e=this.up("window");return e.down("*[name=id]").getValue()&&(e.down("*[name=url]").getValue()||e.down("*[name=attr]").getValue())?e.down("button[name='ok']").enable():e.down("button[name='ok']").disable(),!0}}),Ext.define("$o.ActionDesigner.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.actiondesigner","widget.$actiondesigner"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.tbar=[{text:"Открыть",iconCls:"gi_edit",handler:e.edit,scope:e},{text:"Добавить",iconCls:"gi_circle_plus",handler:e.create,scope:e},{text:"Удалить",iconCls:"gi_circle_minus",handler:e.remove,scope:e}],e.store=Ext.create("Ext.data.Store",{data:[],fields:[{name:"action",type:"string"},{name:"id",type:"string"}]}),e.grid=Ext.create("Ext.grid.Panel",{store:e.store,columns:[{header:"Действие",width:100,dataIndex:"action",renderer:e.cellRenderer},{header:"id",width:100,dataIndex:"id",hidden:!0}],forceFit:!0,frame:!1,deferRowRender:!1,viewConfig:{plugins:{ptype:"gridviewdragdrop"},listeners:{drop:function(t,s,n,r){for(var i=[],a=0;a<e.store.getCount();a++)for(var o=0;o<e.value.length;o++)if(e.value[o].actionId==e.store.getAt(a).get("id")){i.push(e.value[o]);break}e.value=i,e.fireEvent("change",e.value)}}}}),e.items=e.grid,e.on("afterrender",function(){e.value&&e.setValue(e.value)}),this.callParent(arguments)},create:function(){var e=this;dialog.getObject({title:"Выберите действия",width:800,height:600,layout:{split:{orientation:"horizontal",width:300,items:[{treegrid:{id:"olapClasses",title:"Классы",view:"system.classes",fields:{id:"id",parent:"parent_id"},filter:["id",">=",1e3]}},{olap:{id:"olap",title:"Действия",view:"system.actions",singleSelect:!1,filter:["class_id","=",{id:"olapClasses",attr:"id"}]}}]}},attr:"olap.id",success:function(t){for(var s=t.values,n=0;n<s.length;n++){var r=$o.getAction(s[n]),i=$o.getClass(r.get("class")),a=i.getFullCode()+"."+r.get("code"),o={actionId:r.get("id"),fn:a,text:r.get("name")};if(r.get("layout")){var l=JSON.parse(r.get("layout"));"create"==l.type&&(o.iconCls="gi_circle_plus"),"remove"==l.type&&(o.iconCls="gi_circle_minus",o.active="common.recordSelected"),"card"==l.type&&(o.iconCls="gi_edit",o.active="common.recordSelected")}e.value=e.value||[],e.value.push(o)}e.build(),e.fireEvent("change",e.value)}})},edit:function(){var e,t,s=this;if(s.grid.getSelectionModel().hasSelection()){var n=s.grid.getSelectionModel().getSelection()[0],r=n.get("id");for(t=0;t<s.value.length;t++)if(s.value[t].actionId==r||s.value[t].fn==r){e=s.value[t];break}var i=Ext.create("Ext.Window",{width:600,height:600,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:"Действие",bodyPadding:5,modal:1,items:{xtype:"$actioncard",value:e,listeners:{aftersave:function(e){if(i.close(),s.value[t]=e,s.build(),e.actionId){var n=$o.getAction(e.actionId);n.initAction()}s.fireEvent("change",s.value)}}}});i.show()}},remove:function(){var e=this;if(e.grid.getSelectionModel().hasSelection()){for(var t=e.grid.getSelectionModel().getSelection()[0],s=t.get("id"),n=0;n<e.value.length;n++)if(e.value[n].actionId==s||e.value[n].fn==s){e.value.splice(n,1);break}e.build(),e.fireEvent("change",e.value)}},build:function(){for(var e=this,t=[],s=0;s<e.value.length;s++)if(e.value[s].actionId){var n=$o.getAction(e.value[s].actionId);t.push({action:n.toString(),id:e.value[s].actionId})}else t.push({action:e.value[s].text,id:e.value[s].fn});e.store.loadData(t)},setValue:function(e){var t=this;t.value=e,t.build()},getValue:function(){var e=this;return e.value}}),Ext.define("$o.ActionCard.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.actioncard","widget.$actioncard"],layout:"vbox",border:!1,defaults:{border:!1},bodyPadding:1,initComponent:function(){var e=this;e.value=e.value||{},e.tbar=[{text:"Ок",iconCls:"gi_ok",handler:e.save,name:"save",disabled:1,scope:e},{text:"Отмена",iconCls:"gi_remove",handler:function(){e.up("window").close()},name:"cancel"}],e.items=[{xtype:"$conffield",fieldLabel:"Действие",name:"action",width:"100%",confRef:"action",style:"margin-top: 5px",choose:{type:"layout",attr:"olap.id",width:600,height:400,layout:{split:{orientation:"horizontal",width:300,items:[{treegrid:{id:"olapClasses",view:"system.classes",fields:{id:"id",parent:"parent_id"},filter:{fn:function(){return["id",">=",1e3]}}}},{olap:{id:"olap",view:"system.actions",filter:["class_id","=",{id:"olapClasses",attr:"id"}]}}]}}},listeners:{change:function(){if(this.getValue()){var t=$o.getAction(this.getValue());$o.getClass(t.get("class"));if(e.down("*[name=name]").setValue(t.get("name")),t.get("layout")){var s=JSON.parse(t.get("layout"));"create"==s.type&&e.down("*[name=iconCls]").setValue("gi_circle_plus"),"remove"==s.type&&(e.down("*[name=iconCls]").setValue("gi_circle_minus"),e.down("*[name=activeRecordSelected]").setValue(1)),"card"==s.type&&(e.down("*[name=iconCls]").setValue("gi_edit"),e.down("*[name=activeRecordSelected]").setValue(1))}}e.validator()}}},{xtype:"textfield",width:"100%",fieldLabel:"Функция",name:"fn",value:e.value.actionId?"":e.value.fn,validator:e.validator},{xtype:"textfield",width:"100%",fieldLabel:"Наименование",name:"name",value:e.value.text},{xtype:"$iconselector",width:"100%",name:"iconCls",value:e.value.iconCls},{xtype:"checkbox",name:"activeRecordSelected",fieldLabel:"Активно при выбранной записи",checked:"common.recordSelected"==e.value.active},{title:"Параметры",width:"100%",flex:1,xtype:"$actionargs",value:e.value.arguments,listeners:{change:function(t){e.value.arguments=t}}}],e.on("afterrender",function(){e.down("*[name=action]").setValue(e.value.actionId)}),e.addEvents("aftersave"),this.callParent(arguments)},validator:function(){var e=this.up("panel");return e.down("*[name=action]").getValue()||e.down("*[name=fn]").getValue()?e.down("*[name=save]").enable():e.down("*[name=save]").disable(),!0},save:function(){var e,t=this,s=t.down("*[name=action]").getValue(),n=t.value;if(s){n.actionId=s;var r=$o.getAction(s),i=$o.getClass(r.get("class"));e=i.getFullCode()+"."+r.get("code")}else e=t.down("*[name=fn]").getValue();n.fn=e,t.down("*[name=name]").getValue()&&(n.text=t.down("*[name=name]").getValue()),t.down("*[name=iconCls]").getValue()&&(n.iconCls=t.down("*[name=iconCls]").getValue()),t.down("*[name=activeRecordSelected]").getValue()&&(n.active="common.recordSelected"),t.fireEvent("aftersave",n)}}),Ext.define("$o.ActionArgs.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.actionargs","widget.$actionargs"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.value=e.value||{},e.tbar=[{text:"Добавить",iconCls:"gi_circle_plus",handler:e.create,scope:e},{text:"Удалить",iconCls:"gi_circle_minus",handler:e.remove,scope:e}],e.store=Ext.create("Ext.data.Store",{autoSync:!0,data:e.getData(),fields:[{name:"arg",type:"string"},{name:"value",type:"string"}],listeners:{datachanged:e.datachanged,scope:e}}),e.grid=Ext.create("Ext.grid.Panel",{store:e.store,columns:[{header:"Параметр",width:150,dataIndex:"arg",renderer:e.cellRenderer,editor:{xtype:"textfield"}},{header:"Значение",flex:1,dataIndex:"value",renderer:e.cellRenderer,editor:{xtype:"textfield"}}],plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1})],forceFit:!0,frame:!1,deferRowRender:!1}),e.items=e.grid,e.addEvents("change"),this.callParent(arguments)},getData:function(){var e=this,t=[];for(var s in e.value)t.push({arg:s,value:e.value[s]});return t},cellRenderer:function(e,t,s,n,r,i){t.column.dataIndex;return t.tdAttr+=' style=";border: 1px gray solid;"',e},datachanged:function(){var e=this;if(e.store){for(var t={},s=0;s<e.store.getCount();s++){var n=e.store.getAt(s);n.get("arg")&&n.get("value")&&(t[n.get("arg")]=n.get("value"))}e.value=t,e.fireEvent("change",e.value)}},create:function(){var e=this;e.store.insert(e.store.getCount(),{})},remove:function(){var e=this;if(e.grid.getSelectionModel().hasSelection()){var t=e.grid.getSelectionModel().getSelection()[0];e.store.remove(t);var s=t.get("arg");delete e.value[s]}}}),Ext.define("$o.EventDesigner.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.eventdesigner","widget.$eventdesigner"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.tbar=[{text:"Открыть",iconCls:"gi_edit",handler:e.edit,scope:e},{text:"Добавить",iconCls:"gi_circle_plus",handler:e.create,scope:e},{text:"Удалить",iconCls:"gi_circle_minus",handler:e.remove,scope:e}],e.store=Ext.create("Ext.data.Store",{data:[],fields:[{name:"event",type:"string"},{name:"action",type:"string"},{name:"fn",type:"string"}]}),e.grid=Ext.create("Ext.grid.Panel",{store:e.store,columns:[{header:"Событие",flex:1,dataIndex:"event",renderer:e.cellRenderer},{header:"Действие",flex:2,dataIndex:"action",renderer:e.cellRenderer},{header:"fn",width:100,dataIndex:"fn",hidden:!0}],forceFit:!0,frame:!1,deferRowRender:!1}),e.items=e.grid,e.on("afterrender",function(){e.setValue(e.value)}),e.addEvents("changeevent"),this.callParent(arguments)},create:function(){var e=this,t=Ext.create("Ext.Window",{width:600,height:400,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:"Событие",bodyPadding:5,modal:1,items:{xtype:"$eventcard",$events:e.$events,listeners:{aftersave:function(s){t.close(),e.value[s.event]=s,delete s.event,e.build(),e.fireEvent("changeevent",e.value)}}}});t.show()},edit:function(){var e,t=this;if(t.grid.getSelectionModel().hasSelection()){var s=t.grid.getSelectionModel().getSelection()[0];e=t.value[s.get("event")],e.event=s.get("event");var n=Ext.create("Ext.Window",{width:600,height:400,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:"Событие",bodyPadding:5,modal:1,items:{xtype:"$eventcard",value:e,$events:t.$events,listeners:{aftersave:function(e){n.close(),t.value[e.event]=e,delete e.event,t.build(),t.fireEvent("changeevent",t.value)}}}});n.show()}},remove:function(){var e=this;if(e.grid.getSelectionModel().hasSelection()){var t=e.grid.getSelectionModel().getSelection()[0];delete e.value[t.get("event")],e.build(),e.fireEvent("changeevent",e.value)}},build:function(){var e=this,t=[];for(var s in e.value){var n=$o.getAction(e.value[s].fn);t.push({event:s,action:n?n.toString():e.value[s].fn,fn:e.value[s].fn})}e.store.loadData(t)},setValue:function(e){var t=this;e=e||{};for(var s in e)"string"==typeof e[s]&&(e[s]={fn:e[s]});t.value=e,t.build()},getValue:function(){var e=this;return e.value}}),Ext.define("$o.EventCard.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.eventcard","widget.$eventcard"],layout:"vbox",border:!1,defaults:{border:!1},bodyPadding:1,initComponent:function(){var e=this;e.value=e.value||{},e.tbar=[{text:"Ок",iconCls:"gi_ok",handler:e.save,name:"save",disabled:1,scope:e},{text:"Отмена",iconCls:"gi_remove",handler:function(){e.up("window").close()},name:"cancel"}];for(var t=$o.getAction(e.value.fn),s=[],n=0;n<e.$events.length;n++)s.push([e.$events[n],e.$events[n]]);e.items=[{xtype:"combo",name:"event",fieldLabel:"Событие",width:"100%",triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:s}),value:e.value.event,validator:e.validator,style:"margin-top: 5px",valueField:"id",displayField:"text"},{xtype:"$conffield",fieldLabel:"Действие",name:"action",width:"100%",confRef:"action",choose:{type:"layout",attr:"olap.id",width:600,height:400,layout:{split:{orientation:"horizontal",width:300,items:[{treegrid:{id:"olapClasses",view:"system.classes",fields:{id:"id",parent:"parent_id"},filter:{fn:function(){return["id",">=",1e3]}}}},{olap:{id:"olap",view:"system.actions",filter:["class_id","=",{id:"olapClasses",attr:"id"}]}}]}}},listeners:{change:function(){if(this.getValue()){var t=$o.getAction(this.getValue());$o.getClass(t.get("class"))}e.validator()}}},{xtype:"textfield",width:"100%",fieldLabel:"Функция",name:"fn",value:t?"":e.value.fn,validator:e.validator},{title:"Параметры",width:"100%",flex:1,xtype:"$actionargs",value:e.value.arguments,listeners:{change:function(t){e.value.arguments=t}}}],e.on("afterrender",function(){t&&e.down("*[name=action]").setValue(t.get("id"))}),e.addEvents("aftersave"),this.callParent(arguments)},validator:function(){var e=this.up("panel");return e.down("*[name=event]").getValue()&&(e.down("*[name=action]").getValue()||e.down("*[name=fn]").getValue())?e.down("*[name=save]").enable():e.down("*[name=save]").disable(),!0},save:function(){var e,t=this,s=t.down("*[name=action]").getValue();if(s){var n=$o.getAction(s),r=$o.getClass(n.get("class"));e=r.getFullCode()+"."+n.get("code")}else e=t.down("*[name=fn]").getValue();var i=t.value;i.fn=e,i.event=t.down("*[name=event]").getValue(),t.fireEvent("aftersave",i)}}),Ext.define("$o.LayoutDesigner.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.layoutdesigner","widget.$layoutdesigner"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.initCounter(e.value),e.value=e.value||e.createEmpty(),e.treeStore=Ext.create("Ext.data.TreeStore",{root:{expanded:!0,children:[]}}),e.items={xtype:"tabpanel",items:[{title:"Конструктор",iconCls:"gi_adjust_alt",layout:"border",name:"constructor",border:!1,items:[{split:!0,width:230,region:"east",layout:"fit",items:{xtype:"treepanel",store:e.treeStore,rootVisible:!1,title:"Навигатор",iconCls:"gi_search",border:0,tbar:[{text:"Открыть",iconCls:"gi_edit",name:"edit",handler:e.edit,scope:e,disabled:1},{text:"Добавить",iconCls:"gi_circle_plus",name:"create",handler:function(){var t=e.createEmpty();t.panel.title="Закладка";var s=e.getCmp(e.selected.id);s.tab.items.push(t),e.addCmp(t.panel.id)},scope:e,disabled:1},{text:"Удалить",iconCls:"gi_circle_minus",name:"delete",handler:function(){common.confirm({message:"Вы уверены?",scope:this,fn:function(t){if("yes"==t){if(!e.removeTab(e.selected.id)){var s=e.createEmpty(),n=e.getCmp(e.selected.id);for(var r in n)delete n[r];Ext.apply(n,s),e.value.designer=1}e.down("button[name='delete']").disable(),e.build()}}})},scope:e,disabled:1}],bbar:[{text:"Отменить действие",iconCls:"gi_history",name:"prevValue",disabled:1,handler:function(){e.value=JSON.parse(e.prevValue.pop()),e.prevValue.length||e.down("button[name='prevValue']").disable(),e.build({back:1})}}],listeners:{select:function(t,s,n,r){if(s){var i=s.get("text").split("(id:")[1].split(")")[0],a=e.getCmpCode(i);"panel"!=a?(e.down("button[name='edit']").enable(),e.selected={record:s,id:i,code:a}):e.down("button[name='edit']").disable(),"tab"==a?e.down("button[name='create']").enable():e.down("button[name='create']").disable(),"panel"!=a?e.down("button[name='delete']").enable():e.down("button[name='delete']").disable()}}}}},{region:"center",layout:"fit",border:0,style:"border: 1px solid #00ff00; margin: 1px",bodyPadding:1,items:{xtype:"$o.layout",$layout:$o.util.clone(e.value)}}]},{layout:"fit",title:"Исходный код",iconCls:"gi_notes",name:"source",items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},e.addEvents("change"),e.on("afterrender",e.setHandlers),this.callParent(arguments)},edit:function(){var e=this,t=e.selected.id,s=e.selected.code,n=Ext.create("Ext.Window",{width:e.getCmpWidth(s),height:e.getCmpHeight(s),resizeable:!1,border:!1,title:e.getCmpName(s),iconCls:e.getCmpIconCls(s),style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",modal:1,layout:"fit",items:{xtype:"$o.layout"+s,layoutDesigner:e,value:e.getCmpValue(t),listeners:{aftersave:function(){n.close(),e.replaceCmp(t,this.getValue()),e.build(),e.fireEvent("change",e.getValue())}}}});n.show()},getCmpCode:function(e){var t=this,s=function(t){if("object"==typeof t)for(var n in t)if(t[n]){if(t[n].id==e)return n;var r=s(t[n]);if(r)return r}if(t.items)for(var i=0;i<t.items.length;i++){var r=s(t.items[i]);if(r)return r}};return s(t.value)},getCmpValue:function(e){var t=this,s=function(t){if("object"==typeof t)for(var n in t)if(t[n]){if(t[n].id==e)return t;var r=s(t[n]);if(r)return r}if(t.items)for(var i=0;i<t.items.length;i++){var r=s(t.items[i]);if(r)return r}};return s(t.value)},getCmpName:function(e){switch(e){case"split":return"Разделитель";case"tab":return"Закладки";case"olap":return"Таблица";case"treegrid":return"Дерево";case"card":return"Карточка";case"chart":return"Диаграмма";case"image":return"Изображение";case"frame":return"Фрейм";case"panel":return"Пустой"}},getCmpIconCls:function(e){switch(e){case"split":return"gi_share_alt";case"tab":return"gi_share_alt";case"olap":return"gi_table";case"treegrid":return"gi_leaf";case"card":return"gi_edit";case"chart":return"gi_charts";case"image":return"gi_picture";case"frame":return"gi_globe_af";case"panel":return"gi_file"}},getCmpWidth:function(e){switch(e){case"split":return 600;case"tab":return 600;case"olap":return 800;case"treegrid":return 600;case"card":return 800;case"chart":return 600;case"image":return 600;case"frame":return 600}},getCmpHeight:function(e){switch(e){case"split":return 400;case"tab":return 400;case"olap":return 600;case"treegrid":return 600;case"card":return 600;case"chart":return 600;case"image":return 600;case"frame":return 600}},getTreeRecord:function(e){var t=this;e=e||t.value;var s;for(s in e)if("designer"!=s)break;var n=e[s],r={text:t.getCmpName(s)+(n.title?": "+n.title:"")+" (id:"+n.id+")"};if(n.items&&"panel"!=s&&"card"!=s){r.expanded=0,r.children=[];for(var i=0;i<n.items.length;i++)r.children.push(t.getTreeRecord(n.items[i]))}else r.leaf=1;return r},initCounter:function(e){var t=this;if(e=e||{},t.counter=t.counter||1,"object"==typeof e)for(var s in e)e[s]&&t.initCounter(e[s]);if(e.items)for(var n=0;n<e.items.length;n++)t.initCounter(e.items[n]);if(e.id){var r=e.id.split("-");r.length>1&&Number(r[1])>=t.counter&&(t.counter=Number(r[1])+1)}},createEmpty:function(){var e=this,t="cmp-"+e.counter++,s={panel:{id:t,layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"button",text:"Выберите компонент",iconCls:"gi_edit",name:"selectCmp",cmpId:t}]}};return s},build:function(e){var t=this;e=e||{};var s=t.down("*[region='center']");s.removeAll(),s.add({xtype:"$o.layout",$layout:t.updateLayoutTags($o.util.clone(t.value))}),s.doLayout(),t.setHandlers(),t.treeStore.getRootNode().removeAll(),t.treeStore.getRootNode().appendChild(t.getTreeRecord()),t.down("button[name='edit']").disable(),e.back||(t.prevValue=t.prevValue||[],t.prevValue.push(t.down("codemirrortextarea[name='json']").getValue()),t.down("button[name='prevValue']").enable()),t.down("codemirrortextarea[name='json']").setValue(JSON.stringify(t.value,null,"\t"))},selectCmp:function(e){var t=function(){e.success(this.cmpCode),s.close()},s=Ext.create("Ext.Window",{width:560,height:100,bodyPadding:5,resizeable:!1,border:!1,title:"Выберите компонент",style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",modal:1,layout:"hbox",items:[{xtype:"button",text:"Таблица",cmpCode:"olap",iconCls:"gib_table",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t},{xtype:"button",text:"Дерево",cmpCode:"treegrid",iconCls:"gib_leaf",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t},{xtype:"button",text:"Карточка",cmpCode:"card",iconCls:"gib_edit",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t},{xtype:"button",text:"Диаграмма",cmpCode:"chart",iconCls:"gib_charts",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t},{xtype:"button",text:"Изображение",cmpCode:"image",iconCls:"gib_picture",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t},{xtype:"button",text:"Фрейм",cmpCode:"frame",iconCls:"gib_globe_af",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t},{xtype:"button",text:"Разделитель",cmpCode:"split",iconCls:"gib_share_alt",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t},{xtype:"button",text:"Закладки",cmpCode:"tab",iconCls:"gib_bookmark",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t}]});s.show()},getCmp:function(e){var t=this,s=function(t){if("object"==typeof t)for(var n in t)if(t[n]){if(t[n].id==e)return t;var r=s(t[n]);if(r)return r}};return s(t.value)},removeTab:function(e){var t=this,s=function(t){if("object"==typeof t)for(var n in t)if(t[n]){if("tab"==n&&t[n].items.length>1)for(var r=0;r<t[n].items.length;r++){var i;for(i in t[n].items[r])break;if(t[n].items[r][i].id==e)return t[n].items.splice(r,1),1}var r=s(t[n]);if(r)return r}};return s(t.value)},replaceCmp:function(e,t){var s=this,n=function(s){if("object"==typeof s)for(var r in s)if(s[r]){if(s[r].id==e&&["split","tab","olap","treegrid","card","cardConf","chart","image","frame","panel"].indexOf(r)>-1)return delete s[r],void Ext.apply(s,t);n(s[r])}};n(s.value)},addCmp:function(e){var t=this;t.addCmpActive=1,t.selectCmp({success:function(s){var n=Ext.create("Ext.Window",{width:t.getCmpWidth(s),height:t.getCmpHeight(s),resizeable:!1,border:!1,title:t.getCmpName(s),iconCls:t.getCmpIconCls(s),style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",modal:1,layout:"fit",items:{xtype:"$o.layout"+s,layoutDesigner:t,listeners:{aftersave:function(){t.addCmpActive=0,n.close(),t.replaceCmp(e,this.getValue()),t.build(),t.fireEvent("change",t.getValue())}}}});n.show()}})},getValue:function(){var e=this,t=e.down("codemirrortextarea[name='json']").getValue();return t},setValue:function(e){var t=this;if(e){if("string"==typeof e)try{if(e=JSON.parse(e),!e.designer)throw"invalid"}catch(n){var s=t.down("*[region='center']");return s.removeAll(),s.add({layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"label",text:"Извините, не удалось декодировать исходный код макета."}]}),t.treeStore.getRootNode().removeAll(),t.down("button[name='edit']").disable(),t.down("button[name='create']").disable(),t.down("button[name='delete']").disable(),t.down("button[name='prevValue']").disable(),t.value=e,t.down("codemirrortextarea[name='json']").setValue(e),void t.down("tabpanel").setActiveTab(t.down("panel[name=source]"))}}else t.counter=1,e=t.createEmpty(),e.designer=1;t.value=e,t.initCounter(t.value),t.build(),t.prevValue=[],t.down("button[name='prevValue']").disable()},setReadOnly:function(e){},updateLayoutTags:function(e){var t=null,s=function(e){function n(s){for(var a=0;a<s.length;a++){var o=s[a];o.objectId&&o.objectId.substr&&"[#"==o.objectId.substr(0,2)&&(i[o.objectId]?o.objectId=i[o.objectId]:t=e[r].id),o.items&&n(o.items)}}if("object"==typeof e){for(var r in e)if(e[r])if("card"==r&&e[r].object){e[r].readOnly=1;for(var i={},a=e[r].object.length?e[r].object:[e[r].object],o=0;o<a.length;o++){var l=$o.createObject(a[o].cls,"local");i[a[o].tag]=l.get("id")}n(e[r].items)}else"card"!=r||e[r].object?"string"==typeof e[r]?"[#"==e[r].substr(0,2)&&(e[r]=0):s(e[r]):e[r].items=[];
if(e.items)for(var c=0;c<e.items.length;c++)s(e.items[c])}};return s(e),t&&common.message("Не определен класс объекта в карточке: "+t),e},setHandlers:function(){for(var e=this,t=e.query("button[name='selectCmp']"),s=0;s<t.length;s++)t[s].on("click",function(){e.addCmpActive||e.addCmp(this.cmpId)})}}),Ext.define("$o.QuerySort.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.querysort","widget.$querysort"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.value=e.value||[],e.tbar=[{text:"Добавить",handler:e.create,iconCls:"gi_circle_plus",scope:e},{text:"Очистить",iconCls:"gi_circle_minus",handler:e.clear,scope:e}],e.store=Ext.create("Ext.data.Store",{data:[],fields:[{name:"attr",type:"string"},{name:"dir",type:"string"},{name:"alias",type:"string"},{name:"dir_id",type:"string"}]}),e.grid=Ext.create("Ext.grid.Panel",{store:e.store,columns:[{header:"Атрибут",width:100,dataIndex:"attr",renderer:e.cellRenderer},{header:"Сортировка",width:100,dataIndex:"dir",renderer:e.cellRenderer},{header:"alias",width:100,dataIndex:"attr_id",hidden:!0},{header:"dir_id",width:100,dataIndex:"dir_id",hidden:!0}],forceFit:!0,frame:!1,deferRowRender:!1}),e.items=e.grid,e.addEvents("change"),this.callParent(arguments)},cellRenderer:function(e,t,s,n,r,i){if(e){var a=e;"string"==typeof a&&(a=a.split('"').join("'")),t.tdAttr='data-qtip="'+a+'"'}return e},setClasses:function(e,t,s){var n=this;n.$classes=e,n.$classAliases=t,n.$aliases=s},create:function(){for(var e=this,t=[],s=0;s<e.$classes.length;s++){var n=$o.getClass(e.$classes[s]);t.push([e.$aliases[s]+":id",e.$aliases[s]+":id"]);for(var r in n.attrs)t.push([e.$aliases[s]+":"+r,e.$aliases[s]+":"+n.attrs[r].toString()])}var i=Ext.create("Ext.Window",{width:400,height:150,layout:"vbox",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:"Выберите атрибут",iconCls:"gi_file",bodyPadding:5,modal:1,tbar:[{text:"Ок",iconCls:"gi_ok",name:"create",disabled:1,handler:function(){var t=i.down("*[name=attr]").getValue();e.value=e.value||[],e.value.length&&e.value.push(",");var s={};s[t.split(":")[0]]=t.split(":")[1],e.value.push(s),"DESC"==i.down("*[name=dir]").getValue()?e.value.push("DESC"):e.value.push("ASC"),e.build(),i.close(),e.fireEvent("change",e.value)}},{text:"Отмена",iconCls:"gi_remove",handler:function(){i.close()}}],items:[{xtype:"combo",fieldLabel:"Атрибут",name:"attr",width:"100%",mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:t}),valueField:"id",displayField:"text",listeners:{select:function(){this.getValue()?i.down("*[name=create]").enable():i.down("*[name=create]").disable()}}},{xtype:"combo",fieldLabel:"Сортировка",name:"dir",width:"100%",mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["ASC","По возрастанию"],["DESC","По убыванию"]]}),valueField:"id",displayField:"text"}]});i.show()},clear:function(){var e=this;e.setValue([])},build:function(){var e=this,t=[];if(e.value)for(var s=0;s<e.value.length;s+=2){","==e.value[s]&&s++;var n={};"DESC"==e.value[s+1]?(n.dir="По убыванию",n.dir_id="DESC"):(n.dir="По возрастанию",n.dir_id="ASC");var r;for(r in e.value[s])break;for(var i=e.value[s][r],a=0;a<e.$aliases.length;a++)if(e.$aliases[a]==r){var o=$o.getClass(e.$classes[a]);n.attr=r+":"+o.attrs[i].toString(),n.alias=r;break}t.push(n)}e.store.loadData(t)},setValue:function(e){var t=this;t.value=e,t.build(),t.fireEvent("change",e)},getValue:function(){var e=this;return e.value}}),Ext.define("$o.QuerySelect.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.queryselect","widget.$queryselect"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.value=e.value||[],e.tbar=[{text:"Выбрать",iconCls:"gi_edit",handler:e.addAttrs,scope:e}],e.store=Ext.create("Ext.data.Store",{data:[],fields:[{name:"name",type:"string"},{name:"clsName",type:"string"},{name:"clsFrom",type:"string"},{name:"clsId",type:"number"},{name:"attr",type:"string"},{name:"alias",type:"string"}],sorters:[{property:"name",direction:"ASC"}]}),e.grid=Ext.create("Ext.grid.Panel",{store:e.store,columns:[{header:"Атрибут",width:100,dataIndex:"name",renderer:e.cellRenderer},{header:"Псевдоним",width:100,dataIndex:"alias",renderer:e.cellRenderer},{header:"Класс",width:100,dataIndex:"clsName",renderer:e.cellRenderer},{header:"clsFrom",width:100,dataIndex:"clsFrom",hidden:!0},{header:"clsId",width:100,dataIndex:"clsId",hidden:!0},{header:"attr",width:100,dataIndex:"attr",hidden:!0}],forceFit:!0,frame:!1,deferRowRender:!1}),e.items=e.grid,e.addEvents("change"),this.callParent(arguments)},cellRenderer:function(e,t,s,n,r,i){if(e){var a=e;"string"==typeof a&&(a=a.split('"').join("'")),t.tdAttr='data-qtip="'+a+'"'}return e},updateSelect:function(){var e=this;e.value=[];for(var t=0;t<e.store.getCount();t++){var s={};s[e.store.getAt(t).get("clsFrom")]=e.store.getAt(t).get("attr"),e.value.push(s),e.value.push(e.store.getAt(t).get("alias"))}e.fireEvent("change",e.value)},addAttrs:function(){var e=this;if(!e.$classes.length)return void common.message("Необходимо выбрать класс.");for(var t=[],s=0;s<e.$classes.length;s++){for(var n=$o.getClass(e.$classes[s]),r=[{attr:"id",name:"id",alias:s?e.$aliases[s]+"_id":"id"}],i=[],a=0;a<e.store.getCount();a++)e.store.getAt(a).get("clsFrom")==e.$aliases[s]&&"id"==e.store.getAt(a).get("attr")&&(i.push("id"),r[0].alias=e.store.getAt(a).get("alias"));for(var o in n.attrs){for(var l=n.attrs[o],c={attr:o,name:l.toString(),clsName:$o.getClass(l.get("class")).toString(),alias:s?e.$aliases[s]+"_"+o:o},a=0;a<e.store.getCount();a++)e.store.getAt(a).get("clsFrom")==e.$aliases[s]&&e.store.getAt(a).get("attr")==o&&(i.push(o),c.alias=e.store.getAt(a).get("alias"));r.push(c)}var d=Ext.create("Ext.data.Store",{data:r,fields:[{name:"name",type:"string"},{name:"clsName",type:"string"},{name:"attr",type:"string"},{name:"alias",type:"string"}],sorters:[{property:"name",direction:"ASC"}]}),u=new Ext.grid.plugin.CellEditing({clicksToEdit:1}),f=Ext.create("Ext.selection.CheckboxModel",{mode:"MULTI",valueSelected:i,checkOnly:!0}),g=Ext.create("Ext.grid.Panel",{tbar:s?[{text:"Псевдонимы по коду атрибута",iconCls:"gi_sort-by-alphabet",handler:function(){for(var e=this.up("grid").getStore(),t=0;t<e.getCount();t++){var s=e.getAt(t),n=s.get("alias");2==n.split("_").length&&s.set("alias",n.split("_")[1])}}}]:[],store:d,columns:[{header:"Атрибут",width:100,dataIndex:"name",renderer:e.cellRenderer},{header:"Псевдоним",width:100,dataIndex:"alias",renderer:e.cellRenderer,editor:{xtype:"textfield"}},{header:"Класс",width:100,dataIndex:"clsName",renderer:e.cellRenderer},{header:"attr",width:100,dataIndex:"attr",hidden:!0}],plugins:[u],selModel:f,forceFit:!0,frame:!1,deferRowRender:!1,listeners:{afterrender:function(){for(var e=0;e<this.getSelectionModel().valueSelected.length;e++)this.getSelectionModel().select(this.getStore().findRecord("attr",this.getSelectionModel().valueSelected[e],0,!1,!1,!0),!0)}}});t.push({title:e.$aliases[s]+":"+n.toString(),alias:e.$aliases[s],name:"tab",cls:n,layout:"fit",selModel:f,items:g})}var m=Ext.create("Ext.Window",{width:600,height:600,resizeable:!1,border:!1,title:"Выберите атрибуты (используйте указатель мыши и клавиши Shift, Ctrl)",style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",modal:1,layout:"fit",items:{xtype:"tabpanel",deferredRender:!1,items:t},tbar:[{text:"Ок",iconCls:"gi_ok",handler:function(){for(var t=[],s=m.down("tabpanel").query("panel[name=tab]"),n=0;n<s.length;n++){var r=s[n],i=[];r.selModel.hasSelection()&&(i=r.selModel.getSelection());for(var a=0;a<i.length;a++)t.push({name:s[n].alias+":"+(r.cls.attrs[i[a].get("attr")]?r.cls.attrs[i[a].get("attr")].toString():i[a].get("attr")),clsName:r.cls.toString(),clsFrom:e.$aliases[n],clsId:r.cls.get("id"),attr:i[a].get("attr"),alias:i[a].get("alias")})}e.store.loadData(t),m.close(),e.updateSelect()}},{text:"Отмена",iconCls:"gi_remove",handler:function(){m.close()}}]});m.show()},setClasses:function(e,t,s){var n=this;n.$classes=e,n.$classAliases=t,n.$aliases=s},build:function(){var e=this,t=[];if(e.value)for(var s=0;s<e.value.length;s+=2){var n,r;for(r in e.value[s])break;for(var i=e.value[s][r],a=0;a<e.$aliases.length;a++)e.$aliases[a]==r&&(n=$o.getClass(e.$classes[a]));t.push({name:r+":"+(n.attrs[i]?n.attrs[i].toString():i),clsName:n.toString(),clsFrom:r,clsId:n.get("id"),attr:i,alias:e.value[s+1]})}e.store.loadData(t)},setValue:function(e){var t=this;t.value=e,t.build(),t.fireEvent("change",e)},getValue:function(){var e=this;return e.value}}),Ext.define("$o.QueryCondition.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.querycondition","widget.$querycondition"],layout:"vbox",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.filter=e.filter||[],e.value={},e.tbar=[{text:"Ок",iconCls:"gi_ok",name:"save",disabled:1,handler:e.save,scope:e},{text:"Отмена",iconCls:"gi_remove",name:"cancel",handler:function(){e.up("window").close()}}];for(var t=[],s=0;s<e.$classes.length;s++){var n=$o.getClass(e.$classes[s]);t.push([e.$aliases[s]+":id",e.$aliases[s]+":id"]);for(var r in n.attrs)t.push([e.$aliases[s]+":"+r,e.$aliases[s]+":"+n.attrs[r].toString()])}e.items=[{xtype:"combo",fieldLabel:"И/ИЛИ",name:"and_or",width:250,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["and","И"],["or","ИЛИ"]]}),valueField:"id",displayField:"text",validator:e.validator},{xtype:"combo",fieldLabel:"Атрибут 1",name:"attr1",width:"100%",mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:t}),valueField:"id",displayField:"text",validator:e.validator},{xtype:"combo",fieldLabel:"Оператор",name:"oper",width:250,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["=","равно (=)"],["<>","не равно (<>)"],["<","меньше (<)"],[">","больше (>)"],["<=","меньше или равно (<=)"],[">=","больше или равно (>=)"],["is null","пусто (is null)"],["is not null","не пусто (is not null)"],["in","одно из перечня (in)"]]}),valueField:"id",displayField:"text",listeners:{select:function(){var t=this.getValue();"is null"==t||"is not null"==t?(e.down("*[name='value']").disable(),e.down("*[name='attr2']").disable()):(e.down("*[name='value']").enable(),"in"==t?e.down("*[name='attr2']").disable():e.down("*[name='attr2']").enable())}},validator:e.validator},{xtype:"textfield",fieldLabel:"Значение",width:"100%",name:"value",validator:e.validator},{xtype:"combo",fieldLabel:"Атрибут 2",name:"attr2",width:"100%",mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:t}),valueField:"id",displayField:"text",listeners:{select:function(){this.getValue()?e.down("*[name=save]").enable():e.down("*[name=save]").disable(),e.validator()}}}],e.filter.length||e.items.splice(0,1),e.items[0].style="margin-top: 5px;",e.addEvents("aftersave"),this.callParent(arguments)},validator:function(e){var t=this.up("panel"),s=t.down("*[name='and_or']"),n=t.down("*[name='attr1']"),r=t.down("*[name='oper']"),i=t.down("*[name='value']"),a=t.down("*[name='attr2']");if(s&&!s.getValue())return t.down("button[name='save']").disable(),!0;if(n.getValue()&&r.getValue()&&("is null"==r.getValue()||"is not null"==r.getValue()||i.getValue()||a.getValue())){t.down("button[name='save']").enable();var o=n.getValue(),l={};if(l[o.split(":")[0]]=o.split(":")[1],"is null"==r.getValue()||"is not null"==r.getValue())t.value=[l,r.getValue()];else{var c=i.getValue();if(a.getValue()){var d=a.getValue();c={},c[d.split(":")[0]]=d.split(":")[1]}t.value=[l,r.getValue(),c]}s&&(t.value=[s.getValue()].concat(t.value))}else t.down("button[name='save']").disable(),t.value=[];return!0},save:function(){var e=this;e.fireEvent("aftersave",e.value)},getValue:function(){var e=this;return e.value}}),Ext.define("$o.QueryDesigner.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.querydesigner","widget.$querydesigner"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.store=new Ext.data.ArrayStore({fields:["id","text"],data:[]}),e.items={xtype:"tabpanel",items:[{title:"Конструктор",iconCls:"gi_adjust_alt",layout:"border",name:"constructor",border:!1,items:[{split:!0,region:"north",height:315,layout:"fit",border:0,items:{layout:"vbox",bodyPadding:5,items:[{xtype:"compositefield",items:[{xtype:"$conffield",fieldLabel:"Класс",name:"class",width:400,confRef:"class",choose:{type:"custom",fn:function(){var e=this;dialog.getClass({success:function(t){e.setValue(t.id)}})}},listeners:{change:function(){e.updateAttrsStore(),e.validator(),e.updateFrom(),e.updateClasses()}}},{xtype:"displayfield",value:"Псевдоним:",style:"margin-left: 5px",width:70},{xtype:"textfield",name:"alias",width:100,listeners:{change:function(){e.updateAttrsStore(),e.validator(),e.updateFrom(),e.updateClasses()}}}]},{title:"Дополнительные классы",iconCls:"gi_cogwheels",flex:1,width:"100%",layout:"hbox",name:"classes",autoScroll:!0,bodyPadding:5,tbar:[{text:"Добавить",iconCls:"gi_circle_plus",handler:e.addClass,scope:e}]}]}},{region:"center",layout:"border",border:0,items:[{split:!0,width:300,region:"west",layout:"fit",border:1,bodyPadding:1,items:{title:"Атрибуты",iconCls:"gi_file",xtype:"$queryselect",name:"attrs",listeners:{change:function(t){var s=e.decodeQuery();s&&(s.select=t,e.down("codemirrortextarea[name='json']").setValue(JSON.stringify(s,null,"\t")))}}}},{region:"center",layout:"fit",border:0,items:{layout:"border",border:0,items:[{split:!0,width:300,region:"west",layout:"fit",border:1,bodyPadding:1,items:{title:"Фильтр",iconCls:"gi_filter",xtype:"$layoutfilter",name:"filter",classMode:1,listeners:{change:e.updateFilter,scope:e}}},{region:"center",layout:"fit",border:1,bodyPadding:1,items:{title:"Сортировка",iconCls:"gi_sort-by-order",name:"sort",xtype:"$querysort",listeners:{change:function(t){var s=e.decodeQuery();s&&(s.order=t,e.down("codemirrortextarea[name='json']").setValue(JSON.stringify(s,null,"\t")))}}}}]}}]}]},{layout:"fit",title:"Исходный код",iconCls:"gi_notes",name:"source",items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)},decodeQuery:function(){var e=this,t=e.down("*[name=constructor]");t.getEl().unmask(!0);var s=e.down("codemirrortextarea[name='json']").getValue();try{return s=JSON.parse(s)}catch(s){t.getEl().mask("Извините, не удалось декодировать исходный код макета."),e.down("tabpanel").setActiveTab(e.down("panel[name=source]"))}},updateFrom:function(){var e=this,t=e.down("*[name=class]").getValue();if(t){var s=$o.getClass(t).getFullCode(),n=e.decodeQuery();if(n){n.from=[{a:s}];for(var r=e.down("*[name=classes]").query("panel"),i=0;i<r.length;i++){var a=r[i].n,o=e.down("*[name=class_"+a+"]").getValue(),l=e.down("*[name=attr1_"+a+"]").getValue(),c=e.down("*[name=attr2_"+a+"]").getValue(),d=e.down("*[name=join_"+a+"]").getValue();if(o&&l&&c&&d){var u={};u[a]=$o.getClass(o).getFullCode(),n.from=n.from.concat(d,u,"on");var f={};f[l.split(":")[0]]=l.split(":")[1];var g={};g[c.split(":")[0]]=c.split(":")[1],n.from.push([f,"=",g])}}e.down("codemirrortextarea[name='json']").setValue(JSON.stringify(n,null,"\t"))}}},addClass:function(e){"object"==typeof e&&(e=null);var t=this,s=t.down("*[name=classes]");if(!e)for(var n=s.query("panel"),r="abcdefghijklmnopqrstuvwxyz",i=0;i<r.length;i++){for(var a=0,o=0;o<n.length;o++)if(n[o].n==r[i]){a=1;break}if(!a&&r[i]!=t.down("*[name=alias]").getValue()){e=r[i];break}}s.add({layout:"vbox",bodyPadding:5,width:300,n:e,style:"margin-right: 5px",items:[{xtype:"$conffield",fieldLabel:"Класс",width:"100%",labelWidth:100,name:"class_"+e,confRef:"class",choose:{type:"layout",attr:"olap.id",width:500,height:400,layout:{treegrid:{id:"olap",view:"system.classes",fields:{id:"id",parent:"parent_id"},filter:{fn:function(){return["id",">=",1e3,"and","end_id","=",2147483647]}}}}},listeners:{change:function(){t.updateAttrsStore();var e=this.up("*").down("*[fieldLabel='Связующий атрибут 1']"),s=this.up("*").down("*[fieldLabel='Связующий атрибут 2']");if(!e.getValue()&&!s.getValue()){var n=t.down("*[name=class]").getValue(),r=this.getValue();if(n&&r){var i=$o.getClass(n).attrs,a=t.down("*[name=alias]").getValue(),o=this.up("*").down("*[fieldLabel='Псевдоним']").getValue();for(var l in i){var c=i[l];if(c.get("type")==r){e.setValue(a+":"+l),s.setValue(o+":id");break}}}}t.validator(),t.updateFrom(),t.updateClasses()}}},{xtype:"textfield",fieldLabel:"Псевдоним",name:"alias_"+e,value:e,listeners:{change:function(){t.updateAttrsStore(),t.validator(),t.updateFrom(),t.updateClasses()}}},{xtype:"combo",fieldLabel:"Связующий атрибут 1",name:"attr1_"+e,width:"100%",labelWidth:100,mode:"local",queryMode:"local",editable:!1,store:t.store,valueField:"id",displayField:"text",listeners:{select:function(){t.validator(),t.updateFrom()}}},{xtype:"combo",fieldLabel:"Связующий атрибут 2",name:"attr2_"+e,width:"100%",labelWidth:100,mode:"local",queryMode:"local",editable:!1,store:t.store,valueField:"id",displayField:"text",listeners:{select:function(){t.validator(),t.updateFrom()}}},{xtype:"combo",fieldLabel:"Объединение",name:"join_"+e,width:"100%",labelWidth:100,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["left-join","Внешнее"],["inner-join","Внутреннее"]]}),value:"left-join",valueField:"id",displayField:"text",listeners:{select:function(){t.validator(),t.updateFrom()}}},{xtype:"button",text:"Удалить",iconCls:"gi_circle_minus",style:"margin-top: 5px",handler:function(){var e=this.up("panel");s.remove(e),s.doLayout(),t.updateAttrsStore(),t.validator(),t.updateFrom(),t.updateClasses()}}]}),s.doLayout()},updateFilter:function(e){var t=this,s=t.decodeQuery();s&&(s.where=e,t.down("codemirrortextarea[name='json']").setValue(JSON.stringify(s,null,"\t")))},updateClasses:function(){function e(t,s){n[t]=s;var r=$o.getClass(t);r.get("parent")&&e(r.get("parent"),s)}var t=this,s=[],n={},r=[],i=t.down("*[name=class]").getValue();i&&(s.push(i),e(i,t.down("*[name=alias]").getValue()),r.push(t.down("*[name=alias]").getValue()));for(var a=t.down("*[name=classes]").query("panel"),o=0;o<a.length;o++){var i=t.down("*[name=class_"+a[o].n+"]").getValue(),l=t.down("*[name=alias_"+a[o].n+"]").getValue();i&&(s.push(i),e(i,l),r.push(l))}t.down("*[name=attrs]").setClasses(s,n,r),t.down("*[name=filter]").setClasses(s,n,r),t.down("*[name=sort]").setClasses(s,n,r)},validator:function(){},clear:function(){var e=this;e.down("*[name=class]").setValue(null),e.down("*[name=classes]").removeAll(),e.down("*[name=attrs]").setValue(null),e.down("*[name=filter]").setValue(null),e.down("*[name=sort]").setValue(null)},buildForm:function(e){var t=this;if(e=e||{},t.down("*[name=alias]").setValue("a"),e.from&&e.from.length){var s;for(s in e.from[0])break;t.down("*[name=alias]").setValue(s),s=e.from[0][s];var n=$o.getClass(s);t.down("*[name=class]").setValue(n.get("id"));for(var r=1;r<e.from.length;r+=4){var i;for(i in e.from[r+1])break;var a=i;t.addClass(a);var o=$o.getClass(e.from[r+1][i]);t.down("*[name=class_"+a+"]").setValue(o.get("id"));var l=e.from[r+3][0];for(i in l){t.down("*[name=attr1_"+a+"]").setValue(i+":"+l[i]);break}var c=e.from[r+3][2];for(i in c){t.down("*[name=attr2_"+a+"]").setValue(i+":"+c[i]);break}"left-join"==e.from[r]?t.down("*[name=join_"+a+"]").setValue("left-join"):t.down("*[name=join_"+a+"]").setValue("inner-join")}}e.select&&t.down("*[name=attrs]").setValue(e.select),e.where&&t.down("*[name=filter]").setValue(e.where),e.order&&t.down("*[name=sort]").setValue(e.order)},getValue:function(){var e=this;return e.down("codemirrortextarea[name='json']").getValue()},updateAliases:function(e){function t(e){if(e)if(Ext.isArray(e))for(var r=0;r<e.length;r++)t(e[r]);else if("object"==typeof e){for(s in e)break;s!=n[s]&&(e[n[s]]=e[s],delete e[s])}}if(e){var s,n={};if(e.from){for(s in e.from[0])break;n[s]="a";for(var r=1,i=1;i<e.from.length;i+=4){for(s in e.from[i+1])break;n[s]="c"+r,r++}t(e.select),t(e.from),t(e.where),t(e.order)}}},setValue:function(e){var t=this,s=t.down("*[name=constructor]");s.getEl().unmask(!0),e||(e={designer:1});var n="object"==typeof e?JSON.stringify(e,null,"\t"):e;if(t.down("codemirrortextarea[name='json']").setValue(n),"string"==typeof e)try{if(e=JSON.parse(e),!e.designer)throw"invalid"}catch(e){return s.getEl().mask("Извините, не удалось декодировать исходный код макета."),void t.down("tabpanel").setActiveTab(t.down("panel[name=source]"))}t.clear(),t.buildForm(e),t.down("codemirrortextarea[name='json']").setValue(n)},setReadOnly:function(e){},updateAttrsStore:function(){for(var e=this,t=[],s=e.query("*[confRef=class]"),n=[e.down("*[name=alias]")].concat(e.query("*[fieldLabel=Псевдоним]")),r=0;r<s.length;r++)if(s[r].getValue()&&n[r].getValue()){for(var i,a=0;a<n.length;a++)if(1==s[r].name.split("_")&&1==n[a].name.split("_")||s[r].name.split("_")[1]==n[a].name.split("_")[1]){i=n[a].getValue();break}t.push([i+":id",i+":id"]);var o=s[r].getValue(),l=$o.getClass(o);for(var c in l.attrs){var d=l.attrs[c];(2==d.get("type")||12==d.get("type")||d.get("type")>=1e3)&&t.push([i+":"+c,i+":"+d.toString()])}}e.store.loadData(t)}}),Ext.define("$o.QueryColumns.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.querycolumns","widget.$querycolumns"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.$view=$o.getView(e.viewId),e.updateAttrs()&&(e.items={xtype:"$o.layout",border:1,$layout:{split:{orientation:"vertical",height:100,items:[{layout:"fit",xtype:"$o.layout",$layout:{olap:{id:"olap",view:e.$view.getFullCode(),hideBottomToolbar:1,groupedColumns:!0,listeners:{columnresize:e.onColumnResize,columnmove:e.onColumnMove,columnhide:e.onColumnHide,columnshow:e.onColumnShow,scope:e}}},listeners:{afterrender:function(){e.olapContainer=this}}},{split:{title:"Столбцы",iconCls:"gi_file",orientation:"vertical",height:185,pages:[{olap:{id:"olapAttrs",view:"system.viewAttrs",filter:["view_id","=",e.viewId],listeners:{afterrender:function(){e.olapAttrs=this}}}},{cardConf:{id:"attrCard",items:[{conf:"viewAttr",id:"olapAttrs",attr:"id.name",fieldLabel:"Наименование"},{conf:"viewAttr",id:"olapAttrs",attr:"id.code",fieldLabel:"Код",allowBlank:!1,maskRe:/[A-Za-z0-9\_]/},{xtype:"compositefield",fieldLabel:"Видимый",items:[{conf:"viewAttr",id:"olapAttrs",attr:"id.area",xtype:"checkbox",width:100}]},{xtype:"compositefield",fieldLabel:"№ пп",items:[{conf:"viewAttr",id:"olapAttrs",attr:"id.order",xtype:"numberfield",width:100}]},{xtype:"compositefield",fieldLabel:"Ширина",items:[{conf:"viewAttr",id:"olapAttrs",attr:"id.width",xtype:"numberfield",width:100}]}],active:{fn:function(){return!e.schemaId}},listeners:{afterSave:function(){e.olapContainer.removeAll(),e.olapContainer.add({layout:"fit",xtype:"$o.layout",$layout:{olap:{id:"olap",view:e.$view.getFullCode(),hideBottomToolbar:1,groupedColumns:!0,listeners:{columnresize:e.onColumnResize,columnmove:e.onColumnMove,columnhide:e.onColumnHide,columnshow:e.onColumnShow}}}}),e.olapContainer.updateLayout()}}}}]}}]}}},e.dockedItems={dock:"top",height:60,layout:"vbox",border:0,bodyPadding:5,defaults:{width:"100%"},items:[{xtype:"label",text:"- Чтобы скрыть/отобразить столбец используйте контекстное меню любого столбца."},{xtype:"label",text:"- Перетащите столбец мышью для изменения его местоположения."},{xtype:"label",text:"- Ширина столбцов настраивается в заголовке таблицы на границах столбцов."}]}),this.callParent(arguments)},getClassAndClassAttr:function(e,t){var s,n={};for(s in t.from[0])break;n[s]=$o.getClass(t.from[0][s]);for(var r=1;r<t.from.length;r+=4){for(s in t.from[r+1])break;n[s]=$o.getClass(t.from[r+1][s])}for(var r=1;r<t.select.length;r+=2)if(t.select[r]==e){for(s in t.select[r-1])break;var i=t.select[r-1][s];return[n[s],n[s].attrs[i]]}},updateAttrs:function(){var e,t=this,s=[];try{e=JSON.parse(t.$view.get("query"));var n=1;for(var r in t.$view.attrs)t.$view.attrs[r].order&&t.$view.attrs[r].order>=n&&(n=t.$view.attrs[r].order+1);for(var i=1;i<e.select.length;i+=2){var r=e.select[i];if(s.push(r),!t.$view.attrs[r]){var a=t.getClassAndClassAttr(r,e),o=a[1]?a[1].get("name"):r;("a_id"==r||"c"==r[0]&&"_id"==r.substr(r.length-3,3))&&(o="id");var l=$o.createViewAttr({name:o,code:r,view:t.viewId,area:1,width:75,class:a[0].get("id"),order:n++,classAttr:a[1]?a[1].get("id"):null});l.sync()}}for(var r in t.$view.attrs)if(s.indexOf(r)==-1){var l=t.$view.attrs[r];l.remove(),l.sync()}return 1}catch(e){t.items={layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"label",text:"Извините, не удалось декодировать исходный код запроса"}]}}},onColumnResize:function(e,t,s){if(t.$field){var n=t.$field.id,r=$o.getViewAttr(n);r.set("width",s),r.sync(),this.olapAttrs&&this.olapAttrs.refresh()}},onColumnMove:function(e,t,s,n){for(var r=e.getGridColumns(),i=0;i<r.length;i++)if(r[i].$field){var a=$o.getViewAttr(r[i].$field.id);a.get("order")!=i+1&&(a.set("order",i+1),a.sync())}this.olapAttrs&&this.olapAttrs.refresh()},onColumnHide:function(e,t){if(t.$field){var s=t.$field.id,n=$o.getViewAttr(s);n.set("area",0),n.sync(),this.olapAttrs&&this.olapAttrs.refresh()}},onColumnShow:function(e,t){if(t.$field){var s=t.$field.id,n=$o.getViewAttr(s);n.set("area",1),n.sync(),this.olapAttrs&&this.olapAttrs.refresh()}}}),Ext.define("$o.ReportDesigner.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.reportdesigner","widget.$reportdesigner"],layout:"vbox",border:0,initComponent:function(){var e=this;e.startRowsNum=10,e.startColsNum=50;for(var t=[],s=0;s<e.startRowsNum;s++){for(var n=[],r=0;r<e.startColsNum;r++)n.push({text:"",style:"s1"});t.push({height:20,cells:n})}for(var i=[],s=0;s<e.startColsNum;s++)i.push(50);e.value=e.value||{name:void 0,code:void 0,query:[],styles:{s1:{hAlign:"Left",vAlign:"Top",wrap:!0,fontSize:10}},sheets:[{name:"Лист1",columns:i,rows:t}]},e.divId="div-"+ ++Ext.Component.AUTO_ID,e.items=[{xtype:"tabpanel",width:"100%",deferredRender:!1,flex:1,items:[{title:"Шаблон",iconCls:"gi_edit",autoScroll:!0,tbar:[{text:"Объединить",iconCls:"gi_resize_small",handler:function(){e.selectedRange&&(e.ht.mergeCells.mergeOrUnmergeSelection(e.selectedRange),e.ht.render())}},{iconCls:"gi_bold",tooltip:"Полужирный",handler:function(){e.updateProp("bold","bool")}},{iconCls:"gi_italic",tooltip:"Курсив",handler:function(){e.updateProp("italic","bool")}},{iconCls:"gi_unchecked",tooltip:"Рамка",handler:function(){e.updateProp("borders","bool")}},"-",{iconCls:"gi_align_left",tooltip:"Горизонтально: Слева",handler:function(){e.updateProp("hAlign","Left")}},{iconCls:"gi_align_center",tooltip:"Горизонтально: По центру",handler:function(){e.updateProp("hAlign","Center")}},{iconCls:"gi_align_right",tooltip:"Горизонтально: Справа",handler:function(){e.updateProp("hAlign","Right")}},"-",{iconCls:"gi_up_arrow",tooltip:"Вертикально: Сверху",handler:function(){e.updateProp("vAlign","Top")}},{iconCls:"gi_minus",tooltip:"Вертикально: По центру",handler:function(){e.updateProp("vAlign","Middle")}},{iconCls:"gi_down_arrow",tooltip:"Вертикально: Внизу",handler:function(){e.updateProp("vAlign","Bottom")}}],html:"<div id='"+e.divId+"' style='width: 100%; height: 100%;'></div>"},{title:"Настройка",iconCls:"gi_settings",layout:"vbox",bodyPadding:3,border:!1,items:[{xtype:"textfield",name:"name",fieldLabel:"Наименование",width:"100%",value:e.value.name},{xtype:"textfield",name:"code",fieldLabel:"Код",width:"100%",value:e.value.code},{xtype:"combo",fieldLabel:"Ориентация",name:"orientation",width:250,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["portrait","Книжная"],["landscape","Альбомная"]]}),value:e.value.sheets[0].orientation?e.value.sheets[0].orientation:"portrait",valueField:"id",displayField:"text"},{xtype:"$o.reportquery",width:"100%",flex:1,value:e.value.query,listeners:{change:function(t){e.value.query=t}}}]}]}],e.on("afterrender",function(){window.Handsontable?e.make():$o.util.loadJS("/third-party/js/jquery-2.1.1.min.js",function(){$o.util.loadCSS("/third-party/handsontable/jquery.handsontable.full.css",function(){$o.util.loadJS("/third-party/handsontable/jquery.handsontable.full.min.js",function(){$(document).ready(function(){e.make()})})})})},e),e.addEvents("change"),e.callParent(arguments)},updateProp:function(e,t){var s=this,n=s.selectedArea;if(n){for(var r=n.row;r<n.row+n.rowspan;r++)for(var i=n.col;i<n.col+n.colspan;i++)if("bool"==t){var a=!0;s.styleObjects[s.cellStyle[r+"_"+i]]&&(a=!s.styleObjects[s.cellStyle[r+"_"+i]][e]);var o=s.createStyle(s.cellStyle[r+"_"+i],e,a);s.cellStyle[r+"_"+i]=o}else{var o=s.createStyle(s.cellStyle[r+"_"+i],e,t);s.cellStyle[r+"_"+i]=o}s.ht.selectCell(n.row,n.col,n.row+n.rowspan-1,n.col+n.colspan-1),s.ht.render()}},addCol:function(){var e=this;e.ht.alter("insert_col",e.selectedArea.col,1)},removeCol:function(){var e=this;e.ht.alter("remove_col",e.selectedArea.col,1)},addRow:function(){var e=this;e.ht.alter("insert_row",e.selectedArea.row,1)},removeRow:function(){var e=this;e.ht.alter("remove_row",e.selectedArea.row,1)},createStyle:function(e,t,s){var n=this,r=e?$o.util.clone(n.styleObjects[e]):{};r[t]=s;var i,a=0;for(var e in n.styleObjects){var o=n.styleObjects[e];if(JSON.stringify(o).length==JSON.stringify(r).length){var l=1;for(var c in r)if(r[c]!=o[c]){l=0;break}if(l){i=e;break}}a<Number(e.substr(1))&&(a=Number(e.substr(1)))}return i?i:(n.styleObjects["s"+(a+1)]=r,"s"+(a+1))},getData:function(){var e,t=this,s=t.value.sheets[0].rows,n=[];for(t.cellStyle={},e=0;e<s.length;e++){var r,i={},a=s[e].cells;for(r=0;r<a.length;r++)i["c"+r]=a[r].text,t.cellStyle[e+"_"+r]=a[r].style;for(;r<t.startColsNum;r++)i["c"+r]="";n.push(i)}return n},getColWidths:function(){for(var e=this,t=e.value.sheets[0].columns,s=t.length;s<e.startColsNum;s++)t.push(50);return t},getColumns:function(){for(var e=this,t=e.value.sheets[0].rows,s=e.startColsNum,n=0;n<t.length;n++)t[n].cells.length>s&&(s=t[n].cells.length);for(var r=[],n=0;n<s;n++)r.push({data:"c"+n,renderer:e.cellRenderer});return r},setStyles:function(){var e=this;e.styleObjects=e.value.styles},getRowHeights:function(){for(var e=this,t=[],s=e.value.sheets[0].rows,n=0;n<s.length;n++)t.push(s[n].height);return t},getMergeCells:function(){var e=this,t=e.value.sheets[0].mergeCells;return t||!0},make:function(){var e=this;Handsontable.cmp=Handsontable.cmp||{},Handsontable.cmp[e.divId]=e,e.setStyles();var t={data:e.getData(),colWidths:e.getColWidths(),columns:e.getColumns(),rowHeights:e.getRowHeights(),mergeCells:e.getMergeCells(),manualColumnResize:!0,manualRowResize:!0,rowHeaders:!0,colHeaders:!0,minSpareRows:1,minSpareCols:1,contextMenu:!0,beforeRender:function(){this.cmp=e,e.ht=this},afterSelectionEnd:function(t,s,n,r){e.selectedArea={row:t,col:s,rowspan:n-t+1,colspan:r-s+1},e.selectedRange=this.getSelectedRange()}};$("#"+e.divId).handsontable(t)},cellRenderer:function(e,t,s,n){var r=e.cmp;Handsontable.renderers.TextRenderer.apply(this,arguments),t.style.fontFamily="sans-serif";var i=r.styleObjects[r.cellStyle[s+"_"+n]]||{};return i.fontSize?t.style.fontSize=i.fontSize+"pt":t.style.fontSize="10pt",i.hAlign?t.style.textAlign=i.hAlign.toLowerCase():t.style.textAlign="left",i.vAlign?t.style.verticalAlign=i.vAlign.toLowerCase():t.style.verticalAlign="top",i.bold&&(t.style.fontWeight="bold"),i.italic&&(t.style.fontStyle="italic"),i.borders&&(t.style.border="1px solid black"),t},getValue:function(){for(var e=this,t=e.ht.getData(),s=[],n=0;n<t.length;n++){for(var r=[],i=0;i<e.ht.countCols();i++)r.push({text:t[n]["c"+i],style:e.cellStyle[n+"_"+i]});s.push({height:e.ht.getRowHeight(n),cells:r})}for(var a=[],n=0;n<e.ht.countCols();n++)a.push(e.ht.getColWidth(n));var o={name:e.down("textfield[name=name]").getValue(),code:e.down("textfield[name=code]").getValue(),query:e.value.query,styles:e.styleObjects,sheets:[{name:"Sheet1",orientation:e.down("*[name=orientation]").getValue(),columns:a,rows:s,mergeCells:e.ht.mergeCells.mergedCellInfoCollection,
countEmptyRows:e.ht.countEmptyRows(!0),countEmptyCols:e.ht.countEmptyCols(!0)}]};return o},build:function(e){var t=this;if(t.processTags(e),e.preview)t.generateXMLSS().preview();else if(e.html){var s=t.generateHTML();t.previewHTML(s)}else{var n=t.generateXMLSS();e.pdf?n.createPDF():n.create()}},generateXMLSS:function(){for(var e=this,t=[],s=e.value.sheets[0].rows,n=e.value.sheets[0].mergeCells,r=0;r<s.length;r++){for(var i=[],a=s[r].cells,o=0;o<a.length;o++){for(var l=1,c=1,d=0,u=0;u<n.length;u++){if(n[u].row==r&&n[u].col==o){l=n[u].colspan,c=n[u].rowspan;break}if(r>=n[u].row&&r<n[u].row+n[u].rowspan&&o>=n[u].col&&o<n[u].col+n[u].colspan){d=1;break}}d||i.push({text:a[o].text,style:a[o].style,colspan:l,rowspan:c,startIndex:o+1})}t.push({height:.75*s[r].height,cells:i})}var f={default:"hAlign:Left,vAlign:Center,wrap:true,fontSize:10"},g=e.value.styles;for(var m in g){var p=g[m],h=["wrap:true"];p.fontSize&&h.push("fontSize:"+p.fontSize),p.hAlign&&h.push("hAlign:"+p.hAlign),p.vAlign&&h.push("vAlign:"+("Middle"==p.vAlign?"Center":p.vAlign)),p.bold&&h.push("bold:true"),p.italic&&h.push("italic:true"),p.borders&&h.push("borders:All"),f[m]=h.join(",")}for(var i=[],v=e.value.sheets[0].columns,r=0;r<v.length;r++)i.push(v[r]/7);var b=new $report.xmlss;return b.styles=f,b.sheets=[new $report.sheet({name:"Лист1",orientation:e.value.sheets[0].orientation,margins:{left:15,top:15,right:15,bottom:15},columns:i,rows:t})],b},generateHTML:function(e){for(var t=this,s="",n=t.value.sheets[0].rows,r=t.value.sheets[0].columns,i=t.value.sheets[0].mergeCells,a={},o=0;o<n.length;o++){for(var l=n[o],c=l.cells,d="<tr style='height:"+l.height+"px'>",u=0;u<c.length;u++){for(var f=1,g=1,m=0,p=0;p<i.length;p++){if(i[p].row==o&&i[p].col==u){f=i[p].colspan,g=i[p].rowspan;break}if(o>=i[p].row&&o<i[p].row+i[p].rowspan&&u>=i[p].col&&u<i[p].col+i[p].colspan){m=1;break}}if(!m){var h="",v=c[u],b=v.text;void 0!==b&&null!==b&&""!==b||(b="<img width=1 height=1>");var y=t.value.styles[v.style];y=y||{},y.bold>-1&&(h="font-weight:bold;"),y.italic>-1&&(h="font-style:italic;"),y.hAlign&&(h+="text-align:"+y.hAlign.toLowerCase()+";"),y.vAlign&&(h+="vertical-align:"+y.vAlign.toLowerCase()+";"),y.borders&&(a[o]=a[o]||{},a[o][u]=1,a[o-1]&&a[o-1][u]||(h+="border-top:1px solid black;"),a[o][u-1]||(h+="border-left:1px solid black;"),h+="border-right:1px solid black;",h+="border-bottom:1px solid black;"),h+="width:"+r[u]+"px;padding:2px;",d+="<td class='tb-text' colspan="+f+" rowspan="+g+" style='"+h+"'>"+b+"</td>"}}d+="</tr>\n",s+=d}return s},previewHTML:function(e){var t=this;r="<style type='text/css'>\n* {\n   font-family: Tahoma;\n   font-size: 8pt;\n}\n</style>\n","landscape"==t.value.sheets[0].orientation&&(r+='<style type="text/css" media="print">\n\t@page { size: landscape; }\n</style>\n'),r+="<table cellpadding=0 cellspacing=0>"+e+"</table>",w=window.open("","window1","width=800, height=600, resizable=yes, scrollbars=yes, status=yes, top=10, left=10"),w.document.open(),w.document.write(r),w.document.close(),w.print()},processObject:function(e,t,s,n,r){var i=this,a=[],o=t.cells,l=s[e],c=0;for(var d in l){for(var u=[],f=0;f<o.length;f++){for(var g=o[f].text,m=0;m<n.length;m++){var p=n[m],h=void 0==s[p]?"":s[p],v=p.split(".");if(v[0]==e&&v.length>1)for(var b=1,h=l[d];b<v.length;b++)h=h?h[v[b]]:void 0;void 0==h&&(h=""),g=g.split("[#"+n[m]+"]").join(h)}u.push({text:g,style:o[f].style})}a.push({height:t.height,cells:u}),c++,c>1&&i.moveMergeCells(r)}return a},processQuery:function(e,t,s,n,r,i){var a=this,o=[],l=s.cells,c=$o.getView(t.view),d=JSON.parse(c.get("query"));if(t.filter&&t.filter.length){for(var u=t.filter,f=0;f<u.length;f++){var g=u[f];"["==g[0]&&"#"==g[1]&&(u[f]=n[g.substr(2,g.length-3)]);for(var m=1;m<d.select.length;m+=2)d.select[m]==g&&(u[f]=d.select[m-1])}d.where=d.where||[],d.where.length&&(d.where=[d.where,"and"]),d.where.push(u)}for(var p=$o.execute(d),h=0,f=0;f<p.length;f++){for(var v=[],m=0;m<l.length;m++){for(var b=l[m].text,y=0;y<r.length;y++){var w=r[y],c=void 0==n[w]?"":n[w],x=w.split(".");x[0]==e&&x.length>1&&(c=p.get(f,x[1])),b=b.split("[#"+r[y]+"]").join(c)}v.push({text:b,style:l[m].style})}o.push({height:s.height,cells:v}),h++,h>1&&a.moveMergeCells(i)}return o},moveMergeCells:function(e){for(var t=this,s=t.value.sheets[0].mergeCells,n=0;n<s.length;n++)s[n].row>=e&&s[n].row++},processTags:function(e){for(var t=this,s=[],n=t.value.sheets[0].rows,r={},i=0;i<t.value.query.length;i++)r[t.value.query[i].alias]=t.value.query[i];for(var i=0;i<n.length;i++){for(var a=n[i].cells,o=[],l="",c="",d=0;d<a.length;d++)for(var u=a[d].text||"",f=1;f<u.length;f++)if("#"==u[f]&&"["==u[f-1]){var g="";for(f++;f<u.length&&"]"!=u[f];f++)g+=u[f];o.indexOf(g)==-1&&(o.push(g),Ext.isArray(e[g.split(".")[0]])&&(l=g.split(".")[0]),r[g.split(".")[0]]&&(c=g.split(".")[0]))}if(c)s=s.concat(t.processQuery(c,r[c],n[i],e,o,s.length));else if(l)s=s.concat(t.processObject(l,n[i],e,o,s.length));else{for(var m=[],d=0;d<a.length;d++){for(var u=a[d].text||"",f=0;f<o.length;f++){for(var g=o[f],p=g.split("."),h=0,v=e;h<p.length;h++)v=v?v[p[h]]||"":"";u=u.split("[#"+g+"]").join(v)}m.push({text:u,style:a[d].style})}s.push({height:n[i].height,cells:m})}}t.value.sheets[0].rows=s}}),Ext.define("$o.ReportQuery.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.reportquery","widget.$reportquery"],layout:"fit",border:!1,initComponent:function(){var e=this;e.store=Ext.create("Ext.data.Store",{data:e.getData(),fields:[{name:"alias",type:"string"},{name:"view",type:"string"}]}),e.grid=Ext.create("Ext.grid.Panel",{store:e.store,columns:[{header:"Псевдоним",width:100,dataIndex:"alias"},{header:"Запрос",dataIndex:"view",flex:1}],forceFit:!0,frame:!1,deferRowRender:!1,listeners:{afterrender:function(){var t=this.getSelectionModel();t.on("selectionchange",function(){if(t.hasSelection()){var s=t.getSelection()[0];e.down("*[name=filter]").enable(),e.down("*[name=filter]").setViewId(e.data[s.get("alias")].view),e.down("*[name=filter]").setValue(e.data[s.get("alias")].filter)}})}}}),e.items={layout:"border",border:!1,items:[{split:!0,region:"west",width:"50%",layout:"fit",tbar:[{text:"Добавить",name:"create",iconCls:"gi_circle_plus",handler:e.create,scope:e},{text:"Удалить",name:"delete",iconCls:"gi_circle_minus",handler:e.remove,scope:e}],title:"Запросы",iconCls:"gi_cogwheel",border:!1,items:e.grid},{region:"center",layout:"fit",title:"Фильтр",iconCls:"gi_filter",border:!1,items:{xtype:"$layoutfilter",name:"filter",disabled:!0,reportMode:1,listeners:{change:e.updateFilter,scope:e}}}]},e.addEvents("change"),e.callParent(arguments)},getData:function(){var e=this,t=[];e.data={};for(var s=0;s<e.value.length;s++)t.push({alias:e.value[s].alias,view:$o.getView(e.value[s].view).toString()}),e.data[e.value[s].alias]={alias:e.value[s].alias,filter:e.value[s].filter,view:e.value[s].view};return t},create:function(){var e=this;dialog.getView({hasQuery:1,success:function(t){for(var s=0,n=0;n<e.store.getCount();n++){var r=e.store.getAt(n).get("alias");Number(r.substr(1))>s&&(s=Number(r.substr(1)))}var r="q"+(s+1),i={alias:r,view:$o.getView(t.id).toString()};e.store.add(i),e.data[r]={alias:r,view:$o.getView(t.id).getFullCode()},e.fireEvent("change",e.getValue())}})},remove:function(){var e=this,t=e.grid.getSelectionModel();if(t.hasSelection()){var s=t.getSelection()[0];e.store.remove(s),e.down("*[name=filter]").disable(),e.fireEvent("change",e.getValue())}},getValue:function(){for(var e=this,t=[],s=0;s<e.store.getCount();s++){var n=e.store.getAt(s).get("alias");t.push(e.data[n])}return t},updateFilter:function(e){var t=this,s=t.grid.getSelectionModel(),n=s.getSelection()[0];t.data[n.get("alias")].filter=e,t.fireEvent("change",t.getValue())}}),Ext.define("$o.ReportCondition.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.reportcondition","widget.$reportcondition"],layout:"vbox",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.filter=e.filter||[],e.value={},e.tbar=[{text:"Ок",iconCls:"gi_ok",name:"save",disabled:1,handler:e.save,scope:e},{text:"Отмена",iconCls:"gi_remove",name:"cancel",handler:function(){e.up("window").close()}}];var t=[];for(var s in e.$view.attrs){var n=e.$view.attrs[s];t.push([s,n.toString()])}e.items=[{xtype:"combo",fieldLabel:"И/ИЛИ",labelWidth:200,name:"and_or",width:350,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["and","И"],["or","ИЛИ"]]}),valueField:"id",displayField:"text"},{xtype:"combo",fieldLabel:"Атрибут",name:"attr",width:"100%",labelWidth:200,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:t}),valueField:"id",displayField:"text",validator:e.validator},{xtype:"combo",fieldLabel:"Оператор",labelWidth:200,name:"oper",width:350,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["=","равно (=)"],["<>","не равно (<>)"],["<","меньше (<)"],[">","больше (>)"],["<=","меньше или равно (<=)"],[">=","больше или равно (>=)"],["is null","пусто (is null)"],["is not null","не пусто (is not null)"],["in","одно из перечня (in)"]]}),valueField:"id",displayField:"text",listeners:{select:function(){var t=this.getValue();"is null"==t||"is not null"==t?e.down("*[name='value']").disable():e.down("*[name='value']").enable()}},validator:e.validator},{xtype:"textfield",fieldLabel:"Значение",labelWidth:200,width:"100%",name:"value",validator:e.validator}],e.filter.length||e.items.splice(0,1),e.items[0].style="margin-top: 5px;",e.addEvents("aftersave"),this.callParent(arguments)},validator:function(e){var t=this.up("panel"),s=t.down("*[name='and_or']"),n=t.down("*[name='attr']"),r=t.down("*[name='oper']"),i=t.down("*[name='value']");if(s&&!s.getValue())return t.down("button[name='save']").disable(),!0;if(n.getValue()&&r.getValue()&&("is null"==r.getValue()||"is not null"==r.getValue()||i.getValue())){if(t.down("button[name='save']").enable(),"is null"==r.getValue()||"is not null"==r.getValue())t.value=[n.getValue(),r.getValue()];else{var a=i.getValue();t.value=[n.getValue(),r.getValue(),a]}s&&(t.value=[s.getValue()].concat(t.value))}else t.down("button[name='save']").disable(),t.value=[];return!0},save:function(){var e=this;e.fireEvent("aftersave",e.value)},getValue:function(){var e=this;return e.value}}),Ext.define("$o.ProjectDesigner.Widget",{extend:"Ext.tab.Panel",alias:["widget.$o.projectdesigner","widget.$projectdesigner"],layout:"fit",border:!1,defaults:{border:!1},bodyPadding:5,deferredRender:!1,initComponent:function(){var e=this,t=Ext.create("Ext.data.Store",{fields:["action","line","msg","src"],data:[]}),s=Ext.create("Ext.grid.Panel",{name:"errors",store:t,columns:[{text:"Сообщение",dataIndex:"msg",flex:3,renderer:e.cellRenderer},{text:"Действие",dataIndex:"action",width:250,renderer:e.cellRenderer},{text:"Строка",dataIndex:"line",width:80},{text:"Исходный код",dataIndex:"src",flex:2,renderer:e.cellRenderer}],width:"100%",forceFit:!0,flex:1,selModel:Ext.create("Ext.selection.RowModel",{mode:"SINGLE",listeners:{selectionchange:function(){e.down("*[name=showAction]").enable()}}}),tbar:[{text:"Исходный код действия",iconCls:"gi_notes",name:"showAction",disabled:1,handler:function(){var t=e.down("*[name=errors]");if(t.getSelectionModel().hasSelection()){var s=t.getSelectionModel().getSelection()[0],n=s.get("action"),r=$o.getAction(n),i=r.get("body"),a=Ext.create("Ext.Window",{width:800,height:600,layout:"fit",frame:!1,border:!1,bodyPadding:1,modal:!1,maximizable:!0,title:"Исходный код действия: "+r.toString(),iconCls:"gi_notes",items:{name:"body",xtype:"codemirrortextarea",listeners:{afterrender:function(){this.setValue(i)}}},tbar:[{text:"Сохранить",iconCls:"gi_floppy_save",handler:function(){r.set("body",a.down("*[name=body]").getValue()),r.sync(),r.initAction(),a.close()}},{text:"Отмена",iconCls:"gi_remove",handler:function(){a.close()}}]});a.show()}}}]});e.listeners={afterrender:function(){$o.execute({fn:"vo.getProjectInfo",success:function(t){if(e.down("*[name=revision]").setValue(t.revision),e.down("*[name=name]").setValue(t.name),t.smtp=t.smtp||{},e.down("*[name=smtpHost]").setValue(t.smtp.host),e.down("*[name=smtpUsername]").setValue(t.smtp.username),e.down("*[name=smtpPassword]").setValue(t.smtp.password),e.down("*[name=smtpSender]").setValue(t.smtp.sender),e.down("*[name=timeMachineCardButton]").setValue($o.visualObjectum.timeMachine.cardButton),e.down("*[name=timeMachineShowDates]").setValue($o.visualObjectum.timeMachine.showDates),e.down("*[name=timeMachineBuildTime]").setValue($o.visualObjectum.timeMachine.buildTime),e.down("*[name=logoLeft]").setValue($o.visualObjectum.logo.left),e.down("*[name=logoRight]").setValue($o.visualObjectum.logo.right),e.down("*[name=logoHeight]").setValue($o.visualObjectum.logo.height),$o.visualObjectum.initAction&&e.down("*[name=initAction]").setValue($o.getAction($o.visualObjectum.initAction).get("id")),t.scripts&&t.scripts.client){for(var s=[],n=0;n<t.scripts.client.length;n++)s.push({name:t.scripts.client[n]});e.down("*[name=clientScripts]").getStore().loadData(s)}}})}},e.items=[{title:"Общие",iconCls:"gi_file",layout:"vbox",items:[{xtype:"textfield",fieldLabel:"Ревизия проекта",name:"revision",labelWidth:200,width:355,style:"margin-top: 5px",disabled:!0},{xtype:"textfield",fieldLabel:"Наименование проекта",labelWidth:200,name:"name",width:"100%"},{xtype:"compositefield",fieldLabel:"Пароль администратора",labelWidth:200,items:[{xtype:"textfield",name:"password",inputType:"password",width:150},{xtype:"displayfield",value:"Введите пароль еще раз:",style:"margin-left: 5px; margin-right: 2px"},{xtype:"textfield",name:"password2",inputType:"password",width:150}]},{xtype:"fieldset",title:"SMTP",width:"100%",items:{layout:"hbox",border:0,bodyPadding:5,items:[{xtype:"textfield",name:"smtpHost",fieldLabel:"Хост"},{xtype:"textfield",name:"smtpUsername",style:"margin-left: 10px",fieldLabel:"Пользователь"},{xtype:"textfield",name:"smtpPassword",style:"margin-left: 10px",fieldLabel:"Пароль",inputType:"password"},{xtype:"textfield",name:"smtpSender",style:"margin-left: 10px",fieldLabel:"Отправитель"}]}},{xtype:"fieldset",title:"Time machine",width:"100%",items:{layout:"hbox",border:0,bodyPadding:5,items:[{xtype:"checkbox",name:"timeMachineCardButton",fieldLabel:"Отобразить кнопку 'Изменения' в карточке",labelWidth:250},{xtype:"checkbox",name:"timeMachineShowDates",style:"margin-left: 50px",fieldLabel:"Включить выбор даты",labelWidth:150},{xtype:"timefield",name:"timeMachineBuildTime",style:"margin-left: 50px",fieldLabel:"Время создания даты (UTC)",labelWidth:150,width:230,editable:!1}]}},{layout:"hbox",border:0,style:"padding-top: 5px; padding-bottom: 5px",width:"100%",items:[{xtype:"button",text:"Сборка проекта",iconCls:"gi_settings",handler:function(){e.down("*[name=time]").setValue("Сборка ..."),e.down("*[name=errNum]").setValue("Сборка ..."),e.down("*[name=showAction]").disable(),$o.app.name=$ptitle=e.down("*[name=name]").getValue();var t={name:e.down("*[name=name]").getValue(),build:e.down("radiogroup").getValue().rgBuild};if(e.down("*[name=password]").getValue()){if(e.down("*[name=password]").getValue()!=e.down("*[name=password2]").getValue())return void common.message("Введенные пароли не совпадают.");t.password=$o.util.sha1(e.down("*[name=password]").getValue())}t.smtp={host:e.down("*[name=smtpHost]").getValue(),username:e.down("*[name=smtpUsername]").getValue(),password:e.down("*[name=smtpPassword]").getValue(),sender:e.down("*[name=smtpSender]").getValue()};var s=e.down("*[name=timeMachineBuildTime]").getValue();t.timeMachine={cardButton:e.down("*[name=timeMachineCardButton]").getValue()?1:0,showDates:e.down("*[name=timeMachineShowDates]").getValue()?1:0},t.logo={left:e.down("*[name=logoLeft]").getValue(),right:e.down("*[name=logoRight]").getValue(),height:e.down("*[name=logoHeight]").getValue()},e.down("*[name=initAction]").getValue()&&(t.initAction=$o.getAction(e.down("*[name=initAction]").getValue()).getFullCode()),s&&(t.timeMachine.buildTime=(s.getHours()<10?"0"+s.getHours():s.getHours())+":"+(s.getMinutes()<10?"0"+s.getMinutes():s.getMinutes())),$o.visualObjectum.timeMachine.cardButton=t.timeMachine.cardButton,$o.visualObjectum.timeMachine.showDates=t.timeMachine.showDates,$o.visualObjectum.timeMachine.buildTime=t.timeMachine.buildTime;for(var n=[],r=e.down("*[name=clientScripts]").getStore(),i=0;i<r.getCount();i++)n.push(r.getAt(i).get("name"));t.scripts={client:n},$o.execute({fn:"vo.build",args:t,success:function(t){e.showBuildResults(t),t.err&&t.err.length||(common.setConf("projectNeedBuild",{used:0}),$o.app.projectNeedBuildTooltip&&$o.app.projectNeedBuildTooltip.destroy(),e.down("*[name=revision]").setValue(t.revision),$o.execute({fn:"vo.getActions",success:function(t){e.down("*[name=actions]").setValue(t.actions)}}))}})}},{xtype:"radiogroup",columns:2,style:"margin-left: 25px",items:[{boxLabel:"Тестовая",name:"rgBuild",inputValue:"test",width:90,checked:!0},{boxLabel:"Продуктивная",name:"rgBuild",inputValue:"prod"}]}]},{layout:"hbox",border:0,style:"padding-top: 5px; padding-bottom: 5px",width:"100%",items:[{xtype:"textfield",labelWidth:200,disabled:1,name:"errNum",width:300,fieldLabel:"Количество ошибок"},{xtype:"textfield",disabled:1,name:"time",style:"margin-left: 10px",width:200,fieldLabel:"Время сборки"}]},s]},{title:"Дополнительно",iconCls:"gi_file",layout:"vbox",items:[{xtype:"grid",title:"Клиентские скрипты",name:"clientScripts",store:Ext.create("Ext.data.Store",{fields:["name"],data:[]}),columns:[{text:"Путь к скрипту на сервере",dataIndex:"name"}],width:"100%",forceFit:!0,height:150,tbar:[{text:"Добавить",iconCls:"gi_circle_plus",handler:function(){var e=this.up("grid");dialog.getString({fieldLabel:"Введите путь к скрипту на сервере",success:function(t){e.getStore().add({name:t})}})}},{text:"Удалить",iconCls:"gi_circle_minus",handler:function(){var e=this.up("grid"),t=e.getSelectionModel();if(t.hasSelection()){var s=t.getSelection()[0];e.getStore().remove(s)}}}]},{fieldLabel:"Действие инициализации клиента",labelWidth:200,width:600,xtype:"$conffield",name:"initAction",anchor:"100%",confRef:"action",style:"margin-top: 5px",choose:{type:"custom",fn:function(){var e=this;dialog.getAction({success:function(t){e.setValue(t.id)}})}}},{xtype:"fieldset",title:"Логотип",width:"100%",items:{layout:"vbox",border:0,bodyPadding:5,items:[{xtype:"textfield",name:"logoLeft",fieldLabel:"Изображение слева",width:"100%"},{xtype:"textfield",name:"logoRight",fieldLabel:"Изображение справа",width:"100%"},{xtype:"numberfield",name:"logoHeight",fieldLabel:"Высота полосы"}]}}]},{title:"Серверные действия",iconCls:"gi_notes",layout:"fit",tbar:[{text:"Обновить",iconCls:"gi_refresh",handler:function(){$o.execute({fn:"vo.getActions",success:function(t){e.down("*[name=actions]").setValue(t.actions)}})}}],items:{xtype:"codemirrortextarea",name:"actions",listeners:{afterrender:function(){var e=this;$o.execute({fn:"vo.getActions",success:function(t){e.setValue(t.actions)}})}}}}],this.callParent(arguments)},showBuildResults:function(e){var t=this;t.down("*[name=time]").setValue((e.time/1e3).toFixed(3)+" сек."),e.err=e.err||[],t.down("*[name=errNum]").setValue(e.err.length),t.down("*[name=errors]").getStore().loadData(e.err)},cellRenderer:function(e,t,s,n,r,i){return t.style="white-space: normal;",e}}),Ext.define("$o.CardDesigner.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.carddesigner","widget.$carddesigner"],layout:"fit",border:0,defaults:{border:0},initComponent:function(){var e=this;e.counter=1,e.data={},e.treeStore=Ext.create("Ext.data.TreeStore",{autoSync:!0,root:{expanded:!0,children:[]}}),e.storeAttrs=new Ext.data.ArrayStore({fields:["id","text"],data:[]}),e.storeViewAttrs=new Ext.data.ArrayStore({fields:["id","text"],data:[]}),e.items={layout:"border",border:!1,style:"margin: 2px",defaults:{border:!1},items:[{split:!0,region:"west",width:"50%",layout:"fit",items:{title:"Навигатор",iconCls:"gi_search",xtype:"treepanel",name:"tree",store:e.treeStore,selModel:Ext.create("Ext.selection.TreeModel",{mode:"SINGLE",listeners:{selectionchange:{fn:e.selectionChange,scope:e}}}),rootVisible:!1,viewConfig:{plugins:{ptype:"treeviewdragdrop",containerScroll:!0},listeners:{beforedrop:function(e,t,s,n,r){return"Поле:"==t.records[0].get("text").substr(0,5)||"Составное:"!=s.parentNode.get("text").substr(0,10)}}},listeners:{cellcontextmenu:function(t,s,n,r,i,a,o,l){e.down("treepanel").getSelectionModel().deselectAll()}}}},{region:"center",layout:"fit",items:{title:"Параметры",iconCls:"gi_file",layout:"vbox",name:"card",hidden:!0,bodyPadding:5,items:[{xtype:"combo",fieldLabel:"Атрибут",name:"attr",width:"100%",mode:"local",queryMode:"local",editable:!1,store:e.storeAttrs,valueField:"id",displayField:"text",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"textfield",fieldLabel:"Наименование",width:"100%",name:"name",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"numberfield",fieldLabel:"Ширина наименования",width:200,name:"labelWidth",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"fieldcontainer",layout:"hbox",width:"100%",items:[{xtype:"numberfield",fieldLabel:"Ширина",width:200,name:"width",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"numberfield",fieldLabel:"Высота",width:150,labelWidth:50,style:"margin-left: 5px",name:"height",cardDesigner:e,listeners:{change:e.onChange}}]},{xtype:"numberfield",fieldLabel:"Минимальное значение",width:200,name:"minValue",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"numberfield",fieldLabel:"Максимальное значение",width:200,name:"maxValue",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"checkbox",fieldLabel:"Только для чтения",name:"readOnly",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"checkbox",fieldLabel:"Отображать время",name:"showTime",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"checkbox",fieldLabel:"Редактор HTML",name:"htmlEditor",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"fieldset",title:"Выбор объекта",name:"choose",width:"100%",collapsible:1,items:[{xtype:"$conffield",fieldLabel:"Представление",labelWidth:135,name:"view",anchor:"100%",confRef:"view",choose:{type:"custom",fn:function(){var e=this;dialog.getView({success:function(t){e.setValue(t.id)}})}},cardDesigner:e,listeners:{change:e.onChange}},{xtype:"combo",fieldLabel:"Атрибут представления",labelWidth:135,name:"viewAttr",anchor:"100%",mode:"local",queryMode:"local",editable:!1,store:e.storeViewAttrs,valueField:"id",displayField:"text",cardDesigner:e,listeners:{change:e.onChange}},{fieldLabel:"Действие до выбора",labelWidth:135,xtype:"$conffield",name:"filterAction",anchor:"100%",confRef:"action",choose:{type:"custom",fn:function(){var e=this;dialog.getAction({success:function(t){e.setValue(t.id)}})}},cardDesigner:e,listeners:{change:e.onChange}},{xtype:"fieldcontainer",layout:"hbox",width:"100%",items:[{xtype:"numberfield",fieldLabel:"Ширина",width:190,labelWidth:90,name:"viewWidth",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"numberfield",fieldLabel:"Высота",width:150,labelWidth:50,style:"margin-left: 5px",name:"viewHeight",cardDesigner:e,listeners:{change:e.onChange}}]},{xtype:"checkbox",fieldLabel:"Скрыть действия",name:"hideActions",cardDesigner:e,listeners:{change:e.onChange}}]}]}}]},e.tbar=[{text:"Добавить поле",name:"addField",iconCls:"gi_circle_plus",handler:e.addField,scope:e},{text:"Добавить составное поле",name:"addComposite",iconCls:"gi_circle_plus",handler:e.addComposite,scope:e},{text:"Добавить группу",name:"addGroup",iconCls:"gi_circle_plus",handler:e.addGroup,scope:e},{text:"Удалить",disabled:!0,name:"remove",iconCls:"gi_circle_minus",handler:e.remove,scope:e}],e.bbar=[{text:"Предварительный просмотр",iconCls:"gi_search",handler:e.preview,scope:e}],e.on("afterrender",function(){e.setClassId(e.classId),e.setValue(e.value)}),this.callParent(arguments)},addField:function(){var e,t=this,s=t.down("treepanel"),n=s.getSelectionModel();n.hasSelection()?(e=n.getSelection()[0],"Поле:"==e.get("text").substr(0,5)&&(e=e.parentNode),e.set("leaf",!1)):e=s.getStore().getRootNode(),e.expand();var r={id:t.counter++,text:"Поле:",leaf:!0};e.appendChild(r)},addComposite:function(){var e,t=this,s=t.down("treepanel"),n=s.getSelectionModel();n.hasSelection()?(e=n.getSelection()[0],e.set("leaf",!1)):e=s.getStore().getRootNode(),e.expand();var r={id:t.counter++,text:"Составное:",leaf:!0};e.appendChild(r)},addGroup:function(){var e,t=this,s=t.down("treepanel"),n=s.getSelectionModel();n.hasSelection()?(e=n.getSelection()[0],e.set("leaf",!1)):e=s.getStore().getRootNode(),e.expand();var r={id:t.counter++,text:"Группа:",leaf:!0};e.appendChild(r)},selectionChange:function(){var e=this,t=e.down("treepanel"),s=t.getSelectionModel();if(e.down("*[name=addField]").enable(),e.down("*[name=addComposite]").enable(),e.down("*[name=addGroup]").enable(),s.hasSelection()){e.down("*[name=remove]").enable(),e.down("*[name=card]").show();var n=s.getSelection()[0],r="field";"Составное:"==n.get("text").substr(0,10)&&(r="composite"),"Группа:"==n.get("text").substr(0,7)&&(r="group"),"xtype:"==n.get("text").substr(0,6)&&(r="xtype"),"field"==r&&(e.down("*[name=addComposite]").disable(),e.down("*[name=addGroup]").disable()),"composite"==r&&(e.down("*[name=addComposite]").disable(),e.down("*[name=addGroup]").disable()),"field"==r&&e.down("*[name=attr]").show(),"composite"==r&&(e.down("*[name=attr]").hide(),e.down("*[name=name]").show(),e.down("*[name=labelWidth]").show(),e.down("*[name=width]").show(),e.down("*[name=height]").hide(),e.down("*[name=showTime]").hide(),e.down("*[name=minValue]").hide(),e.down("*[name=maxValue]").hide(),e.down("*[name=htmlEditor]").hide(),e.down("*[name=readOnly]").hide(),e.down("*[name=choose]").hide()),"group"==r&&(e.down("*[name=attr]").hide(),e.down("*[name=name]").show(),e.down("*[name=labelWidth]").hide(),e.down("*[name=width]").show(),e.down("*[name=height]").show(),e.down("*[name=showTime]").hide(),e.down("*[name=minValue]").hide(),e.down("*[name=maxValue]").hide(),e.down("*[name=htmlEditor]").hide(),e.down("*[name=readOnly]").hide(),e.down("*[name=choose]").hide()),e.updateCard(n.get("id"),r)}else e.down("*[name=remove]").disable(),e.down("*[name=card]").hide()},updateCard:function(e,t){var s=this;s.selectedId=e,s.data[e]=s.data[e]||{};var n=s.data[e];return!n.attr||s.tag&&n.tag==s.tag?(s.down("*[name=card]").enable(),"xtype"==t?void s.down("*[name=card]").disable():(s.down("*[name=name]").setValue(n.name),s.down("*[name=width]").setValue(n.width),s.down("*[name=labelWidth]").setValue(n.labelWidth),s.down("*[name=height]").setValue(n.height),void("field"==t&&(s.down("*[name=attr]").setValue(n.attr),s.down("*[name=showTime]").setValue(n.showTime),s.down("*[name=minValue]").setValue(n.minValue),s.down("*[name=maxValue]").setValue(n.maxValue),s.down("*[name=htmlEditor]").setValue(n.htmlEditor),s.down("*[name=readOnly]").setValue(n.readOnly),n.attr?(s.down("*[name=name]").show(),s.down("*[name=labelWidth]").show(),s.down("*[name=width]").show(),s.down("*[name=readOnly]").show(),s.attrs[n.attr].get("type")>=1e3?(s.down("*[name=choose]").show(),s.down("*[name=view]").setValue(n.view?$o.getView(n.view).get("id"):null),s.down("*[name=viewAttr]").setValue(n.viewAttr),s.down("*[name=filterAction]").setValue(n.filterAction?$o.getAction(n.filterAction).get("id"):null),s.down("*[name=viewWidth]").setValue(n.viewWidth),s.down("*[name=viewHeight]").setValue(n.viewHeight),s.down("*[name=hideActions]").setValue(n.hideActions)):s.down("*[name=choose]").hide(),3==s.attrs[n.attr].get("type")?(s.down("*[name=showTime]").show(),s.down("*[name=width]").hide()):(s.down("*[name=showTime]").hide(),s.down("*[name=width]").show()),2==s.attrs[n.attr].get("type")?(s.down("*[name=minValue]").show(),s.down("*[name=maxValue]").show()):(s.down("*[name=minValue]").hide(),s.down("*[name=maxValue]").hide()),1==s.attrs[n.attr].get("type")?(s.down("*[name=height]").show(),s.down("*[name=htmlEditor]").show()):(s.down("*[name=height]").hide(),s.down("*[name=htmlEditor]").hide())):(s.down("*[name=name]").hide(),s.down("*[name=labelWidth]").hide(),s.down("*[name=width]").hide(),s.down("*[name=height]").hide(),s.down("*[name=showTime]").hide(),s.down("*[name=minValue]").hide(),s.down("*[name=maxValue]").hide(),s.down("*[name=htmlEditor]").hide(),s.down("*[name=readOnly]").hide(),s.down("*[name=choose]").hide()))))):void s.down("*[name=card]").disable()},onChange:function(){var e=this.cardDesigner,t=this;e.data[e.selectedId]=e.data[e.selectedId]||{};var s=e.data[e.selectedId];if(s.tag=e.tag,s.classId=e.classId,"name"==t.name){s.name=t.getValue();var n=e.down("treepanel").getSelectionModel().getSelection()[0],r=n.get("text").split(":");n.set("text",r[0]+": "+s.name)}if("labelWidth"==t.name&&(s.labelWidth=t.getValue()),"width"==t.name&&(s.width=t.getValue()),"height"==t.name&&(s.height=t.getValue()),"showTime"==t.name&&(s.showTime=t.getValue()),"minValue"==t.name&&(s.minValue=t.getValue()),"maxValue"==t.name&&(s.maxValue=t.getValue()),"htmlEditor"==t.name&&(s.htmlEditor=t.getValue()),"readOnly"==t.name&&(s.readOnly=t.getValue()),"viewWidth"==t.name&&(s.viewWidth=t.getValue()),"viewHeight"==t.name&&(s.viewHeight=t.getValue()),"hideActions"==t.name&&(s.hideActions=t.getValue()),"attr"==t.name){s.attr=t.getValue(),e.updateCard(e.selectedId,"field");for(var i=$o.getClass(e.classId),a=[],o=0;o<i.attrsArray.length;o++){var l=i.attrsArray[o],c=0;for(var d in e.data)e.data[d].attr==l.get("code")&&e.data[d].tag==e.tag&&(c=1);c||a.push([l.get("code"),l.toString()])}e.storeAttrs.loadData(a),e.down("*[name=name]").getValue()||e.down("*[name=name]").setValue(s.attr?e.attrs[s.attr].get("name"):null)}if("view"==t.name){var u=s.view;s.view=t.getValue()?$o.getView(t.getValue()).getFullCode():null,u!=s.view&&e.down("*[name=viewAttr]").setValue(null);var a=[];if(t.getValue()){var f=$o.getView(t.getValue());if(f.get("layout"))a=e.layoutCard.getViewCmpAttrs(f.get("layout"));else for(var g in f.attrs)a.push([g,f.attrs[g].toString()])}e.storeViewAttrs.loadData(a)}"viewAttr"==t.name&&(s.viewAttr=t.getValue()),"filterAction"==t.name&&(s.filterAction=t.getValue()?$o.getAction(t.getValue()).getFullCode():null)},setClassId:function(e,t){var s=this;s.classId=e,s.tag=t;var n=[];if(e){var r=$o.getClass(e);s.attrs=r.attrs;for(var i=0;i<r.attrsArray.length;i++){var a=r.attrsArray[i];n.push([a.get("code"),a.toString()])}}s.storeAttrs.loadData(n)},getValue:function(e){e=e||{};var t=this,s=[],n=function(s,r){for(var i=0;i<s.childNodes.length;i++){var a=s.childNodes[i],o=t.data[a.get("id")]||{},l={};switch(o.width?l.width=o.width:l.anchor="100%",a.get("text").split(":")[0]){case"Поле":if(o.attr){var c=t.getClsByTag(o.tag),d=c.attrs,u=d[o.attr].get("type");if(l.fieldLabel=o.name,l.attr=o.attr,e.preview)l.objectId=$o.createObject(o.classId,"local").get("id");else if(t.layoutCard.value.card.object.cmpAttr){var f=o.tag.split(".");l.id=f[0],l.attr=f[1]+"."+o.attr}else l.objectId=o.tag;1==u&&(o.height&&(l.xtype="textarea",l.height=o.height),o.htmlEditor&&(l.xtype="htmleditor",l.height=l.height||100)),o.labelWidth&&(l.labelWidth=o.labelWidth),l.readOnly=o.readOnly||void 0,3==u&&(l.timefield=!!o.showTime,l.width=l.labelWidth?l.labelWidth+100:200,o.showTime&&(l.width+=100),delete l.anchor),2==u&&(l.minValue=o.minValue,l.maxValue=o.maxValue,o.width?l.width=o.width:l.width=l.labelWidth?l.labelWidth+100:200,delete l.anchor),u>=1e3&&(l.choose={type:"view",id:o.view,attr:o.viewAttr,width:o.viewWidth||void 0,height:o.viewHeight||void 0,hideActions:!!o.hideActions},o.filterAction&&(l.listeners=l.listeners||{},l.listeners.beforechoose=o.filterAction))}else l.empty=1;break;case"Составное":l.fieldLabel=o.name,l.xtype="fieldcontainer",l.layout="hbox",o.labelWidth&&(l.labelWidth=o.labelWidth);break;case"Группа":l.title=o.name,l.height=o.height?o.height:void 0,l.xtype="fieldset",l.collapsible=1;break;case"xtype":l=o.item}if(a.childNodes.length&&(l.items=[],n(a,l.items),"Составное"==a.get("text").split(":")[0]))for(var g=0;g<l.items.length;g++){var m=l.items[g];if(m.style="margin-right: 10px",m.attr&&!m.fieldLabel){
var u=t.attrs[m.attr].get("type");2!=u&&3!=u||(m.width=100),3==u&&m.timefield&&(m.width=200)}}l.empty||r.push(l)}};return n(t.treeStore.getRootNode(),s),s},getClsByTag:function(e){for(var t=this,s=t.layoutCard.value.card.object,n=0;n<s.length;n++)if(s[n].tag==e){var r=$o.getClass(s[n].cls);return r}},setValue:function(e){function t(e,r){for(var i=0;i<e.length;i++){var a,o=e[i],l=s.counter++;if("fieldcontainer"==o.xtype)a={id:l,text:"Составное: "+(o.fieldLabel||""),leaf:!(o.items&&o.items.length)},s.data[l]={name:o.fieldLabel,width:o.width,labelWidth:o.labelWidth};else if("fieldset"==o.xtype)a={id:l,text:"Группа: "+(o.title||""),leaf:!(o.items&&o.items.length)},s.data[l]={name:o.title,width:o.width,height:o.height};else if(o.objectId){var c=s.getClsByTag(o.objectId),d=c.attrs,u=d[o.attr]||d[o.attr.split(".")[1]];a={id:l,text:"Поле: "+(o.fieldLabel||u.get("name")),leaf:!0},s.data[l]={name:o.fieldLabel,width:o.width,height:o.height,showTime:!!o.timefield,minValue:o.minValue,maxValue:o.maxValue,htmlEditor:"htmleditor"==o.xtype,labelWidth:o.labelWidth,readOnly:o.readOnly,attr:u.get("code"),tag:o.objectId,classId:c.get("id")},o.choose&&(s.data[l].viewWidth=o.choose.width,s.data[l].viewHeight=o.choose.height,s.data[l].view=o.choose.id,s.data[l].viewAttr=o.choose.attr,s.data[l].filterAction=o.listeners?o.listeners.beforechoose:void 0,s.data[l].hideActions=o.choose.hideActions);for(var f=0;f<s.storeAttrs.getCount();f++)if(s.storeAttrs.getAt(f).get("id")==u.get("code")){s.storeAttrs.removeAt(f);break}}else a={id:l,text:"xtype: "+(o.xtype||""),leaf:!(o.items&&o.items.length)},s.data[l]={name:"xtype: "+(o.xtype||""),item:o};o.items&&o.items.length&&(a.children=[],t(o.items,a.children)),r==n?r.appendChild(a):r.push(a)}}var s=this;e=e||[];for(var n=s.down("treepanel").getRootNode(),r=n.childNodes.length-1;r>=0;r--)n.childNodes[r].remove();t(e,n)},remove:function(){var e=this,t=e.down("treepanel"),s=t.getSelectionModel(),n=s.getSelection()[0],r=n.parentNode;delete e.data[n.get("id")],e.down("*[name=attr]").setValue(null),n.remove(),r==t.getStore().getRootNode()||r.childNodes.length||r.set("leaf",!0)},preview:function(e){var t=this,s=Ext.create("Ext.Window",{width:800,height:600,layout:"fit",bodyPadding:5,border:!1,resizable:!0,closable:!0,modal:!0,items:{xtype:"$layout",$layout:{card:{hideToolbar:1,items:t.getValue({preview:1})}}}});s.show()}}),Ext.define("$o.app",{singleton:!0,mixins:{observable:"Ext.util.Observable"},extReady:!1,constructor:function(e){this.mixins.observable.constructor.call(this,e),this.addEvents("extReady","ready","viewLayout")},message:function(e,t){Ext.Msg.alert($o.app.name||$o.app.code,e,t)},login:function(e){var t=this,s=e,n=e.success;if($o.authorized)return void n.call(s.scope||this,s);if($o.util.getCookie("esiaUser")&&(e.login=$o.util.getCookie("esiaUser"),$o.util.setCookie("esiaUser","","/"),e.hash=$o.util.getCookie("esiaHash"),$o.util.setCookie("esiaHash","","/"),$o.util.setCookie("esiaAuth","1","/")),e.login&&e.hash)return Ext.getBody().mask("Загрузка ..."),void $o.authorize({login:e.login,password:e.hash,success:function(e){$o.init(Ext.apply(s,{success:function(){Ext.getBody().unmask(!0),n.call(s.scope||this,s)}}))}});var r=function(){var e=Ext.getCmp("$o.app.login.field").getValue(),t=Ext.getCmp("$o.app.password.field").getValue();if(e&&t){a.getEl().mask("Загрузка");var n=$o.util.sha1(t);"password in cookie"==t&&(n=$o.util.getCookie("password"),t=$o.util.getCookie("passwordPlain")),$o.authorize({login:e,password:n,passwordPlain:t,success:function(r){Ext.getCmp("$o.app.remember").getValue()?($zu.setCookie("login",e),$zu.setCookie("password",n),$zu.setCookie("passwordPlain",t)):($zu.removeCookie("login"),$zu.removeCookie("password"),$zu.removeCookie("passwordPlain"));var i=s.success;$o.init(Ext.apply(s,{success:function(){a.getEl().unmask(!0),a.close(),i.call(s.scope||this,s)}}))},failure:function(e){a.getEl().unmask(!0),$o.app.message($o.locale.getString(e)||"Ошибка аутентификации",function(){Ext.getCmp("$o.app.password.field").setValue(""),Ext.getCmp("$o.app.login.field").focus()})}})}},i={xtype:"button",text:"Вход",iconCls:"gi_ok",width:100,style:{marginTop:10},handler:r};e.esia&&(i={border:!1,layout:"hbox",items:[{xtype:"button",text:"Войти через ЕСИА",iconCls:"gi_keys",width:150,style:{marginTop:10,marginRight:5},handler:function(){var t=window.location.protocol+"//"+window.location.hostname;window.location.port&&(t+=":"+window.location.port),t+="/projects/"+e.code+"/plugins/?fn=service.esia";var s=Ext.create("Ext.form.Panel",{standardSubmit:!0,url:e.esia});s.submit({params:{ReturnUrl:t}})}},i]});var a=Ext.create("Ext.Window",{title:t.name||"Авторизация",iconCls:"gi_keys",width:300,height:200,layout:"vbox",bodyPadding:5,closable:!1,monitorValid:!0,defaults:{listeners:{specialkey:function(e,t){t.getKey()==t.ENTER&&r()}}},items:[{xtype:"textfield",emptyText:"Логин",id:"$o.app.login.field",allowBlank:!1,msgTarget:"side",width:270,style:{marginTop:10}},{xtype:"textfield",emptyText:"Пароль",id:"$o.app.password.field",inputType:"password",allowBlank:!1,msgTarget:"side",width:270,style:{marginTop:10}},{xtype:"checkbox",boxLabel:"Запомнить",id:"$o.app.remember",width:270,style:{marginTop:10}},i]});a.show(null,function(){Ext.getCmp("$o.app.login.field").focus(),$o.util.getCookie("login")&&(Ext.getCmp("$o.app.remember").setValue(1),Ext.getCmp("$o.app.login.field").setValue($o.util.getCookie("login")),Ext.getCmp("$o.app.password.field").setValue("password in cookie"))})},initTreeStore:function(e){for(var t=Ext.ModelManager.getModel(e.model),s=t.getFields(),n=e.map,r=function(e){for(var t=0;t<s.length;t++){var i=s[t];e.r[i.name]=e.c.get(i.name)}if(e.c.childs.length){e.r.children=[];for(var t=0;t<e.c.childs.length;t++){var a={};r({c:n[e.c.childs[t]],r:a}),e.r.children.push(a)}}else e.r.leaf=!0},i=[],a=0;a<$o.store[e.data].getCount();a++){var o=$o.store[e.data].getAt(a);if(!o.get("parent")){var l={};r({c:o,r:l}),i.push(l)}}this.treeStore[e.data]=Ext.create("Ext.data.TreeStore",{model:e.model,autoLoad:!0,root:{text:".",children:i},proxy:{type:"memory",reader:{type:"json"}}})},tabChangeListener:function(e){var t=e.getActiveTab();if(t){t.id&&(document.location.href="#"+t.id);var s=t.title;if(t.id)if("o"==t.id[0]){var n=$zs.getObject(t.id.substr(1));s=n.get("name")}else if("v"==t.id[0]){var r=$zs.viewsMap[t.id.substr(1)];try{s=r.stub.get("name")}catch(e){s=r.get("name")}}document.title=s+" - "+$ptitle}},createDesktop:function(e){var t=this,s=e.cleanViewport;$o.app.tp=Ext.create("Ext.tab.Panel",{region:"center",layout:"fit",listeners:{tabchange:{fn:t.tabChangeListener,scope:t}}}),$o.app.lb=Ext.create("Ext.Toolbar",{region:"west",dock:"left",autoScroll:!0,items:[]}),$o.app.rb=Ext.create("Ext.Toolbar",{region:"east",dock:"right",items:[]}),$o.app.tb=Ext.create("Ext.Toolbar",{region:"north",items:[]}),$o.app.bb=Ext.create("Ext.Toolbar",{region:"south",items:[]});var n=[];if("admin"==$o.currentUser){var r=[{xtype:"label",text:"Visual Objectum",style:"font-weight: bold; color: #073255; margin-left: 5px; margin-right: 15px; text-shadow: -1px -1px 1px white, 1px -1px 1px white, -1px 1px 1px white, 1px 1px 1px white;"},{text:"Классы",iconCls:"gi_cogwheels",handler:function(){$o.app.show({items:{id:"conf_classes",xtype:"$o.classes",title:"Классы",iconCls:"gi_cogwheels",name:"classes"}})}},{text:"Представления",iconCls:"gi_eye_open",handler:function(){$o.app.show({items:{id:"conf_views",xtype:"$o.views",title:"Представления",iconCls:"gi_eye_open",name:"views"}})}}];$o.visualObjectum&&$o.visualObjectum.menuConstructor&&r.push({text:"Меню",iconCls:"gi_list",handler:function(){$o.app.show.call($o.app,{record:$o.getView("system.vo.menu")})}}),$o.visualObjectum&&$o.visualObjectum.accessConstructor&&r.push({text:"Доступ",iconCls:"gi_keys",handler:function(){$o.app.show.call($o.app,{record:$o.getView("system.vo.access")})}}),$o.visualObjectum&&$o.visualObjectum.projectConstructor&&r.push({text:"Проект",iconCls:"gi_briefcase",name:"project",handler:function(){$o.app.show({items:{id:"conf_project",xtype:"$projectdesigner",title:"Проект",name:"project",iconCls:"gi_briefcase"}})}}),r.push("->"),r.push({text:"Выход",iconCls:"gi_exit",handler:function(){$o.logout({success:function(){location.reload()}})}}),$o.app.cb=Ext.create("Ext.Toolbar",{region:"north",border:!1,style:"background-color: #b8d7f1; padding: 5px; margin-bottom: 3px;",items:r}),n.push($o.app.cb)}if($o.visualObjectum&&$o.visualObjectum.menuConstructor)if($o.visualObjectum.logo.left&&$o.visualObjectum.logo.height){var i=window,a=document,o=a.documentElement,l=a.getElementsByTagName("body")[0],c=i.innerWidth||o.clientWidth||l.clientWidth;i.innerHeight||o.clientHeight||l.clientHeight;n=[new Ext.Panel({region:"north",border:!1,width:c,height:$o.visualObjectum.logo.height,xtype:"panel",bodyStyle:"background-color: #ffffff; padding: 0px !important; border-bottom: 1px solid #428bca !important;",html:"<div style='width: 100%; height: "+$o.visualObjectum.logo.height+";'><img src='"+$o.visualObjectum.logo.left+"'>"+($o.visualObjectum.logo.right?"<img src='"+$o.visualObjectum.logo.right+"' align=right>":"")+"</div>"})].concat(n)}else n.push(Ext.create("Ext.Toolbar",{region:"north",border:!1,style:"background-color: #fff; padding: 5px; margin-bottom: 3px;",items:[{xtype:"label",text:$ptitle,style:"font-weight: bold; font-size: 15pt; font-style: italic; color: #b8d7f1; margin-left: 5px; margin-right: 15px; text-shadow: -1px -1px 1px #073255, 1px -1px 1px #073255, -1px 1px 1px #073255, 1px 1px 1px #073255;"}]}));n=n.concat($o.app.lb,$o.app.rb,$o.app.tb,$o.app.bb),s?($o.app.tb.hide(),$o.app.lb.hide(),$o.app.rb.hide()):n.push($o.app.tp),$o.app.vp&&$o.app.vp.destroy(),$o.app.vp=Ext.create("Ext.container.Viewport",{layout:"border",border:!1,defaults:{border:!1},items:n})},show:function(e){var t,s=this,n=e.items,r=e.record,i=e.readOnly;if(r){var a=Ext.getClassName(r);if("$o.View.Model"==a){if(!r.get("query")&&!r.get("layout"))return;t="v"+r.get("id"),r.get("layout")&&(n={xtype:"$o.layout",record:r,$layout:i?common.makeReadOnlyLayout(r.get("layout")):r.get("layout")}),!r.get("layout")&&r.get("query")&&(n={xtype:"$o.layout",$layout:{olap:{id:"olap",view:r.getFullCode()}}})}}else n.closable=!0,t=n.id;if(n){var o=$o.app.vp.down("*[region='center']");if("Ext.tab.Panel"==Ext.getClassName(o)){var l=s.tp.down("#"+t);l||(r?l=s.tp.add({id:t,title:r.get("name"),iconCls:r.get("iconCls"),closable:!0,layout:"fit",border:!1,isTab:1,items:n}):(n.isTab=1,l=s.tp.add(n))),s.tp.doLayout(),s.tp.setActiveTab(t)}else $o.app.vp.remove(o),n.region="center",$o.app.vp.add(n)}},beforerequest:function(conn,options,eOpts){var me=this,url=options.url,olapRequest=function(){var start=options.params.page>1?(options.params.page-1)*options.params.limit:0,limit=options.params.limit,tokens=url.substr(12,url.length-12).split("&"),id=tokens[0].split("=")[1],cmpId=tokens[1].split("=")[1];options.url="?sessionId="+$sessionId,options.method="POST";var order=null;if(options.params.sort){var sort=eval("("+options.params.sort+")");order=[sort[0].property,sort[0].direction]}var filter=[],grid=Ext.getCmp(cmpId);if(grid){var gridFilter=grid.getFilter();gridFilter&&gridFilter.length&&(filter=[gridFilter])}else grid={};if(options.params.filter)for(var fs=eval("("+options.params.filter+")"),va=$o.viewsMap[id].attrs,i=0;i<fs.length;i++){var f=fs[i],dataType;if(dataType=va[f.field].get("classAttr")?$o.classAttrsMap[va[f.field].get("classAttr")].getDataType():"number","string"==dataType){for(var has=0,j=1;j<filter.length;j++)if("like"==filter[j]&&filter[j-1]==f.field&&filter[j+1]==f.value+"%"){has=1;break}if(has)continue}if("bool"==dataType){f.value=f.value?1:0;for(var has=0,j=1;j<filter.length;j++)if("="==filter[j]&&filter[j-1]==f.field&&filter[j+1]==f.value){has=1;break}if(has)continue}if(filter.length&&filter.push("and"),"bool"==dataType)f.value?filter.push([f.field,"=",1]):filter.push([f.field,"=",0,"or",f.field,"is null"]);else if("date"==dataType&&"eq"==f.comparison){if(_.isArray(filter[0])){var n=filter[0].indexOf(f.field);n>-1&&(4==filter[0].length?filter.splice(0,2):0==n?filter[0].splice(0,4):filter[0].splice(n-1,4))}filter=filter.concat(f.field,">=",f.value+" 00:00:00","and",f.field,"<=",f.value+" 23:59:59")}else{if(filter.push(f.field),f.comparison)"lt"==f.comparison&&filter.push("<"),"gt"==f.comparison&&filter.push(">"),"eq"==f.comparison&&filter.push("="),"lte"==f.comparison&&filter.push("<="),"gte"==f.comparison&&filter.push(">="),"neq"==f.comparison&&filter.push("<>");else if("string"==dataType){var v=f.value;"object"==typeof v?v.value.indexOf(",")>-1?(v.notLike?filter.push("not in"):filter.push("in"),f.value=v.value.split(",").join(".,.").split(".")):(v.notLike?filter.push("not like"):filter.push("like"),f.value=v.value+"%"):(filter.push("like"),f.value=f.value+"%")}else filter.push("=");filter.push(f.value)}}filter&&1==filter.length&&(filter=filter[0]),options.params=$o.code+".View.getContent("+id+", 0,"+start+", 50, "+limit+', null, [!{"filter":'+JSON.stringify(filter)+',"order":'+JSON.stringify(order)+',"total":'+JSON.stringify(grid.total||null)+',"dateAttrs":'+JSON.stringify(grid.dateAttrs||null)+',"timeOffsetMin":'+(new Date).getTimezoneOffset()+"}!])",options.intercepted="getContent",options.viewId=id,options.cmpId=cmpId,options.start=start},treegridRequest=function(){var node="root"==options.params.node?null:options.params.node,tokens=url.substr(16,url.length-16).split("&"),id=tokens[0].split("=")[1],view=$o.viewsMap[id],cmpId=tokens[1].split("=")[1],treegrid=Ext.getCmp(cmpId),fieldParent=tokens[2].split("=")[1],fieldId=tokens[3].split("=")[1];options.url="?sessionId="+$sessionId,options.method="POST";var query=eval("("+view.get("query")+")"),alias,table;for(alias in query.from[0]){table=query.from[0][alias];break}for(var fieldParentPair={},attrParent,i=1;i<query.select.length;i+=2)if(query.select[i]==fieldParent){fieldParentPair=$o.util.clone(query.select[i-1]);for(var key in fieldParentPair)attrParent=fieldParentPair[key]}for(var fieldIdPair={},attrId,i=1;i<query.select.length;i+=2)if(query.select[i]==fieldId){fieldIdPair=$o.util.clone(query.select[i-1]);for(var key in fieldIdPair)attrId=fieldIdPair[key]}var filter=[fieldParentPair,"is null"];node&&(filter=[fieldParentPair,"=",node]);var where=query.where||[];where.length&&where.push("and"),where=where.concat(filter),query.select=query.select.concat([{___childs:attrId},"___childId",fieldParentPair,"___parentId"]);var field2={};if(field2[alias]=attrId,query.from=query.from.concat(["left-join",{___childs:table},"on",[{___childs:attrParent},"=",field2]]),treegrid.filter&&treegrid.filter.childsFn){var cf=treegrid.filter.childsFn();cf&&cf.length&&(query.from[query.from.length-1]=query.from[query.from.length-1].concat("and",cf))}var convertFilter=function(e,t){for(var s={},n=0;n<e.select.length;n+=2)s[e.select[n+1]]=e.select[n];for(var r=[],n=0;n<t.length;n++)Ext.isArray(t[n])?r.push(convertFilter(e,t[n])):s[t[n]]?r.push($o.util.clone(s[t[n]])):r.push(t[n]);return r};if(treegrid.filter&&(!node||node&&treegrid.filter.all)){var treeFilter=treegrid.getFilter(),filter=convertFilter(query,treeFilter);filter&&filter.length&&(where=where.concat("and",filter))}if(!node&&treegrid.$opened.length){var openedFilter=[fieldParentPair,"in",treegrid.$opened.join(".,.").split(".")];if(treegrid.filter&&treegrid.filter.all){var treeFilter=treegrid.getFilter(),filter=convertFilter(query,treeFilter);filter&&filter.length&&(openedFilter=openedFilter.concat("and",filter))}where.push("or"),where.push(openedFilter)}query.where=where,options.params=$o.code+".Storage.execute([!"+JSON.stringify(query)+"!])",options.intercepted="treegrid",options.viewId=id,options.query=query,options.fieldId=fieldId,options.node=node,options.cmpId=cmpId};"view?read=1"==url.substr(0,11)&&olapRequest(),"treegrid?read=1"==url.substr(0,15)&&treegridRequest()},requestcomplete:function(conn,response,options,eOpts){var r;try{r=eval("("+response.responseText+")")}catch(e){}if(r&&r.header&&r.header.error){var msg=r.header.error,win=Ext.create("Ext.window.Window",{title:$ptitle,resizable:!1,closable:!0,width:600,height:400,layout:"fit",modal:!0,items:[{xtype:"panel",border:!1,style:"padding: 5",html:"<font color=red>"+$o.locale.translate(msg)+"</font>"}],buttons:[{text:"Подробнее",iconCls:"gi_circle_question_mark",handler:function(){win.removeAll(),win.add({xtype:"panel",border:!1,style:"padding: 5",html:"<font color=red>"+$o.locale.translate(msg)+"</font><br>"+JSON.stringify(options)})}},{text:"Ok",name:"ok",iconCls:"gi_ok",handler:function(){win.close()}}]});throw win.show(null,function(){win.down("*[name='ok']").focus()}),r.header.error+" options: "+JSON.stringify(options)}var olapResponse=function(){var model=Ext.ModelManager.getModel("$o.View."+options.viewId+".Model"),mFields=model.getFields(),rt=eval("("+response.responseText+")"),vFields=[],fieldsMap={},grid=Ext.getCmp(options.cmpId);for(var i in rt.data.column){var attr=rt.data.column[i][0].attr;vFields.push(attr);for(var j=0;j<mFields.length;j++)if(mFields[j].name==attr){fieldsMap[i]=mFields[j].name;break}delete grid.totalValues[attr],rt.data.column[i][0].total&&(grid.totalValues[attr]=rt.data.column[i][0].total)}for(var data=[],i=0;i<rt.data.tree.currentLength;i++){for(var row=rt.data.tree[options.start+i].data,rec={},j=0;j<vFields.length;j++)rec[fieldsMap[j]]=row[j].text;data.push(rec)}grid.countOverflow=rt.data.tree.overflow;var r={success:!0,total:rt.data.tree.length,data:data};response.responseText=JSON.stringify(r)},treegridResponse=function(){for(var node=options.node||null,model=Ext.ModelManager.getModel("$o.View."+options.viewId+".Model"),view=$o.viewsMap[options.viewId],treegrid=Ext.getCmp(options.cmpId),mFields=view.orderedFields,rt=eval("("+response.responseText+")"),fieldsMap={},query=options.query,i=0;i<query.select.length;i+=2){var attr;for(var alias in query.select[i]){attr=query.select[i+1];break}for(var j=0;j<mFields.length;j++)if(mFields[j].name==attr){fieldsMap[i/2]=mFields[j].name;break}}for(var levels={},hasId=[],i=0;i<rt.data.length;i++){var row=rt.data[i],rec={},j;for(j=0;j<mFields.length;j++)rec[fieldsMap[j]]=row[j];var childId=row[j],parentId=row[j+1];hasId.indexOf(rec[options.fieldId])==-1&&(childId||(rec.leaf=!0),treegrid&&treegrid.showChecks&&(rec.checked=!1),levels[parentId]=levels[parentId]||[],levels[parentId].push(rec),hasId.push(rec[options.fieldId]))}if(!node&&levels[null]&&levels[null].length)for(var addChildren=function(e){var t=levels[e[options.fieldId]];if(t){for(var s=[],n=0;n<t.length;n++)s.push(t[n]),addChildren(t[n]);e.children=s,e.expanded=!0}},i=0;i<levels[null].length;i++)addChildren(levels[null][i]);var data=levels[node],r={text:".",children:data};response.responseText=JSON.stringify(r)};"getContent"==options.intercepted&&olapResponse(),"treegrid"==options.intercepted&&treegridResponse()},requestexception:function(e,t,s,n){if(!($o.idleTimer>$o.maxIdleSec)){var r="<html><head><title>Unauthenticated</title></head><body><h1>401 Unauthenticated</h1></body></html>"==t.responseText?"Сессия не авторизована. Пожалуйста, перезагрузите страницу браузера.":t.responseText;r||(r="Не удалось соединиться с сервером.<br>status: "+t.status+" "+t.statusText),common.message("<font color=red>"+r+"</font><br>url: "+s.url+"<br>params: "+s.params)}},start:function(options){var me=this,meOptions=options;me.code=options.code,me.name=options.name,me.version=options.version,me.locale=options.locale;var success=options.success,scope=options.scope;$ptitle=options.name,$pversion=options.version;var useHash=options.useHash,go=function(){$o.locale.load("/client/extjs4/locale/"+meOptions.locale+".xml"),Ext.Ajax.on("beforerequest",$o.app.beforerequest,$o.app),Ext.Ajax.on("requestcomplete",$o.app.requestcomplete,$o.app),Ext.Ajax.on("requestexception",$o.app.requestexception,$o.app),me.login(Ext.apply(meOptions,{scope:me,success:function(options){if(me.treeStore={},me.initTreeStore({model:"$o.Class.Model",data:"classes",map:$o.classesMap}),me.initTreeStore({model:"$o.View.Model",data:"views",map:$o.viewsMap}),me.createDesktop(options),$o.initAdapter(),$o.visualObjectum){if("admin"==$o.currentUser){var projectNeedBuild=common.getConf("projectNeedBuild");projectNeedBuild.used&&$o.app.vp.down("*[name=project]")&&(me.projectNeedBuildTooltip=Ext.create("Ext.tip.ToolTip",{title:"Необходима сборка",target:$o.app.vp.down("*[name=project]").id,anchor:"top",html:"Для актуализации действий",width:200,autoHide:!0,autoShow:!0,closable:!0}))}var href=document.location.href;if(href.indexOf("#")>-1&&!useHash){var tokens=href.split("#");document.location.href=tokens[0]+"#"}if($o.visualObjectum.menuConstructor&&(system.init(),system.vo.buildMenu(),$o.visualObjectum.initAction)){var fn_=eval("("+$o.visualObjectum.initAction+")");fn_()}}$o.app.fireEvent("ready"),success&&success.call(scope||me,options)}}))};$o.app.extReady?go.call(me):$o.app.on("extReady",go,me)},loginDialog:function(e){$o.app.vp.destroy();for(var t in $o.viewsMap){var s=Ext.getCmp("v"+t);s&&s.destroy()}var n=this;e=e||{},$o.app.start({code:n.code||e.code,name:n.name||e.name,version:n.version||e.version,locale:n.locale||e.locale,success:e.success})},sendMail:function(e){e=e||{},e.to&&e.subject&&e.message&&Ext.Ajax.request({url:"sendmail?sessionId="+$sessionId,method:"post",params:{to:e.to,from:e.from,subject:e.subject,message:e.message,attachments:JSON.stringify(e.attachments)}})},loadScript:function(e,t){var s=document.createElement("script"),n=document.getElementsByTagName("head")[0];s.readyState&&!s.onload?s.onreadystatechange=function(){"loaded"!=s.readyState&&"complete"!=s.readyState||(s.onreadystatechange=null,t())}:s.onload=t,s.src=e,n.appendChild(s)}}),Ext.onReady(function(){Ext.QuickTips.init(),$o.app.extReady=!0,Ext.Ajax.disableCaching=!1,Ext.Ajax.timeout=12e4,$o.app.fireEvent("extReady")}),Ext.define("$o.app.view",{singleton:!0,getItems:function(e){var t=this,s={id:"e"+e.get("id"),xtype:"tabpanel",title:e.get("name")||e.get("code"),iconCls:"gi_eye_open",layout:"fit",defaults:{bodyPadding:5},items:[{title:"Общие",layout:"form",tbar:[{text:"Сохранить",iconCls:"gi_floppy_save",handler:t.saveCommon}],items:[{xtype:"textfield",fieldLabel:"ID",value:e.get("id"),readOnly:!0},{xtype:"textfield",fieldLabel:"Наименование",value:e.get("name")},{xtype:"textfield",fieldLabel:"Код",value:e.get("code")},{xtype:"textfield",fieldLabel:"Родитель",value:e.get("parent")?$o.getView(e.get("parent")).toString():""},{xtype:"textfield",fieldLabel:"Иконка",value:e.get("iconCls")},{xtype:"textarea",fieldLabel:"Описание",value:e.get("description")}]}]};return s},saveCommon:function(){var e=this;console.log(e)}}),$zs=$o,$s=$o,$zp={application:$o.app},Ext.Component.AUTO_ID=1e6,objectum={ui:{}},$o.initAdapter=function(){$zp.application.toolbar=$o.app.tb,$zp.application.mainPanel=$o.app.tp,$zs.views=$o.viewsTree,$zs.views.get=function(e){var t=$o.getView({code:e});return t},objectum.ui.layout={},objectum.ui.layout.ViewLayout=$o.Layout.Widget,$zs.classes=$o.classesTree,$zs.viewAttrs=$o.viewAttrsMap,$zp.currentUser=$o.currentUser,$zp.application.onClickMenuItem=function(e){var t=$o.viewsMap[e.record.stub.get("id")];$o.app.show({record:t})},$VERSION_MAJOR=$o.serverVersion,$o.app.on("ready",function(){$zp.onLogin&&$zp.onLogin()}),$zs.id=$o.code,objectum.ui.ObjectField=$o.ObjectField.Widget,$zr=$o.locale},Ext.override(Ext.Component,{initComponent:function(){var me=this;if(me.code&&(me.iconCls=me.iconCls?me.iconCls:me.code,me.text=me.text?$o.locale.getString(me.text):$o.locale.getString(me.code)),"string"==typeof me.handler&&(me.handler=eval(me.handler)),me.listeners)for(var event in me.listeners){var ef=me.listeners[event];if("string"==typeof ef)try{me.listeners[event]=eval(ef)}catch(e){me.listeners[event]=function(){console.log("unknown function: "+ef)}}else if(ef&&ef.fn&&"string"==typeof ef.fn)try{me.listeners[event].fn=eval(ef.fn)}catch(e){me.listeners[event].fn=function(){console.log("unknown function: "+ef.fn)}}}me.callOverridden()}}),Ext.override(Ext.Panel,{initComponent:function(){this.code&&(this.iconCls=this.iconCls?this.iconCls:this.code,this.title=this.title?$o.locale.getString(this.title):$o.locale.getString(this.code)),this.callOverridden()}}),Ext.override(Ext.form.field.Date,{initComponent:function(){this.format="d.m.Y",this.callOverridden()}}),Ext.override(Ext.form.field.Time,{initComponent:function(){this.format="H:i:s",this.callOverridden()}}),Ext.override(Ext.form.field.Checkbox,{initComponent:function(){this.addEvents("check"),this.on("change",function(e,t,s){this.fireEvent("check",e,t,s)},this),this.callOverridden()}}),Ext.override(Ext.toolbar.Toolbar,{initComponent:function(){this.hasOwnProperty("border")||(this.border=!1),this.callOverridden()}}),Ext.override(Ext.form.field.Base,{initComponent:function(){this.readOnly&&!this.objectField&&"Ext.form.field.File"!=Ext.getClassName(this)&&"displayfield"!=this.xtype&&this.addCls("readonly-field"),this.hasOwnProperty("allowBlank")&&!this.allowBlank&&this.fieldLabel&&(this.fieldLabel=this.fieldLabel+"<span style='color: red !important'>*</span>"),this.callOverridden()},setReadOnly:function(e){this.objectField||"Ext.form.field.File"==Ext.getClassName(this)||"displayfield"==this.xtype||(this.readOnly?this.addCls("readonly-field"):this.removeCls("readonly-field")),this.callOverridden()}}),Ext.define("Ext.fix.util.AbstractMixedCollection",{override:"Ext.util.AbstractMixedCollection",itemAt:function(e){return this.getAt(e)}}),Date.prototype.toStringOriginal=Date.prototype.toString,Date.prototype.toString=function(e){var t=this.getDate(),s=this.getMonth()+1,n=this.getFullYear(),r=this.getHours(),i=this.getMinutes(),a=this.getSeconds();t<10&&(t="0"+t),s<10&&(s="0"+s);var o=t+"."+s+"."+n;return(r||i||a)&&(r<10&&(r="0"+r),i<10&&(i="0"+i),a<10&&(a="0"+a),o+=" "+r+":"+i+":"+a),o},Date.prototype.toUTCString=function(){var e=this,t=function(e){return e<10?"0"+e:e};return 0==e.getHours()&&0==e.getMinutes()&&0==e.getSeconds()?'"'+t(e.getDate())+"."+t(e.getMonth()+1)+"."+t(e.getFullYear())+'"':'"'+t(e.getUTCDate())+"."+t(e.getUTCMonth()+1)+"."+t(e.getUTCFullYear())+" "+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+'"'},$zu.getThemeBGColor=function(){return window.$themeBGColor||"#ffffff"},Ext.define("$o.locale",{singleton:!0,strings:{},load:function(e){for(var t=Ext.Ajax.request({url:e,async:!1}).responseXML,s=Ext.DomQuery.select("string",t.documentElement),n=0;n<s.length;n++){var r=s[n].attributes[0].value,i=s[n].textContent||s[n].text;$o.locale.strings[r]=i}},getString:function(e){return e?$o.locale.strings[e]||e:""},translate:function(e){if(e.indexOf("connection limit exceeded")>-1&&(e="Извините. Сервер в данный момент перегружен. Пожалуйста, повторите запрос позднее."),e.indexOf("value exists")>-1){var t=e.split(":");e="Значение '"+t[1].trim()+"' используется. Пожалуйста введите другое."}return e}}),$zu.dialog={},$zu.dialog.getNameAndCode=function(e){var t=e.title,s=e.success,n=e.scope||this,r=new Ext.Button({code:"Ok",formBind:!0,scope:this,handler:function(){s.call(n,a.getValue(),o.getValue()),c.close()}}),i=new Ext.Button({code:"Cancel",scope:this,handler:function(){c.close()}}),a=new Ext.form.TextField({selectOnFocus:!0,fieldLabel:$zr.getString("Name"),allowBlank:!1,msgTarget:"side",anchor:"95%",listeners:{render:function(){a.focus(!1,200)},specialkey:function(e,t){t.getKey()!=t.ENTER||r.disabled||(s.call(n,a.getValue(),o.getValue()),c.close())},scope:this}}),o=new Ext.form.TextField({selectOnFocus:!0,fieldLabel:$zr.getString("Code"),allowBlank:!1,msgTarget:"side",anchor:"95%",maskRe:/[A-Za-z0-9\_]/,listeners:{specialkey:function(e,t){t.getKey()!=t.ENTER||r.disabled||(s.call(n,a.getValue(),o.getValue()),c.close())},scope:this}}),l=new Ext.FormPanel({frame:!1,border:!1,defaultType:"textfield",monitorValid:!0,buttonAlign:"right",autoScroll:!0,bodyPadding:5,layout:"form",items:[a,o],buttons:[r,i]}),c=new Ext.Window({width:400,height:150,layout:"fit",modal:!0,title:t,items:[l]});c.show(null,function(){a.focus(!1,200)})},$zu.dialog.getNameAndCodeAndType=function(e){var t=e.title,s=e.success,n=e.scope||this,r=new Ext.Button({code:"Ok",formBind:!0,scope:this,handler:function(){s.call(n,a.getValue(),o.getValue(),l.getValue()),d.close()}}),i=new Ext.Button({code:"Cancel",scope:this,handler:function(){d.close()}}),a=new Ext.form.TextField({selectOnFocus:!0,fieldLabel:$zr.getString("Name"),allowBlank:!1,msgTarget:"side",anchor:"95%",listeners:{render:function(){a.focus(!1,200)},specialkey:function(e,t){t.getKey()!=t.ENTER||r.disabled||(s.call(n,a.getValue(),o.getValue(),l.getValue()),d.close())},scope:this}}),o=new Ext.form.TextField({selectOnFocus:!0,fieldLabel:$zr.getString("Code"),allowBlank:!1,msgTarget:"side",anchor:"95%",maskRe:/[A-Za-z0-9\_]/,listeners:{specialkey:function(e,t){t.getKey()!=t.ENTER||r.disabled||(s.call(n,a.getValue(),o.getValue(),l.getValue()),d.close())},scope:this}}),l=new Ext.create("$o.ConfField.Widget",{conf:"classAttr",confRef:"class",choose:{type:"view",id:"system.classes",attr:"olap.id",width:500,height:400},fieldLabel:"Тип",value:1,allowBlank:!1,msgTarget:"side",anchor:"95%",listeners:{change:function(e){if(e>=1e3){var t=$o.getClass(e);a.setValue(t.get("name")),o.setValue(t.get("code"))}}}}),c=new Ext.FormPanel({frame:!1,border:!1,defaultType:"textfield",monitorValid:!0,buttonAlign:"right",autoScroll:!0,bodyPadding:5,layout:"form",items:[l,a,o],buttons:[r,i]}),d=new Ext.Window({width:400,height:200,layout:"fit",modal:!0,title:t,items:[c]});d.show(null,function(){a.focus(!1,200)})},Ext.namespace("common","common.chart","common.window","common.card","common.tpl","common.report","obj","dialog","$report","$dbf","$csv"),common.message=function(e,t){Ext.Msg.alert($ptitle,e,t)},common.confirm=function(e){var t=e.scope?e.scope:this;Ext.Msg.show({title:$ptitle,msg:e.message,buttons:Ext.Msg.YESNO,fn:e.fn,animEl:"elId",icon:Ext.MessageBox.QUESTION,scope:t})},common.recordSelected=function(e){e=e||{};var t,s=e.attr||"id";t=e.olap?this.relatives[e.olap]:this;var n,r=!1;return n=t.getSelectionModel?t.getSelectionModel().hasSelection():t.getCurrentValue(s),n&&(r=!0),r},obj.create=function(e){var t=$zs.createObject(e.classCode);t.commit();var s=t.getId();if(e.attrs){for(var n in e.attrs)e.attrs.hasOwnProperty(n)&&t.set(n,e.attrs[n]);t.commit()}return e.refresh&&this.refresh({callback:function(e,t,n){n&&this.selectRow({filter:["&id","=",s]})},scope:this}),s},obj.remove=function(e){if(null==e.id)return common.message($zr.getString("object must be selected")),!1;var t=!1,s=$zs.getObject(e.id);if(s){if(e.objects){for(var n=e.objects,r=0;r<n.length;r++)if(n[r].classCode)for(var i=common.execSQL({select:[{a:"id"},"id"],from:[{a:n[r].classCode}],where:[{a:n[r].attr},"=",e.id]}),a=0;a<i.length;a++){var o=$zs.getObject(i.get(a,"id"));o&&(o.remove(),o.commit())}else if(s.get(n[r])){var o=$zs.getObject(s.get(n[r]));o&&(o.remove(),o.commit())}}else if(!e.force){e.object=s;var l=obj.getDependentObjects(e);if(l.length){for(var i='<table id="objDetails" style="font-family:Tahoma !important; font-size:8pt !important;"><tr><td><b>Тип</b></td><td style="padding-left: 5px;"><b>Наименование</b></td></tr>',c=0,r=0;r<l.length;r++){var s=$zs.getObject(l[r]);if(s){c++;var d;try{d=s.get("name")||"id: "+s.get("id")}catch(e){d="id: "+s.get("id")}var u=$zs.classesMap[s.get("classId")].stub.get("name");if("section_"==u.substr(0,8)){if(u="Данные",d="",s.get("subject")){var n=$zs.getObject(s.get("subject"));d+=n.get("name")}if(s.get("repDate")){d&&(d+=", ");var n=$zs.getObject(s.get("repDate"));d+=n.get("name")}}i+="<tr><td>"+u+"</td>",i+='<td style="padding-left: 5px;">'+d+"</td></tr>"}}if(i+="</table>",c)return common.message("Количество зависимых объектов: "+l.length+" (id: "+JSON.stringify(l)+')<br><a href="#" id="detailsLink">Подробности</a>'),Ext.get("detailsLink").on("click",function(){var e=window.open("","window1","width=600, height=400, resizable=yes, scrollbars=yes, status=yes, top=10, left=10");e.document.open(),e.document.write(i)},this),
!1}}s=$zs.getObject(e.id),s.remove(),s.commit(),t=!0,e.refresh&&(this.getSelectionModel().deselectAll(),this.refresh())}return t},obj.getValue=function(e,t){var s=null;if(t&&"$"==t[0]){var n=t.split("."),r=n[0].substr(1,n[0].length-1);e[r]&&(e=$o.getObject(e[r]),n.splice(0,1),t=n.join("."))}if(e)for(var n=t.split("."),i=0;i<n.length;i++){if("$date"==n[i])return s?s.toString("d.m.Y"):s;if(i){if(!s)break;e=$o.getObject(s)}if(!e)break;s=e.get?e.get(n[i]):e[n[i]]}return s},common.getValue=obj.getValue,common.currentDate=function(){var e=new Date,t=e.getDate(),s=e.getMonth()+1,n=e.getFullYear(),r="";return t<10&&(r+="0"),r+=String(t)+".",s<10&&(r+="0"),r+=String(s)+".",r+=String(n)},common.getDate=function(e){if(!e)return"";var t=e.getDate(),s=e.getMonth()+1,n=e.getFullYear(),r="";return t<10&&(r+="0"),r+=String(t)+".",s<10&&(r+="0"),r+=String(s)+".",r+=String(n)},common.getDateFromDDMMYYYY=function(e){var t=null;return e&&10==e.length&&"."==e[2]&&"."==e[5]&&(t=new Date(e.substr(6,4),e.substr(3,2)-1,e.substr(0,2))),t},common.currentTime=function(){var e=new Date,t=e.getHours(),s=e.getMinutes(),n=e.getSeconds(),r="";return t<10&&(r+="0"),r+=String(t)+":",s<10&&(r+="0"),r+=String(s)+":",n<10&&(r+="0"),r+=String(n)},common.currentTimestamp=function(){return common.currentDate()+" "+common.currentTime()},common.getDate=function(e){if(!e)return"";var t=e.getDate(),s=e.getMonth()+1,n=e.getFullYear(),r="";return t<10&&(r+="0"),r+=String(t)+".",s<10&&(r+="0"),r+=String(s)+".",r+=String(n)},common.getDateISO=function(e){if(!e)return e;var t=e.getDate(),s=e.getMonth()+1,n=e.getFullYear(),r=String(n)+"-";return s<10&&(r+="0"),r+=String(s)+"-",t<10&&(r+="0"),r+=String(t)},common.getTime=function(e){var t=e.getHours(),s=e.getMinutes(),n=e.getSeconds(),r="";return t<10&&(r+="0"),r+=String(t)+":",s<10&&(r+="0"),r+=String(s)+":",n<10&&(r+="0"),r+=String(n)},common.getTimestamp=function(e){return common.getDate(e)+" "+common.getTime(e)},common.getUTCDate=function(e){var t=e.getUTCDate(),s=e.getUTCMonth()+1,n=e.getUTCFullYear(),r="";return t<10&&(r+="0"),r+=String(t)+".",s<10&&(r+="0"),r+=String(s)+".",r+=String(n)},common.getUTCTime=function(e){var t=e.getUTCHours(),s=e.getUTCMinutes(),n=e.getUTCSeconds(),r="";return t<10&&(r+="0"),r+=String(t)+":",s<10&&(r+="0"),r+=String(s)+":",n<10&&(r+="0"),r+=String(n)},common.getUTCTimestamp=function(e){return common.getUTCDate(e)+" "+common.getUTCTime(e)},common.getJulianDay=function(e){if(""==e)return 0;var t=e.getDate(),s=e.getMonth()+1,n=e.getFullYear();return jd=Math.floor(1461*(n+4800+(s-14)/12))/4+Math.floor(Math.floor(367*(s-2-12*((s-14)/12)))/12)-3*Math.floor(Math.floor(n+4900+(s-14)/12)/100)/4+t-32075,Math.floor(jd)},common.getDateByJulianDay=function(e){var t,s,n,r,i,a,o;return t=e+68569,s=Math.floor(4*t/146097),t=Math.floor(t-(146097*s+3)/4),n=Math.floor(4e3*(t+1)/1461001),t=t-Math.floor(1461*n/4)+31,r=Math.floor(80*t/2447),i=t-Math.floor(2447*r/80),t=Math.floor(r/11),a=r+2-12*t,o=100*(s-49)+n+t,new Date(o,a-1,i)},common.execSQL=function(e){var t,s;s=$zs?$zs.execute({query:e,async:!1}):zerp.Storage.STORAGES[0].execute("Storage.execute([!"+BiJson.serialize(e)+"!])");try{s.length}catch(e){s={},s.length=0}for(s.fields={},t=0;t<e.select.length/2;t++)s.fields[e.select[2*t+1]]=t,s.fields[t]=t;return s.get=function(e,t){var s=this.fields[t];if(null==s)throw"result.get: col unknown (row:"+e+",col:"+t+")";var n=this[e][s];return void 0==n&&(n=null),n},s},obj.getDependentObjects=function(e){for(var t=common.execSQL({select:[{a:"___fid"},"id"],from:[{a:"system.object"},"left-join",{b:"system.object_attr"},"on",[{a:"___fid"},"=",{b:"___fobject_id"}],"left-join",{c:"system.class_attr"},"on",[{b:"___fclass_attr_id"},"=",{c:"___fid"}]],where:[{a:"___fend_id"},"=",system.revision.maxRevision,"and",{b:"___fend_id"},"=",system.revision.maxRevision,"and",{c:"___fend_id"},"=",system.revision.maxRevision,"and",{c:"___ftype_id"},">=",1e3,"and",{b:"___fnumber"},"=",e.id]}),s=[],n=0;n<t.length;n++)s.indexOf(t.get(n,"id"))==-1&&s.push(t.get(n,"id"));return s},common.window.list=[],common.window.titleMaxLength=12,common.window.cardFn=null,common.window.callCardFn=function(e){return common.window.cardFn(e)},common.window.options=null,common.card=function(){return{}},common.window.onViewLayout=function(e){var t=e.record,s=e.layout;if($zs.views.ser.card.stub.get("id")==t.stub.get("id")&&common.window.options){var n=common.window.options.cardFn,r=n(common.window.options);Ext.apply(s,r),common.window.options=null}},common.window.show=function(e){e=e||{};var t=e.id;e.olap&&e.attr&&(t=this.relatives[e.olap].getCurrentValue(e.attr)),e.id=t;var s,n="Window-"+ ++Ext.Component.AUTO_ID,r=$zs.views.ser.card;if(4==common.extMajorVersion()?s=Ext.create("$o.Layout.Widget",{record:r,$layout:e.cardFn(e)}):(r.stub.set("layout","common.card ()"),common.window.options=e,s=new objectum.ui.layout.ViewLayout(Ext.apply({border:!1,record:r,bodyStyle:"background-color: "+$zu.getThemeBGColor()+";"},e.viewOptions))),s.on("destroy",function(){var s=common.window.list.indexOf(this);if(s>-1&&common.window.list.splice(s,1),e.refreshOlap)try{e.refreshOlap.refresh({callback:function(s,n,r){r&&e.refreshOlap.selectRow({filter:["&id","=",t]})}})}catch(e){}},this),e.refresh&&(e.refreshOlap=this.relatives[e.olap]),e.asWindow){e.width=e.width||800,e.height=e.height||600,e.listeners&&!e.listeners.scope&&(e.listeners.scope=this);var i=new Ext.Window({id:n,title:e.title,resizable:!0,closable:!0,maximizable:e.maximizable,maximized:e.maximized,modal:e.modal,width:e.width,height:e.height,iconCls:e.iconCls,bodyPadding:2,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",layout:"fit",stateful:!1,items:[s],listeners:e.listeners});s.win=i,i.on("show",function(){var e=i.getPosition();e[1]<0&&i.setPosition(e[0],0)},this),i.show(),common.window.list.push(i)}else{var a="o"+t,o=$zp.application,l=function(){if(e.listeners&&e.listeners.close){var t=e.listeners.close.scope||e.listeners.scope||this,s=e.listeners.close.fn||e.listeners.close;s.call(t)}};$o.app.tp.down("#"+a)||($o.app.tp.add({id:a,xtype:"panel",layout:"fit",node:1,iconCls:e.iconCls,tooltip:e.title,title:e.title.length>common.window.titleMaxLength?e.title.substr(0,common.window.titleMaxLength)+"...":e.title,closable:!0,bodyStyle:"background-color: "+$zu.getThemeBGColor()+";",items:[s],close:function(){o.mainPanel.remove(o.openPages[a]),l()},listeners:{destroy:function(){l()},scope:this}}),$o.app.tp.doLayout()),$o.app.tp.setActiveTab(a),document.location.href="#"+a}$zp.application.fireEvent("showPage",{record:r,showOptions:e})},common.window.closeAll=function(){for(var e=0;e<common.window.list.length;e++)common.window.list[e].close()},common.data={},common.getId=function(e){if(null==common.data[e.classCode]){common.data[e.classCode]={};for(var t=common.execSQL({select:[{a:"id"},"id",{a:"code"},"code"],from:[{a:e.classCode}]}),s=0;s<t.length;s++)common.data[e.classCode][t.get(s,"code")]=t.get(s,"id")}var n=common.data[e.classCode][e.code];if(null==n)throw{name:"common.getId exception",message:"classCode:"+e.classCode+", code:"+e.code+" not exist"};return n},common.sprLayout=function(e){var t={split:{orientation:"vertical",width:250,pages:[{olap:{id:e.olapId,view:e.viewCode,actions:[{id:e.classCode+".create",caption:"create",icon:"new",group:!0},{id:e.classCode+".remove",active:{fn:common.recordSelected,arguments:{olap:"olap",attr:"id"}},caption:"delete",icon:"delete"}]}},{card:{id:e.cardId,fields:[{id:"olap",attr:"id.npp"},{id:"olap",attr:"id.name"},{id:"olap",attr:"id.code"},{id:"olap",attr:"id.used"},{id:"olap",attr:"id.description"}]}}]}};return t},common.chart.show=function(e){var t=new Ext.data.JsonStore({fields:e.fields,data:e.data}),s=e.width||800,n=e.height||600,r=new Ext.Window({title:e.title,resizable:!0,closable:!0,maximizable:!0,width:s,height:n,layout:"fit",items:[{xtype:e.xtype,store:t,xField:e.xField,xAxis:new Ext.chart.CategoryAxis({title:e.xAxisTitle}),yAxis:new Ext.chart.NumericAxis({title:e.yAxisTitle,majorUnit:e.majorUnit}),series:e.yFields,extraStyle:{legend:{display:"right"}}}]});r.show()},Ext.apply(Ext.form.VTypes,{daterange:function(e,t){var s=t.parseDate(e);if(!s)return!1;if(t.startDateField){var n=Ext.getCmp(t.startDateField);n.maxValue&&s.getTime()==n.maxValue.getTime()||(n.setMaxValue(s),n.validate())}else if(t.endDateField){var r=Ext.getCmp(t.endDateField);r.minValue&&s.getTime()==r.minValue.getTime()||(r.setMinValue(s),r.validate())}return!0}}),dialog.getPeriod=function(e){var t=new Ext.FormPanel({labelWidth:75,frame:!0,style:"background-color: #fff",bodyStyle:"background-color: #fff",bodyPadding:5,width:300,defaults:{width:225},defaultType:"datefield",items:[{fieldLabel:$zr.getString("From"),allowBlank:!1,msgTarget:"side",value:common.currentDate(),format:"d.m.Y",name:"startdt",id:"startdt",vtype:"daterange",endDateField:"enddt"},{fieldLabel:$zr.getString("To"),allowBlank:!1,msgTarget:"side",value:common.currentDate(),format:"d.m.Y",name:"enddt",id:"enddt",vtype:"daterange",startDateField:"startdt"}]}),s=e.scope||this,n=new Ext.Window({title:e.title,resizable:!0,closable:!0,maximizable:!1,modal:!0,width:300,height:150,layout:"fit",items:[t],buttons:[{code:"ok",formBind:!0,handler:function(){var r=t.items.items[0].getValue(),i=t.items.items[1].getValue();n.close(),e.success.call(s,{startDate:r,dateStart:r,endDate:i,dateEnd:i})}},{code:"cancel",formBind:!1,handler:function(){n.close()}}]});n.show()},dialog.getObject=function(e){var t=e.width||600,s=e.height||400;e.title||(e.title=$zr.getString("object.choosing"));var n,r=e.scope||this;if(e.view)n=new objectum.ui.layout.ViewLayout({xtype:"zviewlayout",border:!1,record:$zs.views.get(e.view,{async:!1}),bodyStyle:"background-color: "+$zu.getThemeBGColor()+";"});else{var i=$zs.views.get("ser.card",{async:!1});i.stub.set("layout","string"==typeof e.layout?e.layout:JSON.stringify(e.layout)),n=new objectum.ui.layout.ViewLayout({xtype:"zviewlayout",border:!1,record:i,bodyStyle:"background-color: "+$zu.getThemeBGColor()+";"})}var a=function(){var t,s=e.attr||"id";s=s.split("."),t=1==s.length?n.relatives.olap.getCurrentValues(s[0]):n.relatives[s[0]].getCurrentValues(s[1]);var i=t[0];o.close(),e.success.call(r,{value:i,values:t})},o=new Ext.Window({title:e.title,resizable:!0,closable:!0,height:s,width:t,layout:"fit",modal:!0,tbar:[{code:"choose",handler:a,scope:r},{code:"cancel",handler:function(){o.close()}}],items:[n]});o.show()},dialog.selectObject=function(e){var t=e.success,s=e.scope,n={olap:{id:"olap",view:e.view,listeners:{dblclick:function(){a()}}}},r=$zs.views.get("ser.card",{async:!1});r.stub.set("layout",JSON.stringify(n));var i=new objectum.ui.layout.ViewLayout({xtype:"zviewlayout",border:!1,record:r,bodyStyle:"background-color: "+$zu.getThemeBGColor()+";"}),a=function(){var e=i.relatives.olap.getCurrentValue("id");c.close(),t.call(s||this,{value:e})},o=new Ext.Button({code:"choose",disabled:!0,handler:a,scope:this}),l=new Ext.Button({code:"cancel",handler:function(){c.close()}});i.on("load",function(){var e=i.relatives.olap;if(e){var t=function(){e.getCurrentValue("id")?o.setDisabled(!1):o.setDisabled(!0)};e.selModel.on("selectionchange",t,this)}},this);var c=new Ext.Window({code:"Выберите объект",resizable:!0,closable:!0,width:e.width||600,height:e.height||400,layout:"fit",modal:!0,tbar:new Ext.Toolbar({items:[o,l]}),items:[i]});c.show()},dialog.getDate=function(e){var t=new Ext.FormPanel({labelWidth:75,bodyStyle:"background-color: "+$zu.getThemeBGColor()+"; padding: 5px 5px 0;",width:300,border:!1,defaults:{width:225},defaultType:"datefield",items:[{fieldLabel:$zr.getString("Date"),allowBlank:!1,msgTarget:"side",value:e.value||common.currentDate(),minValue:e.minValue,maxValue:e.maxValue,format:"d.m.Y",name:"dt",id:"dt"}]}),s=e.scope||this,n=new Ext.Window({title:e.title,closable:!0,modal:!0,width:300,height:120,layout:"fit",items:[t],buttons:[{text:"Ok",iconCls:"ok",formBind:!0,handler:function(){var r=t.items.items[0].getValue();n.close(),e.success.call(s,{date:r})}},{code:"cancel",formBind:!1,handler:function(){n.close()}}]});n.show()},dialog.getString=function(e){var t=e.title||$ptitle,s=e.success,n=e.failure,r=e.scope||this,i=e.value,a=new Ext.Button({code:"Ok",formBind:!0,scope:this,handler:function(){s.call(r,l.getValue()),d.close()}}),o=new Ext.Button({code:"Cancel",scope:this,handler:function(){n&&n.call(r),d.close()}}),l=new Ext.form.TextField({selectOnFocus:!0,fieldLabel:e.fieldLabel||"Введите строку",allowBlank:!1,msgTarget:"side",anchor:"95%",value:i,listeners:{render:function(){l.focus(!1,200)},specialkey:function(e,t){t.getKey()!=t.ENTER||a.disabled||(s.call(r,l.getValue()),d.close())},scope:this}}),c=new Ext.FormPanel({frame:!1,border:!1,defaultType:"textfield",monitorValid:!0,buttonAlign:"right",autoScroll:!0,bodyStyle:"background-color: "+$zu.getThemeBGColor()+"; padding: 5px;",layout:"form",items:[l],buttons:[a,o]}),d=new Ext.Window({width:450,height:150,layout:"fit",modal:!0,title:t,items:[c]});d.show(null,function(){l.focus()})},dialog.getNumber=function(e){var t=e.title||$ptitle,s=e.success,n=e.failure,r=e.scope||this,i=new Ext.Button({code:"Ok",formBind:!0,scope:this,handler:function(){s.call(r,o.getValue()),c.close()}}),a=new Ext.Button({code:"Cancel",scope:this,handler:function(){n&&n.call(r),c.close()}}),o=new Ext.form.NumberField({selectOnFocus:!0,fieldLabel:e.fieldLabel||"Введите число",allowBlank:!1,msgTarget:"side",anchor:"95%",listeners:{render:function(){o.focus(!1,200)},specialkey:function(e,t){t.getKey()!=t.ENTER||i.disabled||(s.call(r,o.getValue()),c.close())},scope:this}}),l=new Ext.FormPanel({frame:!1,border:!1,defaultType:"textfield",monitorValid:!0,buttonAlign:"right",autoScroll:!0,bodyStyle:"background-color: "+$zu.getThemeBGColor()+"; padding: 5px;",layout:"form",items:[o],buttons:[i,a]}),c=new Ext.Window({width:450,height:150,layout:"fit",modal:!0,title:t,items:[l]});c.show(null,function(){o.focus()})},$report.sheet=function(e){e=e||{},this.name=e.name||"Sheet",this.orientation=e.orientation||"portrait",this.scale=e.scale||"100",this.margins=e.margins||{left:15,top:15,right:15,bottom:15},this.rows=e.rows||[],this.validation=e.validation||[],this.namedRange=e.namedRange||[],this.columns=e.columns||{},this.ell=e.ell||{},this.autoFitHeight=e.autoFitHeight},$report.row=function(e){e=e||{},this.height=e.height||12.75,this.cells=e.cells||[],this.startIndex=e.startIndex||0},$report.xmlss=function(e){this.params={},this.styles={default:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9",center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9",center_bold:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,bold:true",bold:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,bold:true",border:"hAlign:Left,vAlign:Top,wrap:true,fontSize:9,borders:All",border_center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,borders:All",border_bold:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true",border_bold_underline:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true,underline:true",border_underline:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,underline:true",border_bold_center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true",border_bottom:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:Bottom",right:"hAlign:Right,vAlign:Center,wrap:true,fontSize:9"},this.columns={},this.rows=[],this.sheets=[],this.normalize=function(e){if(Ext.isArray(this.columns)){for(var t={},s=0;s<this.columns.length;s++)t[s+1]={width:this.columns[s]};this.columns=t}this.rows&&this.rows.length||(this.rows=[{cells:[{text:""}]}]);for(var s=0;s<this.rows.length;s++){var n=this.rows[s];n.height=n.height||12.75,n.cells=n.cells||[];for(var r=0;r<n.cells.length;r++)"number"==typeof n.cells[r].text&&(n.cells[r].text=String(n.cells[r].text));n.startIndex=n.startIndex||0}for(var i=0;i<this.sheets.length;i++){var a=this.sheets[i];if(Ext.isArray(a.columns)){for(var t={},s=0;s<a.columns.length;s++)t[s+1]={width:a.columns[s]};a.columns=t}a.rows=a.rows||[];for(var s=0;s<a.rows.length;s++){var n=a.rows[s];n.height=n.height||12.75,n.cells=n.cells||[];for(var r=0;r<n.cells.length;r++){var o=n.cells[r].text;"number"==typeof o&&(n.cells[r].text=String(n.cells[r].text)),"string"==typeof o&&("null"==o?n.cells[r].text="":n.cells[r].text=o.split("<").join("&lt;").split(">").join("&gt;")),e&&e.showNull&&(null==o||""==o||"null"==o)&&(n.cells[r].text="null"),n.cells[r].style=n.cells[r].style||"default"}n.startIndex=n.startIndex||0}a.rows.length||(a.rows=[{startIndex:0,height:12.75,cells:[{text:"",style:"default"}]}])}},this.preview=function(e){var t=this;e=e||{},t.title=e.title;var s=new Ext.Window({title:"Предварительный просмотр",resizable:!0,closable:!0,maximizable:!0,modal:!0,width:1e3,height:600,border:!1,iconCls:"gi_print",layout:"fit",items:{html:t.createHTML({generate:1}),autoScroll:!0},buttons:[{text:"Печать",iconCls:"gi_print",handler:function(){t.create()}}]});s.show()},this.create=function(e){this.normalize(e);var t="report?sessionId="+$sessionId+"&username="+$zp.currentUser+"&format=xmlss&custom=1";document.getElementById("loading").innerHTML="<form name='form_report' method='post' target='_blank' action='"+t+"'><textarea style='display: none' name='params'>"+JSON.stringify(this.params)+"</textarea><textarea style='display: none' name='styles'>"+JSON.stringify(this.styles)+"</textarea><textarea style='display: none' name='columns'>"+JSON.stringify(this.columns)+"</textarea><textarea style='display: none' name='rows'>"+JSON.stringify(this.rows)+"</textarea><textarea style='display: none' name='sheets'>"+JSON.stringify(this.sheets)+"</textarea></form>",document.forms.form_report.submit()},this.createXLSX=function(e){this.normalize(e);var t="report?sessionId="+$sessionId+"&username="+$zp.currentUser+"&format=xlsx";document.getElementById("loading").innerHTML="<form name='form_report' method='post' target='_blank' action='"+t+"'><textarea style='display: none' name='params'>"+JSON.stringify(this.params)+"</textarea><textarea style='display: none' name='styles'>"+JSON.stringify(this.styles)+"</textarea><textarea style='display: none' name='columns'>"+JSON.stringify(this.columns)+"</textarea><textarea style='display: none' name='rows'>"+JSON.stringify(this.rows)+"</textarea><textarea style='display: none' name='sheets'>"+JSON.stringify(this.sheets)+"</textarea></form>",document.forms.form_report.submit()},this.createCSV=function(e){this.normalize(e);var t="report?sessionId="+$sessionId+"&username="+$zp.currentUser+"&format=xlsx&convert_csv=1&win1251=1";document.getElementById("loading").innerHTML="<form name='form_report' method='post' target='_blank' action='"+t+"'><textarea style='display: none' name='params'>"+JSON.stringify(this.params)+"</textarea><textarea style='display: none' name='styles'>"+JSON.stringify(this.styles)+"</textarea><textarea style='display: none' name='columns'>"+JSON.stringify(this.columns)+"</textarea><textarea style='display: none' name='rows'>"+JSON.stringify(this.rows)+"</textarea><textarea style='display: none' name='sheets'>"+JSON.stringify(this.sheets)+"</textarea></form>",document.forms.form_report.submit()},this.createPDF=function(e){this.normalize();var t="pdf?sessionId="+$sessionId;document.getElementById("loading").innerHTML="<form name='form_report' method='post' target='_blank' action='"+t+"'><textarea style='display: none' name='params'>"+JSON.stringify(this.params)+"</textarea><textarea style='display: none' name='styles'>"+JSON.stringify(this.styles)+"</textarea><textarea style='display: none' name='columns'>"+JSON.stringify(this.columns)+"</textarea><textarea style='display: none' name='rows'>"+JSON.stringify(this.rows)+"</textarea><textarea style='display: none' name='sheets'>"+JSON.stringify(this.sheets)+"</textarea></form>",document.forms.form_report.submit()},this.createHTML=function(e){this.normalize(),e=e||{};var t=e.rows||this.rows;this.sheets.length&&(t=this.sheets[0].rows);var s;s=e.generate?{document:{open:function(){},close:function(){},html:"",write:function(e){this.html+=e}}}:window.open("","window1","width=800, height=600, resizable=yes, scrollbars=yes, status=yes, top=10, left=10"),s.document.open(),e.title&&s.document.write("<p><b>"+e.title+"</b></p>"),s.document.write("<style type='text/css'>\n* {\n   font-family: Tahoma;\n   font-size: 8pt;\n}\ntable {\n\tborder-left: 0px;\n\tborder-top: 0px;\n\tborder-right: 1px solid #BBBBBB;\n\tborder-bottom: 1px solid #BBBBBB;\n}\ntr {\n\tborder: 0px;\n}\ntd {\n\tborder-left: 1px solid #BBBBBB;\n\tborder-top: 1px solid #BBBBBB;\n\tborder-right: 0px;\n\tborder-bottom: 0px;\n}\n.tb-text {\n\ttext-align: left;\n\tpadding: 5px;\n}\n.tb-header {\n\tpadding: 5px;\n\tfont-weight: bold;\n\tbackground: #DDDDDD;\n}\n.tb-title {\n\tpadding: 5px;\n\tpadding-left: 20px !important;\n\tbackground: #DDEEFF;\n}\n</style>\n"),s.document.write("<table cellpadding=0 cellspacing=0>");for(var n=0;n<t.length;n++){for(var r=t[n],i=r.cells,a="<tr>",o=0;o<i.length;o++){var l=i[o],c=l.text;void 0!==c&&null!==c&&""!==c||(c="<img width=1 height=1>"),l.style=l.style||"",l.style.indexOf("bold")>-1&&(c="<b>"+c+"</b>"),"border_gray"==l.style&&(c="<font color='gray'>"+c+"</font>");var d="";"border_bg_gray"==l.style&&(d="bgcolor='#DDDDDD'"),"border_bg_red"==l.style&&(d="bgcolor='#ff9999'"),"border_bg_green"==l.style&&(d="bgcolor='#99ff99'"),"border_bg_blue"==l.style&&(d="bgcolor='#9999ff'"),a+="<td class='tb-text' colspan="+l.colspan+" rowspan="+l.rowspan+" "+d+">"+c+"</td>"}a+="</tr>",s.document.write(a)}if(s.document.write("</table>"),s.document.close(),e.generate)return s.document.html}},$dbf.field=function(e){this.name=e.name,this.type=e.type,"D"==e.type?this.size=8:this.size=e.size||0,this.dec=e.dec||0},$dbf.file=function(e){e=e||{},this.options={filename:"data.dbf",coding:e.coding||"WIN"},this.fields=e.fields||[],this.rows=e.rows||[],this.create=function(e){for(var t="report?sessionId="+$sessionId+"&username="+$zp.currentUser+"&format=dbf&custom=1&filename="+this.options.filename,s=0;s<this.rows.length;s++){var n=this.rows[s];for(var r in n)n[r]=String(n[r])}document.getElementById("loading").innerHTML="<form name='form_report' method='post' action='"+t+"'><textarea style='display: none' name='options'>"+JSON.stringify(this.options)+"</textarea><textarea style='display: none' name='fields'>"+JSON.stringify(this.fields)+"</textarea><textarea style='display: none' name='rows'>"+JSON.stringify(this.rows)+"</textarea></form>",document.forms.form_report.submit()}},$csv.file=function(e){e=e||{},this.body=e.body||"",this.create=function(e){var t="report?sessionId="+$sessionId+"&username="+$o.currentUser+"&format=xmlss&custom=1&csv=1";document.getElementById("loading").innerHTML="<form name='form_report' method='post' action='"+t+"'><textarea style='display: none' name='body'>"+this.body+"</textarea></form>",document.forms.form_report.submit()}},String.prototype.fulltrim=function(){return this.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},common.isEmail=function(e){var t=/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;return t.test(e)},Ext.example=function(){function e(e,t){return['<div class="msg">','<div class="x-box-tl"><div class="x-box-tr"><div class="x-box-tc"></div></div></div>','<div class="x-box-ml"><div class="x-box-mr"><div class="x-box-mc"><h3>',e,"</h3>",t,"</div></div></div>",'<div class="x-box-bl"><div class="x-box-br"><div class="x-box-bc"></div></div></div>',"</div>"].join("")}return{msg:function(t,s,n){var r=Ext.DomHelper.insertFirst(n||document.body,{id:"msg-div"},!0),i=Ext.DomHelper.append(r,{html:e(t,s)},!0);i.slideIn("t").pause(500).ghost("t",{remove:!0})},init:function(){var e=Ext.get("lib-bar");e&&e.show()}}}(),common.balloon=function(e,t){Ext.example.msg(e,t)},common.rowLinks=function(e,t,s,n,r,i,a){return(t.id==(a.fieldName||"name")||t.column&&t.column.dataIndex==(a.fieldName||"name"))&&(e=e||a.nullText||"Без названия",a.id=s.data[a.fieldId||"id"],e="<a href='#' onclick='"+a.fn+'.call (Ext.getCmp ("'+this.id+'"), '+JSON.stringify(a)+")'>"+e+"</a>"),e},common.round=function(e,t){if(!e)return e;var s;switch(t){case null:case void 0:case 0:s=1;break;case 1:s=10;break;case 2:s=100;break;case 3:s=1e3;break;case 4:s=1e4;break;default:throw"common.round - invalid n: "+t}var n=Math.round(e*s)/s;return n},common.isNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},common.sqlArray=function(e){for(var t=[],s=0;s<e.length;s++)s&&t.push(","),t.push(e[s]);return t},common.extMajorVersion=function(){var e=Ext.version||Ext.getVersion().version;return e.split(".")[0]},common.isEmail=function(e){var t=/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;return t.test(e)},common.unicode={escape:function(e){return e?e.replace(/^[-~]|\\/g,function(e){var t=e.charCodeAt(0);return"\\u"+(t<16?"000":t<256?"00":t<4096?"0":"")+t.toString(16)}):e},unescape:function(e){return e?e.replace(/\\u([a-fA-F0-9]{4})/g,function(e,t){return String.fromCharCode(parseInt(t,16))}):e}},common.addRecord=function(e){function t(e,t){for(var s=t.split("."),n=e[s[0]],r=1;r<s.length;r++){var i=$o.getObject(n);if(!i){n=null;break}n=i.get(s[r])}return n}var s=e.store,n=e.data,r=e.map;if(!s||!n||!r)return n;for(var i in r)n[i]=t(n,r[i]);var a=e.cmp;if(a.getXType().indexOf("tree")>-1){var o,l=a.getSelectionModel();l.hasSelection()?(o=l.getSelection()[0],o.set("leaf",!1)):o=a.getStore().getRootNode(),n.leaf=!0,o.appendChild(n)}else s.add(n);return n},common.updateRecord=function(e){function t(e,t){for(var s=t.split("."),n=e.get(s[0]),r=1;r<s.length;r++){var i=$o.getObject(n);if(!i){n=void 0;break}n=i.get(s[r])}return n}var s=e.record,n=e.map;if(!s||!n)return s;for(var r in n){var i=t(s,n[r]);void 0!==i&&s.set(r,i)}return s.commit(),s},common.tpl.remove=function(e){e=e||{};var t=this;common.confirm({message:"Вы уверены?",fn:function(s){if("yes"==s){var n=e.id||t.getValue("a_id")||t.getValue("id");if(n){$o.startTransaction({description:"Remove "+n});var r=$o.getObject(n);if(r.remove(),r.commit(),$o.commitTransaction(),t.getSelectionModel){var i=t.getSelectionModel().getSelection()[0];if(t.getXType().indexOf("tree")>-1){var a=i.parentNode;i.remove(),a==t.getStore().getRootNode()||a.childNodes.length||a.set("leaf",!0)}else t.getStore().remove(i)}}}}})},common.tpl.show=function(options){var me=this;options=options||{},options.id=options.id||this.getValue("a_id")||this.getValue("id");var refresh=options.refresh,fn=options.card;fn&&(fn="string"==typeof fn?eval(fn):fn);var layout=options.layout;if(options.title=options.title||"",options.id){var o=$s.getObject(options.id);options.title=o.get("name")||"ID: "+(options.id<0?"Добавление":options.id)}for(var map=options.map||me.map||{},sql=eval("("+me.$view.get("query")+")"),getTree=function(e){function t(s){for(var r=2;r<e.length;r+=4){var i;for(i in e[r])break;if(!n[i])for(var a=e[r+2],o=0;o<a.length;o++)if("object"==typeof a[o]){var l;for(l in a[o])break;l==s&&"id"!=a[o][l]&&(n[i]=n[s]+"."+a[o][l],t(i))}}}var s,n={};for(s in e[0])break;return n[s]=me.$view.attrs.a_id?"a_id":"id",t(s),n},tree=getTree(sql.from),i=1;i<sql.select.length;i++)if("string"==typeof sql.select[i])for(var j=0;j<me.columns.length;j++)if(me.columns[j].dataIndex==sql.select[i]){var a;for(a in sql.select[i-1])break;map[sql.select[i]]=map[sql.select[i]]||tree[a]+"."+sql.select[i-1][a]}layout=layout||fn.call(this,options),options.readOnly&&common.makeReadOnlyLayout(layout);var items={id:"o"+options.id,objectId:options.id,name:"viewContainer",xtype:"$o.layout",opener:me,title:options.title,$layout:layout,listeners:{destroy:function(){var e=$s.getObject(options.id);if(e.get("id")!=options.id){var t=common.addRecord({cmp:me,store:me.getStore(),data:me.$view.attrs.a_id?{a_id:e.get("id")}:{id:e.get("id")},map:map});me.getXType().indexOf("tree")==-1&&(me.getSelectionModel().deselectAll(),me.getSelectionModel().select(me.getStore().getCount()-1))}else{var t=me.getSelectionModel().getSelection()[0];if(!t){var s=me.getStore(),n=me.getSelectionModel();t=s.getById(options.id),t&&n.select(t)}common.updateRecord({cmp:me,record:t,map:map})}refresh&&"function"==typeof me.refresh&&me.refresh()}}};if(options.asWindow){items.title=void 0;var win=Ext.create("Ext.window.Window",{title:options.title,resizable:!0,closable:!0,width:options.width||800,height:options.height||600,layout:"fit",modal:!0,items:items});win.show()}else $o.app.show({items:items})},common.tpl.getViewObjectId=function(){var e=0,t=this.up("*[name=viewContainer]");return t&&(e=t.objectId),e},common.tpl.getOpener=function(){var e=this.up("*[name=viewContainer]");if(e)return e.opener},common.tpl.create=function(options){var me=this,o=$s.createObject(options.classCode,"local");if(options.attrs)for(var attr in options.attrs){var v=options.attrs[attr];"[object Array]"===Object.prototype.toString.apply(v)&&(v=me.relatives[v[0]].getValue(v[1])),o.set(attr,v)}if(me.getXType().indexOf("tree")>-1&&o.set(me.fields.parent,me.getValue(me.fields.id)),options.id=o.get("id"),options.fn){var fn="string"==typeof options.fn?eval(options.fn):options.fn;fn.call(me,o,options)}options.layout||(options.card=options.card||options.classCode+".card"),common.tpl.show.call(this,options)},common.tpl.updateTags=function(e,t){if(!e)return e;var s=[],n=0;"object"==typeof e&&(e=JSON.stringify(e),n=1);for(var r=1;r<e.length;r++)if(("$"==e[r]||"#"==e[r])&&"["==e[r-1]){for(var i="";r<e.length&&"]"!=e[r];r++)i+=e[r];s.indexOf(i)==-1&&s.push(i)}for(var r=0;r<s.length;r++){var a;a="$"==s[r][0]?common.getValue(t,s[r]):t[s[r].substr(1)],e=e.split("["+s[r]+"]").join(a)}return n&&(e=JSON.parse(e)),e},dialog.getClass=function(e){var t=e.success,s=Ext.create("Ext.Window",{title:"Выберите класс",width:900,height:700,layout:"fit",frame:!1,border:!1,bodyPadding:1,items:{xtype:"$o.classes",name:"classes"},listeners:{afterrender:function(){var e,n=s.down("*[zid=olap]"),r=Ext.create("Ext.Button",{text:"Выбрать",iconCls:"ok",disabled:!0,handler:function(){t({id:e}),s.close()}});n.selModel.on("selectionchange",function(){e=n.getCurrentValue("id"),e?r.setDisabled(!1):r.setDisabled(!0)},this),n.lconfig&&n.lconfig.listeners&&n.lconfig.listeners.dblclick&&delete n.lconfig.listeners.dblclick,n.on("itemdblclick",function(){r.handler()});var i=n.down("toolbar[dock=top]");i.insert(0,[r]),i.doLayout()}}});s.show()},dialog.getView=function(e){var t=e.success,s=Ext.create("Ext.Window",{title:"Выберите "+(e.hasQuery?"запрос":"представление"),width:900,height:700,layout:"fit",frame:!1,border:!1,bodyPadding:1,items:{xtype:"$o.views",name:"views"},listeners:{afterrender:function(){var n,r=s.down("*[zid=olap]"),i=Ext.create("Ext.Button",{text:"Выбрать",iconCls:"ok",disabled:!0,handler:function(){t({id:n}),s.close()}});r.selModel.on("selectionchange",function(){n=r.getCurrentValue("id"),n&&(!e.hasQuery||e.hasQuery&&$o.getView(n).get("query"))?i.setDisabled(!1):i.setDisabled(!0)},this),r.lconfig&&r.lconfig.listeners&&r.lconfig.listeners.dblclick&&delete r.lconfig.listeners.dblclick,r.on("itemdblclick",function(){i.handler()});var a=r.down("toolbar[dock=top]");a.insert(0,[i]),a.doLayout()}}});s.show()},dialog.getAction=function(e){var t=e.success,s=Ext.create("Ext.Window",{title:"Выберите действие",width:900,height:700,layout:"fit",frame:!1,border:!1,bodyPadding:1,items:{xtype:"$o.classes",name:"classes"},listeners:{afterrender:function(){var e=s.down("*[zid=olapActions]");e.up("tabpanel").setActiveTab(2);var n,r=Ext.create("Ext.Button",{text:"Выбрать",iconCls:"ok",disabled:!0,handler:function(){t({id:n}),s.close()}});e.selModel.on("selectionchange",function(){n=e.getCurrentValue("id"),n?r.setDisabled(!1):r.setDisabled(!0)},this),e.lconfig&&e.lconfig.listeners&&e.lconfig.listeners.dblclick&&delete e.lconfig.listeners.dblclick,e.on("itemdblclick",function(){r.handler()});var i=e.down("toolbar[dock=top]");i.insert(0,[r]),i.doLayout()}}});s.show()},common.report.show=function(e){var t=$o.getObject(e.id),s=e.success,n=t.get("options")?JSON.parse(t.get("options")):null,r=Ext.create("Ext.Window",{
title:"Отчет",iconCls:"gi_print",width:800,height:600,layout:"fit",frame:!1,border:!1,bodyPadding:1,modal:!0,maximizable:!0,tbar:[{text:"Сохранить",iconCls:"save",handler:function(){var e=r.down("*[name=reportdesigner]"),n=e.getValue();return n.code?($o.startTransaction(),t.set("name",n.name),t.set("code",n.code),t.set("options",JSON.stringify(n)),t.sync("local"),$o.commitTransaction(),void(s&&s({id:t.get("id")}))):void common.message("Введите код отчета.")}},{text:"Предварительный просмотр",iconCls:"gi_search",handler:function(){var e=JSON.parse(t.get("options")),s=Ext.create("$o.ReportDesigner.Widget",{value:e});s.build({html:1})}}],items:{xtype:"$o.reportdesigner",name:"reportdesigner",value:n}});r.show()},common.report.build=function(e){var t=e.code,s=$o.execute({select:[{a:"id"},"id"],from:[{a:"system.vo.report"}],where:[{a:"code"},"=",t]});if(!s.length)return void common.message("Отчет '"+t+"' отсутствует.");var n=$o.getObject(s.get(0,"id")),r=JSON.parse(n.get("options")),i=Ext.create("$o.ReportDesigner.Widget",{value:r});i.build(e)},common.merge=function(e,t){var s={};for(var n in e)e.hasOwnProperty(n)&&(s[n]=e[n]);for(var r in t)t.hasOwnProperty(r)&&(s.hasOwnProperty(r)?"object"==typeof s[r]&&s[r].constructor===Object&&"object"==typeof t[r]&&t[r].constructor===Object&&(s[r]=common.merge(s[r],t[r])):s[r]=t[r]);return s},common.makeReadOnlyLayout=function(layout){function go(e){for(var t in e)if("object"==typeof e[t])if("actions"==t&&Ext.isArray(e[t]))for(var s=e[t].length-1;s>=0;s--)["Открыть"].indexOf(e[t][s].text)>-1||["open"].indexOf(e[t][s].caption)>-1?(e[t][s].arguments=e[t][s].arguments||{},e[t][s].arguments.readOnly=!0):["Добавить","Удалить"].indexOf(e[t][s].text)>-1||["create","delete"].indexOf(e[t][s].caption)>-1?e[t][s].active=function(){return!1}:(e[t][s].arguments=e[t][s].arguments||{},e[t][s].arguments.readOnly=!0);else"listeners"==t&&e.listeners.dblclick?delete e.listeners.dblclick:"card"==t?e[t].readOnly=!0:go(e[t])}return"string"==typeof layout&&(layout=eval("("+layout+")")),go(layout),layout},common.setThousandSeparator=function(e){for(var t=String(e),s=[],n=0;n<t.length%3;n++)t=" "+t;for(var n=0;n<t.length;n+=3)s.push(t.substr(n,3));return s.join(" ")},common.findObject=function(e,t){var s,n,r,i;for(s in t)t.hasOwnProperty(s)&&(n=s,r=t[s]);for(s in e)if(s==n){if(e[s]==r)return e}else if(e[s]instanceof Object&&e.hasOwnProperty(s)&&(i=common.findObject(e[s],t)))return i;return!1},common.findMenuItem=function(e,t){for(var s=e.items,n=0;n<s.getCount();n++){var r=s.getAt(n),i=!0;if(_.each(t,function(e,t){e!=r[t]&&(i=!1)}),i)return r;if(r.menu&&(r=common.findMenuItem(r.menu,t)))return r}},common.updateMenuItemText=function(e,t,s){var n=common.findMenuItem(e,t);n&&n.setText&&n.setText(s)},common.reportTpl=function(e){if("post"==e.method){var t="report?storage="+$o.code+"&sessionId="+$sessionId+"&username="+$o.currentUser+"&time_offset_min="+(new Date).getTimezoneOffset()+"&format="+e.format+"&template="+e.template;e.files&&(t+="&files="+e.files);var s=document.createElement("form");s.target="Map",s.method="POST",s.action=t;var n=document.createElement("input");n.type="text",n.name="opts",n.value=JSON.stringify(e),s.appendChild(n),document.body.appendChild(s),map=window.open("","Map"),s.submit()}else{var t="report?";_.each(e,function(e,s){t+=s+"="+e+"&"}),t+="storage="+$o.code+"&sessionId="+$sessionId+"&username="+$o.currentUser+"&time_offset_min="+(new Date).getTimezoneOffset();var r=window.open(t);r.focus()}},common.serverJob=function(e){e="string"==typeof e?{fn:e}:e,$o.execute({fn:"service.job",args:e,success:function(e){window.open("/projects/"+$o.id+"/resources/html/"+e.logFile,e.logFile)}})},Ext.namespace("system.object","system.object_attr","system.class_","system.class_attr","system.view","system.view_attr","system.revision","system.LoginPassword","spr.conf","system.access","$layout.card","ose.role","ose.srole","ose.ext","ose.object","system.vo.menu","system.vo.menuItems","subject.human"),system.init=function(){$zp.onLogin=function(){"3"==$VERSION_MAJOR&&system.getObjNews()},$zp.onLogout=function(){common.window.closeAll()},$zp.application.on("ready",function(){function e(){var e=document.location.href,t=e.split("#");return 2==t.length?t=t[1]:""}function t(e){for(var t=$zp.application.mainPanel.items,s=0;s<t.getCount();s++){var n=t.getAt(s);if(n.id==e)return $zp.application.mainPanel.setActiveTab(n.id),!0}return!1}function s(e){if("v"==e[0]){var t=$zs.viewsMap[e.substr(1)];if(t)try{$zp.application.onClickMenuItem.call($zp.application,{record:t,text:t.stub.get("name")})}catch(e){$o.app.show.call($o.app,{record:t})}}else if("o"==e[0]){var s=e.substr(1),n=$zs.getObject(s);n&&system.object.show({id:s})}}function n(){var r=e();r!=$zp.hash&&(t(r)||s(r),$zp.hash=r),setTimeout(n,200)}$zp.hash=e(),$zp.hash&&(t($zp.hash)||s($zp.hash)),"onhashchange"in window?window.onhashchange=n:setTimeout(n,200),common.getConf("maxIdleSec").used&&($o.maxIdleSec=common.getConf("maxIdleSec").value)}),$zp.application.on("viewlayout",common.window.onViewLayout)},system.object_attr.history=function(e){e=e||{};var t;if(e.id)t=e.id;else if(e.objectId){var s=common.execSQL({select:[{a:"___fid"},"id"],from:[{a:"system.object_attr"}],where:[{a:"___fend_id"},"=",system.revision.maxRevision,"and",{a:"___fobject_id"},"=",e.objectId,"and",{a:"___fclass_attr_id"},"=",e.classAttrId]});if(0==s.length)return;t=s.get(0,"id")}else e.olap=e.olap||"olap",e.attr=e.attr||"id",t=this.relatives[e.olap].getCurrentValue(e.attr);common.window.show.call(this,{id:t,asWindow:!0,modal:!0,title:$zr.getString("History of changes"),iconCls:"event-log",cardFn:function(e){var t={olap:{id:"olap",view:"ser.system.objectAttrHistory",filter:["fid","=",e.id]}};return t}})},system.revision.maxRevision=2147483647,system.object.classes={},system.object.registerClass=function(e){system.object.classes[e.classId]={},system.object.classes[e.classId].showFunc=e.showFunc},system.object.show=function(e){var t=e.id;!t&&e.olap&&e.attr&&(t=this.zview.getCurrentValue(e.olap,e.attr));var s=$zs.getObject(t),n=$o.getClass(s.get("classId")),r=n.get("id");system.object.classes[r]?system.object.classes[r].showFunc.call(this,{id:t}):common.window.show({id:t,asWindow:!0,modal:!0,title:$zr.getString("Object")+" ID: "+s.getId(),width:800,height:600,cardFn:function(e){var t=$zs.getObject(e.id),s={card:{id:"objectCard",readOnly:!0,fields:[]}};for(var n in t.data)"classId"!=n&&"id"!=n&&s.card.fields.push({objectId:e.id,attr:n});return s}})},system.view.chooseAll=function(e){this.relatives[e.olap].selModel.selectAll()},system.view.selectQuery=function(e){function t(e){var s={text:e.toString()};if(e.childs){s.expanded=0,s.children=[];for(var n=0;n<e.childs.length;n++)s.children.push(t($o.viewsMap[e.childs[n]]))}else s.leaf=1;return s}var s=e.success,n=[];for(var r in $o.viewsMap){var i=$o.viewsMap[r];i.get("parent")||i.get("system")||n.push(t($o.viewsMap[r]))}var a,o=Ext.create("Ext.data.TreeStore",{root:{expanded:!0,children:n},sorters:[{property:"text",direction:"ASC"}]}),l=Ext.create("Ext.Window",{width:800,height:600,layout:"border",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:"Выберите запрос",iconCls:"gi_cogwheel",bodyPadding:5,modal:1,tbar:[{text:"Выбрать",iconCls:"gi_ok",name:"ok",disabled:1,handler:function(){s({value:a}),l.close()}},{text:"Отмена",iconCls:"gi_remove",handler:function(){l.close()}}],items:[{split:!0,region:"west",width:400,layout:"fit",items:{xtype:"treepanel",title:"Представления",iconCls:"gi_eye_open",store:o,rootVisible:!1,border:0,listeners:{select:function(e,t,s,n){var r=0;if(t){var i=t.get("text").split(":")[1].split(")")[0],o=$o.getView(Number(i));l.down("*[name=query]").setValue(o.get("query")?o.get("query"):""),o.get("query")&&(r=1),a=o.get("id")}r?l.down("*[name=ok]").enable():l.down("*[name=ok]").disable()}}}},{region:"center",layout:"fit",items:{title:"Запрос",name:"query",iconCls:"gi_cogwheel",xtype:"codemirrortextarea",mode:"application/ld+json",border:0}}]});l.show()},system.view.showPanel=function(e){var t=$zp.application,s=$zs.views.get(e.id,{async:!1}),n="View-"+s.stub.get("id"),r=new objectum.ui.layout.ViewLayout({border:!1,record:s,bodyStyle:"background-color: "+$zu.getThemeBGColor()+";"});if(!(n in t.openPages)){var i=s.iconCls;!i&&s.stub&&s.stub.get("iconCls")&&(i=s.stub.get("iconCls")),t.openPages[n]=t.mainPanel.add({id:n,xtype:"panel",layout:"fit",node:1,iconCls:i,tabTip:null,title:s.stub.get("name"),closable:!0,bodyStyle:"background-color: "+$zu.getThemeBGColor()+";",items:[r]}),t.mainPanel.doLayout()}t.mainPanel.activate(t.openPages[n])},system.class_.create=function(e){var t=e.name,s=e.code,n=e.parent;if(3==common.extMajorVersion()){var r=$zs.classesMap;for(var i in r)if(n==r[i].stub.get("parent")&&s==r[i].stub.get("code"))throw'class with code "'+s+'" already exists';var a=new objectum.server.Class({code:s,name:t});n&&a.set("parent",n),a.commit();var o=[],l=objectum.server.Object.create(o);l.stub=a,l.storage=$zs,l.storage.registerClass(l)}else{var c=$o.createClass({name:t,code:s,parent:n?n:null});c.sync()}},system.class_attr.create=function(e){function t(e){if(3==common.extMajorVersion()){var t=new objectum.server.ClassAttr({name:e.name,code:e.code,class:e.classId,type:e.typeId});t.commit(),t.storage=$zs,$zs.classAttrs[t.get("id")]=t;var s=$zs.classAttrsMap[t.get("class")]||[];s.push(t),$zs.classAttrsMap[t.get("class")]=s}else{var n=$o.createClassAttr({name:e.name,code:e.code,class:e.classId,type:e.typeId});n.sync()}}if(e.hasOwnProperty("name"))t({name:e.name,code:e.code,classId:e.classId,typeId:e.typeId});else for(var s in e)t({name:e[s].name,code:s,classId:$zs.getClass(e[s].classCode).stub.get("id"),typeId:$zs.getClass(e[s].typeCode).stub.get("id")})},system.class_attr.get=function(e){var t=e.classId||$zs.getClass(e.classCode).stub.get("id"),s=common.execSQL({select:[{a:"___fid"},"id",{a:"___fcode"},"code",{a:"___fname"},"name",{a:"___ftype_id"},"type_id"],from:[{a:"system.class_attr"}],where:[{a:"___fend_id"},"=",system.revision.maxRevision,"and",{a:"___fclass_id"},"=",t]});return s},system.view.create=function(e){var t=e.name,s=e.code,n=e.parent;if(3==common.extMajorVersion()){var r=$zs.viewsMap;for(var i in r)if(n==r[i].stub.get("parent")&&s==r[i].stub.get("code"))throw'view with code "'+s+'" already exists';var a=new objectum.server.View({code:s,name:t});a.set("materialized",0),n&&a.set("parent",n),a.commit();var o=[],l=objectum.server.View.create(o);l.stub=a,l.storage=$zs,l.storage.registerView(l)}else{var c=$o.createView({name:t,code:s,materialized:0,parent:n?n:null});c.sync()}},system.view_attr.create=function(e){function t(e){if(3==common.extMajorVersion()){var t=new objectum.server.ViewAttr({name:e.name,code:e.code,view:e.viewId,order:e.order,area:e.area?e.area:0,width:e.width?e.width:75});t.commit(),t.storage=$zs,$zs.viewAttrs[t.get("id")]=t;var s=$zs.viewAttrsMap[e.viewId]||[];s.push(t),$zs.viewAttrsMap[e.viewId]=s}else{var n=$o.createViewAttr({name:e.name,code:e.code,view:e.viewId,order:e.order,area:e.area?e.area:0,width:e.width?e.width:75});n.sync()}}if(e.hasOwnProperty("name"))t({name:e.name,code:e.code,viewId:e.viewId,area:e.area,width:e.width});else for(var s in e)t({name:e[s].name,code:s,viewId:$zs.getView(e[s].viewCode).stub.get("id"),area:e[s].area?e[s].area:0,width:e[s].width?e[s].width:75})},system.view_attr.get=function(e){var t=e.viewId||$zs.getView(e.viewCode).stub.get("id"),s=common.execSQL({select:[{a:"___fid"},"id",{a:"___fcode"},"code",{a:"___fname"},"name",{a:"___farea"},"area"],from:[{a:"system.view_attr"}],where:[{a:"___fend_id"},"=",system.revision.maxRevision,"and",{a:"___fview_id"},"=",t]});return s},spr.conf.create=function(e){var t=this.getCurrentValue("id")||null,s=obj.create.call(this,{classCode:"spr.conf",attrs:{parent:t},refresh:!e.silence});return e.silence?s:(e.id=s,void spr.conf.show.call(this,e))},spr.conf.remove=function(){obj.remove.call(this,{id:this.getCurrentValue("id"),refresh:!0})},spr.conf.card=function(e){var t=e.id,s={card:{id:"confCard",listeners:{afterSave:function(){if(common.data.hasOwnProperty("spr.conf")){var e=$zs.getObject(t);common.data["spr.conf"][e.get("code")]={id:e.get("id"),used:e.get("used"),name:e.get("name"),value:e.get("value")}}}},fields:[{objectId:t,attr:"npp"},{objectId:t,attr:"name"},{objectId:t,attr:"code"},{objectId:t,attr:"used"},{objectId:t,attr:"value"},{objectId:t,attr:"description"},{objectId:t,attr:"parent",choose:{type:"view",id:"system.conf",attr:"olap.id",width:600,height:400}}]}};return s},spr.conf.show=function(e){common.window.show.call(this,Ext.apply(e,{title:$zr.getString("Option"),cardFn:spr.conf.card,iconCls:"gi_settings"}))},spr.conf.get=function(e){var t=common.execSQL({select:[{a:"value"},"value"],from:[{a:"spr.conf"}],where:[{a:"code"},"=",e.code]});return t.length?t.get(0,"value"):null},common.data=common.data||{},common.data["spr.conf"]={},common.loadConf=function(e){common.data["spr.conf"][e]={};for(var t=common.execSQL({select:[{a:"id"},"id",{a:"code"},"code",{a:"used"},"used",{a:"name"},"name",{a:"value"},"value",{a:"subject"},"subject"],from:[{a:"spr.conf"}],where:e?[{a:"subject"},"=",e]:[{a:"subject"},"is null"]}),s=0;s<t.length;s++)common.data["spr.conf"][e][t.get(s,"code")]={id:t.get(s,"id"),used:t.get(s,"used"),name:t.get(s,"name"),value:t.get(s,"value")}},common.getConf=function(e){var t=e.subject||null;common.data["spr.conf"][t]||common.loadConf(t);var s="string"==typeof e?e:e.code,n=common.data["spr.conf"][t][s];return null==n&&(n={}),n},common.setConf=function(e,t){if(e){var s,n=t.subject||null,r=$o.inTransaction;r||(s=$o.startTransaction({description:"setConf"}));var i,a=common.execSQL({select:[{a:"id"},"id"],from:[{a:"spr.conf"}],where:(n?[{a:"subject"},"=",n]:[{a:"subject"},"is null"]).concat("and",{a:"code"},"=",e)});i=a.length?$o.getObject(a.get(0,"id")):$o.createObject("spr.conf"),i.set("code",e);for(var o in t)i.set(o,t[o]);i.commit(),r||$o.commitTransaction(s),common.data["spr.conf"][n]?common.data["spr.conf"][n][e]={id:i.get("id"),used:i.get("used"),name:i.get("name"),value:i.get("value")}:common.loadConf(n)}},common.setVar=function(e,t){if(e){var s,n=$o.inTransaction;n||(s=$o.startTransaction({description:"setVar"}));var r,i=common.execSQL({select:[{a:"id"},"id"],from:[{a:"spr.conf"}],where:[{a:"subject"},"=",$userId?$userId:0,"and",{a:"name"},"=",e]});r=i.length?$zs.getObject(i.get(0,"id")):$zs.createObject("spr.conf"),r.set("subject",$userId?$userId:0),r.set("name",e),r.set("value",t),r.commit(),n||$o.commitTransaction(s)}},common.getVar=function(e){if(!e)return null;var t=common.execSQL({select:[{a:"value"},"value"],from:[{a:"spr.conf"}],where:[{a:"subject"},"=",$userId?$userId:0,"and",{a:"name"},"=",e]});return t.length?t.get(0,"value"):null},system.access.getObjects=function(e){e=e||{};var t,s=[];t=e.subjects?[{a:"subjectId"},"in",e.subjects]:[{a:"subjectId"},"=",e.subjectId];for(var n={select:[{a:"objectId"},"objectId",{a:"read"},"read",{a:"write"},"write"],from:[{a:"system.access"},"inner-join",{d:"system.object"},"on",[{a:"objectId"},"=",{d:"___fid"},"and",{d:"___fend_id"},"=","2147483647","and",{d:"___fclass_id"},"=",e.classId]],where:t},r=common.execSQL(n),i=0;i<r.length;i++)1==e.read&&!r.get(i,"read")||0==e.read&&r.get(i,"read")||1==e.write&&!r.get(i,"write")||0==e.write&&r.get(i,"write")||(e.comma&&s.length&&s.push(","),e.detail?s.push({id:r.get(i,"objectId"),read:r.get(i,"read"),write:r.get(i,"write")}):s.push(r.get(i,"objectId")));return s},system.xmlObj=null,system.getObjNews=function(revision){revision=revision||0,system.xmlObj||(window.XMLHttpRequest?system.xmlObj=new XMLHttpRequest:window.ActiveXObject&&(system.xmlObj=new ActiveXObject("Microsoft.XMLHTTP"))),system.xmlObj&&(system.xmlObj.open("POST","/objectum/obj_news?sessionId="+$sessionId+"&mustget="+Math.random(),!0),system.xmlObj.onreadystatechange=function(){if(4==system.xmlObj.readyState)if(401==system.xmlObj.status)common.message("Сессия не авторизована. Пожалуйста, перезагрузите страницу браузера.");else if(system.xmlObj.responseText){var r=eval("("+system.xmlObj.responseText+")");if("session removed"==r.header.error&&Ext.Msg.alert($ptitle,$zr.getString("Session disabled"),function(){location.reload()}),r.revision){revision=r.revision;for(var objects=r.objects,i=0;i<objects.length;i++)delete $zs.objectsMap[objects[i]],$zp.application.fireEvent("objectChanged",{id:objects[i]})}r.message&&common.balloon($zr.getString("Server message"),$zr.getString(r.message)),system.getObjNews(revision),system.objNewsFails=0}else system.objNewsFails=system.objNewsFails||0,system.objNewsFails++,setTimeout("system.getObjNews ("+revision+")",5e3)},system.xmlObj.send($zs.id+" "+revision))},Ext.ns("Ext.ux.state"),Ext.ux.state.LocalStorage=function(e){Ext.ux.state.LocalStorage.superclass.constructor.call(this),Ext.apply(this,e),this.state=localStorage},Ext.extend(Ext.ux.state.LocalStorage,Ext.state.Provider,{get:function(e,t){return"undefined"==typeof this.state[e]?t:this.decodeValue(this.state[e])},set:function(e,t){if("undefined"!=typeof t&&null!==t)this.state[e]=this.encodeValue(t),this.fireEvent("statechange",this,e,t);else try{this.clear(e)}catch(e){}}}),window.localStorage)Ext.state.Manager.setProvider(new Ext.ux.state.LocalStorage);else{var thirtyDays=new Date((new Date).getTime()+2592e6);Ext.state.Manager.setProvider(new Ext.state.CookieProvider({expires:thirtyDays}))}system.LoginPassword.create=function(){var e=$o.createObject("system.LoginPassword");e.commit(),this.refresh()},system.LoginPassword.remove=function(){var e=this.getCurrentValue("id");common.confirm({message:$zr.getString("Are you sure?"),scope:this,fn:function(t){"yes"==t&&($o.startTransaction({description:"Remove "+e}),obj.remove.call(this,{id:e,refresh:!0}),$o.commitTransaction())}})},ose.role.card=function(e){var t=e.id,s={card:{id:"ose.role.card",items:[{objectId:t,attr:"npp"},{objectId:t,attr:"name"},{objectId:t,attr:"code"},{objectId:t,attr:"menu",choose:{type:"layout",attr:"olap.a_id",layout:{olap:{id:"olap",view:"system.vo.menu"}}}}]}};return s},ose.srole.card=function(e){var t=e.id,s={card:{id:"ose.srole.card",items:[{objectId:t,attr:"role",choose:{type:"layout",attr:"olap.id",layout:{olap:{id:"olap",view:"system.ose.role"}}}},{objectId:t,attr:"subject",xtype:"numberfield"}]}};return s},ose.ext.card=function(e){var t=e.id,s={card:{id:"ose.ext.card",items:[{objectId:t,attr:"npp"},{objectId:t,attr:"classAttr"},{objectId:t,attr:"take"},{objectId:t,attr:"give"}]}};return s},ose.object.card=function(e){var t=e.id,s={card:{id:"ose.object.card",items:[{objectId:t,attr:"class"},{objectId:t,attr:"object"},{objectId:t,attr:"subject",xtype:"numberfield"},{objectId:t,attr:"read"},{objectId:t,attr:"update"},{objectId:t,attr:"delete"}]}};return s},system.vo.menu.card=function(e){var t=e.id,s={card:{id:"system.vo.menu.card",items:[{objectId:t,attr:"name"},{objectId:t,attr:"position",xtype:"combo",name:"position",width:300,triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["top","Вверху"],["left","Слева"],["bottom","Внизу"],["right","Справа"]]}),valueField:"id",displayField:"text",style:"margin-top: 5px;"},{objectId:t,attr:"large"},{objectId:t,attr:"npp"},{objectId:t,attr:"hidden"}]}};return s},system.vo.menuItems.card=function(e){var t=e.id,s=$o.getObject(t),n={tab:{items:[{card:{id:"system.vo.menu.card",title:"Пункт меню",items:[{objectId:t,attr:"view",xtype:"numberfield",hideLabel:!0,style:"display: none"},{xtype:"$conffield",fieldLabel:"Представление",name:"view",value:s.get("view"),anchor:"-20",confRef:"view",choose:{type:"custom",fn:function(){var e=this;dialog.getView({success:function(t){e.setValue(t.id)}})}},listeners:{change:function(){if(this.up("*[objectumCmp=card]").down("*[attr=view]").setValue(this.getValue()),this.getValue()){this.up("*[objectumCmp=card]").down("*[name=action]").setValue(null);var e=$o.getView(this.getValue());this.up("*[objectumCmp=card]").down("*[attr=name]").setValue(e.get("name")),this.up("*[objectumCmp=card]").down("*[attr=iconCls]").setValue(e.get("iconCls"))}}}},{objectId:t,attr:"action",xtype:"numberfield",hideLabel:!0,style:"display: none"},{xtype:"$conffield",fieldLabel:"Действие",name:"action",value:s.get("action"),anchor:"-20",confRef:"action",choose:{type:"custom",fn:function(){var e=this;dialog.getAction({success:function(t){e.setValue(t.id)}})}},listeners:{change:function(){if(this.up("*[objectumCmp=card]").down("*[attr=action]").setValue(this.getValue()),this.getValue()){this.up("*[objectumCmp=card]").down("*[name=view]").setValue(null);var e=$o.getAction(this.getValue());this.up("*[objectumCmp=card]").down("*[attr=name]").setValue(e.get("name"))}}}},{objectId:t,attr:"name"},{objectId:t,attr:"description"},{objectId:t,attr:"iconCls",xtype:"$iconselector"},{objectId:t,attr:"npp"},{objectId:t,attr:"hidden"}]}},{olap:{id:"olapMenuItems",title:"Дочерние пункты меню",view:"system.vo.menuItems",actions:[{fn:"common.tpl.show",text:"Открыть",arguments:{asWindow:1,card:"system.vo.menuItems.card"},iconCls:"gi_edit",active:"common.recordSelected"},{fn:"common.tpl.create",text:"Добавить",arguments:{asWindow:1,classCode:"system.vo.menuItems",attrs:{parent:t}},iconCls:"gi_circle_plus"},{fn:"common.tpl.remove",text:"Удалить",iconCls:"gi_circle_minus",active:"common.recordSelected"}],listeners:{cellRenderer:"system.vo.menuItems.cellRenderer",dblclick:{fn:"common.tpl.show",arguments:{asWindow:1,card:"system.vo.menuItems.card"}}},filter:["a_parent","=",t]}}]}};return n},system.vo.menu.cellRenderer=function(e,t,s,n,r,i){if(s.get("a_position")&&"a_position"==t.column.dataIndex)switch(s.get("a_position")){case"top":e="Вверху";break;case"left":e="Слева";break;case"bottom":e="Внизу";break;case"right":e="Справа"}return e},system.vo.menuItems.cellRenderer=function(e,t,s,n,r,i){return s.get("a_view")&&"a_view"==t.column.dataIndex&&(e=$o.getView(s.get("a_view")).toString()),s.get("action")&&"action"==t.column.dataIndex&&(e=$o.getAction(s.get("action")).toString()),e},subject.human.create=function(e){common.tpl.create.call(this,Ext.apply(e,{asWindow:1,classCode:"subject.human"}))},subject.human.card=function(e){var t=e.id,s=common.execSQL({select:[{a:"id"},"id",{a:"role"},"role"],from:[{a:"ose.srole"}],where:[{a:"subject"},"=",t]}),n=null;s.length&&(n=s.get(0,"role"));var r={card:{id:"subject.human.card",listeners:{afterSave:function(){n=this.down("*[name=role]").getValue();var e;s.length?e=$o.getObject(s.get(0,"id")):(e=$o.createObject("ose.srole"),e.set("subject",t)),e.set("role",n),e.sync()}},items:[{objectId:t,attr:"surname"},{objectId:t,attr:"forename"},{objectId:t,attr:"patronymic"},{objectId:t,attr:"birthday",timefield:0},{objectId:t,attr:"login"},{objectId:t,attr:"password"},{xtype:"$objectfield",name:"role",fieldLabel:"Роль",value:n,anchor:"-20",choose:{type:"layout",attr:"olap.id",layout:{olap:{id:"olap",view:"system.ose.role"}}}}]}};return r},system.vo.chooseAdminMenu=function(){var e=Ext.create("Ext.Window",{width:400,height:100,layout:"form",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:"Меню администратора",iconCls:"gi_list",bodyPadding:5,modal:1,tbar:[{text:"Ок",iconCls:"gi_ok",handler:function(){common.setConf("adminMenu",{name:"Меню администратора",value:e.down("*[name=menu]").getValue()}),e.close()}},{text:"Отмена",iconCls:"gi_remove",handler:function(){e.close()}}],items:{xtype:"$objectfield",name:"menu",fieldLabel:"Меню",value:common.getConf("adminMenu").value,choose:{type:"layout",attr:"olap.a_id",layout:{olap:{id:"olap",view:"system.vo.menu"}}}}});e.show()},system.vo.buildMenu=function(){function e(t,s){for(var n=[],r=0;r<i.length;r++)if(s==i.get(r,"parent")){var a={text:i.get(r,"name"),iconCls:i.get(r,"iconCls"),viewRecord:$o.getView(i.get(r,"view")),viewReadOnly:i.get(r,"readOnly"),actionRecord:$o.getAction(i.get(r,"action")),handler:function(){this.viewRecord?$o.app.show.call($o.app,{record:this.viewRecord,readOnly:this.viewReadOnly}):this.actionRecord&&this.actionRecord.execute({readOnly:this.viewReadOnly})}};e(a,i.get(r,"id")),n.push(a)}n.length&&(t.menu={items:n})}var t;if("admin"==$o.currentUser)t=common.getConf("adminMenu").value;else if("autologin"==$o.currentUser)t=common.getConf("autologinMenu").value;else{var s=$o.getObject($o.userId);t="subject.human.vo_adm"==$o.getClass(s.get("classId")).getFullCode()?common.getConf("adminMenu").value:$o.menuId}if(!t){if(!s.get("voRole"))return common.message("Пользователю не назначена роль.");var n=$o.getObject(s.get("voRole"));if(!n||!n.get("menu"))return common.message("Пользователю не назначена роль.");t=n.get("menu")}for(var r=common.execSQL({select:[{a:"id"},"id",{a:"position"},"position",{a:"large"},"large"],from:[{a:"system.vo.menu"}],where:[[{a:"hidden"},"is null","or",{a:"hidden"},"=",0],"and",{a:"id"},"=",t],order:[{a:"npp"},",",{a:"name"}]}),i=common.execSQL({select:[{a:"id"},"id",{a:"menu"},"menu",{a:"name"},"name",{a:"iconCls"},"iconCls",{a:"parent"},"parent",{a:"view"},"view",{a:"action"},"action",{a:"readOnly"},"readOnly"],from:[{a:"system.vo.menuItems"}],where:[{a:"hidden"},"is null","or",{a:"hidden"},"=",0],order:[{a:"npp"},",",{a:"name"}]}),a=[],o=0;o<i.length;o++)if(i.get(o,"menu")==t&&!i.get(o,"parent")){var l=i.get(o,"iconCls");l&&r.get(0,"large")&&(l="gib"+l.substr(2));var c={id:i.get(o,"id"),text:i.get(o,"name"),iconCls:l,viewRecord:$o.getView(i.get(o,"view")),viewReadOnly:i.get(o,"readOnly"),actionRecord:$o.getAction(i.get(o,"action")),handler:function(){this.viewRecord?$o.app.show.call($o.app,{record:this.viewRecord,readOnly:this.viewReadOnly}):this.actionRecord&&this.actionRecord.execute({readOnly:this.viewReadOnly})}};r.get(0,"large")&&(c.iconAlign="top",c.scale="large","left"!=r.get(0,"position")&&"right"!=r.get(0,"position")||(c.arrowAlign="bottom",c.menuAlign="tr",c.arrowCls="arrow-right-white")),a.push(c)}for(var d=0;d<a.length;d++)e(a[d],a[d].id);var c={text:"Выход",iconCls:"gi_exit",handler:function(){if($o.userId){$o.startTransaction();var e=$o.getObject($o.userId);e.set("lastLogout",new Date),e.sync(),$o.commitTransaction()}$o.logout({success:function(){location.reload()}})}};if(r.get(0,"large")&&(c.iconCls="gib_exit",c.iconAlign="top",c.scale="large"),a.push(c),$o.visualObjectum.timeMachine&&$o.visualObjectum.timeMachine.showDates){var u=new Date;$o.visualObjectum.timeMachine.dates=$o.visualObjectum.timeMachine.dates||[];for(var o=0;o<$o.visualObjectum.timeMachine.dates.length;o++){var f=$o.visualObjectum.timeMachine.dates[o].date;f.getTime()<u.getTime()&&(u=f)}a.push({xtype:"displayfield",value:"Системная дата:"},{xtype:"datefield",minValue:u,maxValue:new Date,value:new Date,width:100,listeners:{render:function(){Ext.tip.QuickTipManager.register({target:this.id,text:"Просмотр данных в прошедших датах.",width:200,dismissDelay:3e3})},change:function(e,t){var s,n=common.getJulianDay(t),r=common.getJulianDay(new Date);if(n==r)$o.setRevision();else{for(var i=$o.visualObjectum.timeMachine.dates.length-1;i>=0;i--){var a=common.getJulianDay($o.visualObjectum.timeMachine.dates[i].date);a<=n&&(s=$o.visualObjectum.timeMachine.dates[i].id)}$o.setRevision(s)}}}})}switch(r.get(0,"position")){case"top":$o.app.tb.add(a),$o.app.tb.doLayout();break;case"left":$o.app.lb.add(a),$o.app.lb.doLayout();break;case"right":$o.app.rb.add(a),$o.app.rb.doLayout();break;case"bottom":$o.app.bb.add(a),$o.app.bb.doLayout()}},Ext.override(Ext.menu.Menu,{onMouseLeave:function(e){var t=this,s=!1;t.items.each(function(e){e.menu&&e.menu.isVisible()&&(s=!0)}),s||(t.deactivateActiveItem(),t.disabled||t.fireEvent("mouseleave",t,e))}}),Ext.define("ImportCSVObjects.Widget",{extend:"Ext.panel.Panel",alias:["widget.importcsvobjects"],border:!1,layout:"fit",defaults:{border:!1},bodyPadding:2,classId:null,initComponent:function(){var e=this;e.oCls=$o.getClass(e.classId),e.attrs=_.map(e.oCls.attrs,function(e){return e.set("fullName",e.get("name")+" ("+e.get("code")+")"),e});var t=new Ext.Panel({bodyStyle:"background-color: white; padding: 5px;",border:!1,html:'<input type="file" id="selectedFile">'});e.tbar=[{xtype:"combo",fieldLabel:"Кодировка",labelWidth:65,width:150,name:"coding",triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",store:{type:"json",fields:["id","name"],data:[{id:"utf8",name:"utf-8"},{id:"win1251",name:"win-1251"}]},valueField:"id",displayField:"name",value:"utf8",editable:!1},t,{text:"Загрузить",iconCls:"gi_table",name:"load",disabled:!0,handler:function(){var t=Ext.getDom("selectedFile"),s=t.files[0],n=new FileReader;n.onload=function(){var t=n.result.split("\n");e.data=[],e.fields=[],_.each(t,function(t,s){var n=t.split(";"),r={};_.each(n,function(t,n){var t=null==t?"":t.trim();s?r["attr-"+n]=t:e.fields.push({name:t,code:"attr-"+n})}),s&&n.length&&""!=n[0]&&e.data.push(r)}),e.fields.length&&!e.fields[e.fields.length-1].name&&e.fields.splice(e.fields.length-1,1);var s=e.down("*[name=grid]");s.reconfigure({xtype:"store",fields:_.map(e.fields,function(e){return e.code}),data:e.data},_.map(e.fields,function(e){return{text:e.name,dataIndex:e.code,width:90}})),s.getStore().loadData(e.data),e.down("*[name=recNum]").setValue(e.data.length);var r=_.map(e.fields,function(t){var s;_.each(e.attrs,function(e){e.get("name")==t.name&&(s=e.get("code"))});var n={xtype:"combo",fieldLabel:t.name,name:t.code,triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",store:{type:"json",fields:["id","name"],data:_.map(e.attrs,function(e){return{id:e.get("code"),name:e.get("fullName")}})},valueField:"id",displayField:"name",editable:!1,value:s,width:"100%"};return n});e.down("*[name=map]").removeAll(),e.down("*[name=map]").add(r),e.down("*[name=import]").setDisabled(!1)},n.readAsText(s,"utf8"==e.down("*[name=coding]").getValue()?"utf-8":"windows-1251")}},{text:"Импорт",iconCls:"gi_file_import",name:"import",disabled:!0,handler:function(){e.importer?e.importer(e.data):(Ext.MessageBox.show({title:"Пожалуйста подождите",msg:"Действие выполняется ...",progressText:"",width:300,progress:1,closable:0}),setTimeout(function(){$o.startTransaction();var t={};_.each(e.fields,function(s){var n=e.down("*[name="+s.code+"]");t[s.code]=n.getValue()});var s=[],n=e.down("*[name=idAttr]").getValue();n&&(s=$o.execute({asArray:!0,select:[{a:"id"},"id",{a:n},n],from:[{a:e.oCls.getFullCode()}]}));var r={};_.each(s,function(e){r[e[n]]=e.id}),async.reduce(e.data,0,function(s,i,a){var o={};_.each(i,function(e,s){o[t[s]]=e});var l;(!n||n&&o[n])&&(l=n&&r[o[n]]?$o.getObject(r[o[n]]):$o.createObject(e.classId),_.each(o,function(e,t){l.set(t,e)}),l.sync()),Ext.MessageBox.updateProgress(s/e.data.length,s+" / "+e.data.length),setTimeout(function(){a(null,s+1)},1)},function(t){$o.commitTransaction(),Ext.MessageBox.hide(),e.fireEvent("imported")})},100))}}],e.items={xtype:"tabpanel",items:[{title:"Сопоставление полей",layout:"vbox",name:"map",bodyPadding:5,tbar:[{xtype:"textfield",fieldLabel:"Класс",labelWidth:50,width:400,disabled:!0,value:e.oCls.toString()},{xtype:"combo",fieldLabel:"Идентификатор",name:"idAttr",triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",store:{type:"json",fields:["id","name"],data:_.map(e.attrs,function(e){return{id:e.get("code"),name:e.get("fullName")}})},width:300,style:"margin-left: 5px",valueField:"id",displayField:"name",editable:!1}],items:[]},{title:"CSV",xtype:"grid",name:"grid",tbar:[{xtype:"textfield",disabled:!0,name:"recNum",fieldLabel:"Количество"}],store:{xtype:"store",fields:["name"],data:[]},columns:[{text:"Наименование",dataIndex:"name",width:90}],width:"100%",columnLines:!0,rowLines:!0}]},e.on("afterrender",function(){Ext.get("selectedFile").on("change",function(t){e.down("*[name=load]").setDisabled(!1)},this)}),e.addEvents("imported"),e.callParent(arguments)}}),Ext.define("Ext.ux.GroupTabRenderer",{alias:"plugin.grouptabrenderer",extend:"Ext.AbstractPlugin",tableTpl:new Ext.XTemplate('<div id="{view.id}-body" class="'+Ext.baseCSSPrefix+"{view.id}-table "+Ext.baseCSSPrefix+'grid-table-resizer" style="{tableStyle}">',"{%","values.view.renderRows(values.rows, values.viewStartIndex, out);","%}","</div>",{
priority:5}),rowTpl:new Ext.XTemplate("{%",'Ext.Array.remove(values.itemClasses, "',Ext.baseCSSPrefix+'grid-row");','var dataRowCls = values.recordIndex === -1 ? "" : " '+Ext.baseCSSPrefix+'grid-data-row";',"%}",'<div {[values.rowId ? ("id=\\"" + values.rowId + "\\"") : ""]} ','data-boundView="{view.id}" ','data-recordId="{record.internalId}" ','data-recordIndex="{recordIndex}" ','class="'+Ext.baseCSSPrefix+'grouptab-row {[values.itemClasses.join(" ")]} {[values.rowClasses.join(" ")]}{[dataRowCls]}" ',"{rowAttr:attributes}>",'<tpl for="columns">{%',"parent.view.renderCell(values, parent.record, parent.recordIndex, xindex - 1, out, parent)","%}","</tpl>","</div>",{priority:5}),cellTpl:new Ext.XTemplate('{%values.tdCls = values.tdCls.replace(" '+Ext.baseCSSPrefix+'grid-cell "," ");%}','<div class="'+Ext.baseCSSPrefix+'grouptab-cell {tdCls}" {tdAttr}>','<div {unselectableAttr} class="'+Ext.baseCSSPrefix+'grid-cell-inner" style="text-align: {align}; {style};">{value}</div>','<div class="x-grouptabs-corner x-grouptabs-corner-top-left"></div>','<div class="x-grouptabs-corner x-grouptabs-corner-bottom-left"></div>',"</div>",{priority:5}),selectors:{bodySelector:"div."+Ext.baseCSSPrefix+"grid-table-resizer",nodeContainerSelector:"div."+Ext.baseCSSPrefix+"grid-table-resizer",itemSelector:"div."+Ext.baseCSSPrefix+"grouptab-row",dataRowSelector:"div."+Ext.baseCSSPrefix+"grouptab-row",cellSelector:"div."+Ext.baseCSSPrefix+"grouptab-cell",getCellSelector:function(e){var t="div."+Ext.baseCSSPrefix+"grid-cell";return e&&(t+="-"+e.getItemId()),t}},init:function(e){var t=e.getView(),s=this;t.addTableTpl(s.tableTpl),t.addRowTpl(s.rowTpl),t.addCellTpl(s.cellTpl),Ext.apply(t,s.selectors)}}),Ext.define("Ext.ux.GroupTabPanel",{extend:"Ext.Container",alias:"widget.grouptabpanel",requires:["Ext.tree.Panel","Ext.ux.GroupTabRenderer"],baseCls:Ext.baseCSSPrefix+"grouptabpanel",initComponent:function(e){var t=this;Ext.apply(t,e),t.store=t.createTreeStore(),t.layout={type:"hbox",align:"stretch"},t.defaults={border:!1},t.items=[{xtype:"treepanel",cls:"x-tree-panel x-grouptabbar",width:150,rootVisible:!1,store:t.store,hideHeaders:!0,animate:!1,processEvent:Ext.emptyFn,border:!1,plugins:[{ptype:"grouptabrenderer"}],viewConfig:{overItemCls:"",getRowClass:t.getRowClass},columns:[{xtype:"treecolumn",sortable:!1,dataIndex:"text",flex:1,renderer:function(e,t,s,n,r,i,a){var o="";return s.parentNode&&null===s.parentNode.parentNode?(o+=" x-grouptab-first",s.previousSibling&&(o+=" x-grouptab-prev"),s.get("expanded")&&null!=s.firstChild||(o+=" x-grouptab-last")):o+=null===s.nextSibling?" x-grouptab-last":" x-grouptab-center",s.data.activeTab&&(o+=" x-active-tab"),t.tdCls="x-grouptab"+o,e}}]},{xtype:"container",flex:1,layout:"card",activeItem:t.mainItem,baseCls:Ext.baseCSSPrefix+"grouptabcontainer",items:t.cards}],t.addEvents("beforetabchange","tabchange","beforegroupchange","groupchange"),t.callParent(arguments),t.setActiveTab(t.activeTab),t.setActiveGroup(t.activeGroup),t.mon(t.down("treepanel").getSelectionModel(),"select",t.onNodeSelect,t)},getRowClass:function(e,t,s,n){var r="";return e.data.activeGroup&&(r+=" x-active-group"),r},onNodeSelect:function(e,t){var s,n=this,r=n.store.getRootNode();if(s=t.parentNode&&null===t.parentNode.parentNode?t:t.parentNode,n.setActiveGroup(s.get("id"))===!1||n.setActiveTab(t.get("id"))===!1)return!1;for(;r;)r.set("activeTab",!1),r.set("activeGroup",!1),r=r.firstChild||r.nextSibling||r.parentNode.nextSibling;s.set("activeGroup",!0),s.eachChild(function(e){e.set("activeGroup",!0)}),t.set("activeTab",!0),e.view.refresh()},setActiveTab:function(e){var t,s=this,n=e;return Ext.isString(e)&&(n=Ext.getCmp(n)),n!==s.activeTab&&(t=s.activeTab,s.fireEvent("beforetabchange",s,n,t)!==!1&&(s.activeTab=n,s.rendered&&s.down("container[baseCls="+Ext.baseCSSPrefix+"grouptabcontainer]").getLayout().setActiveItem(n),s.fireEvent("tabchange",s,n,t)),!0)},setActiveGroup:function(e){var t,s=this,n=e;return Ext.isString(e)&&(n=Ext.getCmp(n)),n===s.activeGroup||(t=s.activeGroup,s.fireEvent("beforegroupchange",s,n,t)!==!1&&(s.activeGroup=n,s.fireEvent("groupchange",s,n,t),!0))},createTreeStore:function(){var e=this,t=e.prepareItems(e.items),s={text:".",children:[]},n=e.cards=[];return e.activeGroup=e.activeGroup||0,Ext.each(t,function(t,r){var i=t.items.items,a=i[t.mainItem]||i[0],o={children:[]};o.id=a.id,o.text=a.title,o.iconCls=a.iconCls,o.expanded=!0,o.activeGroup=e.activeGroup===r,o.activeTab=!!o.activeGroup,o.activeTab&&(e.activeTab=o.id),o.activeGroup&&(e.mainItem=t.mainItem||0,e.activeGroup=o.id),Ext.each(i,function(e){if(e.id!==o.id){var t={id:e.id,leaf:!0,text:e.title,iconCls:e.iconCls,activeGroup:o.activeGroup,activeTab:!1};o.children.push(t)}delete e.title,delete e.iconCls,n.push(e)}),s.children.push(o)}),Ext.create("Ext.data.TreeStore",{fields:["id","text","activeGroup","activeTab"],root:{expanded:!0},proxy:{type:"memory",data:s}})},getActiveTab:function(){return this.activeTab},getActiveGroup:function(){return this.activeGroup}}),Ext.define("Ext.ux.form.MultiSelect",{extend:"Ext.form.FieldContainer",mixins:{bindable:"Ext.util.Bindable",field:"Ext.form.field.Field"},alternateClassName:"Ext.ux.Multiselect",alias:["widget.multiselectfield","widget.multiselect"],requires:["Ext.panel.Panel","Ext.view.BoundList","Ext.layout.container.Fit"],uses:["Ext.view.DragZone","Ext.view.DropZone"],layout:"anchor",ddReorder:!1,appendOnly:!1,displayField:"text",allowBlank:!0,minSelections:0,maxSelections:Number.MAX_VALUE,blankText:"This field is required",minSelectionsText:"Minimum {0} item(s) required",maxSelectionsText:"Maximum {0} item(s) required",delimiter:",",dragText:"{0} Item{1}",ignoreSelectChange:0,initComponent:function(){var e=this;e.bindStore(e.store,!0),e.store.autoCreated&&(e.valueField=e.displayField="field1",e.store.expanded||(e.displayField="field2")),Ext.isDefined(e.valueField)||(e.valueField=e.displayField),e.items=e.setupItems(),e.callParent(),e.initField(),e.addEvents("drop")},setupItems:function(){var e=this;return e.boundList=Ext.create("Ext.view.BoundList",Ext.apply({anchor:"none 100%",deferInitialRefresh:!1,border:1,multiSelect:!0,store:e.store,displayField:e.displayField,disabled:e.disabled},e.listConfig)),e.boundList.getSelectionModel().on("selectionchange",e.onSelectChange,e),e.title?(e.boundList.border=!1,{border:!0,anchor:"none 100%",layout:"anchor",title:e.title,tbar:e.tbar,items:e.boundList}):e.boundList},onSelectChange:function(e,t){this.ignoreSelectChange||this.setValue(t)},getSelected:function(){return this.boundList.getSelectionModel().getSelection()},isEqual:function(e,t){var s,n=Ext.Array.from,r=0;if(e=n(e),t=n(t),s=e.length,s!==t.length)return!1;for(;r<s;r++)if(t[r]!==e[r])return!1;return!0},afterRender:function(){var e,t=this;t.callParent(),t.selectOnRender&&(e=t.getRecordsForValue(t.value),e.length&&(++t.ignoreSelectChange,t.boundList.getSelectionModel().select(e),--t.ignoreSelectChange),delete t.toSelect),!t.ddReorder||t.dragGroup||t.dropGroup||(t.dragGroup=t.dropGroup="MultiselectDD-"+Ext.id()),(t.draggable||t.dragGroup)&&(t.dragZone=Ext.create("Ext.view.DragZone",{view:t.boundList,ddGroup:t.dragGroup,dragText:t.dragText})),(t.droppable||t.dropGroup)&&(t.dropZone=Ext.create("Ext.view.DropZone",{view:t.boundList,ddGroup:t.dropGroup,handleNodeDrop:function(e,s,n){var r,i=this.view,a=i.getStore(),o=e.records;e.view.store.remove(o),r=a.indexOf(s),"after"===n&&r++,a.insert(r,o),i.getSelectionModel().select(o),t.fireEvent("drop",t,o)}}))},isValid:function(){var e=this,t=e.disabled,s=e.forceValidation||!t;return s?e.validateValue(e.value):t},validateValue:function(e){var t=this,s=t.getErrors(e),n=Ext.isEmpty(s);return t.preventMark||(n?t.clearInvalid():t.markInvalid(s)),n},markInvalid:function(e){var t=this,s=t.getActiveError();t.setActiveErrors(Ext.Array.from(e)),s!==t.getActiveError()&&t.updateLayout()},clearInvalid:function(){var e=this,t=e.hasActiveError();e.unsetActiveError(),t&&e.updateLayout()},getSubmitData:function(){var e,t=this,s=null;return t.disabled||!t.submitValue||t.isFileUpload()||(e=t.getSubmitValue(),null!==e&&(s={},s[t.getName()]=e)),s},getSubmitValue:function(){var e=this,t=e.delimiter,s=e.getValue();return Ext.isString(t)?s.join(t):s},getValue:function(){return this.value||[]},getRecordsForValue:function(e){var t,s,n,r=this,i=[],a=r.store.getRange(),o=r.valueField,l=0,c=a.length;for(n=e.length;l<n;++l)for(s=0;s<c;++s)t=a[s],t.get(o)==e[l]&&i.push(t);return i},setupValue:function(e){var t,s,n,r=this.delimiter,i=this.valueField,a=0;if(Ext.isDefined(e)){for(r&&Ext.isString(e)?e=e.split(r):Ext.isArray(e)||(e=[e]),s=e.length;a<s;++a)n=e[a],n&&n.isModel&&(e[a]=n.get(i));t=Ext.Array.unique(e)}else t=[];return t},setValue:function(e){var t=this,s=t.boundList.getSelectionModel(),n=t.store;return n.getCount()?(e=t.setupValue(e),t.mixins.field.setValue.call(t,e),void(t.rendered?(++t.ignoreSelectChange,s.deselectAll(),s.select(t.getRecordsForValue(e)),--t.ignoreSelectChange):t.selectOnRender=!0)):void n.on({load:Ext.Function.bind(t.setValue,t,[e]),single:!0})},clearValue:function(){this.setValue([])},onEnable:function(){var e=this.boundList;this.callParent(),e&&e.enable()},onDisable:function(){var e=this.boundList;this.callParent(),e&&e.disable()},getErrors:function(e){var t,s=this,n=Ext.String.format,r=[];return e=Ext.Array.from(e||s.getValue()),t=e.length,!s.allowBlank&&t<1&&r.push(s.blankText),t<s.minSelections&&r.push(n(s.minSelectionsText,s.minSelections)),t>s.maxSelections&&r.push(n(s.maxSelectionsText,s.maxSelections)),r},onDestroy:function(){var e=this;e.bindStore(null),Ext.destroy(e.dragZone,e.dropZone),e.callParent()},onBindStore:function(e){var t=this.boundList;t&&t.bindStore(e)}}),Ext.define("Ext.ux.grid.FiltersFeature",{extend:"Ext.grid.feature.Feature",alias:"feature.filters",uses:["Ext.ux.grid.menu.ListMenu","Ext.ux.grid.menu.RangeMenu","Ext.ux.grid.filter.BooleanFilter","Ext.ux.grid.filter.DateFilter","Ext.ux.grid.filter.DateTimeFilter","Ext.ux.grid.filter.ListFilter","Ext.ux.grid.filter.NumericFilter","Ext.ux.grid.filter.StringFilter"],autoReload:!0,filterCls:"ux-filtered-column",local:!1,menuFilterText:"Filters",paramPrefix:"filter",showMenu:!0,stateId:void 0,updateBuffer:500,hasFeatureEvent:!1,constructor:function(e){var t=this;t.callParent(arguments),t.deferredUpdate=Ext.create("Ext.util.DelayedTask",t.reload,t),t.filters=t.createFiltersCollection(),t.filterConfigs=e.filters},init:function(e){var t=this,s=t.view,n=s.headerCt;t.bindStore(s.getStore(),!0),n.on("menucreate",t.onMenuCreate,t),s.on("refresh",t.onRefresh,t),e.on({scope:t,beforestaterestore:t.applyState,beforestatesave:t.saveState,beforedestroy:t.destroy}),e.filters=t,e.addEvents("filterupdate")},createFiltersCollection:function(){return Ext.create("Ext.util.MixedCollection",!1,function(e){return e?e.dataIndex:null})},createFilters:function(){function e(e,n,r){e&&(r||n)&&(t=c.get(e),s={dataIndex:e,type:t&&t.type&&t.type.type||"auto"},Ext.isObject(n)&&Ext.apply(s,n),o.replace(s))}var t,s,n,r=this,i=r.filters.getCount(),a=r.getGridPanel(),o=r.createFiltersCollection(),l=a.store.model,c=l.prototype.fields;i&&(n={},r.saveState(null,n)),Ext.Array.each(r.filterConfigs,function(t){e(t.dataIndex,t)}),Ext.Array.each(a.columnManager.getColumns(),function(t){t.filterable===!1?o.removeAtKey(t.dataIndex):e(t.dataIndex,t.filter,t.filterable)}),r.removeAll(),o.items&&r.initializeFilters(o.items),i&&r.applyState(null,n)},initializeFilters:function(e){var t,s,n,r=this,i=e.length;for(t=0;t<i;t++)s=e[t],s&&(n=r.getFilterClass(s.type),s=s.menu?s:new n(Ext.apply({grid:r.grid},s)),r.filters.add(s),Ext.util.Observable.capture(s,this.onStateChange,this))},onMenuCreate:function(e,t){var s=this;s.createFilters(),t.on("beforeshow",s.onMenuBeforeShow,s)},onMenuBeforeShow:function(e){var t,s,n=this;n.showMenu&&(t=n.menuItem,t&&!t.isDestroyed||(n.createMenuItem(e),t=n.menuItem),s=n.getMenuFilter(),s&&(t.setMenu(s.menu,!1),t.setChecked(s.active),t.setDisabled(s.disabled===!0)),t.setVisible(!!s),this.sep.setVisible(!!s))},createMenuItem:function(e){var t=this;t.sep=e.add("-"),t.menuItem=e.add({checked:!1,itemId:"filters",text:t.menuFilterText,listeners:{scope:t,checkchange:t.onCheckChange,beforecheckchange:t.onBeforeCheck}})},getGridPanel:function(){return this.view.up("gridpanel")},applyState:function(e,t){var s,n,r=this;if(r.applyingState=!0,r.clearFilters(),t.filters)for(s in t.filters)t.filters.hasOwnProperty(s)&&(n=r.filters.get(s),n&&(n.setValue(t.filters[s]),n.setActive(!0)));r.deferredUpdate.cancel(),r.local&&r.reload(),delete r.applyingState,delete t.filters},saveState:function(e,t){var s={};return this.filters.each(function(e){e.active&&(s[e.dataIndex]=e.getValue())}),t.filters=s},destroy:function(){var e=this;Ext.destroyMembers(e,"menuItem","sep"),e.removeAll(),e.clearListeners()},removeAll:function(){this.filters&&(Ext.destroy.apply(Ext,this.filters.items),this.filters.clear())},bindStore:function(e){var t=this;t.store&&t.storeListeners&&t.store.un(t.storeListeners),e?(t.storeListeners={scope:t},t.local?t.storeListeners.load=t.onLoad:t.storeListeners["before"+(e.buffered?"prefetch":"load")]=t.onBeforeLoad,e.on(t.storeListeners)):delete t.storeListeners,t.store=e},getMenuFilter:function(){var e=this.view.headerCt.getMenu().activeHeader;return e?this.filters.get(e.dataIndex):null},onCheckChange:function(e,t){this.getMenuFilter().setActive(t)},onBeforeCheck:function(e,t){return!t||this.getMenuFilter().isActivatable()},onStateChange:function(e,t){if("serialize"!==e){var s=this,n=s.getGridPanel();t==s.getMenuFilter()&&s.menuItem.setChecked(t.active,!1),!s.autoReload&&!s.local||s.applyingState||s.deferredUpdate.delay(s.updateBuffer),s.updateColumnHeadings(),s.applyingState||n.saveState(),n.fireEvent("filterupdate",s,t)}},onBeforeLoad:function(e,t){t.params=t.params||{},this.cleanParams(t.params);var s=this.buildQuery(this.getFilterData());Ext.apply(t.params,s)},onLoad:function(e){e.filterBy(this.getRecordFilter())},onRefresh:function(){this.updateColumnHeadings()},updateColumnHeadings:function(){var e=this,t=e.view.headerCt;t&&t.items.each(function(t){var s=e.getFilter(t.dataIndex);t[s&&s.active?"addCls":"removeCls"](e.filterCls)})},reload:function(){var e=this,t=e.view.getStore();e.local?(t.clearFilter(!0),t.filterBy(e.getRecordFilter()),t.sort()):(e.deferredUpdate.cancel(),t.buffered&&t.data.clear(),t.loadPage(1))},getRecordFilter:function(){var e,t,s=[],n=this.lockingPartner;return this.filters.each(function(e){e.active&&s.push(e)}),n&&n.filters.each(function(e){e.active&&s.push(e)}),e=s.length,function(n){for(t=0;t<e;t++)if(!s[t].validateRecord(n))return!1;return!0}},addFilter:function(e){var t,s,n,r,i,a=this,o=a.getGridPanel().columnManager.getColumns();for(t=0,s=o.length;t<s;t++)n=o[t],n.dataIndex===e.dataIndex&&(n.filter=e);for(a.view.headerCt.menu?a.createFilters():a.view.headerCt.getMenu(),t=0,r=a.filters.items.length;t<r;t++)if(i=a.filters.items[t],i.dataIndex===e.dataIndex)return i},addFilters:function(e){if(e){var t,s,n=this;for(t=0,s=e.length;t<s;t++)n.addFilter(e[t])}},getFilter:function(e){return this.filters.get(e)},clearFilters:function(){this.filters.each(function(e){e.setActive(!1)})},getFilterItems:function(){var e=this;return e.lockingPartner?e.filters.items.concat(e.lockingPartner.filters.items):e.filters.items},getFilterData:function(){var e,t,s,n,r,i,a=this.getFilterItems(),o=[];for(e=0,t=a.length;e<t;e++)if(s=a[e],s.active)for(n=[].concat(s.serialize()),r=0,i=n.length;r<i;r++)o.push({field:s.dataIndex,data:n[r]});return o},buildQuery:function(e){var t,s,n,r,i,a,o={},l=e.length;if(this.encode){for(a=[],t=0;t<l;t++)s=e[t],a.push(Ext.apply({},{field:s.field},s.data));a.length>0&&(o[this.paramPrefix]=Ext.JSON.encode(a))}else for(t=0;t<l;t++){s=e[t],n=[this.paramPrefix,"[",t,"]"].join(""),o[n+"[field]"]=s.field,r=n+"[data]";for(i in s.data)o[[r,"[",i,"]"].join("")]=s.data[i]}return o},cleanParams:function(e){if(this.encode)delete e[this.paramPrefix];else{var t,s;t=new RegExp("^"+this.paramPrefix+"[[0-9]+]");for(s in e)t.test(s)&&delete e[s]}},getFilterClass:function(e){switch(e){case"auto":e="string";break;case"int":case"float":e="numeric";break;case"bool":e="boolean"}return Ext.ClassManager.getByAlias("gridfilter."+e)}}),Ext.define("Ext.ux.grid.filter.Filter",{extend:"Ext.util.Observable",active:!1,dataIndex:null,menu:null,updateBuffer:500,constructor:function(e){Ext.apply(this,e),this.addEvents("activate","deactivate","serialize","update"),Ext.ux.grid.filter.Filter.superclass.constructor.call(this),this.menu=this.createMenu(e),this.init(e),e&&e.value&&(this.setValue(e.value),this.setActive(e.active!==!1,!0),delete e.value)},destroy:function(){this.menu&&this.menu.destroy(),this.clearListeners()},init:Ext.emptyFn,createMenu:function(e){return e.plain=!0,Ext.create("Ext.menu.Menu",e)},getValue:Ext.emptyFn,setValue:Ext.emptyFn,isActivatable:function(){return!0},getSerialArgs:Ext.emptyFn,validateRecord:function(){return!0},serialize:function(){var e=this.getSerialArgs();return this.fireEvent("serialize",e,this),e},fireUpdate:function(){this.active&&this.fireEvent("update",this),this.setActive(this.isActivatable())},setActive:function(e,t){this.active!=e&&(this.active=e,t!==!0&&this.fireEvent(e?"activate":"deactivate",this))}}),Ext.define("Ext.ux.grid.filter.DateFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.date",uses:["Ext.picker.Date","Ext.menu.Menu"],afterText:"After",afterEqText:"After equal",beforeText:"Before",beforeEqText:"Before equal",compareMap:{beforeEq:"lte",before:"lt",afterEq:"gte",after:"gt",non:"neq",on:"eq"},dateFormat:"m/d/Y",menuItems:["beforeEq","before","afterEq","after","-","non","on"],menuItemCfgs:{selectOnFocus:!0,width:125},onText:"On",nonText:"NOn",pickerOpts:{},init:function(e){var t,s,n,r,i,a=this;for(t=Ext.apply(a.pickerOpts,{xtype:"datepicker",minDate:a.minDate,maxDate:a.maxDate,format:a.dateFormat,listeners:{scope:a,select:a.onMenuSelect}}),a.fields={},s=0,n=a.menuItems.length;s<n;s++)r=a.menuItems[s],"-"!==r&&(i={itemId:"range-"+r,text:a[r+"Text"],menu:Ext.create("Ext.menu.Menu",{plain:!0,items:[Ext.apply(t,{itemId:r,listeners:{select:a.onPickerSelect,scope:a}})]}),listeners:{scope:a,checkchange:a.onCheckChange}},r=a.fields[r]=Ext.create("Ext.menu.CheckItem",i)),a.menu.add(r);a.values={}},onCheckChange:function(e,t){var s=this,n=e.menu.items.first(),r=n.itemId,i=s.values;t?i[r]=n.getValue():delete i[r],s.setActive(s.isActivatable()),s.fireEvent("update",s)},onInputKeyUp:function(e,t){var s=t.getKey();s==t.RETURN&&e.isValid()&&(t.stopEvent(),this.menu.hide())},onMenuSelect:function(e,t){var s=this.fields,n=this.fields[e.itemId];n.setChecked(!0),n==s.on?(s.before.setChecked(!1,!0),s.after.setChecked(!1,!0)):(s.on.setChecked(!1,!0),n==s.after&&this.getFieldValue("before")<t?s.before.setChecked(!1,!0):n==s.before&&this.getFieldValue("after")>t&&s.after.setChecked(!1,!0)),this.fireEvent("update",this),e.up("menu").hide()},getValue:function(){var e,t={};for(e in this.fields)this.fields[e].checked&&(t[e]=this.getFieldValue(e));return t},setValue:function(e,t){var s;for(s in this.fields)e[s]?(this.getPicker(s).setValue(e[s]),this.fields[s].setChecked(!0)):t||this.fields[s].setChecked(!1);this.fireEvent("update",this)},isActivatable:function(){var e;for(e in this.fields)if(this.fields[e].checked)return!0;return!1},getSerialArgs:function(){var e=[];for(var t in this.fields)this.fields[t].checked&&e.push({type:"date",comparison:this.compareMap[t],value:Ext.Date.format(this.getFieldValue(t),this.dateFormat)});return e},getFieldValue:function(e){return this.values[e]},getPicker:function(e){return this.fields[e].menu.items.first()},validateRecord:function(e){var t,s,n=e.get(this.dataIndex),r=Ext.Date.clearTime;if(!Ext.isDate(n))return!1;n=r(n,!0).getTime();for(t in this.fields)if(this.fields[t].checked){if(s=r(this.getFieldValue(t),!0).getTime(),"beforeEq"==t&&s<=n)return!1;if("before"==t&&s<n)return!1;if("afterEq"==t&&s>=n)return!1;if("after"==t&&s>n)return!1;if("non"==t&&s==n)return!1;if("on"==t&&s!=n)return!1}return!0},onPickerSelect:function(e,t){this.values[e.itemId]=t,this.fireEvent("update",this)}}),Ext.define("Ext.ux.grid.filter.BooleanFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.boolean",defaultValue:!1,yesText:"Yes",noText:"No",init:function(e){var t=Ext.id();this.options=[Ext.create("Ext.menu.CheckItem",{text:this.yesText,group:t,checked:this.defaultValue===!0}),Ext.create("Ext.menu.CheckItem",{text:this.noText,group:t,checked:this.defaultValue===!1})],this.menu.add(this.options[0],this.options[1]);for(var s=0;s<this.options.length;s++)this.options[s].on("click",this.fireUpdate,this),this.options[s].on("checkchange",this.fireUpdate,this)},getValue:function(){return this.options[0].checked},setValue:function(e){this.options[e?0:1].setChecked(!0)},getSerialArgs:function(){var e={type:"boolean",value:this.getValue()};return e},validateRecord:function(e){return e.get(this.dataIndex)==this.getValue()}}),Ext.define("Ext.ux.grid.filter.DateTimeFilter",{extend:"Ext.ux.grid.filter.DateFilter",alias:"gridfilter.datetime",dateDefaults:{xtype:"datepicker",format:"m/d/Y"},timeDefaults:{xtype:"timepicker",width:100,height:200,format:"g:i A"},dockDefaults:{dock:"top",buttonText:"Filter"},selectDateToFilter:!0,positionDatepickerFirst:!0,reTime:/\s(am|pm)/i,reItemId:/\w*-(\w*)$/,addTimeSelection:function(e,t){var s,n,r,i,a=this,o=t.getSelectionModel().getSelection(),l=0,c=[],d=["setHours","setMinutes","setSeconds","setMilliseconds"];if(o.length)for(s=o[0].get("disp"),c=s.replace(a.reTime,"").split(":"),n=c.length;l<n;l++)r=d[l],i=c[l],i&&e[r](parseInt(i,10));return e},init:function(e){var t,s,n,r,i,a=this,o=Ext.applyIf(a.date||{},a.dateDefaults),l=Ext.applyIf(a.time||{},a.timeDefaults),c=a.dock,d={click:{scope:a,click:a.onMenuSelect},select:{scope:a,select:a.onMenuSelect}},u=[o,l],f=0;for(a.positionDatepickerFirst||(u=u.reverse(),f=1),t=Ext.apply(a.pickerOpts,{xtype:c?"panel":"container",layout:"hbox",items:u}),c?c&&(a.selectDateToFilter=null,c.dockedItems?(t.dockedItems=c.dockedItems,t.dockedItems.items[c.bindToItem||0].listeners=d.click):(Ext.isBoolean(c)&&(c={}),c=Ext.applyIf(c,a.dockDefaults),t.dockedItems={xtype:"toolbar",dock:c.dock,items:[{xtype:"button",text:c.buttonText,flex:1,listeners:d.click}]})):a.selectDateToFilter?o.listeners=d.select:l.listeners=d.select,a.fields={},s=0,n=a.menuItems.length;s<n;s++)r=a.menuItems[s],"-"!==r&&(t.items[f].itemId=r,i={itemId:"range-"+r,text:a[r+"Text"],menu:Ext.create("Ext.menu.Menu",{items:t}),listeners:{scope:a,checkchange:a.onCheckChange}},r=a.fields[r]=Ext.create("Ext.menu.CheckItem",i)),a.menu.add(r);a.values={}},onCheckChange:function(e,t){var s=this,n=e.menu,r=n.down("timepicker"),i=n.down("datepicker"),a=i.itemId,o=s.values;t?o[a]=s.addTimeSelection(i.value,r):delete o[a],s.setActive(s.isActivatable()),s.fireEvent("update",s)},onMenuSelect:function(e,t){var s,n=this,r=n.menu,i=r.getFocusEl().itemId.replace(n.reItemId,"$1"),a=n.fields;e=r.queryById(i),s=n.fields[e.itemId],s.setChecked(!0),s==a.on?(a.before.setChecked(!1,!0),a.after.setChecked(!1,!0)):(a.on.setChecked(!1,!0),s==a.after&&n.getFieldValue("before")<t?a.before.setChecked(!1,!0):s==a.before&&n.getFieldValue("after")>t&&a.after.setChecked(!1,!0)),n.fireEvent("update",n),e.ownerCt.ownerCt.hide()},getSerialArgs:function(){var e,t=this,s=t.fields,n=[];for(e in s)s[e].checked&&n.push({type:"datetime",comparison:t.compareMap[e],value:Ext.Date.format(t.getFieldValue(e),(t.date.format||t.dateDefaults.format)+" "+(t.time.format||t.timeDefaults.format))});return n},setValue:function(e,t){var s,n,r,i=this,a=i.fields;for(s in a)n=e[s],n?(r=i.menu.down('datepicker[itemId="'+s+'"]'),r.update(n),r.value=n,a[s].setChecked(!0)):t||a[s].setChecked(!1);i.fireEvent("update",i)},validateRecord:function(e){var t,s,n=this,r=e.get(n.dataIndex);if(!Ext.isDate(r))return!1;r=r.getTime();for(t in n.fields)if(n.fields[t].checked){if(s=n.getFieldValue(t).getTime(),"before"==t&&s<=r)return!1;if("after"==t&&s>=r)return!1;if("on"==t&&s!=r)return!1}return!0}}),Ext.define("Ext.ux.grid.filter.ListFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.list",phpMode:!1,init:function(e){this.dt=Ext.create("Ext.util.DelayedTask",this.fireUpdate,this)},createMenu:function(e){var t=Ext.create("Ext.ux.grid.menu.ListMenu",e);return t.on("checkchange",this.onCheckChange,this),t},getValue:function(){return this.menu.getSelected()},setValue:function(e){this.menu.setSelected(e),this.fireEvent("update",this)},isActivatable:function(){return this.getValue().length>0},getSerialArgs:function(){return{type:"list",value:this.phpMode?this.getValue().join(","):this.getValue()}},onCheckChange:function(){this.dt.delay(this.updateBuffer)},validateRecord:function(e){var t=this.getValue();return Ext.Array.indexOf(t,e.get(this.dataIndex))>-1}}),Ext.define("Ext.ux.grid.filter.NumericFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.numeric",uses:["Ext.form.field.Number"],createMenu:function(e){var t,s=this;return t=Ext.create("Ext.ux.grid.menu.RangeMenu",e),t.on("update",s.fireUpdate,s),t},getValue:function(){return this.menu.getValue()},setValue:function(e){this.menu.setValue(e)},isActivatable:function(){var e,t=this.getValue();for(e in t)if(void 0!==t[e])return!0;return!1},getSerialArgs:function(){var e,t=[],s=this.menu.getValue();for(e in s)t.push({type:"numeric",comparison:e,value:s[e]});return t},validateRecord:function(e){var t=e.get(this.dataIndex),s=this.getValue(),n=Ext.isNumber;return(!n(s.eq)||t==s.eq)&&(!(n(s.lt)&&t>=s.lt)&&!(n(s.gt)&&t<=s.gt))}}),Ext.define("Ext.ux.grid.filter.StringFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.string",iconCls:"ux-gridfilter-text-icon",emptyText:"Enter Filter Text...",selectOnFocus:!0,width:125,init:function(e){Ext.applyIf(e,{enableKeyEvents:!0,labelCls:"ux-rangemenu-icon "+this.iconCls,hideEmptyLabel:!1,labelSeparator:"",labelWidth:29,listeners:{scope:this,keyup:this.onInputKeyUp,el:{click:function(e){e.stopPropagation()}}}}),this.inputItem=Ext.create("Ext.form.field.Text",e),this.menu.add(this.inputItem),this.menu.add({xtype:"checkbox",name:"notLike",boxLabel:"Отсутствует",style:"color: white",listeners:{change:function(){this.updateTask.delay(1)},scope:this}}),this.menu.showSeparator=!1,this.updateTask=Ext.create("Ext.util.DelayedTask",this.fireUpdate,this)},getValue:function(){var e=this;return{value:e.inputItem.getValue(),notLike:e.menu.down("*[name=notLike]").getValue()}},setValue:function(e){this.inputItem.setValue(e),this.fireEvent("update",this)},isActivatable:function(){return this.inputItem.getValue().length>0},getSerialArgs:function(){return{type:"string",value:this.getValue()}},validateRecord:function(e){var t=e.get(this.dataIndex);return"string"!=typeof t?0===this.getValue().length:t.toLowerCase().indexOf(this.getValue().toLowerCase())>-1},onInputKeyUp:function(e,t){var s=t.getKey();if(s==t.RETURN&&e.isValid())return t.stopEvent(),void this.updateTask.delay(1)}}),Ext.define("Ext.ux.grid.menu.ListMenu",{extend:"Ext.menu.Menu",idField:"id",labelField:"text",loadingText:"Loading...",loadOnShow:!0,single:!1,plain:!0,constructor:function(e){var t,s,n,r,i=this;if(i.selected=[],i.addEvents("checkchange"),i.callParent(arguments),i.store||i.options||(i.options=i.grid.store.collect(i.dataIndex,!1,!0)),!i.store&&i.options){for(t=[],s=0,n=i.options.length;s<n;s++)switch(r=i.options[s],Ext.type(r)){case"array":t.push(r);break;case"object":t.push([r[i.idField],r[i.labelField]]);break;default:null!=r&&t.push([r,r])}i.store=Ext.create("Ext.data.ArrayStore",{fields:[i.idField,i.labelField],data:t,listeners:{load:i.onLoad,scope:i}}),i.loaded=!0,i.autoStore=!0}else i.add({text:i.loadingText,iconCls:"loading-indicator"}),i.store.on("load",i.onLoad,i)},destroy:function(){var e=this,t=e.store;t&&(e.autoStore?t.destroyStore():t.un("unload",e.onLoad,e)),e.callParent()},show:function(){var e=this;!e.loadOnShow||e.loaded||e.store.loading||e.store.load(),e.callParent()},onLoad:function(e,t){var s,n,r,i,a=this,o={checkchange:a.checkChange,scope:a};for(Ext.suspendLayouts(),a.removeAll(!0),s=a.single?Ext.id():null,r=0,i=t.length;r<i;r++)n=t[r].get(a.idField),a.add(Ext.create("Ext.menu.CheckItem",{text:t[r].get(a.labelField),group:s,checked:Ext.Array.contains(a.selected,n),hideOnClick:!1,value:n,listeners:o}));a.loaded=!0,Ext.resumeLayouts(!0),a.fireEvent("load",a,t)},getSelected:function(){return this.selected},setSelected:function(e){e=this.selected=[].concat(e),this.loaded&&this.items.each(function(t){t.setChecked(!1,!0);for(var s=0,n=e.length;s<n;s++)t.value==e[s]&&t.setChecked(!0,!0)})},checkChange:function(e,t){var s=[];this.items.each(function(e){e.checked&&s.push(e.value)}),this.selected=s,this.fireEvent("checkchange",e,t)}}),Ext.define("Ext.ux.grid.menu.RangeMenu",{extend:"Ext.menu.Menu",fieldCls:"Ext.form.field.Number",itemIconCls:{gte:"ux-rangemenu-gt",gt:"ux-rangemenu-gt",lte:"ux-rangemenu-lt",lt:"ux-rangemenu-lt",neq:"gi_search",eq:"ux-rangemenu-eq"},itemName:{lte:"Меньше или равно",lt:"Меньше",gte:"Больше или равно",gt:"Больше",neq:"Не равно",eq:"Равно"},fieldLabels:{gt:"Greater Than",lt:"Less Than",eq:"Equal To"},menuItemCfgs:{emptyText:"Enter Number...",selectOnFocus:!1,width:155},menuItems:["lte","lt","gte","gt","-","neq","eq"],plain:!0,constructor:function(e){var t,s,n,r,i,a,o,l=this;for(l.callParent(arguments),t=l.fields=l.fields||{},s=l.fieldCfg=l.fieldCfg||{},l.addEvents("update"),l.updateTask=Ext.create("Ext.util.DelayedTask",l.fireUpdate,l),n=0,r=l.menuItems.length;n<r;n++)i=l.menuItems[n],"-"!==i&&(a={itemId:"range-"+i,enableKeyEvents:!0,hideEmptyLabel:!1,fieldLabel:l.itemName[i],labelStyle:"color: white",labelSeparator:"",labelWidth:49,listeners:{scope:l,change:l.onInputChange,keyup:l.onInputKeyUp,el:{click:this.stopFn}},activate:Ext.emptyFn,deactivate:Ext.emptyFn},Ext.apply(a,Ext.applyIf(t[i]||{},s[i]),l.menuItemCfgs),o=a.fieldCls||l.fieldCls,i=t[i]=Ext.create(o,a)),l.add(i)},stopFn:function(e){e.stopPropagation()},fireUpdate:function(){this.fireEvent("update",this)},getValue:function(){var e,t,s={},n=this.fields;for(e in n)n.hasOwnProperty(e)&&(t=n[e],t.isValid()&&null!==t.getValue()&&(s[e]=t.getValue()));return s},setValue:function(e){var t,s,n=this,r=n.fields;for(t in r)r.hasOwnProperty(t)&&(s=r[t],s.suspendEvents(),s.setValue(t in e?e[t]:""),s.resumeEvents());n.fireEvent("update",n)},onInputKeyUp:function(e,t){t.getKey()===t.RETURN&&e.isValid()&&(t.stopEvent(),this.updateTask.delay(1))},onInputChange:function(e){var t=this,s=t.fields,n=s.neq,r=s.eq,i=s.gte,a=s.gt,o=s.lte,l=s.lt;e==r||e==n?(i&&i.setValue(null),a&&a.setValue(null),o&&o.setValue(null),l&&l.setValue(null)):(n.setValue(null),r.setValue(null))}});