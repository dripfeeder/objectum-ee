function hex_sha1(e){return binb2hex(core_sha1(str2binb(e),e.length*chrsz))}function b64_sha1(e){return binb2b64(core_sha1(str2binb(e),e.length*chrsz))}function str_sha1(e){return binb2str(core_sha1(str2binb(e),e.length*chrsz))}function hex_hmac_sha1(e,t){return binb2hex(core_hmac_sha1(e,t))}function b64_hmac_sha1(e,t){return binb2b64(core_hmac_sha1(e,t))}function str_hmac_sha1(e,t){return binb2str(core_hmac_sha1(e,t))}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc")}function core_sha1(e,t){e[t>>5]|=128<<24-t%32,e[(t+64>>9<<4)+15]=t;for(var n=Array(80),r=1732584193,s=-271733879,i=-1732584194,o=271733878,a=-1009589776,l=0;l<e.length;l+=16){for(var c=r,d=s,u=i,f=o,g=a,m=0;m<80;m++){m<16?n[m]=e[l+m]:n[m]=rol(n[m-3]^n[m-8]^n[m-14]^n[m-16],1);var p=safe_add(safe_add(rol(r,5),sha1_ft(m,s,i,o)),safe_add(safe_add(a,n[m]),sha1_kt(m)));a=o,o=i,i=rol(s,30),s=r,r=p}r=safe_add(r,c),s=safe_add(s,d),i=safe_add(i,u),o=safe_add(o,f),a=safe_add(a,g)}return Array(r,s,i,o,a)}function sha1_ft(e,t,n,r){return e<20?t&n|~t&r:e<40?t^n^r:e<60?t&n|t&r|n&r:t^n^r}function sha1_kt(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function core_hmac_sha1(e,t){var n=str2binb(e);n.length>16&&(n=core_sha1(n,e.length*chrsz));for(var r=Array(16),s=Array(16),i=0;i<16;i++)r[i]=909522486^n[i],s[i]=1549556828^n[i];var o=core_sha1(r.concat(str2binb(t)),512+t.length*chrsz);return core_sha1(s.concat(o),672)}function safe_add(e,t){var n=(65535&e)+(65535&t),r=(e>>16)+(t>>16)+(n>>16);return r<<16|65535&n}function rol(e,t){return e<<t|e>>>32-t}function str2binb(e){for(var t=Array(),n=(1<<chrsz)-1,r=0;r<e.length*chrsz;r+=chrsz)t[r>>5]|=(e.charCodeAt(r/chrsz)&n)<<32-chrsz-r%32;return t}function binb2str(e){for(var t="",n=(1<<chrsz)-1,r=0;r<32*e.length;r+=chrsz)t+=String.fromCharCode(e[r>>5]>>>32-chrsz-r%32&n);return t}function binb2hex(e){for(var t=hexcase?"0123456789ABCDEF":"0123456789abcdef",n="",r=0;r<4*e.length;r++)n+=t.charAt(e[r>>2]>>8*(3-r%4)+4&15)+t.charAt(e[r>>2]>>8*(3-r%4)&15);return n}function binb2b64(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n="",r=0;r<4*e.length;r+=3)for(var s=(e[r>>2]>>8*(3-r%4)&255)<<16|(e[r+1>>2]>>8*(3-(r+1)%4)&255)<<8|e[r+2>>2]>>8*(3-(r+2)%4)&255,i=0;i<4;i++)n+=8*r+6*i>32*e.length?b64pad:t.charAt(s>>6*(3-i)&63);return n}!function(){function e(e){var n=!1;return function(){if(n)throw new Error("Callback was already called.");n=!0,e.apply(t,arguments)}}var t,n,r={};t=this,null!=t&&(n=t.async),r.noConflict=function(){return t.async=n,r};var s=function(e,t){if(e.forEach)return e.forEach(t);for(var n=0;n<e.length;n+=1)t(e[n],n,e)},i=function(e,t){if(e.map)return e.map(t);var n=[];return s(e,function(e,r,s){n.push(t(e,r,s))}),n},o=function(e,t,n){return e.reduce?e.reduce(t,n):(s(e,function(e,r,s){n=t(n,e,r,s)}),n)},a=function(e){if(Object.keys)return Object.keys(e);var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t};"undefined"!=typeof process&&process.nextTick?(r.nextTick=process.nextTick,"undefined"!=typeof setImmediate?r.setImmediate=setImmediate:r.setImmediate=r.nextTick):"function"==typeof setImmediate?(r.setImmediate=setImmediate,r.nextTick=setImmediate):(r.setImmediate=r.nextTick,r.nextTick=function(e){setTimeout(e,0)}),r.each=function(t,n,r){if(r=r||function(){},!t.length)return r();var i=0;s(t,function(s){n(s,e(function(e){e?(r(e),r=function(){}):(i+=1,i>=t.length&&r(null))}))})},r.forEach=r.each,r.eachSeries=function(e,t,n){if(n=n||function(){},!e.length)return n();var r=0,s=function(){t(e[r],function(t){t?(n(t),n=function(){}):(r+=1,r>=e.length?n(null):s())})};s()},r.forEachSeries=r.eachSeries,r.eachLimit=function(e,t,n,r){var s=l(t);s.apply(null,[e,n,r])},r.forEachLimit=r.eachLimit;var l=function(e){return function(t,n,r){if(r=r||function(){},!t.length||e<=0)return r();var s=0,i=0,o=0;!function a(){if(s>=t.length)return r();for(;o<e&&i<t.length;)i+=1,o+=1,n(t[i-1],function(e){e?(r(e),r=function(){}):(s+=1,o-=1,s>=t.length?r():a())})}()}},c=function(e){return function(){var t=Array.prototype.slice.call(arguments);return e.apply(null,[r.each].concat(t))}},d=function(e,t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[l(e)].concat(n))}},u=function(e){return function(){var t=Array.prototype.slice.call(arguments);return e.apply(null,[r.eachSeries].concat(t))}},f=function(e,t,n,r){var s=[];t=i(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n,r){s[e.index]=r,t(n)})},function(e){r(e,s)})};r.map=c(f),r.mapSeries=u(f),r.mapLimit=function(e,t,n,r){return g(t)(e,n,r)};var g=function(e){return d(e,f)};r.reduce=function(e,t,n,s){r.eachSeries(e,function(e,r){n(t,e,function(e,n){t=n,r(e)})},function(e){s(e,t)})},r.inject=r.reduce,r.foldl=r.reduce,r.reduceRight=function(e,t,n,s){var o=i(e,function(e){return e}).reverse();r.reduce(o,t,n,s)},r.foldr=r.reduceRight;var m=function(e,t,n,r){var s=[];t=i(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n&&s.push(e),t()})},function(e){r(i(s.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};r.filter=c(m),r.filterSeries=u(m),r.select=r.filter,r.selectSeries=r.filterSeries;var p=function(e,t,n,r){var s=[];t=i(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n||s.push(e),t()})},function(e){r(i(s.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};r.reject=c(p),r.rejectSeries=u(p);var h=function(e,t,n,r){e(t,function(e,t){n(e,function(n){n?(r(e),r=function(){}):t()})},function(e){r()})};r.detect=c(h),r.detectSeries=u(h),r.some=function(e,t,n){r.each(e,function(e,r){t(e,function(e){e&&(n(!0),n=function(){}),r()})},function(e){n(!1)})},r.any=r.some,r.every=function(e,t,n){r.each(e,function(e,r){t(e,function(e){e||(n(!1),n=function(){}),r()})},function(e){n(!0)})},r.all=r.every,r.sortBy=function(e,t,n){r.map(e,function(e,n){t(e,function(t,r){t?n(t):n(null,{value:e,criteria:r})})},function(e,t){if(e)return n(e);var r=function(e,t){var n=e.criteria,r=t.criteria;return n<r?-1:n>r?1:0};n(null,i(t.sort(r),function(e){return e.value}))})},r.auto=function(e,t){t=t||function(){};var n=a(e);if(!n.length)return t(null);var i={},l=[],c=function(e){l.unshift(e)},d=function(e){for(var t=0;t<l.length;t+=1)if(l[t]===e)return void l.splice(t,1)},u=function(){s(l.slice(0),function(e){e()})};c(function(){a(i).length===n.length&&(t(null,i),t=function(){})}),s(n,function(n){var l=e[n]instanceof Function?[e[n]]:e[n],f=function(e){var o=Array.prototype.slice.call(arguments,1);if(o.length<=1&&(o=o[0]),e){var l={};s(a(i),function(e){l[e]=i[e]}),l[n]=o,t(e,l),t=function(){}}else i[n]=o,r.setImmediate(u)},g=l.slice(0,Math.abs(l.length-1))||[],m=function(){return o(g,function(e,t){return e&&i.hasOwnProperty(t)},!0)&&!i.hasOwnProperty(n)};if(m())l[l.length-1](f,i);else{var p=function(){m()&&(d(p),l[l.length-1](f,i))};c(p)}})},r.waterfall=function(e,t){if(t=t||function(){},e.constructor!==Array){var n=new Error("First argument to waterfall must be an array of functions");return t(n)}if(!e.length)return t();var s=function(e){return function(n){if(n)t.apply(null,arguments),t=function(){};else{var i=Array.prototype.slice.call(arguments,1),o=e.next();o?i.push(s(o)):i.push(t),r.setImmediate(function(){e.apply(null,i)})}}};s(r.iterator(e))()};var v=function(e,t,n){if(n=n||function(){},t.constructor===Array)e.map(t,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),t.call(null,e,n)})},n);else{var r={};e.each(a(t),function(e,n){t[e](function(t){var s=Array.prototype.slice.call(arguments,1);s.length<=1&&(s=s[0]),r[e]=s,n(t)})},function(e){n(e,r)})}};r.parallel=function(e,t){v({map:r.map,each:r.each},e,t)},r.parallelLimit=function(e,t,n){v({map:g(t),each:l(t)},e,n)},r.series=function(e,t){if(t=t||function(){},e.constructor===Array)r.mapSeries(e,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),t.call(null,e,n)})},t);else{var n={};r.eachSeries(a(e),function(t,r){e[t](function(e){var s=Array.prototype.slice.call(arguments,1);s.length<=1&&(s=s[0]),n[t]=s,r(e)})},function(e){t(e,n)})}},r.iterator=function(e){var t=function(n){var r=function(){return e.length&&e[n].apply(null,arguments),r.next()};return r.next=function(){return n<e.length-1?t(n+1):null},r};return t(0)},r.apply=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t.concat(Array.prototype.slice.call(arguments)))}};var b=function(e,t,n,r){var s=[];e(t,function(e,t){n(e,function(e,n){s=s.concat(n||[]),t(e)})},function(e){r(e,s)})};r.concat=c(b),r.concatSeries=u(b),r.whilst=function(e,t,n){e()?t(function(s){return s?n(s):void r.whilst(e,t,n)}):n()},r.doWhilst=function(e,t,n){e(function(s){return s?n(s):void(t()?r.doWhilst(e,t,n):n())})},r.until=function(e,t,n){e()?n():t(function(s){return s?n(s):void r.until(e,t,n)})},r.doUntil=function(e,t,n){e(function(s){return s?n(s):void(t()?n():r.doUntil(e,t,n))})},r.queue=function(t,n){function i(e,t,i,o){t.constructor!==Array&&(t=[t]),s(t,function(t){var s={data:t,callback:"function"==typeof o?o:null};i?e.tasks.unshift(s):e.tasks.push(s),e.saturated&&e.tasks.length===n&&e.saturated(),r.setImmediate(e.process)})}void 0===n&&(n=1);var o=0,a={tasks:[],concurrency:n,saturated:null,empty:null,drain:null,push:function(e,t){i(a,e,!1,t)},unshift:function(e,t){i(a,e,!0,t)},process:function(){if(o<a.concurrency&&a.tasks.length){var n=a.tasks.shift();a.empty&&0===a.tasks.length&&a.empty(),o+=1;var r=function(){o-=1,n.callback&&n.callback.apply(n,arguments),a.drain&&a.tasks.length+o===0&&a.drain(),a.process()},s=e(r);t(n.data,s)}},length:function(){return a.tasks.length},running:function(){return o}};return a},r.cargo=function(e,t){var n=!1,o=[],a={tasks:o,payload:t,saturated:null,empty:null,drain:null,push:function(e,n){e.constructor!==Array&&(e=[e]),s(e,function(e){o.push({data:e,callback:"function"==typeof n?n:null}),a.saturated&&o.length===t&&a.saturated()}),r.setImmediate(a.process)},process:function r(){if(!n){if(0===o.length)return void(a.drain&&a.drain());var l="number"==typeof t?o.splice(0,t):o.splice(0),c=i(l,function(e){return e.data});a.empty&&a.empty(),n=!0,e(c,function(){n=!1;var e=arguments;s(l,function(t){t.callback&&t.callback.apply(null,e)}),r()})}},length:function(){return o.length},running:function(){return n}};return a};var y=function(e){return function(t){var n=Array.prototype.slice.call(arguments,1);t.apply(null,n.concat([function(t){var n=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(t?console.error&&console.error(t):console[e]&&s(n,function(t){console[e](t)}))}]))}};r.log=y("log"),r.dir=y("dir"),r.memoize=function(e,t){var n={},r={};t=t||function(e){return e};var s=function(){var s=Array.prototype.slice.call(arguments),i=s.pop(),o=t.apply(null,s);o in n?i.apply(null,n[o]):o in r?r[o].push(i):(r[o]=[i],e.apply(null,s.concat([function(){n[o]=arguments;var e=r[o];delete r[o];for(var t=0,s=e.length;t<s;t++)e[t].apply(null,arguments)}])))};return s.memo=n,s.unmemoized=e,s},r.unmemoize=function(e){return function(){return(e.unmemoized||e).apply(null,arguments)}},r.times=function(e,t,n){for(var s=[],i=0;i<e;i++)s.push(i);return r.map(s,t,n)},r.timesSeries=function(e,t,n){for(var s=[],i=0;i<e;i++)s.push(i);return r.mapSeries(s,t,n)},r.compose=function(){var e=Array.prototype.reverse.call(arguments);return function(){var t=this,n=Array.prototype.slice.call(arguments),s=n.pop();r.reduce(e,n,function(e,n,r){n.apply(t,e.concat([function(){var e=arguments[0],t=Array.prototype.slice.call(arguments,1);r(e,t)}]))},function(e,n){s.apply(t,[e].concat(n))})}};var w=function(e,t){var n=function(){var n=this,r=Array.prototype.slice.call(arguments),s=r.pop();return e(t,function(e,t){e.apply(n,r.concat([t]))},s)};if(arguments.length>2){var r=Array.prototype.slice.call(arguments,2);return n.apply(this,r)}return n};r.applyEach=c(w),r.applyEachSeries=u(w),r.forever=function(e,t){function n(r){if(r){if(t)return t(r);throw r}e(n)}n()},"undefined"!=typeof define&&define.amd?define([],function(){return r}):"undefined"!=typeof module&&module.exports?module.exports=r:t.async=r}();var hexcase=1,b64pad="",chrsz=8;if(function(){function e(e){function t(t,n,r,s,i,o){for(;i>=0&&i<o;i+=e){var a=s?s[i]:i;r=n(r,t[a],a,t)}return r}return function(n,r,s,i){r=b(r,i,4);var o=!$(n)&&v.keys(n),a=(o||n).length,l=e>0?0:a-1;return arguments.length<3&&(s=n[o?o[l]:l],l+=e),t(n,r,s,o,l,a)}}function t(e){return function(t,n,r){n=y(n,r);for(var s=null!=t&&t.length,i=e>0?0:s-1;i>=0&&i<s;i+=e)if(n(t[i],i,t))return i;return-1}}function n(e,t){var n=A.length,r=e.constructor,s=v.isFunction(r)&&r.prototype||o,i="constructor";for(v.has(e,i)&&!v.contains(t,i)&&t.push(i);n--;)i=A[n],i in e&&e[i]!==s[i]&&!v.contains(t,i)&&t.push(i)}var r=this,s=r._,i=Array.prototype,o=Object.prototype,a=Function.prototype,l=i.push,c=i.slice,d=o.toString,u=o.hasOwnProperty,f=Array.isArray,g=Object.keys,m=a.bind,p=Object.create,h=function(){},v=function(e){return e instanceof v?e:this instanceof v?void(this._wrapped=e):new v(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=v),exports._=v):r._=v,v.VERSION="1.8.2";var b=function(e,t,n){if(void 0===t)return e;switch(null==n?3:n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,s){return e.call(t,n,r,s)};case 4:return function(n,r,s,i){return e.call(t,n,r,s,i)}}return function(){return e.apply(t,arguments)}},y=function(e,t,n){return null==e?v.identity:v.isFunction(e)?b(e,t,n):v.isObject(e)?v.matcher(e):v.property(e)};v.iteratee=function(e,t){return y(e,t,1/0)};var w=function(e,t){return function(n){var r=arguments.length;if(r<2||null==n)return n;for(var s=1;s<r;s++)for(var i=arguments[s],o=e(i),a=o.length,l=0;l<a;l++){var c=o[l];t&&void 0!==n[c]||(n[c]=i[c])}return n}},x=function(e){if(!v.isObject(e))return{};if(p)return p(e);h.prototype=e;var t=new h;return h.prototype=null,t},_=Math.pow(2,53)-1,$=function(e){var t=e&&e.length;return"number"==typeof t&&t>=0&&t<=_};v.each=v.forEach=function(e,t,n){t=b(t,n);var r,s;if($(e))for(r=0,s=e.length;r<s;r++)t(e[r],r,e);else{var i=v.keys(e);for(r=0,s=i.length;r<s;r++)t(e[i[r]],i[r],e)}return e},v.map=v.collect=function(e,t,n){t=y(t,n);for(var r=!$(e)&&v.keys(e),s=(r||e).length,i=Array(s),o=0;o<s;o++){var a=r?r[o]:o;i[o]=t(e[a],a,e)}return i},v.reduce=v.foldl=v.inject=e(1),v.reduceRight=v.foldr=e(-1),v.find=v.detect=function(e,t,n){var r;if(r=$(e)?v.findIndex(e,t,n):v.findKey(e,t,n),void 0!==r&&r!==-1)return e[r]},v.filter=v.select=function(e,t,n){var r=[];return t=y(t,n),v.each(e,function(e,n,s){t(e,n,s)&&r.push(e)}),r},v.reject=function(e,t,n){return v.filter(e,v.negate(y(t)),n)},v.every=v.all=function(e,t,n){t=y(t,n);for(var r=!$(e)&&v.keys(e),s=(r||e).length,i=0;i<s;i++){var o=r?r[i]:i;if(!t(e[o],o,e))return!1}return!0},v.some=v.any=function(e,t,n){t=y(t,n);for(var r=!$(e)&&v.keys(e),s=(r||e).length,i=0;i<s;i++){var o=r?r[i]:i;if(t(e[o],o,e))return!0}return!1},v.contains=v.includes=v.include=function(e,t,n){return $(e)||(e=v.values(e)),v.indexOf(e,t,"number"==typeof n&&n)>=0},v.invoke=function(e,t){var n=c.call(arguments,2),r=v.isFunction(t);return v.map(e,function(e){var s=r?t:e[t];return null==s?s:s.apply(e,n)})},v.pluck=function(e,t){return v.map(e,v.property(t))},v.where=function(e,t){return v.filter(e,v.matcher(t))},v.findWhere=function(e,t){return v.find(e,v.matcher(t))},v.max=function(e,t,n){var r,s,i=-(1/0),o=-(1/0);if(null==t&&null!=e){e=$(e)?e:v.values(e);for(var a=0,l=e.length;a<l;a++)r=e[a],r>i&&(i=r)}else t=y(t,n),v.each(e,function(e,n,r){s=t(e,n,r),(s>o||s===-(1/0)&&i===-(1/0))&&(i=e,o=s)});return i},v.min=function(e,t,n){var r,s,i=1/0,o=1/0;if(null==t&&null!=e){e=$(e)?e:v.values(e);for(var a=0,l=e.length;a<l;a++)r=e[a],r<i&&(i=r)}else t=y(t,n),v.each(e,function(e,n,r){s=t(e,n,r),(s<o||s===1/0&&i===1/0)&&(i=e,o=s)});return i},v.shuffle=function(e){for(var t,n=$(e)?e:v.values(e),r=n.length,s=Array(r),i=0;i<r;i++)t=v.random(0,i),t!==i&&(s[i]=s[t]),s[t]=n[i];return s},v.sample=function(e,t,n){return null==t||n?($(e)||(e=v.values(e)),e[v.random(e.length-1)]):v.shuffle(e).slice(0,Math.max(0,t))},v.sortBy=function(e,t,n){return t=y(t,n),v.pluck(v.map(e,function(e,n,r){return{value:e,index:n,criteria:t(e,n,r)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;if(n!==r){if(n>r||void 0===n)return 1;if(n<r||void 0===r)return-1}return e.index-t.index}),"value")};var C=function(e){return function(t,n,r){var s={};return n=y(n,r),v.each(t,function(r,i){var o=n(r,i,t);e(s,r,o)}),s}};v.groupBy=C(function(e,t,n){v.has(e,n)?e[n].push(t):e[n]=[t]}),v.indexBy=C(function(e,t,n){e[n]=t}),v.countBy=C(function(e,t,n){v.has(e,n)?e[n]++:e[n]=1}),v.toArray=function(e){return e?v.isArray(e)?c.call(e):$(e)?v.map(e,v.identity):v.values(e):[]},v.size=function(e){return null==e?0:$(e)?e.length:v.keys(e).length},v.partition=function(e,t,n){t=y(t,n);var r=[],s=[];return v.each(e,function(e,n,i){(t(e,n,i)?r:s).push(e)}),[r,s]},v.first=v.head=v.take=function(e,t,n){if(null!=e)return null==t||n?e[0]:v.initial(e,e.length-t)},v.initial=function(e,t,n){return c.call(e,0,Math.max(0,e.length-(null==t||n?1:t)))},v.last=function(e,t,n){if(null!=e)return null==t||n?e[e.length-1]:v.rest(e,Math.max(0,e.length-t))},v.rest=v.tail=v.drop=function(e,t,n){return c.call(e,null==t||n?1:t)},v.compact=function(e){return v.filter(e,v.identity)};var S=function(e,t,n,r){for(var s=[],i=0,o=r||0,a=e&&e.length;o<a;o++){var l=e[o];if($(l)&&(v.isArray(l)||v.isArguments(l))){t||(l=S(l,t,n));var c=0,d=l.length;for(s.length+=d;c<d;)s[i++]=l[c++]}else n||(s[i++]=l)}return s};v.flatten=function(e,t){return S(e,t,!1)},v.without=function(e){return v.difference(e,c.call(arguments,1))},v.uniq=v.unique=function(e,t,n,r){if(null==e)return[];v.isBoolean(t)||(r=n,n=t,t=!1),null!=n&&(n=y(n,r));for(var s=[],i=[],o=0,a=e.length;o<a;o++){var l=e[o],c=n?n(l,o,e):l;t?(o&&i===c||s.push(l),i=c):n?v.contains(i,c)||(i.push(c),s.push(l)):v.contains(s,l)||s.push(l)}return s},v.union=function(){return v.uniq(S(arguments,!0,!0))},v.intersection=function(e){if(null==e)return[];for(var t=[],n=arguments.length,r=0,s=e.length;r<s;r++){var i=e[r];if(!v.contains(t,i)){for(var o=1;o<n&&v.contains(arguments[o],i);o++);o===n&&t.push(i)}}return t},v.difference=function(e){var t=S(arguments,!0,!0,1);return v.filter(e,function(e){return!v.contains(t,e)})},v.zip=function(){return v.unzip(arguments)},v.unzip=function(e){for(var t=e&&v.max(e,"length").length||0,n=Array(t),r=0;r<t;r++)n[r]=v.pluck(e,r);return n},v.object=function(e,t){for(var n={},r=0,s=e&&e.length;r<s;r++)t?n[e[r]]=t[r]:n[e[r][0]]=e[r][1];return n},v.indexOf=function(e,t,n){var r=0,s=e&&e.length;if("number"==typeof n)r=n<0?Math.max(0,s+n):n;else if(n&&s)return r=v.sortedIndex(e,t),e[r]===t?r:-1;if(t!==t)return v.findIndex(c.call(e,r),v.isNaN);for(;r<s;r++)if(e[r]===t)return r;return-1},v.lastIndexOf=function(e,t,n){var r=e?e.length:0;if("number"==typeof n&&(r=n<0?r+n+1:Math.min(r,n+1)),t!==t)return v.findLastIndex(c.call(e,0,r),v.isNaN);for(;--r>=0;)if(e[r]===t)return r;return-1},v.findIndex=t(1),v.findLastIndex=t(-1),v.sortedIndex=function(e,t,n,r){n=y(n,r,1);for(var s=n(t),i=0,o=e.length;i<o;){var a=Math.floor((i+o)/2);n(e[a])<s?i=a+1:o=a}return i},v.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0),n=n||1;for(var r=Math.max(Math.ceil((t-e)/n),0),s=Array(r),i=0;i<r;i++,e+=n)s[i]=e;return s};var j=function(e,t,n,r,s){if(!(r instanceof t))return e.apply(n,s);var i=x(e.prototype),o=e.apply(i,s);return v.isObject(o)?o:i};v.bind=function(e,t){if(m&&e.bind===m)return m.apply(e,c.call(arguments,1));if(!v.isFunction(e))throw new TypeError("Bind must be called on a function");var n=c.call(arguments,2),r=function(){return j(e,r,t,this,n.concat(c.call(arguments)))};return r},v.partial=function(e){var t=c.call(arguments,1),n=function(){for(var r=0,s=t.length,i=Array(s),o=0;o<s;o++)i[o]=t[o]===v?arguments[r++]:t[o];for(;r<arguments.length;)i.push(arguments[r++]);return j(e,n,this,this,i)};return n},v.bindAll=function(e){var t,n,r=arguments.length;if(r<=1)throw new Error("bindAll must be passed function names");for(t=1;t<r;t++)n=arguments[t],e[n]=v.bind(e[n],e);return e},v.memoize=function(e,t){var n=function(r){var s=n.cache,i=""+(t?t.apply(this,arguments):r);return v.has(s,i)||(s[i]=e.apply(this,arguments)),s[i]};return n.cache={},n},v.delay=function(e,t){var n=c.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},v.defer=v.partial(v.delay,v,1),v.throttle=function(e,t,n){var r,s,i,o=null,a=0;n||(n={});var l=function(){a=n.leading===!1?0:v.now(),o=null,i=e.apply(r,s),o||(r=s=null)};return function(){var c=v.now();a||n.leading!==!1||(a=c);var d=t-(c-a);return r=this,s=arguments,d<=0||d>t?(o&&(clearTimeout(o),o=null),a=c,i=e.apply(r,s),o||(r=s=null)):o||n.trailing===!1||(o=setTimeout(l,d)),i}},v.debounce=function(e,t,n){var r,s,i,o,a,l=function(){var c=v.now()-o;c<t&&c>=0?r=setTimeout(l,t-c):(r=null,n||(a=e.apply(i,s),r||(i=s=null)))};return function(){i=this,s=arguments,o=v.now();var c=n&&!r;return r||(r=setTimeout(l,t)),c&&(a=e.apply(i,s),i=s=null),a}},v.wrap=function(e,t){return v.partial(t,e)},v.negate=function(e){return function(){return!e.apply(this,arguments)}},v.compose=function(){var e=arguments,t=e.length-1;return function(){for(var n=t,r=e[t].apply(this,arguments);n--;)r=e[n].call(this,r);return r}},v.after=function(e,t){return function(){if(--e<1)return t.apply(this,arguments)}},v.before=function(e,t){var n;return function(){return--e>0&&(n=t.apply(this,arguments)),e<=1&&(t=null),n}},v.once=v.partial(v.before,2);var E=!{toString:null}.propertyIsEnumerable("toString"),A=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];v.keys=function(e){if(!v.isObject(e))return[];if(g)return g(e);var t=[];for(var r in e)v.has(e,r)&&t.push(r);return E&&n(e,t),t},v.allKeys=function(e){if(!v.isObject(e))return[];var t=[];for(var r in e)t.push(r);return E&&n(e,t),t},v.values=function(e){for(var t=v.keys(e),n=t.length,r=Array(n),s=0;s<n;s++)r[s]=e[t[s]];return r},v.mapObject=function(e,t,n){t=y(t,n);for(var r,s=v.keys(e),i=s.length,o={},a=0;a<i;a++)r=s[a],o[r]=t(e[r],r,e);return o},v.pairs=function(e){for(var t=v.keys(e),n=t.length,r=Array(n),s=0;s<n;s++)r[s]=[t[s],e[t[s]]];return r},v.invert=function(e){for(var t={},n=v.keys(e),r=0,s=n.length;r<s;r++)t[e[n[r]]]=n[r];return t},v.functions=v.methods=function(e){var t=[];for(var n in e)v.isFunction(e[n])&&t.push(n);return t.sort()},v.extend=w(v.allKeys),v.extendOwn=v.assign=w(v.keys),v.findKey=function(e,t,n){t=y(t,n);for(var r,s=v.keys(e),i=0,o=s.length;i<o;i++)if(r=s[i],t(e[r],r,e))return r},v.pick=function(e,t,n){var r,s,i={},o=e;if(null==o)return i;v.isFunction(t)?(s=v.allKeys(o),r=b(t,n)):(s=S(arguments,!1,!1,1),r=function(e,t,n){return t in n},o=Object(o));for(var a=0,l=s.length;a<l;a++){var c=s[a],d=o[c];r(d,c,o)&&(i[c]=d)}return i},v.omit=function(e,t,n){if(v.isFunction(t))t=v.negate(t);else{var r=v.map(S(arguments,!1,!1,1),String);t=function(e,t){return!v.contains(r,t)}}return v.pick(e,t,n)},v.defaults=w(v.allKeys,!0),v.clone=function(e){return v.isObject(e)?v.isArray(e)?e.slice():v.extend({},e):e},v.tap=function(e,t){return t(e),e},v.isMatch=function(e,t){var n=v.keys(t),r=n.length;if(null==e)return!r;for(var s=Object(e),i=0;i<r;i++){var o=n[i];if(t[o]!==s[o]||!(o in s))return!1}return!0};var I=function(e,t,n,r){if(e===t)return 0!==e||1/e===1/t;if(null==e||null==t)return e===t;e instanceof v&&(e=e._wrapped),t instanceof v&&(t=t._wrapped);var s=d.call(e);if(s!==d.call(t))return!1;switch(s){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!==+e?+t!==+t:0===+e?1/+e===1/t:+e===+t;case"[object Date]":case"[object Boolean]":return+e===+t}var i="[object Array]"===s;if(!i){if("object"!=typeof e||"object"!=typeof t)return!1;var o=e.constructor,a=t.constructor;if(o!==a&&!(v.isFunction(o)&&o instanceof o&&v.isFunction(a)&&a instanceof a)&&"constructor"in e&&"constructor"in t)return!1}n=n||[],r=r||[];for(var l=n.length;l--;)if(n[l]===e)return r[l]===t;if(n.push(e),r.push(t),i){if(l=e.length,l!==t.length)return!1;for(;l--;)if(!I(e[l],t[l],n,r))return!1}else{var c,u=v.keys(e);if(l=u.length,v.keys(t).length!==l)return!1;for(;l--;)if(c=u[l],!v.has(t,c)||!I(e[c],t[c],n,r))return!1}return n.pop(),r.pop(),!0};v.isEqual=function(e,t){return I(e,t)},v.isEmpty=function(e){return null==e||($(e)&&(v.isArray(e)||v.isString(e)||v.isArguments(e))?0===e.length:0===v.keys(e).length)},v.isElement=function(e){return!(!e||1!==e.nodeType)},v.isArray=f||function(e){return"[object Array]"===d.call(e)},v.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},v.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(e){v["is"+e]=function(t){return d.call(t)==="[object "+e+"]"}}),v.isArguments(arguments)||(v.isArguments=function(e){return v.has(e,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(v.isFunction=function(e){return"function"==typeof e||!1}),v.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},v.isNaN=function(e){return v.isNumber(e)&&e!==+e},v.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"===d.call(e)},v.isNull=function(e){return null===e},v.isUndefined=function(e){return void 0===e},v.has=function(e,t){return null!=e&&u.call(e,t)},v.noConflict=function(){return r._=s,this},v.identity=function(e){return e},v.constant=function(e){return function(){return e}},v.noop=function(){},v.property=function(e){return function(t){return null==t?void 0:t[e]}},v.propertyOf=function(e){return null==e?function(){}:function(t){return e[t]}},v.matcher=v.matches=function(e){return e=v.extendOwn({},e),function(t){return v.isMatch(t,e)}},v.times=function(e,t,n){var r=Array(Math.max(0,e));t=b(t,n,1);for(var s=0;s<e;s++)r[s]=t(s);return r},v.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))},v.now=Date.now||function(){return(new Date).getTime()};var q={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},T=v.invert(q),V=function(e){var t=function(t){return e[t]},n="(?:"+v.keys(e).join("|")+")",r=RegExp(n),s=RegExp(n,"g");return function(e){return e=null==e?"":""+e,r.test(e)?e.replace(s,t):e}};v.escape=V(q),v.unescape=V(T),v.result=function(e,t,n){var r=null==e?void 0:e[t];return void 0===r&&(r=n),v.isFunction(r)?r.call(e):r};var k=0;v.uniqueId=function(e){var t=++k+"";return e?e+t:t},v.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var O=/(.)^/,M={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},F=/\\|'|\r|\n|\u2028|\u2029/g,N=function(e){return"\\"+M[e]};v.template=function(e,t,n){!t&&n&&(t=n),t=v.defaults({},t,v.templateSettings);var r=RegExp([(t.escape||O).source,(t.interpolate||O).source,(t.evaluate||O).source].join("|")+"|$","g"),s=0,i="__p+='";e.replace(r,function(t,n,r,o,a){return i+=e.slice(s,a).replace(F,N),s=a+t.length,n?i+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'":r?i+="'+\n((__t=("+r+"))==null?'':__t)+\n'":o&&(i+="';\n"+o+"\n__p+='"),t}),i+="';\n",t.variable||(i="with(obj||{}){\n"+i+"}\n"),i="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+i+"return __p;\n";try{var o=new Function(t.variable||"obj","_",i)}catch(e){throw e.source=i,e}var a=function(e){return o.call(this,e,v)},l=t.variable||"obj";return a.source="function("+l+"){\n"+i+"}",a},v.chain=function(e){var t=v(e);return t._chain=!0,t};var L=function(e,t){return e._chain?v(t).chain():t};v.mixin=function(e){v.each(v.functions(e),function(t){var n=v[t]=e[t];v.prototype[t]=function(){var e=[this._wrapped];return l.apply(e,arguments),L(this,n.apply(v,e))}})},v.mixin(v),v.each(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=i[e];v.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),"shift"!==e&&"splice"!==e||0!==n.length||delete n[0],L(this,n)}}),v.each(["concat","join","slice"],function(e){var t=i[e];v.prototype[e]=function(){return L(this,t.apply(this._wrapped,arguments))}}),v.prototype.value=function(){return this._wrapped},v.prototype.valueOf=v.prototype.toJSON=v.prototype.value,v.prototype.toString=function(){return""+this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return v})}.call(this),function(e){var t="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;if("function"==typeof define&&define.amd)define(["underscore","jquery","exports"],function(n,r,s){t.Backbone=e(t,s,n,r)});else if("undefined"!=typeof exports){var n,r=require("underscore");try{n=require("jquery")}catch(e){}e(t,exports,r,n)}else t.Backbone=e(t,{},t._,t.jQuery||t.Zepto||t.ender||t.$)}(function(e,t,n,r){var s=e.Backbone,i=[].slice;t.VERSION="1.2.1",t.$=r,t.noConflict=function(){return e.Backbone=s,this},t.emulateHTTP=!1,t.emulateJSON=!1;var o=function(e,t,r){switch(e){case 1:return function(){return n[t](this[r])};case 2:return function(e){return n[t](this[r],e)};case 3:return function(e,s){return n[t](this[r],e,s)};case 4:return function(e,s,i){return n[t](this[r],e,s,i)};default:return function(){var e=i.call(arguments);return e.unshift(this[r]),n[t].apply(n,e)}}},a=function(e,t,r){n.each(t,function(t,s){n[s]&&(e.prototype[s]=o(t,s,r))})},l=t.Events={},c=/\s+/,d=function(e,t,r,s,i){var o,a=0;if(r&&"object"==typeof r){void 0!==s&&"context"in i&&void 0===i.context&&(i.context=s);for(o=n.keys(r);a<o.length;a++)t=e(t,o[a],r[o[a]],i)}else if(r&&c.test(r))for(o=r.split(c);a<o.length;a++)t=e(t,o[a],s,i);else t=e(t,r,s,i);return t};l.on=function(e,t,n){return u(this,e,t,n)};var u=function(e,t,n,r,s){if(e._events=d(f,e._events||{},t,n,{context:r,ctx:e,listening:s}),s){var i=e._listeners||(e._listeners={});i[s.id]=s}return e};l.listenTo=function(e,t,r){if(!e)return this;var s=e._listenId||(e._listenId=n.uniqueId("l")),i=this._listeningTo||(this._listeningTo={}),o=i[s];if(!o){var a=this._listenId||(this._listenId=n.uniqueId("l"));o=i[s]={obj:e,objId:s,id:a,listeningTo:i,count:0}}return u(e,t,r,this,o),this};var f=function(e,t,n,r){if(n){var s=e[t]||(e[t]=[]),i=r.context,o=r.ctx,a=r.listening;a&&a.count++,s.push({callback:n,context:i,ctx:i||o,listening:a})}return e};l.off=function(e,t,n){return this._events?(this._events=d(g,this._events,e,t,{context:n,listeners:this._listeners}),this):this},l.stopListening=function(e,t,r){var s=this._listeningTo;if(!s)return this;for(var i=e?[e._listenId]:n.keys(s),o=0;o<i.length;o++){var a=s[i[o]];if(!a)break;a.obj.off(t,r,this)}return n.isEmpty(s)&&(this._listeningTo=void 0),this};var g=function(e,t,r,s){if(e){var i,o=0,a=s.context,l=s.listeners;if(t||r||a){for(var c=t?[t]:n.keys(e);o<c.length;o++){t=c[o];var d=e[t];if(!d)break;for(var u=[],f=0;f<d.length;f++){var g=d[f];r&&r!==g.callback&&r!==g.callback._callback||a&&a!==g.context?u.push(g):(i=g.listening,i&&0===--i.count&&(delete l[i.id],delete i.listeningTo[i.objId]))}u.length?e[t]=u:delete e[t]}return n.size(e)?e:void 0}for(var m=n.keys(l);o<m.length;o++)i=l[m[o]],delete l[i.id],delete i.listeningTo[i.objId]}};l.once=function(e,t,r){var s=d(m,{},e,t,n.bind(this.off,this));return this.on(s,void 0,r)},l.listenToOnce=function(e,t,r){var s=d(m,{},t,r,n.bind(this.stopListening,this,e));return this.listenTo(e,s)};var m=function(e,t,r,s){if(r){var i=e[t]=n.once(function(){s(t,i),r.apply(this,arguments)});i._callback=r}return e};l.trigger=function(e){if(!this._events)return this;for(var t=Math.max(0,arguments.length-1),n=Array(t),r=0;r<t;r++)n[r]=arguments[r+1];return d(p,this._events,e,void 0,n),this};var p=function(e,t,n,r){if(e){var s=e[t],i=e.all;s&&i&&(i=i.slice()),s&&h(s,r),i&&h(i,[t].concat(r))}return e},h=function(e,t){var n,r=-1,s=e.length,i=t[0],o=t[1],a=t[2];switch(t.length){case 0:for(;++r<s;)(n=e[r]).callback.call(n.ctx);
return;case 1:for(;++r<s;)(n=e[r]).callback.call(n.ctx,i);return;case 2:for(;++r<s;)(n=e[r]).callback.call(n.ctx,i,o);return;case 3:for(;++r<s;)(n=e[r]).callback.call(n.ctx,i,o,a);return;default:for(;++r<s;)(n=e[r]).callback.apply(n.ctx,t);return}};l.bind=l.on,l.unbind=l.off,n.extend(t,l);var v=t.Model=function(e,t){var r=e||{};t||(t={}),this.cid=n.uniqueId(this.cidPrefix),this.attributes={},t.collection&&(this.collection=t.collection),t.parse&&(r=this.parse(r,t)||{}),r=n.defaults({},r,n.result(this,"defaults")),this.set(r,t),this.changed={},this.initialize.apply(this,arguments)};n.extend(v.prototype,l,{changed:null,validationError:null,idAttribute:"id",cidPrefix:"c",initialize:function(){},toJSON:function(e){return n.clone(this.attributes)},sync:function(){return t.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return n.escape(this.get(e))},has:function(e){return null!=this.get(e)},matches:function(e){return!!n.iteratee(e,this)(this.attributes)},set:function(e,t,r){if(null==e)return this;var s;if("object"==typeof e?(s=e,r=t):(s={})[e]=t,r||(r={}),!this._validate(s,r))return!1;var i=r.unset,o=r.silent,a=[],l=this._changing;this._changing=!0,l||(this._previousAttributes=n.clone(this.attributes),this.changed={});var c=this.attributes,d=this.changed,u=this._previousAttributes;this.idAttribute in s&&(this.id=s[this.idAttribute]);for(var f in s)t=s[f],n.isEqual(c[f],t)||a.push(f),n.isEqual(u[f],t)?delete d[f]:d[f]=t,i?delete c[f]:c[f]=t;if(!o){a.length&&(this._pending=r);for(var g=0;g<a.length;g++)this.trigger("change:"+a[g],this,c[a[g]],r)}if(l)return this;if(!o)for(;this._pending;)r=this._pending,this._pending=!1,this.trigger("change",this,r);return this._pending=!1,this._changing=!1,this},unset:function(e,t){return this.set(e,void 0,n.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var r in this.attributes)t[r]=void 0;return this.set(t,n.extend({},e,{unset:!0}))},hasChanged:function(e){return null==e?!n.isEmpty(this.changed):n.has(this.changed,e)},changedAttributes:function(e){if(!e)return!!this.hasChanged()&&n.clone(this.changed);var t=this._changing?this._previousAttributes:this.attributes,r={};for(var s in e){var i=e[s];n.isEqual(t[s],i)||(r[s]=i)}return!!n.size(r)&&r},previous:function(e){return null!=e&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return n.clone(this._previousAttributes)},fetch:function(e){e=n.extend({parse:!0},e);var t=this,r=e.success;return e.success=function(n){var s=e.parse?t.parse(n,e):n;return!!t.set(s,e)&&(r&&r.call(e.context,t,n,e),void t.trigger("sync",t,n,e))},R(this,e),this.sync("read",this,e)},save:function(e,t,r){var s;null==e||"object"==typeof e?(s=e,r=t):(s={})[e]=t,r=n.extend({validate:!0,parse:!0},r);var i=r.wait;if(s&&!i){if(!this.set(s,r))return!1}else if(!this._validate(s,r))return!1;var o=this,a=r.success,l=this.attributes;r.success=function(e){o.attributes=l;var t=r.parse?o.parse(e,r):e;return i&&(t=n.extend({},s,t)),!(t&&!o.set(t,r))&&(a&&a.call(r.context,o,e,r),void o.trigger("sync",o,e,r))},R(this,r),s&&i&&(this.attributes=n.extend({},l,s));var c=this.isNew()?"create":r.patch?"patch":"update";"patch"!==c||r.attrs||(r.attrs=s);var d=this.sync(c,this,r);return this.attributes=l,d},destroy:function(e){e=e?n.clone(e):{};var t=this,r=e.success,s=e.wait,i=function(){t.stopListening(),t.trigger("destroy",t,t.collection,e)};e.success=function(n){s&&i(),r&&r.call(e.context,t,n,e),t.isNew()||t.trigger("sync",t,n,e)};var o=!1;return this.isNew()?n.defer(e.success):(R(this,e),o=this.sync("delete",this,e)),s||i(),o},url:function(){var e=n.result(this,"urlRoot")||n.result(this.collection,"url")||L();if(this.isNew())return e;var t=this.get(this.idAttribute);return e.replace(/[^\/]$/,"$&/")+encodeURIComponent(t)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(e){return this._validate({},n.defaults({validate:!0},e))},_validate:function(e,t){if(!t.validate||!this.validate)return!0;e=n.extend({},this.attributes,e);var r=this.validationError=this.validate(e,t)||null;return!r||(this.trigger("invalid",this,r,n.extend(t,{validationError:r})),!1)}});var b={keys:1,values:1,pairs:1,invert:1,pick:0,omit:0,chain:1,isEmpty:1};a(v,b,"attributes");var y=t.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),void 0!==t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,n.extend({silent:!0},t))},w={add:!0,remove:!0,merge:!0},x={add:!0,remove:!1};n.extend(y.prototype,l,{model:v,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},sync:function(){return t.sync.apply(this,arguments)},add:function(e,t){return this.set(e,n.extend({merge:!1},t,x))},remove:function(e,t){t=n.extend({},t);var r=!n.isArray(e);e=r?[e]:n.clone(e);var s=this._removeModels(e,t);return!t.silent&&s&&this.trigger("update",this,t),r?s[0]:s},set:function(e,t){t=n.defaults({},t,w),t.parse&&!this._isModel(e)&&(e=this.parse(e,t));var r=!n.isArray(e);e=r?e?[e]:[]:e.slice();var s,i,o,a,l,c=t.at;null!=c&&(c=+c),c<0&&(c+=this.length+1);for(var d=this.comparator&&null==c&&t.sort!==!1,u=n.isString(this.comparator)?this.comparator:null,f=[],g=[],m={},p=t.add,h=t.merge,v=t.remove,b=!(d||!p||!v)&&[],y=!1,x=0;x<e.length;x++){if(o=e[x],a=this.get(o))v&&(m[a.cid]=!0),h&&o!==a&&(o=this._isModel(o)?o.attributes:o,t.parse&&(o=a.parse(o,t)),a.set(o,t),d&&!l&&a.hasChanged(u)&&(l=!0)),e[x]=a;else if(p){if(i=e[x]=this._prepareModel(o,t),!i)continue;f.push(i),this._addReference(i,t)}i=a||i,i&&(s=this.modelId(i.attributes),!b||!i.isNew()&&m[s]||(b.push(i),y=y||!this.models[x]||i.cid!==this.models[x].cid),m[s]=!0)}if(v){for(var x=0;x<this.length;x++)m[(i=this.models[x]).cid]||g.push(i);g.length&&this._removeModels(g,t)}if(f.length||y)if(d&&(l=!0),this.length+=f.length,null!=c)for(var x=0;x<f.length;x++)this.models.splice(c+x,0,f[x]);else{b&&(this.models.length=0);for(var _=b||f,x=0;x<_.length;x++)this.models.push(_[x])}if(l&&this.sort({silent:!0}),!t.silent){for(var $=null!=c?n.clone(t):t,x=0;x<f.length;x++)null!=c&&($.index=c+x),(i=f[x]).trigger("add",i,this,$);(l||y)&&this.trigger("sort",this,t),(f.length||g.length)&&this.trigger("update",this,t)}return r?e[0]:e},reset:function(e,t){t=t?n.clone(t):{};for(var r=0;r<this.models.length;r++)this._removeReference(this.models[r],t);return t.previousModels=this.models,this._reset(),e=this.add(e,n.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),e},push:function(e,t){return this.add(e,n.extend({at:this.length},t))},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e)},unshift:function(e,t){return this.add(e,n.extend({at:0},t))},shift:function(e){var t=this.at(0);return this.remove(t,e)},slice:function(){return i.apply(this.models,arguments)},get:function(e){if(null!=e){var t=this.modelId(this._isModel(e)?e.attributes:e);return this._byId[e]||this._byId[t]||this._byId[e.cid]}},at:function(e){return e<0&&(e+=this.length),this.models[e]},where:function(e,t){var r=n.matches(e);return this[t?"find":"filter"](function(e){return r(e.attributes)})},findWhere:function(e){return this.where(e,!0)},sort:function(e){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return e||(e={}),n.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(n.bind(this.comparator,this)),e.silent||this.trigger("sort",this,e),this},pluck:function(e){return n.invoke(this.models,"get",e)},fetch:function(e){e=n.extend({parse:!0},e);var t=e.success,r=this;return e.success=function(n){var s=e.reset?"reset":"set";r[s](n,e),t&&t.call(e.context,r,n,e),r.trigger("sync",r,n,e)},R(this,e),this.sync("read",this,e)},create:function(e,t){t=t?n.clone(t):{};var r=t.wait;if(e=this._prepareModel(e,t),!e)return!1;r||this.add(e,t);var s=this,i=t.success;return t.success=function(e,t,n){r&&s.add(e,n),i&&i.call(n.context,e,t,n)},e.save(null,t),e},parse:function(e,t){return e},clone:function(){return new this.constructor(this.models,{model:this.model,comparator:this.comparator})},modelId:function(e){return e[this.model.prototype.idAttribute||"id"]},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(e,t){if(this._isModel(e))return e.collection||(e.collection=this),e;t=t?n.clone(t):{},t.collection=this;var r=new this.model(e,t);return r.validationError?(this.trigger("invalid",this,r.validationError,t),!1):r},_removeModels:function(e,t){for(var n=[],r=0;r<e.length;r++){var s=this.get(e[r]);if(s){var i=this.indexOf(s);this.models.splice(i,1),this.length--,t.silent||(t.index=i,s.trigger("remove",s,this,t)),n.push(s),this._removeReference(s,t)}}return!!n.length&&n},_isModel:function(e){return e instanceof v},_addReference:function(e,t){this._byId[e.cid]=e;var n=this.modelId(e.attributes);null!=n&&(this._byId[n]=e),e.on("all",this._onModelEvent,this)},_removeReference:function(e,t){delete this._byId[e.cid];var n=this.modelId(e.attributes);null!=n&&delete this._byId[n],this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,r){if("add"!==e&&"remove"!==e||n===this){if("destroy"===e&&this.remove(t,r),"change"===e){var s=this.modelId(t.previousAttributes()),i=this.modelId(t.attributes);s!==i&&(null!=s&&delete this._byId[s],null!=i&&(this._byId[i]=t))}this.trigger.apply(this,arguments)}}});var _={forEach:3,each:3,map:3,collect:3,reduce:4,foldl:4,inject:4,reduceRight:4,foldr:4,find:3,detect:3,filter:3,select:3,reject:3,every:3,all:3,some:3,any:3,include:2,contains:2,invoke:0,max:3,min:3,toArray:1,size:1,first:3,head:3,take:3,initial:3,rest:3,tail:3,drop:3,last:3,without:0,difference:0,indexOf:3,shuffle:1,lastIndexOf:3,isEmpty:1,chain:1,sample:3,partition:3};a(y,_,"models");var $=["groupBy","countBy","sortBy","indexBy"];n.each($,function(e){n[e]&&(y.prototype[e]=function(t,r){var s=n.isFunction(t)?t:function(e){return e.get(t)};return n[e](this.models,s,r)})});var C=t.View=function(e){this.cid=n.uniqueId("view"),n.extend(this,n.pick(e,j)),this._ensureElement(),this.initialize.apply(this,arguments)},S=/^(\S+)\s*(.*)$/,j=["model","collection","el","id","attributes","className","tagName","events"];n.extend(C.prototype,l,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this._removeElement(),this.stopListening(),this},_removeElement:function(){this.$el.remove()},setElement:function(e){return this.undelegateEvents(),this._setElement(e),this.delegateEvents(),this},_setElement:function(e){this.$el=e instanceof t.$?e:t.$(e),this.el=this.$el[0]},delegateEvents:function(e){if(e||(e=n.result(this,"events")),!e)return this;this.undelegateEvents();for(var t in e){var r=e[t];if(n.isFunction(r)||(r=this[r]),r){var s=t.match(S);this.delegate(s[1],s[2],n.bind(r,this))}}return this},delegate:function(e,t,n){return this.$el.on(e+".delegateEvents"+this.cid,t,n),this},undelegateEvents:function(){return this.$el&&this.$el.off(".delegateEvents"+this.cid),this},undelegate:function(e,t,n){return this.$el.off(e+".delegateEvents"+this.cid,t,n),this},_createElement:function(e){return document.createElement(e)},_ensureElement:function(){if(this.el)this.setElement(n.result(this,"el"));else{var e=n.extend({},n.result(this,"attributes"));this.id&&(e.id=n.result(this,"id")),this.className&&(e.class=n.result(this,"className")),this.setElement(this._createElement(n.result(this,"tagName"))),this._setAttributes(e)}},_setAttributes:function(e){this.$el.attr(e)}}),t.sync=function(e,r,s){var i=E[e];n.defaults(s||(s={}),{emulateHTTP:t.emulateHTTP,emulateJSON:t.emulateJSON});var o={type:i,dataType:"json"};if(s.url||(o.url=n.result(r,"url")||L()),null!=s.data||!r||"create"!==e&&"update"!==e&&"patch"!==e||(o.contentType="application/json",o.data=JSON.stringify(s.attrs||r.toJSON(s))),s.emulateJSON&&(o.contentType="application/x-www-form-urlencoded",o.data=o.data?{model:o.data}:{}),s.emulateHTTP&&("PUT"===i||"DELETE"===i||"PATCH"===i)){o.type="POST",s.emulateJSON&&(o.data._method=i);var a=s.beforeSend;s.beforeSend=function(e){if(e.setRequestHeader("X-HTTP-Method-Override",i),a)return a.apply(this,arguments)}}"GET"===o.type||s.emulateJSON||(o.processData=!1);var l=s.error;s.error=function(e,t,n){s.textStatus=t,s.errorThrown=n,l&&l.call(s.context,e,t,n)};var c=s.xhr=t.ajax(n.extend(o,s));return r.trigger("request",r,c,s),c};var E={create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"};t.ajax=function(){return t.$.ajax.apply(t.$,arguments)};var A=t.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},I=/\((.*?)\)/g,q=/(\(\?)?:\w+/g,T=/\*\w+/g,V=/[\-{}\[\]+?.,\\\^$|#\s]/g;n.extend(A.prototype,l,{initialize:function(){},route:function(e,r,s){n.isRegExp(e)||(e=this._routeToRegExp(e)),n.isFunction(r)&&(s=r,r=""),s||(s=this[r]);var i=this;return t.history.route(e,function(n){var o=i._extractParameters(e,n);i.execute(s,o,r)!==!1&&(i.trigger.apply(i,["route:"+r].concat(o)),i.trigger("route",r,o),t.history.trigger("route",i,r,o))}),this},execute:function(e,t,n){e&&e.apply(this,t)},navigate:function(e,n){return t.history.navigate(e,n),this},_bindRoutes:function(){if(this.routes){this.routes=n.result(this,"routes");for(var e,t=n.keys(this.routes);null!=(e=t.pop());)this.route(e,this.routes[e])}},_routeToRegExp:function(e){return e=e.replace(V,"\\$&").replace(I,"(?:$1)?").replace(q,function(e,t){return t?e:"([^/?]+)"}).replace(T,"([^?]*?)"),new RegExp("^"+e+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(e,t){var r=e.exec(t).slice(1);return n.map(r,function(e,t){return t===r.length-1?e||null:e?decodeURIComponent(e):null})}});var k=t.History=function(){this.handlers=[],n.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},O=/^[#\/]|\s+$/g,M=/^\/+|\/+$/g,F=/#.*$/;k.started=!1,n.extend(k.prototype,l,{interval:50,atRoot:function(){var e=this.location.pathname.replace(/[^\/]$/,"$&/");return e===this.root&&!this.getSearch()},matchRoot:function(){var e=this.decodeFragment(this.location.pathname),t=e.slice(0,this.root.length-1)+"/";return t===this.root},decodeFragment:function(e){return decodeURI(e.replace(/%25/g,"%2525"))},getSearch:function(){var e=this.location.href.replace(/#.*/,"").match(/\?.+/);return e?e[0]:""},getHash:function(e){var t=(e||this).location.href.match(/#(.*)$/);return t?t[1]:""},getPath:function(){var e=this.decodeFragment(this.location.pathname+this.getSearch()).slice(this.root.length-1);return"/"===e.charAt(0)?e.slice(1):e},getFragment:function(e){return null==e&&(e=this._usePushState||!this._wantsHashChange?this.getPath():this.getHash()),e.replace(O,"")},start:function(e){if(k.started)throw new Error("Backbone.history has already been started");if(k.started=!0,this.options=n.extend({root:"/"},this.options,e),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._hasHashChange="onhashchange"in window,this._useHashChange=this._wantsHashChange&&this._hasHashChange,this._wantsPushState=!!this.options.pushState,this._hasPushState=!(!this.history||!this.history.pushState),this._usePushState=this._wantsPushState&&this._hasPushState,this.fragment=this.getFragment(),this.root=("/"+this.root+"/").replace(M,"/"),this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){var t=this.root.slice(0,-1)||"/";return this.location.replace(t+"#"+this.getPath()),!0}this._hasPushState&&this.atRoot()&&this.navigate(this.getHash(),{replace:!0})}if(!this._hasHashChange&&this._wantsHashChange&&!this._usePushState){this.iframe=document.createElement("iframe"),this.iframe.src="javascript:0",this.iframe.style.display="none",this.iframe.tabIndex=-1;var r=document.body,s=r.insertBefore(this.iframe,r.firstChild).contentWindow;s.document.open(),s.document.close(),s.location.hash="#"+this.fragment}var i=window.addEventListener||function(e,t){return attachEvent("on"+e,t)};if(this._usePushState?i("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe?i("hashchange",this.checkUrl,!1):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),!this.options.silent)return this.loadUrl()},stop:function(){var e=window.removeEventListener||function(e,t){return detachEvent("on"+e,t)};this._usePushState?e("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe&&e("hashchange",this.checkUrl,!1),this.iframe&&(document.body.removeChild(this.iframe),this.iframe=null),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),k.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(e){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getHash(this.iframe.contentWindow)),t!==this.fragment&&(this.iframe&&this.navigate(t),void this.loadUrl())},loadUrl:function(e){return!!this.matchRoot()&&(e=this.fragment=this.getFragment(e),n.any(this.handlers,function(t){if(t.route.test(e))return t.callback(e),!0}))},navigate:function(e,t){if(!k.started)return!1;t&&t!==!0||(t={trigger:!!t}),e=this.getFragment(e||"");var n=this.root;""!==e&&"?"!==e.charAt(0)||(n=n.slice(0,-1)||"/");var r=n+e;if(e=this.decodeFragment(e.replace(F,"")),this.fragment!==e){if(this.fragment=e,this._usePushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,r);else{if(!this._wantsHashChange)return this.location.assign(r);if(this._updateHash(this.location,e,t.replace),this.iframe&&e!==this.getHash(this.iframe.contentWindow)){var s=this.iframe.contentWindow;t.replace||(s.document.open(),s.document.close()),this._updateHash(s.location,e,t.replace)}}return t.trigger?this.loadUrl(e):void 0}},_updateHash:function(e,t,n){if(n){var r=e.href.replace(/(javascript:|#).*$/,"");e.replace(r+"#"+t)}else e.hash="#"+t}}),t.history=new k;var N=function(e,t){var r,s=this;r=e&&n.has(e,"constructor")?e.constructor:function(){return s.apply(this,arguments)},n.extend(r,s,t);var i=function(){this.constructor=r};return i.prototype=s.prototype,r.prototype=new i,e&&n.extend(r.prototype,e),r.__super__=s.prototype,r};v.extend=y.extend=A.extend=C.extend=k.extend=N;var L=function(){throw new Error('A "url" property or function must be specified')},R=function(e,t){var n=t.error;t.error=function(r){n&&n.call(t.context,e,r,t),e.trigger("error",e,r,t)}};return t}),$sessionId=void 0,$userId=void 0,Ext.define("$o",{singleton:!0,mixins:{observable:"Ext.util.Observable"},code:null,currentUser:null,objectsMap:{},actionsMap:{},constructor:function(e){this.mixins.observable.constructor.call(this,e),this.addEvents("afterCreateObject","beforeCommitObject","beforeRemoveObject")},load:function(e){var t=this,n=e.success,r=e.scope;t.initModels(),t.initStores({success:function(e){t.initClasses(e),t.initClassAttrs(e),t.initViews(e),t.initViewAttrs(e),t.initClassModels(),n.call(r||t,e)}})},init:function(e){if(!e)throw new Error("$o.init must have options: {success}");var t=this;t.code=e.code;var n=e.failure,r=e.scope;t.authorized?t.load(e):t.authorize(Ext.apply(e,{success:function(e){t.load(e)},failure:function(e){n&&n.call(r||t,e)}}))},authorize:function(e){var t=e;Ext.Ajax.request({url:"?authorize=1",params:e.login+"\n"+e.password+"\n"+e.passwordPlain,success:function(e,n){if(!e.responseText)return void(t.failure&&t.failure.call(t.scope||this,"Authentication error"));if("wait"!=e.responseText.substr(0,4)){if("no free slots"==e.responseText)return void(t.failure&&t.failure.call(t.scope||this,"no free slots"));if("user in system"==e.responseText)return void(t.failure&&t.failure.call(t.scope||this,"user in system"));if("firewall denied"==e.responseText)return void(t.failure&&t.failure.call(t.scope||this,$o.getString("Access denied")));var r=e.responseText.split(" "),s=r[0],i=r[1];"null"==i&&(i=null),this.sessionId=$sessionId=s,this.userId=$userId=i,this.authorized=!0,this.currentUser=t.login,"autologin"!=this.currentUser&&$o.util.setCookie("sessionId",s),r.length>2&&3==r[2]?$o.serverVersion=3:$o.serverVersion=2,r.length>4&&($o.roleId="null"==r[3]?null:r[3],$o.menuId="null"==r[4]?null:r[4]),$o.idleTimer=0;var o=function(){$o.idleTimer=0};if("autologin"!=this.currentUser)var a=setInterval(function(){$o.idleTimer+=1,$o.maxIdleSec=$o.maxIdleSec||1800,$o.idleTimer>$o.maxIdleSec&&(clearInterval(a),$o.logout({success:function(){Ext.Msg.alert($ptitle,$o.getString("Session disabled"),function(){location.reload()})}}))},1e3);document.addEventListener("mousemove",o,!1),document.addEventListener("click",o,!1),document.addEventListener("scroll",o,!1),t.success.call(t.scope||this,Ext.apply(t,{sessionId:s,userId:i}))}else if(t.failure){var l=e.responseText.split(" ")[1];t.failure.call(t.scope||this,$o.getString("Wait")+" "+(l/60|0)+$o.getString(" ","min","and","try again"))}},failure:function(){t.failure&&t.failure.call(t.scope||this,"Authentication error")},scope:this})},logout:function(e){function t(){Ext.Ajax.request({url:"?logout=1&sessionId="+n.sessionId,params:n.sessionId,success:function(e,t){r&&r()},failure:function(){s&&s()},scope:n})}var n=this;e=e||{};var r=e.success,s=e.failure;if($o.util.getCookie("esiaAuth")){$o.util.setCookie("esiaAuth","","/");var i=window.open("https://esia-portal1.test.gosuslugi.ru/profile/user/saml/Logout");setTimeout(function(){i.close(),window.open("https://esia-portal1.test.gosuslugi.ru/profile/user/saml/Logout"),t()},3e3)}else t()},initModels:function(){var storage=this;Ext.define("$o.Base.Model",{extend:"Ext.data.Model",constructor:function(e){var t=this;t.callParent(arguments),t.remove=function(){t.removed=!0}},sync:function(){var me=this;if(me.removed){var r=Ext.Ajax.request({async:!1,url:"?sessionId="+$sessionId,params:storage.code+"."+me.tableName+".remove("+me.get("id")+")"}),store;if("Class"==me.tableName&&(store=storage.store.classes),"ClassAttr"==me.tableName&&(store=storage.store.classAttrs),"View"==me.tableName&&(store=storage.store.views),"ViewAttr"==me.tableName&&(store=storage.store.viewAttrs),"Action"==me.tableName)return void delete storage.actionsMap[me.get("id")];var rec=store.findRecord("id",me.get("id"),0,!1,!1,!0);return store.remove(rec),"Class"!=me.tableName&&"ClassAttr"!=me.tableName||(storage.initClasses(),storage.initClassAttrs(),storage.initClassModels()),void("View"!=me.tableName&&"ViewAttr"!=me.tableName||(storage.initViews(),storage.initViewAttrs()))}for(var values=[],i=0;i<me.fieldsArray.length;i++)values.push(Ext.encode(me.get(me.fieldsArray[i])||null));if(me.get("id")){var valuesStr=values.join(",");"Action"!=me.tableName&&(valuesStr=valuesStr.split("false").join("0").split("true").join("1"));var r=Ext.Ajax.request({async:!1,url:"?sessionId="+$sessionId,params:storage.code+"."+me.tableName+".set("+valuesStr+")"})}else{values.splice(0,1);var valuesStr=values.join(",");"Action"!=me.tableName&&(valuesStr=valuesStr.split("false").join("0").split("true").join("1"));var r=Ext.Ajax.request({async:!1,url:"?sessionId="+$sessionId,params:storage.code+"."+me.tableName+".create("+valuesStr+")"});storage.checkException(r);var o=eval("("+r.responseText+")");me.set("id",o.data[0][0]),"Class"==me.tableName&&storage.store.classes.add(me),"ClassAttr"==me.tableName&&storage.store.classAttrs.add(me),"View"==me.tableName&&storage.store.views.add(me),"ViewAttr"==me.tableName&&storage.store.viewAttrs.add(me)}if("Class"==me.tableName&&storage.initClass(me),"ClassAttr"==me.tableName&&(storage.initClassAttr(me),me.get("class"))){var cls=$o.getClass(me.get("class"));cls&&storage.initClass(cls)}"View"==me.tableName&&storage.initView(me),"ViewAttr"==me.tableName&&storage.initViewAttr(me)},toString:function(){var e=this,t=e.get("code");e.getFullCode&&(t=e.getFullCode());var n;return n="Action"==e.tableName?e.get("name")+" ("+t+":"+e.get("id")+")"+(e.get("class")?", : "+$o.getClass(e.get("class")).toString():""):e.get("name")+" ("+t+":"+e.get("id")+")"}}),Ext.define("$o.Class.Model",{extend:"$o.Base.Model",idProperty:"id",fields:[{name:"id",type:"number"},{name:"parent",type:"number",useNull:!0},{name:"name",type:"string",useNull:!0},{name:"code",type:"string",useNull:!0},{name:"description",type:"string",useNull:!0},{name:"format",type:"string",useNull:!0},{name:"view",type:"number",useNull:!0},{name:"type",type:"number",useNull:!0},{name:"system",type:"number",useNull:!0}],tableName:"Class",fieldsArray:["id","parent","name","code","description","format","view","type","system"],getFullCode:function(){var e="";return this.get("parent")&&(e=$o.classesMap[this.get("parent")].getFullCode()),e&&(e+="."),e+=this.get("code")},getPath:function(){return this.getFullCode()},updateDefault:function(){storage.updateDefaultView.call(this),storage.updateDefaultActions.call(this)},hasAttrInHierarchy:function(e){function t(e,n){if(e.attrs[n])return $o.getClass(e.attrs[n].get("class"));for(var r=0;r<e.childs.length;r++){var s=t($o.getClass(e.childs[r]),n);if(s)return s}return 0}var n=this,r=t(n,e);return r}}),Ext.define("$o.ClassAttr.Model",{extend:"$o.Base.Model",idProperty:"id",fields:[{name:"id",type:"number"},{name:"class",type:"number",useNull:!0},{name:"name",type:"string",useNull:!0},{name:"code",type:"string",useNull:!0},{name:"type",type:"number",useNull:!0},{name:"order",type:"number",useNull:!0},{name:"notNull",type:"bool",useNull:!0},{name:"validFunc",type:"string",useNull:!0},{name:"formatFunc",type:"string",useNull:!0},{name:"description",type:"string",useNull:!0},{name:"secure",type:"bool",useNull:!0},{name:"maxString",type:"number",useNull:!0},{name:"minString",type:"number",useNull:!0},{name:"maxNumber",type:"number",useNull:!0},{name:"minNumber",type:"number",useNull:!0},{name:"maxDate",type:"date",useNull:!0},{name:"minDate",type:"date",useNull:!0},{name:"unique",type:"bool",useNull:!0},{name:"numberFormat",type:"string",useNull:!0},{name:"dateFormat",type:"string",useNull:!0},{name:"removeRule",type:"string",useNull:!0}],tableName:"ClassAttr",fieldsArray:["id","class","name","code","type","order","notNull","validFunc","formatFunc","description","secure","maxString","minString","maxNumber","minNumber","maxDate","minDate","unique","numberFormat","dateFormat","removeRule"],getDataType:function(){var e;switch(this.get("type")){case 1:case 5:e="string";break;case 2:e="number";break;case 3:e="date";break;case 4:e="bool";break;case 6:case 7:case 8:case 9:e="number";break;default:e="number"}return e},getFieldType:function(){var e=this.getDataType(),t="numberfield";return"string"==e&&(t="textfield"),"date"==e&&(t="datefield"),"bool"==e&&(t="checkbox"),this.get("type")>=1e3&&(t="objectfield"),5==this.get("type")&&(t="$filefield"),t},getFilterDataType:function(){var e=this.getDataType();return"number"==e&&(e="numeric"),e},getVType:function(){var me=this,code;if(me.get("validFunc")){var code=$o.getClass(me.get("class")).getFullCode()+"."+me.get("code");if(!Ext.form.VTypes[code])try{var vf=eval("("+me.get("validFunc")+")"),o={};o[code]=vf.fn,o[code+"Text"]="function"==typeof vf.description?eval("("+vf.description+")"):vf.description,Ext.apply(Ext.form.VTypes,o)}catch(e){}}return code}}),Ext.define("$o.View.Model",{extend:"$o.Base.Model",idProperty:"id",fields:[{name:"id",type:"number"},{name:"parent",type:"number",useNull:!0},{name:"name",type:"string",useNull:!0},{name:"code",type:"string",useNull:!0},{name:"description",type:"string",useNull:!0},{name:"layout",type:"string",useNull:!0},{name:"key",type:"string",useNull:!0},{name:"parentKey",type:"number",useNull:!0},{name:"class",type:"number",useNull:!0},{name:"unrelated",type:"string",useNull:!0},{name:"query",type:"string",useNull:!0},{name:"type",type:"bool",useNull:!0},{name:"system",type:"bool",useNull:!0},{name:"materialized",type:"bool",useNull:!0},{name:"order",type:"number",useNull:!0},{name:"iconCls",type:"string",useNull:!0}],tableName:"View",fieldsArray:["id","parent","name","code","description","layout","key","parentKey","class","unrelated","query","type","system","materialized","order","iconCls"],getFullCode:function(){var e="";return this.get("parent")&&(e=$o.viewsMap[this.get("parent")].getFullCode()),e&&(e+="."),e+=this.get("code")},getPath:function(){return this.getFullCode()}}),Ext.define("$o.ViewAttr.Model",{extend:"$o.Base.Model",idProperty:"id",fields:[{name:"id",type:"number"},{name:"view",type:"number",useNull:!0},{name:"name",type:"string",useNull:!0},{name:"code",type:"string",useNull:!0},{name:"class",type:"number",useNull:!0},{name:"classAttr",type:"number",useNull:!0},{name:"subject",type:"number",useNull:!0},{name:"order",type:"number",useNull:!0},{name:"sort",type:"number",useNull:!0},{name:"sortOrder",type:"number",useNull:!0},{name:"operation",type:"number",useNull:!0},{name:"value",type:"string",useNull:!0},{name:"area",type:"bool",useNull:!0},{name:"width",type:"number",useNull:!0},{name:"totalType",type:"number",useNull:!0},{name:"readOnly",type:"bool",useNull:!0},{name:"group",type:"bool",useNull:!0},{name:"notNull",type:"bool",useNull:!0}],tableName:"ViewAttr",fieldsArray:["id","view","name","code","class","classAttr","subject","order","sort","sortOrder","operation","value","area","width","totalType","readOnly","group","notNull"]}),Ext.define("$o.Action.Model",{extend:"$o.Base.Model",idProperty:"id",fields:[{name:"id",type:"number"},{name:"class",type:"number",useNull:!0},{name:"name",type:"string",useNull:!0},{name:"code",type:"string",useNull:!0},{name:"description",type:"string",useNull:!0},{name:"body",type:"string",useNull:!0},{name:"layout",type:"string",useNull:!0}],tableName:"Action",fieldsArray:["id","class","name","code","description","order","body","layout"],initAction:function(){var actionId=this.get("id"),a=$o.getAction(actionId),cls=$o.getClass(a.get("class")),fName=cls.getFullCode()+"."+a.get("code");Ext.namespace(fName);var f=fName+" = function (options) {\n"+a.get("body")+"};\n",l;try{l=JSON.parse(a.get("layout"))}catch(e){}if(!l||!l.serverAction){try{eval(f)}catch(e){}if(l&&l.layout){var fl=fName+".layout = "+JSON.stringify(l.layout,null,"\t")+";\n";try{eval(fl)}catch(e){}}common.getConf("projectNeedBuild").used||common.setConf("projectNeedBuild",{used:1})}},getFullCode:function(){var e=$o.getClass(this.get("class")),t=(e?e.getFullCode()+".":"")+this.get("code");return t},getPath:function(){return this.getFullCode()},execute:function(options){var fn_=eval(this.getFullCode());"function"==typeof fn_&&fn_(options)}})},initStores:function(options){var me=this,mainOptions=options;Ext.define("$o.Class.Store",{extend:"Ext.data.Store",model:"$o.Class.Model"}),Ext.define("$o.ClassAttr.Store",{extend:"Ext.data.Store",model:"$o.ClassAttr.Model"}),Ext.define("$o.View.Store",{extend:"Ext.data.Store",model:"$o.View.Model"}),Ext.define("$o.ViewAttr.Store",{extend:"Ext.data.Store",model:"$o.ViewAttr.Model"}),me.store={classes:Ext.create("$o.Class.Store"),classAttrs:Ext.create("$o.ClassAttr.Store"),views:Ext.create("$o.View.Store"),viewAttrs:Ext.create("$o.ViewAttr.Store")},3==$o.serverVersion?Ext.Ajax.request({url:"?sessionId="+me.sessionId,params:me.code+'.Storage.getAll("")',success:function(response,options){var d=eval("("+response.responseText+")");me.store.classes.loadData(d.classes),me.store.classAttrs.loadData(d.classAttrs),me.store.views.loadData(d.views),me.store.viewAttrs.loadData(d.viewAttrs),me.visualObjectum=d.visualObjectum||{},me.visualObjectum.timeMachine=me.visualObjectum.timeMachine||{},me.visualObjectum.logo=me.visualObjectum.logo||{},me.data=d,mainOptions.data=d,mainOptions.success.call(mainOptions.scope||me,mainOptions)},scope:me}):(me.data={},mainOptions.data={},async.parallel([function(cb){Ext.Ajax.request({url:"?sessionId="+me.sessionId+"&username="+$o.currentUser,params:me.code+'.Storage.getClasses("")',success:function(response,options){var d=eval("("+response.responseText+")");me.store.classes.loadData(d.data),me.data.classes=d.data,mainOptions.data.classes=d.data,cb();
},scope:me})},function(cb){Ext.Ajax.request({url:"?sessionId="+me.sessionId+"&username="+$o.currentUser,params:me.code+'.Storage.getClassAttrs("")',success:function(response,options){var d=eval("("+response.responseText+")");me.store.classAttrs.loadData(d.data),me.classAttrs={},me.data.classAttrs=d.data,mainOptions.data.classAttrs=d.data,cb()},scope:me})},function(cb){Ext.Ajax.request({url:"?sessionId="+me.sessionId+"&username="+$o.currentUser,params:me.code+'.Storage.getViews("")',success:function(response,options){var d=eval("("+response.responseText+")");me.store.views.loadData(d.data),me.data.views=d.data,mainOptions.data.views=d.data,cb()},scope:me})},function(cb){Ext.Ajax.request({url:"?sessionId="+me.sessionId+"&username="+$o.currentUser,params:me.code+'.Storage.getViewAttrs("")',success:function(response,options){var d=eval("("+response.responseText+")");me.store.viewAttrs.loadData(d.data),me.data.viewAttrs=d.data,mainOptions.data.viewAttrs=d.data,cb()},scope:me})}],function(e,t){mainOptions.success.call(mainOptions.scope||me,mainOptions)}))},checkException:function(options){if(!$o.app){var r=eval("("+options.responseText+")");if(r&&r.header&&r.header.error)throw new Error(r.header.error)}},initClassModels:function(){Ext.define("$o.Class.Base.Model",{extend:"Ext.data.Model",storage:this,commitLocal:function(){var e=this;if("child"!=e.local){e.local=null,e.commit();for(var t in e.localChilds){var n=$o.getObject(t);"their"==e.localChilds[t].place&&n.set(e.localChilds[t].attr,e.get("id")),n.local="root",n.commitLocal(),"mine"==e.localChilds[t].place&&(e.set(e.localChilds[t].attr,n.get("id")),e.commit())}}},commit:function(options){if(this.local)return void("local"==options&&this.commitLocal());if(this.removed)return void this.storage.removeObject(this.get("id"));for(var changes={},changedNum=0,i=0;i<this.fields.getCount();i++){var attr=this.fields.getAt(i).name;if("id"!=attr&&this.data.hasOwnProperty(attr)&&this.data[attr]!=this.originalData[attr]&&(""!==this.data[attr]||this.originalData.hasOwnProperty(attr)&&null!=this.originalData[attr])){var ca=this.getClassAttr(attr);if("date"!=ca.getDataType()||!(!this.data[attr]&&!this.originalData[attr]||this.data[attr]&&this.originalData[attr]&&this.data[attr].getTime()==this.originalData[attr].getTime())){this.originalData[attr]=this.data[attr];var v=this.get(attr);if(v&&"object"==typeof v&&v.getMonth()&&2e3==v.getFullYear()&&1==v.getMonth()&&2==v.getDate()&&3==v.getHours()&&4==v.getMinutes()&&5==v.getSeconds()&&(v="$CURRENT_TIMESTAMP$"),"bool"==ca.getDataType()&&(v=v?1:0),"date"==ca.getDataType()&&v&&"$CURRENT_TIMESTAMP$"!=v)if(0==v.getHours()&&0==v.getMinutes()&&0==v.getSeconds()){var dd=v.getDate(),mm=v.getMonth()+1;v=v.getFullYear()+"-",mm<10&&(v+="0"),v+=mm+"-",dd<10&&(v+="0"),v+=dd+"T00:00:00.000Z"}else v=v.toISOString();changes[attr]={value:null===v?null:String(v),classAttrId:ca.get("id"),type:ca.get("type"),classId:ca.get("class"),classCode:$o.classesMap[ca.get("class")].get("code")},changedNum++}}}if(changedNum||!this.get("id")||this.get("id")<0){this.storage.fireEvent("beforeCommitObject",{objectId:this.get("id"),changes:changes}),this.get("id")<0&&this.set("id",null);var a=[this.get("id"),changes,this.get("classId")],r=Ext.Ajax.request({async:!1,url:"?sessionId="+this.storage.sessionId,params:this.storage.code+".Object.setAttrs([!"+JSON.stringify(a)+"!])"});this.storage.checkException.call(this.storage,r);var o=eval("("+r.responseText+")");(!this.get("id")||this.get("id")<0)&&o.data.id&&this.set("id",o.data.id||o.data);for(var a in o.data)"$CURRENT_TIMESTAMP$"==this.get(a)&&this.set(a,new Date(o.data[a]))}},sync:function(e){this.commit(e)},remove:function(){if($o.isReadOnly())throw common.message($o.getString("Can't change data")),new Error($o.getString("Can't change data"));this.removed=!0},getClassAttr:function(e){var t=$o.classesMap[this.get("classId")];return t.attrs[e]},toString:function(){var cls=$o.classesMap[this.get("classId")],ff=cls.get("format"),r=this.get("name");if(ff)try{var fn=eval("(function () {"+ff+"})");r=fn.call(this)}catch(e){console.log("toString exception"),console.log(this)}return r},set:function(e,t){if("$CURRENT_TIMESTAMP$"==t&&(t=new Date(2e3,1,2,3,4,5)),this.getClassAttr(e)&&this.getClassAttr(e).get("type")>=1e3&&t&&t<0){var n=$o.getObject(t);"root"==this.local?this.localChilds[n.get("id")]={attr:e,place:"mine"}:(this.get("id")||(this.set("id",$o.nextLocalId--),$o.objectsMap[this.get("id")]=this),n.localChilds[this.get("id")]={attr:e,place:"their"},this.local="child")}this.callParent(arguments)},getId:function(){return this.get("id")}});for(var i=0;i<this.store.classes.getCount();i++){var o=this.store.classes.getAt(i),fields=[{name:"id",type:"number",useNull:!0},{name:"classId",type:"number",useNull:!0}];for(var attr in o.attrs){var ca=o.attrs[attr];fields.push({name:ca.get("code"),type:ca.getDataType(),useNull:!0})}Ext.define("$o.Class."+o.get("id")+".Model",{extend:"$o.Class.Base.Model",fields:fields})}},initClass:function(e){var t=this;e.stub=e,e.attrs=e.attrs||{},e.attrsArray=e.attrsArray||[],e.childs=e.childs||[],t.classesMap[e.get("id")]=e,e.get("parent")&&t.classesMap[e.get("parent")].childs.push(e.get("id")),this.classesCode[e.getFullCode()]=e;var n=e.getFullCode().split(".");if(3==n.length&&(t.classesCode[n[0]+"."+n[2]]=t.classesCode[n[0]+"."+n[2]]||e),4==n.length&&(t.classesCode[n[0]+"."+n[3]]=t.classesCode[n[0]+"."+n[3]]||e),e.get("parent")){var r=$o.getClass(e.get("parent"));for(var s in r.attrs)e.attrs[s]=r.attrs[s],e.attrsArray.push(r.attrs[s])}var i=[{name:"id",type:"number",useNull:!0},{name:"classId",type:"number",useNull:!0}];for(var s in e.attrs){var o=e.attrs[s];i.push({name:o.get("code"),type:o.getDataType(),useNull:!0})}if(Ext.ClassManager.get("$o.Class."+e.get("id")+".Model")){var a=Ext.ClassManager.get("$o.Class."+e.get("id")+".Model").prototype.fields;_.each(i,function(e){a.contains({name:e.name})||a.add(e)})}else Ext.define("$o.Class."+e.get("id")+".Model",{extend:"$o.Class.Base.Model",fields:i})},initClasses:function(e){this.classesMap=this.classesMap||{};for(var t=0;t<this.store.classes.getCount();t++){var n=this.store.classes.getAt(t);n.stub=n,n.childs=[],this.classesMap[n.get("id")]=n}this.classesTree=this.classesTree||{},this.classesCode=this.classesCode||{};var r=function(e){for(var t=0;t<this.store.classes.getCount();t++){var n=this.store.classes.getAt(t);if(n.get("parent")==e.parent){e.parent&&this.classesMap[e.parent].childs.push(n.get("id")),e.node[n.get("code")]={id:n.get("id"),stub:n};var s=e.code?e.code+"."+n.get("code"):n.get("code");n.attrs={},n.attrsArray=[],this.classesCode[s]=n;var i=s.split(".");3==i.length&&(this.classesCode[i[0]+"."+i[2]]=this.classesCode[i[0]+"."+i[2]]||n),4==i.length&&(this.classesCode[i[0]+"."+i[3]]=this.classesCode[i[0]+"."+i[3]]||n),r.call(this,{node:e.node[n.get("code")],parent:n.get("id"),code:s})}}};r.call(this,{node:this.classesTree,parent:null})},initClassAttr:function(e){var t=this;if(t.classAttrs[e.get("id")]=e,t.classAttrsMap[e.get("id")]=e,t.classesMap[e.get("class")]){var n=function(r){r.attrs[e.get("code")]=e,r.attrsArray.push(e);for(var s=0;s<r.childs.length;s++)n(t.classesMap[r.childs[s]])};n(t.classesMap[e.get("class")])}},initClassAttrs:function(e){var t=this;t.classAttrs=t.classAttrs||{};for(var n=0;n<t.store.classAttrs.getCount();n++){var r=t.store.classAttrs.getAt(n);t.classAttrs[r.get("id")]=r}t.classAttrsMap=t.classAttrsMap||{};for(var n=0;n<t.store.classAttrs.getCount();n++){var s=this.store.classAttrs.getAt(n);if(t.classAttrsMap[s.get("id")]=s,t.classesMap[s.get("class")]){var i=function(e){e.attrs=e.attrs||{},e.attrs[s.get("code")]=s,e.attrsArray=e.attrsArray||[],e.attrsArray.push(s);for(var n=0;n<e.childs.length;n++)i(t.classesMap[e.childs[n]])};i(t.classesMap[s.get("class")])}}},initView:function(e){e.stub=e,e.attrs=e.attrs||{},e.childs=e.childs||[],this.viewsMap[e.get("id")]=e,this.viewsCode[e.getFullCode()]=e;var t=e.getFullCode().split(".");3==t.length&&(this.viewsCode[t[0]+"."+t[2]]=this.viewsCode[t[0]+"."+t[2]]||e),4==t.length&&(this.viewsCode[t[0]+"."+t[3]]=this.viewsCode[t[0]+"."+t[3]]||e),e.get("parent")&&this.viewsMap[e.get("parent")].childs.push(e.get("id"))},initViews:function(e){this.viewsMap=this.viewsMap||{};for(var t=0;t<this.store.views.getCount();t++){var n=this.store.views.getAt(t);n.stub=n,n.childs=[],this.viewsMap[n.get("id")]=n}this.viewsTree=this.viewsTree||{},this.viewsCode=this.viewsCode||{};var r=function(e){for(var t=0;t<this.store.views.getCount();t++){var n=this.store.views.getAt(t);if(n.get("parent")==e.parent){e.parent&&this.viewsMap[e.parent].childs.push(n.get("id")),e.node[n.get("code")]={id:n.get("id"),stub:n};var s=e.code?e.code+"."+n.get("code"):n.get("code");if(n.attrs={},this.viewsCode[s]=n,s){var i=s.split(".");3==i.length&&(this.viewsCode[i[0]+"."+i[2]]=this.viewsCode[i[0]+"."+i[2]]||n),4==i.length&&(this.viewsCode[i[0]+"."+i[3]]=this.viewsCode[i[0]+"."+i[3]]||n)}r.call(this,{node:e.node[n.get("code")],parent:n.get("id"),code:s})}}};r.call(this,{node:this.viewsTree,parent:null})},initViewAttr:function(e){var t=this;t.viewAttrsMap[e.get("id")]=e,t.viewsMap[e.get("view")].attrs[e.get("code")]=e},initViewAttrs:function(e){var t=this;t.viewAttrsMap=t.viewAttrsMap||{};for(var n=0;n<t.store.viewAttrs.getCount();n++){var r=this.store.viewAttrs.getAt(n);t.viewAttrsMap[r.get("id")]=r,t.viewsMap[r.get("view")]&&(t.viewsMap[r.get("view")].attrs=t.viewsMap[r.get("view")].attrs||{},t.viewsMap[r.get("view")].attrs[r.get("code")]=r)}},getClass:function(e){if(!e)return e;if("number"==typeof e){if(this.classesMap[e])return this.classesMap[e];throw new Error("getClass - Unknown classId: "+e)}if(e&&e.id){if(this.classesMap[e.id])return this.classesMap[e.id];throw new Error("getClass - Unknown classId: "+e.id)}var t=e.classCode||e.code;if("string"==typeof e&&(t=e),this.classesCode[t])return this.classesCode[t];throw new Error("getClass - Unknown classCode: "+t)},getClassAttr:function(e){if(this.classAttrsMap[e])return this.classAttrsMap[e];throw new Error("getClassAttr - Unknown id: "+e)},getView:function(e){if(!e)return e;if("number"==typeof e){if(this.viewsMap[e])return this.viewsMap[e];throw new Error("getView - Unknown viewId: "+e)}if(e&&e.id){if(this.viewsMap[e.id])return this.viewsMap[e.id];throw new Error("getView - Unknown viewId: "+e.id)}var t=e.viewCode||e.code;if("string"==typeof e&&(t=e),this.viewsCode[t])return this.viewsCode[t];throw new Error("getView - Unknown viewCode: "+t)},getViewAttr:function(e){if(this.viewAttrsMap[e])return this.viewAttrsMap[e];throw new Error("getViewAttr - Unknown id: "+e)},getAction:function(id){if(!id)return null;if("string"==typeof id&&id.indexOf(".")>-1)for(var i in this.actionsMap)if(this.actionsMap[i].getFullCode()==id)return this.actionsMap[i];if(this.actionsMap[id])return this.actionsMap[id];var storage=this,r=Ext.Ajax.request({async:!1,url:"?sessionId="+$sessionId,params:storage.code+".Action.get("+("string"==typeof id?'"'+id+'"':id)+")"});if(r=eval("("+r.responseText+")"),!r.data.length)return null;for(var o=Ext.create("$o.Action.Model"),i=0;i<r.data.length;i++)o.set(o.fieldsArray[i],r.data[i]);return this.actionsMap[o.get("id")]=o,o},getObject:function(id){if(!id)return null;if(this.objectsMap[id])return this.objectsMap[id];var r=Ext.Ajax.request({async:!1,url:"?sessionId="+this.sessionId,params:this.code+".Storage.getObject("+id+")"}),d=eval("("+r.responseText+")");if(d.data.id){var o=Ext.create("$o.Class."+d.data.classId+".Model",Ext.apply(d.data.attrs,{id:id,classId:d.data.classId}));return o.originalData=$o.util.clone(d.data.attrs),this.objectsMap[id]=o,o}return null},startTransaction:function(options){var description=options?options.description:"",tr=Ext.Ajax.request({async:!1,url:"?sessionId="+this.sessionId,params:this.code+'.Storage.startTransaction("'+description+'")'});return tr=eval("("+tr.responseText+")").data,$o.inTransaction=!0,tr},commitTransaction:function(e){Ext.Ajax.request({async:!1,url:"?sessionId="+this.sessionId,params:this.code+".Storage.commitTransaction("+(e||1)+")"}),$o.inTransaction=!1},rollbackTransaction:function(e){Ext.Ajax.request({async:!1,url:"?sessionId="+this.sessionId,params:this.code+".Storage.rollbackTransaction("+(e||1)+")"}),$o.inTransaction=!1},execute:function(options){if(options=options||{},!options.fn){var asArray=options.asArray;delete options.asArray;var sql=options.sql||options.query||options,r=Ext.Ajax.request({async:!1,url:"?sessionId="+this.sessionId,params:this.code+".Storage.execute([!"+JSON.stringify(sql)+"!])",paramsEncode:!1});options.noException||this.checkException(r);var o=eval("("+r.responseText+")");if(o.header&&o.header.error)return o.header;if(asArray){var r=[];return _.each(o.data,function(e,t){for(var n={},s=0;s<sql.select.length/2;s++)n[sql.select[2*s+1]]=o.data[t][s];r.push(n)}),r}o.data.fields={};for(var j=0;j<sql.select.length/2;j++)o.data.fields[sql.select[2*j+1]]=j,o.data.fields[j]=j;return o.data.get=function(e,t){var n=this.fields[t];if(null==n)throw new Error("result.get: col unknown (row:"+e+",col:"+t+")");var r=this[e][n];return void 0==r&&(r=null),r},o.data}Ext.Ajax.request({url:"plugins/?sessionId="+this.sessionId,params:JSON.stringify(options),success:function(response,opts){var o=eval("("+response.responseText+")");options.success&&options.success(o)},failure:function(e,t){this.checkException(e.responseText)}})},updateViewAttrsType:function(options){var view=options.view,query=view.get("query"),va=view.attrs;if(query){query=eval("("+query+")");for(var attrs={},i=0;i<query.select.length;i++){var qs=query.select[i];if("object"==typeof qs){var alias;for(alias in qs)break;attrs[query.select[i+1]]={alias:alias,attr:qs[alias]}}}for(var aliasClass={},i=0;i<query.from.length;i++){var qf=query.from[i];if("object"==typeof qf){var alias;for(alias in qf)break;i&&"left-join"!=query.from[i-1]&&"inner-join"!=query.from[i-1]||(aliasClass[alias]=qf[alias])}}for(var code in attrs){var attr=attrs[code],c=$o.getClass({code:aliasClass[attr.alias]});va[code]&&(va[code].set("class",c.get("id")),va[code].set("classAttr","id"!=attr.attr&&c.attrs[attr.attr]?c.attrs[attr.attr].get("id"):null))}}},createObject:function(e,t){if(this.isReadOnly())throw common.message($o.getString("Can't change data")),new Error($o.getString("Can't change data"));var n=this.getClass(e).get("id"),r="local"==t?"root":null;this.nextLocalId=this.nextLocalId||-1;var s=Ext.create("$o.Class."+n+".Model",{id:r?this.nextLocalId:null,classId:n});return s.local=r,s.localChilds={},s.originalData={classId:n},r&&(this.objectsMap[this.nextLocalId]=s,this.nextLocalId--),this.fireEvent("afterCreateObject",{classId:n,object:s}),s},removeObject:function(e){if(this.isReadOnly())throw common.message($o.getString("Can't change data")),new Error($o.getString("Can't change data"));e&&(this.fireEvent("beforeRemoveObject",{objectId:e}),Ext.Ajax.request({async:!1,url:"?sessionId="+this.sessionId,params:this.code+".Object.remove("+e+")"}),delete this.objectsMap[e])},createClass:function(e){var t=Ext.create("$o.Class.Model");for(var n in e)t.set(n,e[n]);return t},createClassAttr:function(e){var t=Ext.create("$o.ClassAttr.Model");for(var n in e){var r=n;"typeId"==r&&(r="type"),"classId"==r&&(r="class"),t.set(r,e[n])}return t},createView:function(e){var t=Ext.create("$o.View.Model");for(var n in e)t.set(n,e[n]);return t},createViewAttr:function(e){var t=Ext.create("$o.ViewAttr.Model");for(var n in e)t.set(n,e[n]);return t},createAction:function(e){var t=Ext.create("$o.Action.Model");for(var n in e)t.set(n,e[n]);return t},updateDefaultView:function(){var e,t=this;if(t.get("view"))try{e=$o.getView(t.get("view"))}catch(e){}e||(e=$o.createView(),e.set("class",t.get("id")),e.set("system",1),e.set("name",t.get("name")),e.set("code","classView."+t.getFullCode()),e.sync(),t.set("view",e.get("id")),t.sync());var n=1;for(var r in e.attrs)e.attrs[r].order&&e.attrs[r].order>=n&&(n=e.attrs[r].order+1);var s=["id"],i={select:[{a:"id"},"id"],from:[{a:t.getFullCode()}],order:[{a:"id"}]};if(!e.attrs.id){var o=$o.createViewAttr({name:"id",code:"id",view:e.get("id"),area:1,width:50,class:t.get("id"),order:n++,classAttr:null});o.sync()}for(var r in t.attrs){var a=t.attrs[r];if(s.push(r),!e.attrs[r]){var o=$o.createViewAttr({name:a.get("name"),code:r,view:e.get("id"),area:1,width:75,class:t.get("id"),order:n++,classAttr:a.get("id")});o.sync()}i.select.push({a:r}),i.select.push(r)}var l={olap:{id:"cmp-1",classView:t.getFullCode()}};i=JSON.stringify(i,null,"\t"),l=JSON.stringify(l,null,"\t"),e.get("query")==i&&e.get("layout")==l||(e.set("query",i),e.set("layout",l),e.sync());for(var r in e.attrs)if(s.indexOf(r)==-1){var o=e.attrs[r];o.remove(),o.sync()}},updateDefaultActions:function(){for(var e=this,t=common.execSQL({select:[{a:"___fid"},"id",{a:"___fcode"},"code"],from:[{a:"system.action"}],where:[{a:"___fend_id"},"=",2147483647,"and",{a:"___fclass_id"},"=",e.get("id")],order:[{a:"___fid"}]}),n={},r=0;r<t.length;r++)n[t.get(r,"code")]=t.get(r,"id");var s,i='var me = this;\nvar id = options.id || me.getValue ("id");\ncommon.tpl.show.call (this, {\n\tid: id,\n\tasWindow: 1,\n\treadOnly: options.readOnly,\n\tlayout: common.tpl.updateTags (\n\t\t'+e.getFullCode()+".card.layout, {\n\t\t\tid: id\n\t\t}\n\t)\n});\n";if(!n.card){var s=$o.createAction();s.set("class",e.get("id")),s.set("name",$o.getString("Open")),s.set("code","card"),s.set("layout",JSON.stringify({type:"card",layout:{card:{id:"card",items:[],object:[{cls:e.getFullCode(),tag:"[#id]"}]}}},null,"\t")),s.set("body",i),s.sync(),s.initAction()}var o,a='common.tpl.create.call (this, {\n\tasWindow: 1,\n\tclassCode: "'+e.getFullCode()+'",\n\tfn: function (o, options) {\n\t\toptions.layout = common.tpl.updateTags (\n\t\t\t'+e.getFullCode()+'.card.layout, {\n\t\t\t\tid: o.get ("id")\n\t\t\t}\n\t\t)\n\t}\n});\n';n.create||(o=$o.createAction(),o.set("class",e.get("id")),o.set("name",$o.getString("Add")),o.set("code","create"),o.set("layout",'{"type": "create"}'),o.set("body",a),o.sync(),o.initAction());var l,c="common.tpl.remove.call (this);\n";n.remove||(l=$o.createAction(),l.set("class",e.get("id")),l.set("name",$o.getString("Remove")),l.set("code","remove"),l.set("layout",'{"type": "remove"}'),l.set("body",c),l.sync(),l.initAction())},getConfObject:function(e,t){var n;switch(e){case"class":n=$o.getClass(t);break;case"classAttr":n=$o.getClassAttr(t);break;case"view":n=$o.getView(t);break;case"viewAttr":n=$o.getViewAttr(t);break;case"action":n=$o.getAction(t)}return n},getRevisions:function(){var r=Ext.Ajax.request({async:!1,url:"get_revisions?sessionId="+$sessionId,params:"getRevisions ()"});return r=eval("("+r.responseText+")")},setRevision:function(revisionId){revisionId=revisionId||"";var r=Ext.Ajax.request({async:!1,url:"set_revision?sessionId="+$sessionId+"&id="+revisionId,params:"setRevision ("+revisionId+")"});return r=eval("("+r.responseText+")"),this.objectsMap={},this.revision=revisionId,this.app.tp.removeAll(),this.app.tp.doLayout(),r},copyFile:function(e){Ext.Ajax.request({async:!1,url:"copy_file?sessionId="+$sessionId+"&src_object_id="+e.src.objectId+"&src_class_attr_id="+e.src.classAttrId+"&dst_object_id="+e.dst.objectId+"&dst_class_attr_id="+e.dst.classAttrId+"&filename="+e.filename})},saveToFile:function(e){Ext.Ajax.request({async:!1,params:e.data,url:"save_to_file?sessionId="+$sessionId+"&object_id="+e.objectId+"&class_attr_id="+e.classAttrId+"&filename="+e.filename})},isReadOnly:function(){if($o.userId){var e=$o.getObject($o.userId);return e.get("readOnly")}return!1},getString:function(e){return $o.locale.getString(e)},queueFn:[],pushFn:function(e){var t=this;t.queueFn.push(e)},executeQueueFunctions:function(e){var t=this;_.each(t.queueFn,function(e){e()})}}),$o.util={},$o.util.clone=function(e){if(!e||"object"!=typeof e)return e;if("object"==typeof e&&e&&e.getMonth)return new Date(e.getTime());var t,n,r="function"==typeof e.pop?[]:{};for(t in e)e.hasOwnProperty(t)&&(n=e[t],n&&"object"==typeof n?r[t]=$o.util.clone(n):r[t]=n);return r},$o.util.setCookie=function(e,t,n,r,s,i){var o=e+"="+escape(t),a=new Date;a.setDate(a.getDate()+30),r=r||a,r&&(o+="; expires="+r.toStringOriginal()),n&&(o+="; path="+escape(n)),s&&(o+="; domain="+escape(s)),i&&(o+="; secure"),document.cookie=o},$o.util.removeCookie=function(e){var t=new Date;t.setTime(t.getTime()-1),document.cookie=e+="=; expires=-1"},$o.util.getCookie=function(e){var t=document.cookie.match("(^|;) ?"+e+"=([^;]*)(;|$)");return t?unescape(t[2]):null},$o.util.getStyle=function(e){for(var t,n=document.styleSheets[0].rules||document.styleSheets[0].cssRules,r=0;r<n.length;r++)if(n[r].selectorText==e){t=n[r].cssText?n[r].cssText:n[r].style.cssText;break}return t},$o.util.isEmptyObject=function(e){if(!e)return!0;for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0},$o.util.loadCSS=function(e,t){var n=document.createElement("link");n.setAttribute("rel","stylesheet"),n.setAttribute("type","text/css"),n.setAttribute("href",e),t&&(void 0===n.onreadystatechange?n.onload=t:n.onreadystatechange=function(){"complete"!=this.readyState&&"loaded"!=this.readyState||t()}),document.getElementsByTagName("head")[0].appendChild(n)},$o.util.loadJS=function(e,t){var n=document.createElement("script");n.src=e,n.type="text/javascript",n.language="javascript";var r=document.getElementsByTagName("head")[0];t&&(void 0===n.onreadystatechange?n.onload=t:n.onreadystatechange=function(){"complete"!=this.readyState&&"loaded"!=this.readyState||t()}),r.appendChild(n)},$o.util.sha1=hex_sha1,$zu=$o.util,"object"!=typeof JSON&&(JSON={}),function(){"use strict";function f(e){return e<10?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,r,s,i,o,a=gap,l=t[e];switch(l&&"object"==typeof l&&"function"==typeof l.toJSON&&(l=l.toJSON(e)),"function"==typeof rep&&(l=rep.call(t,e,l)),typeof l){case"string":return quote(l);case"number":return isFinite(l)?String(l):"null";case"boolean":case"null":return String(l);case"object":if(!l)return"null";if(gap+=indent,o=[],"[object Array]"===Object.prototype.toString.apply(l)){for(i=l.length,n=0;n<i;n+=1)o[n]=str(n,l)||"null";return s=0===o.length?"[]":gap?"[\n"+gap+o.join(",\n"+gap)+"\n"+a+"]":"["+o.join(",")+"]",gap=a,s}if(rep&&"object"==typeof rep)for(i=rep.length,n=0;n<i;n+=1)"string"==typeof rep[n]&&(r=rep[n],s=str(r,l),s&&o.push(quote(r)+(gap?": ":":")+s));else for(r in l)Object.prototype.hasOwnProperty.call(l,r)&&(s=str(r,l),s&&o.push(quote(r)+(gap?": ":":")+s));return s=0===o.length?"{}":gap?"{\n"+gap+o.join(",\n"+gap)+"\n"+a+"}":"{"+o.join(",")+"}",gap=a,s}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(e){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(e){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(e,t,n){var r;if(gap="",indent="","number"==typeof n)for(r=0;r<n;r+=1)indent+=" ";else"string"==typeof n&&(indent=n);if(rep=t,t&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw new Error("JSON.stringify");return str("",{"":e})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(e,t){var n,r,s=e[t];if(s&&"object"==typeof s)for(n in s)Object.prototype.hasOwnProperty.call(s,n)&&(r=walk(s,n),void 0!==r?s[n]=r:delete s[n]);return reviver.call(e,t,s)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),Ext.define("$o.Base.Grid",{createButton:function(action){var me=this,item={scope:me,handler:function(){if(action.type&&"report"==action.type)me.report(action);else if(_fn){item.noTransaction=item.noTransaction||(item.arguments?item.arguments.noTransaction:null);try{_fn="string"==typeof _fn?eval("("+_fn+")"):_fn}catch(e){throw common.message($o.getString("Function not exists")+": "+_fn),new Error("action.fn exception: "+_fn+"\nexception: "+e)}item.noTransaction||$o.startTransaction({description:"***prepare_transaction*** action started"});var a=$o.util.clone(item.arguments);if($o.debug||a&&a.debug)_fn.call(me,a||{}),item.noTransaction||$o.commitTransaction();else try{_fn.call(me,a||{}),item.noTransaction||$o.commitTransaction()}catch(e){throw item.noTransaction||$o.rollbackTransaction(),console.log(e.stack),new Error(e)}}}};if(Ext.apply(item,action),action.code&&(item.text=$o.locale.getString(action.code),item.iconCls=action.code),item.iconCls=item.iconCls||item.icon,item.text=$o.locale.getString(action.text||action.caption),action.actions){item.menu={items:[]};for(var i=0;i<action.actions.length;i++)item.menu.items.push(me.createButton(action.actions[i]))}var _fn=item.fn||item.id;return item.id=void 0,item},report:function(e){var t=this,n=function(){var n,r="report?";for(n in e.arguments)r+=Ext.isArray(e.arguments[n])?n+"="+t.zview.getCurrentValue(e.arguments[n][0],e.arguments[n][1])+"&":n+"="+e.arguments[n]+"&";r+="storage="+$o.code+"&sessionId="+$sessionId+"&username="+$o.currentUser+"&time_offset_min="+(new Date).getTimezoneOffset();var s=window.open(r);s.focus()};if(e.fn){e.arguments.success=function(){n()};try{e.fn.call(t,e.arguments)}catch(e){return void alert(e)}}e.arguments.hasCallback||n(t)},createViewModel:function(e){var t=e.view;t.get("id");$o.updateViewAttrsType({view:t});var n=[];for(var r in t.attrs){var s=t.attrs[r],i=null==s.get("classAttr")?"number":$o.classAttrsMap[s.get("classAttr")].getDataType(),o=null==s.get("classAttr")?"numeric":$o.classAttrsMap[s.get("classAttr")].getFilterDataType();n.push({name:s.get("code"),header:s.get("name"),type:i,filterType:o,order:s.get("order"),id:s.get("id"),area:s.get("area"),width:s.get("width"),useNull:!0})}return n.sort(function(e,t){return null!==e.order&&null!==t.order&&e.order<t.order?-1:null!=e.order&&null==t.order?-1:e.order==t.order&&e.id<t.id?-1:null!==e.order&&null!==t.order&&e.order>t.order?1:null==e.order&&null!=t.order?1:e.order==t.order&&e.id>t.id?1:0}),t.orderedFields=$o.util.clone(n),n},beforeSelectListener:function(e){},selectionChangeListener:function(e){for(var t in this.targets){var n=this.targets[t];n.refresh&&n.refresh({moveFirst:1})}this.checkActions()},checkActions:function(){var tbar=this.getDockedItems("toolbar[dock='top']")[0];if(tbar)for(var i=0;i<tbar.items.getCount();i++){var b=tbar.items.getAt(i);if(b.active){var fn,args;"function"==typeof b.active?fn=b.active:"string"==typeof b.active?fn=eval(b.active):"object"==typeof b.active&&(fn=b.active.fn,args=b.active.arguments);var active=fn.call(this,args);active?b.enable():b.disable()}}},buildToolbar:function(){var e=this;if(e.actions){for(var t=[],n=0;n<e.actions.length;n++)t.push(e.createButton(e.actions[n]));t.length&&(e.dockedItems=e.dockedItems||[],e.dockedItems.push({xtype:"toolbar",dock:e.actionsDock||"top",items:t}))}},getCurrentValue:function(e){var t;if(this.getSelectionModel().hasSelection()){var n=this.getSelectionModel().getSelection()[0];t=n.get(e)}return t},getValue:function(e){return this.getCurrentValue(e)},getCurrentValues:function(e){var t=[];if(this.getSelectionModel().hasSelection())for(var n=this.getSelectionModel().getSelection(),r=0;r<n.length;r++)t.push(n[r].get(e));return t},getValues:function(e){return this.getCurrentValues(e)},getUserFilter:function(){var e=this;if(!e.filters)return[];for(var t=e.filters.getFilterData(),n=[],r={eq:"=",lt:"<",gt:">",neq:"<>",lte:"<=",gte:">="},s=0;s<t.length;s++){s&&n.push("and");var i=t[s];if(i.data.type&&"boolean"==i.data.type)i.data.value?n.push([i.field,"=",1]):n.push([i.field,"=",0,"or",i.field,"is null"]);else{n.push(i.field);var o="like";i.data.comparison&&(o=r[i.data.comparison]);var a=i.data.value;"like"==o&&a&&("object"==typeof a?(a.notLike&&(o="not like"),a.value.indexOf(",")>-1?(o=a.notLike?"not in":"in",i.data.value=a.value.split(",").join(".,.").split(".")):i.data.value=a.value+"%"):i.data.value+="%"),n.push(o),n.push(i.data.value)}}return n},getFilter:function(){var me=this,cf=[],uf=me.getUserFilter();if(!me.filter)return uf;"string"==typeof me.filter&&(me.filter={fn:eval(me.filter)}),"function"==typeof me.filter&&(me.filter={fn:me.filter});var disabled=!1,get=function(e){if("[object Array]"===Object.prototype.toString.apply(e)){for(var t=[],n=0;n<e.length;n++)t.push(get(e[n]));return t}if("object"==typeof e&&e.id){me.relatives[e.id].targets[me.zid]=me;var r=me.zview.getCurrentValue(e.id,e.attr);return void 0==r?(me.setDisabled(!0),void(disabled=!0)):(me.setDisabled(!1),r)}return e};if(me.filter.fn){if(cf=me.filter.fn.call(me,me.filter.arguments),cf=get(cf),disabled&&(cf=void 0),void 0==cf)return void me.setDisabled(!0);me.setDisabled(!1)}else cf=get(me.filter),disabled&&(cf=void 0);return"[object Array]"===Object.prototype.toString.apply(cf)&&(cf.length&&uf.length&&cf.push("and"),cf=cf.concat(uf)),cf},getFullFilter:function(){return this.getFilter()},cellRenderer:function(value,metaData,record,rowIndex,colIndex,store){if(metaData.userStyle=void 0,this.lconfig&&this.lconfig.listeners&&this.lconfig.listeners.cellRenderer){"string"==typeof this.lconfig.listeners.cellRenderer&&(this.lconfig.listeners.cellRenderer=eval(this.lconfig.listeners.cellRenderer));var scope=this.lconfig.listeners.cellRenderer.scope||this.lconfig.listeners.scope||this;"view"==scope&&(scope=this.zview),"this"===scope&&(scope=this);var _fn=this.lconfig.listeners.cellRenderer.fn||this.lconfig.listeners.cellRenderer;"string"==typeof _fn&&(_fn=eval(_fn)),value=_fn.call(scope,value,metaData,record,rowIndex,colIndex,store,this.lconfig.listeners.cellRenderer.arguments)}if(value){var tip=value;"string"==typeof tip&&(tip=tip.split('"').join("'")),metaData.tdAttr='data-qtip="'+tip+'"'}if(metaData.userStyle){var style="";style+=metaData.userStyle||"",metaData.tdAttr+=' style="'+style+'"'}return this.wordWrap&&(metaData.style="white-space: normal;"),value},userEventListener:function(options){if(this.lconfig){var listeners=this.lconfig.listeners,scope=this;if(listeners&&listeners.scope&&(scope=listeners.scope),listeners&&listeners[options.event])if(listeners[options.event].fn){listeners[options.event].scope&&(scope=listeners[options.event].scope);var fn="string"==typeof listeners[options.event].fn?eval("("+listeners[options.event].fn+")"):listeners[options.event].fn,arguments=$o.util.clone(listeners[options.event].arguments);fn.call(scope,arguments||{})}else{var fn="string"==typeof listeners[options.event]?eval("("+listeners[options.event]+")"):listeners[options.event];fn.call(scope,{})}}},getGroupedColumns:function(e){var t=function(e){for(var t=function(e){for(var t=0,n=0;n<e.length;n++){var r=e[n].split(":");r.length>t&&(t=r.length)}return t}(e),n=[],r=0;r<e.length;r++){for(var s=e[r].split(":"),i=0;i<s.length;i++)s[i]={text:s[i].trim(),colspan:1,rowspan:1};for(var i=0,o=t-s.length;i<o;i++)s.push({text:null,colspan:1,rowspan:1});n.push(s)}for(var r=1;r<e.length;r++)for(var i=0;i<t;i++){var a=n[r-1][i].hasOwnProperty("ref")?n[r-1][i].ref:r-1;null!=n[r][i].text&&n[r][i].text==n[a][i].text&&(n[a][i].colspan++,
n[r][i].ref=a)}for(var r=0;r<e.length;r++)for(var i=1;i<t;i++){var l=n[r][i-1].hasOwnProperty("refR")?n[r][i-1].refR:i-1;null==n[r][i].text&&(n[r][l].rowspan++,n[r][i].refR=l)}for(var c=[],r=0;r<t;r++){for(var d=[],u=1,i=0;i<e.length;i++)n[i][r].hasOwnProperty("refR")?u+=n[i][r].colspan:n[i][r].hasOwnProperty("ref")||(d.push({text:n[i][r].text,colspan:n[i][r].colspan,rowspan:n[i][r].rowspan,index:u}),u+=n[i][r].colspan);c.push(d)}return c},n=function(e,t){var n=function(r,s){var i=[];return _.each(e[r],function(o){if(!s||o.index>=s.index&&o.index<s.index+s.colspan){var a=[];r+1<e.length&&(a=n(r+1,o)),a.length?i.push({text:o.text,columns:a}):(t[o.index-1].header=o.text,t[o.index-1].tooltip=o.text,i.push(t[o.index-1]))}}),i},r=n(0);return r},r=t(_.map(e,function(e){return e.header})),s=n(r,e);return s}}),Ext.define("$o.Grid.Widget",{extend:"Ext.grid.Panel",mixins:{baseGrid:"$o.Base.Grid"},alias:["widget.$o.grid"],columnLines:!0,rowLines:!0,total:{},totalValues:{},groupedColumns:!0,initComponent:function(){function e(){var e=$o.inTransaction;e||$o.startTransaction(),s.updateDefault(),e||$o.commitTransaction()}var t,n,r=this;if(r.classView){var s=$o.getClass(r.classView);if(s.get("view")||e(),t=$o.getView(s.get("view")),r.recreateView||t.get("query").indexOf("left-join")>-1){var i=$o.inTransaction;i||$o.startTransaction(),t.remove(),t.sync(),s.set("view",null),s.sync(),e(),i||$o.commitTransaction()}n=s.get("view")}else t=r.queryId?$o.viewsMap[r.queryId]:$o.getView({code:r.$query}),n=r.viewId=t.get("id");r.$view=t;t.get("query");delete r.query;var o=r.createViewModel({view:t});r.columns=[];for(var a=0;a<o.length;a++){var l=o[a],c={header:l.header,tooltip:l.header,dataIndex:l.name,hidden:1!=l.area,width:l.width,filter:{type:l.filterType},$field:l,renderer:r.cellRenderer,scope:r,summaryType:"count",summaryRenderer:r.summaryRenderer};"bool"==l.type&&(c.renderer=function(e,t,n,s,i,o){return e=e?$o.getString("Yes"):$o.getString("No"),r.cellRenderer(e,t,n,s,i,o)}),r.columns.push(c)}if(r.groupedColumns&&(r.columns=r.getGroupedColumns(r.columns)),_.each(r.fields,function(e){e.header=""}),Ext.define("$o.View."+n+".Model",{extend:"Ext.data.Model",fields:o}),r.store=Ext.create("Ext.data.Store",{model:"$o.View."+n+".Model",pageSize:30,remoteSort:!0,clearOnPageLoad:!0,proxy:{type:"ajax",api:{create:"view?create=1&id="+n+"&cmpId="+r.id,read:"view?read=1&id="+n+"&cmpId="+r.id,update:"view?update=1&id="+n+"&cmpId="+r.id,delete:"view?delete=1&id="+n+"&cmpId="+r.id},reader:{type:"json",root:"data"}},listeners:{load:function(e,t,n){r.down("*[name=rowsNum]")&&r.down("*[name=rowsNum]").setText("-: "+(r.countOverflow?">":"")+this.totalCount),r.needReconfigureColumns&&(r.needReconfigureColumns=!1,r.reconfigureColumns())}}}),r.dockedItems=r.dockedItems||[],!r.hideBottomToolbar){var d=[];r.hidePrint||d.push({iconCls:"gi_print",tooltip:"",menu:{items:[{text:"*.xml ("+$o.getString("Table")+" XML - Microsoft Excel)",iconCls:"gi_print",handler:function(){r.printOlap.call(this,"xmlss")}},{text:"*.csv (CSV - "+$o.getString("encoding")+" win-1251)",iconCls:"gi_print",handler:function(){r.printOlap.call(this,"csv","win1251")}},{text:"*.csv (CSV - "+$o.getString("encoding")+" utf-8)",iconCls:"gi_print",handler:function(){r.printOlap.call(this,"csv","utf8")}},{text:"*.xlsx (XLSX - Microsoft Excel)",iconCls:"gi_print",handler:function(){r.printOlap.call(this,"xlsx")}},{text:"*.pdf (PDF)",iconCls:"gi_print",hidden:!common.getConf({code:"reportPDF"}).used,handler:function(){r.printOlap.call(this,"pdf")}},{text:"*.ods (ODF - Open Document Format)",iconCls:"gi_print",handler:function(){r.printOlap.call(this,"ods")}}]}}),r.hideHeaders||(d.push({iconCls:"gi_restart",tooltip:$o.getString("Reset filters and totals"),handler:function(){r.filters.clearFilters(),r.total={},r.totalValues={};var e=r.down("*[itemId=summaryBar]");e.hide(),r.refresh()}}),d.push({xtype:"label",name:"rowsNum",text:""})),r.dockedItems.push({xtype:"pagingtoolbar",store:r.store,dock:"bottom",beforePageText:"",afterPageText:$o.getString("of")+" {0}",items:d})}r.filters={ftype:"filters",encode:!0,local:!1},r.features=[r.filters,{ftype:"summary",dock:"bottom",name:"summary"}],r.buildToolbar(),r.on("beforerender",r.beforeRenderListener,r),r.on("render",r.renderListener,r),r.on("itemdblclick",function(){r.userEventListener({event:"dblclick"})},r),r.selModel=r.selModel||Ext.create("Ext.selection.RowModel",{mode:0==r.singleSelect?"MULTI":"SINGLE",listeners:{beforeselect:{fn:r.beforeSelectListener,scope:r},selectionchange:{fn:r.selectionChangeListener,scope:r}}}),r.relatives=r.relatives||{},r.relatives[r.zid]=r,r.targets={},Ext.ux.grid.FiltersFeature.prototype.menuFilterText=$o.getString("Filter"),Ext.ux.grid.filter.BooleanFilter.prototype.yesText=$o.getString("Yes"),Ext.ux.grid.filter.BooleanFilter.prototype.noText=$o.getString("No"),Ext.ux.grid.filter.DateFilter.prototype.beforeEqText=$o.getString("Less or equal"),Ext.ux.grid.filter.DateFilter.prototype.beforeText=$o.getString("Less"),Ext.ux.grid.filter.DateFilter.prototype.afterEqText=$o.getString("More or equal"),Ext.ux.grid.filter.DateFilter.prototype.afterText=$o.getString("More"),Ext.ux.grid.filter.DateFilter.prototype.nonText=$o.getString("Not equal"),Ext.ux.grid.filter.DateFilter.prototype.onText=$o.getString("Equal"),Ext.ux.grid.filter.DateFilter.prototype.dateFormat="d.m.Y",Ext.ux.grid.menu.RangeMenu.prototype.menuItemCfgs.emptyText=$o.getString("Enter number")+" ...",r.on("columnshow",function(){r.needReconfigureColumns=!0}),r.addEvents("refresh"),r.callParent(arguments)},beforeRenderListener:function(){this.getFilter()&&this.store.load()},renderListener:function(){var e=this;if(e.checkActions(),$o.util.isEmptyObject(e.total)){var t=e.down("*[itemId=summaryBar]");t&&t.hide()}var n=function(){this.down("*[name=totals]")&&this.remove(this.down("*[name=totals]"));for(var t=e.query("gridcolumn"),n=0,s=0;s<t.length;s++)if(t[s].$field&&t[s].$field.name==r.activeHeader.dataIndex){"number"==t[s].$field.type&&(n=1);break}n&&this.add([{text:$o.getString("Totals"),name:"totals",iconCls:"gi_calculator",menu:{defaults:{handler:function(){e.total[r.activeHeader.dataIndex]=this.name,e.refresh();var t=e.down("*[itemId=summaryBar]");t.show()}},items:[{text:$o.getString("Sum"),iconCls:"gi_calculator",name:"sum"},{text:$o.getString("Average"),iconCls:"gi_calculator",name:"avg"},{text:$o.getString("Max"),iconCls:"gi_calculator",name:"max"},{text:$o.getString("Min"),iconCls:"gi_calculator",name:"min"}]}}])},r=e.headerCt.getMenu();r.on("activate",n),e.on("reconfigure",function(){r=e.headerCt.getMenu(),r.on("activate",n)})},summaryRenderer:function(e,t,n){var r=t.column.dataIndex;return this.totalValues[r]},refresh:function(e){var t=this;if(t.getFilter()){if(e&&e.moveFirst){var n=t.getDockedItems("pagingtoolbar");n&&n.length&&n[0].moveFirst()}t.store.reload(e),t.checkActions()}for(var r in t.targets){var s=t.targets[r];s.refresh&&s.refresh({moveFirst:1})}t.fireEvent("refresh")},reconfigureColumns:function(){for(var e=this,t=[],n=e.down("headercontainer").getGridColumns(),r=0;r<n.length;r++){var s=n[r],i={header:s.text,tooltip:s.tooltip,dataIndex:s.dataIndex,hidden:s.hidden,width:s.width,filter:{type:s.filter.type},$field:s.$field,renderer:s.renderer,scope:s.scope};t.push(i)}e.reconfigure(null,t)},selectRow:function(options){var me=this,viewFilter=me.getFilter(),r=Ext.Ajax.request({url:"?sessionId="+$sessionId,params:$o.code+".View.selectRows("+me.viewId+", null, [!"+Ext.encode({viewFilter:viewFilter,selectFilter:options.filter})+"!])",async:!1}),rows=eval("("+r.responseText+")").data;rows.length>0&&(me.store.getProxy().extraParams={start:Math.floor(rows[0]/me.store.pageSize)*me.store.pageSize,limit:me.store.pageSize},me.store.load(function(){me.getSelectionModel().deselectAll(),me.getSelectionModel().select(rows[0]%me.store.pageSize)}))},printOlap:function(e,t){var n=this,r=n.up("grid").viewId;!r&&n.up("grid").classView&&(r=$o.getClass(n.up("grid").classView).get("view"));var s="report?";s+="format="+e+"&view="+r+"&storage="+$o.code,t&&(s+="&coding="+t);var i,o=n.up("grid"),a=n.up("tabpanel");if(a&&(i=a.getActiveTab().title),i||o.title){var l="";i&&(l+=i),o.title&&(l&&(l+=" - "),l+=o.title),s+="&filename="+l,s+="xmlss"==e?".xml":"."+e}var c,d=o.getStore(),u=JSON.stringify(o.getFilter());c=d.sorters.getCount()?'["'+d.sorters.getAt(0).property+'","'+d.sorters.getAt(0).direction+'"]':"null";var f=new Date;s+="&sessionId="+$sessionId+"&username="+$zp.currentUser+"&time_offset_min="+f.getTimezoneOffset();for(var g=n.up("grid").query("gridcolumn"),m=[],p=0;p<g.length;p++){var h=g[p].$field;if(h){var v={attrId:h.id,attr:h.name,header:h.header,code:h.id,hidden:g[p].hidden?1:0,width:g[p].width||75};m.push(v)}}document.getElementById("loading").innerHTML="<form name='form_report' method='post' action='"+s+"'><textarea style='display: none' name='cols'>"+JSON.stringify(m)+"</textarea><textarea style='display: none' name='filter'>"+u+"</textarea><textarea style='display: none' name='total'>"+JSON.stringify(o.total)+"</textarea><textarea style='display: none' name='order'>"+c+"</textarea><textarea style='display: none' name='options'>"+JSON.stringify({dateAttrs:o.dateAttrs})+"</textarea></form>",document.forms.form_report.submit()}}),$o.pushFn(function(){Ext.define("$o.CompositeField.Widget",{extend:"Ext.form.FieldContainer",alias:"widget.compositefield",layout:"hbox",initComponent:function(){this.callParent(arguments)}}),Ext.define("$o.ObjectField.Widget",{extend:"Ext.form.FieldContainer",alias:["widget.objectfield","widget.$objectfield","widget.$o.objectfield"],layout:"hbox",initComponent:function(){var me=this;me.items=[{xtype:"button",iconCls:"gi_edit",style:{marginRight:1},handler:function(){var me=this;if(!me.ro){me.choose=me.choose||{};var winWidth=me.choose.width||800,winHeight=me.choose.height||600;if(me.choose.fn&&"custom"==me.choose.type)return void me.choose.fn.call(me);me.choose.fn&&me.choose.fn.call(me),me.choose.listeners&&me.choose.listeners.beforeShow&&me.choose.listeners.beforeShow.call(me);var layout,view;if("layout"==me.choose.type)layout=$o.util.clone(me.choose.layout);else if(me.choose.id)view=$o.getView({code:me.choose.id}),layout=view.get("layout")||{olap:{id:"olap",view:me.choose.id}};else{var o=$o.getObject(me.objectId),cls=$o.getClass(o.get("classId")),ca=cls.attrs[me.attr];layout={olap:{id:"olap",classView:ca.get("type")}},me.choose.attr="olap.id"}"string"==typeof layout&&(layout=eval("("+layout+")")),me.fireEvent("beforechoose",{layout:layout});var attrs=me.choose.attr.split("."),olap,view=Ext.create("$o.Layout.Widget",{record:view||$zs.views.ser.card,$layout:layout,listeners:{afterrender:function(){var e;if(attrs.length>1){if(olap=view.relatives[attrs[0]],!olap)return void common.message(" '"+attrs[0]+"'  .");e=olap.getDockedItems("toolbar[dock='top']")[0],e&&(e.insert(0,[btnChoose,btnCancel]),e.doLayout())}else olap=view.items.items[0];if(olap.selModel.on("selectionchange",function(){olap.getCurrentValue(attrs[attrs.length-1])?btnChoose.setDisabled(!1):btnChoose.setDisabled(!0)},this),olap.lconfig&&olap.lconfig.listeners&&olap.lconfig.listeners.dblclick&&delete olap.lconfig.listeners.dblclick,olap.on("itemdblclick",function(){me.onChoose(view),setTimeout(function(){win.close()},100)},me),e||(e=win.getDockedItems("toolbar[dock='top']")[0],e.add([btnChoose,btnCancel]),e.doLayout(),e.setVisible(!0)),me.choose.hideActions)for(var t=win.query("button"),n=0;n<t.length;n++)[$o.getString("Add"),$o.getString("Open"),$o.getString("Remove")].indexOf(t[n].text)>-1&&t[n].hide()},scope:me}}),btnChoose=Ext.create("Ext.Button",{text:$o.getString("Choose"),iconCls:"ok",disabled:!0,handler:function(){me.onChoose(view),win.close()},scope:me}),btnCancel=Ext.create("Ext.Button",{text:$o.getString("Cancel"),iconCls:"cancel",handler:function(){win.close()}}),win=Ext.create("Ext.Window",{title:$o.getString("Choose object"),resizable:!0,closable:!0,height:winHeight,width:winWidth,layout:"fit",modal:!0,tbar:Ext.create("Ext.Toolbar",{hidden:!0}),items:[view]});win.show()}},scope:me},{xtype:"button",iconCls:"gi_remove",style:{marginRight:1},handler:function(){me.setValue(null),me.choose.listeners&&me.choose.listeners.afterChoose&&me.choose.listeners.afterChoose.call(me),me.fireEvent("change",null)}},{xtype:"textfield",flex:1,readOnly:!0,objectField:me,listeners:{render:function(e){me.valueField=e,me.value&&me.setValue(me.value),e.getEl().on("mousedown",function(e,t,n){me.down("button[iconCls=gi_edit]")&&me.down("button[iconCls=gi_edit]").handler.call(me)}),me.getActiveError=function(){return me.valueField.getActiveError.call(me.valueField,arguments)}},focus:function(){me.fireEvent("focus",me)}}}],me.hasOwnProperty("allowBlank")&&(me.items[me.items.length-1].allowBlank=me.allowBlank),me.readOnly&&(me.items.splice(0,2),me.addCls("readonly-field")),this.hasOwnProperty("allowBlank")&&!this.allowBlank&&this.fieldLabel&&(this.fieldLabel=this.fieldLabel+"<span style='color: red !important'>*</span>"),me.addEvents("change","beforechoose"),me.listeners&&me.listeners.beforechoose&&"string"==typeof me.listeners.beforechoose&&(me.listeners.beforechoose=eval(me.listeners.beforechoose)),me.callParent(arguments)},onChoose:function(e){var t,n,r,s=this,i=(s.choose.attr?s.choose.attr:"olap.id").split(".");if(1==i.length){for(t in e.relatives)break;n=i[0]}else t=i[0],n=i[1];var o=s.getValue();r=e.relatives[t].getCurrentValue(n),s.setValue(r),s.choose.listeners&&s.choose.listeners.afterChoose&&s.choose.listeners.afterChoose.call(s,o,r)},setValue:function(e){var t=this;if(t.value=e,e){var n=$o.getObject(e);e=n?n.toString():null}t.valueField&&(t.valueField.setValue(e),e?Ext.tip.QuickTipManager.register({target:t.valueField.id,text:e,width:300,dismissDelay:3e3}):Ext.tip.QuickTipManager.unregister(t.valueField.getEl())),t.fireEvent("change",t.value)},getValue:function(){return this.value},setReadOnly:function(e){var t=this;t.ro=e,e?(t.items.getAt(0).hide(),t.items.getAt(1).hide(),t.addCls("readonly-field")):(t.items.getAt(0).show(),t.items.getAt(1).show(),t.removeCls("readonly-field"))},validate:function(){return this.valueField.validate.call(this.valueField,arguments)},isValid:function(){return this.valueField.isValid.call(this.valueField,arguments)}}),Ext.define("$o.DateTimeField.Widget",{extend:"Ext.form.FieldContainer",alias:["widget.datetimefield","widget.$datetimefield"],layout:"hbox",initComponent:function(){var e=this;e.items=[{xtype:"datefield",width:90,readOnly:e.readOnly,listeners:{render:function(t){e.dateField=t,e.value&&e.setValue(e.value)},focus:function(){e.fireEvent("focus",e)}}},{xtype:"timefield",width:80,readOnly:e.readOnly,style:{marginLeft:1},listeners:{render:function(t){e.timeField=t,e.value&&e.setValue(e.value)},focus:function(){e.fireEvent("focus",e)}}}],e.callParent(arguments)},setValue:function(e){var t=this;t.value=e,t.dateField&&t.timeField&&(t.dateField.setValue(e),t.timeField.setValue(e))},getValue:function(){var e=this.dateField.getValue(),t=this.timeField.getValue();return t&&(e.setHours(t.getHours()),e.setMinutes(t.getMinutes()),e.setSeconds(t.getSeconds())),e}}),Ext.define("$o.MultiSelect.Widget",{extend:"Ext.panel.Panel",alias:"widget.$multiselect",border:!0,layout:"fit",initComponent:function(){var e=this;e.title=e.fieldLabel||e.title;var t={render:function(t){e.$multiselect=t}};e.listeners&&e.listeners.change&&(t.change=e.listeners.change),e.items={xtype:"multiselect",store:e.store,valueField:e.valueField,displayField:e.displayField,ddReorder:e.ddReorder,listeners:t},e.callParent(arguments)},getStore:function(){return this.$multiselect.getStore()},getValue:function(){return this.$multiselect.getValue()}}),Ext.define("$o.FileField.Widget",{extend:"Ext.form.FieldContainer",alias:"widget.$filefield",layout:"hbox",initComponent:function(){var e=this;e.items=[{xtype:"button",iconCls:"gi_upload",tooltip:$o.getString("Choose and upload file"),disabled:e.readOnly,style:{marginRight:1},handler:function(){var t=Ext.create("Ext.form.field.File",{fieldLabel:$o.getString("File"),buttonText:$o.getString("Choose"),name:"file-path"}),n=Ext.create("Ext.form.Panel",{defaults:{anchor:"95%"},bodyStyle:"padding: 10px 10px 0 10px;",items:[{hidden:!0,xtype:"textfield",name:"objectId",value:e.objectId},{hidden:!0,xtype:"textfield",name:"classAttrId",value:e.ca.get("id")},t],buttons:[{text:$o.getString("Upload"),iconCls:"gi_upload",handler:function(){e.card.save({autoSave:!0}),n.down("textfield[name=objectId]").setValue(e.objectId),n.getForm().submit({url:"upload?sessionId="+$sessionId+"&username="+$o.currentUser,waitMsg:$o.getString("File uploading")+" ...",success:function(t,n){n.result.success?(e.setValue(n.result.file),e.card.save(),r.close(),common.message($o.getString("File")+" "+n.result.file+" "+$o.getString("uploaded"))):common.message($o.getString("File")+" "+n.result.file+" "+$o.getString("failed to send"))},failure:function(e,t){common.message($o.getString("File","failed to send",".","Error",": ")+t.result.error)}})}},{text:$o.getString("Remove"),iconCls:"gi_remove",handler:function(){e.getValue()&&common.confirm({message:$zr.getString("Are you sure?"),scope:this,fn:function(t){"yes"==t&&(e.setValue(null),e.card.save({filefield:!0}))}})}}]}),r=new Ext.Window({title:$o.getString("File uploading"),resizable:!1,closable:!0,height:114,width:500,layout:"fit",modal:!0,items:n});r.show()},scope:e},{xtype:"button",iconCls:"gi_download",tooltip:$o.getString("Download"),disabled:e.readOnly,style:{marginRight:1},handler:function(){e.download()}},{xtype:"textfield",flex:1,readOnly:!0,listeners:{render:function(t){e.value&&e.setValue(e.value)}}}],e.callParent(arguments)},setValue:function(e){this.down("field").setValue(e)},getValue:function(){return this.down("field").getValue()},setReadOnly:function(e){var t=this;e?(t.items.getAt(0).hide(),t.items.getAt(1).hide(),t.addCls("readonly-field")):(t.items.getAt(0).show(),t.items.getAt(1).show(),t.removeCls("readonly-field"))},download:function(){var e=this,t=e.getValue();if(t){var n="files/"+e.objectId+"-"+e.ca.get("id")+"-"+t,r=window.open(n);r.focus()}}}),Ext.define("$o.ConfField.Widget",{extend:"$o.ObjectField.Widget",alias:["widget.conffield","widget.$conffield"],initComponent:function(){var e=this;e.addEvents("change"),e.callParent(arguments),e.setValue=function(e){var t=this;if(t.value=e,e){var n=$o.getConfObject(t.confRef,e);e=n.toString()}t.valueField&&t.valueField.setValue(e),t.fireEvent("change",t.value)}}}),Ext.define("$o.CodeMirrorTextArea.Widget",{extend:"Ext.panel.Panel",alias:["widget.codemirrortextarea"],layout:"fit",border:0,initComponent:function(){var e=this;e.items={xtype:"textarea",width:"100%",height:"100%",value:e.value,listeners:{afterrender:function(){var t=this;dom=t.inputEl.dom;var n=function(){e.editor=CodeMirror.fromTextArea(dom,{lineNumbers:!0,indentUnit:4,readOnly:!1,mode:e.mode||"javascript",viewportMargin:1/0}),e.editor.setSize(t.getWidth(),t.getHeight()),e.editor.on("change",function(){e.fireEvent("change")})};window.CodeMirror?n():$o.util.loadCSS("/third-party/codemirror/codemirror-4.3.css",function(){$o.util.loadJS("/third-party/codemirror/codemirror-4.3.min.js",function(){n()})})},resize:function(t,n,r,s,i,o){e.editor&&e.editor.setSize(n,r)}}},e.addEvents("change"),e.callParent(arguments)},setValue:function(e){var t=this;e=e||"",t.editor?t.editor.setValue(e):t.down("textarea").setValue(e)},getValue:function(){var e=this;return e.editor?this.editor.getValue():e.down("textarea").getValue()},setReadOnly:function(e){var t=this;e?t.disable():t.enable()}}),Ext.define("$o.IconSelector.Widget",{extend:"Ext.form.FieldContainer",alias:["widget.$o.iconselector","widget.$iconselector"],layout:"hbox",fieldLabel:$o.getString("Icon"),initComponent:function(){var e=this;e.items=[{xtype:"button",iconCls:"gi_edit",name:"choose",height:22,handler:e.choose,scope:e,style:{marginRight:1}},{xtype:"button",iconCls:"gi_remove",height:22,style:{marginRight:5},handler:function(){e.setValue(null),e.fireEvent("change",null)}},{xtype:"button",name:"icon",width:22,height:22,iconCls:e.value,handler:e.choose,scope:e,style:{marginRight:1}},{xtype:"textfield",name:"name",flex:1,readOnly:!0,value:e.value?e.value:"",listeners:{render:function(t){t.getEl().on("mousedown",function(t,n,r){e.down("button[name=choose]").handler.call(e)})}}}],e.addEvents("change"),e.callParent(arguments)},getValue:function(){var e=this;return e.value},setValue:function(e){var t=this;t.value=e,t.down("button[name='icon']").setIconCls(e?e:""),t.down("textfield[name='name']").setValue(e?e:"")},getIconData:function(){for(var e=[],t=document.styleSheets,n=0;n<t.length;n++){var r=t[n].href;if(r&&r.indexOf("images.css")!=-1){var s=t[n].cssRules;s||(s=t[n].rules);for(var i=0;i<s.length;i++){var o=s[i].selectorText;if(o&&(o.length&&(o=o.substr(1)),"gi_"==o.substr(0,3))){var a={},l=s[i].cssText;l=l.split("(")[1].split(")")[0],a.url=l,a.iconCls=o,e.push(a)}}}}var c=function(e,t){var n=e.iconCls,r=t.iconCls;return n>r?1:n<r?-1:0};return e.sort(c),e},setReadOnly:function(e){var t=this;e?t.down("button[name='choose']").disable():t.down("button[name='choose']").enable()},choose:function(){for(var e=this,t=e.getIconData(),n=function(){o.close(),e.setValue(this.iconCls),e.fireEvent("change",this.iconCls)},r=[],s=[],i=0;i<t.length;i++)s.push({iconCls:t[i].iconCls}),s.length>20&&(r.push({layout:"hbox",defaults:{xtype:"button",handler:n,style:"margin-right: 1px; margin-bottom: 1px"},items:s}),s=[]);s.length&&r.push({layout:"hbox",defaults:{xtype:"button",handler:n,style:"margin-right: 1px; margin-bottom: 1px"},items:s});var o=Ext.create("Ext.Window",{width:500,height:570,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:$o.getString("Choose icon"),bodyPadding:5,modal:1,items:{layout:"vbox",border:0,defaults:{border:0},items:r}});o.show()}})}),Ext.define("$o.Card.Widget",{extend:"Ext.panel.Panel",layout:"vbox",objectumCmp:"card",defaults:{width:"100%"},alias:["widget.$o.card","widget.$card"],bodyPadding:5,autoScroll:!0,initComponent:function(){var e=this;e.items=e.items||e.fields,e.on("beforerender",e.beforeRenderListener,e),e.on("afterrender",e.afterRenderListener,e),e.on("beforedestroy",e.beforeDestroyListener,e),e.$items=e.items,e.items=void 0,e.relatives=e.relatives||{},e.relatives[e.zid]=e,e.targets={},e.$source=null,e.buildToolbar(),e.addEvents("beforeSave","aftersave","refresh"),e.processListeners(),e.readOnly=e.readOnly||$o.isReadOnly(),e.on("destroy",function(){e.disableUnloadMessage()}),e.callParent(arguments)},setFieldValues:function(){var e=this;_.each(e.items,function(e){if(e.objectId&&e.attr&&!e.value)try{e.value=$o.getObject(e.objectId).get(e.attr)}catch(e){}})},processListeners:function(){var me=this;me.listeners=me.listeners||{},me.listeners.scope=me.listeners.scope||me;for(var i in me.listeners)if("scope"!=i){var l=me.listeners[i];if("string"==typeof l)try{l=me.listeners[i]=eval(l)}catch(e){}if("function"==typeof l)me.on(i,l,me.listeners.scope);else if(l.fn)if("string"==typeof l.fn)try{var fn=eval(l.fn),args=l.arguments||{};args.card=me,l.fn=_.bind(fn,me,args)}catch(e){console.error(l.fn,e)}else me.on(i,l.fn,l.scope||me.listeners.scope)}},beforeRenderListener:function(){this.createFields()},afterRenderListener:function(){var e=this;_.each(e.getItems(),function(t){t.on("change",function(){e.autoSave||this.originalValue!=this.getValue()&&e.enableUnloadMessage()})}),e.refresh();var t=e.up("window")||e.up("*[isTab=1]");if(t){var n=function(){if(e.enabledUnloadMessage)return common.confirm({message:$o.getString("Data is not saved. Close?"),scope:this,fn:function(e){"yes"==e&&(t.un("beforeclose",n),t.close())}}),!1};t.on("beforeclose",n)}},beforeDestroyListener:function(){this.autoSave&&this.save({autoSave:!0})},getClassAttr:function(e){var t,n=this;if(e.objectId){var r=$o.getObject(e.objectId);r||console.error("bad objectId",e),t=r.getClassAttr(e.attr),t?e.$attr=e.attr:t=-1}else if(e.id&&e.attr){var s=e.attr.split(".")[0],i=e.attr.split(".")[1];n.$source=n.relatives[e.id],n.relatives[e.id].targets[n.zid]=n;var o,a=n.relatives[e.id].$view.attrs;if(a[s].get("classAttr")){var l=a[s].get("classAttr"),c=$o.classAttrsMap[l];o=$o.classesMap[c.get("type")]}else o=$o.classesMap[a[s].get("class")];t=o.attrs[i],t?(e.$relative=n.relatives[e.id],e.$objAttr=s,e.$attr=i,e.id=void 0):t=-1}return t},updateItem:function(e,t,n){var r=this,s=t.getFieldType(),i={fieldLabel:e.caption||e.fieldLabel||t.get("name"),xtype:s,card:this,ca:t};if(r.readOnly&&(i.readOnly=!0),t.get("secure")&&(i.inputType="password"),t.get("notNull")&&(e.allowBlank=!1),e.objectId){var o=$o.getObject(e.objectId);i.value=i.originalValue=o.get(e.attr)}"textfield"!=s&&"objectfield"!=s&&"$filefield"!=s||e.width||(i.anchor="-20"),"textfield"==s&&e.height&&(i.xtype="textarea"),"numberfield"==s&&(i.keyNavEnabled=!1,i.decimalPrecision=3),"datefield"!=s||e.hasOwnProperty("timefield")&&!e.timefield||(i.xtype="datetimefield"),n&&"compositefield"==n.xtype&&(i.style={marginRight:5},delete i.fieldLabel),e.listeners=e.listeners||{},e.listeners.focus=function(){r.down("*[name=fieldChanges]")&&r.down("*[name=fieldChanges]").enable(),r.focusedField=this},0==e.allowBlank&&(e.listeners.afterrender||(e.listeners.afterrender=function(){this.validate&&this.validate()})),i.vtype=t.getVType(),Ext.applyIf(e,i)},createFields:function(){for(var e=this,t=function(n,r){n||console.log(n,r);var s=e.getClassAttr(n);if(s==-1?Ext.apply(n,{xtype:"textfield",anchor:"-20",fieldLabel:n.caption||n.fieldLabel||"unknown",labelStyle:"color: red;",style:"color: red;",readOnly:!0,value:$o.getString("Attribute not exists in storage")}):s&&e.updateItem(n,s,r),n.items)for(var i=0;i<n.items.length;i++)t(n.items.getAt?n.items.getAt(i):n.items[i],n)},n=0;n<e.$items.length;n++)t(e.$items[n],null);e.add(e.$items),e.doLayout()},getItems:function(e){for(var t=this,n=[],r=function(t){if(t.$attr&&(e&&e.hidden||t.isVisible&&t.isVisible())&&n.push(t),t.items)for(var s=0;s<t.items.getCount();s++)r(t.items.getAt(s))},s=0;s<t.items.getCount();s++)r(t.items.getAt(s));return n},getFields:function(e){for(var t=this,n={},r=t.getItems(e),s=0;s<r.length;s++){var i=r[s];i.$attr&&(n[i.$attr]=i)}return n},updateFields:function(){for(var e=this,t=e.getItems(),n=0;n<t.length;n++){var r=t[n];if(r.$attr){var s=r.objectId=r.$relative?r.$relative.getCurrentValue(r.$objAttr):r.objectId,i=$o.getObject(s);r.setValue||console.log(r),r.setValue(i.get(r.$attr)),r.originalValue=i.get(r.$attr)}}},activeCondition:function(){var e=this;if(e.active){var t=e.active.fn.call(e,e.active.arguments),n=e.getItems();for(i=0;i<n.length;i++){var r=n[i];r.readOnly||r.setReadOnly(!t)}if(!e.readOnly&&!e.hideToolbar&&!e.autoSave){var s=e.getDockedItems("toolbar[dock='top']");s&&s.length&&s[0].setDisabled(!t)}}},refresh:function(){var e=this,t=e.$source;t?t.getSelectionModel().hasSelection()?(e.setDisabled(!1),e.updateFields()):e.setDisabled(!0):e.updateFields(),e.activeCondition();for(var n in this.targets){var r=this.targets[n];r.refresh&&r.refresh({moveFirst:1})}e.disableUnloadMessage(),e.fireEvent("refresh")},save:function(e){e=e||{};var t=this,n=function(){for(var n=t.getItems(),r={},s=!1,i=0;i<n.length;i++){var o=n[i];if(!e.filefield||"$filefield"==o.xtype){var a=o.objectId;if(a){var l=$o.getObject(a);if(l){r[a]=l;var c=o.getValue();l.get(o.$attr)!=c&&(l.getClassAttr(o.$attr).get("secure")&&(c=$o.util.sha1(c)),l.set(o.$attr,c),s=!0)}}}}if(s||t.hasListener("beforeSave")||t.hasListener("aftersave")){$o.startTransaction({description:"Card saving"});try{try{t.fireEvent("beforeSave",{card:t})}catch(e){console.error(e)}for(var a in r){var l=r[a];l.commit("local"),a<0&&_.each(n,function(e){e.objectId==a&&(e.objectId=l.get("id"))})}try{t.fireEvent("aftersave",{card:t})}catch(e){console.error(e),console.error(e.stack)}$o.commitTransaction(),t.$source&&t.$source.refresh()}catch(e){throw t.getEl()&&t.getEl().unmask(!0),common.message("<font color=red>"+$o.getString("Could not save data")+"</font><br>Error: "+e+"<br>Stack: "+e.stack),$o.rollbackTransaction(),e}}e.autoSave||(t.getEl()&&t.getEl().unmask(!0),t.disableUnloadMessage());for(var d in t.targets){var u=t.targets[d];u.refresh&&u.refresh({moveFirst:1})}e&&e.success&&e.success.call(e.scope||t),t.up("window")&&common.getConf({code:"closeWindowAfterSave"}).used&&(t.up("window").close(),common.message($o.getString("Information saved")))};if(e.autoSave)n();else{for(var r=t.getItems(),s="",i=0;i<r.length;i++){var o=r[i];if(o.getActiveError&&o.getActiveError()){var a=o.fieldLabel;!a&&o.ownerCt&&o.ownerCt.fieldLabel&&(a=o.ownerCt.fieldLabel),s+="<b>"+a+": "+(null==o.getValue()?"":o.getValue())+"</b> "+o.getActiveError()+"<br>"}}s?common.message("<font color=red>"+$o.getString("Form contains errors")+":</font><br><br>"+s):(t.getEl()&&t.getEl().mask(" ..."),setTimeout(n,300))}},onHighlight:function(){var e=this,t=[];_.each(e.query("*"),function(e){e.objectId&&t.push(e.objectId)}),t=_.uniq(t);var n=$o.execute({asArray:!0,select:[{a:"___fobject_id"},"objectId",{b:"___fcode"},"classAttrCode"],from:[{a:"system.object_attr"},"left-join",{b:"system.class_attr"},"on",[{a:"___fclass_attr_id"},"=",{b:"___fid"}]],where:[{a:"___fobject_id"},"in",t.join(".,.").split(".")]}),r={};_.each(n,function(e){r[e.objectId]=r[e.objectId]||{},r[e.objectId][e.classAttrCode]=r[e.objectId][e.classAttrCode]||0,r[e.objectId][e.classAttrCode]++}),_.each(e.query("*"),function(e){e.objectId&&r[e.objectId]&&r[e.objectId][e.attr]>1&&e.setFieldStyle("border: 2px solid orange")})},onFieldChanges:function(e,t){for(var n=this,r="number"==typeof e?e:n.focusedField.objectId,s="number"==typeof e?t:n.focusedField.$attr,i=$o.getObject(r),o=$o.getClass(i.get("classId")),a=o.attrs[s],l=$o.execute({select:[{a:"___fid"},"fid",{a:"___fstring"},"fstring",{a:"___fnumber"},"fnumber",{a:"___ftime"},"ftime",{b:"___fdate"},"fdate",{b:"___fsubject_id"},"fsubject_id",{b:"___fremote_addr"},"fremote_addr",{b:"___fdescription"},"fdescription",{c:"name"},"subject"],from:[{a:"system.object_attr"},"left-join",{b:"system.revision"},"on",[{a:"___fstart_id"},"=",{b:"___fid"}],"left-join",{c:"subject"},"on",[{b:"___fsubject_id"},"=",{c:"id"}]],where:[{a:"___fobject_id"},"=",r,"and",{a:"___fclass_attr_id"},"=",a.get("id")],order:[{b:"___fdate"},"desc"]}),c=[],d=0;d<l.length;d++){var u;if(l.get(d,"fsubject_id"))var f=$o.getObject(l.get(d,"fsubject_id")),u=_.filter(_.map(["login","surname","forename","patronymic","email","phone"],function(e){return f.get(e)}),function(e){if(e)return!0}).join(", ");else u="admin";var i={date:l.get(d,"fdate"),subject:u,ip:l.get(d,"fremote_addr"),description:l.get(d,"fdescription")},g="";if(l.get(d,"fstring"))g=l.get(d,"fstring");else if(l.get(d,"ftime"))g=common.getTimestamp(l.get(d,"ftime"));else if(l.get(d,"fnumber")&&(g=l.get(d,"fnumber"),a.get("type")>=1e3)){var m=$o.getObject(l.get(d,"fnumber"));g=m.toString()}i.value=g,c.push(i)}var p=Ext.create("Ext.data.Store",{data:c,fields:[{name:"date",type:"string"},{name:"value",type:"string"},{name:"subject",type:"string"},{name:"ip",type:"string"},{name:"description",type:"string"}]}),h=function(e,t,n,r,s,i){if(e){var o=e;o=o.split('"').join("'"),t.tdAttr='data-qtip="'+o+'"'}return t.style="white-space: normal;",e},v=Ext.create("Ext.grid.Panel",{store:p,columns:[{header:$o.getString("Date"),width:100,dataIndex:"date",renderer:h},{header:$o.getString("Value"),width:150,dataIndex:"value",renderer:h},{header:$o.getString("User"),width:150,dataIndex:"subject",renderer:h},{header:"IP",width:100,dataIndex:"ip",renderer:h},{header:$o.getString("Revision comment"),width:150,dataIndex:"description",renderer:h,hidden:!0}],forceFit:!0,frame:!1,deferRowRender:!1}),b=new Ext.Window({title:$o.getString("Revision History"),resizable:!0,closable:!0,modal:!0,width:600,height:600,border:!1,iconCls:"gi_history",layout:"fit",items:v});b.show()},buildToolbar:function(){var e=this;e.tbarUser=e.tbar||[],e.tbar=[],e.hideToolbar||e.readOnly||e.autoSave||$o.isReadOnly()||(e.tbar=[{
text:$o.getString("Save"),iconCls:"save",handler:e.save,scope:e},{text:$o.getString("Refresh"),iconCls:"refresh",handler:e.refresh,scope:e}],e.showSaveAndClose&&e.tbar.push({text:$o.getString("Save and close"),iconCls:"ok",handler:function(){this.save({success:function(){this.up("window").close()}})},scope:e}),$o.visualObjectum&&$o.visualObjectum.timeMachine&&$o.visualObjectum.timeMachine.cardButton&&($o.visualObjectum.timeMachine.cardHighlight||window.monu?e.tbar.push({text:$o.getString("Changes"),iconCls:"gi_history",menu:[{text:$o.getString("Revision History"),iconCls:"gi_history",name:"fieldChanges",disabled:1,handler:e.onFieldChanges,scope:e},{text:$o.getString("Show changed fields"),iconCls:"gi_history",handler:e.onHighlight,scope:e}]}):e.tbar.push({text:$o.getString("Changes"),iconCls:"gi_history",name:"fieldChanges",disabled:1,handler:e.onFieldChanges,scope:e})));for(var t=0;t<e.tbarUser.length;t++)e.tbar.push(e.tbarUser[t])},getChanged:function(){var e=this,t=[],n=e.getItems();for(i=0;i<n.length;i++){var r=n[i];if(r.isDirty()){var s=r.getValue();r.ca.get("secure")&&(s=$o.util.sha1(s));var o={};o.attr=r.$attr,o.oldValue=r.originalValue,o.newValue=s,o.fieldLabel=r.fieldLabel,o.xtype=r.xtype,t.push(o)}}return t},enableUnloadMessage:function(){this.enabledUnloadMessage=!0,window.onbeforeunload=function(e){var t=$o.getString("Data is not saved. You will lose changes if you leave the page");return"undefined"==typeof e&&(e=window.event),e&&(e.returnValue=t),t}},disableUnloadMessage:function(){this.enabledUnloadMessage=!1,window.onbeforeunload=void 0}}),Ext.define("$o.CardConf.Widget",{extend:"$o.Card.Widget",alias:["widget.$o.cardConf","widget.$cardConf"],initComponent:function(){var e=this;e.callParent(arguments)},updateItem:function(e,t){var n=this,r={fieldLabel:e.fieldLabel||e.attr,xtype:"textfield",anchor:"-20",card:n,conf:e.conf};if(n.readOnly&&(r.readOnly=!0),e.confRef&&(r.xtype="conffield"),"number"==typeof e.id){r.confId=e.id;var s=$o.getConfObject(e.conf,e.id);s&&(r.value=r.originalValue=s.get(e.attr),e.$attr=e.attr)}else if("string"==typeof e.id){var i=e.attr.split(".")[0],o=e.attr.split(".")[1];n.$source=n.relatives[e.id],n.relatives[e.id].targets[n.zid]=n,r.$relative=n.relatives[e.id],r.$idAttr=i,r.$attr=o}t&&"compositefield"==t.xtype&&(r.style={marginRight:5},delete r.fieldLabel),delete e.id,Ext.applyIf(e,r)},createFields:function(){for(var e=this,t=function(n,r){if(n.conf&&n.id&&n.attr&&e.updateItem(n,r),n.items)for(var s=0;s<n.items.length;s++)t(n.items.getAt?n.items.getAt(s):n.items[s],n)},n=0;n<e.$items.length;n++)t(e.$items[n],null);e.add(e.$items),e.doLayout()},updateFields:function(){for(var e=this,t=e.getItems(),n=0;n<t.length;n++){var r=t[n];if(r.$attr){var s=r.confId=r.$relative?r.$relative.getCurrentValue(r.$idAttr):r.confId;if(s){var i=$o.getConfObject(r.conf,s);r.setValue||console.log(r),r.setValue(i.get(r.$attr)),r.originalValue=i.get(r.$attr)}}}},save:function(e){e=e||{};for(var t=this,n=function(){for(var n=t.getItems(),r={},s=!1,i=0;i<n.length;i++){var o=n[i],a=o.confId;if(a){var l=$o.getConfObject(o.conf,a);if(l){r[a]=l;var c=o.getValue();l.get(o.$attr)!=c&&(l.set(o.$attr,c),s=!0)}}}if(s){t.fireEvent("beforeSave"),$o.startTransaction({description:"CardConf saving"});try{for(var a in r){var l=r[a];l.sync()}t.fireEvent("afterSave"),$o.commitTransaction(),t.$source&&t.$source.refresh()}catch(e){throw t.getEl()&&t.getEl().unmask(!0),$o.rollbackTransaction(),e}}t.getEl()&&t.getEl().unmask(!0),e&&e.success&&e.success.call(e.scope||t)},r=t.getItems(),s="",i=0;i<r.length;i++){var o=r[i];if(o.getActiveError&&o.getActiveError()){var a=o.fieldLabel;!a&&o.ownerCt&&o.ownerCt.fieldLabel&&(a=o.ownerCt.fieldLabel),s+="<b>"+a+": "+(null==o.getValue()?"":o.getValue())+"</b> "+o.getActiveError()+"<br>"}}s?common.message("<font color=red>"+$o.getString("Form contains errors")+":</font><br><br>"+s):(t.getEl()&&t.getEl().mask($o.getString("Saving")+" ..."),setTimeout(n,100))}}),Ext.define("$o.Tree.Widget",{extend:"Ext.tree.Panel",mixins:{baseGrid:"$o.Base.Grid"},alias:["widget.$o.tree"],useArrows:!0,rootVisible:!1,multiSelect:!0,columnLines:!0,rowLines:!0,scroll:!0,layout:"anchor",initComponent:function(){var e=this,t=e.$view=e.queryId?$o.viewsMap[e.queryId]:$o.getView({code:e.$query}),n=e.viewId=t.get("id");t.get("query");delete e.query;var r=e.createViewModel({view:t});Ext.define("$o.View."+n+".Model",{extend:"Ext.data.Model",fields:r}),e.columns=[],e.$opened=[];for(var s=0;s<r.length;s++){var i=r[s],o={text:i.header,tooltip:i.header,dataIndex:i.name,hidden:1!=i.area,width:i.width,renderer:e.cellRenderer,scope:e};s||(o.xtype="treecolumn",o.locked=!0),"bool"==i.type&&(o.renderer=function(t,n,r,s,i,o){return t=t?"":"",e.cellRenderer(t,n,r,s,i,o)}),e.columns.push(o)}e.store=Ext.create("Ext.data.TreeStore",{model:"$o.View."+n+".Model",autoLoad:!1,root:{expanded:!1},proxy:{type:"ajax",api:{create:"treegrid?create=1&id="+n+"&cmpId="+e.id+"&fieldParent="+e.fields.parent+"&fieldId="+e.fields.id,read:"treegrid?read=1&id="+n+"&cmpId="+e.id+"&fieldParent="+e.fields.parent+"&fieldId="+e.fields.id,update:"treegrid?update=1&id="+n+"&cmpId="+e.id+"&fieldParent="+e.fields.parent+"&fieldId="+e.fields.id,delete:"treegrid?delete=1&id="+n+"&cmpId="+e.id+"&fieldParent="+e.fields.parent+"&fieldId="+e.fields.id}},listeners:{load:e.loadListener,expand:e.expandListener,collapse:e.collapseListener,scope:e}}),e.selModel=Ext.create("Ext.selection.TreeModel",{mode:0==e.singleSelect?"MULTI":"SINGLE",listeners:{beforeselect:{fn:e.beforeSelectListener,scope:e},selectionchange:{fn:e.selectionChangeListener,scope:e}}}),e.bbar=[{iconCls:"refresh",handler:e.refresh,scope:e}],e.on("beforerender",e.beforeRenderListener,e),e.on("render",e.renderListener,e),e.on("itemdblclick",function(){e.userEventListener({event:"dblclick"})},e),e.on("cellcontextmenu",function(){e.getSelectionModel().deselectAll()},e),e.buildToolbar(),e.relatives=e.relatives||{},e.relatives[e.zid]=e,e.targets={},e.callParent(arguments)},beforeRenderListener:function(){this.getFilter()&&this.store.getRootNode().expand()},renderListener:function(){this.checkActions()},expandListener:function(e){e.isRoot()||this.$opened.indexOf(e.get(this.fields.id))==-1&&this.$opened.push(e.get(this.fields.id))},collapseListener:function(e){e.isRoot()||this.$opened.splice(this.$opened.indexOf(e.get(this.fields.id)),1)},refresh:function(e){var t=this;e=e||{};var n,r=e.callback;t.getSelectionModel().hasSelection()&&(n=t.getSelectionModel().getSelection(),n=n[0]),t.getFilter()&&(t.store.getRootNode().isExpanded()?t.store.load({callback:function(){if(n&&t.getRootNode().findChild(t.fields.id,n.get(t.fields.id)))for(var e=0;e<t.records.length;e++){var s=t.records[e];if(s.get(t.fields.id)==n.get(t.fields.id)){t.getSelectionModel().deselectAll(),t.getSelectionModel().select(s);break}}r&&r.call(t,n,t.getStore(),!0)}}):t.store.getRootNode().expand(),this.checkActions())},loadListener:function(e,t,n,r,s){var i=this;i.records=i.records||[];var o=i.fields.id,a=function(e){for(var t=0;t<e.length;t++){for(var n=e[t],r=!1,s=0;s<i.records.length;s++){var l=i.records[s];if(n.get(o)==l.get(o)){i.records[s]=n,r=!0;break}}r||i.records.push(n),n.childNodes&&a(n.childNodes)}};a(n)},selectRow:function(e){var t=this;if(e.filter)for(var n=e.filter[2],r=0;r<t.records.length;r++){var s=t.records[r];if(s.get(t.fields.id)==n){t.getSelectionModel().deselectAll(),t.getSelectionModel().select(s);break}}}}),Ext.define("$o.Chart.Widget",{extend:"Ext.chart.Chart",alias:["widget.$o.chart"],style:"background:#fff",animate:!0,shadow:!0,overflowY:"auto",initComponent:function(){var e=this,t=e.$view=e.queryId?$o.viewsMap[e.queryId]:$o.getView({code:e.$query});e.viewId=t.get("id"),t.get("query");delete e.query;var n=[e.attrMark],r=[e.attrValue],s=e.getData();e.store=Ext.create("Ext.data.Store",{fields:["___name",e.attrMark,e.attrValue],data:s}),e.axes=[{type:"Numeric",position:"bottom",fields:r,minimum:0,label:{renderer:Ext.util.Format.numberRenderer("0,0")},grid:!0,title:e.titleValue},{type:"Category",position:"left",fields:["___name"],title:e.titleMark}],e.series=[{type:"bar",axis:"bottom",xField:e.attrMark,yField:r,title:n,tips:{trackMouse:!0,width:300,height:50,renderer:function(e,t){this.setTitle(t.value[0]+" ("+e.get("n"+t.yField.substr(1))+"): "+(null==t.value[1]?"":t.value[1]))}},label:{display:"insideEnd",field:n}}],e.relatives=e.relatives||{},e.relatives[e.zid]=e,e.targets={},e.callParent(arguments)},getData:function(){var e=this,t=e.$view.get("query");if(t=JSON.parse(t),e.filter){t.where=t.where||[],t.where.length&&t.where.push("and");for(var n=$o.util.clone(e.filter),r=0;r<n.length;r++){for(var s=1;s<t.select.length;s+=2)n[r]==t.select[s]&&(n[r]=t.select[s-1]);if(n[r]&&"object"==typeof n[r]&&n[r].id&&n[r].attr){if(e.relatives[n[r].id].targets[e.zid]=e,n[r]=e.relatives[n[r].id].getValue(n[r].attr),void 0==n[r])return e.disable(),[];e.enable()}}t.where.push(n)}for(var i=$o.execute({sql:t}),o=[],r=0;r<i.length;r++){var a={};a[e.attrMark]=i.get(r,e.attrMark),a[e.attrValue]=i.get(r,e.attrValue),a.___name="",o.push(a)}return o},refresh:function(e){var t=this;if(!t.refreshing){t.refreshing=1;var t=this;e=e||{},t.store.loadData(t.getData()),t.redraw(),t.refreshing=0}}}),Ext.define("$o.Image.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.image"],border:0,initComponent:function(){var e=this;e.relatives=e.relatives||{},e.relatives[e.zid]=e,e.targets={},e.items={xtype:"image",src:e.url,width:e.width,height:e.height,shrinkWrap:!0},e.on("afterrender",e.refresh,e),e.callParent(arguments)},refresh:function(e){var t=this;if(t.attr){var n=t.relatives[t.attr.split(".")[0]],r=t.attr.split(".")[1];if(n)if(n.targets[t.zid]=t,"$o.card"==n.xtype){for(var s,i=n.getItems(),o=0;o<i.length;o++)if(i[o].objectId){s=i[o].objectId;break}if(s){var a=$o.getObject(s);if(a.get(r)){var l=$o.getClass(a.get("classId")).attrs[r],c="files/"+s+"-"+l.get("id")+"-"+a.get(r);t.down("image").setSrc(c)}else t.down("image").setSrc(null)}}else{var c=n.getValue(r);t.down("image").setSrc(c)}}}}),Ext.define("$o.Frame.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.frame"],border:0,initComponent:function(){var e=this;e.relatives=e.relatives||{},e.relatives[e.zid]=e,e.targets={},e.html='<iframe src="'+e.url+'" frameborder="0" width="100%" height="100%">',e.on("afterrender",e.refresh,e),e.callParent(arguments)},refresh:function(e){var t=this;if(t.attr){var n=t.relatives[t.attr.split(".")[0]],r=t.attr.split(".")[1];if(n){n.targets[t.zid]=t;var s=n.getValue(r);t.update('<iframe src="'+s+'" frameborder="0" width="100%" height="100%">')}}}}),Ext.define("$o.Layout.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.layout","widget.$layout"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){this.relatives={};var layout=this.$layout;!layout&&this.record&&this.record.stub&&(layout=this.record.stub.get("layout"),!layout&&this.record.get("query")&&(layout={olap:{id:"olap",view:this.record.getFullCode()}})),"object"!=typeof layout&&(layout=eval("("+layout+")"),"function"==typeof layout&&(layout=layout())),delete this.layout,this.addEvents("load"),this.on("afterrender",function(){this.fireEvent("load")},this),this.record=this.record||{},this.record.stub=this.record.stub||{},this.record.stub.get=this.record.stub.get||function(){},$o.app.fireEvent("viewLayout",{record:this.record,layout:layout}),this.items=this.process(layout);try{this.viewFullCode=$o.getView(this.record.get("id")).getFullCode()}catch(e){}this.callParent(arguments)},processTab:function(e){var t={xtype:"tabpanel",zid:e.id,items:[]};e.items=e.pages||e.items;for(var n=0;n<e.items.length;n++)t.items.push(this.process(e.items[n]));return delete e.id,t},processSplit:function(e){var t={layout:"border",border:!1,zid:e.id,defaults:{border:!1}};return"horizontal"==e.orientation?t.items=[{split:!0,region:"west",width:e.width,layout:"fit",items:this.process(e.pages?e.pages[0]:e.items[0])},{region:"center",layout:"fit",items:this.process(e.pages?e.pages[1]:e.items[1])}]:t.items=[{split:!0,region:"north",height:e.height||e.width,layout:"fit",items:this.process(e.pages?e.pages[0]:e.items[0])},{region:"center",layout:"fit",items:this.process(e.pages?e.pages[1]:e.items[1])}],delete e.id,t},processOlap:function(e){var t={xtype:"$o.grid",zview:this,relatives:this.relatives,$query:e.view,zid:e.id,lconfig:{listeners:{}}};return e.listeners&&e.listeners.dblclick&&(t.lconfig.listeners.dblclick=$o.util.clone(e.listeners.dblclick),delete e.listeners.dblclick),e.listeners&&e.listeners.cellRenderer&&(t.lconfig.listeners.cellRenderer=$o.util.clone(e.listeners.cellRenderer),delete e.listeners.cellRenderer),delete e.view,delete e.id,t},processChart:function(e){var t={xtype:"$o.chart",zview:this,relatives:this.relatives,$query:e.view,zid:e.id};return delete e.view,delete e.id,t},processImage:function(e){var t={xtype:"$o.image",zview:this,relatives:this.relatives,url:e.url,attr:e.attr,width:e.width,height:e.height,zid:e.id};return delete e.id,t},processFrame:function(e){var t={xtype:"$o.frame",zview:this,relatives:this.relatives,url:e.url,attr:e.attr,zid:e.id};return delete e.id,t},processTreegrid:function(e){var t={xtype:"$o.tree",zview:this,relatives:this.relatives,$query:e.view,zid:e.id,lconfig:{listeners:{}}};return e.listeners&&e.listeners.dblclick&&(t.lconfig.listeners.dblclick=$o.util.clone(e.listeners.dblclick),delete e.listeners.dblclick),e.listeners&&e.listeners.cellRenderer&&(t.lconfig.listeners.cellRenderer=$o.util.clone(e.listeners.cellRenderer),delete e.listeners.cellRenderer),delete e.view,delete e.id,t},processCard:function(e){var t={xtype:"$o.card",zview:this,relatives:this.relatives,zid:e.id};return delete e.id,t},processCardConf:function(e){var t={xtype:"$o.cardConf",zview:this,relatives:this.relatives,zid:e.id};return delete e.id,t},processPanel:function(e){var t={xtype:"panel",zview:this,relatives:this.relatives,zid:e.id};return delete e.id,t},process:function(e){var t={};for(var n in e){var r=e[n];switch(n){case"tab":t=this.processTab(r);break;case"split":t=this.processSplit(r);break;case"olap":t=this.processOlap(r);break;case"treegrid":t=this.processTreegrid(r);break;case"card":t=this.processCard(r);break;case"cardConf":t=this.processCardConf(r);break;case"panel":t=this.processPanel(r);break;case"chart":t=this.processChart(r);break;case"image":t=this.processImage(r);break;case"frame":t=this.processFrame(r);break;case"calendar":break;case"designer":break;default:return e}r.title=$o.locale.getString(r.title)||$o.locale.getString(r.caption),Ext.applyIf(t,r)}return t},getCurrentValue:function(e,t){var n,r=this.relatives[e];return r&&(n=r.getCurrentValue(t)),n}}),Ext.define("$o.Classes.Widget",{extend:"$o.Layout.Widget",alias:["widget.$o.classes","widget.$classes"],initComponent:function(){var e=this;e.$layout={split:{orientation:"horizontal",width:290,pages:[{treegrid:{id:"olap",view:"system.classes",fields:{id:"id",parent:"parent_id"},filter:{fn:function(){return["end_id","=",2147483647,"and","id",">=",1e3]},all:!0},actions:[{fn:function(){var t=this;$zu.dialog.getNameAndCode({title:$o.getString("Class",":","Adding"),success:function(n,r){var s=!1;async.series([function(e){var n=$o.getClass(t.getCurrentValue("id"));n&&"spr"==n.getFullCode().split(".")[0]?common.confirm({message:$o.getString("Create standard dictionary (card, view)?"),scope:this,fn:function(t){"yes"==t&&(s=!0),e()}}):e()}],function(i){var o=$o.startTransaction({description:"Create class "}),a=$o.createClass();a.set("parent",t.getCurrentValue("id")),a.set("name",n),a.set("code",r),a.sync(),a.updateDefault(),s&&e.createSpr(a),$o.commitTransaction(o),t.refresh({callback:function(e,n,r){r&&t.selectRow({filter:["&id","=",a.get("id")]})},scope:t})})}})},caption:"create",icon:"new"},{fn:function(){common.confirm({message:$zr.getString("Are you sure?"),scope:this,fn:function(e){if("yes"==e){var t=this.getCurrentValue("id"),n=$o.startTransaction({description:"Remove class "+t}),r=$o.getClass(t);r.remove(),r.sync(),$o.commitTransaction(n),this.refresh()}}})},active:{fn:function(){var e=this.getCurrentValue("id")&&!this.getCurrentValue("schema_id");return e}},caption:"delete",icon:"delete"},{fn:function(){e.showObjects({classId:this.getCurrentValue("id")})},active:{fn:function(){var e=this.getCurrentValue("id");return e}},caption:$o.getString("Objects"),iconCls:"gi_file"}],listeners:{afterrender:function(){e.olapClasses=this}}}},{tab:{pages:[{cardConf:{id:"commonCard",title:$o.getString("Commons"),iconCls:"gi_edit",items:[{conf:"class",id:"olap",attr:"id.name",fieldLabel:$o.getString("Name")},{conf:"class",id:"olap",attr:"id.code",allowBlank:!1,fieldLabel:$o.getString("Code"),readOnly:!0,maskRe:/[A-Za-z0-9\_]/},{conf:"class",id:"olap",attr:"id.description",fieldLabel:$o.getString("Description"),xtype:"textarea",height:150},{conf:"class",id:"olap",attr:"id.format",fieldLabel:$o.getString("Format function (default: return this.get ('name');)"),xtype:"textarea",height:200}],active:{fn:function(){return!this.relatives.olap.getCurrentValue("schema_id")}}}},{split:{title:$o.getString("Attributes"),iconCls:"gi_file",orientation:"vertical",height:400,pages:[{olap:{id:"olapAttrs",view:"system.classAttrs",filter:["class_id","=",{id:"olap",attr:"id"}],actions:[{fn:function(){$zu.dialog.getNameAndCodeAndType({title:$o.getString("Class attribute",":","Adding"),success:function(e,t,n){var r=$o.getClass(this.relatives.olap.getCurrentValue("id")),s=r.hasAttrInHierarchy(t);if(s)return void common.message($o.getString("Attribute already exists in class")+": "+s.toString());var i=$o.startTransaction({description:"Create class attr"}),o=$o.createClassAttr();o.set("class",this.relatives.olap.getCurrentValue("id")),o.set("name",e),o.set("code",t),o.set("type",n),o.set("removeRule","set null"),o.sync(),$o.getClass(o.get("class")).updateDefault(),$o.commitTransaction(i),this.refresh({callback:function(e,t,n){n&&this.selectRow({filter:["&id","=",o.get("id")]})},scope:this})},scope:this})},arguments:{debug:1},caption:"create",icon:"new",active:{fn:function(){return!this.relatives.olap.getCurrentValue("schema_id")}}},{fn:function(){common.confirm({message:$zr.getString("Are you sure?"),scope:this,fn:function(e){if("yes"==e){var t=this.getCurrentValue("id"),n=$o.startTransaction({description:"Remove class attr "+t}),r=$o.getClassAttr(t),s=r.get("class");r.remove(),r.sync(),$o.getClass(s).updateDefault(),$o.commitTransaction(n),this.refresh()}}})},active:{fn:function(){return this.getCurrentValue("id")&&!this.relatives.olap.getCurrentValue("schema_id")}},caption:"delete",icon:"delete"}],cellRenderer:function(e,t,n,r,s,i){if("type"==t.column.dataIndex&&n.get("type_id")){var o=$o.getClass(n.get("type_id"));o&&(e=o.toString())}return e}}},{cardConf:{id:"attrCard",items:[{conf:"classAttr",id:"olapAttrs",attr:"id.name",fieldLabel:$o.getString("Name")},{conf:"classAttr",id:"olapAttrs",attr:"id.code",fieldLabel:$o.getString("Code"),allowBlank:!1,readOnly:!0,maskRe:/[A-Za-z0-9\_]/},{conf:"classAttr",id:"olapAttrs",attr:"id.type",fieldLabel:$o.getString("Type"),confRef:"class",readOnly:!0},{anchor:"100%",xtype:"fieldcontainer",layout:"hbox",items:[{conf:"classAttr",id:"olapAttrs",attr:"id.secure",fieldLabel:$o.getString("Password"),xtype:"checkbox"},{conf:"classAttr",id:"olapAttrs",attr:"id.unique",fieldLabel:$o.getString("Unique"),xtype:"checkbox",style:"margin-left: 10px"},{conf:"classAttr",id:"olapAttrs",attr:"id.notNull",fieldLabel:$o.getString("Not null"),xtype:"checkbox",style:"margin-left: 10px"},{xtype:"compositefield",fieldLabel:$o.getString("Remove rule"),style:"margin-left: 10px",items:[{xtype:"combo",conf:"classAttr",id:"olapAttrs",attr:"id.removeRule",width:200,triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["set null","Set null)"],["cascade","Cascade"]]}),valueField:"id",displayField:"text"}]}]},{conf:"classAttr",id:"olapAttrs",attr:"id.formatFunc",fieldLabel:$o.getString("Options")+" (JSON)",xtype:"textarea",height:50},{conf:"classAttr",id:"olapAttrs",attr:"id.validFunc",fieldLabel:$o.getString("Validation function"),xtype:"textarea",height:30},{conf:"classAttr",id:"olapAttrs",attr:"id.description",fieldLabel:$o.getString("Description"),xtype:"textarea",height:30}],active:{fn:function(){if(this.relatives.olapAttrs.getValue("id")){var e=$o.getClassAttr(this.relatives.olapAttrs.getValue("id"));e.get("type")>=1e3?this.down("*[attr=id.removeRule]").enable():this.down("*[attr=id.removeRule]").disable(),1==e.get("type")?this.down("*[attr=id.secure]").enable():this.down("*[attr=id.secure]").disable()}return!this.relatives.olap.getCurrentValue("schema_id")}}}}]}},{split:{title:$o.getString("Actions"),iconCls:"gi_wrench",orientation:"vertical",width:400,pages:[{olap:{id:"olapActions",view:"system.actions",filter:["class_id","=",{id:"olap",attr:"id"}],actions:[{fn:function(){$zu.dialog.getNameAndCode({title:$o.getString("Action",":","Adding"),success:function(e,t){var n=$o.startTransaction({description:"Create action"}),r=$o.createAction();r.set("class",this.relatives.olap.getCurrentValue("id")),r.set("name",e),r.set("code",t),r.sync(),$o.commitTransaction(n),this.refresh({callback:function(e,t,n){n&&this.selectRow({filter:["&id","=",r.get("id")]})},scope:this})},scope:this})},caption:"create",icon:"new",active:{fn:function(){return!this.relatives.olap.getCurrentValue("schema_id")}}},{fn:function(){common.confirm({message:$zr.getString("Are you sure?"),scope:this,fn:function(e){if("yes"==e){var t=this.getCurrentValue("id"),n=$o.startTransaction({description:"Remove action "+t}),r=$o.getAction(t);r.remove(),r.sync(),$o.commitTransaction(n),this.refresh()}}})},active:{fn:function(){return this.getCurrentValue("id")&&!this.relatives.olap.getCurrentValue("schema_id")}},caption:"delete",icon:"delete"},{fn:function(){var e=$o.getAction(this.getCurrentValue("id")),t=e.get("body"),n=Ext.create("Ext.Window",{width:800,height:600,layout:"fit",frame:!1,border:!1,bodyPadding:1,modal:!1,maximizable:!0,title:$o.getString("Action source code")+": "+e.toString(),iconCls:"gi_notes",items:{name:"body",xtype:"codemirrortextarea",listeners:{afterrender:function(){this.setValue(t)}}},tbar:[{text:$o.getString("Save"),iconCls:"gi_floppy_save",disabled:this.relatives.olap.getCurrentValue("schema_id"),handler:function(){e.set("body",n.down("*[name=body]").getValue()),e.sync(),e.initAction(),n.close()}},{text:$o.getString("Cancel"),iconCls:"gi_remove",handler:function(){n.close()}}]});n.show()},active:{fn:function(){return this.getCurrentValue("id")}},text:$o.getString("Source code"),iconCls:"gi_notes"},{fn:function(){var t=this.getCurrentValue("class_id"),n=$o.getAction(this.getCurrentValue("id")),r=n.get("layout");r=r||"{}",r=JSON.parse(r);var s=(r.layout,Ext.create("Ext.Window",{width:800,height:600,layout:"fit",frame:!1,border:!1,bodyPadding:1,modal:!1,maximizable:!0,title:$o.getString("Action layout")+": "+n.toString(),iconCls:"gi_table",items:{xtype:"$layoutdesigner",name:"layout",listeners:{afterrender:function(){this.setValue(r.layout),this.classId=t}}},tbar:[{text:$o.getString("Save"),iconCls:"gi_floppy_save",disabled:this.relatives.olap.getCurrentValue("schema_id"),handler:function(){var t=s.down("*[name=layout]").getValue();if(t){if("string"==typeof t)try{r.layout=JSON.parse(t)}catch(e){return common.message($o.getString("Parsing layout ended with an error")),void s.close()}"object"==typeof t&&(r.layout=t)}else delete r.layout;n.set("layout",JSON.stringify(r,null,"\t")),n.sync(),n.initAction(),e.actionCard.down("*[attr=id.layout]").originalValue=JSON.stringify(r,null,"\t"),s.close()}},{text:$o.getString("Cancel"),iconCls:"gi_remove",handler:function(){s.close()}}]}));s.show()},active:{fn:function(){return this.getCurrentValue("id")}},text:$o.getString("Layout"),iconCls:"gi_table"}],listeners:{afterrender:function(){e.olapActions=this}}}},{cardConf:{id:"actionCard",listeners:{afterrender:function(){e.actionCard=this},afterSave:function(){var t=this.relatives.olapActions.getValue("id"),n=$o.getAction(t),r=e.actionCard.down("*[attr=id.layout]"),s=r.originalValue;s=JSON.parse(s),s&&"object"==typeof s||(s={}),s.type=e.actionCard.down("*[name=type]").getValue(),s.serverAction=e.actionCard.down("*[name=serverAction]").getValue(),s.noAuth=e.actionCard.down("*[name=noAuth]").getValue(),n.set("layout",JSON.stringify(s,null,"\t")),n.sync(),n.initAction()}},items:[{conf:"action",id:"olapActions",attr:"id.name",fieldLabel:$o.getString("Name"),labelWidth:150},{conf:"action",id:"olapActions",attr:"id.code",fieldLabel:$o.getString("Code"),allowBlank:!1,labelWidth:150,maskRe:/[A-Za-z0-9\_]/},{xtype:"combo",name:"type",fieldLabel:$o.getString("Type"),triggerAction:"all",lazyRender:!0,mode:"local",labelWidth:150,queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[[null,"-"],["create",$o.getString("Adding")],["remove",$o.getString("Removing")],["card",$o.getString("Card")]]}),valueField:"id",displayField:"text",listeners:{select:function(){e.actionCard.down("*[attr=id.layout]").setValue(e.actionCard.down("*[attr=id.layout]").counter++)}}},{xtype:"compositefield",fieldLabel:$o.getString("Server action"),labelWidth:150,items:[{xtype:"checkbox",name:"serverAction",listeners:{change:function(){e.actionCard.down("*[attr=id.layout]").setValue(e.actionCard.down("*[attr=id.layout]").counter++),this.getValue()?(e.actionCard.down("*[name=noAuth]").enable(),e.actionCard.down("*[name=displayNoAuth]").enable()):(e.actionCard.down("*[name=noAuth]").disable(),e.actionCard.down("*[name=displayNoAuth]").disable())}}},{xtype:"displayfield",name:"displayNoAuth",value:$o.getString("Execute no authentication")+":",style:"margin-left: 10px; margin-right: 5px"},{xtype:"checkbox",name:"noAuth",labelWidth:150,listeners:{change:function(){e.actionCard.down("*[attr=id.layout]").setValue(e.actionCard.down("*[attr=id.layout]").counter++)}}}]},{conf:"action",id:"olapActions",attr:"id.body",xtype:"textarea",hideLabel:!0,style:"display: none"},{conf:"action",id:"olapActions",attr:"id.layout",xtype:"textarea",hideLabel:!0,style:"display: none"}],active:{fn:function(){if(this.relatives.olapActions.getValue("id")){var e=$o.getAction(this.relatives.olapActions.getValue("id")),t=e.get("layout");t=t||"{}",t=JSON.parse(t),this.down("*[name=type]").setValue(t.type),this.down("*[name=serverAction]").setValue(t.serverAction),this.down("*[name=noAuth]").setValue(t.noAuth),t.serverAction?(this.down("*[name=noAuth]").enable(),this.down("*[name=displayNoAuth]").enable()):(this.down("*[name=noAuth]").disable(),this.down("*[name=displayNoAuth]").disable()),t.system?this.down("*[iconCls=save]").disable():this.down("*[iconCls=save]").enable(),this.down("*[attr=id.layout]").originalValue=e.get("layout"),this.down("*[attr=id.layout]").counter=1}return!this.relatives.olap.getCurrentValue("schema_id")}}}}]}},{olap:{id:"olapDependency",title:$o.getString("Dependencies"),iconCls:"gi_link",view:"system.typeClassAttrs",filter:["type_id","=",{id:"olap",attr:"id"}],cellRenderer:function(e,t,n,r,s,i){if("classCode"==t.column.dataIndex){var o=$o.getClass(n.get("class_id"));o&&(e=o.getFullCode())}return e}}}]}}]}},e.callParent(arguments)},showObjects:function(e){var t=$o.getClass(e.classId);if(!t.attrsArray.length)return void common.message($o.getString("Class has no attributes"));var n=Ext.create("Ext.Window",{title:$o.getString("Class objects")+": "+t.toString(),iconCls:"gi_file",width:800,height:600,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",bodyPadding:1,modal:!0,items:{xtype:"$o.layout",$layout:{olap:{id:"olap",classView:e.classId,recreateView:!0,singleSelect:!1,actions:[{fn:function(){var e=this;common.confirm({message:$o.getString("Are you sure?"),fn:function(t){"yes"==t&&($o.startTransaction({description:"Remove by admin"}),_.each(e.getSelectionModel().getSelection(),function(t,n){$o.removeObject(t.get("id")),e.getStore().remove(t)}),$o.commitTransaction())}})},text:$o.getString("Remove"),iconCls:"gi_circle_minus",active:"common.recordSelected"},{fn:function(){var e=this,t=JSON.parse(e.$view.get("query")),n=e.getFilter();n&&n.length&&(_.each(n,function(e,r){var s=t.select.indexOf(e);s>-1&&(n[r]=t.select[s-1])}),t.where=t.where||[],t.where.length&&t.where.push("and"),t.where.push(n)),t.asArray=!0;var r=$o.execute(t);common.confirm({message:$o.getString("Entries will be deleted")+": "+r.length+". "+$o.getString("Are you sure?"),fn:function(t){"yes"==t&&(Ext.MessageBox.show({title:$o.getString("Please wait"),msg:$o.getString("Action in progress")+" ...",progressText:"",width:300,progress:1,closable:!1}),setTimeout(function(){$o.startTransaction(),async.reduce(r,0,function(e,t,n){Ext.MessageBox.updateProgress(e/r.length,e+" / "+r.length),$o.removeObject(t.id),setTimeout(function(){n(null,e+1)},1)},function(t){$o.commitTransaction(),Ext.MessageBox.hide(),e.refresh()})},100))}})},text:$o.getString("Remove all"),iconCls:"gi_circle_minus"},{fn:function(){var e=this,n=JSON.parse(e.$view.get("query")),r=e.getFilter();r&&r.length&&(_.each(r,function(e,t){var s=n.select.indexOf(e);s>-1&&(r[t]=n.select[s-1])}),n.where=n.where||[],n.where.length&&n.where.push("and"),n.where.push(r)),n.asArray=!0;var s=$o.execute(n),i=Ext.create("Ext.window.Window",{title:$o.getString("Changing the value of"),iconCls:"edit",closable:!0,width:600,height:400,layout:"vbox",modal:!0,style:"background-color: #fff",bodyStyle:"background-color: #fff",bodyPadding:5,items:[{xtype:"textfield",disabled:!0,fieldLabel:$o.getString("Entries will be changed"),value:s.length},{xtype:"combo",fieldLabel:$o.getString("Attribute"),name:"attr",triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",store:{type:"json",fields:["id","name"],data:_.map(t.attrsArray,function(e){return{id:e.get("code"),name:e.toString()}})},width:"100%",valueField:"id",displayField:"name",editable:!1},{xtype:"textfield",name:"value",fieldLabel:$o.getString("Value"),width:"100%"}],buttons:[{text:$o.getString("Change"),iconCls:"ok",handler:function(){var t=i.down("*[name=attr]").getValue(),n=i.down("*[name=value]").getValue()||null;return t?(Ext.MessageBox.show({title:$o.getString("Please wait"),msg:$o.getString("Action in progress")+" ...",progressText:"",width:300,progress:1,closable:!1}),void setTimeout(function(){$o.startTransaction(),async.reduce(s,0,function(e,r,i){Ext.MessageBox.updateProgress(e/s.length,e+" / "+s.length);var o=$o.getObject(r.id);o.set(t,n),o.sync(),setTimeout(function(){i(null,e+1)},1)},function(t){$o.commitTransaction(),Ext.MessageBox.hide(),i.close(),e.refresh()})},100)):common.message($o.getString("Choose attribute"))}}]});i.show()},text:$o.getString("Change all"),iconCls:"edit"},{text:$o.getString("Import")+" CSV",iconCls:"gi_disk_import",fn:function(){var t=this,n=Ext.create("Ext.window.Window",{title:$o.getString("import")+" CSV",iconCls:"gi_disk_import",closable:!0,width:800,height:600,layout:"fit",modal:!0,style:"background-color: #fff",bodyStyle:"background-color: #fff",items:{xtype:"importcsvobjects",classId:e.classId,listeners:{imported:function(){n.close(),t.refresh()}}}});n.show()}}]}}}});n.show()},createSpr:function(e){var t={type:"card",layout:{designer:1,card:{id:"card",items:[{anchor:"100%",fieldLabel:$o.getString("Name"),attr:"name",objectId:"[#id]"},{fieldLabel:$o.getString("N"),attr:"npp",objectId:"[#id]",width:200},{anchor:"100%",fieldLabel:$o.getString("Code"),attr:"code",objectId:"[#id]"}],object:[{cls:e.getFullCode(),tag:"[#id]"}]}}},n=$o.execute({asArray:!0,select:[{a:"___fid"},"id"],from:[{a:"system.action"}],where:[{a:"___fend_id"},"=",2147483647,"and",{a:"___fclass_id"},"=",e.get("id"),"and",{a:"___fcode"},"=","card"]}),r=$o.getAction(n[0].id);r.set("layout",JSON.stringify(t,null,"\t")),r.sync();var s=e.getFullCode().split(".");s.splice(s.length-1,1),s=s.join(".");var i;try{i=$o.getView(s)}catch(e){return common.message($o.getString("base view not exists")+" "+s)}if(!i)return common.message($o.getString("base view not exists")+" "+s);
var o=s+"."+e.get("code"),a=$o.createView();a.set("parent",i.get("id")),a.set("name",e.get("name")),a.set("code",e.get("code")),a.set("query",JSON.stringify({designer:1,select:[{a:"id"},"id",{a:"name"},"name",{a:"code"},"code",{a:"npp"},"npp"],from:[{a:o}],order:[{a:"npp"},",",{a:"name"}]},null,"\t")),a.set("layout",JSON.stringify({designer:1,olap:{id:"olap",view:o,actions:[{fn:o+".card",text:$o.getString("Open"),iconCls:"gi_edit",active:"common.recordSelected"},{fn:o+".create",text:$o.getString("Add"),iconCls:"gi_circle_plus"},{fn:o+".remove",text:$o.getString("Remove"),iconCls:"gi_circle_minus",active:"common.recordSelected"}]}},null,"\t")),a.set("iconCls","gi_book"),a.sync(),_.each([{code:"id",name:"id",width:75,area:0},{code:"name",name:$o.getString("Name"),width:500,area:1},{code:"code",name:$o.getString("Code"),width:75,area:0},{code:"npp",name:$o.getString("N"),width:75,area:0}],function(e,t){var n=$o.createViewAttr();n.set("view",a.get("id")),n.set("code",e.code),n.set("name",e.name),n.set("width",e.width),n.set("area",e.area),n.set("order",t+1),n.sync()})}}),Ext.define("$o.Views.Widget",{extend:"$o.Layout.Widget",alias:["widget.$o.views","widget.$views"],initComponent:function(){var me=this;me.$layout={split:{orientation:"horizontal",width:290,pages:[{treegrid:{id:"olap",view:"system.views",fields:{id:"id",parent:"parent_id"},filter:{fn:function(){return["system","is null","and","end_id","=",2147483647]},all:!0},actions:[{fn:function(){$zu.dialog.getNameAndCode({title:$o.getString("View",":","Adding"),success:function(e,t){var n=$o.startTransaction({description:"Create view"}),r=$o.createView();r.set("parent",this.getCurrentValue("id")),r.set("name",e),r.set("code",t),r.sync(),$o.commitTransaction(n),this.refresh({callback:function(e,t,n){n&&this.selectRow({filter:["&id","=",r.get("id")]})},scope:this})},scope:this})},caption:"create",icon:"new"},{fn:function(){common.confirm({message:$zr.getString("Are you sure?"),scope:this,fn:function(e){if("yes"==e){var t=this.getCurrentValue("id"),n=$o.startTransaction({description:"Remove view "+t}),r=$o.getView(t);r.remove(),r.sync(),$o.commitTransaction(n),this.refresh()}}})},active:{fn:function(){var e=this.getCurrentValue("id")&&!this.getCurrentValue("schema_id");return e}},caption:"delete",icon:"delete"},{fn:function(){var e=$o.viewsMap[this.getCurrentValue("id")];$o.app.show.call($o.app,{record:e})},active:{fn:function(){var e=this.getCurrentValue("id");return e}},caption:$o.getString("Review"),iconCls:"gi_eye_open"}]}},{tab:{listeners:{tabchangeTODO:function(e,t){var n=this;if(t.title==$o.getString("Query")||t.title==$o.getString("Layout")){var r=t.getItems()[0],s=r.getValue(),i=Ext.getDom(r.inputEl);n.editor&&n.editor.toTextArea();var o=t.getHeight(!0);Ext.util.CSS.updateRule(".CodeMirror-scroll","height",o+"px"),n.editor=CodeMirror.fromTextArea(i,{lineNumbers:!0,indentUnit:4,readOnly:!1,mode:{name:"javascript",json:!0}}),n.editor.setValue(s)}}},pages:[{cardConf:{id:"commonCard",title:$o.getString("Commons"),iconCls:"gi_edit",tbar:[{text:$o.getString("Dependencies"),iconCls:"gi_link",handler:function(){var e=this.up("*[name=views]").relatives.olap.getValue("id"),t=$o.getView(e).getFullCode(),n=[];_.each($o.viewsMap,function(e,r){e.get("layout")&&e.get("layout").indexOf(t)>-1&&n.push({id:e.get("id"),path:e.getFullCode(),name:e.get("name")})});var r=Ext.create("Ext.Window",{width:600,height:600,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:$o.getString("Dependencies")+": "+$o.getString("Views"),iconCls:"gi_link",bodyPadding:5,modal:1,items:{xtype:"grid",name:"grid",store:{type:"json",fields:["id","path","name"],data:n},columns:[{text:"id",dataIndex:"id"},{text:$o.getString("Code"),dataIndex:"path"},{text:$o.getString("Name"),dataIndex:"name"}],width:"100%",forceFit:!0,columnLines:!0,rowLines:!0}});r.show()}}],items:[{conf:"view",id:"olap",attr:"id.name",fieldLabel:$o.getString("Name")},{conf:"view",id:"olap",attr:"id.code",fieldLabel:$o.getString("Code"),allowBlank:!1,maskRe:/[A-Za-z0-9\_]/},{conf:"view",id:"olap",attr:"id.parent",fieldLabel:$o.getString("Parent"),confRef:"view",choose:{type:"view",id:"system.views",attr:"olap.id",width:500,height:400}},{conf:"view",id:"olap",attr:"id.description",fieldLabel:$o.getString("Description"),xtype:"textarea",height:150},{conf:"view",id:"olap",attr:"id.iconCls",fieldLabel:$o.getString("Icon"),xtype:"$iconselector"}],active:{fn:function(){return!this.relatives.olap.getCurrentValue("schema_id")}}}},{cardConf:{id:"queryCard",title:$o.getString("Query"),iconCls:"gi_cogwheel",tbar:[{text:$o.getString("Setting the table columns"),iconCls:"gi_table",handler:function(){var e=Ext.create("Ext.Window",{width:800,height:600,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:$o.getString("Setting the table columns"),bodyPadding:5,modal:1,maximizable:!0,items:{xtype:"$querycolumns",viewId:this.up("*[name=views]").relatives.olap.getValue("id"),schemaId:this.up("*[name=views]").relatives.olap.getCurrentValue("schema_id")}});e.show()}}],listeners:{beforeSave:function(){var me=this,query=me.down("*[attr=id.query]").getValue();query=eval("("+query+")");var r=$o.execute({sql:query,noException:1});r.error&&common.message($o.getString("Error in query")+":\n"+r.error)}},items:[{flex:1,width:"100%",border:0,layout:"fit",items:[{conf:"view",id:"olap",attr:"id.query",hideLabel:!0,xtype:"$querydesigner"}]}],active:{fn:function(){return!this.relatives.olap.getCurrentValue("schema_id")}}}},{cardConf:{id:"layoutCard",title:$o.getString("Layout"),iconCls:"gi_table",items:[{flex:1,width:"100%",border:0,layout:"fit",items:[{conf:"view",id:"olap",attr:"id.layout",hideLabel:!0,xtype:"$layoutdesigner"}]}],active:{fn:function(){return!this.relatives.olap.getCurrentValue("schema_id")}}}}]}}]}},me.callParent(arguments)}}),Ext.define("$o.LayoutEditor",{extend:"Ext.panel.Panel",layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.tbar=[{text:"",name:"ok",iconCls:"gi_ok",handler:e.save,scope:e},{text:$o.getString("Cancel"),name:"cancel",iconCls:"gi_remove",handler:function(){e.up("window").close()}},{text:$o.getString("Convert to splitter"),name:"make_split",iconCls:"gi_share_alt",handler:function(){var t=e.down("codemirrortextarea[name='json']"),n={split:{id:"cmp-"+e.layoutDesigner.counter++,orientation:"horizontal",width:"50%",items:[JSON.parse(t.getValue()),e.layoutDesigner.createEmpty()]}};t.setValue(JSON.stringify(n,null,"\t")),e.save({convertion:1})},scope:e},{text:$o.getString("Convert to tabs"),name:"make_tab",iconCls:"gi_bookmark",handler:function(){var t=e.down("codemirrortextarea[name='json']"),n=JSON.parse(t.getValue());n[e.cmpCode].title=n[e.cmpCode].title||"";var r={tab:{id:"cmp-"+e.layoutDesigner.counter++,items:[n]}};t.setValue(JSON.stringify(r,null,"\t")),e.save({convertion:1})},scope:e}],e.addEvents("beforesave","aftersave","change"),this.callParent(arguments)},changeAttr:function(e,t){var n=this,r=n.down("codemirrortextarea[name='json']"),s=r.getValue();s=JSON.parse(s);for(var i=e.split("."),o=s[n.cmpCode],a=0;a<i.length;a++){if(o[i[a]]=o[i[a]]||{},a==i.length-1){o[i[a]]=t;break}o=o[i[a]]}"title"!=e||t||delete s[n.cmpCode][e],"filter"!=e||t&&0!=t.length||delete s[n.cmpCode][e],n.value=s,r.setValue(JSON.stringify(s,null,"\t"))},save:function(e){var t=this;t.fireEvent("beforesave",e);var n=t.down("codemirrortextarea[name='json']"),r=JSON.parse(n.getValue());t.value=r,t.fireEvent("aftersave",r),t.fireEvent("change",r)},getValue:function(){var e=this;return e.value}}),Ext.define("$o.LayoutOlap.Widget",{extend:"$o.LayoutEditor",alias:["widget.$o.layoutolap","widget.$layoutolap"],cmpCode:"olap",initComponent:function(){var e=this;e.value=e.value||{olap:{id:"cmp-"+e.layoutDesigner.counter++}};var t=null;e.value.olap.filter&&"string"==typeof e.value.olap.filter&&(t=$o.getAction(e.value.olap.filter).get("id")),e.items={xtype:"tabpanel",items:[{layout:"vbox",title:$o.getString("Commons"),iconCls:"gi_edit",bodyPadding:5,items:[{xtype:"textfield",width:"100%",labelWidth:150,fieldLabel:$o.getString("Identifier"),name:"id",style:"margin-top: 5px;",value:e.value.olap.id,listeners:{change:function(){e.changeAttr("id",this.getValue()),e.down("*[name=filter]").setCmpId(this.getValue())}}},{xtype:"textfield",labelWidth:150,width:"100%",fieldLabel:$o.getString("Title"),name:"title",value:e.value.olap.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}}},{xtype:"$iconselector",labelWidth:150,width:"100%",name:"iconCls",value:e.value.olap.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}},{xtype:"$conffield",fieldLabel:$o.getString("Query"),labelWidth:150,name:"view",value:e.value.olap.view,width:"100%",confRef:"view",choose:{type:"custom",fn:function(){var e=this;dialog.getView({hasQuery:1,success:function(t){e.setValue(t.id)}})}},listeners:{afterrender:function(){e.validator()},change:function(){e.validator();var t=this.getValue()?$o.getView(this.getValue()).getFullCode():void 0;e.changeAttr("view",t),e.down("*[name=filter]").setViewId(t?$o.getView(t).get("id"):null),e.down("*[name=total]").setViewId(t?$o.getView(t).get("id"):null)}}},{xtype:"checkbox",width:"100%",name:"wordWrap",labelWidth:150,fieldLabel:$o.getString("Word wrap"),checked:e.value.olap.wordWrap,listeners:{change:function(){e.changeAttr("wordWrap",this.getValue())}}},{xtype:"checkbox",width:"100%",name:"groupedColumns",labelWidth:150,fieldLabel:$o.getString("Grouped header"),checked:e.value.olap.groupedColumns,listeners:{change:function(){e.changeAttr("groupedColumns",this.getValue())}}},{fieldLabel:$o.getString("Filter from action"),xtype:"$conffield",labelWidth:150,name:"filterAction",value:t,width:"100%",confRef:"action",choose:{type:"custom",fn:function(){var e=this;dialog.getAction({success:function(t){e.setValue(t.id)}})}},listeners:{change:function(t){t?(t=$o.getAction(t).getFullCode(),e.down("*[name=filter]").setValue(null),e.down("*[name=filter]").disable()):e.down("*[name=filter]").enable(),e.changeAttr("filter",t)}}},{layout:"hbox",width:"100%",border:0,flex:1,items:[{layout:"fit",width:"30%",height:"100%",title:$o.getString("Menu"),iconCls:"gi_list",bodyPadding:2,items:{xtype:"$actiondesigner",name:"actions",value:e.value.olap.actions,listeners:{change:function(t){e.changeAttr("actions",t)}}}},{layout:"fit",width:"40%",height:"100%",title:$o.getString("Filter"),iconCls:"gi_filter",bodyPadding:2,style:"margin-left: 1px",items:{xtype:"$layoutfilter",name:"filter",layoutDesigner:e.layoutDesigner,disabled:!!t,value:t?null:e.value.olap.filter,$cmpId:e.value.olap.id,$viewId:e.value.olap.view,listeners:{change:function(t){e.changeAttr("filter",t),e.validator.call(this)}}}},{layout:"fit",width:"30%",height:"100%",title:$o.getString("Totals"),iconCls:"gi_calculator",bodyPadding:2,style:"margin-left: 1px",items:{xtype:"$layouttotal",name:"total",layoutDesigner:e.layoutDesigner,value:e.value.olap.total,viewId:e.value.olap.view?$o.getView(e.value.olap.view).get("id"):null,listeners:{change:function(t){e.changeAttr("total",t)}}}}]}]},{layout:"fit",title:$o.getString("Events"),iconCls:"gi_wifi_alt",border:0,items:{xtype:"$eventdesigner",name:"events",value:e.value.olap.listeners,$events:["afterrender","dblclick","cellRenderer"],listeners:{changeevent:function(t){e.changeAttr("listeners",t)}}}},{layout:"fit",title:$o.getString("Source code"),iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)},validator:function(){var e=this,t=e.down("*[name='view']");return t.getValue()?$o.getView(t.getValue()).get("query")?e.down("button[name='ok']").enable():(common.message($o.getString("Selected view does not contain a query")),e.down("button[name='ok']").disable()):e.down("button[name='ok']").disable(),!0}}),Ext.define("$o.LayoutTreegrid.Widget",{extend:"$o.LayoutEditor",alias:["widget.$o.layouttreegrid","widget.$layouttreegrid"],cmpCode:"treegrid",initComponent:function(){var e=this;e.value=e.value||{treegrid:{id:"cmp-"+e.layoutDesigner.counter++}};var t=e.getData();e.items={xtype:"tabpanel",items:[{layout:"vbox",title:$o.getString("Commons"),iconCls:"gi_edit",bodyPadding:5,items:[{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Identifier"),name:"id",style:"margin-top: 5px;",value:e.value.treegrid.id,listeners:{change:function(){e.changeAttr("id",this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Title"),name:"title",value:e.value.treegrid.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}},validator:e.validator},{xtype:"$iconselector",width:"100%",name:"iconCls",value:e.value.treegrid.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}},{xtype:"$conffield",fieldLabel:$o.getString("Query"),name:"view",value:e.value.treegrid.view,width:"100%",confRef:"view",choose:{type:"custom",fn:function(){var t=this;dialog.getView({hasQuery:1,success:function(n){t.setValue(n.id),e.changeAttr("view",n.id?$o.getView(n.id).getFullCode():void 0);var r=e.getData();e.down("*[name='idAttr']").getStore().loadData(r),e.down("*[name='idAttr']").setValue(null),e.down("*[name='parent']").getStore().loadData(r),e.down("*[name='parent']").setValue(null),e.validator.call(t)}})}},listeners:{afterrender:function(){e.validator.call(this)}}},{xtype:"combo",fieldLabel:$o.getString("Node identifier"),name:"idAttr",width:"100%",mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:t}),valueField:"id",displayField:"text",value:e.value.treegrid.fields?e.value.treegrid.fields.id:null,validator:e.validator},{xtype:"combo",fieldLabel:$o.getString("Parent node identifier"),name:"parent",width:"100%",mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:t}),valueField:"id",displayField:"text",value:e.value.treegrid.fields?e.value.treegrid.fields.parent:null,validator:e.validator},{layout:"fit",width:"100%",flex:1,title:$o.getString("Menu"),iconCls:"gi_list",bodyPadding:2,items:{xtype:"$actiondesigner",name:"actions",value:e.value.treegrid.actions,listeners:{change:function(t){e.changeAttr("actions",t)}}}}]},{layout:"fit",title:$o.getString("Events"),iconCls:"gi_wifi_alt",border:0,items:{xtype:"$eventdesigner",name:"events",value:e.value.treegrid.listeners,$events:["dblclick"],listeners:{changeevent:function(t){e.changeAttr("listeners",t)}}}},{layout:"fit",title:$o.getString("Source code"),iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)},getData:function(){var e=this,t=[];if(e.value.treegrid.view){var n=$o.getView(e.value.treegrid.view);for(var r in n.attrs){var s=n.attrs[r];if(s.get("classAttr")){var i=$o.getClassAttr(s.get("classAttr"));if(!(2==i.get("type")||12==i.get("type")||i.get("type")>=1e3))continue}t.push([r,s.toString()])}}return t},validator:function(){var e=this.up("panel[cmpCode='treegrid']"),t=e.down("*[name='view']"),n=e.down("*[name='idAttr']"),r=e.down("*[name='parent']");return n.getValue()&&r.getValue()&&n.getValue()!=r.getValue()?(n.getValue()&&r.getValue()&&e.changeAttr("fields",{id:n.getValue(),parent:r.getValue()}),t.getValue()?$o.getView(t.getValue()).get("query")?e.down("button[name='ok']").enable():(common.message($o.getString("Selected view does not contain a query")),e.down("button[name='ok']").disable()):e.down("button[name='ok']").disable(),!0):(e.down("button[name='ok']").disable(),!0)}}),Ext.define("$o.LayoutSplit.Widget",{extend:"$o.LayoutEditor",alias:["widget.$o.layoutsplit"],cmpCode:"split",initComponent:function(){var e=this;e.value=e.value||{split:{id:"cmp-"+e.layoutDesigner.counter++,orientation:"horizontal",width:"50%",items:[e.layoutDesigner.createEmpty(),e.layoutDesigner.createEmpty()]}};var t,n=e.value.split.width||e.value.split.height;"string"==typeof n?(t="%",n=n.substr(0,n.length-1)):t="px",e.items={xtype:"tabpanel",items:[{layout:"vbox",title:$o.getString("Commons"),iconCls:"gi_edit",bodyPadding:5,items:[{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Identifier"),name:"id",style:"margin-top: 5px;",value:e.value.split.id,listeners:{change:function(){e.changeAttr("id",this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Title"),name:"title",value:e.value.split.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}}},{xtype:"$iconselector",width:"100%",name:"iconCls",value:e.value.split.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}},{xtype:"combo",fieldLabel:$o.getString("Orientation"),name:"orientation",width:"100%",triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["horizontal",$o.getString("Horizontal")],["vertical",$o.getString("Vertical")]]}),valueField:"id",displayField:"text",style:"margin-top: 5px;",value:e.value.split.orientation,listeners:{select:function(){e.changeAttr("orientation",this.getValue())}}},{xtype:"compositefield",fieldLabel:$o.getString("Width (height) of left (top) component"),items:[{xtype:"numberfield",name:"width",value:n,width:100,validator:function(t){return this.getValue()?e.down("button[name='ok']").enable():e.down("button[name='ok']").disable(),"%"==e.down("*[name=ed]").getValue()?e.changeAttr("width",this.getValue()+"%"):e.changeAttr("width",Number(this.getValue())),!0}},{xtype:"combo",name:"ed",width:50,triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["%","%"],["px","px"]]}),valueField:"id",displayField:"text",style:"margin-left: 2px;",value:t,listeners:{select:function(){"%"==this.getValue()?(e.down("*[name=width]").getValue()>90&&e.down("*[name=width]").setValue(90),e.changeAttr("width",e.down("*[name=width]").getValue()+"%")):e.changeAttr("width",Number(e.down("*[name=width]").getValue()))}}}]}]},{layout:"fit",title:$o.getString("Source code"),iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)}}),Ext.define("$o.LayoutTab.Widget",{extend:"$o.LayoutEditor",alias:["widget.$o.layouttab"],cmpCode:"tab",initComponent:function(){var e=this,t=e.layoutDesigner.createEmpty();t.panel.title=$o.getString("Tab"),e.value=e.value||{tab:{id:"cmp-"+e.layoutDesigner.counter++,items:[t]}},e.items={xtype:"tabpanel",items:[{layout:"vbox",title:$o.getString("Commons"),iconCls:"gi_edit",bodyPadding:5,items:[{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Identifier"),name:"id",style:"margin-top: 5px;",value:e.value.tab.id,listeners:{change:function(){e.changeAttr("id",this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Title"),name:"title",value:e.value.tab.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}}},{xtype:"$iconselector",width:"100%",name:"iconCls",value:e.value.tab.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}}]},{layout:"fit",title:$o.getString("Source code"),iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)}}),Ext.define("$o.LayoutCondition.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.layoutcondition","widget.$layoutcondition"],layout:"vbox",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.filter=e.filter||[],e.value={},e.tbar=[{text:"",iconCls:"gi_ok",name:"save",disabled:1,handler:e.save,scope:e},{text:$o.getString("Cancel"),iconCls:"gi_remove",name:"cancel",handler:function(){e.up("window").close()}}];var t=[];for(var n in e.$view.attrs){var r=e.$view.attrs[n];t.push([n,r.toString()])}e.items=[{xtype:"combo",fieldLabel:$o.getString("And","/","Or"),labelWidth:200,name:"and_or",width:350,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["and",$o.getString("And")],["or",$o.getString("Or")]]}),valueField:"id",displayField:"text"},{xtype:"combo",fieldLabel:$o.getString("Attribute of this component"),name:"attr",width:"100%",labelWidth:200,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:t}),valueField:"id",displayField:"text",validator:e.validator},{xtype:"combo",fieldLabel:$o.getString("Operator"),labelWidth:200,name:"oper",width:350,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["=",$o.getString("equal")+" (=)"],["<>",$o.getString("not equal")+" (<>)"],["<",$o.getString("less")+" (<)"],[">",$o.getString("more")+" (>)"],["<=",$o.getString("less or equal")+" (<=)"],[">=",$o.getString("more or equal")+" (>=)"],["is null",$o.getString("empty")+" (is null)"],["is not null",$o.getString("not null")+" (is not null)"],["in",$o.getString("one of list")+" (in)"]]}),valueField:"id",displayField:"text",listeners:{select:function(){var t=this.getValue();"is null"==t||"is not null"==t?(e.down("*[name='value']").disable(),e.down("*[name='attrValue']").disable()):(e.down("*[name='value']").enable(),"in"==t?e.down("*[name='attrValue']").disable():e.down("*[name='attrValue']").enable())}},validator:e.validator},{xtype:"textfield",fieldLabel:$o.getString("Value"),labelWidth:200,width:"100%",name:"value",validator:e.validator},{xtype:"combo",fieldLabel:$o.getString("Attribute of another component"),name:"attrValue",width:"100%",labelWidth:200,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:e.getOtherAttrs()}),valueField:"id",displayField:"text",validator:e.validator}],e.filter.length||e.items.splice(0,1),e.items[0].style="margin-top: 5px;",e.addEvents("aftersave"),this.callParent(arguments)},validator:function(e){var t=this.up("panel"),n=t.down("*[name='and_or']"),r=t.down("*[name='attr']"),s=t.down("*[name='oper']"),i=t.down("*[name='value']"),o=t.down("*[name='attrValue']");if(n&&!n.getValue())return t.down("button[name='save']").disable(),!0;if(r.getValue()&&s.getValue()&&("is null"==s.getValue()||"is not null"==s.getValue()||i.getValue()||o.getValue())){if(t.down("button[name='save']").enable(),"is null"==s.getValue()||"is not null"==s.getValue())t.value=[r.getValue(),s.getValue()];else{var a=i.getValue();if(o.getValue()){var l=o.getValue();a={id:l.split(":")[0],attr:l.split(":")[1]}}t.value=[r.getValue(),s.getValue(),a]}n&&(t.value=[n.getValue()].concat(t.value))}else t.down("button[name='save']").disable(),t.value=[];return!0},getOtherAttrs:function(){var e=this,t=[],n=function(r){if("object"==typeof r)for(var s in r)if(r[s]){if(r[s].id&&r[s].view&&r[s].id!=e.$cmpId){var i=$o.getView(r[s].view);for(var o in i.attrs)t.push([r[s].id+":"+o,r[s].id+":"+i.attrs[o].toString()])}n(r[s])}};return n(e.layoutDesigner.value),t},save:function(){var e=this;e.fireEvent("aftersave",e.value)},getValue:function(){var e=this;return e.value}}),Ext.define("$o.LayoutFilter.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.layoutfilter","widget.$layoutfilter"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.value=e.value||[],e.classMode||(e.$view=$o.getView(e.$viewId));var t=e.getItems();t.width="100%",t.flex=1,e.items=t,e.tbar=[{text:$o.getString("Add"),name:"create",iconCls:"gi_circle_plus",handler:e.createCondition,scope:e},{text:$o.getString("Clear"),name:"delete",iconCls:"gi_circle_minus",scope:e,handler:function(){e.value=[],e.build(),e.fireEvent("change",e.value)}}],e.addEvents("change"),this.callParent(arguments)},build:function(){var e=this,t=e.getItems();e.removeAll(),e.add(t),e.doLayout()},createCondition:function(){var e=this,t="$o.layoutcondition";e.classMode&&(t="$o.querycondition"),e.reportMode&&(t="$o.reportcondition");var n=Ext.create("Ext.Window",{width:600,height:400,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:$o.getString("Condition"),iconCls:"gi_filter",bodyPadding:5,modal:1,items:{xtype:t,filter:e.value,$cmpId:e.$cmpId,$view:e.$view,$classes:e.$classes,$classAliases:e.$classAliases,$aliases:e.$aliases,layoutDesigner:e.layoutDesigner,listeners:{aftersave:function(t){n.close(),e.value=e.value||[],e.value=e.value.concat(t),e.build(),e.fireEvent("change",e.value)}}}});n.show()},getItems:function(){function e(r,s){for(var i=0;i<r.length;i++){var o=(s?s:"")+(i+1)+".",a="";if(o.split(".").length>2)for(var l=0;l<o.length;l++)a+="_";Ext.isArray(r[i])?e(r[i],o):("and"==r[i+2]||"or"==r[i+2]||i==r.length-2?(n.push({attr:a+t.getAttrName(r[i]),oper:t.getOperName(r[i+1])}),i+=2):(n.push({attr:a+t.getAttrName(r[i]),oper:t.getOperName(r[i+1]),value:t.getValueName(r[i+2])}),i+=3),i<r.length&&n.push({attr:a+("and"==r[i]?"":"")}))}}var t=this,n=[];t.value&&e(t.value);var r=Ext.create("Ext.data.Store",{data:n,fields:[{name:"attr",type:"string"},{name:"oper",type:"string"},{name:"value",type:"string"}]}),s=Ext.create("Ext.grid.Panel",{store:r,columns:[{header:$o.getString("Attribute"),width:100,dataIndex:"attr",renderer:t.cellRenderer},{header:$o.getString("Operator"),width:100,dataIndex:"oper",renderer:t.cellRenderer},{header:$o.getString("Value"),width:100,dataIndex:"value",renderer:t.cellRenderer}],forceFit:!0,frame:!1,deferRowRender:!1});return s},getAttrName:function(e,t){var n=this,r=e;if(t&&$o.getView(t).attrs[e])r=$o.getView(t).attrs[e].toString();else if(!n.classMode&&n.$view.attrs[e])r=n.$view.attrs[e].toString();else if(n.classMode&&"object"==typeof e){var s;for(s in e)break;for(var i=0;i<n.$aliases.length;i++)if(n.$aliases[i]==s){var o=$o.getClass(n.$classes[i]);if(o.attrs[e[s]]){r=s+":"+o.attrs[e[s]].toString();break}}}return r},getOperName:function(e){var t={};return t["="]=$o.getString("equal")+" (=)",t["<>"]=$o.getString("not equal")+" (<>)",t["<"]=$o.getString("less")+" (<)",t[">"]=$o.getString("more")+" (>)",t["<="]=$o.getString("less or equal")+" (<=)",t[">="]=$o.getString("more or equal")+" (>=)",t["is null"]=$o.getString("empty")+" (is null)",t["is not null"]=$o.getString("not null")+" (is not null)",t.in=$o.getString("one of list")+" (in)",t[e]},getValueName:function(e){var t=this;if(Ext.isArray(e))return e.join(", ");if("object"==typeof e){if(t.classMode)return t.getAttrName(e);var n=t.layoutDesigner.getCmp(e.id),r=t.layoutDesigner.getCmpCode(e.id),s=n[r].view;return t.getAttrName(e.attr,s)}return e},cellRenderer:function(e,t,n,r,s,i){if(e){var o=e;"string"==typeof o&&(o=o.split('"').join("'")),t.tdAttr='data-qtip="'+o+'"'}return e},setValue:function(e){var t=this;t.value=e,t.build()},setViewId:function(e){var t=this;t.$viewId=e,t.$view=$o.getView(t.$viewId)},setCmpId:function(e){var t=this;t.$cmpId=e},setClasses:function(e,t,n){var r=this;r.$classes=e,r.$classAliases=t,r.$aliases=n},getValue:function(){var e=this;return e.value}}),Ext.define("$o.LayoutCard.Widget",{extend:"$o.LayoutEditor",layout:"fit",border:!1,defaults:{border:!1},alias:["widget.$o.layoutcard","widget.$layoutcard"],cmpCode:"card",initComponent:function(){var e=this,t=e.layoutDesigner?"cmp-"+e.layoutDesigner.counter++:"card";e.value=e.value||{card:{id:t,items:[]}},e.value.card.object=e.value.card.object||[],Ext.isArray(e.value.card.object)||(e.value.card.object=[e.value.card.object]);var n=[{layout:"column",border:0,width:"100%",items:[{columnWidth:.5,border:0,items:[{xtype:"compositefield",width:375,labelWidth:100,fieldLabel:$o.getString("Identifier"),style:"margin-top: 5px;",items:[{xtype:"textfield",name:"id",value:e.value.card.id,listeners:{change:function(){e.changeAttr("id",this.getValue())}}},{xtype:"displayfield",value:$o.getString("Read only")+":",style:"margin-left: 5px;"},{xtype:"checkbox",name:"readOnly",value:e.value.card.readOnly,listeners:{change:function(){e.changeAttr("readOnly",this.getValue())}}}]},{xtype:"textfield",labelWidth:100,width:375,fieldLabel:$o.getString("Title"),name:"title",value:e.value.card.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}}},{xtype:"$iconselector",labelWidth:100,width:375,name:"iconCls",value:e.value.card.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}}]},{columnWidth:.5,border:0,style:"margin-left: 5px",items:[{xtype:"grid",name:"tags",store:{xtype:"store",fields:["clsName","cls","tag","cmpAttrName","cmpAttr"],data:[]},columns:[{text:$o.getString("Class of object"),dataIndex:"clsName",flex:2},{text:$o.getString("Tag of object"),dataIndex:"tag",flex:1},{text:$o.getString("Object by attribute of component"),dataIndex:"cmpAttrName",flex:2},{text:"cls",dataIndex:"cls",hidden:!0},{text:"cmpAttr",dataIndex:"cmpAttr",hidden:!0}],tbar:[{text:$o.getString("Add"),iconCls:"gi_circle_plus",handler:function(){var t=Ext.create("Ext.Window",{title:$o.getString("Tag",":","Adding"),width:600,height:400,layout:"vbox",bodyPadding:5,border:!1,resizable:!0,closable:!0,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",tbar:[{text:$o.getString("Add"),iconCls:"gi_circle_plus",handler:function(){var n=e.down("*[name=tags]").getStore(),r=t.down("*[name=cls]").getValue(),s=t.down("*[name=tag]").getValue();n.insert(n.getCount(),{cls:r,clsName:r?$o.getClass(r).toString():null,tag:s,cmpAttr:t.down("*[name=cmpAttr]").getValue()}),r?e.value.card.object.push({cls:$o.getClass(r).getFullCode(),tag:s}):e.value.card.object.push({tag:s}),t.close()}}],items:[{xtype:"$conffield",fieldLabel:$o.getString("Object class"),labelWidth:200,name:"cls",width:"100%",confRef:"class",choose:{type:"custom",fn:function(){var e=this;dialog.getClass({success:function(t){e.setValue(t.id)}})}}},{xtype:"textfield",fieldLabel:$o.getString("Tag of object"),labelWidth:200,width:"100%",name:"tag"},{xtype:"combo",fieldLabel:$o.getString("Object by attribute of component"),name:"cmpAttr",anchor:"100%",labelWidth:200,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:e.layoutDesigner?e.getViewCmpAttrs(JSON.parse(e.layoutDesigner.getValue())):[]}),width:"100%",valueField:"id",displayField:"text"}]});t.show()}},{text:$o.getString("Remove"),iconCls:"gi_circle_minus",handler:function(){var t=e.down("*[name=tags]");if(t.getSelectionModel().hasSelection()){for(var n=t.getSelectionModel().getSelection()[0],r=0;r<e.value.card.object.length;r++){if(n.get("cls")){var s=$o.getClass(n.get("cls"));if(s.getFullCode()==e.value.card.object[r].cls){e.value.card.object.splice(r,1);break}}if(n.get("cmpAttr")&&n.get("cmpAttr")==e.value.card.object[r].cmpAttr){e.value.card.object.splice(r,1);break}}t.getStore().remove(n)}}}],width:"100%",forceFit:!0,height:90,border:1,selModel:Ext.create("Ext.selection.RowModel",{mode:"SINGLE",listeners:{selectionchange:function(t,n){if(n.length){var r=n[0].get("cls");e.down("*[name=cardDesigner]").setClassId(r,n[0].get("tag")),e.down("*[name=cardDesigner]").down("*[name=tree]").getSelectionModel().deselectAll()}},scope:e}}),listeners:{afterrender:function(){if(e.value.card.object){Ext.isArray(e.value.card.object)||(e.value.card.object=[e.value.card.object]);for(var t=0;t<e.value.card.object.length;t++){var n=$o.getClass(e.value.card.object[t].cls);e.value.card.object[t].cls=n.get("id"),e.value.card.object[t].clsName=n.toString()}this.getStore().loadData(e.value.card.object)}}}}]}]}];n.push({layout:"fit",title:$o.getString("Card",":","Attributes"),name:"cardDesigner",width:"100%",border:1,flex:1,xtype:"$carddesigner",layoutCard:e,value:e.value.card.items}),e.items={xtype:"tabpanel",items:[{layout:"vbox",title:$o.getString("Commons"),iconCls:"gi_edit",bodyPadding:5,items:n},{layout:"fit",title:$o.getString("Events"),iconCls:"gi_wifi_alt",border:0,items:{xtype:"$eventdesigner",name:"events",value:e.value.card.listeners,$events:["aftersave","afterrender","beforerender"],
listeners:{changeevent:function(t){e.changeAttr("listeners",t)}}}},{layout:"fit",title:" ",iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},e.addEvents("change"),e.on("beforesave",function(t){if(!t.convertion){e.value.card.items=e.down("*[name=cardDesigner]").getValue();for(var n=0;n<e.value.card.object.length;n++)delete e.value.card.object[n].clsName,e.value.card.object[n].cls=$o.getClass(e.value.card.object[n].cls).getFullCode();e.down("*[name=json]").setValue(JSON.stringify(e.value,null,"\t"))}}),this.callParent(arguments)},validator:function(){var e=this.up("panel");return e.down("*[name=cls]").getValue()&&(e.down("*[name=tag]").getValue()||e.down("*[name=cmpAttr]").getValue())?e.up("window").down("button[name=ok]").enable():e.up("window").down("button[name=ok]").disable(),!0},getViewCmpAttrs:function(layout){var me=this;try{"string"==typeof layout&&(layout=eval("("+layout+")"))}catch(e){}if(!layout)return[];var data=[];me.cmpAttrId={};var get=function(e){if("object"==typeof e)for(var t in e)if(e[t]){if(e[t].id&&e[t].view){v=$o.getView(e[t].view);for(var n in v.attrs){var r=v.attrs[n];if(r.get("classAttr")){var s=$o.getClassAttr(r.get("classAttr"));if(!(2==s.get("type")||12==s.get("type")||s.get("type")>=1e3))continue}data.push([e[t].id+"."+n,e[t].id+":"+r.toString()]),me.cmpAttrId[e[t].id+"."+n]=r.get("id")}}get(e[t])}};return get(layout),data},setValue:function(e){var t=this;t.value=e,t.value.card.object=t.value.card.object||[],Ext.isArray(t.value.card.object)||(t.value.card.object=[t.value.card.object]),t.down("*[name=json]").setValue(JSON.stringify(e,null,"\t")),t.build()},getValue:function(){var e=this;return e.value}}),Ext.define("$o.LayoutTotal.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.layouttotal","widget.$layouttotal"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.value=e.value||{},e.tbar=[{text:$o.getString("Clear"),name:"delete",iconCls:"gi_circle_minus",scope:e,handler:function(){e.value={},e.build(),e.fireEvent("change",e.value)}}],e.store=Ext.create("Ext.data.Store",{data:[],autoSync:!0,fields:[{name:"attr",type:"string"},{name:"total",type:"string"}],listeners:{datachanged:e.datachanged,scope:e}});var t=new Ext.grid.plugin.CellEditing({clicksToEdit:1});e.grid=Ext.create("Ext.grid.Panel",{store:e.store,columns:[{header:$o.getString("Attribute"),dataIndex:"attr"},{header:$o.getString("Total"),width:100,dataIndex:"total",editor:{xtype:"combo",mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["sum",$o.getString("Sum")],["avg",$o.getString("Average")],["max",$o.getString("Max")],["min",$o.getString("Min")]]}),valueField:"id",displayField:"text"},renderer:function(e,t,n,r,s,i){switch(t.tdAttr+=' style=";border: 1px gray solid;"',e){case"sum":e=$o.getString("Sum");break;case"avg":e=$o.getString("Average");break;case"max":e=$o.getString("Max");break;case"min":e=$o.getString("Min")}return e}}],plugins:[t],forceFit:!0,frame:!1,deferRowRender:!1}),e.items=e.grid,e.addEvents("change"),e.build(),this.callParent(arguments)},datachanged:function(){var e=this;if(e.store){e.value={};for(var t=0;t<e.store.getCount();t++)e.store.getAt(t).get("total")&&(e.value[e.store.getAt(t).get("attr")]=e.store.getAt(t).get("total"));e.fireEvent("change",e.value)}},setViewId:function(e){var t=this;t.viewId!=e&&(t.value={}),t.viewId=e,t.build()},build:function(){var e=this,t=$o.getView(e.viewId)||{},n=[];for(var r in t.attrs){var s=t.attrs[r];s.get("classAttr")&&2!=$o.getClassAttr(s.get("classAttr")).get("type")||n.push([r,e.value[r]])}e.store.loadData(n)}}),Ext.define("$o.LayoutChart.Widget",{extend:"$o.LayoutEditor",alias:["widget.$o.layoutchart","widget.$layoutchart"],cmpCode:"chart",border:1,initComponent:function(){var e=this;e.value=e.value||{chart:{id:"cmp-"+e.layoutDesigner.counter++}},e.storeMark=new Ext.data.ArrayStore({fields:["id","text"],data:[]}),e.storeValue=new Ext.data.ArrayStore({fields:["id","text"],data:[]}),e.items={xtype:"tabpanel",items:[{layout:"vbox",title:$o.getString("Commons"),iconCls:"gi_edit",bodyPadding:5,items:[{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Identifier"),name:"id",style:"margin-top: 5px;",value:e.value.chart.id,listeners:{change:function(){e.changeAttr("id",this.getValue()),e.down("*[name=filter]").setCmpId(this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Title"),name:"title",value:e.value.chart.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}}},{xtype:"$iconselector",width:"100%",name:"iconCls",value:e.value.chart.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}},{xtype:"$conffield",fieldLabel:$o.getString("Query"),name:"view",value:e.value.chart.view,width:"100%",confRef:"view",choose:{type:"custom",fn:function(){var e=this;system.view.selectQuery({success:function(t){e.setValue(t.value),e.fireEvent("change",t.value)}})}},listeners:{afterrender:function(){e.validator()},change:function(){e.validator.call(this);var t=this.getValue()?$o.getView(this.getValue()).getFullCode():void 0;e.changeAttr("view",t),e.down("*[name=filter]").setViewId(t?$o.getView(t).get("id"):null),e.updateStores(this.getValue())}}},{xtype:"combo",fieldLabel:$o.getString("Mark",":","Attribute"),name:"attrMark",width:"100%",mode:"local",queryMode:"local",editable:!1,store:e.storeMark,value:e.value.chart.attrMark,valueField:"id",displayField:"text",validator:e.validator,listeners:{select:function(){e.changeAttr("attrMark",this.getValue())}}},{xtype:"combo",fieldLabel:$o.getString("Value",":","Attribute"),name:"attrValue",width:"100%",mode:"local",queryMode:"local",editable:!1,store:e.storeValue,value:e.value.chart.attrValue,valueField:"id",displayField:"text",validator:e.validator,listeners:{select:function(){e.changeAttr("attrValue",this.getValue())}}},{xtype:"textfield",fieldLabel:$o.getString("Title of marks"),width:"100%",name:"titleMark",validator:e.validator,value:e.value.chart.titleMark,listeners:{change:function(){e.changeAttr("titleMark",this.getValue())}}},{xtype:"textfield",fieldLabel:$o.getString("Title of values"),width:"100%",name:"titleValue",validator:e.validator,value:e.value.chart.titleValue,listeners:{change:function(){e.changeAttr("titleValue",this.getValue())}}},{layout:"fit",width:"100%",flex:1,title:$o.getString("Filter"),iconCls:"gi_filter",bodyPadding:2,items:{xtype:"$layoutfilter",name:"filter",layoutDesigner:e.layoutDesigner,value:e.value.chart.filter,$cmpId:e.value.chart.id,$viewId:e.value.chart.view,listeners:{change:function(t){e.changeAttr("filter",t),e.validator.call(this)}}}}]},{layout:"fit",title:$o.getString("Source code"),iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)},updateStores:function(e){var t=this;t.down("*[name=attrMark]").setValue(null),t.down("*[name=attrValue]").setValue(null);var n=[];if(e){var r=$o.getView(e);for(var s in r.attrs)n.push([s,r.attrs[s].toString()])}if(t.storeMark.loadData(n),n=[],e){var r=$o.getView(e);for(var s in r.attrs){var i=r.attrs[s];i.get("classAttr")&&2!=$o.getClassAttr(i.get("classAttr")).get("type")||n.push([s,i.toString()])}}t.storeValue.loadData(n)},validator:function(){var e=this.up("window");return e.down("*[name=view]").getValue()&&e.down("*[name=attrMark]").getValue()&&e.down("*[name=attrValue]").getValue()?e.down("button[name='ok']").enable():e.down("button[name='ok']").disable(),!0}}),Ext.define("$o.LayoutImage.Widget",{extend:"$o.LayoutEditor",alias:["widget.$o.layoutimage","widget.$layoutimage"],cmpCode:"image",border:1,initComponent:function(){var e=this;e.value=e.value||{image:{id:"cmp-"+e.layoutDesigner.counter++}},e.store=new Ext.data.ArrayStore({fields:["id","text"],data:e.getOtherAttrs()}),e.items={xtype:"tabpanel",items:[{layout:"vbox",title:$o.getString("Commons"),iconCls:"gi_edit",bodyPadding:5,items:[{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Identifier"),name:"id",style:"margin-top: 5px;",value:e.value.image.id,validator:e.validator,listeners:{change:function(){e.changeAttr("id",this.getValue()),e.down("*[name=filter]").setCmpId(this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Title"),name:"title",value:e.value.image.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}}},{xtype:"$iconselector",width:"100%",name:"iconCls",value:e.value.image.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Reference")+" (URL)",name:"url",value:e.value.image.url,validator:e.validator,listeners:{change:function(){e.changeAttr("url",this.getValue()),e.down("*[name=attr]").setValue(null)}}},{xtype:"combo",fieldLabel:$o.getString("Component attribute"),name:"attr",width:"100%",mode:"local",queryMode:"local",editable:!1,store:e.store,value:e.value.image.attr,valueField:"id",displayField:"text",validator:e.validator,listeners:{select:function(){e.changeAttr("attr",this.getValue()),e.down("*[name=url]").setValue(null)}}},{xtype:"numberfield",width:300,fieldLabel:$o.getString("Width"),name:"width",value:e.value.image.width,validator:e.validator,listeners:{change:function(){e.changeAttr("width",this.getValue())}}},{xtype:"numberfield",width:300,fieldLabel:$o.getString("Height"),name:"height",value:e.value.image.height,validator:e.validator,listeners:{change:function(){e.changeAttr("height",this.getValue())}}}]},{layout:"fit",title:$o.getString("Source code"),iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)},getOtherAttrs:function(){var e=this,t=[],n=function(r){function s(e){if(e)for(var n=0;n<e.length;n++){var o=e[n],a=c.attrs[o.attr];o.objectId&&o.attr&&a&&5==a.get("type")&&t.push([r[i].id+"."+o.attr,r[i].id+":"+a.toString()]),o.items&&s(o.items)}}if("object"==typeof r)for(var i in r)if(r[i]){if(r[i].id&&r[i].id!=e.$cmpId){if(r[i].view){var o=$o.getView(r[i].view);for(var a in o.attrs){var l=o.attrs[a];l.get("classAttr")&&5==$o.getClassAttr(l.get("classAttr")).get("type")&&t.push([r[i].id+"."+a,r[i].id+":"+l.toString()])}}if("card"==i&&r[i].object&&r[i].object.cls){var c=$o.getClass(r[i].object.cls);s(r[i].items)}}n(r[i])}};return n(e.layoutDesigner.value),t},validator:function(){var e=this.up("window");return e.down("*[name=id]").getValue()&&(e.down("*[name=url]").getValue()||e.down("*[name=attr]").getValue())?e.down("button[name='ok']").enable():e.down("button[name='ok']").disable(),!0}}),Ext.define("$o.LayoutFrame.Widget",{extend:"$o.LayoutEditor",alias:["widget.$o.layoutframe","widget.$layoutframe"],cmpCode:"frame",border:0,initComponent:function(){var e=this;e.value=e.value||{frame:{id:"cmp-"+e.layoutDesigner.counter++}},e.store=new Ext.data.ArrayStore({fields:["id","text"],data:e.getOtherAttrs()}),e.items={xtype:"tabpanel",items:[{layout:"vbox",title:$o.getString("Commons"),iconCls:"gi_edit",bodyPadding:5,items:[{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Identifier"),name:"id",style:"margin-top: 5px;",value:e.value.frame.id,validator:e.validator,listeners:{change:function(){e.changeAttr("id",this.getValue()),e.down("*[name=filter]").setCmpId(this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Title"),name:"title",value:e.value.frame.title,listeners:{change:function(){e.changeAttr("title",this.getValue())}}},{xtype:"$iconselector",width:"100%",name:"iconCls",value:e.value.frame.iconCls,listeners:{change:function(){e.changeAttr("iconCls",this.getValue())}}},{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Reference")+" (URL)",name:"url",value:e.value.frame.url,validator:e.validator,listeners:{change:function(){e.changeAttr("url",this.getValue()),e.down("*[name=attr]").setValue(null)}}},{xtype:"combo",fieldLabel:$o.getString("Component attribute"),name:"attr",width:"100%",mode:"local",queryMode:"local",editable:!1,store:e.store,value:e.value.frame.attr,valueField:"id",displayField:"text",validator:e.validator,listeners:{select:function(){e.changeAttr("attr",this.getValue()),e.down("*[name=url]").setValue(null)}}}]},{layout:"fit",title:$o.getString("Source code"),iconCls:"gi_notes",border:0,items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)},getOtherAttrs:function(){var e=this,t=[],n=function(r){if("object"==typeof r)for(var s in r)if(r[s]){if(r[s].id&&r[s].view&&r[s].id!=e.$cmpId){var i=$o.getView(r[s].view);for(var o in i.attrs){var a=i.attrs[o];"olap"!=s&&"treegrid"!=s||!a.get("classAttr")||1!=$o.getClassAttr(a.get("classAttr")).get("type")||t.push([r[s].id+"."+o,r[s].id+":"+a.toString()])}}n(r[s])}};return n(e.layoutDesigner.value),t},validator:function(){var e=this.up("window");return e.down("*[name=id]").getValue()&&(e.down("*[name=url]").getValue()||e.down("*[name=attr]").getValue())?e.down("button[name='ok']").enable():e.down("button[name='ok']").disable(),!0}}),Ext.define("$o.ActionDesigner.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.actiondesigner","widget.$actiondesigner"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.tbar=[{text:$o.getString("Open"),iconCls:"gi_edit",handler:e.edit,scope:e},{text:$o.getString("Add"),iconCls:"gi_circle_plus",handler:e.create,scope:e},{text:$o.getString("Remove"),iconCls:"gi_circle_minus",handler:e.remove,scope:e}],e.store=Ext.create("Ext.data.Store",{data:[],fields:[{name:"action",type:"string"},{name:"id",type:"string"}]}),e.grid=Ext.create("Ext.grid.Panel",{store:e.store,columns:[{header:$o.getString("Action"),width:100,dataIndex:"action",renderer:e.cellRenderer},{header:"id",width:100,dataIndex:"id",hidden:!0}],forceFit:!0,frame:!1,deferRowRender:!1,viewConfig:{plugins:{ptype:"gridviewdragdrop"},listeners:{drop:function(t,n,r,s){for(var i=[],o=0;o<e.store.getCount();o++)for(var a=0;a<e.value.length;a++)if(e.value[a].actionId==e.store.getAt(o).get("id")){i.push(e.value[a]);break}e.value=i,e.fireEvent("change",e.value)}}}}),e.items=e.grid,e.on("afterrender",function(){e.value&&e.setValue(e.value)}),this.callParent(arguments)},create:function(){var e=this;dialog.getObject({title:$o.getString("Select","actions"),width:800,height:600,layout:{split:{orientation:"horizontal",width:300,items:[{treegrid:{id:"olapClasses",title:$o.getString("Classes"),view:"system.classes",fields:{id:"id",parent:"parent_id"},filter:["id",">=",1e3]}},{olap:{id:"olap",title:$o.getString("Actions"),view:"system.actions",singleSelect:!1,filter:["class_id","=",{id:"olapClasses",attr:"id"}]}}]}},attr:"olap.id",success:function(t){for(var n=t.values,r=0;r<n.length;r++){var s=$o.getAction(n[r]),i=$o.getClass(s.get("class")),o=i.getFullCode()+"."+s.get("code"),a={actionId:s.get("id"),fn:o,text:s.get("name")};if(s.get("layout")){var l=JSON.parse(s.get("layout"));"create"==l.type&&(a.iconCls="gi_circle_plus"),"remove"==l.type&&(a.iconCls="gi_circle_minus",a.active="common.recordSelected"),"card"==l.type&&(a.iconCls="gi_edit",a.active="common.recordSelected")}e.value=e.value||[],e.value.push(a)}e.build(),e.fireEvent("change",e.value)}})},edit:function(){var e,t,n=this;if(n.grid.getSelectionModel().hasSelection()){var r=n.grid.getSelectionModel().getSelection()[0],s=r.get("id");for(t=0;t<n.value.length;t++)if(n.value[t].actionId==s||n.value[t].fn==s){e=n.value[t];break}var i=Ext.create("Ext.Window",{width:600,height:600,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:$o.getString("Action"),bodyPadding:5,modal:1,items:{xtype:"$actioncard",value:e,listeners:{aftersave:function(e){if(i.close(),n.value[t]=e,n.build(),e.actionId){var r=$o.getAction(e.actionId);r.initAction()}n.fireEvent("change",n.value)}}}});i.show()}},remove:function(){var e=this;if(e.grid.getSelectionModel().hasSelection()){for(var t=e.grid.getSelectionModel().getSelection()[0],n=t.get("id"),r=0;r<e.value.length;r++)if(e.value[r].actionId==n||e.value[r].fn==n){e.value.splice(r,1);break}e.build(),e.fireEvent("change",e.value)}},build:function(){for(var e=this,t=[],n=0;n<e.value.length;n++)if(e.value[n].actionId){var r=$o.getAction(e.value[n].actionId);t.push({action:r.toString(),id:e.value[n].actionId})}else t.push({action:e.value[n].text,id:e.value[n].fn});e.store.loadData(t)},setValue:function(e){var t=this;t.value=e,t.build()},getValue:function(){var e=this;return e.value}}),Ext.define("$o.ActionCard.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.actioncard","widget.$actioncard"],layout:"vbox",border:!1,defaults:{border:!1},bodyPadding:1,initComponent:function(){var e=this;e.value=e.value||{},e.tbar=[{text:"",iconCls:"gi_ok",handler:e.save,name:"save",disabled:1,scope:e},{text:$o.getString("Cancel"),iconCls:"gi_remove",handler:function(){e.up("window").close()},name:"cancel"}],e.items=[{xtype:"$conffield",fieldLabel:$o.getString("Action"),name:"action",width:"100%",confRef:"action",style:"margin-top: 5px",choose:{type:"layout",attr:"olap.id",width:600,height:400,layout:{split:{orientation:"horizontal",width:300,items:[{treegrid:{id:"olapClasses",view:"system.classes",fields:{id:"id",parent:"parent_id"},filter:{fn:function(){return["id",">=",1e3]}}}},{olap:{id:"olap",view:"system.actions",filter:["class_id","=",{id:"olapClasses",attr:"id"}]}}]}}},listeners:{change:function(){if(this.getValue()){var t=$o.getAction(this.getValue());$o.getClass(t.get("class"));if(e.down("*[name=name]").setValue(t.get("name")),t.get("layout")){var n=JSON.parse(t.get("layout"));"create"==n.type&&e.down("*[name=iconCls]").setValue("gi_circle_plus"),"remove"==n.type&&(e.down("*[name=iconCls]").setValue("gi_circle_minus"),e.down("*[name=activeRecordSelected]").setValue(1)),"card"==n.type&&(e.down("*[name=iconCls]").setValue("gi_edit"),e.down("*[name=activeRecordSelected]").setValue(1))}}e.validator()}}},{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Function"),name:"fn",value:e.value.actionId?"":e.value.fn,validator:e.validator},{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Name"),name:"name",value:e.value.text},{xtype:"$iconselector",width:"100%",name:"iconCls",value:e.value.iconCls},{xtype:"checkbox",name:"activeRecordSelected",fieldLabel:$o.getString("Active when record selected"),checked:"common.recordSelected"==e.value.active},{title:$o.getString("Options"),width:"100%",flex:1,xtype:"$actionargs",value:e.value.arguments,listeners:{change:function(t){e.value.arguments=t}}}],e.on("afterrender",function(){e.down("*[name=action]").setValue(e.value.actionId)}),e.addEvents("aftersave"),this.callParent(arguments)},validator:function(){var e=this.up("panel");return e.down("*[name=action]").getValue()||e.down("*[name=fn]").getValue()?e.down("*[name=save]").enable():e.down("*[name=save]").disable(),!0},save:function(){var e,t=this,n=t.down("*[name=action]").getValue(),r=t.value;if(n){r.actionId=n;var s=$o.getAction(n),i=$o.getClass(s.get("class"));e=i.getFullCode()+"."+s.get("code")}else e=t.down("*[name=fn]").getValue();r.fn=e,t.down("*[name=name]").getValue()&&(r.text=t.down("*[name=name]").getValue()),t.down("*[name=iconCls]").getValue()&&(r.iconCls=t.down("*[name=iconCls]").getValue()),t.down("*[name=activeRecordSelected]").getValue()&&(r.active="common.recordSelected"),t.fireEvent("aftersave",r)}}),Ext.define("$o.ActionArgs.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.actionargs","widget.$actionargs"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.value=e.value||{},e.tbar=[{text:$o.getString("Add"),iconCls:"gi_circle_plus",handler:e.create,scope:e},{text:$o.getString("Remove"),iconCls:"gi_circle_minus",handler:e.remove,scope:e}],e.store=Ext.create("Ext.data.Store",{autoSync:!0,data:e.getData(),fields:[{name:"arg",type:"string"},{name:"value",type:"string"}],listeners:{datachanged:e.datachanged,scope:e}}),e.grid=Ext.create("Ext.grid.Panel",{store:e.store,columns:[{header:$o.getString("Option"),width:150,dataIndex:"arg",renderer:e.cellRenderer,editor:{xtype:"textfield"}},{header:$o.getString("Value"),flex:1,dataIndex:"value",renderer:e.cellRenderer,editor:{xtype:"textfield"}}],plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1})],forceFit:!0,frame:!1,deferRowRender:!1}),e.items=e.grid,e.addEvents("change"),this.callParent(arguments)},getData:function(){var e=this,t=[];for(var n in e.value)t.push({arg:n,value:e.value[n]});return t},cellRenderer:function(e,t,n,r,s,i){t.column.dataIndex;return t.tdAttr+=' style=";border: 1px gray solid;"',e},datachanged:function(){var e=this;if(e.store){for(var t={},n=0;n<e.store.getCount();n++){var r=e.store.getAt(n);r.get("arg")&&r.get("value")&&(t[r.get("arg")]=r.get("value"))}e.value=t,e.fireEvent("change",e.value)}},create:function(){var e=this;e.store.insert(e.store.getCount(),{})},remove:function(){var e=this;if(e.grid.getSelectionModel().hasSelection()){var t=e.grid.getSelectionModel().getSelection()[0];e.store.remove(t);var n=t.get("arg");delete e.value[n]}}}),Ext.define("$o.EventDesigner.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.eventdesigner","widget.$eventdesigner"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.tbar=[{text:$o.getString("Open"),iconCls:"gi_edit",handler:e.edit,scope:e},{text:$o.getString("Add"),iconCls:"gi_circle_plus",handler:e.create,scope:e},{text:$o.getString("Remove"),iconCls:"gi_circle_minus",handler:e.remove,scope:e}],e.store=Ext.create("Ext.data.Store",{data:[],fields:[{name:"event",type:"string"},{name:"action",type:"string"},{name:"fn",type:"string"}]}),e.grid=Ext.create("Ext.grid.Panel",{store:e.store,columns:[{header:$o.getString("Event"),flex:1,dataIndex:"event",renderer:e.cellRenderer},{header:$o.getString("Action"),flex:2,dataIndex:"action",renderer:e.cellRenderer},{header:"fn",width:100,dataIndex:"fn",hidden:!0}],forceFit:!0,frame:!1,deferRowRender:!1}),e.items=e.grid,e.on("afterrender",function(){e.setValue(e.value)}),e.addEvents("changeevent"),this.callParent(arguments)},create:function(){var e=this,t=Ext.create("Ext.Window",{width:600,height:400,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:"",bodyPadding:5,modal:1,items:{xtype:"$eventcard",$events:e.$events,listeners:{aftersave:function(n){t.close(),e.value[n.event]=n,delete n.event,e.build(),e.fireEvent("changeevent",e.value)}}}});t.show()},edit:function(){var e,t=this;if(t.grid.getSelectionModel().hasSelection()){var n=t.grid.getSelectionModel().getSelection()[0];e=t.value[n.get("event")],e.event=n.get("event");var r=Ext.create("Ext.Window",{width:600,height:400,layout:"fit",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:$o.getString("Event"),bodyPadding:5,modal:1,items:{xtype:"$eventcard",value:e,$events:t.$events,listeners:{aftersave:function(e){r.close(),t.value[e.event]=e,delete e.event,t.build(),t.fireEvent("changeevent",t.value)}}}});r.show()}},remove:function(){var e=this;if(e.grid.getSelectionModel().hasSelection()){var t=e.grid.getSelectionModel().getSelection()[0];delete e.value[t.get("event")],e.build(),e.fireEvent("changeevent",e.value)}},build:function(){var e=this,t=[];for(var n in e.value){var r=$o.getAction(e.value[n].fn);t.push({event:n,action:r?r.toString():e.value[n].fn,fn:e.value[n].fn})}e.store.loadData(t)},setValue:function(e){var t=this;e=e||{};for(var n in e)"string"==typeof e[n]&&(e[n]={fn:e[n]});t.value=e,t.build()},getValue:function(){var e=this;return e.value}}),Ext.define("$o.EventCard.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.eventcard","widget.$eventcard"],layout:"vbox",border:!1,defaults:{border:!1},bodyPadding:1,initComponent:function(){var e=this;e.value=e.value||{},e.tbar=[{text:"",iconCls:"gi_ok",handler:e.save,name:"save",disabled:1,scope:e},{text:$o.getString("Cancel"),iconCls:"gi_remove",handler:function(){e.up("window").close()},name:"cancel"}];for(var t=$o.getAction(e.value.fn),n=[],r=0;r<e.$events.length;r++)n.push([e.$events[r],e.$events[r]]);e.items=[{xtype:"combo",name:"event",fieldLabel:$o.getString("Event"),width:"100%",triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:n}),value:e.value.event,validator:e.validator,style:"margin-top: 5px",valueField:"id",displayField:"text"},{xtype:"$conffield",fieldLabel:$o.getString("Action"),name:"action",width:"100%",confRef:"action",choose:{type:"layout",attr:"olap.id",width:600,height:400,layout:{split:{orientation:"horizontal",width:300,items:[{treegrid:{id:"olapClasses",view:"system.classes",fields:{id:"id",parent:"parent_id"},filter:{fn:function(){return["id",">=",1e3]}}}},{olap:{id:"olap",view:"system.actions",filter:["class_id","=",{id:"olapClasses",attr:"id"}]}}]}}},listeners:{change:function(){if(this.getValue()){var t=$o.getAction(this.getValue());$o.getClass(t.get("class"))}e.validator()}}},{xtype:"textfield",width:"100%",fieldLabel:$o.getString("Function"),name:"fn",value:t?"":e.value.fn,validator:e.validator},{title:$o.getString("Options"),width:"100%",flex:1,xtype:"$actionargs",value:e.value.arguments,listeners:{change:function(t){e.value.arguments=t}}}],e.on("afterrender",function(){t&&e.down("*[name=action]").setValue(t.get("id"))}),e.addEvents("aftersave"),this.callParent(arguments)},validator:function(){var e=this.up("panel");return e.down("*[name=event]").getValue()&&(e.down("*[name=action]").getValue()||e.down("*[name=fn]").getValue())?e.down("*[name=save]").enable():e.down("*[name=save]").disable(),!0},save:function(){var e,t=this,n=t.down("*[name=action]").getValue();if(n){var r=$o.getAction(n),s=$o.getClass(r.get("class"));e=s.getFullCode()+"."+r.get("code")}else e=t.down("*[name=fn]").getValue();var i=t.value;i.fn=e,i.event=t.down("*[name=event]").getValue(),t.fireEvent("aftersave",i)}}),Ext.define("$o.LayoutDesigner.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.layoutdesigner","widget.$layoutdesigner"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.initCounter(e.value),e.value=e.value||e.createEmpty(),e.treeStore=Ext.create("Ext.data.TreeStore",{root:{expanded:!0,children:[]}}),e.items={xtype:"tabpanel",items:[{title:$o.getString("Constructor"),iconCls:"gi_adjust_alt",layout:"border",name:"constructor",border:!1,items:[{split:!0,width:230,region:"east",layout:"fit",items:{xtype:"treepanel",store:e.treeStore,rootVisible:!1,title:$o.getString("Navigator"),iconCls:"gi_search",border:0,tbar:[{text:$o.getString("Open"),iconCls:"gi_edit",name:"edit",handler:e.edit,scope:e,disabled:1},{text:$o.getString("Add"),iconCls:"gi_circle_plus",name:"create",handler:function(){var t=e.createEmpty();t.panel.title="";var n=e.getCmp(e.selected.id);n.tab.items.push(t),e.addCmp(t.panel.id)},scope:e,disabled:1},{text:$o.getString("Remove"),iconCls:"gi_circle_minus",name:"delete",handler:function(){common.confirm({message:" ?",scope:this,fn:function(t){if("yes"==t){if(!e.removeTab(e.selected.id)){var n=e.createEmpty(),r=e.getCmp(e.selected.id);for(var s in r)delete r[s];Ext.apply(r,n),e.value.designer=1}e.down("button[name='delete']").disable(),e.build()}}})},scope:e,disabled:1}],bbar:[{text:$o.getString("Cancel action"),iconCls:"gi_history",name:"prevValue",disabled:1,handler:function(){e.value=JSON.parse(e.prevValue.pop()),e.prevValue.length||e.down("button[name='prevValue']").disable(),e.build({back:1})}}],listeners:{select:function(t,n,r,s){if(n){var i=n.get("text").split("(id:")[1].split(")")[0],o=e.getCmpCode(i);"panel"!=o?(e.down("button[name='edit']").enable(),e.selected={record:n,id:i,code:o}):e.down("button[name='edit']").disable(),"tab"==o?e.down("button[name='create']").enable():e.down("button[name='create']").disable(),"panel"!=o?e.down("button[name='delete']").enable():e.down("button[name='delete']").disable()}}}}},{region:"center",layout:"fit",border:0,style:"border: 1px solid #00ff00; margin: 1px",bodyPadding:1,items:{xtype:"$o.layout",$layout:$o.util.clone(e.value)}}]},{layout:"fit",title:$o.getString("Source code"),iconCls:"gi_notes",name:"source",items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},e.addEvents("change"),e.on("afterrender",e.setHandlers),this.callParent(arguments)},edit:function(){var e=this,t=e.selected.id,n=e.selected.code,r=Ext.create("Ext.Window",{width:e.getCmpWidth(n),height:e.getCmpHeight(n),resizeable:!1,border:!1,title:e.getCmpName(n),iconCls:e.getCmpIconCls(n),style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",modal:1,layout:"fit",items:{xtype:"$o.layout"+n,layoutDesigner:e,value:e.getCmpValue(t),listeners:{aftersave:function(){r.close(),e.replaceCmp(t,this.getValue()),e.build(),e.fireEvent("change",e.getValue())}}}});r.show()},getCmpCode:function(e){var t=this,n=function(t){if("object"==typeof t)for(var r in t)if(t[r]){if(t[r].id==e)return r;var s=n(t[r]);if(s)return s}if(t.items)for(var i=0;i<t.items.length;i++){var s=n(t.items[i]);if(s)return s}};return n(t.value)},getCmpValue:function(e){var t=this,n=function(t){if("object"==typeof t)for(var r in t)if(t[r]){if(t[r].id==e)return t;var s=n(t[r]);if(s)return s}if(t.items)for(var i=0;i<t.items.length;i++){var s=n(t.items[i]);if(s)return s}};return n(t.value)},getCmpName:function(e){switch(e){case"split":return $o.getString("Splitter");case"tab":return $o.getString("Tabs");case"olap":return $o.getString("Table");case"treegrid":return $o.getString("Tree");case"card":return $o.getString("Card");case"chart":return $o.getString("Chart");case"image":return $o.getString("Image");case"frame":return $o.getString("Frame");case"panel":return $o.getString("Empty")}},getCmpIconCls:function(e){switch(e){case"split":return"gi_share_alt";case"tab":return"gi_share_alt";case"olap":return"gi_table";case"treegrid":return"gi_leaf";case"card":return"gi_edit";case"chart":return"gi_charts";case"image":return"gi_picture";case"frame":return"gi_globe_af";case"panel":return"gi_file"}},getCmpWidth:function(e){switch(e){case"split":return 600;case"tab":return 600;case"olap":return 800;case"treegrid":return 600;case"card":return 800;case"chart":return 600;case"image":return 600;case"frame":return 600}},getCmpHeight:function(e){switch(e){case"split":return 400;case"tab":return 400;case"olap":return 600;case"treegrid":return 600;case"card":return 600;case"chart":return 600;case"image":return 600;case"frame":return 600}},getTreeRecord:function(e){var t=this;e=e||t.value;var n;for(n in e)if("designer"!=n)break;var r=e[n],s={text:t.getCmpName(n)+(r.title?": "+r.title:"")+" (id:"+r.id+")"};if(r.items&&"panel"!=n&&"card"!=n){s.expanded=0,s.children=[];for(var i=0;i<r.items.length;i++)s.children.push(t.getTreeRecord(r.items[i]))}else s.leaf=1;return s},initCounter:function(e){var t=this;if(e=e||{},t.counter=t.counter||1,"object"==typeof e)for(var n in e)e[n]&&t.initCounter(e[n]);if(e.items)for(var r=0;r<e.items.length;r++)t.initCounter(e.items[r]);if(e.id){var s=e.id.split("-");s.length>1&&Number(s[1])>=t.counter&&(t.counter=Number(s[1])+1)}},createEmpty:function(){var e=this,t="cmp-"+e.counter++,n={panel:{id:t,layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"button",text:$o.getString("Select","component"),iconCls:"gi_edit",name:"selectCmp",cmpId:t}]}};return n},build:function(e){var t=this;e=e||{};var n=t.down("*[region='center']");n.removeAll(),n.add({xtype:"$o.layout",$layout:t.updateLayoutTags($o.util.clone(t.value))}),n.doLayout(),t.setHandlers(),t.treeStore.getRootNode().removeAll(),t.treeStore.getRootNode().appendChild(t.getTreeRecord()),t.down("button[name='edit']").disable(),e.back||(t.prevValue=t.prevValue||[],t.prevValue.push(t.down("codemirrortextarea[name='json']").getValue()),
t.down("button[name='prevValue']").enable()),t.down("codemirrortextarea[name='json']").setValue(JSON.stringify(t.value,null,"\t"))},selectCmp:function(e){var t=function(){e.success(this.cmpCode),n.close()},n=Ext.create("Ext.Window",{width:560,height:100,bodyPadding:5,resizeable:!1,border:!1,title:$o.getString("Select","component"),style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",modal:1,layout:"hbox",items:[{xtype:"button",text:$o.getString("Table"),cmpCode:"olap",iconCls:"gib_table",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t},{xtype:"button",text:$o.getString("Tree"),cmpCode:"treegrid",iconCls:"gib_leaf",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t},{xtype:"button",text:$o.getString("Card"),cmpCode:"card",iconCls:"gib_edit",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t},{xtype:"button",text:$o.getString("Chart"),cmpCode:"chart",iconCls:"gib_charts",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t},{xtype:"button",text:$o.getString("Image"),cmpCode:"image",iconCls:"gib_picture",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t},{xtype:"button",text:$o.getString("Frame"),cmpCode:"frame",iconCls:"gib_globe_af",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t},{xtype:"button",text:$o.getString("Splitter"),cmpCode:"split",iconCls:"gib_share_alt",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t},{xtype:"button",text:$o.getString("Tabs"),cmpCode:"tab",iconCls:"gib_bookmark",iconAlign:"top",scale:"large",style:"margin-left: 5px;",handler:t}]});n.show()},getCmp:function(e){var t=this,n=function(t){if("object"==typeof t)for(var r in t)if(t[r]){if(t[r].id==e)return t;var s=n(t[r]);if(s)return s}};return n(t.value)},removeTab:function(e){var t=this,n=function(t){if("object"==typeof t)for(var r in t)if(t[r]){if("tab"==r&&t[r].items.length>1)for(var s=0;s<t[r].items.length;s++){var i;for(i in t[r].items[s])break;if(t[r].items[s][i].id==e)return t[r].items.splice(s,1),1}var s=n(t[r]);if(s)return s}};return n(t.value)},replaceCmp:function(e,t){var n=this,r=function(n){if("object"==typeof n)for(var s in n)if(n[s]){if(n[s].id==e&&["split","tab","olap","treegrid","card","cardConf","chart","image","frame","panel"].indexOf(s)>-1)return delete n[s],void Ext.apply(n,t);r(n[s])}};r(n.value)},addCmp:function(e){var t=this;t.addCmpActive=1,t.selectCmp({success:function(n){var r=Ext.create("Ext.Window",{width:t.getCmpWidth(n),height:t.getCmpHeight(n),resizeable:!1,border:!1,title:t.getCmpName(n),iconCls:t.getCmpIconCls(n),style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",modal:1,layout:"fit",items:{xtype:"$o.layout"+n,layoutDesigner:t,listeners:{aftersave:function(){t.addCmpActive=0,r.close(),t.replaceCmp(e,this.getValue()),t.build(),t.fireEvent("change",t.getValue())}}}});r.show()}})},getValue:function(){var e=this,t=e.down("codemirrortextarea[name='json']").getValue();return t},setValue:function(e){var t=this;if(e){if("string"==typeof e)try{if(e=JSON.parse(e),!e.designer)throw"invalid"}catch(r){var n=t.down("*[region='center']");return n.removeAll(),n.add({layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"label",text:$o.getString("Sorry, we could not decode the source code layout")}]}),t.treeStore.getRootNode().removeAll(),t.down("button[name='edit']").disable(),t.down("button[name='create']").disable(),t.down("button[name='delete']").disable(),t.down("button[name='prevValue']").disable(),t.value=e,t.down("codemirrortextarea[name='json']").setValue(e),void t.down("tabpanel").setActiveTab(t.down("panel[name=source]"))}}else t.counter=1,e=t.createEmpty(),e.designer=1;t.value=e,t.initCounter(t.value),t.build(),t.prevValue=[],t.down("button[name='prevValue']").disable()},setReadOnly:function(e){},updateLayoutTags:function(e){var t=null,n=function(e){function r(n){for(var o=0;o<n.length;o++){var a=n[o];a.objectId&&a.objectId.substr&&"[#"==a.objectId.substr(0,2)&&(i[a.objectId]?a.objectId=i[a.objectId]:t=e[s].id),a.items&&r(a.items)}}if("object"==typeof e){for(var s in e)if(e[s])if("card"==s&&e[s].object){e[s].readOnly=1;for(var i={},o=e[s].object.length?e[s].object:[e[s].object],a=0;a<o.length;a++){var l=$o.createObject(o[a].cls,"local");i[o[a].tag]=l.get("id")}r(e[s].items)}else"card"!=s||e[s].object?"string"==typeof e[s]?"[#"==e[s].substr(0,2)&&(e[s]=0):n(e[s]):e[s].items=[];if(e.items)for(var c=0;c<e.items.length;c++)n(e.items[c])}};return n(e),t&&common.message($o.getString("Class of object in the card is not defined")+": "+t),e},setHandlers:function(){for(var e=this,t=e.query("button[name='selectCmp']"),n=0;n<t.length;n++)t[n].on("click",function(){e.addCmpActive||e.addCmp(this.cmpId)})}}),Ext.define("$o.QuerySort.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.querysort","widget.$querysort"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.value=e.value||[],e.tbar=[{text:$o.getString("Add"),handler:e.create,iconCls:"gi_circle_plus",scope:e},{text:$o.getString("Clear"),iconCls:"gi_circle_minus",handler:e.clear,scope:e}],e.store=Ext.create("Ext.data.Store",{data:[],fields:[{name:"attr",type:"string"},{name:"dir",type:"string"},{name:"alias",type:"string"},{name:"dir_id",type:"string"}]}),e.grid=Ext.create("Ext.grid.Panel",{store:e.store,columns:[{header:$o.getString("Attribute"),width:100,dataIndex:"attr",renderer:e.cellRenderer},{header:$o.getString("Sort"),width:100,dataIndex:"dir",renderer:e.cellRenderer},{header:"alias",width:100,dataIndex:"attr_id",hidden:!0},{header:"dir_id",width:100,dataIndex:"dir_id",hidden:!0}],forceFit:!0,frame:!1,deferRowRender:!1}),e.items=e.grid,e.addEvents("change"),this.callParent(arguments)},cellRenderer:function(e,t,n,r,s,i){if(e){var o=e;"string"==typeof o&&(o=o.split('"').join("'")),t.tdAttr='data-qtip="'+o+'"'}return e},setClasses:function(e,t,n){var r=this;r.$classes=e,r.$classAliases=t,r.$aliases=n},create:function(){for(var e=this,t=[],n=0;n<e.$classes.length;n++){var r=$o.getClass(e.$classes[n]);t.push([e.$aliases[n]+":id",e.$aliases[n]+":id"]);for(var s in r.attrs)t.push([e.$aliases[n]+":"+s,e.$aliases[n]+":"+r.attrs[s].toString()])}var i=Ext.create("Ext.Window",{width:400,height:150,layout:"vbox",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:$o.getString("Select","attribute"),iconCls:"gi_file",bodyPadding:5,modal:1,tbar:[{text:"",iconCls:"gi_ok",name:"create",disabled:1,handler:function(){var t=i.down("*[name=attr]").getValue();e.value=e.value||[],e.value.length&&e.value.push(",");var n={};n[t.split(":")[0]]=t.split(":")[1],e.value.push(n),"DESC"==i.down("*[name=dir]").getValue()?e.value.push("DESC"):e.value.push("ASC"),e.build(),i.close(),e.fireEvent("change",e.value)}},{text:$o.getString("Cancel"),iconCls:"gi_remove",handler:function(){i.close()}}],items:[{xtype:"combo",fieldLabel:$o.getString("Attribute"),name:"attr",width:"100%",mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:t}),valueField:"id",displayField:"text",listeners:{select:function(){this.getValue()?i.down("*[name=create]").enable():i.down("*[name=create]").disable()}}},{xtype:"combo",fieldLabel:$o.getString("Sort"),name:"dir",width:"100%",mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["ASC",$o.getString("Sort ascending")],["DESC",$o.getString("Sort descending")]]}),valueField:"id",displayField:"text"}]});i.show()},clear:function(){var e=this;e.setValue([])},build:function(){var e=this,t=[];if(e.value)for(var n=0;n<e.value.length;n+=2){","==e.value[n]&&n++;var r={};"DESC"==e.value[n+1]?(r.dir=$o.getString("Sort descending"),r.dir_id="DESC"):(r.dir=$o.getString("Sort ascending"),r.dir_id="ASC");var s;for(s in e.value[n])break;for(var i=e.value[n][s],o=0;o<e.$aliases.length;o++)if(e.$aliases[o]==s){var a=$o.getClass(e.$classes[o]);r.attr=s+":"+a.attrs[i].toString(),r.alias=s;break}t.push(r)}e.store.loadData(t)},setValue:function(e){var t=this;t.value=e,t.build(),t.fireEvent("change",e)},getValue:function(){var e=this;return e.value}}),Ext.define("$o.QuerySelect.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.queryselect","widget.$queryselect"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.value=e.value||[],e.tbar=[{text:$o.getString("Choose"),iconCls:"gi_edit",handler:e.addAttrs,scope:e}],e.store=Ext.create("Ext.data.Store",{data:[],fields:[{name:"name",type:"string"},{name:"clsName",type:"string"},{name:"clsFrom",type:"string"},{name:"clsId",type:"number"},{name:"attr",type:"string"},{name:"alias",type:"string"}],sorters:[{property:"name",direction:"ASC"}]}),e.grid=Ext.create("Ext.grid.Panel",{store:e.store,columns:[{header:$o.getString("Attribute"),width:100,dataIndex:"name",renderer:e.cellRenderer},{header:$o.getString("Alias"),width:100,dataIndex:"alias",renderer:e.cellRenderer},{header:$o.getString("Class"),width:100,dataIndex:"clsName",renderer:e.cellRenderer},{header:"clsFrom",width:100,dataIndex:"clsFrom",hidden:!0},{header:"clsId",width:100,dataIndex:"clsId",hidden:!0},{header:"attr",width:100,dataIndex:"attr",hidden:!0}],forceFit:!0,frame:!1,deferRowRender:!1}),e.items=e.grid,e.addEvents("change"),this.callParent(arguments)},cellRenderer:function(e,t,n,r,s,i){if(e){var o=e;"string"==typeof o&&(o=o.split('"').join("'")),t.tdAttr='data-qtip="'+o+'"'}return e},updateSelect:function(){var e=this;e.value=[];for(var t=0;t<e.store.getCount();t++){var n={};n[e.store.getAt(t).get("clsFrom")]=e.store.getAt(t).get("attr"),e.value.push(n),e.value.push(e.store.getAt(t).get("alias"))}e.fireEvent("change",e.value)},addAttrs:function(){var e=this;if(!e.$classes.length)return void common.message($o.getString("Select","class"));for(var t=[],n=0;n<e.$classes.length;n++){for(var r=$o.getClass(e.$classes[n]),s=[{attr:"id",name:"id",alias:n?e.$aliases[n]+"_id":"id"}],i=[],o=0;o<e.store.getCount();o++)e.store.getAt(o).get("clsFrom")==e.$aliases[n]&&"id"==e.store.getAt(o).get("attr")&&(i.push("id"),s[0].alias=e.store.getAt(o).get("alias"));for(var a in r.attrs){for(var l=r.attrs[a],c={attr:a,name:l.toString(),clsName:$o.getClass(l.get("class")).toString(),alias:n?e.$aliases[n]+"_"+a:a},o=0;o<e.store.getCount();o++)e.store.getAt(o).get("clsFrom")==e.$aliases[n]&&e.store.getAt(o).get("attr")==a&&(i.push(a),c.alias=e.store.getAt(o).get("alias"));s.push(c)}var d=Ext.create("Ext.data.Store",{data:s,fields:[{name:"name",type:"string"},{name:"clsName",type:"string"},{name:"attr",type:"string"},{name:"alias",type:"string"}],sorters:[{property:"name",direction:"ASC"}]}),u=new Ext.grid.plugin.CellEditing({clicksToEdit:1}),f=Ext.create("Ext.selection.CheckboxModel",{mode:"MULTI",valueSelected:i,checkOnly:!0}),g=Ext.create("Ext.grid.Panel",{tbar:n?[{text:$o.getString("Aliases by attribute code"),iconCls:"gi_sort-by-alphabet",handler:function(){for(var e=this.up("grid").getStore(),t=0;t<e.getCount();t++){var n=e.getAt(t),r=n.get("alias");2==r.split("_").length&&n.set("alias",r.split("_")[1])}}}]:[],store:d,columns:[{header:$o.getString("Attribute"),width:100,dataIndex:"name",renderer:e.cellRenderer},{header:$o.getString("Alias"),width:100,dataIndex:"alias",renderer:e.cellRenderer,editor:{xtype:"textfield"}},{header:$o.getString("Class"),width:100,dataIndex:"clsName",renderer:e.cellRenderer},{header:"attr",width:100,dataIndex:"attr",hidden:!0}],plugins:[u],selModel:f,forceFit:!0,frame:!1,deferRowRender:!1,listeners:{afterrender:function(){for(var e=0;e<this.getSelectionModel().valueSelected.length;e++)this.getSelectionModel().select(this.getStore().findRecord("attr",this.getSelectionModel().valueSelected[e],0,!1,!1,!0),!0)}}});t.push({title:e.$aliases[n]+":"+r.toString(),alias:e.$aliases[n],name:"tab",cls:r,layout:"fit",selModel:f,items:g})}var m=Ext.create("Ext.Window",{width:600,height:600,resizeable:!1,border:!1,title:$o.getString("Select attributes (use mouse and Shift, Ctrl)"),style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",modal:1,layout:"fit",items:{xtype:"tabpanel",deferredRender:!1,items:t},tbar:[{text:"",iconCls:"gi_ok",handler:function(){for(var t=[],n=m.down("tabpanel").query("panel[name=tab]"),r=0;r<n.length;r++){var s=n[r],i=[];s.selModel.hasSelection()&&(i=s.selModel.getSelection());for(var o=0;o<i.length;o++)t.push({name:n[r].alias+":"+(s.cls.attrs[i[o].get("attr")]?s.cls.attrs[i[o].get("attr")].toString():i[o].get("attr")),clsName:s.cls.toString(),clsFrom:e.$aliases[r],clsId:s.cls.get("id"),attr:i[o].get("attr"),alias:i[o].get("alias")})}e.store.loadData(t),m.close(),e.updateSelect()}},{text:$o.getString("Cancel"),iconCls:"gi_remove",handler:function(){m.close()}}]});m.show()},setClasses:function(e,t,n){var r=this;r.$classes=e,r.$classAliases=t,r.$aliases=n},build:function(){var e=this,t=[];if(e.value)for(var n=0;n<e.value.length;n+=2){var r,s;for(s in e.value[n])break;for(var i=e.value[n][s],o=0;o<e.$aliases.length;o++)e.$aliases[o]==s&&(r=$o.getClass(e.$classes[o]));t.push({name:s+":"+(r.attrs[i]?r.attrs[i].toString():i),clsName:r.toString(),clsFrom:s,clsId:r.get("id"),attr:i,alias:e.value[n+1]})}e.store.loadData(t)},setValue:function(e){var t=this;t.value=e,t.build(),t.fireEvent("change",e)},getValue:function(){var e=this;return e.value}}),Ext.define("$o.QueryCondition.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.querycondition","widget.$querycondition"],layout:"vbox",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.filter=e.filter||[],e.value={},e.tbar=[{text:"",iconCls:"gi_ok",name:"save",disabled:1,handler:e.save,scope:e},{text:$o.getString("Cancel"),iconCls:"gi_remove",name:"cancel",handler:function(){e.up("window").close()}}];for(var t=[],n=0;n<e.$classes.length;n++){var r=$o.getClass(e.$classes[n]);t.push([e.$aliases[n]+":id",e.$aliases[n]+":id"]);for(var s in r.attrs)t.push([e.$aliases[n]+":"+s,e.$aliases[n]+":"+r.attrs[s].toString()])}e.items=[{xtype:"combo",fieldLabel:$o.getString("And/or"),name:"and_or",width:250,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["and",$o.getString("and")],["or",$o.getString("or")]]}),valueField:"id",displayField:"text",validator:e.validator},{xtype:"combo",fieldLabel:$o.getString("Attribute")+" 1",name:"attr1",width:"100%",mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:t}),valueField:"id",displayField:"text",validator:e.validator},{xtype:"combo",fieldLabel:$o.getString("Operator"),name:"oper",width:250,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["=",$o.getString("equal")+" (=)"],["<>",$o.getString("not equal")+" (<>)"],["<",$o.getString("less")+" (<)"],[">",$o.getString("more")+" (>)"],["<=",$o.getString("less or equal")+" (<=)"],[">=",$o.getString("more  or equal")+" (>=)"],["is null",$o.getString("null")+" (is null)"],["is not null",$o.getString("not null")+" (is not null)"],["in",$o.getString("one of list")+" (in)"]]}),valueField:"id",displayField:"text",listeners:{select:function(){var t=this.getValue();"is null"==t||"is not null"==t?(e.down("*[name='value']").disable(),e.down("*[name='attr2']").disable()):(e.down("*[name='value']").enable(),"in"==t?e.down("*[name='attr2']").disable():e.down("*[name='attr2']").enable())}},validator:e.validator},{xtype:"textfield",fieldLabel:$o.getString("Value"),width:"100%",name:"value",validator:e.validator},{xtype:"combo",fieldLabel:$o.getString("Attribute")+" 2",name:"attr2",width:"100%",mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:t}),valueField:"id",displayField:"text",listeners:{select:function(){this.getValue()?e.down("*[name=save]").enable():e.down("*[name=save]").disable(),e.validator()}}}],e.filter.length||e.items.splice(0,1),e.items[0].style="margin-top: 5px;",e.addEvents("aftersave"),this.callParent(arguments)},validator:function(e){var t=this.up("panel"),n=t.down("*[name='and_or']"),r=t.down("*[name='attr1']"),s=t.down("*[name='oper']"),i=t.down("*[name='value']"),o=t.down("*[name='attr2']");if(n&&!n.getValue())return t.down("button[name='save']").disable(),!0;if(r.getValue()&&s.getValue()&&("is null"==s.getValue()||"is not null"==s.getValue()||i.getValue()||o.getValue())){t.down("button[name='save']").enable();var a=r.getValue(),l={};if(l[a.split(":")[0]]=a.split(":")[1],"is null"==s.getValue()||"is not null"==s.getValue())t.value=[l,s.getValue()];else{var c=i.getValue();if(o.getValue()){var d=o.getValue();c={},c[d.split(":")[0]]=d.split(":")[1]}t.value=[l,s.getValue(),c]}n&&(t.value=[n.getValue()].concat(t.value))}else t.down("button[name='save']").disable(),t.value=[];return!0},save:function(){var e=this;e.fireEvent("aftersave",e.value)},getValue:function(){var e=this;return e.value}}),Ext.define("$o.QueryDesigner.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.querydesigner","widget.$querydesigner"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.store=new Ext.data.ArrayStore({fields:["id","text"],data:[]}),e.items={xtype:"tabpanel",items:[{title:$o.getString("Constructor"),iconCls:"gi_adjust_alt",layout:"border",name:"constructor",border:!1,items:[{split:!0,region:"north",height:315,layout:"fit",border:0,items:{layout:"vbox",bodyPadding:5,items:[{xtype:"compositefield",items:[{xtype:"$conffield",fieldLabel:$o.getString("Class"),name:"class",width:400,confRef:"class",choose:{type:"custom",fn:function(){var e=this;dialog.getClass({success:function(t){e.setValue(t.id)}})}},listeners:{change:function(){e.updateAttrsStore(),e.validator(),e.updateFrom(),e.updateClasses()}}},{xtype:"displayfield",value:$o.getString("Alias")+":",style:"margin-left: 5px",width:70},{xtype:"textfield",name:"alias",width:100,listeners:{change:function(){e.updateAttrsStore(),e.validator(),e.updateFrom(),e.updateClasses()}}}]},{title:$o.getString("Additional classes"),iconCls:"gi_cogwheels",flex:1,width:"100%",layout:"hbox",name:"classes",autoScroll:!0,bodyPadding:5,tbar:[{text:$o.getString("Add"),iconCls:"gi_circle_plus",handler:e.addClass,scope:e}]}]}},{region:"center",layout:"border",border:0,items:[{split:!0,width:300,region:"west",layout:"fit",border:1,bodyPadding:1,items:{title:$o.getString("Attributes"),iconCls:"gi_file",xtype:"$queryselect",name:"attrs",listeners:{change:function(t){var n=e.decodeQuery();n&&(n.select=t,e.down("codemirrortextarea[name='json']").setValue(JSON.stringify(n,null,"\t")))}}}},{region:"center",layout:"fit",border:0,items:{layout:"border",border:0,items:[{split:!0,width:300,region:"west",layout:"fit",border:1,bodyPadding:1,items:{title:$o.getString("Filter"),iconCls:"gi_filter",xtype:"$layoutfilter",name:"filter",classMode:1,listeners:{change:e.updateFilter,scope:e}}},{region:"center",layout:"fit",border:1,bodyPadding:1,items:{title:$o.getString("Sort"),iconCls:"gi_sort-by-order",name:"sort",xtype:"$querysort",listeners:{change:function(t){var n=e.decodeQuery();n&&(n.order=t,e.down("codemirrortextarea[name='json']").setValue(JSON.stringify(n,null,"\t")))}}}}]}}]}]},{layout:"fit",title:$o.getString("Source code"),iconCls:"gi_notes",name:"source",items:{xtype:"codemirrortextarea",mode:"application/ld+json",name:"json",value:JSON.stringify(e.value,null,"\t")}}]},this.callParent(arguments)},decodeQuery:function(){var e=this,t=e.down("*[name=constructor]");t.getEl().unmask(!0);var n=e.down("codemirrortextarea[name='json']").getValue();try{return n=JSON.parse(n)}catch(n){t.getEl().mask($o.getString("Sorry, we could not decode the source code layout")),e.down("tabpanel").setActiveTab(e.down("panel[name=source]"))}},updateFrom:function(){var e=this,t=e.down("*[name=class]").getValue();if(t){var n=$o.getClass(t).getFullCode(),r=e.decodeQuery();if(r){r.from=[{a:n}];for(var s=e.down("*[name=classes]").query("panel"),i=0;i<s.length;i++){var o=s[i].n,a=e.down("*[name=class_"+o+"]").getValue(),l=e.down("*[name=attr1_"+o+"]").getValue(),c=e.down("*[name=attr2_"+o+"]").getValue(),d=e.down("*[name=join_"+o+"]").getValue();if(a&&l&&c&&d){var u={};u[o]=$o.getClass(a).getFullCode(),r.from=r.from.concat(d,u,"on");var f={};f[l.split(":")[0]]=l.split(":")[1];var g={};g[c.split(":")[0]]=c.split(":")[1],r.from.push([f,"=",g])}}e.down("codemirrortextarea[name='json']").setValue(JSON.stringify(r,null,"\t"))}}},addClass:function(e){"object"==typeof e&&(e=null);var t=this,n=t.down("*[name=classes]");if(!e)for(var r=n.query("panel"),s="abcdefghijklmnopqrstuvwxyz",i=0;i<s.length;i++){for(var o=0,a=0;a<r.length;a++)if(r[a].n==s[i]){o=1;break}if(!o&&s[i]!=t.down("*[name=alias]").getValue()){e=s[i];break}}n.add({layout:"vbox",bodyPadding:5,width:300,n:e,style:"margin-right: 5px",items:[{xtype:"$conffield",fieldLabel:"",width:"100%",labelWidth:100,name:"class_"+e,confRef:"class",choose:{type:"layout",attr:"olap.id",width:500,height:400,layout:{treegrid:{id:"olap",view:"system.classes",fields:{id:"id",parent:"parent_id"},filter:{fn:function(){return["id",">=",1e3,"and","end_id","=",2147483647]}}}}},listeners:{change:function(){t.updateAttrsStore();var e=this.up("*").down("*[fieldLabel='"+$o.getString("Attribute")+" 1']"),n=this.up("*").down("*[fieldLabel='"+$o.getString("Attribute")+" 2']");if(!e.getValue()&&!n.getValue()){var r=t.down("*[name=class]").getValue(),s=this.getValue();if(r&&s){var i=$o.getClass(r).attrs,o=t.down("*[name=alias]").getValue(),a=this.up("*").down("*[fieldLabel='"+$o.getString("Alias")+"']").getValue();for(var l in i){var c=i[l];if(c.get("type")==s){e.setValue(o+":"+l),n.setValue(a+":id");break}}}}t.validator(),t.updateFrom(),t.updateClasses()}}},{xtype:"textfield",fieldLabel:$o.getString("Alias"),name:"alias_"+e,value:e,listeners:{change:function(){t.updateAttrsStore(),t.validator(),t.updateFrom(),t.updateClasses()}}},{xtype:"combo",fieldLabel:$o.getString("Attribute")+" 1",name:"attr1_"+e,width:"100%",labelWidth:100,mode:"local",queryMode:"local",editable:!1,store:t.store,valueField:"id",displayField:"text",listeners:{select:function(){t.validator(),t.updateFrom()}}},{xtype:"combo",fieldLabel:$o.getString("Attribute")+" 2",name:"attr2_"+e,width:"100%",labelWidth:100,mode:"local",queryMode:"local",editable:!1,store:t.store,valueField:"id",displayField:"text",listeners:{select:function(){t.validator(),t.updateFrom()}}},{xtype:"combo",fieldLabel:$o.getString("Union"),name:"join_"+e,width:"100%",labelWidth:100,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["left-join",$o.getString("External")],["inner-join",$o.getString("Internal")]]}),value:"left-join",valueField:"id",displayField:"text",listeners:{select:function(){t.validator(),t.updateFrom()}}},{xtype:"button",text:$o.getString("Remove"),iconCls:"gi_circle_minus",style:"margin-top: 5px",handler:function(){var e=this.up("panel");n.remove(e),n.doLayout(),t.updateAttrsStore(),t.validator(),t.updateFrom(),t.updateClasses()}}]}),n.doLayout()},updateFilter:function(e){var t=this,n=t.decodeQuery();n&&(n.where=e,t.down("codemirrortextarea[name='json']").setValue(JSON.stringify(n,null,"\t")))},updateClasses:function(){function e(t,n){r[t]=n;var s=$o.getClass(t);s.get("parent")&&e(s.get("parent"),n)}var t=this,n=[],r={},s=[],i=t.down("*[name=class]").getValue();i&&(n.push(i),e(i,t.down("*[name=alias]").getValue()),s.push(t.down("*[name=alias]").getValue()));for(var o=t.down("*[name=classes]").query("panel"),a=0;a<o.length;a++){var i=t.down("*[name=class_"+o[a].n+"]").getValue(),l=t.down("*[name=alias_"+o[a].n+"]").getValue();i&&(n.push(i),e(i,l),s.push(l))}t.down("*[name=attrs]").setClasses(n,r,s),t.down("*[name=filter]").setClasses(n,r,s),t.down("*[name=sort]").setClasses(n,r,s)},validator:function(){},clear:function(){var e=this;e.down("*[name=class]").setValue(null),e.down("*[name=classes]").removeAll(),e.down("*[name=attrs]").setValue(null),e.down("*[name=filter]").setValue(null),e.down("*[name=sort]").setValue(null)},buildForm:function(e){var t=this;if(e=e||{},t.down("*[name=alias]").setValue("a"),e.from&&e.from.length){var n;for(n in e.from[0])break;t.down("*[name=alias]").setValue(n),n=e.from[0][n];var r=$o.getClass(n);t.down("*[name=class]").setValue(r.get("id"));for(var s=1;s<e.from.length;s+=4){var i;for(i in e.from[s+1])break;var o=i;t.addClass(o);var a=$o.getClass(e.from[s+1][i]);t.down("*[name=class_"+o+"]").setValue(a.get("id"));var l=e.from[s+3][0];for(i in l){t.down("*[name=attr1_"+o+"]").setValue(i+":"+l[i]);break}var c=e.from[s+3][2];for(i in c){t.down("*[name=attr2_"+o+"]").setValue(i+":"+c[i]);break}"left-join"==e.from[s]?t.down("*[name=join_"+o+"]").setValue("left-join"):t.down("*[name=join_"+o+"]").setValue("inner-join")}}e.select&&t.down("*[name=attrs]").setValue(e.select),e.where&&t.down("*[name=filter]").setValue(e.where),e.order&&t.down("*[name=sort]").setValue(e.order)},getValue:function(){var e=this;return e.down("codemirrortextarea[name='json']").getValue()},updateAliases:function(e){function t(e){if(e)if(Ext.isArray(e))for(var s=0;s<e.length;s++)t(e[s]);else if("object"==typeof e){for(n in e)break;n!=r[n]&&(e[r[n]]=e[n],delete e[n])}}if(e){var n,r={};if(e.from){for(n in e.from[0])break;r[n]="a";for(var s=1,i=1;i<e.from.length;i+=4){for(n in e.from[i+1])break;r[n]="c"+s,s++}t(e.select),t(e.from),t(e.where),t(e.order)}}},setValue:function(e){var t=this,n=t.down("*[name=constructor]");n.getEl().unmask(!0),e||(e={designer:1});var r="object"==typeof e?JSON.stringify(e,null,"\t"):e;if(t.down("codemirrortextarea[name='json']").setValue(r),"string"==typeof e)try{if(e=JSON.parse(e),!e.designer)throw"invalid"}catch(e){return n.getEl().mask($o.getString("Sorry, we could not decode the source code layout")),void t.down("tabpanel").setActiveTab(t.down("panel[name=source]"))}t.clear(),t.buildForm(e),t.down("codemirrortextarea[name='json']").setValue(r)},setReadOnly:function(e){},updateAttrsStore:function(){for(var e=this,t=[],n=e.query("*[confRef=class]"),r=[e.down("*[name=alias]")].concat(e.query("*[fieldLabel="+$o.getString("Alias")+"]")),s=0;s<n.length;s++)if(n[s].getValue()&&r[s].getValue()){for(var i,o=0;o<r.length;o++)if(1==n[s].name.split("_")&&1==r[o].name.split("_")||n[s].name.split("_")[1]==r[o].name.split("_")[1]){i=r[o].getValue();break}t.push([i+":id",i+":id"]);var a=n[s].getValue(),l=$o.getClass(a);for(var c in l.attrs){var d=l.attrs[c];(2==d.get("type")||12==d.get("type")||d.get("type")>=1e3)&&t.push([i+":"+c,i+":"+d.toString()])}}e.store.loadData(t)}}),Ext.define("$o.QueryColumns.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.querycolumns","widget.$querycolumns"],layout:"fit",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.$view=$o.getView(e.viewId),e.updateAttrs()&&(e.items={xtype:"$o.layout",border:1,$layout:{split:{orientation:"vertical",height:100,items:[{layout:"fit",xtype:"$o.layout",$layout:{olap:{id:"olap",view:e.$view.getFullCode(),hideBottomToolbar:1,groupedColumns:!0,listeners:{columnresize:e.onColumnResize,columnmove:e.onColumnMove,columnhide:e.onColumnHide,columnshow:e.onColumnShow,scope:e}}},listeners:{afterrender:function(){e.olapContainer=this}}},{split:{title:$o.getString("Columns"),iconCls:"gi_file",orientation:"vertical",height:185,pages:[{olap:{id:"olapAttrs",view:"system.viewAttrs",filter:["view_id","=",e.viewId],listeners:{afterrender:function(){e.olapAttrs=this}}}},{cardConf:{id:"attrCard",items:[{conf:"viewAttr",id:"olapAttrs",attr:"id.name",fieldLabel:$o.getString("Name")},{conf:"viewAttr",id:"olapAttrs",attr:"id.code",fieldLabel:$o.getString("Code"),allowBlank:!1,maskRe:/[A-Za-z0-9\_]/},{xtype:"compositefield",fieldLabel:$o.getString("Visible"),items:[{conf:"viewAttr",id:"olapAttrs",attr:"id.area",xtype:"checkbox",width:100}]},{xtype:"compositefield",fieldLabel:$o.getString("N"),items:[{conf:"viewAttr",id:"olapAttrs",attr:"id.order",xtype:"numberfield",width:100}]},{xtype:"compositefield",fieldLabel:$o.getString("Width"),items:[{conf:"viewAttr",id:"olapAttrs",attr:"id.width",xtype:"numberfield",width:100}]}],active:{fn:function(){return!e.schemaId}},listeners:{afterSave:function(){e.olapContainer.removeAll(),e.olapContainer.add({layout:"fit",xtype:"$o.layout",$layout:{olap:{id:"olap",view:e.$view.getFullCode(),hideBottomToolbar:1,groupedColumns:!0,listeners:{columnresize:e.onColumnResize,columnmove:e.onColumnMove,columnhide:e.onColumnHide,columnshow:e.onColumnShow}}}}),e.olapContainer.updateLayout()}}}}]}}]}}},e.dockedItems={dock:"top",height:60,layout:"vbox",border:0,bodyPadding:5,defaults:{width:"100%"},items:[{xtype:"label",text:"- "+$o.getString("To hide / show a column use context menu of any column")},{xtype:"label",text:"- "+$o.getString("Drag the column to modify its location")},{xtype:"label",text:"- "+$o.getString("Width of columns set in the header of table at the column boundaries")}]}),this.callParent(arguments)},getClassAndClassAttr:function(e,t){var n,r={};for(n in t.from[0])break;r[n]=$o.getClass(t.from[0][n]);for(var s=1;s<t.from.length;s+=4){for(n in t.from[s+1])break;r[n]=$o.getClass(t.from[s+1][n])}for(var s=1;s<t.select.length;s+=2)if(t.select[s]==e){for(n in t.select[s-1])break;var i=t.select[s-1][n];return[r[n],r[n].attrs[i]]}},updateAttrs:function(){var e,t=this,n=[];try{e=JSON.parse(t.$view.get("query"));var r=1;for(var s in t.$view.attrs)t.$view.attrs[s].order&&t.$view.attrs[s].order>=r&&(r=t.$view.attrs[s].order+1);for(var i=1;i<e.select.length;i+=2){var s=e.select[i];if(n.push(s),!t.$view.attrs[s]){var o=t.getClassAndClassAttr(s,e),a=o[1]?o[1].get("name"):s;("a_id"==s||"c"==s[0]&&"_id"==s.substr(s.length-3,3))&&(a="id");var l=$o.createViewAttr({name:a,code:s,view:t.viewId,area:1,width:75,class:o[0].get("id"),order:r++,classAttr:o[1]?o[1].get("id"):null});l.sync()}}for(var s in t.$view.attrs)if(n.indexOf(s)==-1){var l=t.$view.attrs[s];l.remove(),l.sync()}return 1}catch(e){t.items={layout:{type:"vbox",align:"center",pack:"center"},items:[{xtype:"label",text:$o.getString("Sorry, we could not decode the source code query")}]}}},onColumnResize:function(e,t,n){if(t.$field){var r=t.$field.id,s=$o.getViewAttr(r);s.set("width",n),s.sync(),this.olapAttrs&&this.olapAttrs.refresh()}},onColumnMove:function(e,t,n,r){for(var s=e.getGridColumns(),i=0;i<s.length;i++)if(s[i].$field){var o=$o.getViewAttr(s[i].$field.id);o.get("order")!=i+1&&(o.set("order",i+1),o.sync())}this.olapAttrs&&this.olapAttrs.refresh()},onColumnHide:function(e,t){if(t.$field){var n=t.$field.id,r=$o.getViewAttr(n);r.set("area",0),r.sync(),this.olapAttrs&&this.olapAttrs.refresh()}},onColumnShow:function(e,t){if(t.$field){var n=t.$field.id,r=$o.getViewAttr(n);r.set("area",1),r.sync(),this.olapAttrs&&this.olapAttrs.refresh()}}}),Ext.define("$o.ReportDesigner.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.reportdesigner","widget.$reportdesigner"],layout:"vbox",border:0,initComponent:function(){var e=this;e.startRowsNum=10,e.startColsNum=50;for(var t=[],n=0;n<e.startRowsNum;n++){for(var r=[],s=0;s<e.startColsNum;s++)r.push({text:"",style:"s1"});t.push({height:20,cells:r})}for(var i=[],n=0;n<e.startColsNum;n++)i.push(50);e.value=e.value||{name:void 0,code:void 0,query:[],styles:{s1:{hAlign:"Left",vAlign:"Top",wrap:!0,fontSize:10}},sheets:[{name:"1",columns:i,rows:t}]},e.divId="div-"+ ++Ext.Component.AUTO_ID,e.items=[{xtype:"tabpanel",width:"100%",deferredRender:!1,flex:1,items:[{title:"",iconCls:"gi_edit",autoScroll:!0,tbar:[{text:"",iconCls:"gi_resize_small",handler:function(){e.selectedRange&&(e.ht.mergeCells.mergeOrUnmergeSelection(e.selectedRange),e.ht.render())}},{iconCls:"gi_bold",tooltip:"",handler:function(){e.updateProp("bold","bool")}},{iconCls:"gi_italic",tooltip:"",handler:function(){e.updateProp("italic","bool")}},{iconCls:"gi_unchecked",tooltip:"",handler:function(){e.updateProp("borders","bool")}},"-",{iconCls:"gi_align_left",tooltip:": ",handler:function(){e.updateProp("hAlign","Left")}},{iconCls:"gi_align_center",tooltip:":  ",handler:function(){
e.updateProp("hAlign","Center")}},{iconCls:"gi_align_right",tooltip:": ",handler:function(){e.updateProp("hAlign","Right")}},"-",{iconCls:"gi_up_arrow",tooltip:": ",handler:function(){e.updateProp("vAlign","Top")}},{iconCls:"gi_minus",tooltip:":  ",handler:function(){e.updateProp("vAlign","Middle")}},{iconCls:"gi_down_arrow",tooltip:": ",handler:function(){e.updateProp("vAlign","Bottom")}}],html:"<div id='"+e.divId+"' style='width: 100%; height: 100%;'></div>"},{title:"",iconCls:"gi_settings",layout:"vbox",bodyPadding:3,border:!1,items:[{xtype:"textfield",name:"name",fieldLabel:"",width:"100%",value:e.value.name},{xtype:"textfield",name:"code",fieldLabel:"",width:"100%",value:e.value.code},{xtype:"combo",fieldLabel:"",name:"orientation",width:250,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["portrait",""],["landscape",""]]}),value:e.value.sheets[0].orientation?e.value.sheets[0].orientation:"portrait",valueField:"id",displayField:"text"},{xtype:"$o.reportquery",width:"100%",flex:1,value:e.value.query,listeners:{change:function(t){e.value.query=t}}}]}]}],e.on("afterrender",function(){window.Handsontable?e.make():$o.util.loadJS("/third-party/js/jquery-2.1.1.min.js",function(){$o.util.loadCSS("/third-party/handsontable/jquery.handsontable.full.css",function(){$o.util.loadJS("/third-party/handsontable/jquery.handsontable.full.min.js",function(){$(document).ready(function(){e.make()})})})})},e),e.addEvents("change"),e.callParent(arguments)},updateProp:function(e,t){var n=this,r=n.selectedArea;if(r){for(var s=r.row;s<r.row+r.rowspan;s++)for(var i=r.col;i<r.col+r.colspan;i++)if("bool"==t){var o=!0;n.styleObjects[n.cellStyle[s+"_"+i]]&&(o=!n.styleObjects[n.cellStyle[s+"_"+i]][e]);var a=n.createStyle(n.cellStyle[s+"_"+i],e,o);n.cellStyle[s+"_"+i]=a}else{var a=n.createStyle(n.cellStyle[s+"_"+i],e,t);n.cellStyle[s+"_"+i]=a}n.ht.selectCell(r.row,r.col,r.row+r.rowspan-1,r.col+r.colspan-1),n.ht.render()}},addCol:function(){var e=this;e.ht.alter("insert_col",e.selectedArea.col,1)},removeCol:function(){var e=this;e.ht.alter("remove_col",e.selectedArea.col,1)},addRow:function(){var e=this;e.ht.alter("insert_row",e.selectedArea.row,1)},removeRow:function(){var e=this;e.ht.alter("remove_row",e.selectedArea.row,1)},createStyle:function(e,t,n){var r=this,s=e?$o.util.clone(r.styleObjects[e]):{};s[t]=n;var i,o=0;for(var e in r.styleObjects){var a=r.styleObjects[e];if(JSON.stringify(a).length==JSON.stringify(s).length){var l=1;for(var c in s)if(s[c]!=a[c]){l=0;break}if(l){i=e;break}}o<Number(e.substr(1))&&(o=Number(e.substr(1)))}return i?i:(r.styleObjects["s"+(o+1)]=s,"s"+(o+1))},getData:function(){var e,t=this,n=t.value.sheets[0].rows,r=[];for(t.cellStyle={},e=0;e<n.length;e++){var s,i={},o=n[e].cells;for(s=0;s<o.length;s++)i["c"+s]=o[s].text,t.cellStyle[e+"_"+s]=o[s].style;for(;s<t.startColsNum;s++)i["c"+s]="";r.push(i)}return r},getColWidths:function(){for(var e=this,t=e.value.sheets[0].columns,n=t.length;n<e.startColsNum;n++)t.push(50);return t},getColumns:function(){for(var e=this,t=e.value.sheets[0].rows,n=e.startColsNum,r=0;r<t.length;r++)t[r].cells.length>n&&(n=t[r].cells.length);for(var s=[],r=0;r<n;r++)s.push({data:"c"+r,renderer:e.cellRenderer});return s},setStyles:function(){var e=this;e.styleObjects=e.value.styles},getRowHeights:function(){for(var e=this,t=[],n=e.value.sheets[0].rows,r=0;r<n.length;r++)t.push(n[r].height);return t},getMergeCells:function(){var e=this,t=e.value.sheets[0].mergeCells;return t||!0},make:function(){var e=this;Handsontable.cmp=Handsontable.cmp||{},Handsontable.cmp[e.divId]=e,e.setStyles();var t={data:e.getData(),colWidths:e.getColWidths(),columns:e.getColumns(),rowHeights:e.getRowHeights(),mergeCells:e.getMergeCells(),manualColumnResize:!0,manualRowResize:!0,rowHeaders:!0,colHeaders:!0,minSpareRows:1,minSpareCols:1,contextMenu:!0,beforeRender:function(){this.cmp=e,e.ht=this},afterSelectionEnd:function(t,n,r,s){e.selectedArea={row:t,col:n,rowspan:r-t+1,colspan:s-n+1},e.selectedRange=this.getSelectedRange()}};$("#"+e.divId).handsontable(t)},cellRenderer:function(e,t,n,r){var s=e.cmp;Handsontable.renderers.TextRenderer.apply(this,arguments),t.style.fontFamily="sans-serif";var i=s.styleObjects[s.cellStyle[n+"_"+r]]||{};return i.fontSize?t.style.fontSize=i.fontSize+"pt":t.style.fontSize="10pt",i.hAlign?t.style.textAlign=i.hAlign.toLowerCase():t.style.textAlign="left",i.vAlign?t.style.verticalAlign=i.vAlign.toLowerCase():t.style.verticalAlign="top",i.bold&&(t.style.fontWeight="bold"),i.italic&&(t.style.fontStyle="italic"),i.borders&&(t.style.border="1px solid black"),t},getValue:function(){for(var e=this,t=e.ht.getData(),n=[],r=0;r<t.length;r++){for(var s=[],i=0;i<e.ht.countCols();i++)s.push({text:t[r]["c"+i],style:e.cellStyle[r+"_"+i]});n.push({height:e.ht.getRowHeight(r),cells:s})}for(var o=[],r=0;r<e.ht.countCols();r++)o.push(e.ht.getColWidth(r));var a={name:e.down("textfield[name=name]").getValue(),code:e.down("textfield[name=code]").getValue(),query:e.value.query,styles:e.styleObjects,sheets:[{name:"Sheet1",orientation:e.down("*[name=orientation]").getValue(),columns:o,rows:n,mergeCells:e.ht.mergeCells.mergedCellInfoCollection,countEmptyRows:e.ht.countEmptyRows(!0),countEmptyCols:e.ht.countEmptyCols(!0)}]};return a},build:function(e){var t=this;if(t.processTags(e),e.preview)t.generateXMLSS().preview();else if(e.html){var n=t.generateHTML();t.previewHTML(n)}else{var r=t.generateXMLSS();e.pdf?r.createPDF():r.create()}},generateXMLSS:function(){for(var e=this,t=[],n=e.value.sheets[0].rows,r=e.value.sheets[0].mergeCells,s=0;s<n.length;s++){for(var i=[],o=n[s].cells,a=0;a<o.length;a++){for(var l=1,c=1,d=0,u=0;u<r.length;u++){if(r[u].row==s&&r[u].col==a){l=r[u].colspan,c=r[u].rowspan;break}if(s>=r[u].row&&s<r[u].row+r[u].rowspan&&a>=r[u].col&&a<r[u].col+r[u].colspan){d=1;break}}d||i.push({text:o[a].text,style:o[a].style,colspan:l,rowspan:c,startIndex:a+1})}t.push({height:.75*n[s].height,cells:i})}var f={default:"hAlign:Left,vAlign:Center,wrap:true,fontSize:10"},g=e.value.styles;for(var m in g){var p=g[m],h=["wrap:true"];p.fontSize&&h.push("fontSize:"+p.fontSize),p.hAlign&&h.push("hAlign:"+p.hAlign),p.vAlign&&h.push("vAlign:"+("Middle"==p.vAlign?"Center":p.vAlign)),p.bold&&h.push("bold:true"),p.italic&&h.push("italic:true"),p.borders&&h.push("borders:All"),f[m]=h.join(",")}for(var i=[],v=e.value.sheets[0].columns,s=0;s<v.length;s++)i.push(v[s]/7);var b=new $report.xmlss;return b.styles=f,b.sheets=[new $report.sheet({name:"1",orientation:e.value.sheets[0].orientation,margins:{left:15,top:15,right:15,bottom:15},columns:i,rows:t})],b},generateHTML:function(e){for(var t=this,n="",r=t.value.sheets[0].rows,s=t.value.sheets[0].columns,i=t.value.sheets[0].mergeCells,o={},a=0;a<r.length;a++){for(var l=r[a],c=l.cells,d="<tr style='height:"+l.height+"px'>",u=0;u<c.length;u++){for(var f=1,g=1,m=0,p=0;p<i.length;p++){if(i[p].row==a&&i[p].col==u){f=i[p].colspan,g=i[p].rowspan;break}if(a>=i[p].row&&a<i[p].row+i[p].rowspan&&u>=i[p].col&&u<i[p].col+i[p].colspan){m=1;break}}if(!m){var h="",v=c[u],b=v.text;void 0!==b&&null!==b&&""!==b||(b="<img width=1 height=1>");var y=t.value.styles[v.style];y=y||{},y.bold>-1&&(h="font-weight:bold;"),y.italic>-1&&(h="font-style:italic;"),y.hAlign&&(h+="text-align:"+y.hAlign.toLowerCase()+";"),y.vAlign&&(h+="vertical-align:"+y.vAlign.toLowerCase()+";"),y.borders&&(o[a]=o[a]||{},o[a][u]=1,o[a-1]&&o[a-1][u]||(h+="border-top:1px solid black;"),o[a][u-1]||(h+="border-left:1px solid black;"),h+="border-right:1px solid black;",h+="border-bottom:1px solid black;"),h+="width:"+s[u]+"px;padding:2px;",d+="<td class='tb-text' colspan="+f+" rowspan="+g+" style='"+h+"'>"+b+"</td>"}}d+="</tr>\n",n+=d}return n},previewHTML:function(e){var t=this;r="<style type='text/css'>\n* {\n   font-family: Tahoma;\n   font-size: 8pt;\n}\n</style>\n","landscape"==t.value.sheets[0].orientation&&(r+='<style type="text/css" media="print">\n\t@page { size: landscape; }\n</style>\n'),r+="<table cellpadding=0 cellspacing=0>"+e+"</table>",w=window.open("","window1","width=800, height=600, resizable=yes, scrollbars=yes, status=yes, top=10, left=10"),w.document.open(),w.document.write(r),w.document.close(),w.print()},processObject:function(e,t,n,r,s){var i=this,o=[],a=t.cells,l=n[e],c=0;for(var d in l){for(var u=[],f=0;f<a.length;f++){for(var g=a[f].text,m=0;m<r.length;m++){var p=r[m],h=void 0==n[p]?"":n[p],v=p.split(".");if(v[0]==e&&v.length>1)for(var b=1,h=l[d];b<v.length;b++)h=h?h[v[b]]:void 0;void 0==h&&(h=""),g=g.split("[#"+r[m]+"]").join(h)}u.push({text:g,style:a[f].style})}o.push({height:t.height,cells:u}),c++,c>1&&i.moveMergeCells(s)}return o},processQuery:function(e,t,n,r,s,i){var o=this,a=[],l=n.cells,c=$o.getView(t.view),d=JSON.parse(c.get("query"));if(t.filter&&t.filter.length){for(var u=t.filter,f=0;f<u.length;f++){var g=u[f];"["==g[0]&&"#"==g[1]&&(u[f]=r[g.substr(2,g.length-3)]);for(var m=1;m<d.select.length;m+=2)d.select[m]==g&&(u[f]=d.select[m-1])}d.where=d.where||[],d.where.length&&(d.where=[d.where,"and"]),d.where.push(u)}for(var p=$o.execute(d),h=0,f=0;f<p.length;f++){for(var v=[],m=0;m<l.length;m++){for(var b=l[m].text,y=0;y<s.length;y++){var w=s[y],c=void 0==r[w]?"":r[w],x=w.split(".");x[0]==e&&x.length>1&&(c=p.get(f,x[1])),b=b.split("[#"+s[y]+"]").join(c)}v.push({text:b,style:l[m].style})}a.push({height:n.height,cells:v}),h++,h>1&&o.moveMergeCells(i)}return a},moveMergeCells:function(e){for(var t=this,n=t.value.sheets[0].mergeCells,r=0;r<n.length;r++)n[r].row>=e&&n[r].row++},processTags:function(e){for(var t=this,n=[],r=t.value.sheets[0].rows,s={},i=0;i<t.value.query.length;i++)s[t.value.query[i].alias]=t.value.query[i];for(var i=0;i<r.length;i++){for(var o=r[i].cells,a=[],l="",c="",d=0;d<o.length;d++)for(var u=o[d].text||"",f=1;f<u.length;f++)if("#"==u[f]&&"["==u[f-1]){var g="";for(f++;f<u.length&&"]"!=u[f];f++)g+=u[f];a.indexOf(g)==-1&&(a.push(g),Ext.isArray(e[g.split(".")[0]])&&(l=g.split(".")[0]),s[g.split(".")[0]]&&(c=g.split(".")[0]))}if(c)n=n.concat(t.processQuery(c,s[c],r[i],e,a,n.length));else if(l)n=n.concat(t.processObject(l,r[i],e,a,n.length));else{for(var m=[],d=0;d<o.length;d++){for(var u=o[d].text||"",f=0;f<a.length;f++){for(var g=a[f],p=g.split("."),h=0,v=e;h<p.length;h++)v=v?v[p[h]]||"":"";u=u.split("[#"+g+"]").join(v)}m.push({text:u,style:o[d].style})}n.push({height:r[i].height,cells:m})}}t.value.sheets[0].rows=n}}),Ext.define("$o.ReportQuery.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.reportquery","widget.$reportquery"],layout:"fit",border:!1,initComponent:function(){var e=this;e.store=Ext.create("Ext.data.Store",{data:e.getData(),fields:[{name:"alias",type:"string"},{name:"view",type:"string"}]}),e.grid=Ext.create("Ext.grid.Panel",{store:e.store,columns:[{header:"",width:100,dataIndex:"alias"},{header:"",dataIndex:"view",flex:1}],forceFit:!0,frame:!1,deferRowRender:!1,listeners:{afterrender:function(){var t=this.getSelectionModel();t.on("selectionchange",function(){if(t.hasSelection()){var n=t.getSelection()[0];e.down("*[name=filter]").enable(),e.down("*[name=filter]").setViewId(e.data[n.get("alias")].view),e.down("*[name=filter]").setValue(e.data[n.get("alias")].filter)}})}}}),e.items={layout:"border",border:!1,items:[{split:!0,region:"west",width:"50%",layout:"fit",tbar:[{text:"",name:"create",iconCls:"gi_circle_plus",handler:e.create,scope:e},{text:"",name:"delete",iconCls:"gi_circle_minus",handler:e.remove,scope:e}],title:"",iconCls:"gi_cogwheel",border:!1,items:e.grid},{region:"center",layout:"fit",title:"",iconCls:"gi_filter",border:!1,items:{xtype:"$layoutfilter",name:"filter",disabled:!0,reportMode:1,listeners:{change:e.updateFilter,scope:e}}}]},e.addEvents("change"),e.callParent(arguments)},getData:function(){var e=this,t=[];e.data={};for(var n=0;n<e.value.length;n++)t.push({alias:e.value[n].alias,view:$o.getView(e.value[n].view).toString()}),e.data[e.value[n].alias]={alias:e.value[n].alias,filter:e.value[n].filter,view:e.value[n].view};return t},create:function(){var e=this;dialog.getView({hasQuery:1,success:function(t){for(var n=0,r=0;r<e.store.getCount();r++){var s=e.store.getAt(r).get("alias");Number(s.substr(1))>n&&(n=Number(s.substr(1)))}var s="q"+(n+1),i={alias:s,view:$o.getView(t.id).toString()};e.store.add(i),e.data[s]={alias:s,view:$o.getView(t.id).getFullCode()},e.fireEvent("change",e.getValue())}})},remove:function(){var e=this,t=e.grid.getSelectionModel();if(t.hasSelection()){var n=t.getSelection()[0];e.store.remove(n),e.down("*[name=filter]").disable(),e.fireEvent("change",e.getValue())}},getValue:function(){for(var e=this,t=[],n=0;n<e.store.getCount();n++){var r=e.store.getAt(n).get("alias");t.push(e.data[r])}return t},updateFilter:function(e){var t=this,n=t.grid.getSelectionModel(),r=n.getSelection()[0];t.data[r.get("alias")].filter=e,t.fireEvent("change",t.getValue())}}),Ext.define("$o.ReportCondition.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.reportcondition","widget.$reportcondition"],layout:"vbox",border:!1,defaults:{border:!1},initComponent:function(){var e=this;e.filter=e.filter||[],e.value={},e.tbar=[{text:"",iconCls:"gi_ok",name:"save",disabled:1,handler:e.save,scope:e},{text:"",iconCls:"gi_remove",name:"cancel",handler:function(){e.up("window").close()}}];var t=[];for(var n in e.$view.attrs){var r=e.$view.attrs[n];t.push([n,r.toString()])}e.items=[{xtype:"combo",fieldLabel:"/",labelWidth:200,name:"and_or",width:350,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["and",""],["or",""]]}),valueField:"id",displayField:"text"},{xtype:"combo",fieldLabel:"",name:"attr",width:"100%",labelWidth:200,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:t}),valueField:"id",displayField:"text",validator:e.validator},{xtype:"combo",fieldLabel:"",labelWidth:200,name:"oper",width:350,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["="," (=)"],["<>","  (<>)"],["<"," (<)"],[">"," (>)"],["<=","   (<=)"],[">=","   (>=)"],["is null"," (is null)"],["is not null","  (is not null)"],["in","   (in)"]]}),valueField:"id",displayField:"text",listeners:{select:function(){var t=this.getValue();"is null"==t||"is not null"==t?e.down("*[name='value']").disable():e.down("*[name='value']").enable()}},validator:e.validator},{xtype:"textfield",fieldLabel:"",labelWidth:200,width:"100%",name:"value",validator:e.validator}],e.filter.length||e.items.splice(0,1),e.items[0].style="margin-top: 5px;",e.addEvents("aftersave"),this.callParent(arguments)},validator:function(e){var t=this.up("panel"),n=t.down("*[name='and_or']"),r=t.down("*[name='attr']"),s=t.down("*[name='oper']"),i=t.down("*[name='value']");if(n&&!n.getValue())return t.down("button[name='save']").disable(),!0;if(r.getValue()&&s.getValue()&&("is null"==s.getValue()||"is not null"==s.getValue()||i.getValue())){if(t.down("button[name='save']").enable(),"is null"==s.getValue()||"is not null"==s.getValue())t.value=[r.getValue(),s.getValue()];else{var o=i.getValue();t.value=[r.getValue(),s.getValue(),o]}n&&(t.value=[n.getValue()].concat(t.value))}else t.down("button[name='save']").disable(),t.value=[];return!0},save:function(){var e=this;e.fireEvent("aftersave",e.value)},getValue:function(){var e=this;return e.value}}),Ext.define("$o.ProjectDesigner.Widget",{extend:"Ext.tab.Panel",alias:["widget.$o.projectdesigner","widget.$projectdesigner"],layout:"fit",border:!1,defaults:{border:!1},bodyPadding:5,deferredRender:!1,initComponent:function(){var e=this,t=Ext.create("Ext.data.Store",{fields:["action","line","msg","src"],data:[]}),n=Ext.create("Ext.grid.Panel",{name:"errors",store:t,columns:[{text:$o.getString("Message"),dataIndex:"msg",flex:3,renderer:e.cellRenderer},{text:$o.getString("Action"),dataIndex:"action",width:250,renderer:e.cellRenderer},{text:$o.getString("String"),dataIndex:"line",width:80},{text:$o.getString("Source code"),dataIndex:"src",flex:2,renderer:e.cellRenderer}],width:"100%",forceFit:!0,flex:1,selModel:Ext.create("Ext.selection.RowModel",{mode:"SINGLE",listeners:{selectionchange:function(){e.down("*[name=showAction]").enable()}}}),tbar:[{text:$o.getString("Action",":","Source code"),iconCls:"gi_notes",name:"showAction",disabled:1,handler:function(){var t=e.down("*[name=errors]");if(t.getSelectionModel().hasSelection()){var n=t.getSelectionModel().getSelection()[0],r=n.get("action"),s=$o.getAction(r),i=s.get("body"),o=Ext.create("Ext.Window",{width:800,height:600,layout:"fit",frame:!1,border:!1,bodyPadding:1,modal:!1,maximizable:!0,title:$o.getString("Action",":","Source code")+": "+s.toString(),iconCls:"gi_notes",items:{name:"body",xtype:"codemirrortextarea",listeners:{afterrender:function(){this.setValue(i)}}},tbar:[{text:$o.getString("Save"),iconCls:"gi_floppy_save",handler:function(){s.set("body",o.down("*[name=body]").getValue()),s.sync(),s.initAction(),o.close()}},{text:$o.getString("Cancel"),iconCls:"gi_remove",handler:function(){o.close()}}]});o.show()}}}]});e.listeners={afterrender:function(){$o.execute({fn:"vo.getProjectInfo",success:function(t){if(e.down("*[name=revision]").setValue(t.revision),e.down("*[name=name]").setValue(t.name),t.smtp=t.smtp||{},e.down("*[name=smtpHost]").setValue(t.smtp.host),e.down("*[name=smtpUsername]").setValue(t.smtp.username),e.down("*[name=smtpPassword]").setValue(t.smtp.password),e.down("*[name=smtpSender]").setValue(t.smtp.sender),e.down("*[name=timeMachineCardButton]").setValue($o.visualObjectum.timeMachine.cardButton),e.down("*[name=timeMachineShowDates]").setValue($o.visualObjectum.timeMachine.showDates),e.down("*[name=timeMachineBuildTime]").setValue($o.visualObjectum.timeMachine.buildTime),e.down("*[name=logoLeft]").setValue($o.visualObjectum.logo.left),e.down("*[name=logoRight]").setValue($o.visualObjectum.logo.right),e.down("*[name=logoHeight]").setValue($o.visualObjectum.logo.height),$o.visualObjectum.initAction&&e.down("*[name=initAction]").setValue($o.getAction($o.visualObjectum.initAction).get("id")),t.scripts&&t.scripts.client){for(var n=[],r=0;r<t.scripts.client.length;r++)n.push({name:t.scripts.client[r]});e.down("*[name=clientScripts]").getStore().loadData(n)}}})}},e.items=[{title:$o.getString("Commons"),iconCls:"gi_file",layout:"vbox",items:[{xtype:"textfield",fieldLabel:$o.getString("Project revision"),name:"revision",labelWidth:200,width:355,style:"margin-top: 5px",disabled:!0},{xtype:"textfield",fieldLabel:$o.getString("Project name"),labelWidth:200,name:"name",width:"100%"},{xtype:"compositefield",fieldLabel:$o.getString("Admin password"),labelWidth:200,items:[{xtype:"textfield",name:"password",inputType:"password",width:150},{xtype:"displayfield",value:$o.getString("enter password again")+":",style:"margin-left: 5px; margin-right: 2px"},{xtype:"textfield",name:"password2",inputType:"password",width:150}]},{xtype:"fieldset",title:"SMTP",width:"100%",items:{layout:"hbox",border:0,bodyPadding:5,items:[{xtype:"textfield",name:"smtpHost",fieldLabel:$o.getString("Host")},{xtype:"textfield",name:"smtpUsername",style:"margin-left: 10px",fieldLabel:$o.getString("User")},{xtype:"textfield",name:"smtpPassword",style:"margin-left: 10px",fieldLabel:$o.getString("Password"),inputType:"password"},{xtype:"textfield",name:"smtpSender",style:"margin-left: 10px",fieldLabel:$o.getString("Sender")}]}},{xtype:"fieldset",title:"Time machine",width:"100%",items:{layout:"hbox",border:0,bodyPadding:5,items:[{xtype:"checkbox",name:"timeMachineCardButton",fieldLabel:$o.getString("Show button 'Changes' in card"),labelWidth:250}]}},{layout:"hbox",border:0,style:"padding-top: 5px; padding-bottom: 5px",width:"100%",items:[{xtype:"button",text:$o.getString("Build project"),iconCls:"gi_settings",handler:function(){e.down("*[name=time]").setValue($o.getString("building")+" ..."),e.down("*[name=errNum]").setValue($o.getString("building")+" ..."),e.down("*[name=showAction]").disable(),$o.app.name=$ptitle=e.down("*[name=name]").getValue();var t={name:e.down("*[name=name]").getValue(),build:e.down("radiogroup").getValue().rgBuild};if(e.down("*[name=password]").getValue()){if(e.down("*[name=password]").getValue()!=e.down("*[name=password2]").getValue())return void common.message($o.getString("Passwords not equal"));t.password=$o.util.sha1(e.down("*[name=password]").getValue())}t.smtp={host:e.down("*[name=smtpHost]").getValue(),username:e.down("*[name=smtpUsername]").getValue(),password:e.down("*[name=smtpPassword]").getValue(),sender:e.down("*[name=smtpSender]").getValue()};var n=e.down("*[name=timeMachineBuildTime]").getValue();t.timeMachine={cardButton:e.down("*[name=timeMachineCardButton]").getValue()?1:0,showDates:e.down("*[name=timeMachineShowDates]").getValue()?1:0},t.logo={left:e.down("*[name=logoLeft]").getValue(),right:e.down("*[name=logoRight]").getValue(),height:e.down("*[name=logoHeight]").getValue()},e.down("*[name=initAction]").getValue()&&(t.initAction=$o.getAction(e.down("*[name=initAction]").getValue()).getFullCode()),n&&(t.timeMachine.buildTime=(n.getHours()<10?"0"+n.getHours():n.getHours())+":"+(n.getMinutes()<10?"0"+n.getMinutes():n.getMinutes())),$o.visualObjectum.timeMachine.cardButton=t.timeMachine.cardButton,$o.visualObjectum.timeMachine.showDates=t.timeMachine.showDates,$o.visualObjectum.timeMachine.buildTime=t.timeMachine.buildTime;for(var r=[],s=e.down("*[name=clientScripts]").getStore(),i=0;i<s.getCount();i++)r.push(s.getAt(i).get("name"));t.scripts={client:r},$o.execute({fn:"vo.build",args:t,success:function(t){e.showBuildResults(t),t.err&&t.err.length||(common.setConf("projectNeedBuild",{used:0}),$o.app.projectNeedBuildTooltip&&$o.app.projectNeedBuildTooltip.destroy(),e.down("*[name=revision]").setValue(t.revision),$o.execute({fn:"vo.getActions",success:function(t){e.down("*[name=actions]").setValue(t.actions)}}))}})}},{xtype:"radiogroup",columns:2,style:"margin-left: 25px",items:[{boxLabel:$o.getString("Test"),name:"rgBuild",inputValue:"test",width:90,checked:!0},{boxLabel:$o.getString("Production"),name:"rgBuild",inputValue:"prod"}]}]},{layout:"hbox",border:0,style:"padding-top: 5px; padding-bottom: 5px",width:"100%",items:[{xtype:"textfield",labelWidth:200,disabled:1,name:"errNum",width:300,fieldLabel:$o.getString("Errors num")},{xtype:"textfield",disabled:1,name:"time",style:"margin-left: 10px",width:200,fieldLabel:$o.getString("building duration")}]},n]},{title:$o.getString("Additional"),iconCls:"gi_file",layout:"vbox",items:[{xtype:"grid",title:$o.getString("Client scripts"),name:"clientScripts",store:Ext.create("Ext.data.Store",{fields:["name"],data:[]}),columns:[{text:$o.getString("Script location on server"),dataIndex:"name"}],width:"100%",forceFit:!0,height:150,tbar:[{text:$o.getString("Add"),iconCls:"gi_circle_plus",handler:function(){var e=this.up("grid");dialog.getString({fieldLabel:$o.getString("Enter script location on server"),success:function(t){e.getStore().add({name:t})}})}},{text:$o.getString("Remove"),iconCls:"gi_circle_minus",handler:function(){var e=this.up("grid"),t=e.getSelectionModel();if(t.hasSelection()){var n=t.getSelection()[0];e.getStore().remove(n)}}}]},{fieldLabel:$o.getString("Action of client initialization"),labelWidth:200,width:600,xtype:"$conffield",name:"initAction",anchor:"100%",confRef:"action",style:"margin-top: 5px",choose:{type:"custom",fn:function(){var e=this;dialog.getAction({success:function(t){e.setValue(t.id)}})}}},{xtype:"fieldset",title:$o.getString("Logo"),width:"100%",items:{layout:"vbox",border:0,bodyPadding:5,items:[{xtype:"textfield",name:"logoLeft",fieldLabel:$o.getString("Left image"),width:"100%"},{xtype:"textfield",name:"logoRight",fieldLabel:$o.getString("Right image"),width:"100%"},{xtype:"numberfield",name:"logoHeight",fieldLabel:$o.getString("Strip height")}]}}]},{title:$o.getString("Server actions"),iconCls:"gi_notes",layout:"fit",tbar:[{text:$o.getString("Refresh"),iconCls:"gi_refresh",handler:function(){$o.execute({fn:"vo.getActions",success:function(t){e.down("*[name=actions]").setValue(t.actions)}})}}],items:{xtype:"codemirrortextarea",name:"actions",listeners:{afterrender:function(){var e=this;$o.execute({fn:"vo.getActions",success:function(t){e.setValue(t.actions)}})}}}}],this.callParent(arguments)},showBuildResults:function(e){var t=this;t.down("*[name=time]").setValue((e.time/1e3).toFixed(3)+" ."),e.err=e.err||[],t.down("*[name=errNum]").setValue(e.err.length),t.down("*[name=errors]").getStore().loadData(e.err)},cellRenderer:function(e,t,n,r,s,i){return t.style="white-space: normal;",e}}),Ext.define("$o.CardDesigner.Widget",{extend:"Ext.panel.Panel",alias:["widget.$o.carddesigner","widget.$carddesigner"],layout:"fit",border:0,defaults:{border:0},initComponent:function(){var e=this;e.counter=1,e.data={},e.treeStore=Ext.create("Ext.data.TreeStore",{autoSync:!0,root:{expanded:!0,children:[]}}),e.storeAttrs=new Ext.data.ArrayStore({fields:["id","text"],data:[]}),e.storeViewAttrs=new Ext.data.ArrayStore({fields:["id","text"],data:[]}),e.items={layout:"border",border:!1,style:"margin: 2px",defaults:{border:!1},items:[{split:!0,region:"west",width:"50%",layout:"fit",items:{title:$o.getString("Navigator"),iconCls:"gi_search",xtype:"treepanel",name:"tree",store:e.treeStore,selModel:Ext.create("Ext.selection.TreeModel",{mode:"SINGLE",listeners:{selectionchange:{fn:e.selectionChange,scope:e}}}),rootVisible:!1,viewConfig:{plugins:{ptype:"treeviewdragdrop",containerScroll:!0},listeners:{beforedrop:function(e,t,n,r,s){return":"==t.records[0].get("text").substr(0,5)||":"!=n.parentNode.get("text").substr(0,10)}}},listeners:{cellcontextmenu:function(t,n,r,s,i,o,a,l){e.down("treepanel").getSelectionModel().deselectAll()}}}},{region:"center",layout:"fit",items:{title:$o.getString("Options"),iconCls:"gi_file",layout:"vbox",name:"card",hidden:!0,bodyPadding:5,items:[{xtype:"combo",fieldLabel:$o.getString("Attribute"),name:"attr",width:"100%",mode:"local",queryMode:"local",editable:!1,store:e.storeAttrs,valueField:"id",displayField:"text",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"textfield",fieldLabel:$o.getString("Name"),width:"100%",name:"name",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"numberfield",fieldLabel:$o.getString("Name width"),width:200,name:"labelWidth",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"fieldcontainer",layout:"hbox",width:"100%",items:[{xtype:"numberfield",fieldLabel:$o.getString("Width"),width:200,name:"width",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"numberfield",fieldLabel:$o.getString("Height"),width:150,labelWidth:50,style:"margin-left: 5px",name:"height",cardDesigner:e,listeners:{change:e.onChange}}]},{xtype:"numberfield",fieldLabel:$o.getString("Min value"),width:200,name:"minValue",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"numberfield",fieldLabel:$o.getString("Max value"),width:200,name:"maxValue",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"checkbox",fieldLabel:$o.getString("Read only"),name:"readOnly",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"checkbox",fieldLabel:$o.getString("Show time"),name:"showTime",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"checkbox",fieldLabel:$o.getString("Editor")+" HTML",name:"htmlEditor",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"fieldset",title:$o.getString("Object selection"),name:"choose",width:"100%",collapsible:1,items:[{xtype:"$conffield",fieldLabel:$o.getString("View"),labelWidth:135,name:"view",anchor:"100%",confRef:"view",choose:{type:"custom",fn:function(){var e=this;dialog.getView({success:function(t){e.setValue(t.id)}})}},cardDesigner:e,listeners:{change:e.onChange}},{xtype:"combo",fieldLabel:$o.getString("View attribute"),labelWidth:135,name:"viewAttr",anchor:"100%",mode:"local",queryMode:"local",editable:!1,store:e.storeViewAttrs,valueField:"id",displayField:"text",cardDesigner:e,listeners:{change:e.onChange}},{fieldLabel:$o.getString("Action before selection"),labelWidth:135,xtype:"$conffield",name:"filterAction",anchor:"100%",confRef:"action",choose:{type:"custom",fn:function(){var e=this;dialog.getAction({success:function(t){e.setValue(t.id)}})}},cardDesigner:e,listeners:{change:e.onChange}},{xtype:"fieldcontainer",layout:"hbox",width:"100%",items:[{xtype:"numberfield",fieldLabel:$o.getString("Width"),width:190,labelWidth:90,name:"viewWidth",cardDesigner:e,listeners:{change:e.onChange}},{xtype:"numberfield",fieldLabel:$o.getString("Height"),width:150,labelWidth:50,style:"margin-left: 5px",name:"viewHeight",cardDesigner:e,listeners:{change:e.onChange}}]},{xtype:"checkbox",fieldLabel:$o.getString("Hide actions"),name:"hideActions",cardDesigner:e,listeners:{change:e.onChange}}]}]}}]},e.tbar=[{text:$o.getString("Add field"),name:"addField",iconCls:"gi_circle_plus",handler:e.addField,scope:e},{text:$o.getString("Add composite field"),name:"addComposite",iconCls:"gi_circle_plus",handler:e.addComposite,scope:e},{text:$o.getString("Add group"),name:"addGroup",iconCls:"gi_circle_plus",handler:e.addGroup,scope:e},{text:$o.getString("Remove"),disabled:!0,name:"remove",iconCls:"gi_circle_minus",handler:e.remove,scope:e}],e.bbar=[{text:$o.getString("Preview"),iconCls:"gi_search",handler:e.preview,scope:e}],e.on("afterrender",function(){e.setClassId(e.classId),e.setValue(e.value)}),this.callParent(arguments)},addField:function(){var e,t=this,n=t.down("treepanel"),r=n.getSelectionModel();r.hasSelection()?(e=r.getSelection()[0],e.get("text").substr(0,5)==$o.getString("Field")+":"&&(e=e.parentNode),e.set("leaf",!1)):e=n.getStore().getRootNode(),e.expand();var s={id:t.counter++,text:$o.getString("Field")+":",leaf:!0};e.appendChild(s)},addComposite:function(){var e,t=this,n=t.down("treepanel"),r=n.getSelectionModel();r.hasSelection()?(e=r.getSelection()[0],e.set("leaf",!1)):e=n.getStore().getRootNode(),e.expand();var s={id:t.counter++,text:$o.getString("Composite")+":",leaf:!0};e.appendChild(s)},addGroup:function(){var e,t=this,n=t.down("treepanel"),r=n.getSelectionModel();r.hasSelection()?(e=r.getSelection()[0],e.set("leaf",!1)):e=n.getStore().getRootNode(),e.expand();var s={id:t.counter++,text:$o.getString("Group")+":",leaf:!0};e.appendChild(s)},selectionChange:function(){var e=this,t=e.down("treepanel"),n=t.getSelectionModel();if(e.down("*[name=addField]").enable(),e.down("*[name=addComposite]").enable(),e.down("*[name=addGroup]").enable(),n.hasSelection()){e.down("*[name=remove]").enable(),e.down("*[name=card]").show();var r=n.getSelection()[0],s="field";r.get("text").substr(0,10)==$o.getString("Composite")+":"&&(s="composite"),r.get("text").substr(0,7)==$o.getString("Group")+":"&&(s="group"),"xtype:"==r.get("text").substr(0,6)&&(s="xtype"),"field"==s&&(e.down("*[name=addComposite]").disable(),e.down("*[name=addGroup]").disable()),"composite"==s&&(e.down("*[name=addComposite]").disable(),e.down("*[name=addGroup]").disable()),"field"==s&&e.down("*[name=attr]").show(),"composite"==s&&(e.down("*[name=attr]").hide(),e.down("*[name=name]").show(),e.down("*[name=labelWidth]").show(),e.down("*[name=width]").show(),e.down("*[name=height]").hide(),e.down("*[name=showTime]").hide(),e.down("*[name=minValue]").hide(),e.down("*[name=maxValue]").hide(),e.down("*[name=htmlEditor]").hide(),e.down("*[name=readOnly]").hide(),e.down("*[name=choose]").hide()),"group"==s&&(e.down("*[name=attr]").hide(),e.down("*[name=name]").show(),e.down("*[name=labelWidth]").hide(),e.down("*[name=width]").show(),e.down("*[name=height]").show(),e.down("*[name=showTime]").hide(),e.down("*[name=minValue]").hide(),e.down("*[name=maxValue]").hide(),e.down("*[name=htmlEditor]").hide(),e.down("*[name=readOnly]").hide(),e.down("*[name=choose]").hide()),e.updateCard(r.get("id"),s)}else e.down("*[name=remove]").disable(),e.down("*[name=card]").hide();
},updateCard:function(e,t){var n=this;n.selectedId=e,n.data[e]=n.data[e]||{};var r=n.data[e];return!r.attr||n.tag&&r.tag==n.tag?(n.down("*[name=card]").enable(),"xtype"==t?void n.down("*[name=card]").disable():(n.down("*[name=name]").setValue(r.name),n.down("*[name=width]").setValue(r.width),n.down("*[name=labelWidth]").setValue(r.labelWidth),n.down("*[name=height]").setValue(r.height),void("field"==t&&(n.down("*[name=attr]").setValue(r.attr),n.down("*[name=showTime]").setValue(r.showTime),n.down("*[name=minValue]").setValue(r.minValue),n.down("*[name=maxValue]").setValue(r.maxValue),n.down("*[name=htmlEditor]").setValue(r.htmlEditor),n.down("*[name=readOnly]").setValue(r.readOnly),r.attr?(n.down("*[name=name]").show(),n.down("*[name=labelWidth]").show(),n.down("*[name=width]").show(),n.down("*[name=readOnly]").show(),n.attrs[r.attr].get("type")>=1e3?(n.down("*[name=choose]").show(),n.down("*[name=view]").setValue(r.view?$o.getView(r.view).get("id"):null),n.down("*[name=viewAttr]").setValue(r.viewAttr),n.down("*[name=filterAction]").setValue(r.filterAction?$o.getAction(r.filterAction).get("id"):null),n.down("*[name=viewWidth]").setValue(r.viewWidth),n.down("*[name=viewHeight]").setValue(r.viewHeight),n.down("*[name=hideActions]").setValue(r.hideActions)):n.down("*[name=choose]").hide(),3==n.attrs[r.attr].get("type")?(n.down("*[name=showTime]").show(),n.down("*[name=width]").hide()):(n.down("*[name=showTime]").hide(),n.down("*[name=width]").show()),2==n.attrs[r.attr].get("type")?(n.down("*[name=minValue]").show(),n.down("*[name=maxValue]").show()):(n.down("*[name=minValue]").hide(),n.down("*[name=maxValue]").hide()),1==n.attrs[r.attr].get("type")?(n.down("*[name=height]").show(),n.down("*[name=htmlEditor]").show()):(n.down("*[name=height]").hide(),n.down("*[name=htmlEditor]").hide())):(n.down("*[name=name]").hide(),n.down("*[name=labelWidth]").hide(),n.down("*[name=width]").hide(),n.down("*[name=height]").hide(),n.down("*[name=showTime]").hide(),n.down("*[name=minValue]").hide(),n.down("*[name=maxValue]").hide(),n.down("*[name=htmlEditor]").hide(),n.down("*[name=readOnly]").hide(),n.down("*[name=choose]").hide()))))):void n.down("*[name=card]").disable()},onChange:function(){var e=this.cardDesigner,t=this;e.data[e.selectedId]=e.data[e.selectedId]||{};var n=e.data[e.selectedId];if(n.tag=e.tag,n.classId=e.classId,"name"==t.name){n.name=t.getValue();var r=e.down("treepanel").getSelectionModel().getSelection()[0],s=r.get("text").split(":");r.set("text",s[0]+": "+n.name)}if("labelWidth"==t.name&&(n.labelWidth=t.getValue()),"width"==t.name&&(n.width=t.getValue()),"height"==t.name&&(n.height=t.getValue()),"showTime"==t.name&&(n.showTime=t.getValue()),"minValue"==t.name&&(n.minValue=t.getValue()),"maxValue"==t.name&&(n.maxValue=t.getValue()),"htmlEditor"==t.name&&(n.htmlEditor=t.getValue()),"readOnly"==t.name&&(n.readOnly=t.getValue()),"viewWidth"==t.name&&(n.viewWidth=t.getValue()),"viewHeight"==t.name&&(n.viewHeight=t.getValue()),"hideActions"==t.name&&(n.hideActions=t.getValue()),"attr"==t.name){n.attr=t.getValue(),e.updateCard(e.selectedId,"field");for(var i=$o.getClass(e.classId),o=[],a=0;a<i.attrsArray.length;a++){var l=i.attrsArray[a],c=0;for(var d in e.data)e.data[d].attr==l.get("code")&&e.data[d].tag==e.tag&&(c=1);c||o.push([l.get("code"),l.toString()])}e.storeAttrs.loadData(o),e.down("*[name=name]").getValue()||e.down("*[name=name]").setValue(n.attr?e.attrs[n.attr].get("name"):null)}if("view"==t.name){var u=n.view;n.view=t.getValue()?$o.getView(t.getValue()).getFullCode():null,u!=n.view&&e.down("*[name=viewAttr]").setValue(null);var o=[];if(t.getValue()){var f=$o.getView(t.getValue());if(f.get("layout"))o=e.layoutCard.getViewCmpAttrs(f.get("layout"));else for(var g in f.attrs)o.push([g,f.attrs[g].toString()])}e.storeViewAttrs.loadData(o)}"viewAttr"==t.name&&(n.viewAttr=t.getValue()),"filterAction"==t.name&&(n.filterAction=t.getValue()?$o.getAction(t.getValue()).getFullCode():null)},setClassId:function(e,t){var n=this;n.classId=e,n.tag=t;var r=[];if(e){var s=$o.getClass(e);n.attrs=s.attrs;for(var i=0;i<s.attrsArray.length;i++){var o=s.attrsArray[i];r.push([o.get("code"),o.toString()])}}n.storeAttrs.loadData(r)},getValue:function(e){e=e||{};var t=this,n=[],r=function(n,s){for(var i=0;i<n.childNodes.length;i++){var o=n.childNodes[i],a=t.data[o.get("id")]||{},l={};switch(a.width?l.width=a.width:l.anchor="100%",o.get("text").split(":")[0]){case $o.getString("Field"):if(a.attr){var c=t.getClsByTag(a.tag),d=c.attrs,u=d[a.attr].get("type");if(l.fieldLabel=a.name,l.attr=a.attr,e.preview)l.objectId=$o.createObject(a.classId,"local").get("id");else if(t.layoutCard.value.card.object.cmpAttr){var f=a.tag.split(".");l.id=f[0],l.attr=f[1]+"."+a.attr}else l.objectId=a.tag;1==u&&(a.height&&(l.xtype="textarea",l.height=a.height),a.htmlEditor&&(l.xtype="htmleditor",l.height=l.height||100)),a.labelWidth&&(l.labelWidth=a.labelWidth),l.readOnly=a.readOnly||void 0,3==u&&(l.timefield=!!a.showTime,l.width=l.labelWidth?l.labelWidth+100:200,a.showTime&&(l.width+=100),delete l.anchor),2==u&&(l.minValue=a.minValue,l.maxValue=a.maxValue,a.width?l.width=a.width:l.width=l.labelWidth?l.labelWidth+100:200,delete l.anchor),u>=1e3&&(l.choose={type:"view",id:a.view,attr:a.viewAttr,width:a.viewWidth||void 0,height:a.viewHeight||void 0,hideActions:!!a.hideActions},a.filterAction&&(l.listeners=l.listeners||{},l.listeners.beforechoose=a.filterAction))}else l.empty=1;break;case $o.getString("Composite"):l.fieldLabel=a.name,l.xtype="fieldcontainer",l.layout="hbox",a.labelWidth&&(l.labelWidth=a.labelWidth);break;case $o.getString("Group"):l.title=a.name,l.height=a.height?a.height:void 0,l.xtype="fieldset",l.collapsible=1;break;case"xtype":l=a.item}if(o.childNodes.length&&(l.items=[],r(o,l.items),o.get("text").split(":")[0]==$o.getString("Composite")))for(var g=0;g<l.items.length;g++){var m=l.items[g];if(m.style="margin-right: 10px",m.attr&&!m.fieldLabel){var u=t.attrs[m.attr].get("type");2!=u&&3!=u||(m.width=100),3==u&&m.timefield&&(m.width=200)}}l.empty||s.push(l)}};return r(t.treeStore.getRootNode(),n),n},getClsByTag:function(e){for(var t=this,n=t.layoutCard.value.card.object,r=0;r<n.length;r++)if(n[r].tag==e){var s=$o.getClass(n[r].cls);return s}},setValue:function(e){function t(e,s){for(var i=0;i<e.length;i++){var o,a=e[i],l=n.counter++;if("fieldcontainer"==a.xtype)o={id:l,text:$o.getString("Composite")+": "+(a.fieldLabel||""),leaf:!(a.items&&a.items.length)},n.data[l]={name:a.fieldLabel,width:a.width,labelWidth:a.labelWidth};else if("fieldset"==a.xtype)o={id:l,text:$o.getString("Group")+": "+(a.title||""),leaf:!(a.items&&a.items.length)},n.data[l]={name:a.title,width:a.width,height:a.height};else if(a.objectId){var c=n.getClsByTag(a.objectId),d=c.attrs,u=d[a.attr]||d[a.attr.split(".")[1]];o={id:l,text:$o.getString("Field")+": "+(a.fieldLabel||u.get("name")),leaf:!0},n.data[l]={name:a.fieldLabel,width:a.width,height:a.height,showTime:!!a.timefield,minValue:a.minValue,maxValue:a.maxValue,htmlEditor:"htmleditor"==a.xtype,labelWidth:a.labelWidth,readOnly:a.readOnly,attr:u.get("code"),tag:a.objectId,classId:c.get("id")},a.choose&&(n.data[l].viewWidth=a.choose.width,n.data[l].viewHeight=a.choose.height,n.data[l].view=a.choose.id,n.data[l].viewAttr=a.choose.attr,n.data[l].filterAction=a.listeners?a.listeners.beforechoose:void 0,n.data[l].hideActions=a.choose.hideActions);for(var f=0;f<n.storeAttrs.getCount();f++)if(n.storeAttrs.getAt(f).get("id")==u.get("code")){n.storeAttrs.removeAt(f);break}}else o={id:l,text:"xtype: "+(a.xtype||""),leaf:!(a.items&&a.items.length)},n.data[l]={name:"xtype: "+(a.xtype||""),item:a};a.items&&a.items.length&&(o.children=[],t(a.items,o.children)),s==r?s.appendChild(o):s.push(o)}}var n=this;e=e||[];for(var r=n.down("treepanel").getRootNode(),s=r.childNodes.length-1;s>=0;s--)r.childNodes[s].remove();t(e,r)},remove:function(){var e=this,t=e.down("treepanel"),n=t.getSelectionModel(),r=n.getSelection()[0],s=r.parentNode;delete e.data[r.get("id")],e.down("*[name=attr]").setValue(null),r.remove(),s==t.getStore().getRootNode()||s.childNodes.length||s.set("leaf",!0)},preview:function(e){var t=this,n=Ext.create("Ext.Window",{width:800,height:600,layout:"fit",bodyPadding:5,border:!1,resizable:!0,closable:!0,modal:!0,items:{xtype:"$layout",$layout:{card:{hideToolbar:1,items:t.getValue({preview:1})}}}});n.show()}}),Ext.define("$o.app",{singleton:!0,mixins:{observable:"Ext.util.Observable"},extReady:!1,constructor:function(e){this.mixins.observable.constructor.call(this,e),this.addEvents("extReady","ready","viewLayout")},message:function(e,t){Ext.Msg.alert($o.app.name||$o.app.code,e,t)},login:function(e){var t=this,n=e,r=e.success;if($o.authorized)return void r.call(n.scope||this,n);if($o.util.getCookie("esiaUser")&&(e.login=$o.util.getCookie("esiaUser"),$o.util.setCookie("esiaUser","","/"),e.hash=$o.util.getCookie("esiaHash"),$o.util.setCookie("esiaHash","","/"),$o.util.setCookie("esiaAuth","1","/")),e.login&&e.hash)return Ext.getBody().mask(" ..."),void $o.authorize({login:e.login,password:e.hash,success:function(e){$o.init(Ext.apply(n,{success:function(){Ext.getBody().unmask(!0),r.call(n.scope||this,n)}}))}});var s=function(){var e=Ext.getCmp("$o.app.login.field").getValue(),t=Ext.getCmp("$o.app.password.field").getValue();if(e&&t){o.getEl().mask("");var r=$o.util.sha1(t);"password in cookie"==t&&(r=$o.util.getCookie("password"),t=$o.util.getCookie("passwordPlain")),$o.authorize({login:e,password:r,passwordPlain:t,success:function(s){Ext.getCmp("$o.app.remember").getValue()?($zu.setCookie("login",e),$zu.setCookie("password",r),$zu.setCookie("passwordPlain",t)):($zu.removeCookie("login"),$zu.removeCookie("password"),$zu.removeCookie("passwordPlain"));var i=n.success;$o.init(Ext.apply(n,{success:function(){o.getEl().unmask(!0),o.close(),i.call(n.scope||this,n)}}))},failure:function(e){o.getEl().unmask(!0),$o.app.message($o.locale.getString(e)||$o.getString("Authentication error"),function(){Ext.getCmp("$o.app.password.field").setValue(""),Ext.getCmp("$o.app.login.field").focus()})}})}},i={xtype:"button",text:$o.getString("Enter"),iconCls:"gi_ok",width:100,style:{marginTop:10},handler:s};e.esia&&(i={border:!1,layout:"hbox",items:[{xtype:"button",text:"  ",iconCls:"gi_keys",width:150,style:{marginTop:10,marginRight:5},handler:function(){var t=window.location.protocol+"//"+window.location.hostname;window.location.port&&(t+=":"+window.location.port),t+="/projects/"+e.code+"/plugins/?fn=service.esia";var n=Ext.create("Ext.form.Panel",{standardSubmit:!0,url:e.esia});n.submit({params:{ReturnUrl:t}})}},i]});var o=Ext.create("Ext.Window",{title:t.name||$o.getString("Authorization"),iconCls:"gi_keys",width:300,height:200,layout:"vbox",bodyPadding:5,closable:!1,monitorValid:!0,defaults:{listeners:{specialkey:function(e,t){t.getKey()==t.ENTER&&s()}}},items:[{xtype:"textfield",emptyText:$o.getString("Login"),id:"$o.app.login.field",allowBlank:!1,msgTarget:"side",width:270,style:{marginTop:10}},{xtype:"textfield",emptyText:$o.getString("Password"),id:"$o.app.password.field",inputType:"password",allowBlank:!1,msgTarget:"side",width:270,style:{marginTop:10}},{xtype:"checkbox",boxLabel:$o.getString("Remember"),id:"$o.app.remember",width:270,style:{marginTop:10}},i]});o.show(null,function(){Ext.getCmp("$o.app.login.field").focus(),$o.util.getCookie("login")&&(Ext.getCmp("$o.app.remember").setValue(1),Ext.getCmp("$o.app.login.field").setValue($o.util.getCookie("login")),Ext.getCmp("$o.app.password.field").setValue("password in cookie"))})},initTreeStore:function(e){for(var t=Ext.ModelManager.getModel(e.model),n=t.getFields(),r=e.map,s=function(e){for(var t=0;t<n.length;t++){var i=n[t];e.r[i.name]=e.c.get(i.name)}if(e.c.childs.length){e.r.children=[];for(var t=0;t<e.c.childs.length;t++){var o={};s({c:r[e.c.childs[t]],r:o}),e.r.children.push(o)}}else e.r.leaf=!0},i=[],o=0;o<$o.store[e.data].getCount();o++){var a=$o.store[e.data].getAt(o);if(!a.get("parent")){var l={};s({c:a,r:l}),i.push(l)}}this.treeStore[e.data]=Ext.create("Ext.data.TreeStore",{model:e.model,autoLoad:!0,root:{text:".",children:i},proxy:{type:"memory",reader:{type:"json"}}})},tabChangeListener:function(e){var t=e.getActiveTab();if(t){t.id&&(document.location.href="#"+t.id);var n=t.title;if(t.id)if("o"==t.id[0]){var r=$zs.getObject(t.id.substr(1));n=r.get("name")}else if("v"==t.id[0]){var s=$zs.viewsMap[t.id.substr(1)];try{n=s.stub.get("name")}catch(e){n=s.get("name")}}document.title=n+" - "+$ptitle}},createDesktop:function(e){var t=this,n=e.cleanViewport;$o.app.tp=Ext.create("Ext.tab.Panel",{region:"center",layout:"fit",listeners:{tabchange:{fn:t.tabChangeListener,scope:t}}}),$o.app.lb=Ext.create("Ext.Toolbar",{region:"west",dock:"left",autoScroll:!0,items:[]}),$o.app.rb=Ext.create("Ext.Toolbar",{region:"east",dock:"right",items:[]}),$o.app.tb=Ext.create("Ext.Toolbar",{region:"north",items:[]}),$o.app.bb=Ext.create("Ext.Toolbar",{region:"south",items:[]});var r=[];if("admin"==$o.currentUser){var s=[{xtype:"label",text:"Visual Objectum",style:"font-weight: bold; color: #073255; margin-left: 5px; margin-right: 15px; text-shadow: -1px -1px 1px white, 1px -1px 1px white, -1px 1px 1px white, 1px 1px 1px white;"},{text:$o.getString("Classes"),iconCls:"gi_cogwheels",handler:function(){$o.app.show({items:{id:"conf_classes",xtype:"$o.classes",title:$o.getString("Classes"),iconCls:"gi_cogwheels",name:"classes"}})}},{text:$o.getString("Views"),iconCls:"gi_eye_open",handler:function(){$o.app.show({items:{id:"conf_views",xtype:"$o.views",title:$o.getString("Views"),iconCls:"gi_eye_open",name:"views"}})}}];$o.visualObjectum&&$o.visualObjectum.menuConstructor&&s.push({text:$o.getString("Menu"),iconCls:"gi_list",handler:function(){$o.app.show.call($o.app,{record:$o.getView("system.vo.menu")})}}),$o.visualObjectum&&$o.visualObjectum.accessConstructor&&s.push({text:$o.getString("Access"),iconCls:"gi_keys",handler:function(){$o.app.show.call($o.app,{record:$o.getView("system.vo.access")})}}),$o.visualObjectum&&$o.visualObjectum.projectConstructor&&s.push({text:$o.getString("Project"),iconCls:"gi_briefcase",name:"project",handler:function(){$o.app.show({items:{id:"conf_project",xtype:"$projectdesigner",title:$o.getString("Project"),name:"project",iconCls:"gi_briefcase"}})}}),s.push("->"),s.push({text:$o.getString("Exit"),iconCls:"gi_exit",handler:function(){$o.logout({success:function(){location.reload()}})}}),$o.app.cb=Ext.create("Ext.Toolbar",{region:"north",border:!1,style:"background-color: #b8d7f1; padding: 5px; margin-bottom: 3px;",items:s}),r.push($o.app.cb)}if($o.visualObjectum&&$o.visualObjectum.menuConstructor)if($o.visualObjectum.logo.left&&$o.visualObjectum.logo.height){var i=window,o=document,a=o.documentElement,l=o.getElementsByTagName("body")[0],c=i.innerWidth||a.clientWidth||l.clientWidth;i.innerHeight||a.clientHeight||l.clientHeight;r=[new Ext.Panel({region:"north",border:!1,width:c,height:$o.visualObjectum.logo.height,xtype:"panel",bodyStyle:"background-color: #ffffff; padding: 0px !important; border-bottom: 1px solid #428bca !important;",html:"<div style='width: 100%; height: "+$o.visualObjectum.logo.height+";'><img src='"+$o.visualObjectum.logo.left+"'>"+($o.visualObjectum.logo.right?"<img src='"+$o.visualObjectum.logo.right+"' align=right>":"")+"</div>"})].concat(r)}else r.push(Ext.create("Ext.Toolbar",{region:"north",border:!1,style:"background-color: #fff; padding: 5px; margin-bottom: 3px;",items:[{xtype:"label",text:$ptitle,style:"font-weight: bold; font-size: 15pt; font-style: italic; color: #b8d7f1; margin-left: 5px; margin-right: 15px; text-shadow: -1px -1px 1px #073255, 1px -1px 1px #073255, -1px 1px 1px #073255, 1px 1px 1px #073255;"}]}));r=r.concat($o.app.lb,$o.app.rb,$o.app.tb,$o.app.bb),n?($o.app.tb.hide(),$o.app.lb.hide(),$o.app.rb.hide()):r.push($o.app.tp),$o.app.vp&&$o.app.vp.destroy(),$o.app.vp=Ext.create("Ext.container.Viewport",{layout:"border",border:!1,defaults:{border:!1},items:r})},show:function(e){var t,n=this,r=e.items,s=e.record,i=e.readOnly;if(s){var o=Ext.getClassName(s);if("$o.View.Model"==o){if(!s.get("query")&&!s.get("layout"))return;t="v"+s.get("id"),s.get("layout")&&(r={xtype:"$o.layout",record:s,$layout:i?common.makeReadOnlyLayout(s.get("layout")):s.get("layout")}),!s.get("layout")&&s.get("query")&&(r={xtype:"$o.layout",$layout:{olap:{id:"olap",view:s.getFullCode()}}})}}else r.closable=!0,t=r.id;if(r){var a=$o.app.vp.down("*[region='center']");if("Ext.tab.Panel"==Ext.getClassName(a)){var l=n.tp.down("#"+t);l||(s?l=n.tp.add({id:t,title:s.get("name"),iconCls:s.get("iconCls"),closable:!0,layout:"fit",border:!1,isTab:1,items:r}):(r.isTab=1,l=n.tp.add(r))),n.tp.doLayout(),n.tp.setActiveTab(t)}else $o.app.vp.remove(a),r.region="center",$o.app.vp.add(r)}},beforerequest:function(conn,options,eOpts){var me=this,url=options.url,olapRequest=function(){var start=options.params.page>1?(options.params.page-1)*options.params.limit:0,limit=options.params.limit,tokens=url.substr(12,url.length-12).split("&"),id=tokens[0].split("=")[1],cmpId=tokens[1].split("=")[1];options.url="?sessionId="+$sessionId,options.method="POST";var order=null;if(options.params.sort){var sort=eval("("+options.params.sort+")");order=[sort[0].property,sort[0].direction]}var filter=[],grid=Ext.getCmp(cmpId);if(grid){var gridFilter=grid.getFilter();gridFilter&&gridFilter.length&&(filter=[gridFilter])}else grid={};if(options.params.filter)for(var fs=eval("("+options.params.filter+")"),va=$o.viewsMap[id].attrs,i=0;i<fs.length;i++){var f=fs[i],dataType;if(dataType=va[f.field].get("classAttr")?$o.classAttrsMap[va[f.field].get("classAttr")].getDataType():"number","string"==dataType){for(var has=0,j=1;j<filter.length;j++)if("like"==filter[j]&&filter[j-1]==f.field&&filter[j+1]==f.value+"%"){has=1;break}if(has)continue}if("bool"==dataType){f.value=f.value?1:0;for(var has=0,j=1;j<filter.length;j++)if("="==filter[j]&&filter[j-1]==f.field&&filter[j+1]==f.value){has=1;break}if(has)continue}if(filter.length&&filter.push("and"),"bool"==dataType)f.value?filter.push([f.field,"=",1]):filter.push([f.field,"=",0,"or",f.field,"is null"]);else if("date"==dataType&&"eq"==f.comparison){if(_.isArray(filter[0])){var n=filter[0].indexOf(f.field);n>-1&&(4==filter[0].length?filter.splice(0,2):0==n?filter[0].splice(0,4):filter[0].splice(n-1,4))}filter=filter.concat(f.field,">=",f.value+" 00:00:00","and",f.field,"<=",f.value+" 23:59:59")}else{if(filter.push(f.field),f.comparison)"lt"==f.comparison&&filter.push("<"),"gt"==f.comparison&&filter.push(">"),"eq"==f.comparison&&filter.push("="),"lte"==f.comparison&&filter.push("<="),"gte"==f.comparison&&filter.push(">="),"neq"==f.comparison&&filter.push("<>");else if("string"==dataType){var v=f.value;"object"==typeof v?v.value.indexOf(",")>-1?(v.notLike?filter.push("not in"):filter.push("in"),f.value=v.value.split(",").join(".,.").split(".")):(v.notLike?filter.push("not like"):filter.push("like"),f.value=v.value+"%"):(filter.push("like"),f.value=f.value+"%")}else filter.push("=");filter.push(f.value)}}filter&&1==filter.length&&(filter=filter[0]),options.params=$o.code+".View.getContent("+id+", 0,"+start+", 50, "+limit+', null, [!{"filter":'+JSON.stringify(filter)+',"order":'+JSON.stringify(order)+',"total":'+JSON.stringify(grid.total||null)+',"dateAttrs":'+JSON.stringify(grid.dateAttrs||null)+',"timeOffsetMin":'+(new Date).getTimezoneOffset()+"}!])",options.intercepted="getContent",options.viewId=id,options.cmpId=cmpId,options.start=start},treegridRequest=function(){var node="root"==options.params.node?null:options.params.node,tokens=url.substr(16,url.length-16).split("&"),id=tokens[0].split("=")[1],view=$o.viewsMap[id],cmpId=tokens[1].split("=")[1],treegrid=Ext.getCmp(cmpId),fieldParent=tokens[2].split("=")[1],fieldId=tokens[3].split("=")[1];options.url="?sessionId="+$sessionId,options.method="POST";var query=eval("("+view.get("query")+")"),alias,table;for(alias in query.from[0]){table=query.from[0][alias];break}for(var fieldParentPair={},attrParent,i=1;i<query.select.length;i+=2)if(query.select[i]==fieldParent){fieldParentPair=$o.util.clone(query.select[i-1]);for(var key in fieldParentPair)attrParent=fieldParentPair[key]}for(var fieldIdPair={},attrId,i=1;i<query.select.length;i+=2)if(query.select[i]==fieldId){fieldIdPair=$o.util.clone(query.select[i-1]);for(var key in fieldIdPair)attrId=fieldIdPair[key]}var filter=[fieldParentPair,"is null"];node&&(filter=[fieldParentPair,"=",node]);var where=query.where||[];where.length&&where.push("and"),where=where.concat(filter),query.select=query.select.concat([{___childs:attrId},"___childId",fieldParentPair,"___parentId"]);var field2={};if(field2[alias]=attrId,query.from=query.from.concat(["left-join",{___childs:table},"on",[{___childs:attrParent},"=",field2]]),treegrid.filter&&treegrid.filter.childsFn){var cf=treegrid.filter.childsFn();cf&&cf.length&&(query.from[query.from.length-1]=query.from[query.from.length-1].concat("and",cf))}var convertFilter=function(e,t){for(var n={},r=0;r<e.select.length;r+=2)n[e.select[r+1]]=e.select[r];for(var s=[],r=0;r<t.length;r++)Ext.isArray(t[r])?s.push(convertFilter(e,t[r])):n[t[r]]?s.push($o.util.clone(n[t[r]])):s.push(t[r]);return s};if(treegrid.filter&&(!node||node&&treegrid.filter.all)){var treeFilter=treegrid.getFilter(),filter=convertFilter(query,treeFilter);filter&&filter.length&&(where=where.concat("and",filter))}if(!node&&treegrid.$opened.length){var openedFilter=[fieldParentPair,"in",treegrid.$opened.join(".,.").split(".")];if(treegrid.filter&&treegrid.filter.all){var treeFilter=treegrid.getFilter(),filter=convertFilter(query,treeFilter);filter&&filter.length&&(openedFilter=openedFilter.concat("and",filter))}where.push("or"),where.push(openedFilter)}query.where=where,options.params=$o.code+".Storage.execute([!"+JSON.stringify(query)+"!])",options.intercepted="treegrid",options.viewId=id,options.query=query,options.fieldId=fieldId,options.node=node,options.cmpId=cmpId};"view?read=1"==url.substr(0,11)&&olapRequest(),"treegrid?read=1"==url.substr(0,15)&&treegridRequest()},requestcomplete:function(conn,response,options,eOpts){var r;try{r=eval("("+response.responseText+")")}catch(e){}if(r&&r.header&&r.header.error){var msg=r.header.error,win=Ext.create("Ext.window.Window",{title:$ptitle,resizable:!1,closable:!0,width:600,height:400,layout:"fit",modal:!0,items:[{xtype:"panel",border:!1,style:"padding: 5",html:"<font color=red>"+$o.locale.translate(msg)+"</font>"}],buttons:[{text:$o.getString("More"),iconCls:"gi_circle_question_mark",handler:function(){win.removeAll(),win.add({xtype:"panel",border:!1,style:"padding: 5",html:"<font color=red>"+$o.locale.translate(msg)+"</font><br>"+JSON.stringify(options)})}},{text:"Ok",name:"ok",iconCls:"gi_ok",handler:function(){win.close()}}]});throw win.show(null,function(){win.down("*[name='ok']").focus()}),r.header.error+" options: "+JSON.stringify(options)}var olapResponse=function(){var model=Ext.ModelManager.getModel("$o.View."+options.viewId+".Model"),mFields=model.getFields(),rt=eval("("+response.responseText+")"),vFields=[],fieldsMap={},grid=Ext.getCmp(options.cmpId);for(var i in rt.data.column){var attr=rt.data.column[i][0].attr;vFields.push(attr);for(var j=0;j<mFields.length;j++)if(mFields[j].name==attr){fieldsMap[i]=mFields[j].name;break}delete grid.totalValues[attr],rt.data.column[i][0].total&&(grid.totalValues[attr]=rt.data.column[i][0].total)}for(var data=[],i=0;i<rt.data.tree.currentLength;i++){for(var row=rt.data.tree[options.start+i].data,rec={},j=0;j<vFields.length;j++)rec[fieldsMap[j]]=row[j].text;data.push(rec)}grid.countOverflow=rt.data.tree.overflow;var r={success:!0,total:rt.data.tree.length,data:data};response.responseText=JSON.stringify(r)},treegridResponse=function(){for(var node=options.node||null,model=Ext.ModelManager.getModel("$o.View."+options.viewId+".Model"),view=$o.viewsMap[options.viewId],treegrid=Ext.getCmp(options.cmpId),mFields=view.orderedFields,rt=eval("("+response.responseText+")"),fieldsMap={},query=options.query,i=0;i<query.select.length;i+=2){var attr;for(var alias in query.select[i]){attr=query.select[i+1];break}for(var j=0;j<mFields.length;j++)if(mFields[j].name==attr){fieldsMap[i/2]=mFields[j].name;break}}for(var levels={},hasId=[],i=0;i<rt.data.length;i++){var row=rt.data[i],rec={},j;for(j=0;j<mFields.length;j++)rec[fieldsMap[j]]=row[j];var childId=row[j],parentId=row[j+1];hasId.indexOf(rec[options.fieldId])==-1&&(childId||(rec.leaf=!0),treegrid&&treegrid.showChecks&&(rec.checked=!1),levels[parentId]=levels[parentId]||[],levels[parentId].push(rec),hasId.push(rec[options.fieldId]))}if(!node&&levels[null]&&levels[null].length)for(var addChildren=function(e){var t=levels[e[options.fieldId]];if(t){for(var n=[],r=0;r<t.length;r++)n.push(t[r]),addChildren(t[r]);e.children=n,e.expanded=!0}},i=0;i<levels[null].length;i++)addChildren(levels[null][i]);var data=levels[node],r={text:".",children:data};response.responseText=JSON.stringify(r)};"getContent"==options.intercepted&&olapResponse(),"treegrid"==options.intercepted&&treegridResponse()},requestexception:function(e,t,n,r){if(!($o.idleTimer>$o.maxIdleSec)){var s="<html><head><title>Unauthenticated</title></head><body><h1>401 Unauthenticated</h1></body></html>"==t.responseText?$o.getString("Session not authorized. Please, reload browser page"):t.responseText;s||(s=$o.getString("Could not connect to server")+"<br>status: "+t.status+" "+t.statusText),common.message("<font color=red>"+s+"</font><br>url: "+n.url+"<br>params: "+n.params)}},start:function(options){var me=this,meOptions=options;me.code=options.code,me.name=options.name,me.version=options.version,me.locale=options.locale;var success=options.success,scope=options.scope;$ptitle=options.name,$pversion=options.version;var useHash=options.useHash,go=function(){"en"!=meOptions.locale&&$o.locale.load("/client/extjs4/locale/"+meOptions.locale+".json"),$o.executeQueueFunctions(),Ext.Ajax.on("beforerequest",$o.app.beforerequest,$o.app),Ext.Ajax.on("requestcomplete",$o.app.requestcomplete,$o.app),Ext.Ajax.on("requestexception",$o.app.requestexception,$o.app),me.login(Ext.apply(meOptions,{scope:me,success:function(options){if(me.treeStore={},me.initTreeStore({model:"$o.Class.Model",data:"classes",map:$o.classesMap}),me.initTreeStore({model:"$o.View.Model",data:"views",map:$o.viewsMap}),me.createDesktop(options),$o.initAdapter(),$o.visualObjectum){if("admin"==$o.currentUser){var projectNeedBuild=common.getConf("projectNeedBuild");projectNeedBuild.used&&$o.app.vp.down("*[name=project]")&&(me.projectNeedBuildTooltip=Ext.create("Ext.tip.ToolTip",{title:$o.getString("Need assembly"),target:$o.app.vp.down("*[name=project]").id,anchor:"top",html:$o.getString("To update actions"),width:200,autoHide:!0,autoShow:!0,closable:!0}))}var href=document.location.href;if(href.indexOf("#")>-1&&!useHash){var tokens=href.split("#");document.location.href=tokens[0]+"#"}if($o.visualObjectum.menuConstructor&&(system.init(),system.vo.buildMenu(),$o.visualObjectum.initAction)){var fn_=eval("("+$o.visualObjectum.initAction+")");fn_()}}$o.app.fireEvent("ready"),success&&success.call(scope||me,options)}}))};$o.app.extReady?go.call(me):$o.app.on("extReady",go,me)},loginDialog:function(e){$o.app.vp.destroy();for(var t in $o.viewsMap){var n=Ext.getCmp("v"+t);n&&n.destroy()}var r=this;e=e||{},$o.app.start({code:r.code||e.code,name:r.name||e.name,version:r.version||e.version,locale:r.locale||e.locale,success:e.success})},sendMail:function(e){e=e||{},e.to&&e.subject&&e.message&&Ext.Ajax.request({url:"sendmail?sessionId="+$sessionId,method:"post",params:{to:e.to,from:e.from,subject:e.subject,message:e.message,attachments:JSON.stringify(e.attachments)}})},loadScript:function(e,t){var n=document.createElement("script"),r=document.getElementsByTagName("head")[0];n.readyState&&!n.onload?n.onreadystatechange=function(){"loaded"!=n.readyState&&"complete"!=n.readyState||(n.onreadystatechange=null,t())}:n.onload=t,n.src=e,r.appendChild(n)}}),Ext.onReady(function(){Ext.QuickTips.init(),$o.app.extReady=!0,Ext.Ajax.disableCaching=!1,Ext.Ajax.timeout=12e4,$o.app.fireEvent("extReady")}),Ext.define("$o.app.view",{singleton:!0,getItems:function(e){var t=this,n={id:"e"+e.get("id"),xtype:"tabpanel",title:e.get("name")||e.get("code"),iconCls:"gi_eye_open",layout:"fit",defaults:{bodyPadding:5},items:[{title:$o.getString("Commons"),layout:"form",tbar:[{text:$o.getString("Save"),iconCls:"gi_floppy_save",handler:t.saveCommon}],items:[{xtype:"textfield",fieldLabel:"ID",value:e.get("id"),readOnly:!0},{xtype:"textfield",fieldLabel:$o.getString("Name"),value:e.get("name")},{xtype:"textfield",fieldLabel:$o.getString("Code"),value:e.get("code")},{xtype:"textfield",fieldLabel:$o.getString("Parent"),value:e.get("parent")?$o.getView(e.get("parent")).toString():""},{xtype:"textfield",fieldLabel:$o.getString("Icon"),value:e.get("iconCls")},{xtype:"textarea",fieldLabel:$o.getString("Description"),value:e.get("description")}]}]};return n},saveCommon:function(){var e=this;console.log(e)}}),$zs=$o,$s=$o,$zp={application:$o.app},Ext.Component.AUTO_ID=1e6,objectum={ui:{}},$o.initAdapter=function(){$zp.application.toolbar=$o.app.tb,$zp.application.mainPanel=$o.app.tp,$zs.views=$o.viewsTree,$zs.views.get=function(e){var t=$o.getView({code:e});return t},objectum.ui.layout={},objectum.ui.layout.ViewLayout=$o.Layout.Widget,$zs.classes=$o.classesTree,$zs.viewAttrs=$o.viewAttrsMap,$zp.currentUser=$o.currentUser,$zp.application.onClickMenuItem=function(e){var t=$o.viewsMap[e.record.stub.get("id")];$o.app.show({record:t})},$VERSION_MAJOR=$o.serverVersion,$o.app.on("ready",function(){$zp.onLogin&&$zp.onLogin()}),$zs.id=$o.code,objectum.ui.ObjectField=$o.ObjectField.Widget,$zr=$o.locale},Ext.override(Ext.Component,{initComponent:function(){var me=this;if(me.code&&(me.iconCls=me.iconCls?me.iconCls:me.code,me.text=me.text?$o.locale.getString(me.text):$o.locale.getString(me.code)),"string"==typeof me.handler&&(me.handler=eval(me.handler)),me.listeners)for(var event in me.listeners){var ef=me.listeners[event];if("string"==typeof ef)try{me.listeners[event]=eval(ef)}catch(e){me.listeners[event]=function(){console.log("unknown function: "+ef)}}else if(ef&&ef.fn&&"string"==typeof ef.fn)try{me.listeners[event].fn=eval(ef.fn)}catch(e){me.listeners[event].fn=function(){console.log("unknown function: "+ef.fn)}}}me.callOverridden()}}),Ext.override(Ext.Panel,{initComponent:function(){this.code&&(this.iconCls=this.iconCls?this.iconCls:this.code,this.title=this.title?$o.locale.getString(this.title):$o.locale.getString(this.code)),this.callOverridden()}}),Ext.override(Ext.form.field.Date,{initComponent:function(){this.format="d.m.Y",this.callOverridden()}}),Ext.override(Ext.form.field.Time,{initComponent:function(){this.format="H:i:s",this.callOverridden()}}),Ext.override(Ext.form.field.Checkbox,{initComponent:function(){this.addEvents("check"),this.on("change",function(e,t,n){this.fireEvent("check",e,t,n)},this),this.callOverridden()}}),Ext.override(Ext.toolbar.Toolbar,{initComponent:function(){this.hasOwnProperty("border")||(this.border=!1),this.callOverridden()}}),Ext.override(Ext.form.field.Base,{initComponent:function(){this.readOnly&&!this.objectField&&"Ext.form.field.File"!=Ext.getClassName(this)&&"displayfield"!=this.xtype&&this.addCls("readonly-field"),this.hasOwnProperty("allowBlank")&&!this.allowBlank&&this.fieldLabel&&(this.fieldLabel=this.fieldLabel+"<span style='color: red !important'>*</span>"),this.callOverridden()},setReadOnly:function(e){this.objectField||"Ext.form.field.File"==Ext.getClassName(this)||"displayfield"==this.xtype||(this.readOnly?this.addCls("readonly-field"):this.removeCls("readonly-field")),this.callOverridden()}}),Ext.define("Ext.fix.util.AbstractMixedCollection",{override:"Ext.util.AbstractMixedCollection",itemAt:function(e){return this.getAt(e)}}),Date.prototype.toStringOriginal=Date.prototype.toString,Date.prototype.toString=function(e){var t=this.getDate(),n=this.getMonth()+1,r=this.getFullYear(),s=this.getHours(),i=this.getMinutes(),o=this.getSeconds();
t<10&&(t="0"+t),n<10&&(n="0"+n);var a=t+"."+n+"."+r;return(s||i||o)&&(s<10&&(s="0"+s),i<10&&(i="0"+i),o<10&&(o="0"+o),a+=" "+s+":"+i+":"+o),a},Date.prototype.toUTCString=function(){var e=this,t=function(e){return e<10?"0"+e:e};return 0==e.getHours()&&0==e.getMinutes()&&0==e.getSeconds()?'"'+t(e.getDate())+"."+t(e.getMonth()+1)+"."+t(e.getFullYear())+'"':'"'+t(e.getUTCDate())+"."+t(e.getUTCMonth()+1)+"."+t(e.getUTCFullYear())+" "+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+'"'},$zu.getThemeBGColor=function(){return window.$themeBGColor||"#ffffff"},Ext.define("$o.locale",{singleton:!0,strings:{},load:function(e){var t=Ext.Ajax.request({url:e,async:!1});try{_.each(JSON.parse(t.responseText),function(e,t){$o.locale.strings[t.toLowerCase()]=e})}catch(o){for(var t=Ext.Ajax.request({url:e,async:!1}).responseXML,n=Ext.DomQuery.select("string",t.documentElement),r=0;r<n.length;r++){var s=n[r].attributes[0].value,i=n[r].textContent||n[r].text;$o.locale.strings[s]=i}}},getString:function(){var e=_.map(_.toArray(arguments),function(e){if(!e)return e;var t=$o.locale.strings[e.toLowerCase()]||e;return e&&t&&(t=e[0].toUpperCase()==e[0]||["create","remove","delete","open","choose","cancel"].indexOf(e)>-1?t[0].toUpperCase()+t.substr(1):t[0].toLowerCase()+t.substr(1)),t});return e.join(" ")},translate:function(e){if(e.indexOf("connection limit exceeded")>-1&&(e=".     . ,   ."),e.indexOf("value exists")>-1){var t=e.split(":");e=" '"+t[1].trim()+"' .   ."}return e}}),$zu.dialog={},$zu.dialog.getNameAndCode=function(e){var t=e.title,n=e.success,r=e.scope||this,s=new Ext.Button({code:"Ok",formBind:!0,scope:this,handler:function(){n.call(r,o.getValue(),a.getValue()),c.close()}}),i=new Ext.Button({code:"Cancel",scope:this,handler:function(){c.close()}}),o=new Ext.form.TextField({selectOnFocus:!0,fieldLabel:$zr.getString("Name"),allowBlank:!1,msgTarget:"side",anchor:"95%",listeners:{render:function(){o.focus(!1,200)},specialkey:function(e,t){t.getKey()!=t.ENTER||s.disabled||(n.call(r,o.getValue(),a.getValue()),c.close())},scope:this}}),a=new Ext.form.TextField({selectOnFocus:!0,fieldLabel:$zr.getString("Code"),allowBlank:!1,msgTarget:"side",anchor:"95%",maskRe:/[A-Za-z0-9\_]/,listeners:{specialkey:function(e,t){t.getKey()!=t.ENTER||s.disabled||(n.call(r,o.getValue(),a.getValue()),c.close())},scope:this}}),l=new Ext.FormPanel({frame:!1,border:!1,defaultType:"textfield",monitorValid:!0,buttonAlign:"right",autoScroll:!0,bodyPadding:5,layout:"form",items:[o,a],buttons:[s,i]}),c=new Ext.Window({width:400,height:150,layout:"fit",modal:!0,title:t,items:[l]});c.show(null,function(){o.focus(!1,200)})},$zu.dialog.getNameAndCodeAndType=function(e){var t=e.title,n=e.success,r=e.scope||this,s=new Ext.Button({code:"Ok",formBind:!0,scope:this,handler:function(){n.call(r,o.getValue(),a.getValue(),l.getValue()),d.close()}}),i=new Ext.Button({code:"Cancel",scope:this,handler:function(){d.close()}}),o=new Ext.form.TextField({selectOnFocus:!0,fieldLabel:$zr.getString("Name"),allowBlank:!1,msgTarget:"side",anchor:"95%",listeners:{render:function(){o.focus(!1,200)},specialkey:function(e,t){t.getKey()!=t.ENTER||s.disabled||(n.call(r,o.getValue(),a.getValue(),l.getValue()),d.close())},scope:this}}),a=new Ext.form.TextField({selectOnFocus:!0,fieldLabel:$zr.getString("Code"),allowBlank:!1,msgTarget:"side",anchor:"95%",maskRe:/[A-Za-z0-9\_]/,listeners:{specialkey:function(e,t){t.getKey()!=t.ENTER||s.disabled||(n.call(r,o.getValue(),a.getValue(),l.getValue()),d.close())},scope:this}}),l=new Ext.create("$o.ConfField.Widget",{conf:"classAttr",confRef:"class",choose:{type:"view",id:"system.classes",attr:"olap.id",width:500,height:400},fieldLabel:"",value:1,allowBlank:!1,msgTarget:"side",anchor:"95%",listeners:{change:function(e){if(e>=1e3){var t=$o.getClass(e);o.setValue(t.get("name")),a.setValue(t.get("code"))}}}}),c=new Ext.FormPanel({frame:!1,border:!1,defaultType:"textfield",monitorValid:!0,buttonAlign:"right",autoScroll:!0,bodyPadding:5,layout:"form",items:[l,o,a],buttons:[s,i]}),d=new Ext.Window({width:400,height:200,layout:"fit",modal:!0,title:t,items:[c]});d.show(null,function(){o.focus(!1,200)})},Ext.namespace("common","common.chart","common.window","common.card","common.tpl","common.report","obj","dialog","$report","$dbf","$csv"),common.message=function(e,t){Ext.Msg.alert($ptitle,e,t)},common.confirm=function(e){var t=e.scope?e.scope:this;Ext.Msg.show({title:$ptitle,msg:e.message,buttons:Ext.Msg.YESNO,fn:e.fn,animEl:"elId",icon:Ext.MessageBox.QUESTION,scope:t})},common.recordSelected=function(e){e=e||{};var t,n=e.attr||"id";t=e.olap?this.relatives[e.olap]:this;var r,s=!1;return r=t.getSelectionModel?t.getSelectionModel().hasSelection():t.getCurrentValue(n),r&&(s=!0),s},obj.create=function(e){var t=$zs.createObject(e.classCode);t.commit();var n=t.getId();if(e.attrs){for(var r in e.attrs)e.attrs.hasOwnProperty(r)&&t.set(r,e.attrs[r]);t.commit()}return e.refresh&&this.refresh({callback:function(e,t,r){r&&this.selectRow({filter:["&id","=",n]})},scope:this}),n},obj.remove=function(e){if(null==e.id)return common.message($zr.getString("object must be selected")),!1;var t=!1,n=$zs.getObject(e.id);if(n){if(e.objects){for(var r=e.objects,s=0;s<r.length;s++)if(r[s].classCode)for(var i=common.execSQL({select:[{a:"id"},"id"],from:[{a:r[s].classCode}],where:[{a:r[s].attr},"=",e.id]}),o=0;o<i.length;o++){var a=$zs.getObject(i.get(o,"id"));a&&(a.remove(),a.commit())}else if(n.get(r[s])){var a=$zs.getObject(n.get(r[s]));a&&(a.remove(),a.commit())}}else if(!e.force){e.object=n;var l=obj.getDependentObjects(e);if(l.length){for(var i='<table id="objDetails" style="font-family:Tahoma !important; font-size:8pt !important;"><tr><td><b></b></td><td style="padding-left: 5px;"><b></b></td></tr>',c=0,s=0;s<l.length;s++){var n=$zs.getObject(l[s]);if(n){c++;var d;try{d=n.get("name")||"id: "+n.get("id")}catch(e){d="id: "+n.get("id")}var u=$zs.classesMap[n.get("classId")].stub.get("name");if("section_"==u.substr(0,8)){if(u="",d="",n.get("subject")){var r=$zs.getObject(n.get("subject"));d+=r.get("name")}if(n.get("repDate")){d&&(d+=", ");var r=$zs.getObject(n.get("repDate"));d+=r.get("name")}}i+="<tr><td>"+u+"</td>",i+='<td style="padding-left: 5px;">'+d+"</td></tr>"}}if(i+="</table>",c)return common.message("  : "+l.length+" (id: "+JSON.stringify(l)+')<br><a href="#" id="detailsLink"></a>'),Ext.get("detailsLink").on("click",function(){var e=window.open("","window1","width=600, height=400, resizable=yes, scrollbars=yes, status=yes, top=10, left=10");e.document.open(),e.document.write(i)},this),!1}}n=$zs.getObject(e.id),n.remove(),n.commit(),t=!0,e.refresh&&(this.getSelectionModel().deselectAll(),this.refresh())}return t},obj.getValue=function(e,t){var n=null;if(t&&"$"==t[0]){var r=t.split("."),s=r[0].substr(1,r[0].length-1);e[s]&&(e=$o.getObject(e[s]),r.splice(0,1),t=r.join("."))}if(e)for(var r=t.split("."),i=0;i<r.length;i++){if("$date"==r[i])return n?n.toString("d.m.Y"):n;if(i){if(!n)break;e=$o.getObject(n)}if(!e)break;n=e.get?e.get(r[i]):e[r[i]]}return n},common.getValue=obj.getValue,common.currentDate=function(){var e=new Date,t=e.getDate(),n=e.getMonth()+1,r=e.getFullYear(),s="";return t<10&&(s+="0"),s+=String(t)+".",n<10&&(s+="0"),s+=String(n)+".",s+=String(r)},common.getDate=function(e){if(!e)return"";var t=e.getDate(),n=e.getMonth()+1,r=e.getFullYear(),s="";return t<10&&(s+="0"),s+=String(t)+".",n<10&&(s+="0"),s+=String(n)+".",s+=String(r)},common.getDateFromDDMMYYYY=function(e){var t=null;return e&&10==e.length&&"."==e[2]&&"."==e[5]&&(t=new Date(e.substr(6,4),e.substr(3,2)-1,e.substr(0,2))),t},common.currentTime=function(){var e=new Date,t=e.getHours(),n=e.getMinutes(),r=e.getSeconds(),s="";return t<10&&(s+="0"),s+=String(t)+":",n<10&&(s+="0"),s+=String(n)+":",r<10&&(s+="0"),s+=String(r)},common.currentTimestamp=function(){return common.currentDate()+" "+common.currentTime()},common.getDate=function(e){if(!e)return"";var t=e.getDate(),n=e.getMonth()+1,r=e.getFullYear(),s="";return t<10&&(s+="0"),s+=String(t)+".",n<10&&(s+="0"),s+=String(n)+".",s+=String(r)},common.getDateISO=function(e){if(!e)return e;var t=e.getDate(),n=e.getMonth()+1,r=e.getFullYear(),s=String(r)+"-";return n<10&&(s+="0"),s+=String(n)+"-",t<10&&(s+="0"),s+=String(t)},common.getTime=function(e){var t=e.getHours(),n=e.getMinutes(),r=e.getSeconds(),s="";return t<10&&(s+="0"),s+=String(t)+":",n<10&&(s+="0"),s+=String(n)+":",r<10&&(s+="0"),s+=String(r)},common.getTimestamp=function(e){return common.getDate(e)+" "+common.getTime(e)},common.getUTCDate=function(e){var t=e.getUTCDate(),n=e.getUTCMonth()+1,r=e.getUTCFullYear(),s="";return t<10&&(s+="0"),s+=String(t)+".",n<10&&(s+="0"),s+=String(n)+".",s+=String(r)},common.getUTCTime=function(e){var t=e.getUTCHours(),n=e.getUTCMinutes(),r=e.getUTCSeconds(),s="";return t<10&&(s+="0"),s+=String(t)+":",n<10&&(s+="0"),s+=String(n)+":",r<10&&(s+="0"),s+=String(r)},common.getUTCTimestamp=function(e){return common.getUTCDate(e)+" "+common.getUTCTime(e)},common.getJulianDay=function(e){if(""==e)return 0;var t=e.getDate(),n=e.getMonth()+1,r=e.getFullYear();return jd=Math.floor(1461*(r+4800+(n-14)/12))/4+Math.floor(Math.floor(367*(n-2-12*((n-14)/12)))/12)-3*Math.floor(Math.floor(r+4900+(n-14)/12)/100)/4+t-32075,Math.floor(jd)},common.getDateByJulianDay=function(e){var t,n,r,s,i,o,a;return t=e+68569,n=Math.floor(4*t/146097),t=Math.floor(t-(146097*n+3)/4),r=Math.floor(4e3*(t+1)/1461001),t=t-Math.floor(1461*r/4)+31,s=Math.floor(80*t/2447),i=t-Math.floor(2447*s/80),t=Math.floor(s/11),o=s+2-12*t,a=100*(n-49)+r+t,new Date(a,o-1,i)},common.execSQL=function(e){var t,n;n=$zs?$zs.execute({query:e,async:!1}):zerp.Storage.STORAGES[0].execute("Storage.execute([!"+BiJson.serialize(e)+"!])");try{n.length}catch(e){n={},n.length=0}for(n.fields={},t=0;t<e.select.length/2;t++)n.fields[e.select[2*t+1]]=t,n.fields[t]=t;return n.get=function(e,t){var n=this.fields[t];if(null==n)throw"result.get: col unknown (row:"+e+",col:"+t+")";var r=this[e][n];return void 0==r&&(r=null),r},n},obj.getDependentObjects=function(e){for(var t=common.execSQL({select:[{a:"___fid"},"id"],from:[{a:"system.object"},"left-join",{b:"system.object_attr"},"on",[{a:"___fid"},"=",{b:"___fobject_id"}],"left-join",{c:"system.class_attr"},"on",[{b:"___fclass_attr_id"},"=",{c:"___fid"}]],where:[{a:"___fend_id"},"=",system.revision.maxRevision,"and",{b:"___fend_id"},"=",system.revision.maxRevision,"and",{c:"___fend_id"},"=",system.revision.maxRevision,"and",{c:"___ftype_id"},">=",1e3,"and",{b:"___fnumber"},"=",e.id]}),n=[],r=0;r<t.length;r++)n.indexOf(t.get(r,"id"))==-1&&n.push(t.get(r,"id"));return n},common.window.list=[],common.window.titleMaxLength=12,common.window.cardFn=null,common.window.callCardFn=function(e){return common.window.cardFn(e)},common.window.options=null,common.card=function(){return{}},common.window.onViewLayout=function(e){var t=e.record,n=e.layout;if($zs.views.ser.card.stub.get("id")==t.stub.get("id")&&common.window.options){var r=common.window.options.cardFn,s=r(common.window.options);Ext.apply(n,s),common.window.options=null}},common.window.show=function(e){e=e||{};var t=e.id;e.olap&&e.attr&&(t=this.relatives[e.olap].getCurrentValue(e.attr)),e.id=t;var n,r="Window-"+ ++Ext.Component.AUTO_ID,s=$zs.views.ser.card;if(4==common.extMajorVersion()?n=Ext.create("$o.Layout.Widget",{record:s,$layout:e.cardFn(e)}):(s.stub.set("layout","common.card ()"),common.window.options=e,n=new objectum.ui.layout.ViewLayout(Ext.apply({border:!1,record:s,bodyStyle:"background-color: "+$zu.getThemeBGColor()+";"},e.viewOptions))),n.on("destroy",function(){var n=common.window.list.indexOf(this);if(n>-1&&common.window.list.splice(n,1),e.refreshOlap)try{e.refreshOlap.refresh({callback:function(n,r,s){s&&e.refreshOlap.selectRow({filter:["&id","=",t]})}})}catch(e){}},this),e.refresh&&(e.refreshOlap=this.relatives[e.olap]),e.asWindow){e.width=e.width||800,e.height=e.height||600,e.listeners&&!e.listeners.scope&&(e.listeners.scope=this);var i=new Ext.Window({id:r,title:e.title,resizable:!0,closable:!0,maximizable:e.maximizable,maximized:e.maximized,modal:e.modal,width:e.width,height:e.height,iconCls:e.iconCls,bodyPadding:2,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",layout:"fit",stateful:!1,items:[n],listeners:e.listeners});n.win=i,i.on("show",function(){var e=i.getPosition();e[1]<0&&i.setPosition(e[0],0)},this),i.show(),common.window.list.push(i)}else{var o="o"+t,a=$zp.application,l=function(){if(e.listeners&&e.listeners.close){var t=e.listeners.close.scope||e.listeners.scope||this,n=e.listeners.close.fn||e.listeners.close;n.call(t)}};$o.app.tp.down("#"+o)||($o.app.tp.add({id:o,xtype:"panel",layout:"fit",node:1,iconCls:e.iconCls,tooltip:e.title,title:e.title.length>common.window.titleMaxLength?e.title.substr(0,common.window.titleMaxLength)+"...":e.title,closable:!0,bodyStyle:"background-color: "+$zu.getThemeBGColor()+";",items:[n],close:function(){a.mainPanel.remove(a.openPages[o]),l()},listeners:{destroy:function(){l()},scope:this}}),$o.app.tp.doLayout()),$o.app.tp.setActiveTab(o),document.location.href="#"+o}$zp.application.fireEvent("showPage",{record:s,showOptions:e})},common.window.closeAll=function(){for(var e=0;e<common.window.list.length;e++)common.window.list[e].close()},common.data={},common.getId=function(e){if(null==common.data[e.classCode]){common.data[e.classCode]={};for(var t=common.execSQL({select:[{a:"id"},"id",{a:"code"},"code"],from:[{a:e.classCode}]}),n=0;n<t.length;n++)common.data[e.classCode][t.get(n,"code")]=t.get(n,"id")}var r=common.data[e.classCode][e.code];if(null==r)throw{name:"common.getId exception",message:"classCode:"+e.classCode+", code:"+e.code+" not exist"};return r},common.sprLayout=function(e){var t={split:{orientation:"vertical",width:250,pages:[{olap:{id:e.olapId,view:e.viewCode,actions:[{id:e.classCode+".create",caption:"create",icon:"new",group:!0},{id:e.classCode+".remove",active:{fn:common.recordSelected,arguments:{olap:"olap",attr:"id"}},caption:"delete",icon:"delete"}]}},{card:{id:e.cardId,fields:[{id:"olap",attr:"id.npp"},{id:"olap",attr:"id.name"},{id:"olap",attr:"id.code"},{id:"olap",attr:"id.used"},{id:"olap",attr:"id.description"}]}}]}};return t},common.chart.show=function(e){var t=new Ext.data.JsonStore({fields:e.fields,data:e.data}),n=e.width||800,r=e.height||600,s=new Ext.Window({title:e.title,resizable:!0,closable:!0,maximizable:!0,width:n,height:r,layout:"fit",items:[{xtype:e.xtype,store:t,xField:e.xField,xAxis:new Ext.chart.CategoryAxis({title:e.xAxisTitle}),yAxis:new Ext.chart.NumericAxis({title:e.yAxisTitle,majorUnit:e.majorUnit}),series:e.yFields,extraStyle:{legend:{display:"right"}}}]});s.show()},Ext.apply(Ext.form.VTypes,{daterange:function(e,t){var n=t.parseDate(e);if(!n)return!1;if(t.startDateField){var r=Ext.getCmp(t.startDateField);r.maxValue&&n.getTime()==r.maxValue.getTime()||(r.setMaxValue(n),r.validate())}else if(t.endDateField){var s=Ext.getCmp(t.endDateField);s.minValue&&n.getTime()==s.minValue.getTime()||(s.setMinValue(n),s.validate())}return!0}}),dialog.getPeriod=function(e){var t=new Ext.FormPanel({labelWidth:75,frame:!0,style:"background-color: #fff",bodyStyle:"background-color: #fff",bodyPadding:5,width:300,defaults:{width:225},defaultType:"datefield",items:[{fieldLabel:$zr.getString("From"),allowBlank:!1,msgTarget:"side",value:common.currentDate(),format:"d.m.Y",name:"startdt",id:"startdt",vtype:"daterange",endDateField:"enddt"},{fieldLabel:$zr.getString("To"),allowBlank:!1,msgTarget:"side",value:common.currentDate(),format:"d.m.Y",name:"enddt",id:"enddt",vtype:"daterange",startDateField:"startdt"}]}),n=e.scope||this,r=new Ext.Window({title:e.title,resizable:!0,closable:!0,maximizable:!1,modal:!0,width:300,height:150,layout:"fit",items:[t],buttons:[{code:"ok",formBind:!0,handler:function(){var s=t.items.items[0].getValue(),i=t.items.items[1].getValue();r.close(),e.success.call(n,{startDate:s,dateStart:s,endDate:i,dateEnd:i})}},{code:"cancel",formBind:!1,handler:function(){r.close()}}]});r.show()},dialog.getObject=function(e){var t=e.width||600,n=e.height||400;e.title||(e.title=$zr.getString("object.choosing"));var r,s=e.scope||this;if(e.view)r=new objectum.ui.layout.ViewLayout({xtype:"zviewlayout",border:!1,record:$zs.views.get(e.view,{async:!1}),bodyStyle:"background-color: "+$zu.getThemeBGColor()+";"});else{var i=$zs.views.get("ser.card",{async:!1});i.stub.set("layout","string"==typeof e.layout?e.layout:JSON.stringify(e.layout)),r=new objectum.ui.layout.ViewLayout({xtype:"zviewlayout",border:!1,record:i,bodyStyle:"background-color: "+$zu.getThemeBGColor()+";"})}var o=function(){var t,n=e.attr||"id";n=n.split("."),t=1==n.length?r.relatives.olap.getCurrentValues(n[0]):r.relatives[n[0]].getCurrentValues(n[1]);var i=t[0];a.close(),e.success.call(s,{value:i,values:t})},a=new Ext.Window({title:e.title,resizable:!0,closable:!0,height:n,width:t,layout:"fit",modal:!0,tbar:[{code:"choose",handler:o,scope:s},{code:"cancel",handler:function(){a.close()}}],items:[r]});a.show()},dialog.selectObject=function(e){var t=e.success,n=e.scope,r={olap:{id:"olap",view:e.view,listeners:{dblclick:function(){o()}}}},s=$zs.views.get("ser.card",{async:!1});s.stub.set("layout",JSON.stringify(r));var i=new objectum.ui.layout.ViewLayout({xtype:"zviewlayout",border:!1,record:s,bodyStyle:"background-color: "+$zu.getThemeBGColor()+";"}),o=function(){var e=i.relatives.olap.getCurrentValue("id");c.close(),t.call(n||this,{value:e})},a=new Ext.Button({code:"choose",disabled:!0,handler:o,scope:this}),l=new Ext.Button({code:"cancel",handler:function(){c.close()}});i.on("load",function(){var e=i.relatives.olap;if(e){var t=function(){e.getCurrentValue("id")?a.setDisabled(!1):a.setDisabled(!0)};e.selModel.on("selectionchange",t,this)}},this);var c=new Ext.Window({code:$o.getString("Choose object"),resizable:!0,closable:!0,width:e.width||600,height:e.height||400,layout:"fit",modal:!0,tbar:new Ext.Toolbar({items:[a,l]}),items:[i]});c.show()},dialog.getDate=function(e){var t=new Ext.FormPanel({labelWidth:75,bodyStyle:"background-color: "+$zu.getThemeBGColor()+"; padding: 5px 5px 0;",width:300,border:!1,defaults:{width:225},defaultType:"datefield",items:[{fieldLabel:$zr.getString("Date"),allowBlank:!1,msgTarget:"side",value:e.value||common.currentDate(),minValue:e.minValue,maxValue:e.maxValue,format:"d.m.Y",name:"dt",id:"dt"}]}),n=e.scope||this,r=new Ext.Window({title:e.title,closable:!0,modal:!0,width:300,height:120,layout:"fit",items:[t],buttons:[{text:"Ok",iconCls:"ok",formBind:!0,handler:function(){var s=t.items.items[0].getValue();r.close(),e.success.call(n,{date:s})}},{code:"cancel",formBind:!1,handler:function(){r.close()}}]});r.show()},dialog.getString=function(e){var t=e.title||$ptitle,n=e.success,r=e.failure,s=e.scope||this,i=e.value,o=new Ext.Button({code:"Ok",formBind:!0,scope:this,handler:function(){n.call(s,l.getValue()),d.close()}}),a=new Ext.Button({code:"Cancel",scope:this,handler:function(){r&&r.call(s),d.close()}}),l=new Ext.form.TextField({selectOnFocus:!0,fieldLabel:e.fieldLabel||$o.getString("Enter string"),allowBlank:!1,msgTarget:"side",anchor:"95%",value:i,listeners:{render:function(){l.focus(!1,200)},specialkey:function(e,t){t.getKey()!=t.ENTER||o.disabled||(n.call(s,l.getValue()),d.close())},scope:this}}),c=new Ext.FormPanel({frame:!1,border:!1,defaultType:"textfield",monitorValid:!0,buttonAlign:"right",autoScroll:!0,bodyStyle:"background-color: "+$zu.getThemeBGColor()+"; padding: 5px;",layout:"form",items:[l],buttons:[o,a]}),d=new Ext.Window({width:450,height:150,layout:"fit",modal:!0,title:t,items:[c]});d.show(null,function(){l.focus()})},dialog.getNumber=function(e){var t=e.title||$ptitle,n=e.success,r=e.failure,s=e.scope||this,i=new Ext.Button({code:"Ok",formBind:!0,scope:this,handler:function(){n.call(s,a.getValue()),c.close()}}),o=new Ext.Button({code:"Cancel",scope:this,handler:function(){r&&r.call(s),c.close()}}),a=new Ext.form.NumberField({selectOnFocus:!0,fieldLabel:e.fieldLabel||$o.getString("Enter number"),allowBlank:!1,msgTarget:"side",anchor:"95%",listeners:{render:function(){a.focus(!1,200)},specialkey:function(e,t){t.getKey()!=t.ENTER||i.disabled||(n.call(s,a.getValue()),c.close())},scope:this}}),l=new Ext.FormPanel({frame:!1,border:!1,defaultType:"textfield",monitorValid:!0,buttonAlign:"right",autoScroll:!0,bodyStyle:"background-color: "+$zu.getThemeBGColor()+"; padding: 5px;",layout:"form",items:[a],buttons:[i,o]}),c=new Ext.Window({width:450,height:150,layout:"fit",modal:!0,title:t,items:[l]});c.show(null,function(){a.focus()})},$report.sheet=function(e){e=e||{},this.name=e.name||"Sheet",this.orientation=e.orientation||"portrait",this.scale=e.scale||"100",this.margins=e.margins||{left:15,top:15,right:15,bottom:15},this.rows=e.rows||[],this.validation=e.validation||[],this.namedRange=e.namedRange||[],this.columns=e.columns||{},this.ell=e.ell||{},this.autoFitHeight=e.autoFitHeight},$report.row=function(e){e=e||{},this.height=e.height||12.75,this.cells=e.cells||[],this.startIndex=e.startIndex||0},$report.xmlss=function(e){this.params={},this.styles={default:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9",center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9",center_bold:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,bold:true",bold:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,bold:true",border:"hAlign:Left,vAlign:Top,wrap:true,fontSize:9,borders:All",border_center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,borders:All",border_bold:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true",border_bold_underline:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true,underline:true",border_underline:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:All,underline:true",border_bold_center:"hAlign:Center,vAlign:Center,wrap:true,fontSize:9,borders:All,bold:true",border_bottom:"hAlign:Left,vAlign:Center,wrap:true,fontSize:9,borders:Bottom",right:"hAlign:Right,vAlign:Center,wrap:true,fontSize:9"},this.columns={},this.rows=[],this.sheets=[],this.normalize=function(e){if(Ext.isArray(this.columns)){for(var t={},n=0;n<this.columns.length;n++)t[n+1]={width:this.columns[n]};this.columns=t}this.rows&&this.rows.length||(this.rows=[{cells:[{text:""}]}]);for(var n=0;n<this.rows.length;n++){var r=this.rows[n];r.height=r.height||12.75,r.cells=r.cells||[];for(var s=0;s<r.cells.length;s++)"number"==typeof r.cells[s].text&&(r.cells[s].text=String(r.cells[s].text));r.startIndex=r.startIndex||0}for(var i=0;i<this.sheets.length;i++){var o=this.sheets[i];if(Ext.isArray(o.columns)){for(var t={},n=0;n<o.columns.length;n++)t[n+1]={width:o.columns[n]};o.columns=t}o.rows=o.rows||[];for(var n=0;n<o.rows.length;n++){var r=o.rows[n];r.height=r.height||12.75,r.cells=r.cells||[];for(var s=0;s<r.cells.length;s++){var a=r.cells[s].text;"number"==typeof a&&(r.cells[s].text=String(r.cells[s].text)),"string"==typeof a&&("null"==a?r.cells[s].text="":r.cells[s].text=a.split("<").join("&lt;").split(">").join("&gt;")),e&&e.showNull&&(null==a||""==a||"null"==a)&&(r.cells[s].text="null"),r.cells[s].style=r.cells[s].style||"default"}r.startIndex=r.startIndex||0}o.rows.length||(o.rows=[{startIndex:0,height:12.75,cells:[{text:"",style:"default"}]}])}},this.preview=function(e){var t=this;e=e||{},t.title=e.title;var n=new Ext.Window({title:$o.getString("Preview"),resizable:!0,closable:!0,maximizable:!0,modal:!0,width:1e3,height:600,border:!1,iconCls:"gi_print",layout:"fit",items:{html:t.createHTML({generate:1}),autoScroll:!0},buttons:[{text:e.xlsx?" XML - MS Excel":"",iconCls:"gi_print",handler:function(){t.create()}},{text:"XLSX - MS Excel",iconCls:"gi_print",hidden:!e.xlsx,handler:function(){t.createXLSX()}}]});n.show()},this.create=function(e){this.normalize(e);var t="report?sessionId="+$sessionId+"&username="+$zp.currentUser+"&format=xmlss&custom=1";document.getElementById("loading").innerHTML="<form name='form_report' method='post' target='_blank' action='"+t+"'><textarea style='display: none' name='params'>"+JSON.stringify(this.params)+"</textarea><textarea style='display: none' name='styles'>"+JSON.stringify(this.styles)+"</textarea><textarea style='display: none' name='columns'>"+JSON.stringify(this.columns)+"</textarea><textarea style='display: none' name='rows'>"+JSON.stringify(this.rows)+"</textarea><textarea style='display: none' name='sheets'>"+JSON.stringify(this.sheets)+"</textarea></form>",document.forms.form_report.submit()},this.createXLSX=function(e){this.normalize(e);var t="report?sessionId="+$sessionId+"&username="+$zp.currentUser+"&format=xlsx";document.getElementById("loading").innerHTML="<form name='form_report' method='post' target='_blank' action='"+t+"'><textarea style='display: none' name='params'>"+JSON.stringify(this.params)+"</textarea><textarea style='display: none' name='styles'>"+JSON.stringify(this.styles)+"</textarea><textarea style='display: none' name='columns'>"+JSON.stringify(this.columns)+"</textarea><textarea style='display: none' name='rows'>"+JSON.stringify(this.rows)+"</textarea><textarea style='display: none' name='sheets'>"+JSON.stringify(this.sheets)+"</textarea></form>",document.forms.form_report.submit()},this.createCSV=function(e){this.normalize(e);var t="report?sessionId="+$sessionId+"&username="+$zp.currentUser+"&format=xlsx&convert_csv=1&win1251=1";document.getElementById("loading").innerHTML="<form name='form_report' method='post' target='_blank' action='"+t+"'><textarea style='display: none' name='params'>"+JSON.stringify(this.params)+"</textarea><textarea style='display: none' name='styles'>"+JSON.stringify(this.styles)+"</textarea><textarea style='display: none' name='columns'>"+JSON.stringify(this.columns)+"</textarea><textarea style='display: none' name='rows'>"+JSON.stringify(this.rows)+"</textarea><textarea style='display: none' name='sheets'>"+JSON.stringify(this.sheets)+"</textarea></form>",document.forms.form_report.submit()},this.createPDF=function(e){this.normalize();var t="pdf?sessionId="+$sessionId;document.getElementById("loading").innerHTML="<form name='form_report' method='post' target='_blank' action='"+t+"'><textarea style='display: none' name='params'>"+JSON.stringify(this.params)+"</textarea><textarea style='display: none' name='styles'>"+JSON.stringify(this.styles)+"</textarea><textarea style='display: none' name='columns'>"+JSON.stringify(this.columns)+"</textarea><textarea style='display: none' name='rows'>"+JSON.stringify(this.rows)+"</textarea><textarea style='display: none' name='sheets'>"+JSON.stringify(this.sheets)+"</textarea></form>",document.forms.form_report.submit()},this.createHTML=function(e){this.normalize(),e=e||{};var t=e.rows||this.rows;this.sheets.length&&(t=this.sheets[0].rows);var n;n=e.generate?{document:{open:function(){},close:function(){},html:"",write:function(e){this.html+=e}}}:window.open("","window1","width=800, height=600, resizable=yes, scrollbars=yes, status=yes, top=10, left=10"),n.document.open(),e.title&&n.document.write("<p><b>"+e.title+"</b></p>"),n.document.write("<style type='text/css'>\n* {\n   font-family: Tahoma;\n   font-size: 8pt;\n}\ntable {\n\tborder-left: 0px;\n\tborder-top: 0px;\n\tborder-right: 1px solid #BBBBBB;\n\tborder-bottom: 1px solid #BBBBBB;\n}\ntr {\n\tborder: 0px;\n}\ntd {\n\tborder-left: 1px solid #BBBBBB;\n\tborder-top: 1px solid #BBBBBB;\n\tborder-right: 0px;\n\tborder-bottom: 0px;\n}\n.tb-text {\n\ttext-align: left;\n\tpadding: 5px;\n}\n.tb-header {\n\tpadding: 5px;\n\tfont-weight: bold;\n\tbackground: #DDDDDD;\n}\n.tb-title {\n\tpadding: 5px;\n\tpadding-left: 20px !important;\n\tbackground: #DDEEFF;\n}\n</style>\n"),n.document.write("<table cellpadding=0 cellspacing=0>");for(var r=0;r<t.length;r++){for(var s=t[r],i=s.cells,o="<tr>",a=0;a<i.length;a++){var l=i[a],c=l.text;void 0!==c&&null!==c&&""!==c||(c="<img width=1 height=1>"),l.style=l.style||"",l.style.indexOf("bold")>-1&&(c="<b>"+c+"</b>"),"border_gray"==l.style&&(c="<font color='gray'>"+c+"</font>");var d="";"border_bg_gray"==l.style&&(d="bgcolor='#DDDDDD'"),"border_bg_red"==l.style&&(d="bgcolor='#ff9999'"),"border_bg_green"==l.style&&(d="bgcolor='#99ff99'"),"border_bg_blue"==l.style&&(d="bgcolor='#9999ff'"),o+="<td class='tb-text' colspan="+l.colspan+" rowspan="+l.rowspan+" "+d+">"+c+"</td>"}o+="</tr>",n.document.write(o)}if(n.document.write("</table>"),n.document.close(),e.generate)return n.document.html}},$dbf.field=function(e){this.name=e.name,this.type=e.type,"D"==e.type?this.size=8:this.size=e.size||0,this.dec=e.dec||0},$dbf.file=function(e){e=e||{},this.options={filename:"data.dbf",coding:e.coding||"WIN"},this.fields=e.fields||[],this.rows=e.rows||[],this.create=function(e){for(var t="report?sessionId="+$sessionId+"&username="+$zp.currentUser+"&format=dbf&custom=1&filename="+this.options.filename,n=0;n<this.rows.length;n++){var r=this.rows[n];for(var s in r)r[s]=String(r[s])}document.getElementById("loading").innerHTML="<form name='form_report' method='post' action='"+t+"'><textarea style='display: none' name='options'>"+JSON.stringify(this.options)+"</textarea><textarea style='display: none' name='fields'>"+JSON.stringify(this.fields)+"</textarea><textarea style='display: none' name='rows'>"+JSON.stringify(this.rows)+"</textarea></form>",document.forms.form_report.submit()}},$csv.file=function(e){e=e||{},this.body=e.body||"",this.create=function(e){var t="report?sessionId="+$sessionId+"&username="+$o.currentUser+"&format=xmlss&custom=1&csv=1";document.getElementById("loading").innerHTML="<form name='form_report' method='post' action='"+t+"'><textarea style='display: none' name='body'>"+this.body+"</textarea></form>",document.forms.form_report.submit()}},String.prototype.fulltrim=function(){return this.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},common.isEmail=function(e){var t=/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;return t.test(e)},Ext.example=function(){function e(e,t){return['<div class="msg">','<div class="x-box-tl"><div class="x-box-tr"><div class="x-box-tc"></div></div></div>','<div class="x-box-ml"><div class="x-box-mr"><div class="x-box-mc"><h3>',e,"</h3>",t,"</div></div></div>",'<div class="x-box-bl"><div class="x-box-br"><div class="x-box-bc"></div></div></div>',"</div>"].join("")}return{msg:function(t,n,r){var s=Ext.DomHelper.insertFirst(r||document.body,{id:"msg-div"},!0),i=Ext.DomHelper.append(s,{html:e(t,n)},!0);i.slideIn("t").pause(500).ghost("t",{remove:!0})},init:function(){var e=Ext.get("lib-bar");e&&e.show()}}}(),common.balloon=function(e,t){Ext.example.msg(e,t)},common.rowLinks=function(e,t,n,r,s,i,o){return(t.id==(o.fieldName||"name")||t.column&&t.column.dataIndex==(o.fieldName||"name"))&&(e=e||o.nullText||$o.getString("Untitled"),o.id=n.data[o.fieldId||"id"],e="<a href='#' onclick='"+o.fn+'.call (Ext.getCmp ("'+this.id+'"), '+JSON.stringify(o)+")'>"+e+"</a>"),e},common.round=function(e,t){if(!e)return e;var n;switch(t){case null:case void 0:case 0:n=1;break;case 1:n=10;break;case 2:n=100;break;case 3:n=1e3;break;case 4:n=1e4;break;default:throw"common.round - invalid n: "+t}var r=Math.round(e*n)/n;return r},common.isNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},common.sqlArray=function(e){for(var t=[],n=0;n<e.length;n++)n&&t.push(","),t.push(e[n]);return t},common.extMajorVersion=function(){var e=Ext.version||Ext.getVersion().version;return e.split(".")[0]},common.isEmail=function(e){var t=/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;return t.test(e)},common.unicode={escape:function(e){return e?e.replace(/^[-~]|\\/g,function(e){var t=e.charCodeAt(0);return"\\u"+(t<16?"000":t<256?"00":t<4096?"0":"")+t.toString(16)}):e},unescape:function(e){return e?e.replace(/\\u([a-fA-F0-9]{4})/g,function(e,t){return String.fromCharCode(parseInt(t,16))}):e}},common.addRecord=function(e){function t(e,t){for(var n=t.split("."),r=e[n[0]],s=1;s<n.length;s++){
var i=$o.getObject(r);if(!i){r=null;break}r=i.get(n[s])}return r}var n=e.store,r=e.data,s=e.map;if(!n||!r||!s)return r;for(var i in s)r[i]=t(r,s[i]);var o=e.cmp;if(o.getXType().indexOf("tree")>-1){var a,l=o.getSelectionModel();l.hasSelection()?(a=l.getSelection()[0],a.set("leaf",!1)):a=o.getStore().getRootNode(),r.leaf=!0,a.appendChild(r)}else n.add(r);return r},common.updateRecord=function(e){function t(e,t){for(var n=t.split("."),r=e.get(n[0]),s=1;s<n.length;s++){var i=$o.getObject(r);if(!i){r=void 0;break}r=i.get(n[s])}return r}var n=e.record,r=e.map;if(!n||!r)return n;for(var s in r){var i=t(n,r[s]);void 0!==i&&n.set(s,i)}return n.commit(),n},common.tpl.remove=function(e){e=e||{};var t=this;common.confirm({message:$o.getString("Are you sure?"),fn:function(n){if("yes"==n){var r=e.id||t.getValue("a_id")||t.getValue("id");if(r){$o.startTransaction({description:"Remove "+r});var s=$o.getObject(r);if(s.remove(),s.commit(),$o.commitTransaction(),t.getSelectionModel){var i=t.getSelectionModel().getSelection()[0];if(t.getXType().indexOf("tree")>-1){var o=i.parentNode;i.remove(),o==t.getStore().getRootNode()||o.childNodes.length||o.set("leaf",!0)}else t.getStore().remove(i)}}}}})},common.tpl.show=function(options){var me=this;options=options||{},options.id=options.id||this.getValue("a_id")||this.getValue("id");var refresh=options.refresh,fn=options.card;fn&&(fn="string"==typeof fn?eval(fn):fn);var layout=options.layout;if(options.title=options.title||"",options.id){var o=$s.getObject(options.id);options.title=o.get("name")||"ID: "+(options.id<0?$o.getString("Adding"):options.id)}for(var map=options.map||me.map||{},sql=eval("("+me.$view.get("query")+")"),getTree=function(e){function t(n){for(var s=2;s<e.length;s+=4){var i;for(i in e[s])break;if(!r[i])for(var o=e[s+2],a=0;a<o.length;a++)if("object"==typeof o[a]){var l;for(l in o[a])break;l==n&&"id"!=o[a][l]&&(r[i]=r[n]+"."+o[a][l],t(i))}}}var n,r={};for(n in e[0])break;return r[n]=me.$view.attrs.a_id?"a_id":"id",t(n),r},tree=getTree(sql.from),i=1;i<sql.select.length;i++)if("string"==typeof sql.select[i])for(var j=0;j<me.columns.length;j++)if(me.columns[j].dataIndex==sql.select[i]){var a;for(a in sql.select[i-1])break;map[sql.select[i]]=map[sql.select[i]]||tree[a]+"."+sql.select[i-1][a]}layout=layout||fn.call(this,options),options.readOnly&&common.makeReadOnlyLayout(layout);var items={id:"o"+options.id,objectId:options.id,name:"viewContainer",xtype:"$o.layout",opener:me,title:options.title,$layout:layout,listeners:{destroy:function(){var e=$s.getObject(options.id);if(e.get("id")!=options.id){var t=common.addRecord({cmp:me,store:me.getStore(),data:me.$view.attrs.a_id?{a_id:e.get("id")}:{id:e.get("id")},map:map});me.getXType().indexOf("tree")==-1&&(me.getSelectionModel().deselectAll(),me.getSelectionModel().select(me.getStore().getCount()-1))}else{var t=me.getSelectionModel().getSelection()[0];if(!t){var n=me.getStore(),r=me.getSelectionModel();t=n.getById(options.id),t&&r.select(t)}common.updateRecord({cmp:me,record:t,map:map})}refresh&&"function"==typeof me.refresh&&me.refresh()}}};if(options.asWindow){items.title=void 0;var win=Ext.create("Ext.window.Window",{title:options.title,resizable:!0,closable:!0,width:options.width||800,height:options.height||600,layout:"fit",modal:!0,items:items});win.show()}else $o.app.show({items:items})},common.tpl.getViewObjectId=function(){var e=0,t=this.up("*[name=viewContainer]");return t&&(e=t.objectId),e},common.tpl.getOpener=function(){var e=this.up("*[name=viewContainer]");if(e)return e.opener},common.tpl.create=function(options){var me=this,o=$s.createObject(options.classCode,"local");if(options.attrs)for(var attr in options.attrs){var v=options.attrs[attr];"[object Array]"===Object.prototype.toString.apply(v)&&(v=me.relatives[v[0]].getValue(v[1])),o.set(attr,v)}if(me.getXType().indexOf("tree")>-1&&o.set(me.fields.parent,me.getValue(me.fields.id)),options.id=o.get("id"),options.fn){var fn="string"==typeof options.fn?eval(options.fn):options.fn;fn.call(me,o,options)}options.layout||(options.card=options.card||options.classCode+".card"),common.tpl.show.call(this,options)},common.tpl.updateTags=function(e,t){if(!e)return e;var n=[],r=0;"object"==typeof e&&(e=JSON.stringify(e),r=1);for(var s=1;s<e.length;s++)if(("$"==e[s]||"#"==e[s])&&"["==e[s-1]){for(var i="";s<e.length&&"]"!=e[s];s++)i+=e[s];n.indexOf(i)==-1&&n.push(i)}for(var s=0;s<n.length;s++){var o;o="$"==n[s][0]?common.getValue(t,n[s]):t[n[s].substr(1)],e=e.split("["+n[s]+"]").join(o)}return r&&(e=JSON.parse(e)),e},dialog.getClass=function(e){var t=e.success,n=Ext.create("Ext.Window",{title:$o.getString("Choose","class"),width:900,height:700,layout:"fit",frame:!1,border:!1,bodyPadding:1,items:{xtype:"$o.classes",name:"classes"},listeners:{afterrender:function(){var e,r=n.down("*[zid=olap]"),s=Ext.create("Ext.Button",{text:$o.getString("Choose"),iconCls:"ok",disabled:!0,handler:function(){t({id:e}),n.close()}});r.selModel.on("selectionchange",function(){e=r.getCurrentValue("id"),e?s.setDisabled(!1):s.setDisabled(!0)},this),r.lconfig&&r.lconfig.listeners&&r.lconfig.listeners.dblclick&&delete r.lconfig.listeners.dblclick,r.on("itemdblclick",function(){s.handler()});var i=r.down("toolbar[dock=top]");i.insert(0,[s]),i.doLayout()}}});n.show()},dialog.getView=function(e){var t=e.success,n=Ext.create("Ext.Window",{title:$o.getString("Select")+" "+(e.hasQuery?$o.getString("query"):$o.getString("view")),width:900,height:700,layout:"fit",frame:!1,border:!1,bodyPadding:1,items:{xtype:"$o.views",name:"views"},listeners:{afterrender:function(){var r,s=n.down("*[zid=olap]"),i=Ext.create("Ext.Button",{text:$o.getString("Choose"),iconCls:"ok",disabled:!0,handler:function(){t({id:r}),n.close()}});s.selModel.on("selectionchange",function(){r=s.getCurrentValue("id"),r&&(!e.hasQuery||e.hasQuery&&$o.getView(r).get("query"))?i.setDisabled(!1):i.setDisabled(!0)},this),s.lconfig&&s.lconfig.listeners&&s.lconfig.listeners.dblclick&&delete s.lconfig.listeners.dblclick,s.on("itemdblclick",function(){i.handler()});var o=s.down("toolbar[dock=top]");o.insert(0,[i]),o.doLayout()}}});n.show()},dialog.getAction=function(e){var t=e.success,n=Ext.create("Ext.Window",{title:$o.getString("Select","action"),width:900,height:700,layout:"fit",frame:!1,border:!1,bodyPadding:1,items:{xtype:"$o.classes",name:"classes"},listeners:{afterrender:function(){var e=n.down("*[zid=olapActions]");e.up("tabpanel").setActiveTab(2);var r,s=Ext.create("Ext.Button",{text:$o.getString("Choose"),iconCls:"ok",disabled:!0,handler:function(){t({id:r}),n.close()}});e.selModel.on("selectionchange",function(){r=e.getCurrentValue("id"),r?s.setDisabled(!1):s.setDisabled(!0)},this),e.lconfig&&e.lconfig.listeners&&e.lconfig.listeners.dblclick&&delete e.lconfig.listeners.dblclick,e.on("itemdblclick",function(){s.handler()});var i=e.down("toolbar[dock=top]");i.insert(0,[s]),i.doLayout()}}});n.show()},common.report.show=function(e){var t=$o.getObject(e.id),n=e.success,r=t.get("options")?JSON.parse(t.get("options")):null,s=Ext.create("Ext.Window",{title:$o.getString("Report"),iconCls:"gi_print",width:800,height:600,layout:"fit",frame:!1,border:!1,bodyPadding:1,modal:!0,maximizable:!0,tbar:[{text:$o.getString("Save"),iconCls:"save",handler:function(){var e=s.down("*[name=reportdesigner]"),r=e.getValue();return r.code?($o.startTransaction(),t.set("name",r.name),t.set("code",r.code),t.set("options",JSON.stringify(r)),t.sync("local"),$o.commitTransaction(),void(n&&n({id:t.get("id")}))):void common.message($o.getString("Enter report code"))}},{text:$o.getString("Preview"),iconCls:"gi_search",handler:function(){var e=JSON.parse(t.get("options")),n=Ext.create("$o.ReportDesigner.Widget",{value:e});n.build({html:1})}}],items:{xtype:"$o.reportdesigner",name:"reportdesigner",value:r}});s.show()},common.report.build=function(e){var t=e.code,n=$o.execute({select:[{a:"id"},"id"],from:[{a:"system.vo.report"}],where:[{a:"code"},"=",t]});if(!n.length)return void common.message($o.getString("Report")+" '"+t+"' "+$o.getString("not exists"));var r=$o.getObject(n.get(0,"id")),s=JSON.parse(r.get("options")),i=Ext.create("$o.ReportDesigner.Widget",{value:s});i.build(e)},common.merge=function(e,t){var n={};for(var r in e)e.hasOwnProperty(r)&&(n[r]=e[r]);for(var s in t)t.hasOwnProperty(s)&&(n.hasOwnProperty(s)?"object"==typeof n[s]&&n[s].constructor===Object&&"object"==typeof t[s]&&t[s].constructor===Object&&(n[s]=common.merge(n[s],t[s])):n[s]=t[s]);return n},common.makeReadOnlyLayout=function(layout){function go(e){if(!cache[e]){cache[e]=!0;for(var t in e)if("object"==typeof e[t])if("actions"==t&&Ext.isArray(e[t]))for(var n=e[t].length-1;n>=0;n--)[$o.getString("Open")].indexOf(e[t][n].text)>-1||["open"].indexOf(e[t][n].caption)>-1?(e[t][n].arguments=e[t][n].arguments||{},e[t][n].arguments.readOnly=!0):[$o.getString("Add"),$o.getString("Remove")].indexOf(e[t][n].text)>-1||["create","delete"].indexOf(e[t][n].caption)>-1?e[t][n].active=function(){return!1}:(e[t][n].arguments=e[t][n].arguments||{},e[t][n].arguments.readOnly=!0);else"listeners"==t&&e.listeners.dblclick?delete e.listeners.dblclick:"card"==t?e[t].readOnly=!0:go(e[t])}}var cache={};return"string"==typeof layout&&(layout=eval("("+layout+")")),go(layout),layout},common.setThousandSeparator=function(e){for(var t=String(e),n=[],r=0;r<t.length%3;r++)t=" "+t;for(var r=0;r<t.length;r+=3)n.push(t.substr(r,3));return n.join(" ")},common.findObject=function(e,t){var n,r,s,i;for(n in t)t.hasOwnProperty(n)&&(r=n,s=t[n]);for(n in e)if(n==r){if(e[n]==s)return e}else if(e[n]instanceof Object&&e.hasOwnProperty(n)&&(i=common.findObject(e[n],t)))return i;return!1},common.findMenuItem=function(e,t){for(var n=e.items,r=0;r<n.getCount();r++){var s=n.getAt(r),i=!0;if(_.each(t,function(e,t){e!=s[t]&&(i=!1)}),i)return s;if(s.menu&&(s=common.findMenuItem(s.menu,t)))return s}},common.updateMenuItemText=function(e,t,n){var r=common.findMenuItem(e,t);r&&r.setText&&r.setText(n)},common.reportTpl=function(e){if("post"==e.method){var t="report?storage="+$o.code+"&sessionId="+$sessionId+"&username="+$o.currentUser+"&time_offset_min="+(new Date).getTimezoneOffset()+"&format="+e.format+"&template="+e.template;e.files&&(t+="&files="+e.files);var n=document.createElement("form");n.target="Map",n.method="POST",n.action=t;var r=document.createElement("input");r.type="text",r.name="opts",r.value=JSON.stringify(e),n.appendChild(r),document.body.appendChild(n),map=window.open("","Map"),n.submit()}else{var t="report?";_.each(e,function(e,n){t+=n+"="+e+"&"}),t+="storage="+$o.code+"&sessionId="+$sessionId+"&username="+$o.currentUser+"&time_offset_min="+(new Date).getTimezoneOffset();var s=window.open(t);s.focus()}},common.serverJob=function(e){e="string"==typeof e?{fn:e}:e,$o.execute({fn:"service.job",args:e,success:function(e){window.open("/projects/"+$o.id+"/resources/html/"+e.logFile,e.logFile)}})},Ext.namespace("system.object","system.object_attr","system.class_","system.class_attr","system.view","system.view_attr","system.revision","system.LoginPassword","spr.conf","system.access","$layout.card","ose.role","ose.srole","ose.ext","ose.object","system.vo.menu","system.vo.menuItems","subject.human"),system.init=function(){$zp.onLogin=function(){"3"==$VERSION_MAJOR&&system.getObjNews()},$zp.onLogout=function(){common.window.closeAll()},$zp.application.on("ready",function(){function e(){var e=document.location.href,t=e.split("#");return 2==t.length?t=t[1]:""}function t(e){for(var t=$zp.application.mainPanel.items,n=0;n<t.getCount();n++){var r=t.getAt(n);if(r.id==e)return $zp.application.mainPanel.setActiveTab(r.id),!0}return!1}function n(e){if("v"==e[0]){var t=$zs.viewsMap[e.substr(1)];if(t)try{$zp.application.onClickMenuItem.call($zp.application,{record:t,text:t.stub.get("name")})}catch(e){$o.app.show.call($o.app,{record:t})}}else if("o"==e[0]){var n=e.substr(1),r=$zs.getObject(n);r&&system.object.show({id:n})}}function r(){var s=e();s!=$zp.hash&&(t(s)||n(s),$zp.hash=s),setTimeout(r,200)}$zp.hash=e(),$zp.hash&&(t($zp.hash)||n($zp.hash)),"onhashchange"in window?window.onhashchange=r:setTimeout(r,200),common.getConf("maxIdleSec").used&&($o.maxIdleSec=common.getConf("maxIdleSec").value)}),$zp.application.on("viewlayout",common.window.onViewLayout)},system.object_attr.history=function(e){e=e||{};var t;if(e.id)t=e.id;else if(e.objectId){var n=common.execSQL({select:[{a:"___fid"},"id"],from:[{a:"system.object_attr"}],where:[{a:"___fend_id"},"=",system.revision.maxRevision,"and",{a:"___fobject_id"},"=",e.objectId,"and",{a:"___fclass_attr_id"},"=",e.classAttrId]});if(0==n.length)return;t=n.get(0,"id")}else e.olap=e.olap||"olap",e.attr=e.attr||"id",t=this.relatives[e.olap].getCurrentValue(e.attr);common.window.show.call(this,{id:t,asWindow:!0,modal:!0,title:$zr.getString("History of changes"),iconCls:"event-log",cardFn:function(e){var t={olap:{id:"olap",view:"ser.system.objectAttrHistory",filter:["fid","=",e.id]}};return t}})},system.revision.maxRevision=2147483647,system.object.classes={},system.object.registerClass=function(e){system.object.classes[e.classId]={},system.object.classes[e.classId].showFunc=e.showFunc},system.object.show=function(e){var t=e.id;!t&&e.olap&&e.attr&&(t=this.zview.getCurrentValue(e.olap,e.attr));var n=$zs.getObject(t),r=$o.getClass(n.get("classId")),s=r.get("id");system.object.classes[s]?system.object.classes[s].showFunc.call(this,{id:t}):common.window.show({id:t,asWindow:!0,modal:!0,title:$zr.getString("Object")+" ID: "+n.getId(),width:800,height:600,cardFn:function(e){var t=$zs.getObject(e.id),n={card:{id:"objectCard",readOnly:!0,fields:[]}};for(var r in t.data)"classId"!=r&&"id"!=r&&n.card.fields.push({objectId:e.id,attr:r});return n}})},system.view.chooseAll=function(e){this.relatives[e.olap].selModel.selectAll()},system.view.selectQuery=function(e){function t(e){var n={text:e.toString()};if(e.childs){n.expanded=0,n.children=[];for(var r=0;r<e.childs.length;r++)n.children.push(t($o.viewsMap[e.childs[r]]))}else n.leaf=1;return n}var n=e.success,r=[];for(var s in $o.viewsMap){var i=$o.viewsMap[s];i.get("parent")||i.get("system")||r.push(t($o.viewsMap[s]))}var o,a=Ext.create("Ext.data.TreeStore",{root:{expanded:!0,children:r},sorters:[{property:"text",direction:"ASC"}]}),l=Ext.create("Ext.Window",{width:800,height:600,layout:"border",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:$o.getString("Select","query"),iconCls:"gi_cogwheel",bodyPadding:5,modal:1,tbar:[{text:$o.getString("Choose"),iconCls:"gi_ok",name:"ok",disabled:1,handler:function(){n({value:o}),l.close()}},{text:$o.getString("Cancel"),iconCls:"gi_remove",handler:function(){l.close()}}],items:[{split:!0,region:"west",width:400,layout:"fit",items:{xtype:"treepanel",title:$o.getString("Views"),iconCls:"gi_eye_open",store:a,rootVisible:!1,border:0,listeners:{select:function(e,t,n,r){var s=0;if(t){var i=t.get("text").split(":")[1].split(")")[0],a=$o.getView(Number(i));l.down("*[name=query]").setValue(a.get("query")?a.get("query"):""),a.get("query")&&(s=1),o=a.get("id")}s?l.down("*[name=ok]").enable():l.down("*[name=ok]").disable()}}}},{region:"center",layout:"fit",items:{title:$o.getString("Query"),name:"query",iconCls:"gi_cogwheel",xtype:"codemirrortextarea",mode:"application/ld+json",border:0}}]});l.show()},system.view.showPanel=function(e){var t=$zp.application,n=$zs.views.get(e.id,{async:!1}),r="View-"+n.stub.get("id"),s=new objectum.ui.layout.ViewLayout({border:!1,record:n,bodyStyle:"background-color: "+$zu.getThemeBGColor()+";"});if(!(r in t.openPages)){var i=n.iconCls;!i&&n.stub&&n.stub.get("iconCls")&&(i=n.stub.get("iconCls")),t.openPages[r]=t.mainPanel.add({id:r,xtype:"panel",layout:"fit",node:1,iconCls:i,tabTip:null,title:n.stub.get("name"),closable:!0,bodyStyle:"background-color: "+$zu.getThemeBGColor()+";",items:[s]}),t.mainPanel.doLayout()}t.mainPanel.activate(t.openPages[r])},system.class_.create=function(e){var t=e.name,n=e.code,r=e.parent;if(3==common.extMajorVersion()){var s=$zs.classesMap;for(var i in s)if(r==s[i].stub.get("parent")&&n==s[i].stub.get("code"))throw'class with code "'+n+'" already exists';var o=new objectum.server.Class({code:n,name:t});r&&o.set("parent",r),o.commit();var a=[],l=objectum.server.Object.create(a);l.stub=o,l.storage=$zs,l.storage.registerClass(l)}else{var c=$o.createClass({name:t,code:n,parent:r?r:null});c.sync()}},system.class_attr.create=function(e){function t(e){if(3==common.extMajorVersion()){var t=new objectum.server.ClassAttr({name:e.name,code:e.code,class:e.classId,type:e.typeId});t.commit(),t.storage=$zs,$zs.classAttrs[t.get("id")]=t;var n=$zs.classAttrsMap[t.get("class")]||[];n.push(t),$zs.classAttrsMap[t.get("class")]=n}else{var r=$o.createClassAttr({name:e.name,code:e.code,class:e.classId,type:e.typeId});r.sync()}}if(e.hasOwnProperty("name"))t({name:e.name,code:e.code,classId:e.classId,typeId:e.typeId});else for(var n in e)t({name:e[n].name,code:n,classId:$zs.getClass(e[n].classCode).stub.get("id"),typeId:$zs.getClass(e[n].typeCode).stub.get("id")})},system.class_attr.get=function(e){var t=e.classId||$zs.getClass(e.classCode).stub.get("id"),n=common.execSQL({select:[{a:"___fid"},"id",{a:"___fcode"},"code",{a:"___fname"},"name",{a:"___ftype_id"},"type_id"],from:[{a:"system.class_attr"}],where:[{a:"___fend_id"},"=",system.revision.maxRevision,"and",{a:"___fclass_id"},"=",t]});return n},system.view.create=function(e){var t=e.name,n=e.code,r=e.parent;if(3==common.extMajorVersion()){var s=$zs.viewsMap;for(var i in s)if(r==s[i].stub.get("parent")&&n==s[i].stub.get("code"))throw'view with code "'+n+'" already exists';var o=new objectum.server.View({code:n,name:t});o.set("materialized",0),r&&o.set("parent",r),o.commit();var a=[],l=objectum.server.View.create(a);l.stub=o,l.storage=$zs,l.storage.registerView(l)}else{var c=$o.createView({name:t,code:n,materialized:0,parent:r?r:null});c.sync()}},system.view_attr.create=function(e){function t(e){if(3==common.extMajorVersion()){var t=new objectum.server.ViewAttr({name:e.name,code:e.code,view:e.viewId,order:e.order,area:e.area?e.area:0,width:e.width?e.width:75});t.commit(),t.storage=$zs,$zs.viewAttrs[t.get("id")]=t;var n=$zs.viewAttrsMap[e.viewId]||[];n.push(t),$zs.viewAttrsMap[e.viewId]=n}else{var r=$o.createViewAttr({name:e.name,code:e.code,view:e.viewId,order:e.order,area:e.area?e.area:0,width:e.width?e.width:75});r.sync()}}if(e.hasOwnProperty("name"))t({name:e.name,code:e.code,viewId:e.viewId,area:e.area,width:e.width});else for(var n in e)t({name:e[n].name,code:n,viewId:$zs.getView(e[n].viewCode).stub.get("id"),area:e[n].area?e[n].area:0,width:e[n].width?e[n].width:75})},system.view_attr.get=function(e){var t=e.viewId||$zs.getView(e.viewCode).stub.get("id"),n=common.execSQL({select:[{a:"___fid"},"id",{a:"___fcode"},"code",{a:"___fname"},"name",{a:"___farea"},"area"],from:[{a:"system.view_attr"}],where:[{a:"___fend_id"},"=",system.revision.maxRevision,"and",{a:"___fview_id"},"=",t]});return n},spr.conf.create=function(e){var t=this.getCurrentValue("id")||null,n=obj.create.call(this,{classCode:"spr.conf",attrs:{parent:t},refresh:!e.silence});return e.silence?n:(e.id=n,void spr.conf.show.call(this,e))},spr.conf.remove=function(){obj.remove.call(this,{id:this.getCurrentValue("id"),refresh:!0})},spr.conf.card=function(e){var t=e.id,n={card:{id:"confCard",listeners:{afterSave:function(){if(common.data.hasOwnProperty("spr.conf")){var e=$zs.getObject(t);common.data["spr.conf"][e.get("code")]={id:e.get("id"),used:e.get("used"),name:e.get("name"),value:e.get("value")}}}},fields:[{objectId:t,attr:"npp"},{objectId:t,attr:"name"},{objectId:t,attr:"code"},{objectId:t,attr:"used"},{objectId:t,attr:"value"},{objectId:t,attr:"description"},{objectId:t,attr:"parent",choose:{type:"view",id:"system.conf",attr:"olap.id",width:600,height:400}}]}};return n},spr.conf.show=function(e){common.window.show.call(this,Ext.apply(e,{title:$zr.getString("Option"),cardFn:spr.conf.card,iconCls:"gi_settings"}))},spr.conf.get=function(e){var t=common.execSQL({select:[{a:"value"},"value"],from:[{a:"spr.conf"}],where:[{a:"code"},"=",e.code]});return t.length?t.get(0,"value"):null},common.data=common.data||{},common.data["spr.conf"]={},common.loadConf=function(e){common.data["spr.conf"][e]={};for(var t=common.execSQL({select:[{a:"id"},"id",{a:"code"},"code",{a:"used"},"used",{a:"name"},"name",{a:"value"},"value",{a:"subject"},"subject"],from:[{a:"spr.conf"}],where:e?[{a:"subject"},"=",e]:[{a:"subject"},"is null"]}),n=0;n<t.length;n++)common.data["spr.conf"][e][t.get(n,"code")]={id:t.get(n,"id"),used:t.get(n,"used"),name:t.get(n,"name"),value:t.get(n,"value")}},common.getConf=function(e){var t=e.subject||null;common.data["spr.conf"][t]||common.loadConf(t);var n="string"==typeof e?e:e.code,r=common.data["spr.conf"][t][n];return null==r&&(r={}),r},common.setConf=function(e,t){if(e){var n,r=t.subject||null,s=$o.inTransaction;s||(n=$o.startTransaction({description:"setConf"}));var i,o=common.execSQL({select:[{a:"id"},"id"],from:[{a:"spr.conf"}],where:(r?[{a:"subject"},"=",r]:[{a:"subject"},"is null"]).concat("and",{a:"code"},"=",e)});i=o.length?$o.getObject(o.get(0,"id")):$o.createObject("spr.conf"),i.set("code",e);for(var a in t)i.set(a,t[a]);i.commit(),s||$o.commitTransaction(n),common.data["spr.conf"][r]?common.data["spr.conf"][r][e]={id:i.get("id"),used:i.get("used"),name:i.get("name"),value:i.get("value")}:common.loadConf(r)}},common.setVar=function(e,t){if(e){var n,r=$o.inTransaction;r||(n=$o.startTransaction({description:"setVar"}));var s,i=common.execSQL({select:[{a:"id"},"id"],from:[{a:"spr.conf"}],where:[{a:"subject"},"=",$userId?$userId:0,"and",{a:"name"},"=",e]});s=i.length?$zs.getObject(i.get(0,"id")):$zs.createObject("spr.conf"),s.set("subject",$userId?$userId:0),s.set("name",e),s.set("value",t),s.commit(),r||$o.commitTransaction(n)}},common.getVar=function(e){if(!e)return null;var t=common.execSQL({select:[{a:"value"},"value"],from:[{a:"spr.conf"}],where:[{a:"subject"},"=",$userId?$userId:0,"and",{a:"name"},"=",e]});return t.length?t.get(0,"value"):null},system.access.getObjects=function(e){e=e||{};var t,n=[];t=e.subjects?[{a:"subjectId"},"in",e.subjects]:[{a:"subjectId"},"=",e.subjectId];for(var r={select:[{a:"objectId"},"objectId",{a:"read"},"read",{a:"write"},"write"],from:[{a:"system.access"},"inner-join",{d:"system.object"},"on",[{a:"objectId"},"=",{d:"___fid"},"and",{d:"___fend_id"},"=","2147483647","and",{d:"___fclass_id"},"=",e.classId]],where:t},s=common.execSQL(r),i=0;i<s.length;i++)1==e.read&&!s.get(i,"read")||0==e.read&&s.get(i,"read")||1==e.write&&!s.get(i,"write")||0==e.write&&s.get(i,"write")||(e.comma&&n.length&&n.push(","),e.detail?n.push({id:s.get(i,"objectId"),read:s.get(i,"read"),write:s.get(i,"write")}):n.push(s.get(i,"objectId")));return n},system.xmlObj=null,system.getObjNews=function(revision){revision=revision||0,system.xmlObj||(window.XMLHttpRequest?system.xmlObj=new XMLHttpRequest:window.ActiveXObject&&(system.xmlObj=new ActiveXObject("Microsoft.XMLHTTP"))),system.xmlObj&&(system.xmlObj.open("POST","/objectum/obj_news?sessionId="+$sessionId+"&mustget="+Math.random(),!0),system.xmlObj.onreadystatechange=function(){if(4==system.xmlObj.readyState)if(401==system.xmlObj.status)common.message($o.getString("Session not authorized. Please, reload browser page"));else if(system.xmlObj.responseText){var r=eval("("+system.xmlObj.responseText+")");if("session removed"==r.header.error&&Ext.Msg.alert($ptitle,$zr.getString("Session disabled"),function(){location.reload()}),r.revision){revision=r.revision;for(var objects=r.objects,i=0;i<objects.length;i++)delete $zs.objectsMap[objects[i]],$zp.application.fireEvent("objectChanged",{id:objects[i]})}r.message&&common.balloon($zr.getString("Server message"),$zr.getString(r.message)),system.getObjNews(revision),system.objNewsFails=0}else system.objNewsFails=system.objNewsFails||0,system.objNewsFails++,setTimeout("system.getObjNews ("+revision+")",5e3)},system.xmlObj.send($zs.id+" "+revision))},Ext.ns("Ext.ux.state"),Ext.ux.state.LocalStorage=function(e){Ext.ux.state.LocalStorage.superclass.constructor.call(this),Ext.apply(this,e),this.state=localStorage},Ext.extend(Ext.ux.state.LocalStorage,Ext.state.Provider,{get:function(e,t){return"undefined"==typeof this.state[e]?t:this.decodeValue(this.state[e])},set:function(e,t){if("undefined"!=typeof t&&null!==t)this.state[e]=this.encodeValue(t),this.fireEvent("statechange",this,e,t);else try{this.clear(e)}catch(e){}}}),window.localStorage)Ext.state.Manager.setProvider(new Ext.ux.state.LocalStorage);else{var thirtyDays=new Date((new Date).getTime()+2592e6);Ext.state.Manager.setProvider(new Ext.state.CookieProvider({expires:thirtyDays}))}system.LoginPassword.create=function(){var e=$o.createObject("system.LoginPassword");e.commit(),this.refresh()},system.LoginPassword.remove=function(){var e=this.getCurrentValue("id");common.confirm({message:$zr.getString("Are you sure?"),scope:this,fn:function(t){"yes"==t&&($o.startTransaction({description:"Remove "+e}),obj.remove.call(this,{id:e,refresh:!0}),$o.commitTransaction())}})},ose.role.card=function(e){var t=e.id,n={card:{id:"ose.role.card",items:[{objectId:t,attr:"npp"},{objectId:t,attr:"name"},{objectId:t,attr:"code"},{objectId:t,attr:"menu",choose:{type:"layout",attr:"olap.a_id",layout:{olap:{id:"olap",view:"system.vo.menu"}}}}]}};return n},ose.srole.card=function(e){var t=e.id,n={card:{id:"ose.srole.card",items:[{objectId:t,attr:"role",choose:{type:"layout",attr:"olap.id",layout:{olap:{id:"olap",view:"system.ose.role"}}}},{objectId:t,attr:"subject",xtype:"numberfield"}]}};return n},ose.ext.card=function(e){var t=e.id,n={card:{id:"ose.ext.card",items:[{objectId:t,attr:"npp"},{objectId:t,attr:"classAttr"},{objectId:t,attr:"take"},{objectId:t,attr:"give"}]}};return n},ose.object.card=function(e){var t=e.id,n={card:{id:"ose.object.card",items:[{objectId:t,attr:"class"},{objectId:t,attr:"object"},{objectId:t,attr:"subject",xtype:"numberfield"},{objectId:t,attr:"read"},{objectId:t,attr:"update"},{objectId:t,attr:"delete"}]}};return n},system.vo.menu.card=function(e){var t=e.id,n={card:{id:"system.vo.menu.card",items:[{objectId:t,attr:"name"},{objectId:t,attr:"position",xtype:"combo",name:"position",width:300,triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",editable:!1,store:new Ext.data.ArrayStore({fields:["id","text"],data:[["top",""],["left",""],["bottom",""],["right",""]]}),valueField:"id",displayField:"text",style:"margin-top: 5px;"},{objectId:t,attr:"large"},{objectId:t,attr:"npp"},{objectId:t,attr:"hidden"}]}};return n},system.vo.menuItems.card=function(e){var t=e.id,n=$o.getObject(t),r={tab:{items:[{card:{id:"system.vo.menu.card",title:$o.getString("Menu item"),items:[{objectId:t,attr:"view",xtype:"numberfield",hideLabel:!0,style:"display: none"},{xtype:"$conffield",fieldLabel:$o.getString("View"),name:"view",value:n.get("view"),anchor:"-20",confRef:"view",choose:{type:"custom",fn:function(){var e=this;dialog.getView({success:function(t){e.setValue(t.id)}})}},listeners:{change:function(){if(this.up("*[objectumCmp=card]").down("*[attr=view]").setValue(this.getValue()),this.getValue()){this.up("*[objectumCmp=card]").down("*[name=action]").setValue(null);var e=$o.getView(this.getValue());this.up("*[objectumCmp=card]").down("*[attr=name]").setValue(e.get("name")),this.up("*[objectumCmp=card]").down("*[attr=iconCls]").setValue(e.get("iconCls"))}}}},{objectId:t,attr:"action",xtype:"numberfield",hideLabel:!0,style:"display: none"},{xtype:"$conffield",fieldLabel:$o.getString("Action"),name:"action",value:n.get("action"),anchor:"-20",confRef:"action",choose:{type:"custom",fn:function(){var e=this;dialog.getAction({success:function(t){e.setValue(t.id)}})}},listeners:{change:function(){if(this.up("*[objectumCmp=card]").down("*[attr=action]").setValue(this.getValue()),this.getValue()){this.up("*[objectumCmp=card]").down("*[name=view]").setValue(null);var e=$o.getAction(this.getValue());this.up("*[objectumCmp=card]").down("*[attr=name]").setValue(e.get("name"))}}}},{objectId:t,attr:"name"},{objectId:t,attr:"description"},{objectId:t,attr:"iconCls",xtype:"$iconselector"},{objectId:t,attr:"npp"},{objectId:t,attr:"hidden"}]}},{olap:{id:"olapMenuItems",title:$o.getString("Child menu items"),view:"system.vo.menuItems",actions:[{fn:"common.tpl.show",text:$o.getString("Open"),arguments:{asWindow:1,card:"system.vo.menuItems.card"},iconCls:"gi_edit",active:"common.recordSelected"},{fn:"common.tpl.create",text:$o.getString("Add"),arguments:{asWindow:1,classCode:"system.vo.menuItems",attrs:{parent:t}},iconCls:"gi_circle_plus"},{fn:"common.tpl.remove",text:$o.getString("Remove"),iconCls:"gi_circle_minus",active:"common.recordSelected"}],listeners:{cellRenderer:"system.vo.menuItems.cellRenderer",dblclick:{fn:"common.tpl.show",arguments:{asWindow:1,card:"system.vo.menuItems.card"}}},filter:["a_parent","=",t]}}]}};return r},system.vo.menu.cellRenderer=function(e,t,n,r,s,i){if(n.get("a_position")&&"a_position"==t.column.dataIndex)switch(n.get("a_position")){case"top":e=$o.getString("Top");break;case"left":e=$o.getString("Left");break;case"bottom":e=$o.getString("Bottom");break;case"right":e=$o.getString("Right")}return e},system.vo.menuItems.cellRenderer=function(e,t,n,r,s,i){return n.get("a_view")&&"a_view"==t.column.dataIndex&&(e=$o.getView(n.get("a_view")).toString()),n.get("action")&&"action"==t.column.dataIndex&&(e=$o.getAction(n.get("action")).toString()),e},subject.human.create=function(e){common.tpl.create.call(this,Ext.apply(e,{asWindow:1,classCode:"subject.human"}))},subject.human.card=function(e){var t=e.id,n=common.execSQL({select:[{a:"id"},"id",{a:"role"},"role"],from:[{a:"ose.srole"}],where:[{a:"subject"},"=",t]}),r=null;n.length&&(r=n.get(0,"role"));var s={card:{id:"subject.human.card",listeners:{afterSave:function(){r=this.down("*[name=role]").getValue();var e;n.length?e=$o.getObject(n.get(0,"id")):(e=$o.createObject("ose.srole"),e.set("subject",t)),e.set("role",r),e.sync()}},items:[{objectId:t,attr:"surname"},{objectId:t,attr:"forename"},{objectId:t,attr:"patronymic"},{objectId:t,attr:"birthday",timefield:0},{objectId:t,attr:"login"},{objectId:t,attr:"password"},{xtype:"$objectfield",name:"role",fieldLabel:"",value:r,anchor:"-20",choose:{type:"layout",attr:"olap.id",layout:{olap:{id:"olap",view:"system.ose.role"}}}}]}};return s},system.vo.chooseAdminMenu=function(){var e=Ext.create("Ext.Window",{width:400,height:100,layout:"form",frame:!1,border:!1,style:"background-color: #ffffff",bodyStyle:"background-color: #ffffff",title:$o.getString("Admin menu"),iconCls:"gi_list",bodyPadding:5,modal:1,tbar:[{text:"",iconCls:"gi_ok",handler:function(){common.setConf("adminMenu",{name:$o.getString("Admin menu"),value:e.down("*[name=menu]").getValue()}),e.close()}},{text:$o.getString("Cancel"),iconCls:"gi_remove",handler:function(){e.close()}}],items:{xtype:"$objectfield",name:"menu",fieldLabel:$o.getString("Menu"),value:common.getConf("adminMenu").value,choose:{type:"layout",attr:"olap.a_id",layout:{olap:{id:"olap",view:"system.vo.menu"}}}}});e.show()},system.vo.buildMenu=function(){function e(t,n){for(var r=[],s=0;s<i.length;s++)if(n==i.get(s,"parent")){try{$o.getView(i.get(s,"view"))}catch(e){console.log(i.get(s,"id"))}var o={text:i.get(s,"name"),iconCls:i.get(s,"iconCls"),viewRecord:$o.getView(i.get(s,"view")),viewReadOnly:i.get(s,"readOnly"),actionRecord:$o.getAction(i.get(s,"action")),handler:function(){this.viewRecord?$o.app.show.call($o.app,{record:this.viewRecord,readOnly:this.viewReadOnly}):this.actionRecord&&this.actionRecord.execute({readOnly:this.viewReadOnly})}};e(o,i.get(s,"id")),r.push(o)}r.length&&(t.menu={items:r})}var t;if("admin"==$o.currentUser)t=common.getConf("adminMenu").value;else if("autologin"==$o.currentUser)t=common.getConf("autologinMenu").value;else{var n=$o.getObject($o.userId);t="subject.human.vo_adm"==$o.getClass(n.get("classId")).getFullCode()?common.getConf("adminMenu").value:$o.menuId}if(!t){if(!n.get("voRole"))return common.message($o.getString("User has no role"));
var r=$o.getObject(n.get("voRole"));if(!r||!r.get("menu"))return common.message($o.getString("User has no role"));t=r.get("menu")}for(var s=common.execSQL({select:[{a:"id"},"id",{a:"position"},"position",{a:"large"},"large"],from:[{a:"system.vo.menu"}],where:[[{a:"hidden"},"is null","or",{a:"hidden"},"=",0],"and",{a:"id"},"=",t],order:[{a:"npp"},",",{a:"name"}]}),i=common.execSQL({select:[{a:"id"},"id",{a:"menu"},"menu",{a:"name"},"name",{a:"iconCls"},"iconCls",{a:"parent"},"parent",{a:"view"},"view",{a:"action"},"action",{a:"readOnly"},"readOnly"],from:[{a:"system.vo.menuItems"}],where:[{a:"hidden"},"is null","or",{a:"hidden"},"=",0],order:[{a:"npp"},",",{a:"name"}]}),o=[],a=0;a<i.length;a++)if(i.get(a,"menu")==t&&!i.get(a,"parent")){var l=i.get(a,"iconCls");l&&s.get(0,"large")&&(l="gib"+l.substr(2));var c={id:i.get(a,"id"),text:i.get(a,"name"),iconCls:l,viewRecord:$o.getView(i.get(a,"view")),viewReadOnly:i.get(a,"readOnly"),actionRecord:$o.getAction(i.get(a,"action")),handler:function(){this.viewRecord?$o.app.show.call($o.app,{record:this.viewRecord,readOnly:this.viewReadOnly}):this.actionRecord&&this.actionRecord.execute({readOnly:this.viewReadOnly})}};s.get(0,"large")&&(c.iconAlign="top",c.scale="large","left"!=s.get(0,"position")&&"right"!=s.get(0,"position")||(c.arrowAlign="bottom",c.menuAlign="tr",c.arrowCls="arrow-right-white")),o.push(c)}for(var d=0;d<o.length;d++)e(o[d],o[d].id);var c={text:$o.getString("Exit"),iconCls:"gi_exit",handler:function(){if($o.userId){$o.startTransaction();var e=$o.getObject($o.userId);e.set("lastLogout",new Date),e.sync(),$o.commitTransaction()}$o.logout({success:function(){location.reload()}})}};if(s.get(0,"large")&&(c.iconCls="gib_exit",c.iconAlign="top",c.scale="large"),o.push(c),$o.visualObjectum.timeMachine&&$o.visualObjectum.timeMachine.showDates){var u=new Date;$o.visualObjectum.timeMachine.dates=$o.visualObjectum.timeMachine.dates||[];for(var a=0;a<$o.visualObjectum.timeMachine.dates.length;a++){var f=$o.visualObjectum.timeMachine.dates[a].date;f.getTime()<u.getTime()&&(u=f)}o.push({xtype:"displayfield",value:$o.getString("System date")+":"},{xtype:"datefield",minValue:u,maxValue:new Date,value:new Date,width:100,listeners:{render:function(){Ext.tip.QuickTipManager.register({target:this.id,text:$o.getString("View data in last dates"),width:200,dismissDelay:3e3})},change:function(e,t){var n,r=common.getJulianDay(t),s=common.getJulianDay(new Date);if(r==s)$o.setRevision();else{for(var i=$o.visualObjectum.timeMachine.dates.length-1;i>=0;i--){var o=common.getJulianDay($o.visualObjectum.timeMachine.dates[i].date);o<=r&&(n=$o.visualObjectum.timeMachine.dates[i].id)}$o.setRevision(n)}}}})}switch(s.get(0,"position")){case"top":$o.app.tb.add(o),$o.app.tb.doLayout();break;case"left":$o.app.lb.add(o),$o.app.lb.doLayout();break;case"right":$o.app.rb.add(o),$o.app.rb.doLayout();break;case"bottom":$o.app.bb.add(o),$o.app.bb.doLayout()}},Ext.override(Ext.menu.Menu,{onMouseLeave:function(e){var t=this,n=!1;t.items.each(function(e){e.menu&&e.menu.isVisible()&&(n=!0)}),n||(t.deactivateActiveItem(),t.disabled||t.fireEvent("mouseleave",t,e))}}),Ext.define("ImportCSVObjects.Widget",{extend:"Ext.panel.Panel",alias:["widget.importcsvobjects"],border:!1,layout:"fit",defaults:{border:!1},bodyPadding:2,classId:null,initComponent:function(){var e=this;e.oCls=$o.getClass(e.classId),e.attrs=_.map(e.oCls.attrs,function(e){return e.set("fullName",e.get("name")+" ("+e.get("code")+")"),e});var t=new Ext.Panel({bodyStyle:"background-color: white; padding: 5px;",border:!1,html:'<input type="file" id="selectedFile">'});e.tbar=[{xtype:"combo",fieldLabel:$o.getString("Encoding"),labelWidth:65,width:150,name:"coding",triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",store:{type:"json",fields:["id","name"],data:[{id:"utf8",name:"utf-8"},{id:"win1251",name:"win-1251"}]},valueField:"id",displayField:"name",value:"utf8",editable:!1},t,{text:$o.getString("Load"),iconCls:"gi_table",name:"load",disabled:!0,handler:function(){var t=Ext.getDom("selectedFile"),n=t.files[0],r=new FileReader;r.onload=function(){var t=r.result.split("\n");e.data=[],e.fields=[],_.each(t,function(t,n){var r=t.split(";"),s={};_.each(r,function(t,r){var t=null==t?"":t.trim();n?s["attr-"+r]=t:e.fields.push({name:t,code:"attr-"+r})}),n&&r.length&&""!=r[0]&&e.data.push(s)}),e.fields.length&&!e.fields[e.fields.length-1].name&&e.fields.splice(e.fields.length-1,1);var n=e.down("*[name=grid]");n.reconfigure({xtype:"store",fields:_.map(e.fields,function(e){return e.code}),data:e.data},_.map(e.fields,function(e){return{text:e.name,dataIndex:e.code,width:90}})),n.getStore().loadData(e.data),e.down("*[name=recNum]").setValue(e.data.length);var s=_.map(e.fields,function(t){var n;_.each(e.attrs,function(e){e.get("name")==t.name&&(n=e.get("code"))});var r={xtype:"combo",fieldLabel:t.name,name:t.code,triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",store:{type:"json",fields:["id","name"],data:_.map(e.attrs,function(e){return{id:e.get("code"),name:e.get("fullName")}})},valueField:"id",displayField:"name",editable:!1,value:n,width:"100%"};return r});e.down("*[name=map]").removeAll(),e.down("*[name=map]").add(s),e.down("*[name=import]").setDisabled(!1)},r.readAsText(n,"utf8"==e.down("*[name=coding]").getValue()?"utf-8":"windows-1251")}},{text:$o.getString("Import"),iconCls:"gi_file_import",name:"import",disabled:!0,handler:function(){e.importer?e.importer(e.data):(Ext.MessageBox.show({title:$o.getString("Please wait"),msg:$o.getString("Action in progress")+" ...",progressText:"",width:300,progress:1,closable:0}),setTimeout(function(){$o.startTransaction();var t={};_.each(e.fields,function(n){var r=e.down("*[name="+n.code+"]");t[n.code]=r.getValue()});var n=[],r=e.down("*[name=idAttr]").getValue();r&&(n=$o.execute({asArray:!0,select:[{a:"id"},"id",{a:r},r],from:[{a:e.oCls.getFullCode()}]}));var s={};_.each(n,function(e){s[e[r]]=e.id}),async.reduce(e.data,0,function(n,i,o){var a={};_.each(i,function(e,n){a[t[n]]=e});var l;(!r||r&&a[r])&&(l=r&&s[a[r]]?$o.getObject(s[a[r]]):$o.createObject(e.classId),_.each(a,function(e,t){l.set(t,e)}),l.sync()),Ext.MessageBox.updateProgress(n/e.data.length,n+" / "+e.data.length),setTimeout(function(){o(null,n+1)},1)},function(t){$o.commitTransaction(),Ext.MessageBox.hide(),e.fireEvent("imported")})},100))}}],e.items={xtype:"tabpanel",items:[{title:$o.getString("Field mapping"),layout:"vbox",name:"map",bodyPadding:5,tbar:[{xtype:"textfield",fieldLabel:$o.getString("Class"),labelWidth:50,width:400,disabled:!0,value:e.oCls.toString()},{xtype:"combo",fieldLabel:$o.getString("Identifier"),name:"idAttr",triggerAction:"all",lazyRender:!0,mode:"local",queryMode:"local",store:{type:"json",fields:["id","name"],data:_.map(e.attrs,function(e){return{id:e.get("code"),name:e.get("fullName")}})},width:300,style:"margin-left: 5px",valueField:"id",displayField:"name",editable:!1}],items:[]},{title:"CSV",xtype:"grid",name:"grid",tbar:[{xtype:"textfield",disabled:!0,name:"recNum",fieldLabel:$o.getString("Amount")}],store:{xtype:"store",fields:["name"],data:[]},columns:[{text:$o.getString("Name"),dataIndex:"name",width:90}],width:"100%",columnLines:!0,rowLines:!0}]},e.on("afterrender",function(){Ext.get("selectedFile").on("change",function(t){e.down("*[name=load]").setDisabled(!1)},this)}),e.addEvents("imported"),e.callParent(arguments)}}),Ext.define("Ext.ux.GroupTabRenderer",{alias:"plugin.grouptabrenderer",extend:"Ext.AbstractPlugin",tableTpl:new Ext.XTemplate('<div id="{view.id}-body" class="'+Ext.baseCSSPrefix+"{view.id}-table "+Ext.baseCSSPrefix+'grid-table-resizer" style="{tableStyle}">',"{%","values.view.renderRows(values.rows, values.viewStartIndex, out);","%}","</div>",{priority:5}),rowTpl:new Ext.XTemplate("{%",'Ext.Array.remove(values.itemClasses, "',Ext.baseCSSPrefix+'grid-row");','var dataRowCls = values.recordIndex === -1 ? "" : " '+Ext.baseCSSPrefix+'grid-data-row";',"%}",'<div {[values.rowId ? ("id=\\"" + values.rowId + "\\"") : ""]} ','data-boundView="{view.id}" ','data-recordId="{record.internalId}" ','data-recordIndex="{recordIndex}" ','class="'+Ext.baseCSSPrefix+'grouptab-row {[values.itemClasses.join(" ")]} {[values.rowClasses.join(" ")]}{[dataRowCls]}" ',"{rowAttr:attributes}>",'<tpl for="columns">{%',"parent.view.renderCell(values, parent.record, parent.recordIndex, xindex - 1, out, parent)","%}","</tpl>","</div>",{priority:5}),cellTpl:new Ext.XTemplate('{%values.tdCls = values.tdCls.replace(" '+Ext.baseCSSPrefix+'grid-cell "," ");%}','<div class="'+Ext.baseCSSPrefix+'grouptab-cell {tdCls}" {tdAttr}>','<div {unselectableAttr} class="'+Ext.baseCSSPrefix+'grid-cell-inner" style="text-align: {align}; {style};">{value}</div>','<div class="x-grouptabs-corner x-grouptabs-corner-top-left"></div>','<div class="x-grouptabs-corner x-grouptabs-corner-bottom-left"></div>',"</div>",{priority:5}),selectors:{bodySelector:"div."+Ext.baseCSSPrefix+"grid-table-resizer",nodeContainerSelector:"div."+Ext.baseCSSPrefix+"grid-table-resizer",itemSelector:"div."+Ext.baseCSSPrefix+"grouptab-row",dataRowSelector:"div."+Ext.baseCSSPrefix+"grouptab-row",cellSelector:"div."+Ext.baseCSSPrefix+"grouptab-cell",getCellSelector:function(e){var t="div."+Ext.baseCSSPrefix+"grid-cell";return e&&(t+="-"+e.getItemId()),t}},init:function(e){var t=e.getView(),n=this;t.addTableTpl(n.tableTpl),t.addRowTpl(n.rowTpl),t.addCellTpl(n.cellTpl),Ext.apply(t,n.selectors)}}),Ext.define("Ext.ux.GroupTabPanel",{extend:"Ext.Container",alias:"widget.grouptabpanel",requires:["Ext.tree.Panel","Ext.ux.GroupTabRenderer"],baseCls:Ext.baseCSSPrefix+"grouptabpanel",initComponent:function(e){var t=this;Ext.apply(t,e),t.store=t.createTreeStore(),t.layout={type:"hbox",align:"stretch"},t.defaults={border:!1},t.items=[{xtype:"treepanel",cls:"x-tree-panel x-grouptabbar",width:150,rootVisible:!1,store:t.store,hideHeaders:!0,animate:!1,processEvent:Ext.emptyFn,border:!1,plugins:[{ptype:"grouptabrenderer"}],viewConfig:{overItemCls:"",getRowClass:t.getRowClass},columns:[{xtype:"treecolumn",sortable:!1,dataIndex:"text",flex:1,renderer:function(e,t,n,r,s,i,o){var a="";return n.parentNode&&null===n.parentNode.parentNode?(a+=" x-grouptab-first",n.previousSibling&&(a+=" x-grouptab-prev"),n.get("expanded")&&null!=n.firstChild||(a+=" x-grouptab-last")):a+=null===n.nextSibling?" x-grouptab-last":" x-grouptab-center",n.data.activeTab&&(a+=" x-active-tab"),t.tdCls="x-grouptab"+a,e}}]},{xtype:"container",flex:1,layout:"card",activeItem:t.mainItem,baseCls:Ext.baseCSSPrefix+"grouptabcontainer",items:t.cards}],t.addEvents("beforetabchange","tabchange","beforegroupchange","groupchange"),t.callParent(arguments),t.setActiveTab(t.activeTab),t.setActiveGroup(t.activeGroup),t.mon(t.down("treepanel").getSelectionModel(),"select",t.onNodeSelect,t)},getRowClass:function(e,t,n,r){var s="";return e.data.activeGroup&&(s+=" x-active-group"),s},onNodeSelect:function(e,t){var n,r=this,s=r.store.getRootNode();if(n=t.parentNode&&null===t.parentNode.parentNode?t:t.parentNode,r.setActiveGroup(n.get("id"))===!1||r.setActiveTab(t.get("id"))===!1)return!1;for(;s;)s.set("activeTab",!1),s.set("activeGroup",!1),s=s.firstChild||s.nextSibling||s.parentNode.nextSibling;n.set("activeGroup",!0),n.eachChild(function(e){e.set("activeGroup",!0)}),t.set("activeTab",!0),e.view.refresh()},setActiveTab:function(e){var t,n=this,r=e;return Ext.isString(e)&&(r=Ext.getCmp(r)),r!==n.activeTab&&(t=n.activeTab,n.fireEvent("beforetabchange",n,r,t)!==!1&&(n.activeTab=r,n.rendered&&n.down("container[baseCls="+Ext.baseCSSPrefix+"grouptabcontainer]").getLayout().setActiveItem(r),n.fireEvent("tabchange",n,r,t)),!0)},setActiveGroup:function(e){var t,n=this,r=e;return Ext.isString(e)&&(r=Ext.getCmp(r)),r===n.activeGroup||(t=n.activeGroup,n.fireEvent("beforegroupchange",n,r,t)!==!1&&(n.activeGroup=r,n.fireEvent("groupchange",n,r,t),!0))},createTreeStore:function(){var e=this,t=e.prepareItems(e.items),n={text:".",children:[]},r=e.cards=[];return e.activeGroup=e.activeGroup||0,Ext.each(t,function(t,s){var i=t.items.items,o=i[t.mainItem]||i[0],a={children:[]};a.id=o.id,a.text=o.title,a.iconCls=o.iconCls,a.expanded=!0,a.activeGroup=e.activeGroup===s,a.activeTab=!!a.activeGroup,a.activeTab&&(e.activeTab=a.id),a.activeGroup&&(e.mainItem=t.mainItem||0,e.activeGroup=a.id),Ext.each(i,function(e){if(e.id!==a.id){var t={id:e.id,leaf:!0,text:e.title,iconCls:e.iconCls,activeGroup:a.activeGroup,activeTab:!1};a.children.push(t)}delete e.title,delete e.iconCls,r.push(e)}),n.children.push(a)}),Ext.create("Ext.data.TreeStore",{fields:["id","text","activeGroup","activeTab"],root:{expanded:!0},proxy:{type:"memory",data:n}})},getActiveTab:function(){return this.activeTab},getActiveGroup:function(){return this.activeGroup}}),Ext.define("Ext.ux.form.MultiSelect",{extend:"Ext.form.FieldContainer",mixins:{bindable:"Ext.util.Bindable",field:"Ext.form.field.Field"},alternateClassName:"Ext.ux.Multiselect",alias:["widget.multiselectfield","widget.multiselect"],requires:["Ext.panel.Panel","Ext.view.BoundList","Ext.layout.container.Fit"],uses:["Ext.view.DragZone","Ext.view.DropZone"],layout:"anchor",ddReorder:!1,appendOnly:!1,displayField:"text",allowBlank:!0,minSelections:0,maxSelections:Number.MAX_VALUE,blankText:"This field is required",minSelectionsText:"Minimum {0} item(s) required",maxSelectionsText:"Maximum {0} item(s) required",delimiter:",",dragText:"{0} Item{1}",ignoreSelectChange:0,initComponent:function(){var e=this;e.bindStore(e.store,!0),e.store.autoCreated&&(e.valueField=e.displayField="field1",e.store.expanded||(e.displayField="field2")),Ext.isDefined(e.valueField)||(e.valueField=e.displayField),e.items=e.setupItems(),e.callParent(),e.initField(),e.addEvents("drop")},setupItems:function(){var e=this;return e.boundList=Ext.create("Ext.view.BoundList",Ext.apply({anchor:"none 100%",deferInitialRefresh:!1,border:1,multiSelect:!0,store:e.store,displayField:e.displayField,disabled:e.disabled},e.listConfig)),e.boundList.getSelectionModel().on("selectionchange",e.onSelectChange,e),e.title?(e.boundList.border=!1,{border:!0,anchor:"none 100%",layout:"anchor",title:e.title,tbar:e.tbar,items:e.boundList}):e.boundList},onSelectChange:function(e,t){this.ignoreSelectChange||this.setValue(t)},getSelected:function(){return this.boundList.getSelectionModel().getSelection()},isEqual:function(e,t){var n,r=Ext.Array.from,s=0;if(e=r(e),t=r(t),n=e.length,n!==t.length)return!1;for(;s<n;s++)if(t[s]!==e[s])return!1;return!0},afterRender:function(){var e,t=this;t.callParent(),t.selectOnRender&&(e=t.getRecordsForValue(t.value),e.length&&(++t.ignoreSelectChange,t.boundList.getSelectionModel().select(e),--t.ignoreSelectChange),delete t.toSelect),!t.ddReorder||t.dragGroup||t.dropGroup||(t.dragGroup=t.dropGroup="MultiselectDD-"+Ext.id()),(t.draggable||t.dragGroup)&&(t.dragZone=Ext.create("Ext.view.DragZone",{view:t.boundList,ddGroup:t.dragGroup,dragText:t.dragText})),(t.droppable||t.dropGroup)&&(t.dropZone=Ext.create("Ext.view.DropZone",{view:t.boundList,ddGroup:t.dropGroup,handleNodeDrop:function(e,n,r){var s,i=this.view,o=i.getStore(),a=e.records;e.view.store.remove(a),s=o.indexOf(n),"after"===r&&s++,o.insert(s,a),i.getSelectionModel().select(a),t.fireEvent("drop",t,a)}}))},isValid:function(){var e=this,t=e.disabled,n=e.forceValidation||!t;return n?e.validateValue(e.value):t},validateValue:function(e){var t=this,n=t.getErrors(e),r=Ext.isEmpty(n);return t.preventMark||(r?t.clearInvalid():t.markInvalid(n)),r},markInvalid:function(e){var t=this,n=t.getActiveError();t.setActiveErrors(Ext.Array.from(e)),n!==t.getActiveError()&&t.updateLayout()},clearInvalid:function(){var e=this,t=e.hasActiveError();e.unsetActiveError(),t&&e.updateLayout()},getSubmitData:function(){var e,t=this,n=null;return t.disabled||!t.submitValue||t.isFileUpload()||(e=t.getSubmitValue(),null!==e&&(n={},n[t.getName()]=e)),n},getSubmitValue:function(){var e=this,t=e.delimiter,n=e.getValue();return Ext.isString(t)?n.join(t):n},getValue:function(){return this.value||[]},getRecordsForValue:function(e){var t,n,r,s=this,i=[],o=s.store.getRange(),a=s.valueField,l=0,c=o.length;for(r=e.length;l<r;++l)for(n=0;n<c;++n)t=o[n],t.get(a)==e[l]&&i.push(t);return i},setupValue:function(e){var t,n,r,s=this.delimiter,i=this.valueField,o=0;if(Ext.isDefined(e)){for(s&&Ext.isString(e)?e=e.split(s):Ext.isArray(e)||(e=[e]),n=e.length;o<n;++o)r=e[o],r&&r.isModel&&(e[o]=r.get(i));t=Ext.Array.unique(e)}else t=[];return t},setValue:function(e){var t=this,n=t.boundList.getSelectionModel(),r=t.store;return r.getCount()?(e=t.setupValue(e),t.mixins.field.setValue.call(t,e),void(t.rendered?(++t.ignoreSelectChange,n.deselectAll(),n.select(t.getRecordsForValue(e)),--t.ignoreSelectChange):t.selectOnRender=!0)):void r.on({load:Ext.Function.bind(t.setValue,t,[e]),single:!0})},clearValue:function(){this.setValue([])},onEnable:function(){var e=this.boundList;this.callParent(),e&&e.enable()},onDisable:function(){var e=this.boundList;this.callParent(),e&&e.disable()},getErrors:function(e){var t,n=this,r=Ext.String.format,s=[];return e=Ext.Array.from(e||n.getValue()),t=e.length,!n.allowBlank&&t<1&&s.push(n.blankText),t<n.minSelections&&s.push(r(n.minSelectionsText,n.minSelections)),t>n.maxSelections&&s.push(r(n.maxSelectionsText,n.maxSelections)),s},onDestroy:function(){var e=this;e.bindStore(null),Ext.destroy(e.dragZone,e.dropZone),e.callParent()},onBindStore:function(e){var t=this.boundList;t&&t.bindStore(e)}}),Ext.define("Ext.ux.grid.FiltersFeature",{extend:"Ext.grid.feature.Feature",alias:"feature.filters",uses:["Ext.ux.grid.menu.ListMenu","Ext.ux.grid.menu.RangeMenu","Ext.ux.grid.filter.BooleanFilter","Ext.ux.grid.filter.DateFilter","Ext.ux.grid.filter.DateTimeFilter","Ext.ux.grid.filter.ListFilter","Ext.ux.grid.filter.NumericFilter","Ext.ux.grid.filter.StringFilter"],autoReload:!0,filterCls:"ux-filtered-column",local:!1,menuFilterText:"Filters",paramPrefix:"filter",showMenu:!0,stateId:void 0,updateBuffer:500,hasFeatureEvent:!1,constructor:function(e){var t=this;t.callParent(arguments),t.deferredUpdate=Ext.create("Ext.util.DelayedTask",t.reload,t),t.filters=t.createFiltersCollection(),t.filterConfigs=e.filters},init:function(e){var t=this,n=t.view,r=n.headerCt;t.bindStore(n.getStore(),!0),r.on("menucreate",t.onMenuCreate,t),n.on("refresh",t.onRefresh,t),e.on({scope:t,beforestaterestore:t.applyState,beforestatesave:t.saveState,beforedestroy:t.destroy}),e.filters=t,e.addEvents("filterupdate")},createFiltersCollection:function(){return Ext.create("Ext.util.MixedCollection",!1,function(e){return e?e.dataIndex:null})},createFilters:function(){function e(e,r,s){e&&(s||r)&&(t=c.get(e),n={dataIndex:e,type:t&&t.type&&t.type.type||"auto"},Ext.isObject(r)&&Ext.apply(n,r),a.replace(n))}var t,n,r,s=this,i=s.filters.getCount(),o=s.getGridPanel(),a=s.createFiltersCollection(),l=o.store.model,c=l.prototype.fields;i&&(r={},s.saveState(null,r)),Ext.Array.each(s.filterConfigs,function(t){e(t.dataIndex,t)}),Ext.Array.each(o.columnManager.getColumns(),function(t){t.filterable===!1?a.removeAtKey(t.dataIndex):e(t.dataIndex,t.filter,t.filterable)}),s.removeAll(),a.items&&s.initializeFilters(a.items),i&&s.applyState(null,r)},initializeFilters:function(e){var t,n,r,s=this,i=e.length;for(t=0;t<i;t++)n=e[t],n&&(r=s.getFilterClass(n.type),n=n.menu?n:new r(Ext.apply({grid:s.grid},n)),s.filters.add(n),Ext.util.Observable.capture(n,this.onStateChange,this))},onMenuCreate:function(e,t){var n=this;n.createFilters(),t.on("beforeshow",n.onMenuBeforeShow,n)},onMenuBeforeShow:function(e){var t,n,r=this;r.showMenu&&(t=r.menuItem,t&&!t.isDestroyed||(r.createMenuItem(e),t=r.menuItem),n=r.getMenuFilter(),n&&(t.setMenu(n.menu,!1),t.setChecked(n.active),t.setDisabled(n.disabled===!0)),t.setVisible(!!n),this.sep.setVisible(!!n))},createMenuItem:function(e){var t=this;t.sep=e.add("-"),t.menuItem=e.add({checked:!1,itemId:"filters",text:t.menuFilterText,listeners:{scope:t,checkchange:t.onCheckChange,beforecheckchange:t.onBeforeCheck}})},getGridPanel:function(){return this.view.up("gridpanel")},applyState:function(e,t){var n,r,s=this;if(s.applyingState=!0,s.clearFilters(),t.filters)for(n in t.filters)t.filters.hasOwnProperty(n)&&(r=s.filters.get(n),r&&(r.setValue(t.filters[n]),r.setActive(!0)));s.deferredUpdate.cancel(),s.local&&s.reload(),delete s.applyingState,delete t.filters},saveState:function(e,t){var n={};return this.filters.each(function(e){e.active&&(n[e.dataIndex]=e.getValue())}),t.filters=n},destroy:function(){var e=this;Ext.destroyMembers(e,"menuItem","sep"),e.removeAll(),e.clearListeners()},removeAll:function(){this.filters&&(Ext.destroy.apply(Ext,this.filters.items),this.filters.clear())},bindStore:function(e){var t=this;t.store&&t.storeListeners&&t.store.un(t.storeListeners),e?(t.storeListeners={scope:t},t.local?t.storeListeners.load=t.onLoad:t.storeListeners["before"+(e.buffered?"prefetch":"load")]=t.onBeforeLoad,e.on(t.storeListeners)):delete t.storeListeners,t.store=e},getMenuFilter:function(){var e=this.view.headerCt.getMenu().activeHeader;return e?this.filters.get(e.dataIndex):null},onCheckChange:function(e,t){this.getMenuFilter().setActive(t)},onBeforeCheck:function(e,t){return!t||this.getMenuFilter().isActivatable()},onStateChange:function(e,t){if("serialize"!==e){var n=this,r=n.getGridPanel();t==n.getMenuFilter()&&n.menuItem.setChecked(t.active,!1),!n.autoReload&&!n.local||n.applyingState||n.deferredUpdate.delay(n.updateBuffer),n.updateColumnHeadings(),n.applyingState||r.saveState(),r.fireEvent("filterupdate",n,t)}},onBeforeLoad:function(e,t){t.params=t.params||{},this.cleanParams(t.params);var n=this.buildQuery(this.getFilterData());Ext.apply(t.params,n)},onLoad:function(e){e.filterBy(this.getRecordFilter())},onRefresh:function(){this.updateColumnHeadings()},updateColumnHeadings:function(){var e=this,t=e.view.headerCt;t&&t.items.each(function(t){var n=e.getFilter(t.dataIndex);t[n&&n.active?"addCls":"removeCls"](e.filterCls)})},reload:function(){var e=this,t=e.view.getStore();e.local?(t.clearFilter(!0),t.filterBy(e.getRecordFilter()),t.sort()):(e.deferredUpdate.cancel(),t.buffered&&t.data.clear(),t.loadPage(1))},getRecordFilter:function(){var e,t,n=[],r=this.lockingPartner;return this.filters.each(function(e){e.active&&n.push(e)}),r&&r.filters.each(function(e){e.active&&n.push(e)}),e=n.length,function(r){for(t=0;t<e;t++)if(!n[t].validateRecord(r))return!1;return!0}},addFilter:function(e){var t,n,r,s,i,o=this,a=o.getGridPanel().columnManager.getColumns();for(t=0,n=a.length;t<n;t++)r=a[t],r.dataIndex===e.dataIndex&&(r.filter=e);for(o.view.headerCt.menu?o.createFilters():o.view.headerCt.getMenu(),t=0,s=o.filters.items.length;t<s;t++)if(i=o.filters.items[t],i.dataIndex===e.dataIndex)return i},addFilters:function(e){if(e){var t,n,r=this;for(t=0,n=e.length;t<n;t++)r.addFilter(e[t])}},getFilter:function(e){return this.filters.get(e)},clearFilters:function(){this.filters.each(function(e){e.setActive(!1)})},getFilterItems:function(){var e=this;return e.lockingPartner?e.filters.items.concat(e.lockingPartner.filters.items):e.filters.items},getFilterData:function(){var e,t,n,r,s,i,o=this.getFilterItems(),a=[];for(e=0,t=o.length;e<t;e++)if(n=o[e],n.active)for(r=[].concat(n.serialize()),s=0,i=r.length;s<i;s++)a.push({field:n.dataIndex,data:r[s]});return a},buildQuery:function(e){var t,n,r,s,i,o,a={},l=e.length;if(this.encode){for(o=[],t=0;t<l;t++)n=e[t],o.push(Ext.apply({},{field:n.field},n.data));o.length>0&&(a[this.paramPrefix]=Ext.JSON.encode(o))}else for(t=0;t<l;t++){n=e[t],r=[this.paramPrefix,"[",t,"]"].join(""),a[r+"[field]"]=n.field,s=r+"[data]";for(i in n.data)a[[s,"[",i,"]"].join("")]=n.data[i]}return a},cleanParams:function(e){if(this.encode)delete e[this.paramPrefix];else{var t,n;t=new RegExp("^"+this.paramPrefix+"[[0-9]+]");for(n in e)t.test(n)&&delete e[n]}},getFilterClass:function(e){switch(e){case"auto":e="string";break;case"int":case"float":e="numeric";break;case"bool":e="boolean"}return Ext.ClassManager.getByAlias("gridfilter."+e)}}),Ext.define("Ext.ux.grid.filter.Filter",{extend:"Ext.util.Observable",active:!1,dataIndex:null,menu:null,updateBuffer:500,constructor:function(e){Ext.apply(this,e),this.addEvents("activate","deactivate","serialize","update"),Ext.ux.grid.filter.Filter.superclass.constructor.call(this),this.menu=this.createMenu(e),this.init(e),e&&e.value&&(this.setValue(e.value),this.setActive(e.active!==!1,!0),delete e.value)},destroy:function(){this.menu&&this.menu.destroy(),this.clearListeners()},init:Ext.emptyFn,createMenu:function(e){return e.plain=!0,Ext.create("Ext.menu.Menu",e)},getValue:Ext.emptyFn,setValue:Ext.emptyFn,isActivatable:function(){return!0},getSerialArgs:Ext.emptyFn,validateRecord:function(){return!0},serialize:function(){var e=this.getSerialArgs();return this.fireEvent("serialize",e,this),e},fireUpdate:function(){this.active&&this.fireEvent("update",this),this.setActive(this.isActivatable())},setActive:function(e,t){this.active!=e&&(this.active=e,t!==!0&&this.fireEvent(e?"activate":"deactivate",this))}}),Ext.define("Ext.ux.grid.filter.DateFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.date",uses:["Ext.picker.Date","Ext.menu.Menu"],afterText:"After",afterEqText:"After equal",beforeText:"Before",beforeEqText:"Before equal",compareMap:{beforeEq:"lte",before:"lt",afterEq:"gte",after:"gt",non:"neq",on:"eq"},dateFormat:"m/d/Y",menuItems:["beforeEq","before","afterEq","after","-","non","on"],menuItemCfgs:{selectOnFocus:!0,width:125},onText:"On",nonText:"NOn",pickerOpts:{},init:function(e){var t,n,r,s,i,o=this;for(t=Ext.apply(o.pickerOpts,{xtype:"datepicker",minDate:o.minDate,maxDate:o.maxDate,format:o.dateFormat,listeners:{scope:o,select:o.onMenuSelect}}),o.fields={},n=0,r=o.menuItems.length;n<r;n++)s=o.menuItems[n],"-"!==s&&(i={itemId:"range-"+s,text:o[s+"Text"],menu:Ext.create("Ext.menu.Menu",{plain:!0,items:[Ext.apply(t,{itemId:s,listeners:{select:o.onPickerSelect,scope:o}})]}),listeners:{scope:o,checkchange:o.onCheckChange}},s=o.fields[s]=Ext.create("Ext.menu.CheckItem",i)),o.menu.add(s);o.values={}},onCheckChange:function(e,t){var n=this,r=e.menu.items.first(),s=r.itemId,i=n.values;t?i[s]=r.getValue():delete i[s],n.setActive(n.isActivatable()),n.fireEvent("update",n)},onInputKeyUp:function(e,t){var n=t.getKey();n==t.RETURN&&e.isValid()&&(t.stopEvent(),this.menu.hide())},onMenuSelect:function(e,t){var n=this.fields,r=this.fields[e.itemId];r.setChecked(!0),r==n.on?(n.before.setChecked(!1,!0),n.after.setChecked(!1,!0)):(n.on.setChecked(!1,!0),r==n.after&&this.getFieldValue("before")<t?n.before.setChecked(!1,!0):r==n.before&&this.getFieldValue("after")>t&&n.after.setChecked(!1,!0)),this.fireEvent("update",this),e.up("menu").hide()},getValue:function(){var e,t={};for(e in this.fields)this.fields[e].checked&&(t[e]=this.getFieldValue(e));return t},setValue:function(e,t){var n;for(n in this.fields)e[n]?(this.getPicker(n).setValue(e[n]),this.fields[n].setChecked(!0)):t||this.fields[n].setChecked(!1);this.fireEvent("update",this)},isActivatable:function(){var e;for(e in this.fields)if(this.fields[e].checked)return!0;return!1},getSerialArgs:function(){var e=[];for(var t in this.fields)this.fields[t].checked&&e.push({type:"date",comparison:this.compareMap[t],value:Ext.Date.format(this.getFieldValue(t),this.dateFormat)});return e},getFieldValue:function(e){return this.values[e]},getPicker:function(e){return this.fields[e].menu.items.first()},validateRecord:function(e){var t,n,r=e.get(this.dataIndex),s=Ext.Date.clearTime;if(!Ext.isDate(r))return!1;r=s(r,!0).getTime();for(t in this.fields)if(this.fields[t].checked){if(n=s(this.getFieldValue(t),!0).getTime(),"beforeEq"==t&&n<=r)return!1;if("before"==t&&n<r)return!1;if("afterEq"==t&&n>=r)return!1;if("after"==t&&n>r)return!1;if("non"==t&&n==r)return!1;if("on"==t&&n!=r)return!1}return!0},onPickerSelect:function(e,t){this.values[e.itemId]=t,this.fireEvent("update",this)}}),Ext.define("Ext.ux.grid.filter.BooleanFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.boolean",defaultValue:!1,yesText:"Yes",noText:"No",init:function(e){var t=Ext.id();this.options=[Ext.create("Ext.menu.CheckItem",{text:this.yesText,group:t,checked:this.defaultValue===!0}),Ext.create("Ext.menu.CheckItem",{text:this.noText,group:t,checked:this.defaultValue===!1})],this.menu.add(this.options[0],this.options[1]);for(var n=0;n<this.options.length;n++)this.options[n].on("click",this.fireUpdate,this),this.options[n].on("checkchange",this.fireUpdate,this)},getValue:function(){return this.options[0].checked},setValue:function(e){this.options[e?0:1].setChecked(!0)},getSerialArgs:function(){var e={type:"boolean",value:this.getValue()};return e},validateRecord:function(e){return e.get(this.dataIndex)==this.getValue()}}),Ext.define("Ext.ux.grid.filter.DateTimeFilter",{extend:"Ext.ux.grid.filter.DateFilter",alias:"gridfilter.datetime",dateDefaults:{xtype:"datepicker",format:"m/d/Y"},timeDefaults:{xtype:"timepicker",width:100,height:200,format:"g:i A"},dockDefaults:{dock:"top",buttonText:"Filter"},selectDateToFilter:!0,positionDatepickerFirst:!0,reTime:/\s(am|pm)/i,reItemId:/\w*-(\w*)$/,addTimeSelection:function(e,t){var n,r,s,i,o=this,a=t.getSelectionModel().getSelection(),l=0,c=[],d=["setHours","setMinutes","setSeconds","setMilliseconds"];if(a.length)for(n=a[0].get("disp"),c=n.replace(o.reTime,"").split(":"),r=c.length;l<r;l++)s=d[l],i=c[l],i&&e[s](parseInt(i,10));return e},init:function(e){var t,n,r,s,i,o=this,a=Ext.applyIf(o.date||{},o.dateDefaults),l=Ext.applyIf(o.time||{},o.timeDefaults),c=o.dock,d={click:{scope:o,click:o.onMenuSelect},select:{scope:o,select:o.onMenuSelect}},u=[a,l],f=0;for(o.positionDatepickerFirst||(u=u.reverse(),f=1),t=Ext.apply(o.pickerOpts,{xtype:c?"panel":"container",layout:"hbox",items:u}),c?c&&(o.selectDateToFilter=null,c.dockedItems?(t.dockedItems=c.dockedItems,t.dockedItems.items[c.bindToItem||0].listeners=d.click):(Ext.isBoolean(c)&&(c={}),c=Ext.applyIf(c,o.dockDefaults),t.dockedItems={xtype:"toolbar",dock:c.dock,items:[{xtype:"button",text:c.buttonText,flex:1,listeners:d.click}]})):o.selectDateToFilter?a.listeners=d.select:l.listeners=d.select,o.fields={},n=0,r=o.menuItems.length;n<r;n++)s=o.menuItems[n],"-"!==s&&(t.items[f].itemId=s,i={itemId:"range-"+s,text:o[s+"Text"],menu:Ext.create("Ext.menu.Menu",{items:t}),listeners:{scope:o,checkchange:o.onCheckChange}},s=o.fields[s]=Ext.create("Ext.menu.CheckItem",i)),o.menu.add(s);o.values={}},onCheckChange:function(e,t){var n=this,r=e.menu,s=r.down("timepicker"),i=r.down("datepicker"),o=i.itemId,a=n.values;t?a[o]=n.addTimeSelection(i.value,s):delete a[o],n.setActive(n.isActivatable()),n.fireEvent("update",n)},onMenuSelect:function(e,t){var n,r=this,s=r.menu,i=s.getFocusEl().itemId.replace(r.reItemId,"$1"),o=r.fields;e=s.queryById(i),n=r.fields[e.itemId],n.setChecked(!0),n==o.on?(o.before.setChecked(!1,!0),o.after.setChecked(!1,!0)):(o.on.setChecked(!1,!0),n==o.after&&r.getFieldValue("before")<t?o.before.setChecked(!1,!0):n==o.before&&r.getFieldValue("after")>t&&o.after.setChecked(!1,!0)),r.fireEvent("update",r),e.ownerCt.ownerCt.hide()},getSerialArgs:function(){var e,t=this,n=t.fields,r=[];for(e in n)n[e].checked&&r.push({type:"datetime",comparison:t.compareMap[e],value:Ext.Date.format(t.getFieldValue(e),(t.date.format||t.dateDefaults.format)+" "+(t.time.format||t.timeDefaults.format))});return r},setValue:function(e,t){var n,r,s,i=this,o=i.fields;for(n in o)r=e[n],r?(s=i.menu.down('datepicker[itemId="'+n+'"]'),s.update(r),s.value=r,o[n].setChecked(!0)):t||o[n].setChecked(!1);i.fireEvent("update",i)},validateRecord:function(e){var t,n,r=this,s=e.get(r.dataIndex);if(!Ext.isDate(s))return!1;s=s.getTime();for(t in r.fields)if(r.fields[t].checked){if(n=r.getFieldValue(t).getTime(),"before"==t&&n<=s)return!1;if("after"==t&&n>=s)return!1;if("on"==t&&n!=s)return!1}return!0}}),Ext.define("Ext.ux.grid.filter.ListFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.list",phpMode:!1,init:function(e){this.dt=Ext.create("Ext.util.DelayedTask",this.fireUpdate,this)},createMenu:function(e){var t=Ext.create("Ext.ux.grid.menu.ListMenu",e);
return t.on("checkchange",this.onCheckChange,this),t},getValue:function(){return this.menu.getSelected()},setValue:function(e){this.menu.setSelected(e),this.fireEvent("update",this)},isActivatable:function(){return this.getValue().length>0},getSerialArgs:function(){return{type:"list",value:this.phpMode?this.getValue().join(","):this.getValue()}},onCheckChange:function(){this.dt.delay(this.updateBuffer)},validateRecord:function(e){var t=this.getValue();return Ext.Array.indexOf(t,e.get(this.dataIndex))>-1}}),Ext.define("Ext.ux.grid.filter.NumericFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.numeric",uses:["Ext.form.field.Number"],createMenu:function(e){var t,n=this;return t=Ext.create("Ext.ux.grid.menu.RangeMenu",e),t.on("update",n.fireUpdate,n),t},getValue:function(){return this.menu.getValue()},setValue:function(e){this.menu.setValue(e)},isActivatable:function(){var e,t=this.getValue();for(e in t)if(void 0!==t[e])return!0;return!1},getSerialArgs:function(){var e,t=[],n=this.menu.getValue();for(e in n)t.push({type:"numeric",comparison:e,value:n[e]});return t},validateRecord:function(e){var t=e.get(this.dataIndex),n=this.getValue(),r=Ext.isNumber;return(!r(n.eq)||t==n.eq)&&(!(r(n.lt)&&t>=n.lt)&&!(r(n.gt)&&t<=n.gt))}}),Ext.define("Ext.ux.grid.filter.StringFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.string",iconCls:"ux-gridfilter-text-icon",emptyText:"Enter Filter Text...",selectOnFocus:!0,width:125,init:function(e){Ext.applyIf(e,{enableKeyEvents:!0,labelCls:"ux-rangemenu-icon "+this.iconCls,hideEmptyLabel:!1,labelSeparator:"",labelWidth:29,listeners:{scope:this,keyup:this.onInputKeyUp,el:{click:function(e){e.stopPropagation()}}}}),this.inputItem=Ext.create("Ext.form.field.Text",e),this.menu.add(this.inputItem),this.menu.add({xtype:"checkbox",name:"notLike",boxLabel:"",style:"color: white",listeners:{change:function(){this.updateTask.delay(1)},scope:this}}),this.menu.showSeparator=!1,this.updateTask=Ext.create("Ext.util.DelayedTask",this.fireUpdate,this)},getValue:function(){var e=this;return{value:e.inputItem.getValue(),notLike:e.menu.down("*[name=notLike]").getValue()}},setValue:function(e){this.inputItem.setValue(e),this.fireEvent("update",this)},isActivatable:function(){return this.inputItem.getValue().length>0},getSerialArgs:function(){return{type:"string",value:this.getValue()}},validateRecord:function(e){var t=e.get(this.dataIndex);return"string"!=typeof t?0===this.getValue().length:t.toLowerCase().indexOf(this.getValue().toLowerCase())>-1},onInputKeyUp:function(e,t){var n=t.getKey();if(n==t.RETURN&&e.isValid())return t.stopEvent(),void this.updateTask.delay(1)}}),Ext.define("Ext.ux.grid.menu.ListMenu",{extend:"Ext.menu.Menu",idField:"id",labelField:"text",loadingText:"Loading...",loadOnShow:!0,single:!1,plain:!0,constructor:function(e){var t,n,r,s,i=this;if(i.selected=[],i.addEvents("checkchange"),i.callParent(arguments),i.store||i.options||(i.options=i.grid.store.collect(i.dataIndex,!1,!0)),!i.store&&i.options){for(t=[],n=0,r=i.options.length;n<r;n++)switch(s=i.options[n],Ext.type(s)){case"array":t.push(s);break;case"object":t.push([s[i.idField],s[i.labelField]]);break;default:null!=s&&t.push([s,s])}i.store=Ext.create("Ext.data.ArrayStore",{fields:[i.idField,i.labelField],data:t,listeners:{load:i.onLoad,scope:i}}),i.loaded=!0,i.autoStore=!0}else i.add({text:i.loadingText,iconCls:"loading-indicator"}),i.store.on("load",i.onLoad,i)},destroy:function(){var e=this,t=e.store;t&&(e.autoStore?t.destroyStore():t.un("unload",e.onLoad,e)),e.callParent()},show:function(){var e=this;!e.loadOnShow||e.loaded||e.store.loading||e.store.load(),e.callParent()},onLoad:function(e,t){var n,r,s,i,o=this,a={checkchange:o.checkChange,scope:o};for(Ext.suspendLayouts(),o.removeAll(!0),n=o.single?Ext.id():null,s=0,i=t.length;s<i;s++)r=t[s].get(o.idField),o.add(Ext.create("Ext.menu.CheckItem",{text:t[s].get(o.labelField),group:n,checked:Ext.Array.contains(o.selected,r),hideOnClick:!1,value:r,listeners:a}));o.loaded=!0,Ext.resumeLayouts(!0),o.fireEvent("load",o,t)},getSelected:function(){return this.selected},setSelected:function(e){e=this.selected=[].concat(e),this.loaded&&this.items.each(function(t){t.setChecked(!1,!0);for(var n=0,r=e.length;n<r;n++)t.value==e[n]&&t.setChecked(!0,!0)})},checkChange:function(e,t){var n=[];this.items.each(function(e){e.checked&&n.push(e.value)}),this.selected=n,this.fireEvent("checkchange",e,t)}}),Ext.define("Ext.ux.grid.menu.RangeMenu",{extend:"Ext.menu.Menu",fieldCls:"Ext.form.field.Number",itemIconCls:{gte:"ux-rangemenu-gt",gt:"ux-rangemenu-gt",lte:"ux-rangemenu-lt",lt:"ux-rangemenu-lt",neq:"gi_search",eq:"ux-rangemenu-eq"},itemName:{lte:"  ",lt:"",gte:"  ",gt:"",neq:" ",eq:""},fieldLabels:{gt:"Greater Than",lt:"Less Than",eq:"Equal To"},menuItemCfgs:{emptyText:"Enter Number...",selectOnFocus:!1,width:155},menuItems:["lte","lt","gte","gt","-","neq","eq"],plain:!0,constructor:function(e){var t,n,r,s,i,o,a,l=this;for(l.callParent(arguments),t=l.fields=l.fields||{},n=l.fieldCfg=l.fieldCfg||{},l.addEvents("update"),l.updateTask=Ext.create("Ext.util.DelayedTask",l.fireUpdate,l),r=0,s=l.menuItems.length;r<s;r++)i=l.menuItems[r],"-"!==i&&(o={itemId:"range-"+i,enableKeyEvents:!0,hideEmptyLabel:!1,fieldLabel:l.itemName[i],labelStyle:"color: white",labelSeparator:"",labelWidth:49,listeners:{scope:l,change:l.onInputChange,keyup:l.onInputKeyUp,el:{click:this.stopFn}},activate:Ext.emptyFn,deactivate:Ext.emptyFn},Ext.apply(o,Ext.applyIf(t[i]||{},n[i]),l.menuItemCfgs),a=o.fieldCls||l.fieldCls,i=t[i]=Ext.create(a,o)),l.add(i)},stopFn:function(e){e.stopPropagation()},fireUpdate:function(){this.fireEvent("update",this)},getValue:function(){var e,t,n={},r=this.fields;for(e in r)r.hasOwnProperty(e)&&(t=r[e],t.isValid()&&null!==t.getValue()&&(n[e]=t.getValue()));return n},setValue:function(e){var t,n,r=this,s=r.fields;for(t in s)s.hasOwnProperty(t)&&(n=s[t],n.suspendEvents(),n.setValue(t in e?e[t]:""),n.resumeEvents());r.fireEvent("update",r)},onInputKeyUp:function(e,t){t.getKey()===t.RETURN&&e.isValid()&&(t.stopEvent(),this.updateTask.delay(1))},onInputChange:function(e){var t=this,n=t.fields,r=n.neq,s=n.eq,i=n.gte,o=n.gt,a=n.lte,l=n.lt;e==s||e==r?(i&&i.setValue(null),o&&o.setValue(null),a&&a.setValue(null),l&&l.setValue(null)):(r.setValue(null),s.setValue(null))}});